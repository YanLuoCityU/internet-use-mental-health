---
title: "Internet use and mental health"
author: "Yan Luo"
date: '2023-10-01'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Make sure the working directory is "your path/internet-use-mental-health"
knitr::opts_knit$set(root.dir = "E:/Multiple cohort study/Harmonized Data FIile/HarmonizedSurveyData/internet_use_mental/internet-use-mental-health")

library(tidyverse)
library(haven)
library(sjlabelled)
library(mice)
library(tictoc)
library(doParallel)
library(gtsummary)

```

# Self-constructed functions

```{r}

reverse_code <- function(x) {
  max_val <- max(x, na.rm = T)
  return(max_val - x + 1)
}

```


# Import data

## Main datasets: Harmonized_SHARE

```{r}

print(getwd())

# Import the data
harm_share <- read_dta(paste(getwd(), "/data/raw/share/H_SHARE_f.dta", sep = ""))

## Transform Harmonized_SHARE from wide format to long format
wide_harm_share <- harm_share %>%
  select(
    c(mergeid, hhid, pn, country, isocountry, ragender, raeducl, radyear, radmonth)| # id, country, gender, education
      (starts_with("r") & (ends_with("iwy") | ends_with("iwm"))) | # Interview dates
      (starts_with("r") & (ends_with("agey") | ends_with("agem"))) | # Age
      (starts_with("h") & ends_with("atotb") & !contains("hh")) | # Household wealth
      (starts_with("r") & ends_with("lbrf_s")) | # Labor force status
      (starts_with("r") & (ends_with("smokev") | ends_with("smoken") | ends_with("drinkxw") | ends_with("vgactx") | ends_with("mdactx"))) | # Health behaviors
      (starts_with("r") & (ends_with("mstat"))) | # Marital status
      (starts_with("h") & (ends_with("hhres") | ends_with("child") | ends_with("kcnt"))) | # Household size, number of children, contact with other people
      (starts_with("r") & (ends_with("livpar") | ends_with("pcnt"))) | # Number of living parents
      (starts_with("r") & (ends_with("hibpe") | ends_with("diabe") | ends_with("cancre") | ends_with("lunge") | ends_with("hearte") | ends_with("stroke") | ends_with("psyche") | ends_with("arthre") | ends_with("parkine"))) | # Chronic diseases
      (starts_with("r") & (ends_with("alzdeme"))) | # Memory-related diseases, Alzheimerâ€™s disease, dementia
      (starts_with("r") & (ends_with("batha") | ends_with("eata") | ends_with("beda") | ends_with("toilta") | ends_with("walkra") | ends_with("dressa") | ends_with("adltot_s") | ends_with("adltotm_s"))) | # ADL
      (starts_with("r") & (ends_with("mapa") | ends_with("phonea") | ends_with("moneya") | ends_with("medsa") | ends_with("shopa") | ends_with("mealsa") | ends_with("housewka") | ends_with("iadltot1_s") | ends_with("iadltot1m_s"))) | # IADL
      (starts_with("r") & (ends_with("depress") | ends_with("pessim") | ends_with("suicid") | ends_with("guilt") | ends_with("sleep") | ends_with("intrst") | ends_with("irritb") | ends_with("appett") | ends_with("fatig") | ends_with("concnt") | ends_with("enjoym") | ends_with("tearfl") | ends_with("eurod"))) | # EURO-D
      (starts_with("r") & ends_with("shlt")) | # Self-reported health
      (starts_with("h") & ends_with("kcnt")) | # Contact with other people
      (starts_with("r") & ends_with("pcnt"))
     ) %>% 
  mutate(
    r3iwm = NA, r3agey = NA, r3agem = NA, 
    r3iwy = NA, 
    r1iwy_w = r1iwy, r2iwy_w = ifelse(r2iwy == 2010, 2009, r2iwy), r3iwy_w = NA, 
    r4iwy_w = r4iwy, r5iwy_w = r5iwy, r6iwy_w = r6iwy, 
    r7iwy_w = ifelse(r7iwy == 2019, 2018, r7iwy), r8iwy_w = r8iwy,
    h3atotb = NA, # Household wealth
    r3lbrf_s = NA,
    r3smokev = NA, r3smoken = NA, r3drinkxw = NA, r3vgactx = NA, r3mdactx = NA, # Health behaviors
    r3mstat = NA,
    hh3hhres = NA, # Household size
    h3child = NA, h3fchild = NA, h3grchild = NA, h3fgrchild = NA, r3livpar = NA, h3kcnt = NA, r3pcnt = NA, # Contact with other people
    r3hibpe = NA, r3diabe = NA, r3cancre = NA, r3lunge = NA, r3hearte = NA, r3stroke = NA, r1psyche = NA, r3psyche = NA, r3arthre = NA, r3parkine = NA, r1alzdeme = NA, r3alzdeme = NA, # Chronic diseases
    r3batha = NA, r3eata = NA, r3beda = NA, r3toilta = NA, r3walkra = NA, r3dressa = NA, r3adltot_s = NA, r3adltotm_s = NA, # ADL
    r3mapa = NA, r3phonea = NA, r3moneya = NA, r3medsa = NA, r3shopa = NA, r3mealsa = NA, r3housewka = NA, r3iadltot1_s = NA, r3iadltot1m_s = NA, # IADL
    r3depress = NA, r3pessim = NA, r3suicid = NA, r3guilt = NA, r3sleep = NA, r3intrst = NA, r3irritb = NA, r3appett = NA, r3fatig = NA, r3concnt = NA, r3enjoym = NA, r3tearfl = NA, r3eurod = NA, r3feurod = NA, # EURO-D
    r3shlt = NA, # Self-reported health
    h3kcnt = NA, r3pcnt = NA
  ) %>%
  dplyr::select(!c(r1rxsleep, r2rxsleep, r4rxsleep, r5rxsleep, r6rxsleep, r7rxsleep, r8rxsleep))

index_reorder <- str_detect(names(wide_harm_share), "[h-r]+[0-9]+(.*)")
names_reorder <- names(wide_harm_share)[index_reorder] %>% 
  str_match("[h-r]+([0-9]+)(.*)") %>% 
  as_tibble() %>% 
  arrange(.[[3]], .[[2]]) %>%
  select(V1) %>%
  as_vector("character") %>% unname()

long_share <- wide_harm_share %>% 
  select(!contains(names_reorder), contains(names_reorder)) %>%
    pivot_longer(
    col = !c(mergeid, hhid, pn, country, isocountry, ragender, raeducl, radyear, radmonth),
    names_to = ".value",
    names_pattern = "[h-r]+[0-9]+(.*)"
  ) %>%
  mutate(
    wave = case_when(
      iwy_w %in% c(2004:2005) ~ 2004, # modified version: r2iwy = ifelse(r2iwy == 2010, 2009, r2iwy)
      iwy_w %in% c(2006:2009) ~ 2007,
      iwy_w %in% c(2010:2012) ~ 2011,
      iwy_w %in% c(2013) ~ 2013,
      iwy_w %in% c(2015) ~ 2015,
      iwy_w %in% c(2017:2018) ~ 2017,
      iwy_w %in% c(2019:2020) ~ 2019
    )
  ) %>%
  remove_all_labels() %>%
  zap_formats()

rm(harm_share, wide_harm_share, index_reorder, names_reorder)

```

## 2013 - 2019 cohort core questionnaire

```{r}

share <- tibble()
for(i in c(5:8)){
  ac <- str_c(getwd(), "/data/raw/share/sharew", i, "_rel8-0-0_ac.dta") # Life satisfaction
  cv <- str_c(getwd(), "/data/raw/share/sharew", i, "_rel8-0-0_cv_r.dta") # Interview dates
  it <- str_c(getwd(), "/data/raw/share/sharew", i, "_rel8-0-0_it.dta") # Internet use
  share_w <- read_dta(ac) %>%
    left_join(read_dta(cv), by = c("mergeid")) %>%
    left_join(read_dta(it), by = c("mergeid")) %>%
    select(mergeid, int_year, ac012_, it004_) %>%
    mutate(
      .keep = "unused",
      iwy = as.numeric(int_year), 
      wave = case_when(
        iwy %in% c(2013) ~ 2013,
        iwy %in% c(2015) ~ 2015,
        iwy %in% c(2017:2018) ~ 2017,
        iwy %in% c(2019:2020) ~ 2019
      ),
      ac012_, it004_
      )
  share <- bind_rows(share, share_w)
}

rm(ac, cv, it, i, share_w)

```


# Variable definition

```{r}

# Merge datasets
long_merge <- long_share %>%
  left_join(share, by = c("mergeid", "iwy", "wave"))

rm(long_share, share)

# Define variables
tidy_share <- long_merge %>%
  filter(!is.na(iwy)) %>%
  filter(wave >= 2013) %>% 
  mutate(
    .keep = "none",
    ## Basic information
    id = mergeid, cohort = "share", country = isocountry, iwy, iwm, wave,
    radyear, radmonth,
    
    ## Exposure variables
    internet_yes = case_when(
      it004_ == 1 ~ "yes",
      it004_ == 5 ~ "no",
      TRUE ~ NA_character_
    ),
    internet_yes = relevel(factor(internet_yes), ref = "no"),

    ## Outcomes
    # depressive syptomes
    depress, pessim, suicid, guilt, sleep, intrst, 
    irritb, appett, fatig, concnt, enjoym, tearfl,
    # self-rated health
    shlt = reverse_code(shlt), 
    # life satisfaction
    satlife = ifelse(ac012_ < 0, NA, ac012_), 
    
    ## Covariates
    # Demographics
    age = agey, 
    male = ifelse(ragender == 2, "female", "male"), male = relevel(factor(male), ref = "female"),
    nonmarried = case_when(
      mstat %in% c(1:3) ~ "no",
      mstat %in% c(4:8) ~ "yes",
      TRUE ~ NA_character_
      ),
    nonmarried = relevel(factor(nonmarried), ref = "no"),
    hhres,
    kcnt = ifelse(child == 0, 0, kcnt),
    pcnt = ifelse(livpar == 0, 0, pcnt),
    contact = case_when(
      kcnt == 1 | pcnt == 1 ~ "yes",
      is.na(kcnt) & is.na(pcnt) ~ NA_character_,
      TRUE ~ "no"
    ),
    contact = relevel(factor(contact), ref = "no"),
    kcnt = ifelse(kcnt == 1, "yes", "no"), kcnt = relevel(factor(kcnt), ref = "no"),
    
    # Socioeconomic status
    atotb, 
    lowedu = case_when(
      raeducl == 3 ~ "tertiary",
      raeducl == 2 ~ "secondary",
      raeducl == 1 ~ "primary",
      TRUE ~ NA_character_
    ),
    lowedu = relevel(factor(lowedu), ref = "tertiary"),
    lbrf = case_when(
      lbrf_s %in% c(1,2) ~ "employed",
      lbrf_s %in% c(4,5) ~ "retired",
      lbrf_s %in% c(3,6,7,8) ~ "others",
      TRUE ~ NA_character_
    ), 
    lbrf = relevel(factor(lbrf), ref = "employed"),
    
    # Health behaviors
    smoke = case_when(
      smokev == 0 ~ "never",
      smokev == 1 & smoken == 0 ~ "ever",
      smoken == 1 ~ "current",
      TRUE ~ NA_character_
    ),
    smoke = relevel(factor(smoke), ref = "never"),
    smoken = ifelse(smoken == 1, "yes", "no"), smoken = relevel(factor(smoken), ref = "no"),
    weekdrink = case_when(
      drinkxw == 0 ~ "no",
      drinkxw == 1 ~ "yes",
      TRUE ~ NA_character_
    ),
    weekdrink = relevel(factor(weekdrink), ref = "no"),
    phyinact = case_when(
      vgactx %in% c(1:4) | mdactx %in% c(1:4) ~ "no",
      vgactx == 5 & mdactx == 5 ~ "yes",
      TRUE ~ NA_character_
    ),
    phyinact = relevel(factor(phyinact), ref = "no"),
    
    # Physical health
    hibpe, diabe, cancre, lunge, hearte, stroke, arthre, 
    psyche = factor(psyche, labels = c("no", "yes")), 
    psyche = relevel(factor(psyche), ref = "no"),
    parkine = factor(parkine, labels = c("no", "yes")), 
    parkine = relevel(factor(parkine), ref = "no"),
    alzdeme = factor(alzdeme, labels = c("no", "yes")), 
    alzdeme = relevel(factor(alzdeme), ref = "no"),
    dressa, batha, eata, beda, toilta, walkra, # ADLs 
    moneya, medsa, shopa, mealsa, phonea, mapa, housewka # IADLs
  ) %>%
  arrange(id, wave) %>%
  rowwise() %>%
  mutate(
    dis = sum(c(hibpe, diabe, cancre, lunge, hearte, stroke, arthre), na.rm = T),
    dis_miss = sum(is.na(c(hibpe, diabe, cancre, lunge, hearte, stroke, arthre)), na.rm = F),
    adl = sum(c(dressa, batha, eata, beda, toilta, walkra), na.rm = T),
    adl_miss = sum(is.na(c(dressa, batha, eata, beda, toilta, walkra)), na.rm = F),
    iadl = sum(c(moneya, medsa, shopa, mealsa, phonea, housewka), na.rm = T),
    iadl_miss = sum(is.na(c(moneya, medsa, shopa, mealsa, phonea, housewka)), na.rm = F),
  ) %>%
  ungroup() %>%
  mutate(
    dis = ifelse(dis_miss == 7, NA, dis), 
    adl = ifelse(adl_miss == 6, NA, adl),
    iadl = ifelse(iadl_miss == 6, NA, iadl),
    adl_any = ifelse(adl == 0, "no", "yes"), adl_any = relevel(factor(adl_any), ref = "no")
  )

length(unique(tidy_share$id)) # 109340

```


# Generate analytic samples

## Internet use (yes/no)

```{r}

# Keep participants aged >=50 years
id_50plus <- tidy_share %>%
  group_by(id) %>%
  slice(1) %>%
  ungroup() %>%
  filter(age >= 50) %>%
  pull(id)

filter_50plus <- tidy_share %>%
  filter(id %in% id_50plus)
length(unique(filter_50plus$id)) # 107044

# Keep participants with complete data on internet use at baseline
id_iyes <- filter_50plus %>%
  group_by(id) %>%
  slice(1) %>%
  ungroup() %>%
  filter(!is.na(internet_yes)) %>%
  pull(id)

filter_iyes <- filter_50plus %>%
  filter(id %in% id_iyes)
length(unique(filter_iyes$id)) # 85946

# Keep participants with complete data on outcomes at baseline
## Depressive symptoms
id_cesd_bl <- filter_iyes %>%
  rowwise() %>%
  mutate(
    cesd_miss = sum(is.na(c(depress, pessim, suicid, guilt, sleep, intrst, irritb, appett, fatig, concnt, enjoym, tearfl)), na.rm = F)
  ) %>%
  ungroup() %>%
  mutate(
    with_cesd = ifelse(cesd_miss == 0, 1, 0)
  ) %>%
  group_by(id) %>%
  slice(1) %>%
  filter(with_cesd == 1) %>% 
  ungroup() %>%
  pull(id)

## Self-rated health
id_shlt_bl <- filter_iyes %>%
  mutate(
    with_shlt = ifelse(!is.na(shlt), 1, 0)
  ) %>%
  group_by(id) %>%
  slice(1) %>%
  filter(with_shlt == 1) %>% 
  ungroup() %>%
  pull(id)

## Life satisfaction
id_satlife_bl <- filter_iyes %>%
  mutate(
    with_satlife = ifelse(!is.na(satlife), 1, 0)
  ) %>%
  group_by(id) %>%
  slice(1) %>%
  filter(with_satlife == 1) %>% 
  ungroup() %>%
  pull(id)

id_ot_bl <- intersect(id_cesd_bl, id_satlife_bl) # 82117
length(unique(id_ot_bl))
id_ot_bl <- intersect(id_ot_bl, id_shlt_bl) # 82091
length(unique(id_ot_bl))

filter_ot_bl <- filter_iyes %>%
  filter(id %in% id_ot_bl)
length(unique(filter_ot_bl$id)) # 82091

# Keep participants with at least one-wave complete data on outcomes over follow-ups
id_2obs <- filter_ot_bl %>%
  group_by(id) %>%
  filter(n() >= 2) %>%
  dplyr::slice(1) %>%
  ungroup() %>%
  pull(id)

filter_2obs <- filter_ot_bl %>%
  filter(id %in% id_2obs)
length(unique(filter_2obs$id)) # 64448

## Depressive symptoms
id_cesd <- filter_2obs %>%
  rowwise() %>%
  mutate(
    cesd_miss = sum(is.na(c(depress, pessim, suicid, guilt, sleep, intrst, irritb, appett, fatig, concnt, enjoym, tearfl)), na.rm = F)
  ) %>%
  ungroup() %>%
  mutate(
    with_cesd = ifelse(cesd_miss == 0, 1, 0)
  ) %>%
  group_by(id) %>%
  slice(2:n()) %>%
  mutate(
    t_with_cesd = cumsum(with_cesd)
    ) %>%
  slice(n()) %>%
  filter(t_with_cesd >= 1) %>% 
  ungroup() %>%
  pull(id)

## Self-rated health
id_shlt <- filter_2obs %>%
  mutate(
    with_shlt = ifelse(!is.na(shlt), 1, 0)
  ) %>%
  group_by(id) %>%
  slice(2:n()) %>%
  mutate(
    t_with_shlt = cumsum(with_shlt)
    ) %>%
  slice(n()) %>%
  filter(t_with_shlt >= 1) %>% 
  ungroup() %>%
  pull(id)

## Life satisfaction
id_satlife <- filter_2obs %>%
  mutate(
    with_satlife = ifelse(!is.na(satlife), 1, 0)
  ) %>%
  group_by(id) %>%
  slice(2:n()) %>%
  mutate(
    t_with_satlife = cumsum(with_satlife)
    ) %>%
  slice(n()) %>%
  filter(t_with_satlife >= 1) %>% 
  ungroup() %>%
  pull(id)

id_ot <- intersect(id_cesd, id_satlife) # 55932
length(unique(id_ot))
id_ot <- intersect(id_ot, id_shlt) # 55925
length(unique(id_ot))

filter_ot <- filter_2obs %>%
  filter(id %in% id_ot)
length(unique(filter_ot$id)) # 55925

# Keep participants without memory-related and psychological diseases at baseline
id_mental <- filter_ot %>%
  group_by(id) %>%
  slice(1) %>%
  ungroup() %>%
  filter(parkine == "yes" | alzdeme == "yes" | psyche == "yes") %>%
  pull(id)

filter_nomental <- filter_ot %>%
  filter(!id %in% id_mental) 
length(unique(filter_nomental$id)) # 48971

# Keep participants with complete data on covariates at baseline
id_cov <- filter_nomental %>%
  rowwise() %>%
  mutate(
    cov_miss = sum(is.na(c(age, male, atotb, lowedu, lbrf, nonmarried, hhres, contact, smoken, weekdrink, phyinact, dis, adl_any, iadl)), na.rm = F)
  ) %>%
  ungroup() %>%
  mutate(
    with_cov = ifelse(cov_miss == 0, 1, 0) # with all items
  ) %>%
  group_by(id) %>%
  slice(1) %>%
  ungroup() %>%
  filter(with_cov == 1) %>%
  pull(id)

filter_cov_iyes <- filter_nomental %>%
  filter(id %in% id_cov) %>%
  rowwise() %>%
  mutate(
    cesd = sum(c(depress, pessim, suicid, guilt, sleep, intrst, irritb, appett, fatig, concnt, enjoym, tearfl), na.rm = F)
  ) %>%
  ungroup()
length(unique(filter_cov_iyes$id)) # 44518

table(filter_cov_iyes %>% group_by(id) %>% summarise(count = n()) %>% pull(count))

# Number of participants by country at baseline
table(filter_cov_iyes %>% group_by(id) %>% slice(1) %>% ungroup() %>% pull(country))

# Final
bl <- filter_cov_iyes %>% 
  group_by(id) %>% 
  slice(1) %>%
  ungroup() %>%
  mutate(
    .keep = "none",
    id, country, internet_yes, 
    age, male, lowedu, lbrf, atotb,
    nonmarried, hhres, contact, smoken, weekdrink, phyinact,
    dis, adl_any, iadl
    ) %>%
  group_by(country) %>%
  mutate(
    lowwealth = factor(reverse_code(ntile(atotb, 3)))
  ) %>%
  ungroup() %>%
  select(!c(country, atotb))

final <- filter_cov_iyes %>%
  group_by(id) %>%
  mutate(
    fisrt = first(wave),
    cwave = wave - fisrt
  ) %>%
  ungroup() %>%
  mutate(
    .keep = "none",
    id, country, iwy, iwm, wave,
    cesd, shlt, satlife, 
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife),
    depression = ifelse(cesd >= 4, 1, 0), cwave
  ) %>%
  dplyr::select(
    id, country, iwy, iwm, wave,
    cesd, shlt, satlife,
    cesd_stand, shlt_stand, satlife_stand,
    depression, cwave
  )

final_iyes_share <- final %>% 
  left_join(., bl, by = "id") %>%
  mutate(
    id = str_c("share_", id)
  )

```

### Inverse probability weighting

```{r}

# All observations of all participants in the original data (baseline covariates + time-varying outcomes)
bl <- tidy_share %>% 
  group_by(id) %>% 
  slice(1) %>%
  ungroup() %>%
  mutate(
    .keep = "none",
    id, country = factor(country), internet_yes, 
    age, male, lowedu, atotb, lbrf, 
    nonmarried, hhres, contact, smoken, weekdrink, phyinact,
    dis, adl_any, iadl
    )

attr_ipw <- tidy_share %>% 
  select(
    id, wave,
    depress, pessim, suicid, guilt, sleep, intrst, irritb, appett, fatig, concnt, enjoym, tearfl,
    satlife, shlt
  ) %>%
  left_join(., bl, by = "id")

# Construct attrition observations
attr_obs <- tidy_share %>% 
  group_by(id) %>%
  slice(n()) %>%
  ungroup() %>%
  filter(wave != 2019) %>%
  mutate(
    wave = case_when(
      wave == 2013 ~ 2015,
      wave == 2015 ~ 2017,
      wave == 2017 ~ 2019,
      TRUE ~ NA_real_
    ),
    attrition = 1
  ) %>% 
  select(
    id, wave, attrition
  )

# Multiple imputation
predictorMatrix <- matrix(0, nrow = dim(attr_ipw)[2], ncol = dim(attr_ipw)[2])
colnames(predictorMatrix) <- colnames(attr_ipw)
rownames(predictorMatrix) <- colnames(attr_ipw)
row_pre <- which(rownames(predictorMatrix) %in% colnames(attr_ipw)[-c(1:2)])
col_pre <- which(colnames(predictorMatrix) %in% colnames(attr_ipw)[-c(1:2)])
predictorMatrix[row_pre, col_pre] <- 1
for(i in 3:dim(attr_ipw)[2]){ predictorMatrix[i,i]<-0 }

cores <- detectCores()
tic()
mi_attr_ipw <- attr_ipw %>%
  futuremice(data = ., m = 10, maxit = 5, predictorMatrix = predictorMatrix, parallelseed = 12345, n.core = cores - 1)
toc() # 40 min


attr_ipw <- attr_ipw %>%
  mutate(
      attrition = 0
    ) %>%
  bind_rows(., attr_obs) %>%
  arrange(id, wave) %>%
  mutate(
    propensity_num1 = NA, propensity_num2 = NA, propensity_num3 = NA, 
    propensity_num4 = NA, propensity_num5 = NA, propensity_num6 = NA,
    propensity_num7 = NA, propensity_num8 = NA, propensity_num9 = NA,
    propensity_num10 = NA,
    propensity_denom1 = NA, propensity_denom2 = NA, propensity_denom3 = NA, 
    propensity_denom4 = NA, propensity_denom5 = NA, propensity_denom6 = NA, 
    propensity_denom7 = NA, propensity_denom8 = NA, propensity_denom9 = NA, 
    propensity_denom10 = NA
  ) %>%
  group_by(id) %>%
  mutate(
    fisrt = first(wave),
    cwave = wave - fisrt
  ) %>%
  ungroup()

# Calculate the probability of included in the analysis using five imputed datasets
for(i in 1:10){
  mi_data <- mice::complete(mi_attr_ipw, i)
  
  mi_bl <- mi_data %>%
    group_by(id) %>% 
    slice(1) %>%
    ungroup() %>%
    mutate(
      .keep = "none",
      id, country = factor(country), internet_yes, 
      age, male, lowedu, atotb, lbrf, 
      nonmarried, hhres, contact, smoken, weekdrink, phyinact,
      dis, adl_any, iadl
      )
  
  mi_obs <- attr_obs %>%
    left_join(., mi_bl, by = "id")
  
  mi_data <- mi_data %>%
    mutate(
      attrition = 0
    ) %>%
    bind_rows(., mi_obs) %>%
    arrange(id, wave) %>%
    rowwise() %>%
    mutate(
      cesd = sum(c(depress, pessim, suicid, guilt, sleep, intrst, irritb, appett, fatig, concnt, enjoym, tearfl), na.rm = F)
    ) %>%
    ungroup() %>%
    mutate(
      lowwealth = factor(reverse_code(ntile(atotb, 3)))
    ) %>%
    group_by(id) %>%
    mutate(
      fisrt = first(wave),
      cwave = wave - fisrt,
      lag_cesd = lag(cesd, default = first(0)),
      lag_satlife = lag(satlife, default = first(0)),
      lag_shlt = lag(shlt, default = first(0))
    ) %>%
    ungroup()
  
  model_num <- glm(attrition ~ country + internet_yes + age + male + 
                     lowedu + lowwealth + lbrf + nonmarried + hhres + contact + 
                     smoken + weekdrink + phyinact + dis + adl_any + iadl, 
                   data = mi_data, family = binomial(link = "logit"))
  
  model_denom <- glm(attrition ~ country + internet_yes + age + male + 
                       lowedu + lowwealth + lbrf + nonmarried + hhres + contact + 
                       smoken + weekdrink + phyinact + dis + adl_any + iadl + 
                       lag_cesd + lag_satlife + lag_shlt, 
                     data = mi_data, family = binomial(link = "logit"))
  
  # Propensity scores from the models
  attr_ipw[, paste0("propensity_num", i)] <- model_num$fitted.values
  attr_ipw[, paste0("propensity_denom", i)] <- model_denom$fitted.values
  
  rm(mi_data, mi_bl, mi_obs, model_num, model_denom)
}


# Combine weights
attr_ipw <- attr_ipw %>% 
  rowwise() %>%
  # Propensity scores from the models
  mutate(
    propensity_num = mean(c_across(propensity_num1:propensity_num10)),
    propensity_denom = mean(c_across(propensity_denom1:propensity_denom10)),
    ) %>% 
  ungroup() %>%
  # Probability of observed outcome
  mutate(
    propensity_num_outcome = ifelse(attrition == 1, propensity_num, 1 - propensity_num),
    propensity_denom_outcome = ifelse(attrition == 1, propensity_denom, 1 - propensity_denom)
    ) %>% 
  # Numerator / denominator
  mutate(weights_no_time = propensity_num_outcome / propensity_denom_outcome) %>%
  group_by(id) %>% 
  mutate(attrition_ipw = cumprod(weights_no_time)) %>% 
  ungroup() %>%
  mutate(
    id = str_c("share_", id)
  )

final_iyes_share <- final_iyes_share %>%
  left_join(., attr_ipw %>% select(id, wave, attrition_ipw), by = c("id", "wave"))

rm(bl, final)
rm(list = ls()[str_detect(string = ls(), pattern = "id_")])
object <- ls()[str_detect(string = ls(), pattern = "filter_")]
rm(list = object[!object %in% "filter_cov_iyes"])

```

### Internet use and incident depression

```{r}

length(unique(final_iyes_share$id)) # 44518

# Keep participants without depression at baseline
final_iyes_inc <- final_iyes_share %>%
  group_by(id) %>%
  filter(first(depression == 0)) %>%
  mutate(
    has_depression = any(depression == 1, na.rm = T)
  ) %>%
  ungroup()
length(unique(final_iyes_inc$id)) # 35143

# Date of baseline
final_iyes_inc_bl <- final_iyes_inc %>%
  group_by(id) %>%
  slice(1) %>%
  ungroup() %>%
  mutate(
    iwy_bl = iwy, iwm_bl = iwm
  )

# Date of the first occurrence of depression
final_iyes_inc_dep <- final_iyes_inc %>%
  filter(has_depression == T) %>%
  filter(depression == 1) %>%
  group_by(id) %>%
  slice(1) %>%
  ungroup()

# Date of the last observation
final_iyes_inc_nodep <- final_iyes_inc %>%
  filter(has_depression == F) %>%
  group_by(id) %>%
  slice(n()) %>%
  ungroup()

# Final dataset
final_iyes_inc_share <- bind_rows(final_iyes_inc_dep, final_iyes_inc_nodep) %>%
  left_join(final_iyes_inc_bl %>% select(id, iwy_bl, iwm_bl), by = "id") %>%
  rowwise() %>%
  mutate(
    cmonth = iwy*12 + iwm - iwy_bl*12 - iwm_bl
  ) %>%
  ungroup()

rm(final_iyes_inc, final_iyes_inc_bl, final_iyes_inc_dep, final_iyes_inc_nodep)

```


### Supplementary Table 5: compare baseline characteristic between analytic samples and whole samples

```{r}

all <- tidy_share %>%
  group_by(id) %>%
  slice(1) %>%
  ungroup() %>%
  mutate(
    .keep = "none",
    internet_yes, 
    age, male, lowedu, atotb, lbrf, 
    nonmarried, hhres, contact, smoken, weekdrink, phyinact,
    dis, adl_any, iadl, sample = "original"
  )

analytic <- filter_cov_iyes %>%
  group_by(id) %>%
  slice(1) %>%
  ungroup() %>%
  mutate(
    .keep = "none",
    internet_yes, 
    age, male, lowedu, atotb, lbrf, 
    nonmarried, hhres, contact, smoken, weekdrink, phyinact,
    dis, adl_any, iadl, sample = "analytic"
  )

data <- bind_rows(all, analytic)

var_need <- c("internet_yes", "age", "male", "lowedu", "atotb", "lbrf", "nonmarried", "hhres", "contact", "smoken", "weekdrink", "phyinact", "dis", "adl_any", "iadl")

var_name <- c(
  "Internet use",
  
  "Age (years)",
  "Male",
  "Education",
  "Wealth",
  "Labor force status",

  "Unmarried",  
  "Household size",
  "Weekly contact with other people",
  "Current smoker",
  "Weekly alcohol use",
  "Physical inactivity",
  
  "Number of chronic conditions",
  "ADL disability", 
  "IADL"
)

label_list <- list()
for (i in 1:length(var_name)) {
  formula_str <- paste0(var_need[i], " ~ ", "\"", gsub("'", "'", var_name[i]), "\"")
  label_list[[i]] <- as.formula(formula_str)
}

tbl <- data %>%
  mutate(
    male = relevel(factor(male, labels = c("no", "yes")), ref = "no"),
    lowedu = factor(lowedu, levels = c("primary", "secondary", "tertiary"), labels = c("Primary", "Secondary", "Tertiary")),
    # lowwealth = factor(lowwealth, levels = c("3", "2", "1"), labels = c("Low", "Middle", "High")),
    lbrf = factor(lbrf, levels = c("employed", "retired", "others"), labels = c("Working", "Retired", "Others"))
  ) %>%
  tbl_summary(
    by = sample,
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      atotb ~ "{median} ({p25}, {p75})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    label = label_list,
    type = list(hhres ~ "continuous", dis ~ "continuous", iadl ~ "continuous"),
    digits = list(all_continuous() ~ 1, all_categorical() ~ c(0, 1)),
    missing = "no"
    ) %>%
  add_p(pvalue_fun = function(x) style_pvalue(x, digits = 3))

tbl %>%
  as_flex_table() %>%
  flextable::save_as_docx(path = str_c(getwd(), "/results/Table/Supplementary Table 5_Differences in baseline characteristics between analytic and whole samples_SHARE.docx"))

table <- table(data$sample, data$male)
chisq.test(table, correct = F)

wilcox.test(
  data %>% filter(sample=="original") %>% pull(age),
  data %>% filter(sample=="analytic") %>% pull(age),
  exact = F)

```

## Cumulative Internet use

```{r}

# Keep participants aged >=50 years
id_50plus <- tidy_share %>%
  group_by(id) %>%
  slice(1) %>%
  ungroup() %>%
  filter(age >= 50) %>%
  pull(id)

filter_50plus <- tidy_share %>%
  filter(id %in% id_50plus)
length(unique(filter_50plus$id)) # 107044

# Keep participants with two consecutive wave complete data on internet use
id_2iobs <- filter_50plus %>%
  mutate(
    with_iyes = ifelse(!is.na(internet_yes), 1, 0)
  ) %>%
  group_by(id) %>%
  filter(n() >= 2) %>%
  slice(1:2) %>%
  mutate(
    wave_int = wave - lag(wave, default = first(wave)),
    t_with_iyes = cumsum(with_iyes)
  ) %>%
  filter(wave_int <= 3) %>%
  slice(n()) %>%
  filter(t_with_iyes == 2) %>%
  select(id, wave, wave_int, age, internet_yes, t_with_iyes) %>%
  ungroup() %>%
  pull(id)

filter_2iobs <- filter_50plus %>%
  filter(id %in% id_2iobs)
length(unique(filter_2iobs$id)) # 49986

table(filter_2iobs %>% group_by(id) %>% summarise(count = n()) %>% pull(count))

# Keep participants with complete data on outcomes at the third wave (baseline)
## Depressive symptoms
id_cesd_2w <- filter_2iobs %>%
  rowwise() %>%
  mutate(
    cesd_miss = sum(is.na(c(depress, pessim, suicid, guilt, sleep, intrst, irritb, appett, fatig, concnt, enjoym, tearfl)), na.rm = F)
  ) %>%
  ungroup() %>%
  mutate(
    with_cesd = ifelse(cesd_miss == 0, 1, 0) # with all items
  ) %>%
  group_by(id) %>%
  slice(2) %>%
  filter(with_cesd == 1) %>% 
  ungroup() %>%
  pull(id)

## Self-rated health
id_shlt_2w <- filter_2iobs %>%
  mutate(
    with_shlt = ifelse(!is.na(shlt), 1, 0)
  ) %>%
  group_by(id) %>%
  slice(2) %>%
  filter(with_shlt == 1) %>% 
  ungroup() %>%
  pull(id)

## Life satisfaction
id_satlife_2w <- filter_2iobs %>%
  mutate(
    with_satlife = ifelse(!is.na(satlife), 1, 0)
  ) %>%
  group_by(id) %>%
  slice(2) %>%
  filter(with_satlife == 1) %>% 
  ungroup() %>%
  pull(id)

id_ot_2w <- intersect(id_cesd_2w, id_satlife_2w) # 47525
length(unique(id_ot_2w))
id_ot_2w <- intersect(id_ot_2w, id_shlt_2w) # 47511
length(unique(id_ot_2w))

filter_ot_2w <- filter_2iobs %>%
  filter(id %in% id_ot_2w)
length(unique(filter_ot_2w$id)) # 47511

# Keep participants with at least one-wave complete data on outcomes over follow-ups
id_3obs <- filter_ot_2w %>%
  group_by(id) %>%
  filter(n() >= 3) %>%
  dplyr::slice(1) %>%
  ungroup() %>%
  pull(id)

filter_3obs <- filter_ot_2w %>%
  filter(id %in% id_3obs)
length(unique(filter_3obs$id)) # 39081

## Depressive symptoms
id_cesd <- filter_3obs %>%
  rowwise() %>%
  mutate(
    cesd_miss = sum(is.na(c(depress, pessim, suicid, guilt, sleep, intrst, irritb, appett, fatig, concnt, enjoym, tearfl)), na.rm = F)
  ) %>%
  ungroup() %>%
  mutate(
    with_cesd = ifelse(cesd_miss == 0, 1, 0) # with all items
  ) %>%
  group_by(id) %>%
  slice(3:n()) %>%
  mutate(
    t_with_cesd = cumsum(with_cesd)
    ) %>%
  slice(n()) %>%
  filter(t_with_cesd >= 1) %>% 
  ungroup() %>%
  pull(id)

## Self-rated health
id_shlt <- filter_3obs %>%
  mutate(
    with_shlt = ifelse(!is.na(shlt), 1, 0)
  ) %>%
  group_by(id) %>%
  slice(3:n()) %>%
  mutate(
    t_with_shlt = cumsum(with_shlt)
    ) %>%
  slice(n()) %>%
  filter(t_with_shlt >= 1) %>% 
  ungroup() %>%
  pull(id)

## Life satisfaction
id_satlife <- filter_3obs %>%
  mutate(
    with_satlife = ifelse(!is.na(satlife), 1, 0)
  ) %>%
  group_by(id) %>%
  slice(3:n()) %>%
  mutate(
    t_with_satlife = cumsum(with_satlife)
    ) %>%
  slice(n()) %>%
  filter(t_with_satlife >= 1) %>% 
  ungroup() %>%
  pull(id)

id_ot <- intersect(id_cesd, id_satlife) # 27534
length(unique(id_ot))
id_ot <- intersect(id_ot, id_shlt) # 27534
length(unique(id_ot))

filter_ot <- filter_3obs %>%
  filter(id %in% id_ot)
length(unique(filter_ot$id)) # 27534

# Keep participants without dementia and psychological diseases at baseline
id_mental <- filter_ot %>%
  group_by(id) %>%
  slice(2) %>%
  ungroup() %>%
  filter(parkine == "yes" | alzdeme == "yes" | psyche == "yes") %>%
  pull(id)

filter_nomental <- filter_ot %>%
  filter(!id %in% id_mental) 
length(unique(filter_nomental$id)) # 23152

# Keep participants with complete data on covariates at baseline
id_cov <- filter_nomental %>%
  rowwise() %>%
  mutate(
    cov_miss = sum(is.na(c(age, male, atotb, lowedu, lbrf, nonmarried, hhres, contact, smoken, weekdrink, phyinact, dis, adl_any, iadl)), na.rm = F)
  ) %>%
  ungroup() %>%
  mutate(
    with_cov = ifelse(cov_miss == 0, 1, 0) # with all items
  ) %>%
  group_by(id) %>%
  slice(1) %>%
  ungroup() %>%
  filter(with_cov == 1) %>%
  pull(id)

filter_cov <- filter_nomental %>%
  filter(id %in% id_cov) %>%
  rowwise() %>%
  mutate(
    cesd = sum(c(depress, pessim, suicid, guilt, sleep, intrst, irritb, appett, fatig, concnt, enjoym, tearfl), na.rm = F)
  ) %>%
  ungroup()
length(unique(filter_cov$id)) # 21135

table(filter_cov %>% group_by(id) %>% summarise(count = n()) %>% pull(count))

table(filter_cov %>% group_by(id) %>% slice(1) %>% ungroup() %>% pull(country))
# Greece and Poland had very few samples (n=2)

filter_cov <- filter_cov %>%
  filter(!country %in% c(300, 616))
length(unique(filter_cov$id)) # 21131

# Final
icum <- filter_cov %>%
  mutate(
    internet_yes = as.numeric(internet_yes) - 1
    ) %>%
  group_by(id) %>%
  slice(1:2) %>%
  mutate(
    internet_cum = cumsum(internet_yes) # Cumulative internet use
    ) %>% 
  slice(n()) %>%
  ungroup() %>%
  mutate(
    .keep = "none", id, internet_cum
  )

bl <- filter_cov %>% 
  group_by(id) %>% 
  slice(1) %>%
  ungroup() %>%
  mutate(
    .keep = "none",
    id, country, 
    age, male, lowedu, lbrf, atotb,
    nonmarried, hhres, contact, smoken, weekdrink, phyinact,
    dis, adl_any, iadl
    ) %>%
  group_by(country) %>%
  mutate(
    lowwealth = factor(reverse_code(ntile(atotb, 3)))
  ) %>%
  ungroup() %>%
  select(!c(country, atotb)) %>%
  left_join(., icum, by = c("id"))

final <- filter_cov %>%
  group_by(id) %>%
  slice(2:n()) %>%
  mutate(
    fisrt = first(wave),
    cwave = wave - fisrt
  ) %>%
  ungroup() %>%
  mutate(
    .keep = "none",
    id, country, iwy, iwm, wave, 
    cesd, shlt, satlife, 
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife),
    depression = ifelse(cesd >= 4, 1, 0), cwave
  ) %>%
  dplyr::select(
    id, country, iwy, iwm, wave,
    cesd, shlt, satlife,
    cesd_stand, shlt_stand, satlife_stand,
    depression, cwave
  )

final_icum_share <- final %>% 
  left_join(., bl, by = "id") %>%
  mutate(
    id = str_c("share_", id)
  ) %>%
  left_join(., attr_ipw %>% select(id, wave, attrition_ipw), by = c("id", "wave"))

icum_gformula_share <- filter_cov %>%
  group_by(id) %>%
  mutate(wave_num = row_number()-1) %>%
  ungroup() %>%
  select(
    id, country, wave_num, internet_yes, age, male, lowedu, atotb, lbrf, 
    nonmarried, hhres, contact, smoken, weekdrink, phyinact,
    dis, adl_any, iadl,
    cesd, satlife, shlt
    ) #%>%
  # left_join(., attr_ipw %>% select(id, wave, attrition_ipw), by = c("id", "wave"))

rm(icum, bl, final)
rm(list = ls()[str_detect(string = ls(), pattern = "id_")])
rm(list = ls()[str_detect(string = ls(), pattern = "filter_")])

```

## Bidirectional association: mental health and Internet use

```{r}

# Keep participants aged >=50 years
id_50plus <- tidy_share %>%
  group_by(id) %>%
  slice(1) %>%
  ungroup() %>%
  filter(age >= 50) %>%
  pull(id)

filter_50plus <- tidy_share %>%
  filter(id %in% id_50plus)
length(unique(filter_50plus$id)) # 107044

# Keep participants with complete data on internet use at baseline
id_iyes_bl <- filter_50plus %>%
  group_by(id) %>%
  slice(1) %>%
  ungroup() %>%
  filter(!is.na(internet_yes)) %>%
  pull(id)

filter_iyes_bl <- filter_50plus %>%
  filter(id %in% id_iyes_bl)
length(unique(filter_iyes_bl$id)) # 85946

# Keep participants with complete data on outcomes at baseline
## Depressive symptoms
id_cesd_bl <- filter_iyes_bl %>%
  rowwise() %>%
  mutate(
    cesd_miss = sum(is.na(c(depress, pessim, suicid, guilt, sleep, intrst, irritb, appett, fatig, concnt, enjoym, tearfl)), na.rm = F)
  ) %>%
  ungroup() %>%
  mutate(
    with_cesd = ifelse(cesd_miss == 0, 1, 0)
  ) %>%
  group_by(id) %>%
  slice(1) %>%
  filter(with_cesd == 1) %>% 
  ungroup() %>%
  pull(id)

## Self-rated health
id_shlt_bl <- filter_iyes_bl %>%
  mutate(
    with_shlt = ifelse(!is.na(shlt), 1, 0)
  ) %>%
  group_by(id) %>%
  slice(1) %>%
  filter(with_shlt == 1) %>% 
  ungroup() %>%
  pull(id)

## Life satisfaction
id_satlife_bl <- filter_iyes_bl %>%
  mutate(
    with_satlife = ifelse(!is.na(satlife), 1, 0)
  ) %>%
  group_by(id) %>%
  slice(1) %>%
  filter(with_satlife == 1) %>% 
  ungroup() %>%
  pull(id)

id_ot_bl <- intersect(id_cesd_bl, id_satlife_bl) # 82117
length(unique(id_ot_bl))
id_ot_bl <- intersect(id_ot_bl, id_shlt_bl) # 82091
length(unique(id_ot_bl))

filter_ot_bl <- filter_iyes_bl %>%
  filter(id %in% id_ot_bl)
length(unique(filter_ot_bl$id)) # 82091

# Keep participants with at least one-wave complete data on internet use over follow-ups
id_2obs <- filter_ot_bl %>%
  group_by(id) %>%
  filter(n() >= 2) %>%
  dplyr::slice(1) %>%
  ungroup() %>%
  pull(id)

filter_2obs <- filter_ot_bl %>%
  filter(id %in% id_2obs)
length(unique(filter_2obs$id)) # 64448

id_iyes <- filter_2obs %>%
  mutate(
    with_iyes = ifelse(!is.na(internet_yes), 1, 0)
  ) %>%
  group_by(id) %>%
  slice(2:n()) %>%
  mutate(
    t_with_iyes = cumsum(with_iyes)
    ) %>%
  slice(n()) %>%
  filter(t_with_iyes >= 1) %>% 
  ungroup() %>%
  pull(id)

filter_iyes <- filter_2obs %>%
  filter(id %in% id_iyes)
length(unique(filter_iyes$id)) # 57528

# Keep participants without dementia and psychological diseases at baseline
id_mental <- filter_iyes %>%
  group_by(id) %>%
  slice(1) %>%
  ungroup() %>%
  filter(parkine == "yes" | alzdeme == "yes" | psyche == "yes") %>%
  pull(id)

filter_nomental <- filter_iyes %>%
  filter(!id %in% id_mental) 
length(unique(filter_nomental$id)) # 50191

# Keep participants with complete data on covariates at baseline
id_cov <- filter_nomental %>%
  rowwise() %>%
  mutate(
    cov_miss = sum(is.na(c(age, male, atotb, lowedu, lbrf, nonmarried, hhres, contact, smoken, weekdrink, phyinact, dis, adl_any, iadl)), na.rm = F)
  ) %>%
  ungroup() %>%
  mutate(
    with_cov = ifelse(cov_miss == 0, 1, 0)
  ) %>%
  group_by(id) %>%
  slice(1) %>%
  ungroup() %>%
  filter(with_cov == 1) %>%
  pull(id)

filter_cov <- filter_nomental %>%
  filter(id %in% id_cov) %>%
  rowwise() %>%
  mutate(
    cesd = sum(c(depress, pessim, suicid, guilt, sleep, intrst, irritb, appett, fatig, concnt, enjoym, tearfl), na.rm = F)
  ) %>%
  ungroup()
length(unique(filter_cov$id)) # 45609

table(filter_cov %>% group_by(id) %>% summarise(count = n()) %>% pull(count))

# Final dataset
## Replace with the baseline values
bl <- filter_cov %>% 
  group_by(id) %>% 
  slice(1) %>%
  ungroup() %>%
  mutate(
    .keep = "none",
    id, cesd, satlife, shlt,
    cesd_stand = scale(cesd), satlife_stand = scale(satlife), shlt_stand = scale(shlt), 
    age, male, lowedu, lowwealth = factor(reverse_code(ntile(atotb, 3))), lbrf, 
    nonmarried, hhres, contact, smoken, weekdrink, phyinact,
    dis, adl_any, iadl
    )

final <- filter_cov %>%
  group_by(id) %>%
  mutate(
    fisrt = first(wave),
    cwave = wave - fisrt
  ) %>%
  ungroup() %>%
  dplyr::select(
    id, country, iwy, iwm, wave,
    internet_yes, cwave
  )

final_bidirec_share <- final %>% 
  left_join(., bl, by = "id") %>%
  mutate(
    id = str_c("share_", id)
  )

rm(bl, final)
rm(list = ls()[str_detect(string = ls(), pattern = "id_")])
rm(list = ls()[str_detect(string = ls(), pattern = "filter_")])

```



# Subgroup analyses: Internet use (yes/no)

## By age

```{r}

# 50-64 years
middle_iyes_share <- final_iyes_share %>%
  filter(age < 65) %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

# â‰¥65 years
old_iyes_share <- final_iyes_share %>%
  filter(age >= 65) %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

```

## By gender

```{r}

# Male
male_iyes_share <- final_iyes_share %>%
  filter(male == "male") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

# Female
female_iyes_share <- final_iyes_share %>%
  filter(male == "female") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

```

## By marital status

```{r}

# Married
married_iyes_share <- final_iyes_share %>%
  filter(nonmarried == "no") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

# Unmarried
nonmarried_iyes_share <- final_iyes_share %>%
  filter(nonmarried == "yes") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

```

## By weekly contact

```{r}

# Weekly contact with other people
contact_iyes_share <- final_iyes_share %>%
  filter(contact == "yes") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

# No weekly contact
nocontact_iyes_share <- final_iyes_share %>%
  filter(contact == "no") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

```

## By education

```{r}

# Primary
pedu_iyes_share <- final_iyes_share %>%
  filter(lowedu == "primary") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

# Secondary
sedu_iyes_share <- final_iyes_share %>%
  filter(lowedu == "secondary") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

# Tertiary
tedu_iyes_share <- final_iyes_share %>%
  filter(lowedu == "tertiary") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

```

## By household wealth

```{r}

# Low
lwealth_iyes_share <- final_iyes_share %>%
  filter(lowwealth == 3) %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

# Middle
mwealth_iyes_share <- final_iyes_share %>%
  filter(lowwealth == 2) %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

# High
hwealth_iyes_share <- final_iyes_share %>%
  filter(lowwealth == 1) %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

```

## By labor force status

```{r}

# Working
work_iyes_share <- final_iyes_share %>%
  filter(lbrf == "employed") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

# Retired
retired_iyes_share <- final_iyes_share %>%
  filter(lbrf == "retired") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

# Others
others_iyes_share <- final_iyes_share %>%
  filter(lbrf == "others") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

```

## By current smoking 

```{r}

# Current smoking
smoke_iyes_share <- final_iyes_share %>%
  filter(smoken == "yes") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

# No smoking
nosmoke_iyes_share <- final_iyes_share %>%
  filter(smoken == "no") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

```

## By alcohol consumption

```{r}

# Weekly alcohol use
drink_iyes_share <- final_iyes_share %>%
  filter(weekdrink == "yes") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

# Less than weekly alcohol use
nodrink_iyes_share <- final_iyes_share %>%
  filter(weekdrink == "no") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )


```

## By physical activity

```{r}

# Physical inactivity
phyinact_iyes_share <- final_iyes_share %>%
  filter(phyinact == "yes") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

# Physical activity
phyact_iyes_share <- final_iyes_share %>%
  filter(phyinact == "no") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

```

## By ADL disability

```{r}

# ADL disability
adl_iyes_share <- final_iyes_share %>%
  filter(adl_any == "yes") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

# No ADL limitation
noadl_iyes_share <- final_iyes_share %>%
  filter(adl_any == "no") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

```

## By chronic conditions

```{r}

# â‰¥1 chronic conditions
dis_iyes_share <- final_iyes_share %>%
  filter(dis > 0) %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

# No chronic conditions
nodis_iyes_share <- final_iyes_share %>%
  filter(dis == 0) %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

```


# Sentivity analyses: Multiple imputation

## Internet use (yes/no)

```{r}

final_mi_iyes <- final_iyes_share %>%
  dplyr::select(!c(cesd_stand, shlt_stand, satlife_stand, depression))

# Setting MICE arguments
predictorMatrix <- matrix(0, nrow = dim(final_mi_iyes)[2], ncol = dim(final_mi_iyes)[2])
colnames(predictorMatrix) <- colnames(final_mi_iyes)
rownames(predictorMatrix) <- colnames(final_mi_iyes)
row_pre <- which(rownames(predictorMatrix) %in% colnames(final_mi_iyes)[-c(1:5)])
col_pre <- which(colnames(predictorMatrix) %in% colnames(final_mi_iyes)[-c(1:5)])
predictorMatrix[row_pre, col_pre] <- 1
for(i in 6:dim(final_mi_iyes)[2]){ predictorMatrix[i,i]<-0 }

cores <- detectCores()
tic()
mi_iyes <- final_mi_iyes %>%
  futuremice(data = ., m = 10, maxit = 5, predictorMatrix = predictorMatrix, parallelseed = 12345, n.core = cores - 1)
toc()

mi_iyes_share <- list()
for(i in 1:10){
  mi_data <- mice::complete(mi_iyes, i) %>%
    mutate(
      cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife),
      depression = ifelse(cesd >= 4, 1, 0)
    )
  
  mi_iyes_share[[i]] <- mi_data
  
  rm(mi_data)
}

mi_iyes_inc_share <- list()
for(i in 1:10){
  mi_data <- mice::complete(mi_iyes, i) %>%
    mutate(depression = ifelse(cesd >= 4, 1, 0)) %>%
    group_by(id) %>%
    filter(first(depression == 0)) %>%
    mutate(
      has_depression = any(depression == 1, na.rm = T)
    ) %>%
    ungroup()
  
  mi_data_bl <- mi_data %>%
    group_by(id) %>%
    slice(1) %>%
    ungroup() %>%
    mutate(iwy_bl = iwy, iwm_bl = iwm)
  
  mi_data_dep <- mi_data %>%
    filter(has_depression == T) %>%
    filter(depression == 1) %>%
    group_by(id) %>%
    slice(1) %>%
    ungroup()
  
  mi_data_nodep <- mi_data %>%
    filter(has_depression == F) %>%
    group_by(id) %>%
    slice(n()) %>%
    ungroup()
  
  mi_iyes_inc_share[[i]] <- bind_rows(mi_data_dep, mi_data_nodep) %>%
    left_join(mi_data_bl %>% select(id, iwy_bl, iwm_bl), by = "id") %>%
    rowwise() %>%
    mutate(
      cmonth = iwy*12 + iwm - iwy_bl*12 - iwm_bl
    ) %>%
    ungroup()
  
  rm(mi_data, mi_data_bl, mi_data_dep, mi_data_nodep)
}


```

## Cumulative internet use

```{r}

final_mi_icum <- final_icum_share %>%
  dplyr::select(!c(cesd_stand, shlt_stand, satlife_stand, depression))

# Setting MICE arguments
predictorMatrix <- matrix(0, nrow = dim(final_mi_icum)[2], ncol = dim(final_mi_icum)[2])
colnames(predictorMatrix) <- colnames(final_mi_icum)
rownames(predictorMatrix) <- colnames(final_mi_icum)
row_pre <- which(rownames(predictorMatrix) %in% colnames(final_mi_icum)[-c(1:5)])
col_pre <- which(colnames(predictorMatrix) %in% colnames(final_mi_icum)[-c(1:5)])
predictorMatrix[row_pre, col_pre] <- 1
for(i in 6:dim(final_mi_icum)[2]){ predictorMatrix[i,i]<-0 }

cores <- detectCores()
tic()
mi_icum <- final_mi_icum %>%
  futuremice(data = ., m = 10, maxit = 5, predictorMatrix = predictorMatrix, parallelseed = 12345, n.core = cores - 1)
toc()

mi_icum_share <- list()

for(i in 1:10){
  mi_data <- mice::complete(mi_icum, i) %>%
    mutate(
      cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife),
      depression = ifelse(cesd >= 4, 1, 0)
    )
  
  mi_icum_share[[i]] <- mi_data
  
  rm(mi_data)
}

```

### G-formula

```{r}

predictorMatrix <- matrix(0, nrow = dim(icum_gformula_share)[2], ncol = dim(icum_gformula_share)[2])
colnames(predictorMatrix) <- colnames(icum_gformula_share)
rownames(predictorMatrix) <- colnames(icum_gformula_share)
row_pre <- which(rownames(predictorMatrix) %in% colnames(icum_gformula_share)[-c(1:3)])
col_pre <- which(colnames(predictorMatrix) %in% colnames(icum_gformula_share)[-c(1:3)])
predictorMatrix[row_pre, col_pre] <- 1
for(i in 4:dim(icum_gformula_share)[2]){ predictorMatrix[i,i]<-0 }

cores <- detectCores()
tic()
mi_icum_gformula <- icum_gformula_share %>%
  futuremice(data = ., m = 10, maxit = 5, predictorMatrix = predictorMatrix, parallelseed = 12345, n.core = cores - 1)
toc()

mi_icum_gformula_share <- list()
tic()
for(i in 1:10){
  mi_data <- mice::complete(mi_icum_gformula, i) %>%
    mutate(
      lowwealth = factor(reverse_code(ntile(atotb, 3))),
      cesd_stand = scale(cesd), satlife_stand = scale(satlife), shlt_stand = scale(shlt)
      ) %>%
    mutate_if(is.factor, as.numeric) %>%
    mutate_at(
      vars(internet_yes, male, lowedu, lowwealth, lbrf, nonmarried, contact, 
           smoken, weekdrink, phyinact, adl_any),
      ~ . -1)
  
  mi_icum_gformula_share[[i]] <- mi_data
  
  rm(mi_data)
}
toc()

```

## Bidirectional association: mental health and Internet use

```{r}

final_mi_bidirec <- final_bidirec_share %>%
  dplyr::select(!c(cesd_stand, shlt_stand, satlife_stand))

# Setting MICE arguments
predictorMatrix <- matrix(0, nrow = dim(final_mi_bidirec)[2], ncol = dim(final_mi_bidirec)[2])
colnames(predictorMatrix) <- colnames(final_mi_bidirec)
rownames(predictorMatrix) <- colnames(final_mi_bidirec)
row_pre <- which(rownames(predictorMatrix) %in% colnames(final_mi_bidirec)[-c(1:5)])
col_pre <- which(colnames(predictorMatrix) %in% colnames(final_mi_bidirec)[-c(1:5)])
predictorMatrix[row_pre, col_pre] <- 1
for(i in 6:dim(final_mi_bidirec)[2]){ predictorMatrix[i,i]<-0 }

cores <- detectCores()
tic()
mi_bidirec <- final_mi_bidirec %>%
  futuremice(data = ., m = 10, maxit = 5, predictorMatrix = predictorMatrix, parallelseed = 12345, n.core = cores - 1)
toc()

mi_bidirec_share <- list()
for(i in 1:10){
  mi_data <- mice::complete(mi_bidirec, i) %>%
    mutate(
      cesd_stand = scale(cesd), satlife_stand = scale(satlife), shlt_stand = scale(shlt)
    )
  
  mi_bidirec_share[[i]] <- mi_data
  
  rm(mi_data)
}

```


# Save data

```{r}

save(
  final_iyes_share, final_icum_share, final_iyes_inc_share, 
  icum_gformula_share, final_bidirec_share, # Complete cases
  middle_iyes_share, old_iyes_share, male_iyes_share, female_iyes_share,
  married_iyes_share, nonmarried_iyes_share, contact_iyes_share, nocontact_iyes_share,
  pedu_iyes_share, sedu_iyes_share, tedu_iyes_share,
  lwealth_iyes_share, mwealth_iyes_share, hwealth_iyes_share,
  work_iyes_share, retired_iyes_share, others_iyes_share,
  smoke_iyes_share, nosmoke_iyes_share, drink_iyes_share, nodrink_iyes_share,
  phyinact_iyes_share, phyact_iyes_share, adl_iyes_share, noadl_iyes_share,
  dis_iyes_share, nodis_iyes_share, # Subgroup analyses
  mi_iyes_share, mi_icum_share, mi_iyes_inc_share, 
  mi_icum_gformula_share, mi_bidirec_share, # Multiple imputation analyses
  file = str_c(getwd(), "/data/processed/share_processed_data.RData", sep = "")
  )

```
