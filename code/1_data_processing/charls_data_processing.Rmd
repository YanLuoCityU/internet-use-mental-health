---
title: "Internet use and mental health"
author: "Yan Luo"
date: '2023-10-01'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Make sure the working directory is "your path/internet-use-mental-health"
knitr::opts_knit$set(root.dir = "D:/github_project/internet-use-mental-health")

library(tidyverse)
library(haven)
library(sjlabelled)
library(mice)
library(tictoc)
library(doParallel)

```

# Self-constructed functions

```{r}

reverse_code <- function(x) {
  max_val <- max(x, na.rm = T)
  return(max_val - x + 1)
}

```

# Import data

## Main datasets: Harmonized_CHARLS

```{r}

print(getwd())

# Import the data
harm_charls <- read_dta(str_c(getwd(), "/data/raw/charls/H_CHARLS_d.dta", sep = ""))

## Transform Harmonized_CHARLS from wide format to long format
wide_harm_charls <- harm_charls %>%
  dplyr::select(
    c(ID, householdID, hhid, pn, pnc, ID_w1, householdID_w1, communityID, ragender, raeducl) | # id, gender, education
      (starts_with("r") & (ends_with("iwy") | ends_with("iwm"))) | # Interview dates (for data merging)
      (starts_with("r") & ends_with("agey")) | # Age
      (starts_with("h") & ends_with("atotb")) | # Household wealth
      (starts_with("r") & (ends_with("lbrf_c"))) | # Labor force status
      (starts_with("r") & (ends_with("smokev") | ends_with("smoken") | ends_with("drinkn_c") | ends_with("vgactx_c") | ends_with("mdactx_c"))) | # Health behaviors
      (starts_with("r") & (ends_with("mstat"))) | # Marital status
      (starts_with("h") & ends_with("hhres")) | # Household size
      (starts_with("r") & (ends_with("hibpe") | ends_with("diabe") | ends_with("cancre") | ends_with("lunge") | ends_with("hearte") | ends_with("stroke") | ends_with("psyche") | ends_with("arthre"))) | # Chronic diseases
      (starts_with("r") & (ends_with("memrye"))) | # Memory-related diseases, Alzheimerâ€™s disease, dementia
      (starts_with("r") & (ends_with("batha") | ends_with("eata") | ends_with("beda") | ends_with("toilta") | ends_with("urina") | ends_with("dressa") | ends_with("adlab_c") | ends_with("adlabm_c"))) | # ADL
      (starts_with("r") & (ends_with("phonea") | ends_with("moneya") | ends_with("medsa") | ends_with("shopa") | ends_with("mealsa") | ends_with("housewka") | ends_with("iadlza") | ends_with("iadlzam"))) | # IADL
      (starts_with("r") & (ends_with("depresl") | ends_with("effortl") | ends_with("sleeprl") | ends_with("whappyl") | ends_with("flonel") | ends_with("botherl") | ends_with("mindtsl") | ends_with("fhopel") | ends_with("fearll") | ends_with("goingl") | ends_with("cesd10") | ends_with("cesd10m"))) | # CES-D
      (starts_with("r") & ends_with("shlta")) | # Self-reported Health
      (starts_with("r") & (ends_with("satlife"))) # Life Satisfaction
     ) %>% 
  mutate(
    .keep = "unused",
    r1phonea = NA, r1iadlza = NA, r1iadlzam = NA, # IADL
    h1atotb = hh1atotb, h2atotb = hh2atotb
    ) 

index_reorder <- str_detect(names(wide_harm_charls), "[h-r][0-9]+(.*)")
names_reorder <- names(wide_harm_charls)[index_reorder] %>% 
  str_match("[h-r]([0-9]+)(.*)") %>% 
  as_tibble() %>% 
  arrange(.[[3]], .[[2]]) %>%
  dplyr::select(V1) %>%
  as_vector("character") %>% unname()

long_charls <- wide_harm_charls %>% 
  dplyr::select(!contains(names_reorder), contains(names_reorder)) %>%
    pivot_longer(
    col = !c(ID, householdID, hhid, pn, pnc, ID_w1, householdID_w1, communityID, ragender, raeducl),
    names_to = ".value",
    names_pattern = "[h-r][0-9]+(.*)"
  ) %>%
  mutate(
      wave = case_when(
      iwy %in% c(2010:2012) ~ 2011,
      iwy %in% c(2013:2014) ~ 2013,
      iwy %in% c(2015:2016) ~ 2015,
      iwy %in% c(2018:2018) ~ 2018
    )
  ) %>%
  remove_all_labels() %>%
  zap_formats()

rm(harm_charls, wide_harm_charls, index_reorder, names_reorder)

```

## 2011 - 2018 cohort original questionnaire

```{r}

# Province information
charls_prov <- read_dta(str_c(getwd(), "/data/raw/charls/2011/psu.dta")) %>%
  remove_all_labels() %>%
  zap_formats()

# 2011
charls_w1 <- read_dta(str_c(getwd(), "/data/raw/charls/2011/demographic_background.dta")) %>%
  left_join(read_dta(str_c(getwd(), "/data/raw/charls/2011/weight.dta")), by = c("ID", "householdID", "communityID")) %>%
  left_join(read_dta(str_c(getwd(), "/data/raw/charls/2011/health_status_and_functioning.dta")), by = c("ID", "householdID", "communityID")) %>%
  mutate(
    .keep = "none",
    ID, householdID, communityID, iwy = as.numeric(iyear), wave = 2011,
    internet = da056s10, internet_f = da057_10_
  ) %>% 
  mutate(
    ID = str_c(householdID, "0", str_sub(ID, 10, 11)),
    householdID = str_c(householdID, "0")
    ) %>%
  remove_all_labels() %>%
  zap_formats()

# 2013
charls_w2 <- read_dta(str_c(getwd(), "/data/raw/charls/2013/Demographic_Background.dta")) %>%
  left_join(read_dta(str_c(getwd(), "/data/raw/charls/2013/Weights.dta")), by = c("ID", "householdID", "communityID")) %>%
  left_join(read_dta(str_c(getwd(), "/data/raw/charls/2013/Health_Status_and_Functioning.dta")), by = c("ID", "householdID", "communityID")) %>%
  mutate(
    .keep = "none",
    ID, householdID, communityID, iwy = as.numeric(iyear), wave = 2013,
    internet = da056s10, internet_f = da057_10_
  ) %>%
  remove_all_labels() %>%
  zap_formats()

# 2015
charls_w3 <- read_dta(str_c(getwd(), "/data/raw/charls/2015/Demographic_Background.dta")) %>%
  left_join(read_dta(str_c(getwd(), "/data/raw/charls/2015/Sample_Infor.dta")), by = c("ID", "householdID", "communityID")) %>%
  left_join(read_dta(str_c(getwd(), "/data/raw/charls/2015/Health_Status_and_Functioning.dta")), by = c("ID", "householdID", "communityID")) %>%
  mutate(
    .keep = "none",
    ID, householdID, communityID, iwy = as.numeric(iyear), wave = 2015,
    internet = da056s10, internet_f = da057_10_
  ) %>%
  remove_all_labels() %>%
  zap_formats()

charls_w3_dis <- read_dta(str_c(getwd(), "/data/raw/charls/2015/Demographic_Background.dta")) %>%
  left_join(read_dta(str_c(getwd(), "/data/raw/charls/2015/Sample_Infor.dta")), by = c("ID", "householdID", "communityID")) %>%
  left_join(read_dta(str_c(getwd(), "/data/raw/charls/2015/Health_Status_and_Functioning.dta")), by = c("ID", "householdID", "communityID")) %>%
  mutate(
    .keep = "none",
    ID, householdID, communityID, iwy = as.numeric(iyear), wave = 2015,
    hyper = case_when(
      (zda007_1_ == 1 & da007_w2_1_1_ == 1) | (is.na(zda007_1_) & da007_w2_1_1_ == 2)| (zda007_1_ == 1 & da007_w2_1_1_ == 2 & da007_w2_2_1_ == 1) | da007_1_ == 1 ~ 1,
      (zda007_1_ == 1 & da007_w2_1_1_ == 2 & da007_w2_2_1_ == 2) | (is.na(zda007_1_) & da007_w2_1_1_ == 1) | da007_1_ == 2 ~ 0,
      TRUE ~ NA_real_
    ),
    dyslip = case_when(
      (zda007_2_ == 1 & da007_w2_1_2_ == 1) | (is.na(zda007_2_) & da007_w2_1_2_ == 2)| (zda007_2_ == 1 & da007_w2_1_2_ == 2 & da007_w2_2_2_ == 1) | da007_2_ == 1 ~ 1,
      (zda007_2_ == 1 & da007_w2_1_2_ == 2 & da007_w2_2_2_ == 2) | (is.na(zda007_2_) & da007_w2_1_2_ == 1) | da007_2_ == 2 ~ 0,
      TRUE ~ NA_real_
    ),
    diabetes = case_when(
      (zda007_3_ == 1 & da007_w2_1_3_ == 1) | (is.na(zda007_3_) & da007_w2_1_3_ == 2)| (zda007_3_ == 1 & da007_w2_1_3_ == 2 & da007_w2_2_3_ == 1) | da007_3_ == 1 ~ 1,
      (zda007_3_ == 1 & da007_w2_1_3_ == 2 & da007_w2_2_3_ == 2) | (is.na(zda007_3_) & da007_w2_1_3_ == 1) | da007_3_ == 2 ~ 0,
      TRUE ~ NA_real_
    ),
    cancer = case_when(
      (zda007_4_ == 1 & da007_w2_1_4_ == 1) | (is.na(zda007_4_) & da007_w2_1_4_ == 2)| (zda007_4_ == 1 & da007_w2_1_4_ == 2 & da007_w2_2_4_ == 1) | da007_4_ == 1 ~ 1,
      (zda007_4_ == 1 & da007_w2_1_4_ == 2 & da007_w2_2_4_ == 2) | (is.na(zda007_4_) & da007_w2_1_4_ == 1) | da007_4_ == 2 ~ 0,
      TRUE ~ NA_real_
    ),
    lung = case_when(
      (zda007_5_ == 1 & da007_w2_1_5_ == 1) | (is.na(zda007_5_) & da007_w2_1_5_ == 2)| (zda007_5_ == 1 & da007_w2_1_5_ == 2 & da007_w2_2_5_ == 1) | da007_5_ == 1 ~ 1,
      (zda007_5_ == 1 & da007_w2_1_5_ == 2 & da007_w2_2_5_ == 2) | (is.na(zda007_5_) & da007_w2_1_5_ == 1) | da007_5_ == 2 ~ 0,
      TRUE ~ NA_real_
    ),
    liver = case_when(
      (zda007_6_ == 1 & da007_w2_1_6_ == 1) | (is.na(zda007_6_) & da007_w2_1_6_ == 2)| (zda007_6_ == 1 & da007_w2_1_6_ == 2 & da007_w2_2_6_ == 1) | da007_6_ == 1 ~ 1,
      (zda007_6_ == 1 & da007_w2_1_6_ == 2 & da007_w2_2_6_ == 2) | (is.na(zda007_6_) & da007_w2_1_6_ == 1) | da007_6_ == 2 ~ 0,
      TRUE ~ NA_real_
    ),
    heart = case_when(
      (zda007_7_ == 1 & da007_w2_1_7_ == 1) | (is.na(zda007_7_) & da007_w2_1_7_ == 2)| (zda007_7_ == 1 & da007_w2_1_7_ == 2 & da007_w2_2_7_ == 1) | da007_7_ == 1 ~ 1,
      (zda007_7_ == 1 & da007_w2_1_7_ == 2 & da007_w2_2_7_ == 2) | (is.na(zda007_7_) & da007_w2_1_7_ == 1) | da007_7_ == 2 ~ 0,
      TRUE ~ NA_real_
    ),
    stroke2 = case_when(
      (zda007_8_ == 1 & da007_w2_1_8_ == 1) | (is.na(zda007_8_) & da007_w2_1_8_ == 2)| (zda007_8_ == 1 & da007_w2_1_8_ == 2 & da007_w2_2_8_ == 1) | da007_8_ == 1 ~ 1,
      (zda007_8_ == 1 & da007_w2_1_8_ == 2 & da007_w2_2_8_ == 2) | (is.na(zda007_8_) & da007_w2_1_8_ == 1) | da007_8_ == 2 ~ 0,
      TRUE ~ NA_real_
    ),
    kidney = case_when(
      (zda007_9_ == 1 & da007_w2_1_9_ == 1) | (is.na(zda007_9_) & da007_w2_1_9_ == 2)| (zda007_9_ == 1 & da007_w2_1_9_ == 2 & da007_w2_2_9_ == 1) | da007_9_ == 1 ~ 1,
      (zda007_9_ == 1 & da007_w2_1_9_ == 2 & da007_w2_2_9_ == 2) | (is.na(zda007_9_) & da007_w2_1_9_ == 1) | da007_9_ == 2 ~ 0,
      TRUE ~ NA_real_
    ),
    stomach = case_when(
      (zda007_10_ == 1 & da007_w2_1_10_ == 1) | (is.na(zda007_10_) & da007_w2_1_10_ == 2)| (zda007_10_ == 1 & da007_w2_1_10_ == 2 & da007_w2_2_10_ == 1) | da007_10_ == 1 ~ 1,
      (zda007_10_ == 1 & da007_w2_1_10_ == 2 & da007_w2_2_10_ == 2) | (is.na(zda007_10_) & da007_w2_1_10_ == 1) | da007_10_ == 2 ~ 0,
      TRUE ~ NA_real_
    ),
    emotion = case_when(
      (zda007_11_ == 1 & da007_w2_1_11_ == 1) | (is.na(zda007_11_) & da007_w2_1_11_ == 2)| (zda007_11_ == 1 & da007_w2_1_11_ == 2 & da007_w2_2_11_ == 1) | da007_11_ == 1 ~ 1,
      (zda007_11_ == 1 & da007_w2_1_11_ == 2 & da007_w2_2_11_ == 2) | (is.na(zda007_11_) & da007_w2_1_11_ == 1) | da007_11_ == 2 ~ 0,
      TRUE ~ NA_real_
    ),
    memory = case_when(
      (zda007_12_ == 1 & da007_w2_1_12_ == 1) | (is.na(zda007_12_) & da007_w2_1_12_ == 2)| (zda007_12_ == 1 & da007_w2_1_12_ == 2 & da007_w2_2_12_ == 1) | da007_12_ == 1 ~ 1,
      (zda007_12_ == 1 & da007_w2_1_12_ == 2 & da007_w2_2_12_ == 2) | (is.na(zda007_12_) & da007_w2_1_12_ == 1) | da007_12_ == 2 ~ 0,
      TRUE ~ NA_real_
    ),
    arthritis = case_when(
      (zda007_13_ == 1 & da007_w2_1_13_ == 1) | (is.na(zda007_13_) & da007_w2_1_13_ == 2)| (zda007_13_ == 1 & da007_w2_1_13_ == 2 & da007_w2_2_13_ == 1) | da007_13_ == 1 ~ 1,
      (zda007_13_ == 1 & da007_w2_1_13_ == 2 & da007_w2_2_13_ == 2) | (is.na(zda007_13_) & da007_w2_1_13_ == 1) | da007_13_ == 2 ~ 0,
      TRUE ~ NA_real_
    ),
    asthma = case_when(
      (zda007_14_ == 1 & da007_w2_1_14_ == 1) | (is.na(zda007_14_) & da007_w2_1_14_ == 2)| (zda007_14_ == 1 & da007_w2_1_14_ == 2 & da007_w2_2_14_ == 1) | da007_14_ == 1 ~ 1,
      (zda007_14_ == 1 & da007_w2_1_14_ == 2 & da007_w2_2_14_ == 2) | (is.na(zda007_14_) & da007_w2_1_14_ == 1) | da007_14_ == 2 ~ 0,
      TRUE ~ NA_real_
    )
  )

# 2018
charls_w4 <- read_dta(str_c(getwd(), "/data/raw/charls/2018/Demographic_Background.dta")) %>%
  left_join(read_dta(str_c(getwd(), "/data/raw/charls/2018/Sample_Infor.dta")), by = c("ID", "householdID", "communityID")) %>%
  left_join(read_dta(str_c(getwd(), "/data/raw/charls/2018/Health_Status_and_Functioning.dta")), by = c("ID", "householdID", "communityID")) %>%
  mutate(
    .keep = "none",
    ID, householdID, communityID, iwy = as.numeric(iyear), wave = 2018,
    internet = da056_s10, internet_f = da057_10_
  ) %>%
  remove_all_labels() %>%
  zap_formats()

long_original <- bind_rows(charls_w1, charls_w2, charls_w3, charls_w4) %>%
  left_join(charls_prov %>% dplyr::select(communityID, province_eng), by = "communityID")

rm(charls_w1, charls_w2, charls_w3, charls_w4, charls_prov)

```

# Variable definition

```{r}

# Merge datasets
long_merge <- long_charls %>%
  left_join(long_original, by = c("ID", "householdID", "communityID", "wave", "iwy")) %>%
  left_join(charls_w3_dis, by = c("ID", "householdID", "communityID", "wave", "iwy"))

rm(long_charls, long_original, charls_w3_dis)


# Define variables
tidy_charls <- long_merge %>%
  filter(!is.na(iwy)) %>%
  mutate( 
    .keep = "none",
    ## Basic information
    id = as.numeric(ID), cohort = "charls", country = 156, wave, iwy, iwm,
    
    ## Exposure variables
    internet_yes = case_when(
      internet == 10 ~ "yes",
      wave < 2018 & is.na(internet) ~ "no",
      wave == 2018 & internet == 0 ~ "no",
      TRUE ~ NA_character_
    ),
    internet_yes = relevel(factor(internet_yes), ref = "no"),
    internet_freq = case_when(
      internet_yes == "yes" &  internet_f == 1 ~ "daily",
      internet_yes == "yes" &  internet_f == 2 ~ "weekly",
      internet_yes == "yes" &  internet_f == 3 ~ "notregularly",
      internet_yes == "no" ~ "none",
      TRUE ~ NA_character_
    ),
    internet_freq = factor(internet_freq, levels = c("none", "notregularly", "weekly", "daily")),
    
    ## Outcomes
    # depressive symptom
    depresl, flonel, effortl, sleeprl, whappyl = reverse_code(whappyl), botherl, mindtsl, fhopel = reverse_code(fhopel), fearll, goingl,
    # self-rated health
    shlt = reverse_code(shlta), 
    # life satisfaction
    satlife, 
    
    ## Covariates
    # Demographics
    age = agey, 
    male = ifelse(ragender == 2, "female", "male"), male = relevel(factor(male), ref = "female"),
    nonmarried = case_when(
      mstat %in% c(1:3) ~ "no",
      mstat %in% c(4:8) ~ "yes",
      TRUE ~ NA_character_
      ),
    nonmarried = relevel(factor(nonmarried), ref = "no"),
    hhres, 

    # Socioeconomic status
    atotb, 
    lowedu = case_when(
      raeducl == 3 ~ "tertiary",
      raeducl == 2 ~ "secondary",
      raeducl == 1 ~ "primary",
      TRUE ~ NA_character_
    ),
    lowedu = relevel(factor(lowedu), ref = "tertiary"),
    lbrf = case_when(
      lbrf_c %in% c(1:5) ~ "employed",
      lbrf_c %in% c(7) ~ "retired",
      lbrf_c %in% c(6,8) ~ "others",
      TRUE ~ NA_character_
    ), 
    lbrf = relevel(factor(lbrf), ref = "employed"),
    
    # Health behaviors
    smoke = case_when(
      smokev == 0 ~ "never",
      smokev == 1 & smoken == 0 ~ "ever",
      smoken == 1 ~ "current",
      TRUE ~ NA_character_
    ),
    smoke = relevel(factor(smoke), ref = "never"),
    smoken = ifelse(smoken == 1, "yes", "no"), smoken = relevel(factor(smoken), ref = "no"),
    weekdrink = case_when(
      drinkn_c %in% c(0:3) ~ "no",
      drinkn_c %in% c(1:9) ~ "yes",
      TRUE ~ NA_character_
    ),
    weekdrink = relevel(factor(weekdrink), ref = "no"),
    phyinact = case_when(
      vgactx_c %in% c(1:7) | mdactx_c %in% c(1:7) ~ "no",
      vgactx_c == 0 & mdactx_c == 0 ~ "yes",
      TRUE ~ NA_character_
    ),
    phyinact = relevel(factor(phyinact), ref = "no"),
    
    # Physical health
    hibpe = ifelse(is.na(hibpe), hyper, hibpe), 
    diabe = ifelse(is.na(diabe), diabetes, diabe),
    cancre = ifelse(is.na(cancre), cancer, cancre), 
    lunge = ifelse(is.na(lunge), lung, lunge),
    hearte = ifelse(is.na(hearte), heart, hearte),
    stroke = ifelse(is.na(stroke), stroke2, stroke), 
    arthre = ifelse(is.na(arthre), arthritis, arthre), 
    psyche = ifelse(is.na(psyche), emotion, psyche),
    psyche = factor(psyche, labels = c("no", "yes")), 
    psyche = relevel(factor(psyche), ref = "no"),
    memrye = ifelse(is.na(memrye), memory, memrye),
    memrye = factor(memrye, labels = c("no", "yes")), 
    memrye = relevel(factor(memrye), ref = "no"),
    dressa, batha, eata, beda, toilta, urina, # ADLs 
    moneya, medsa, shopa, mealsa, housewka # IADLs
  ) %>%
  arrange(id, wave) %>%
  rowwise() %>%
  mutate(
    dis = sum(c(hibpe, diabe, cancre, lunge, hearte, stroke, arthre), na.rm = F),
    dis_miss = sum(is.na(c(hibpe, diabe, cancre, lunge, hearte, stroke, arthre)), na.rm = F),
    adl = sum(c(dressa, batha, eata, beda, toilta, urina), na.rm = F),
    adl_miss = sum(is.na(c(dressa, batha, eata, beda, toilta, urina)), na.rm = F),
    iadl = sum(c(moneya, medsa, shopa, mealsa, housewka), na.rm = F),
    iadl_miss = sum(is.na(c(moneya, medsa, shopa, mealsa, housewka)), na.rm = F),
  ) %>%
  ungroup() %>%
  mutate(
    dis = ifelse(dis_miss == 7, NA, dis),
    adl = ifelse(adl_miss == 6, NA, adl),
    iadl = ifelse(iadl_miss == 6, NA, iadl),
    adl_any = ifelse(adl == 0, "no", "yes"), adl_any = relevel(factor(adl_any), ref = "no")
  )

length(unique(tidy_charls$id))

```


# Generate analytic samples

## Internet use (yes/no)

```{r}

# Keep participants aged >=51 years
id_50plus <- tidy_charls %>%
  group_by(id) %>%
  slice(1) %>%
  ungroup() %>%
  filter(age >= 50) %>%
  pull(id)

filter_50plus <- tidy_charls %>%
  filter(id %in% id_50plus)
length(unique(filter_50plus$id)) # 16908

# Keep participants with complete data on internet use at baseline
id_iyes <- filter_50plus %>%
  group_by(id) %>%
  slice(1) %>%
  ungroup() %>%
  filter(!is.na(internet_yes)) %>%
  pull(id)

filter_iyes <- filter_50plus %>%
  filter(id %in% id_iyes)
length(unique(filter_iyes$id)) # 16903

# Keep participants with complete data on outcomes at baseline
## Depressive symptoms
id_cesd_bl <- filter_iyes %>%
  rowwise() %>%
  mutate(
    cesd_miss = sum(is.na(c(depresl, flonel, effortl, sleeprl, whappyl, botherl, mindtsl, fhopel, fearll, goingl)), na.rm = F)
  ) %>%
  ungroup() %>%
  mutate(
    with_cesd = ifelse(cesd_miss == 0, 1, 0)
  ) %>%
  group_by(id) %>%
  slice(1) %>%
  filter(with_cesd == 1) %>% 
  ungroup() %>%
  pull(id)

## Self-rated health
id_shlt_bl <- filter_iyes %>%
  mutate(
    with_shlt = ifelse(!is.na(shlt), 1, 0)
  ) %>%
  group_by(id) %>%
  slice(1) %>%
  filter(with_shlt == 1) %>% 
  ungroup() %>%
  pull(id)

## Life satisfaction
id_satlife_bl <- filter_iyes %>%
  mutate(
    with_satlife = ifelse(!is.na(satlife), 1, 0)
  ) %>%
  group_by(id) %>%
  slice(1) %>%
  filter(with_satlife == 1) %>% 
  ungroup() %>%
  pull(id)

id_ot_bl <- intersect(id_cesd_bl, id_shlt_bl) # 14278
id_ot_bl <- intersect(id_ot_bl, id_satlife_bl) # 13036

filter_ot_bl <- filter_iyes %>%
  filter(id %in% id_ot_bl)
length(unique(filter_ot_bl$id)) # 13036

# Keep participants with at least one-wave complete data on outcomes over follow-ups
id_2obs <- filter_ot_bl %>%
  group_by(id) %>%
  filter(n() >= 2) %>%
  dplyr::slice(1) %>%
  ungroup() %>%
  pull(id)

filter_2obs <- filter_ot_bl %>%
  filter(id %in% id_2obs)
length(unique(filter_2obs$id)) # 11843

## Depressive symptoms
id_cesd <- filter_2obs %>%
  rowwise() %>%
  mutate(
    cesd_miss = sum(is.na(c(depresl, flonel, effortl, sleeprl, whappyl, botherl, mindtsl, fhopel, fearll, goingl)), na.rm = F)
  ) %>%
  ungroup() %>%
  mutate(
    with_cesd = ifelse(cesd_miss == 0, 1, 0)
  ) %>%
  group_by(id) %>%
  slice(2:n()) %>%
  mutate(
    t_with_cesd = cumsum(with_cesd)
    ) %>%
  slice(n()) %>%
  filter(t_with_cesd >= 1) %>% 
  ungroup() %>%
  pull(id)

## Self-rated health
id_shlt <- filter_2obs %>%
  mutate(
    with_shlt = ifelse(!is.na(shlt), 1, 0)
  ) %>%
  group_by(id) %>%
  slice(2:n()) %>%
  mutate(
    t_with_shlt = cumsum(with_shlt)
    ) %>%
  slice(n()) %>%
  filter(t_with_shlt >= 1) %>% 
  ungroup() %>%
  pull(id)

## Life satisfaction
id_satlife <- filter_2obs %>%
  mutate(
    with_satlife = ifelse(!is.na(satlife), 1, 0)
  ) %>%
  group_by(id) %>%
  slice(2:n()) %>%
  mutate(
    t_with_satlife = cumsum(with_satlife)
    ) %>%
  slice(n()) %>%
  filter(t_with_satlife >= 1) %>% 
  ungroup() %>%
  pull(id)

id_ot <- intersect(id_cesd, id_shlt) # 11133
id_ot <- intersect(id_ot, id_satlife) # 11124

filter_ot <- filter_2obs %>%
  filter(id %in% id_ot)
length(unique(filter_ot$id)) # 11124

# Keep participants without dementia and psychological diseases at baseline
id_mental <- filter_ot %>%
  group_by(id) %>%
  slice(1) %>%
  ungroup() %>%
  filter(memrye == "yes" | psyche == "yes") %>%
  pull(id)

filter_nomental <- filter_ot %>%
  filter(!id %in% id_mental) 
length(unique(filter_nomental$id)) # 10872

# Keep participants with complete data on covariates at baseline
id_cov <- filter_nomental %>%
  rowwise() %>%
  mutate(
    cov_miss = sum(is.na(c(age, male, atotb, lowedu, lbrf, nonmarried, hhres, smoken, weekdrink, phyinact, dis, adl_any, iadl)), na.rm = F)
  ) %>%
  ungroup() %>%
  mutate(
    with_cov = ifelse(cov_miss == 0, 1, 0) # with all items
  ) %>%
  group_by(id) %>%
  slice(1) %>%
  ungroup() %>%
  filter(with_cov == 1) %>%
  pull(id)

filter_cov_iyes <- filter_nomental %>%
  filter(id %in% id_cov) %>%
  rowwise() %>%
  mutate(
    cesd = sum(c(depresl, flonel, effortl, sleeprl, whappyl, botherl, mindtsl, fhopel, fearll, goingl), na.rm = F)
  ) %>%
  ungroup()
    
length(unique(filter_cov_iyes$id)) # 3003

table(filter_cov_iyes %>% group_by(id) %>% summarise(count = n()) %>% pull(count))

# Final
bl <- filter_cov_iyes %>% 
  group_by(id) %>% 
  slice(1) %>%
  ungroup() %>%
  mutate(
    .keep = "none",
    id, internet_yes, 
    age, male, lowedu, lowwealth = factor(reverse_code(ntile(atotb, 4))), lbrf, 
    nonmarried, hhres, smoken, weekdrink, phyinact,
    dis, adl_any, iadl
    )

final <- filter_cov_iyes %>%
  group_by(id) %>%
  mutate(
    fisrt = first(wave),
    cwave = wave - fisrt
  ) %>%
  ungroup() %>%
  mutate(
    .keep = "none",
    id, country, iwy, iwm, wave,
    cesd, shlt, satlife, 
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife),
    cwave
  ) %>%
  dplyr::select(
    id, country, iwy, iwm, wave,
    cesd, shlt, satlife,
    cesd_stand, shlt_stand, satlife_stand,
    cwave
  )

final_iyes_charls <- final %>% 
  left_join(., bl, by = "id") %>%
  mutate(
    id = str_c("charls_", id)
  )

rm(bl, final)
rm(list = ls()[str_detect(string = ls(), pattern = "id_")])
object <- ls()[str_detect(string = ls(), pattern = "filter_")]
rm(list = object[!object %in% "filter_cov_iyes"])

```

## Internet use frequency

```{r}

filter_cov_ifreq <- filter_cov_iyes

bl <- filter_cov_ifreq %>% 
  group_by(id) %>% 
  slice(1) %>%
  ungroup() %>%
  mutate(
    .keep = "none",
    id, internet_freq, 
    age, male, lowedu, lowwealth = factor(reverse_code(ntile(atotb, 3))), lbrf, 
    nonmarried, hhres, smoken, weekdrink, phyinact,
    dis, adl_any, iadl
    )

final <- filter_cov_ifreq %>%
  group_by(id) %>%
  mutate(
    fisrt = first(wave),
    cwave = wave - fisrt
  ) %>%
  ungroup() %>%
  mutate(
    .keep = "none",
    id, country, iwy, iwm, wave,
    cesd, shlt, satlife, 
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife),
    cwave
  ) %>%
  dplyr::select(
    id, country, iwy, iwm, wave,
    cesd, shlt, satlife,
    cesd_stand, shlt_stand, satlife_stand,
    cwave
  )

final_ifreq_charls <- final %>% 
  left_join(., bl, by = "id") %>%
  mutate(
    id = str_c("elsa_", id)
  )

rm(bl, final)
rm(list = ls()[str_detect(string = ls(), pattern = "id_")])
object <- ls()[str_detect(string = ls(), pattern = "filter_")]
rm(list = object[!object %in% "filter_cov_iyes"])
  
```

## Cumulative internet use

```{r}

# Keep participants aged >=51 years
id_50plus <- tidy_charls %>%
  group_by(id) %>%
  slice(1) %>%
  ungroup() %>%
  filter(age >= 50) %>%
  pull(id)

filter_50plus <- tidy_charls %>%
  filter(id %in% id_50plus)
length(unique(filter_50plus$id)) # 16908

# Keep participants with two consecutive wave complete data on internet use
id_2iobs <- filter_50plus %>%
  mutate(
    with_iyes = ifelse(!is.na(internet_yes), 1, 0)
  ) %>%
  group_by(id) %>%
  filter(n() >= 2) %>%
  slice(1:2) %>%
  mutate(
    wave_int = wave - lag(wave, default = first(wave)),
    t_with_iyes = cumsum(with_iyes)
  ) %>%
  filter(wave_int <= 3) %>%
  slice(n()) %>%
  filter(t_with_iyes == 2) %>%
  select(id, wave, wave_int, age, internet_yes, t_with_iyes) %>%
  ungroup() %>%
  pull(id)

filter_2iobs <- filter_50plus %>%
  filter(id %in% id_2iobs)
length(unique(filter_2iobs$id)) # 14053

# Keep participants with complete data on outcomes at the third wave (baseline)
## Depressive symptoms
id_cesd_2w <- filter_2iobs %>%
  rowwise() %>%
  mutate(
    cesd_miss = sum(is.na(c(depresl, flonel, effortl, sleeprl, whappyl, botherl, mindtsl, fhopel, fearll, goingl)), na.rm = F)
  ) %>%
  ungroup() %>%
  mutate(
    with_cesd = ifelse(cesd_miss == 0, 1, 0)
  ) %>%
  group_by(id) %>%
  slice(2) %>%
  filter(with_cesd == 1) %>% 
  ungroup() %>%
  pull(id)

## Self-rated health
id_shlt_2w <- filter_2iobs %>%
  mutate(
    with_shlt = ifelse(!is.na(shlt), 1, 0)
  ) %>%
  group_by(id) %>%
  slice(2) %>%
  filter(with_shlt == 1) %>% 
  ungroup() %>%
  pull(id)

## Life satisfaction
id_satlife_2w <- filter_2iobs %>%
  mutate(
    with_satlife = ifelse(!is.na(satlife), 1, 0)
  ) %>%
  group_by(id) %>%
  slice(2) %>%
  filter(with_satlife == 1) %>% 
  ungroup() %>%
  pull(id)

id_ot_2w <- intersect(id_cesd_2w, id_shlt_2w) # 11610
id_ot_2w <- intersect(id_ot_2w, id_satlife_2w) # 11555

filter_ot_2w <- filter_2iobs %>%
  filter(id %in% id_ot_2w)
length(unique(filter_ot_2w$id)) # 11555

# Keep participants with at least one-wave complete data on outcomes over follow-ups
id_3obs <- filter_ot_2w %>%
  group_by(id) %>%
  filter(n() >= 3) %>%
  dplyr::slice(1) %>%
  ungroup() %>%
  pull(id)

filter_3obs <- filter_ot_2w %>%
  filter(id %in% id_3obs)
length(unique(filter_3obs$id)) # 10171

## Depressive symptoms
id_cesd <- filter_3obs %>%
  rowwise() %>%
  mutate(
    cesd_miss = sum(is.na(c(depresl, flonel, effortl, sleeprl, whappyl, botherl, mindtsl, fhopel, fearll, goingl)), na.rm = F)
  ) %>%
  ungroup() %>%
  mutate(
    with_cesd = ifelse(cesd_miss == 0, 1, 0)
  ) %>%
  group_by(id) %>%
  slice(3:n()) %>%
  mutate(
    t_with_cesd = cumsum(with_cesd)
    ) %>%
  slice(n()) %>%
  filter(t_with_cesd >= 1) %>% 
  ungroup() %>%
  pull(id)

## Self-rated health
id_shlt <- filter_3obs %>%
  mutate(
    with_shlt = ifelse(!is.na(shlt), 1, 0)
  ) %>%
  group_by(id) %>%
  slice(3:n()) %>%
  mutate(
    t_with_shlt = cumsum(with_shlt)
    ) %>%
  slice(n()) %>%
  filter(t_with_shlt >= 1) %>% 
  ungroup() %>%
  pull(id)

## Life satisfaction
id_satlife <- filter_3obs %>%
  mutate(
    with_satlife = ifelse(!is.na(satlife), 1, 0)
  ) %>%
  group_by(id) %>%
  slice(3:n()) %>%
  mutate(
    t_with_satlife = cumsum(with_satlife)
    ) %>%
  slice(n()) %>%
  filter(t_with_satlife >= 1) %>% 
  ungroup() %>%
  pull(id)

id_ot <- intersect(id_cesd, id_shlt) # 9365
id_ot <- intersect(id_ot, id_satlife) # 9356

filter_ot <- filter_3obs %>%
  filter(id %in% id_ot)
length(unique(filter_ot$id)) # 9356

# Keep participants without dementia and psychological diseases at baseline
id_mental <- filter_ot %>%
  group_by(id) %>%
  slice(2) %>%
  ungroup() %>%
  filter(memrye == "yes" | psyche == "yes") %>%
  pull(id)

filter_nomental <- filter_ot %>%
  filter(!id %in% id_mental) 
length(unique(filter_nomental$id)) # 9085

# Keep participants with complete data on covariates at baseline
id_cov <- filter_nomental %>%
  rowwise() %>%
  mutate(
    cov_miss = sum(is.na(c(age, male, atotb, lowedu, lbrf, nonmarried, hhres, smoken, weekdrink, phyinact, dis, adl_any, iadl)), na.rm = F)
  ) %>%
  ungroup() %>%
  mutate(
    with_cov = ifelse(cov_miss == 0, 1, 0)
  ) %>%
  group_by(id) %>%
  slice(1) %>%
  ungroup() %>%
  filter(with_cov == 1) %>%
  pull(id)

filter_cov <- filter_nomental %>%
  filter(id %in% id_cov) %>%
  rowwise() %>%
  mutate(
    cesd = sum(c(depresl, flonel, effortl, sleeprl, whappyl, botherl, mindtsl, fhopel, fearll, goingl), na.rm = F)
  ) %>%
  ungroup()
length(unique(filter_cov$id)) # 2444

# Final
icum <- filter_cov %>%
  mutate(
    internet_yes = as.numeric(internet_yes) - 1
    ) %>%
  group_by(id) %>%
  slice(1:2) %>%
  mutate(
    internet_cum = cumsum(internet_yes) # Cumulative internet use
    ) %>% 
  slice(n()) %>%
  ungroup() %>%
  mutate(
    .keep = "none", id, internet_cum
  )

bl <- filter_cov %>% 
  group_by(id) %>% 
  slice(1) %>%
  ungroup() %>%
  mutate(
    .keep = "none",
    id, 
    age, male, lowedu, lowwealth = factor(reverse_code(ntile(atotb, 4))), lbrf, 
    nonmarried, hhres, smoken, weekdrink, phyinact,
    dis, adl_any, iadl
    ) %>%
  left_join(., icum, by = c("id"))

final <- filter_cov %>%
  group_by(id) %>%
  slice(2:n()) %>%
  mutate(
    fisrt = first(wave),
    cwave = wave - fisrt
  ) %>%
  ungroup() %>%
  mutate(
    .keep = "none",
    id, country, iwy, iwm, wave, 
    cesd, shlt, satlife, 
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife),
    cwave
  ) %>%
  dplyr::select(
    id, country, iwy, iwm, wave,
    cesd, shlt, satlife,
    cesd_stand, shlt_stand, satlife_stand,
    cwave
  )

final_icum_charls <- final %>% 
  left_join(., bl, by = "id") %>%
  mutate(
    id = str_c("charls_", id)
  )

rm(icum, bl, final)
rm(list = ls()[str_detect(string = ls(), pattern = "id_")])
object <- ls()[str_detect(string = ls(), pattern = "filter_")]
rm(list = object[!object %in% "filter_cov_iyes"])

```

# Subgroup analyses: Internet use (yes/no)

## By age

```{r}

# 50-64 years
middle_iyes_charls <- final_iyes_charls %>%
  filter(age < 65) %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

# â‰¥65 years
old_iyes_charls <- final_iyes_charls %>%
  filter(age >= 65) %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

```

## By gender

```{r}

# Male
male_iyes_charls <- final_iyes_charls %>%
  filter(male == "male") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

# Female
female_iyes_charls <- final_iyes_charls %>%
  filter(male == "female") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

```

## By marital status

```{r}

# Married
married_iyes_charls <- final_iyes_charls %>%
  filter(nonmarried == "no") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

# Unmarried
nonmarried_iyes_charls <- final_iyes_charls %>%
  filter(nonmarried == "yes") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

```

## By education

```{r}

# Primary
pedu_iyes_charls <- final_iyes_charls %>%
  filter(lowedu == "primary") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

# Secondary
sedu_iyes_charls <- final_iyes_charls %>%
  filter(lowedu == "secondary") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

# Tertiary
tedu_iyes_charls <- final_iyes_charls %>%
  filter(lowedu == "tertiary") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

```

## By household wealth

```{r}

# Low
lwealth_iyes_charls <- final_iyes_charls %>%
  filter(lowwealth == 3) %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

# Middle
mwealth_iyes_charls <- final_iyes_charls %>%
  filter(lowwealth == 2) %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

# High
hwealth_iyes_charls <- final_iyes_charls %>%
  filter(lowwealth == 1) %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

```

## By labor force status

```{r}

# Working
work_iyes_charls <- final_iyes_charls %>%
  filter(lbrf == "employed") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

# Retired
retired_iyes_charls <- final_iyes_charls %>%
  filter(lbrf == "retired") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

# Others
others_iyes_charls <- final_iyes_charls %>%
  filter(lbrf == "others") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

```

## By current smoking 

```{r}

# Current smoking
smoke_iyes_charls <- final_iyes_charls %>%
  filter(smoken == "yes") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

# No smoking
nosmoke_iyes_charls <- final_iyes_charls %>%
  filter(smoken == "no") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

```

## By alcohol consumption

```{r}

# Weekly alcohol use
drink_iyes_charls <- final_iyes_charls %>%
  filter(weekdrink == "yes") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

# Less than weekly alcohol use
nodrink_iyes_charls <- final_iyes_charls %>%
  filter(weekdrink == "no") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )


```

## By physical activity

```{r}

# Physical inactivity
phyinact_iyes_charls <- final_iyes_charls %>%
  filter(phyinact == "yes") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

# Physical activity
phyact_iyes_charls <- final_iyes_charls %>%
  filter(phyinact == "no") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

```

## By ADL disability

```{r}

# ADL disability
adl_iyes_charls <- final_iyes_charls %>%
  filter(adl_any == "yes") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

# No ADL limitation
noadl_iyes_charls <- final_iyes_charls %>%
  filter(adl_any == "no") %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

```

## By chronic conditions

```{r}

# â‰¥1 chronic conditions
dis_iyes_charls <- final_iyes_charls %>%
  filter(dis > 0) %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

# No chronic conditions
nodis_iyes_charls <- final_iyes_charls %>%
  filter(dis == 0) %>%
  select(!c(cesd_stand, shlt_stand, satlife_stand)) %>%
  mutate(
    cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
  )

```

# Sentivity analyses: Multiple imputation

## Internet use (yes/no)

```{r}

final_mi_iyes <- final_iyes_charls %>%
  dplyr::select(!c(cesd_stand, shlt_stand, satlife_stand))

# Setting MICE arguments
predictorMatrix <- matrix(0, nrow = dim(final_mi_iyes)[2], ncol = dim(final_mi_iyes)[2])
colnames(predictorMatrix) <- colnames(final_mi_iyes)
rownames(predictorMatrix) <- colnames(final_mi_iyes)
row_pre <- which(rownames(predictorMatrix) %in% colnames(final_mi_iyes)[-c(1:5)])
col_pre <- which(colnames(predictorMatrix) %in% colnames(final_mi_iyes)[-c(1:5)])
predictorMatrix[row_pre, col_pre] <- 1
for(i in 6:dim(final_mi_iyes)[2]){ predictorMatrix[i,i]<-0 }

cores <- detectCores()
tic()
mi_iyes <- final_mi_iyes %>%
  futuremice(data = ., m = 20, maxit = 5, predictorMatrix = predictorMatrix, parallelseed = 12345, n.core = cores - 1)
toc()

mi_iyes_charls <- list()

for(i in 1:20){
  mi_data <- mice::complete(mi_iyes, i) %>%
    mutate(
      cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
    )
  
  mi_iyes_charls[[i]] <- mi_data
  
  rm(mi_data)
}

```

## Internet use frequency

```{r}

final_mi_ifreq <- final_ifreq_charls %>%
  dplyr::select(!c(cesd_stand, shlt_stand, satlife_stand))

# Setting MICE arguments
predictorMatrix <- matrix(0, nrow = dim(final_mi_ifreq)[2], ncol = dim(final_mi_ifreq)[2])
colnames(predictorMatrix) <- colnames(final_mi_ifreq)
rownames(predictorMatrix) <- colnames(final_mi_ifreq)
row_pre <- which(rownames(predictorMatrix) %in% colnames(final_mi_ifreq)[-c(1:5)])
col_pre <- which(colnames(predictorMatrix) %in% colnames(final_mi_ifreq)[-c(1:5)])
predictorMatrix[row_pre, col_pre] <- 1
for(i in 6:dim(final_mi_ifreq)[2]){ predictorMatrix[i,i]<-0 }

cores <- detectCores()
tic()
mi_ifreq <- final_mi_ifreq %>%
  futuremice(data = ., m = 20, maxit = 5, predictorMatrix = predictorMatrix, parallelseed = 12345, n.core = cores - 1)
toc()

mi_ifreq_charls <- list()

for(i in 1:20){
  mi_data <- mice::complete(mi_ifreq, i) %>%
    mutate(
      cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
    )
  
  mi_ifreq_charls[[i]] <- mi_data
  
  rm(mi_data)
}

```

## Cumulative internet use

```{r}

final_mi_icum <- final_icum_charls %>%
  dplyr::select(!c(cesd_stand, shlt_stand, satlife_stand))

# Setting MICE arguments
predictorMatrix <- matrix(0, nrow = dim(final_mi_icum)[2], ncol = dim(final_mi_icum)[2])
colnames(predictorMatrix) <- colnames(final_mi_icum)
rownames(predictorMatrix) <- colnames(final_mi_icum)
row_pre <- which(rownames(predictorMatrix) %in% colnames(final_mi_icum)[-c(1:5)])
col_pre <- which(colnames(predictorMatrix) %in% colnames(final_mi_icum)[-c(1:5)])
predictorMatrix[row_pre, col_pre] <- 1
for(i in 6:dim(final_mi_icum)[2]){ predictorMatrix[i,i]<-0 }

cores <- detectCores()
tic()
mi_icum <- final_mi_icum %>%
  futuremice(data = ., m = 20, maxit = 5, predictorMatrix = predictorMatrix, parallelseed = 12345, n.core = cores - 1)
toc()

mi_icum_charls <- list()

for(i in 1:20){
  mi_data <- mice::complete(mi_icum, i) %>%
    mutate(
      cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)
    )
  
  mi_icum_charls[[i]] <- mi_data
  
  rm(mi_data)
}

```

# Save data

```{r}

save(
  final_iyes_charls, final_ifreq_charls, final_icum_charls, # Main analyses
  middle_iyes_charls, old_iyes_charls, male_iyes_charls, female_iyes_charls,
  pedu_iyes_charls, sedu_iyes_charls, tedu_iyes_charls,
  lwealth_iyes_charls, mwealth_iyes_charls, hwealth_iyes_charls,
  work_iyes_charls, retired_iyes_charls, others_iyes_charls,
  smoke_iyes_charls, nosmoke_iyes_charls, drink_iyes_charls, nodrink_iyes_charls,
  married_iyes_charls, nonmarried_iyes_charls,
  phyinact_iyes_charls, phyact_iyes_charls, adl_iyes_charls, noadl_iyes_charls,
  dis_iyes_charls, nodis_iyes_charls, # Subgroup analyses
  mi_iyes_charls, mi_ifreq_charls, mi_icum_charls, # Multiple imputation analyses
  file = str_c(getwd(), "/data/processed/charls_processed_data.RData", sep = "")
  )

```

