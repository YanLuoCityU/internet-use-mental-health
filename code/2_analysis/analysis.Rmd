---
title: "Internet use and mental health"
author: "Yan Luo"
date: '2023-10-01'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Make sure the working directory is "your path/internet-use-mental-health"
knitr::opts_knit$set(root.dir = "E:/Multiple cohort study/Harmonized Data FIile/HarmonizedSurveyData/internet_use_mental/internet-use-mental-health")

# data processing
library(tidyverse)
library(readxl)
library(skimr)
library(mice)
library(miceadds)
library(gtsummary)
library(glue)
library(gt)
library(tictoc)
library(data.table)
library(modelsummary)
library(broom.mixed)

# visualization
library(forestploter)
library(ggplot2)
library(ggpubr)
library(ggtext)
library(patchwork)
library(grid)
library(glue)
library(ggsci)

# statistical analysis
library(lmerTest)
library(metafor)
library(marginaleffects)
library(survival)
library(gfoRmula)
library(geepack)

```


# Import processed data

```{r}

print(getwd())

file_list <- list.files(path = str_c(getwd(), "/data/processed"), full.names = T)

lapply(file_list, load, .GlobalEnv)

country_factor <- read_excel(str_c(getwd(), "/data/country_level_factors.xlsx"))

```


# Internet use (yes/no)

## Merge data

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

mi_iyes_merge <- list()
for(i in 1:10){
  mi_iyes <- mi_iyes_hrs[[i]] %>% mutate(id = as.character(id)) %>% 
    bind_rows(., mi_iyes_elsa[[i]] %>% mutate(id = as.character(id))) %>%
    bind_rows(., mi_iyes_charls[[i]] %>% mutate(id = as.character(id))) %>%
    bind_rows(., mi_iyes_share[[i]]) %>%
    bind_rows(., mi_iyes_mhas[[i]]) %>%
    mutate(
      country_names = case_when(
        country == iso[1] ~ names[1],
        country == iso[2] ~ names[2],
        country == iso[3] ~ names[3],
        country == iso[4] ~ names[4],
        country == iso[5] ~ names[5],
        country == iso[6] ~ names[6],
        country == iso[7] ~ names[7],
        country == iso[8] ~ names[8],
        country == iso[9] ~ names[9],
        country == iso[10] ~ names[10],
        country == iso[11] ~ names[11],
        country == iso[12] ~ names[12],
        country == iso[13] ~ names[13],
        country == iso[14] ~ names[14],
        country == iso[15] ~ names[15],
        country == iso[16] ~ names[16],
        country == iso[17] ~ names[17],
        country == iso[18] ~ names[18],
        country == iso[19] ~ names[19],
        country == iso[20] ~ names[20],
        country == iso[21] ~ names[21],
        country == iso[22] ~ names[22],
        country == iso[23] ~ names[23]
      )
    )
  mi_iyes_merge[[i]] <- mi_iyes
  rm(mi_iyes)
}
  
```

## Linear mixed model and meta analysis

### CES-D

```{r warning=FALSE}

#### lme4 ####
tic()
cesd_iyes_unadj_mi_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    cesd_iyes_unadj_mi <- lmer(
      cesd_stand ~ internet_yes*cwave + (1 | id),
      data = final_iyes_elsi, 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil doesn't have missing values
    
    # Average marginal effect
    cesd_iyes_unadj_mi_result <- marginaleffects::avg_comparisons(
      cesd_iyes_unadj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    cesd_iyes_unadj_mi <- lapply(mi_iyes_merge, function(x){
      lmer(
        cesd_stand ~ internet_yes*cwave + (1 | id),
        data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'))
      })
    
    cesd_iyes_unadj_mi_result <- lapply(seq_along(cesd_iyes_unadj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_iyes_unadj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }
  
  cesd_iyes_unadj_mi_results <- cesd_iyes_unadj_mi_results %>% 
    bind_rows(., cesd_iyes_unadj_mi_result)
  
  rm(cesd_iyes_unadj_mi, cesd_iyes_unadj_mi_result)
}

cesd_iyes_adj_mi_results <- tibble()
cesd_iyes_adj_mi_avgpred_plots <- tibble()
for(i in 1:23){
  
  if(i==3){
    cesd_iyes_adj_mi <- lmer(
      cesd_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi, 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values

    cesd_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      cesd_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    
    cesd_iyes_adj_mi_avgpred_plot <- marginaleffects::avg_predictions(
      cesd_iyes_adj_mi, by = c("cwave", "internet_yes")
      ) %>% 
      tidy() %>%
      mutate(country = names[i]) %>%
      select(country, estimate, std.error, statistic, p.value)
  }else{
    cesd_iyes_adj_mi <- lapply(mi_iyes_merge, function(x){
      lmer(
        cesd_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'))
      })
    cesd_iyes_adj_mi_result <- lapply(seq_along(cesd_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    
    # Plot for the marginal predictions by Internet use and follow-up time
    cesd_iyes_adj_mi_avgpred_plot <- lapply(seq_along(cesd_iyes_adj_mi), \(j) 
      marginaleffects::avg_predictions(
        cesd_iyes_adj_mi[[j]], by = c("cwave", "internet_yes"))
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i]) %>%
      select(country, term, estimate, std.error, statistic, p.value)
  }
  
  cesd_iyes_adj_mi_results <- cesd_iyes_adj_mi_results %>% 
    bind_rows(., cesd_iyes_adj_mi_result)
  
  cesd_iyes_adj_mi_avgpred_plots <- cesd_iyes_adj_mi_avgpred_plots %>% 
    bind_rows(., cesd_iyes_adj_mi_avgpred_plot)
  
  rm(cesd_iyes_adj_mi, cesd_iyes_adj_mi_result, cesd_iyes_adj_mi_avgpred_plot)
}
toc() # 1699 sec elapsed

#### metafor ####
cesd_iyes_unadj_mi_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_unadj_mi_results, slab = country)

cesd_iyes_adj_mi_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_mi_results, slab = country)

# meta regression
metareg_cesd_iyes_mi_adj <- cesd_iyes_adj_mi_results %>% 
  left_join(country_factor, by = "country") %>%
  mutate(
    measure = case_when(
      country == "Mexico" ~ "home_level",
      country != "Mexico" &  country != "England" ~ "binary",
      country == "England" ~ "frequency",
      TRUE ~ NA_character_
    ),
    measure = factor(measure, levels = c("binary", "home_level", "frequency")),
  )

## country-level factors
gdp_cesd_iyes_mi_adj <- rma(yi = estimate, sei = std.error, mods = ~ GDP_per_capita, data = metareg_cesd_iyes_mi_adj, slab = country)

gini_cesd_iyes_mi_adj <- rma(yi = estimate, sei = std.error, mods = ~ poly(gini, degree = 3, raw = TRUE), data = metareg_cesd_iyes_mi_adj, slab = country) # Significant

whi_cesd_iyes_mi_adj <- rma(yi = estimate, sei = std.error, mods = ~ world_happiness_index, data = metareg_cesd_iyes_mi_adj, slab = country)

indiv_cesd_iyes_mi_adj <- rma(yi = estimate, sei = std.error, mods = ~ individualism_score, data = metareg_cesd_iyes_mi_adj, slab = country) # High R2

hale_cesd_iyes_mi_adj <- rma(yi = estimate, sei = std.error, mods = ~ poly(healthy_life_expectancy, degree = 3, raw = TRUE), data = metareg_cesd_iyes_mi_adj, slab = country) # Significant

iuse_cesd_iyes_mi_adj <- rma(yi = estimate, sei = std.error, mods = ~ poly(internet_use_rate, degree = 3, raw = TRUE), data = metareg_cesd_iyes_mi_adj, slab = country) # Significant

dskill_cesd_iyes_mi_adj <- rma(yi = estimate, sei = std.error, mods = ~ poly(digital_skills_score, degree = 3, raw = TRUE), data = metareg_cesd_iyes_mi_adj, slab = country) # Significant

## measurement of Internet use
measure_cesd_iyes_mi_adj <- rma(yi = estimate, sei = std.error, mods = ~ measure, data = metareg_cesd_iyes_mi_adj, slab = country)

```

### Life satisfaction

```{r warning=FALSE}

#### lme4 ####
tic()
satlife_iyes_unadj_mi_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    satlife_iyes_unadj_mi <- lmer(
      satlife_stand ~ internet_yes*cwave + (1 | id),
      data = final_iyes_elsi, 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil doesn't have missing values
    
    # Average marginal effect
    satlife_iyes_unadj_mi_result <- marginaleffects::avg_comparisons(
      satlife_iyes_unadj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    satlife_iyes_unadj_mi <- lapply(mi_iyes_merge, function(x){
      lmer(
        satlife_stand ~ internet_yes*cwave + (1 | id),
        data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'))
      })
    
    satlife_iyes_unadj_mi_result <- lapply(seq_along(satlife_iyes_unadj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_iyes_unadj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }
  
  satlife_iyes_unadj_mi_results <- satlife_iyes_unadj_mi_results %>% 
    bind_rows(., satlife_iyes_unadj_mi_result)
  
  rm(satlife_iyes_unadj_mi, satlife_iyes_unadj_mi_result)
}

satlife_iyes_adj_mi_results <- tibble()
satlife_iyes_adj_mi_avgpred_plots <- tibble()
for(i in 1:23){
  
  if(i==3){
    satlife_iyes_adj_mi <- lmer(
      satlife_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi, 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values

    satlife_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      satlife_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    
    satlife_iyes_adj_mi_avgpred_plot <- marginaleffects::avg_predictions(
      satlife_iyes_adj_mi, by = c("cwave", "internet_yes")
      ) %>% 
      tidy() %>%
      mutate(country = names[i]) %>%
      select(country, term, estimate, std.error, statistic, p.value)
  }else{
    satlife_iyes_adj_mi <- lapply(mi_iyes_merge, function(x){
      lmer(
        satlife_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'))
      })
    satlife_iyes_adj_mi_result <- lapply(seq_along(satlife_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    
    # Plot for the marginal predictions by Internet use and follow-up time
    satlife_iyes_adj_mi_avgpred_plot <- lapply(seq_along(satlife_iyes_adj_mi), \(j) 
      marginaleffects::avg_predictions(
        satlife_iyes_adj_mi[[j]], by = c("cwave", "internet_yes"))
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i]) %>%
      select(country, term, estimate, std.error, statistic, p.value)
  }
  
  satlife_iyes_adj_mi_results <- satlife_iyes_adj_mi_results %>% 
    bind_rows(., satlife_iyes_adj_mi_result)
  
  satlife_iyes_adj_mi_avgpred_plots <- satlife_iyes_adj_mi_avgpred_plots %>% 
    bind_rows(., satlife_iyes_adj_mi_avgpred_plot)
  
  rm(satlife_iyes_adj_mi, satlife_iyes_adj_mi_result, satlife_iyes_adj_mi_avgpred_plot)
}
toc() # 2422.58 sec elapsed

#### metafor ####
satlife_iyes_unadj_mi_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_unadj_mi_results, slab = country)

satlife_iyes_adj_mi_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_mi_results, slab = country)

# meta regression
metareg_satlife_iyes_mi_adj <- satlife_iyes_adj_mi_results %>% 
  left_join(country_factor, by = "country") %>%
  mutate(
    measure = case_when(
      country == "Mexico" ~ "home_level",
      country != "Mexico" &  country != "England" ~ "binary",
      country == "England" ~ "frequency",
      TRUE ~ NA_character_
    ),
    measure = factor(measure, levels = c("binary", "home_level", "frequency")),
  )

## country-level factors
gdp_satlife_iyes_mi_adj <- rma(yi = estimate, sei = std.error, mods = ~ GDP_per_capita, data = metareg_satlife_iyes_mi_adj, slab = country)

gini_satlife_iyes_mi_adj <- rma(yi = estimate, sei = std.error, mods = ~ gini, data = metareg_satlife_iyes_mi_adj, slab = country)

whi_satlife_iyes_mi_adj <- rma(yi = estimate, sei = std.error, mods = ~ world_happiness_index, data = metareg_satlife_iyes_mi_adj, slab = country)

indiv_satlife_iyes_mi_adj <- rma(yi = estimate, sei = std.error, mods = ~ individualism_score, data = metareg_satlife_iyes_mi_adj, slab = country)

hale_satlife_iyes_mi_adj <- rma(yi = estimate, sei = std.error, mods = ~ healthy_life_expectancy, data = metareg_satlife_iyes_mi_adj, slab = country)

iuse_satlife_iyes_mi_adj <- rma(yi = estimate, sei = std.error, mods = ~ poly(internet_use_rate, degree = 2, raw = TRUE), data = metareg_satlife_iyes_mi_adj, slab = country) # Significant

dskill_satlife_iyes_mi_adj <- rma(yi = estimate, sei = std.error, mods = ~ digital_skills_score, data = metareg_satlife_iyes_mi_adj, slab = country)

## measurement of Internet use
measure_satlife_iyes_mi_adj <- rma(yi = estimate, sei = std.error, mods = ~ measure, data = metareg_satlife_iyes_mi_adj, slab = country)

```


### Self-rated health

```{r warning=FALSE}

#### lme4 ####
tic()
shlt_iyes_unadj_mi_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    shlt_iyes_unadj_mi <- lmer(
      shlt_stand ~ internet_yes*cwave + (1 | id),
      data = final_iyes_elsi, 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil doesn't have missing values
    
    # Average marginal effect
    shlt_iyes_unadj_mi_result <- marginaleffects::avg_comparisons(
      shlt_iyes_unadj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    shlt_iyes_unadj_mi <- lapply(mi_iyes_merge, function(x){
      lmer(
        shlt_stand ~ internet_yes*cwave + (1 | id),
        data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'))
      })
    
    shlt_iyes_unadj_mi_result <- lapply(seq_along(shlt_iyes_unadj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_iyes_unadj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }
  
  shlt_iyes_unadj_mi_results <- shlt_iyes_unadj_mi_results %>% 
    bind_rows(., shlt_iyes_unadj_mi_result)
  
  rm(shlt_iyes_unadj_mi, shlt_iyes_unadj_mi_result)
}

shlt_iyes_adj_mi_results <- tibble()
shlt_iyes_adj_mi_avgpred_plots <- tibble()
for(i in 1:23){
  
  if(i==3){
    shlt_iyes_adj_mi <- lmer(
      shlt_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi, 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values

    shlt_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      shlt_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    
    shlt_iyes_adj_mi_avgpred_plot <- marginaleffects::avg_predictions(
      shlt_iyes_adj_mi, by = c("cwave", "internet_yes")
      ) %>% 
      tidy() %>%
      mutate(country = names[i]) %>%
      select(country, term, estimate, std.error, statistic, p.value)
  }else{
    shlt_iyes_adj_mi <- lapply(mi_iyes_merge, function(x){
      lmer(
        shlt_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'))
      })
    shlt_iyes_adj_mi_result <- lapply(seq_along(shlt_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    
    # Plot for the marginal predictions by Internet use and follow-up time
    shlt_iyes_adj_mi_avgpred_plot <- lapply(seq_along(shlt_iyes_adj_mi), \(j) 
      marginaleffects::avg_predictions(
        shlt_iyes_adj_mi[[j]], by = c("cwave", "internet_yes"))
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i]) %>%
      select(country, term, estimate, std.error, statistic, p.value)
  }
  
  shlt_iyes_adj_mi_results <- shlt_iyes_adj_mi_results %>% 
    bind_rows(., shlt_iyes_adj_mi_result)
  
  shlt_iyes_adj_mi_avgpred_plots <- shlt_iyes_adj_mi_avgpred_plots %>% 
    bind_rows(., shlt_iyes_adj_mi_avgpred_plot)
  
  rm(shlt_iyes_adj_mi, shlt_iyes_adj_mi_result, shlt_iyes_adj_mi_avgpred_plot)
}
toc()

#### metafor ####
shlt_iyes_unadj_mi_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_unadj_mi_results, slab = country)

shlt_iyes_adj_mi_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_mi_results, slab = country)

# meta regression
metareg_shlt_iyes_mi_adj <- shlt_iyes_adj_mi_results %>% 
  left_join(country_factor, by = "country") %>%
  mutate(
    measure = case_when(
      country == "Mexico" ~ "home_level",
      country != "Mexico" &  country != "England" ~ "binary",
      country == "England" ~ "frequency",
      TRUE ~ NA_character_
    ),
    measure = factor(measure, levels = c("binary", "home_level", "frequency")),
  )

## country-level factors
gdp_shlt_iyes_mi_adj <- rma(yi = estimate, sei = std.error, mods = ~ GDP_per_capita, data = metareg_shlt_iyes_mi_adj, slab = country)

gini_shlt_iyes_mi_adj <- rma(yi = estimate, sei = std.error, mods = ~ gini, data = metareg_shlt_iyes_mi_adj, slab = country)

whi_shlt_iyes_mi_adj <- rma(yi = estimate, sei = std.error, mods = ~ world_happiness_index, data = metareg_shlt_iyes_mi_adj, slab = country) # Significant

indiv_shlt_iyes_mi_adj <- rma(yi = estimate, sei = std.error, mods = ~ poly(individualism_score, degree = 3, raw = TRUE), data = metareg_shlt_iyes_mi_adj, slab = country) # High R2

hale_shlt_iyes_mi_adj <- rma(yi = estimate, sei = std.error, mods = ~ healthy_life_expectancy, data = metareg_shlt_iyes_mi_adj, slab = country)

iuse_shlt_iyes_mi_adj <- rma(yi = estimate, sei = std.error, mods = ~ internet_use_rate, data = metareg_shlt_iyes_mi_adj, slab = country)

dskill_shlt_iyes_mi_adj <- rma(yi = estimate, sei = std.error, mods = ~ digital_skills_score, data = metareg_shlt_iyes_mi_adj, slab = country)

## measurement of Internet use
measure_shlt_iyes_mi_adj <- rma(yi = estimate, sei = std.error, mods = ~ measure, data = metareg_shlt_iyes_mi_adj, slab = country)

```

## Figure 1: Associations of Internet use with depressive symptoms and life satisfaction

```{r}

#### Theme setting ####
theme <- forestploter::forest_theme(
  core = list(bg_params = list(fill = c("white"))), 
  base_size = 10,
  # base_family = "Arial",
  ci_pch = 15,
  ci_col = "#3B4992FF", 
  ci_alpha = 1,
  ci_lty = 1,
  ci_lwd = 1,
  ci_Theight = unit(0, "cm"),
  
  xaxis_lwd = 1,
  xaxis_cex = 1,
  
  summary_col = "#008B45FF", 
  refline_col = "gray", 
  refline_lwd = 2, 
  
  title_just = "center",
  title_cex = 1.2,
  title_fontface = "bold",
  title_col = "black",
  
  arrow_type = "closed",
  arrow_label_just = "end",
  arrow_length = 0.05,
  arrow_lwd = 1,
  arrow_fill = "black",
  arrow_col = "black"
  )

#### CES-D ####
# Data
dat <- cesd_iyes_adj_mi_results %>%
  mutate(weights = weights(cesd_iyes_adj_mi_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(cesd_iyes_adj_mi_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_mi_meta$se), 
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "AME (95% CI)", "Weight (%)")

p_cesd <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Fewer depressive symptoms","More depressive symptoms"),
  xlim = c(-0.5, 0.5),
  ticks_at = c(-0.5, -0.25, 0, 0.25, 0.5),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(cesd_iyes_adj_mi_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(cesd_iyes_adj_mi_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(cesd_iyes_adj_mi_meta$H2, digits = 2)))
    )

p_cesd <- add_text(
  p_cesd, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(cesd_iyes_adj_mi_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(cesd_iyes_adj_mi_meta$k - cesd_iyes_adj_mi_meta$p), ") = ", 
        .(fmtx(cesd_iyes_adj_mi_meta$QE, digits = 2)), ", ",

        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(cesd_iyes_adj_mi_meta$k - cesd_iyes_adj_mi_meta$p), ") = ", 
        .(fmtx(cesd_iyes_adj_mi_meta$QE, digits = 2)), ", ",
        .(fmtp(cesd_iyes_adj_mi_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
  }

p_cesd <- add_text(
  p_cesd, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(cesd_iyes_adj_mi_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(cesd_iyes_adj_mi_meta$zval, digits = 2)), ", ",
        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(cesd_iyes_adj_mi_meta$zval, digits = 2)), ", ",
      .(fmtp(cesd_iyes_adj_mi_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )    
  }

p_cesd <- add_text(
  p_cesd, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_cesd <- add_border(p_cesd, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))


#### Life satisfaction ####
# Data
dat <- satlife_iyes_adj_mi_results %>%
  mutate(weights = weights(satlife_iyes_adj_mi_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(satlife_iyes_adj_mi_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_mi_meta$se), 
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "AME (95% CI)", "Weight (%)")

p_satlife <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Lower life satisfaction","Higher life satisfaction"),
  xlim = c(-0.2, 0.8),
  ticks_at = c(-0.2, 0, 0.2, 0.4, 0.6, 0.8),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(satlife_iyes_adj_mi_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(satlife_iyes_adj_mi_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(satlife_iyes_adj_mi_meta$H2, digits = 2)))
    )

p_satlife <- add_text(
  p_satlife, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(satlife_iyes_adj_mi_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(satlife_iyes_adj_mi_meta$k - satlife_iyes_adj_mi_meta$p), ") = ", 
        .(fmtx(satlife_iyes_adj_mi_meta$QE, digits = 2)), ", ",

        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(satlife_iyes_adj_mi_meta$k - satlife_iyes_adj_mi_meta$p), ") = ", 
        .(fmtx(satlife_iyes_adj_mi_meta$QE, digits = 2)), ", ",
        .(fmtp(satlife_iyes_adj_mi_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
  }

p_satlife <- add_text(
  p_satlife, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(satlife_iyes_adj_mi_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(satlife_iyes_adj_mi_meta$zval, digits = 2)), ", ",
        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(satlife_iyes_adj_mi_meta$zval, digits = 2)), ", ",
      .(fmtp(satlife_iyes_adj_mi_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )    
  }

p_satlife <- add_text(
  p_satlife, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_satlife <- add_border(p_satlife, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))


#### Pool ####
p_pool <- wrap_elements(
  wrap_elements(p_cesd) + wrap_elements(p_satlife) + 
    plot_layout(nrow = 1) + 
    plot_annotation(tag_levels = "a")
  ) 

ggsave(str_c(getwd(), "/results/Figure/Figure 1_Forest plot_internet use.tiff"), plot = p_pool, width = 16, height = 7, unit = "in", dpi = 500, device = "tiff")

ggsave(str_c(getwd(), "/results/Figure/Figure 1_Forest plot_internet use.pdf"), plot = p_pool, width = 16, height = 7, unit = "in", dpi = 300, device = "pdf")

# ggsave(str_c(getwd(), "/results/Figure/Figure 1_Forest plot_internet use.pdf"), plot = p_pool, width = 297, height = 210, unit = "mm", dpi = 300, device = "pdf")

rm(p_pool)

```

## Supplementary Figure 1: Associations of Internet use with self-reported health

```{r}

#### Self-rated health ####
# Data
dat <- shlt_iyes_adj_mi_results %>%
  mutate(weights = weights(shlt_iyes_adj_mi_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(shlt_iyes_adj_mi_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_mi_meta$se), 
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "AME (95% CI)", "Weight (%)")

p_shlt <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Worse self-reported health","Better self-reported health"),
  xlim = c(-0.4, 0.4),
  ticks_at = c(-0.4, -0.2, 0, 0.2, 0.4),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(shlt_iyes_adj_mi_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(shlt_iyes_adj_mi_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(shlt_iyes_adj_mi_meta$H2, digits = 2)))
    )

p_shlt <- add_text(
  p_shlt, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(shlt_iyes_adj_mi_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(shlt_iyes_adj_mi_meta$k - shlt_iyes_adj_mi_meta$p), ") = ", 
        .(fmtx(shlt_iyes_adj_mi_meta$QE, digits = 2)), ", ",

        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(shlt_iyes_adj_mi_meta$k - shlt_iyes_adj_mi_meta$p), ") = ", 
        .(fmtx(shlt_iyes_adj_mi_meta$QE, digits = 2)), ", ",
        .(fmtp(shlt_iyes_adj_mi_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
  }

p_shlt <- add_text(
  p_shlt, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(shlt_iyes_adj_mi_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(shlt_iyes_adj_mi_meta$zval, digits = 2)), ", ",
        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(shlt_iyes_adj_mi_meta$zval, digits = 2)), ", ",
      .(fmtp(shlt_iyes_adj_mi_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )    
  }

p_shlt <- add_text(
  p_shlt, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_shlt <- add_border(p_shlt, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))


ggsave(str_c(getwd(), "/results/Figure/Supplementary Figure 1_Forest plot_internet use.tiff"), plot = p_shlt, width = 8, height = 7, unit = "in", dpi = 500, device = "tiff")

rm(theme, dat, dat_fig, test_hetero, test_overall, p_cesd, p_satlife, p_shlt)

```

## Supplementary Figure 2-4: Line plot for marginal predictions

```{r}

#### CES-D ####
dat <- cesd_iyes_adj_mi_avgpred_plots %>%
  separate(term, into = c("cwave", "internet_yes"), sep = " ") %>%
  mutate(
    cwave = as.numeric(cwave),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error
  )

cesd_avgpred <- ggplot(
  data = dat, aes(x = cwave, y = estimate, group = internet_yes, color = internet_yes, fill = internet_yes)) +
  geom_ribbon(
    aes(x = cwave, ymin = lower, ymax = upper), alpha = 0.3) +
  geom_line(linewidth = 1.25) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    # legend.title = element_blank(),
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 12),
    legend.position = "right",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 16, face = "bold"),
    strip.text = element_text(size = 12, colour = "black", face = "bold")
    ) +
  labs(
    x = "Years since baseline",
    y = "Predicted standardized scores",
    title = "Depressive symptoms",
    color = "Internet use", 
    fill = "Internet use"
  ) +
  scale_color_npg(labels = c("No", "Yes")) + 
  scale_fill_npg(labels = c("No", "Yes")) +
  facet_wrap(~ country)

ggsave(str_c(getwd(), "/results/Figure/Supplementary Figure 2_Line plot for marginal prediction over time_depressive symptoms.tiff"), plot = cesd_avgpred, width = 16, height = 10, unit = "in", dpi = 300, device = "tiff")

#### Life satisfaction ####
dat <- satlife_iyes_adj_mi_avgpred_plots %>%
  separate(term, into = c("cwave", "internet_yes"), sep = " ") %>%
  mutate(
    cwave = as.numeric(cwave),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error
  )

satlife_avgpred <- ggplot(
  data = dat, aes(x = cwave, y = estimate, group = internet_yes, color = internet_yes, fill = internet_yes)) +
  geom_ribbon(
    aes(x = cwave, ymin = lower, ymax = upper), alpha = 0.3) +
  geom_line(linewidth = 1.25) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    # legend.title = element_blank(),
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 12),
    legend.position = "right",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 16, face = "bold"),
    strip.text = element_text(size = 12, colour = "black", face = "bold")
    ) +
  labs(
    x = "Years since baseline",
    y = "Predicted standardized scores",
    title = "Life satisfaction",
    color = "Internet use", 
    fill = "Internet use"
  ) +
  scale_color_npg(labels = c("No", "Yes")) + 
  scale_fill_npg(labels = c("No", "Yes")) +
  facet_wrap(~ country)

ggsave(str_c(getwd(), "/results/Figure/Supplementary Figure 3_Line plot for marginal prediction over time_life satisfaction.tiff"), plot = satlife_avgpred, width = 16, height = 10, unit = "in", dpi = 300, device = "tiff")


#### Life satisfaction ####
dat <- shlt_iyes_adj_mi_avgpred_plots %>%
  separate(term, into = c("cwave", "internet_yes"), sep = " ") %>%
  mutate(
    cwave = as.numeric(cwave),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error
  )

shlt_avgpred <- ggplot(
  data = dat, aes(x = cwave, y = estimate, group = internet_yes, color = internet_yes, fill = internet_yes)) +
  geom_ribbon(
    aes(x = cwave, ymin = lower, ymax = upper), alpha = 0.3) +
  geom_line(linewidth = 1.25) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    # legend.title = element_blank(),
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 12),
    legend.position = "right",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 16, face = "bold"),
    strip.text = element_text(size = 12, colour = "black", face = "bold")
    ) +
  labs(
    x = "Years since baseline",
    y = "Predicted standardized scores",
    title = "Self-reported health",
    color = "Internet use", 
    fill = "Internet use"
  ) +
  scale_color_npg(labels = c("No", "Yes")) + 
  scale_fill_npg(labels = c("No", "Yes")) +
  facet_wrap(~ country)

ggsave(str_c(getwd(), "/results/Figure/Supplementary Figure 4_Line plot for marginal prediction over time_self-reported health.tiff"), plot = shlt_avgpred, width = 16, height = 10, unit = "in", dpi = 300, device = "tiff")

rm(dat, cesd_avgpred, satlife_avgpred, shlt_avgpred)

```

## Supplementary Figure 6: Bubble plot

```{r}

#### CES-D ####
# GDP per capita
dat <- metareg_cesd_iyes_mi_adj %>%
  mutate(weights = weights(gdp_cesd_iyes_mi_adj))

dat_ci <- metafor::predict.rma(gdp_cesd_iyes_mi_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_cesd_iyes_mi_adj$GDP_per_capita)

bubble_gdp_cesd <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = GDP_per_capita, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = GDP_per_capita, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(gdp_cesd_iyes_mi_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(gdp_cesd_iyes_mi_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(8500, 130000)
  ) +
  scale_y_continuous(
    limits = c(-0.30, 0.15)
  ) +
  labs(
    x = "$US",
    y = "Average marginal effect",
    title = "Depressive symptoms"
  )
  

# Gini index
dat <- metareg_cesd_iyes_mi_adj %>%
  mutate(weights = weights(gini_cesd_iyes_mi_adj))

dat_ci <- metafor::predict.rma(gini_cesd_iyes_mi_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_cesd_iyes_mi_adj$gini)

bubble_gini_cesd <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = gini, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = gini, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(gini_cesd_iyes_mi_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(gini_cesd_iyes_mi_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(24, 54)
  ) +
  scale_y_continuous(
    limits = c(-0.30, 0.15)
  ) +
  labs(
    x = "Score",
    y = "Average marginal effect",
    title = "Depressive symptoms"
  )
  
# World happiness index
dat <- metareg_cesd_iyes_mi_adj %>%
  mutate(weights = weights(whi_cesd_iyes_mi_adj))

dat_ci <- metafor::predict.rma(whi_cesd_iyes_mi_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_cesd_iyes_mi_adj$world_happiness_index)

bubble_whi_cesd <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = world_happiness_index, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF",
    ) + 
  geom_text(
    aes(x = world_happiness_index, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(whi_cesd_iyes_mi_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(whi_cesd_iyes_mi_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(5.8, 7.68)
  ) +
  scale_y_continuous(
    limits = c(-0.30, 0.15)
  ) +
  labs(
    x = "Score",
    y = "Average marginal effect",
    title = "Depressive symptoms"
  )

# Hofstede’s index
dat <- metareg_cesd_iyes_mi_adj %>%
  mutate(weights = weights(indiv_cesd_iyes_mi_adj))

dat_ci <- metafor::predict.rma(indiv_cesd_iyes_mi_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_cesd_iyes_mi_adj$individualism_score)

bubble_indiv_cesd <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = individualism_score, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = individualism_score, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(indiv_cesd_iyes_mi_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(indiv_cesd_iyes_mi_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(34, 101)
  ) +
  scale_y_continuous(
    limits = c(-0.30, 0.15)
  ) +
  labs(
    x = "Score",
    y = "Average marginal effect",
    title = "Depressive symptoms"
  )

# Healthy life expectancy at birth
dat <- metareg_cesd_iyes_mi_adj %>%
  mutate(weights = weights(hale_cesd_iyes_mi_adj))

dat_ci <- metafor::predict.rma(hale_cesd_iyes_mi_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_cesd_iyes_mi_adj$healthy_life_expectancy)

bubble_hale_cesd <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = healthy_life_expectancy, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = healthy_life_expectancy, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(hale_cesd_iyes_mi_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(hale_cesd_iyes_mi_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(65.2, 72.8)
  ) +
  scale_y_continuous(
    limits = c(-0.30, 0.15)
  ) +
  labs(
    x = "Years",
    y = "Average marginal effect",
    title = "Depressive symptoms"
  )

# Internet use rate
dat <- metareg_cesd_iyes_mi_adj %>%
  mutate(weights = weights(iuse_cesd_iyes_mi_adj))

dat_ci <- metafor::predict.rma(iuse_cesd_iyes_mi_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_cesd_iyes_mi_adj$internet_use_rate)

bubble_iuse_cesd <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = internet_use_rate, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = internet_use_rate, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(iuse_cesd_iyes_mi_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(iuse_cesd_iyes_mi_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(75, 99)
  ) +
  scale_y_continuous(
    limits = c(-0.30, 0.15)
  ) +
  labs(
    x = "Rate (%)",
    y = "Average marginal effect",
    title = "Depressive symptoms"
  )

# Digital skills among active population
dat <- metareg_cesd_iyes_mi_adj %>%
  mutate(weights = weights(dskill_cesd_iyes_mi_adj))

dat_ci <- metafor::predict.rma(dskill_cesd_iyes_mi_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_cesd_iyes_mi_adj$digital_skills_score)

bubble_dskill_cesd <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = digital_skills_score, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = digital_skills_score, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(dskill_cesd_iyes_mi_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(dskill_cesd_iyes_mi_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(34, 79)
  ) +
  scale_y_continuous(
    limits = c(-0.30, 0.15)
  ) +
  labs(
    x = "Score",
    y = "Average marginal effect",
    title = "Depressive symptoms"
  )


#### Life satisfaction ####
# GDP per capita
dat <- metareg_satlife_iyes_mi_adj %>%
  mutate(weights = weights(gdp_satlife_iyes_mi_adj))

dat_ci <- metafor::predict.rma(gdp_satlife_iyes_mi_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_satlife_iyes_mi_adj$GDP_per_capita)

bubble_gdp_satlife <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3
    ) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = GDP_per_capita, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = GDP_per_capita, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(gdp_satlife_iyes_mi_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(gdp_satlife_iyes_mi_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(8500, 130000)
  ) +
  scale_y_continuous(
    limits = c(-0.2, 0.45)
  ) +
  labs(
    x = "$US",
    y = "Average marginal effect",
    title = "Life satisfaction"
  )
  

# Gini index
dat <- metareg_satlife_iyes_mi_adj %>%
  mutate(weights = weights(gini_satlife_iyes_mi_adj))

dat_ci <- metafor::predict.rma(gini_satlife_iyes_mi_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_satlife_iyes_mi_adj$gini)

bubble_gini_satlife <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = gini, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = gini, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(gini_satlife_iyes_mi_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(gini_satlife_iyes_mi_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(24, 54)
  ) +
  scale_y_continuous(
    limits = c(-0.2, 0.45)
  ) +
  labs(
    x = "Score",
    y = "Average marginal effect",
    title = "Life satisfaction"
  )
  
# World happiness index
dat <- metareg_satlife_iyes_mi_adj %>%
  mutate(weights = weights(whi_satlife_iyes_mi_adj))

dat_ci <- metafor::predict.rma(whi_satlife_iyes_mi_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_satlife_iyes_mi_adj$world_happiness_index)

bubble_whi_satlife <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = world_happiness_index, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = world_happiness_index, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(whi_satlife_iyes_mi_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(whi_satlife_iyes_mi_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(5.8, 7.68)
  ) +
  scale_y_continuous(
    limits = c(-0.2, 0.45)
  ) +
  labs(
    x = "Score",
    y = "Average marginal effect",
    title = "Life satisfaction"
  )

# Hofstede’s index
dat <- metareg_satlife_iyes_mi_adj %>%
  mutate(weights = weights(indiv_satlife_iyes_mi_adj))

dat_ci <- metafor::predict.rma(indiv_satlife_iyes_mi_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_satlife_iyes_mi_adj$individualism_score)

bubble_indiv_satlife <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = individualism_score, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = individualism_score, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(indiv_satlife_iyes_mi_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(indiv_satlife_iyes_mi_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(34, 101)
  ) +
  scale_y_continuous(
    limits = c(-0.2, 0.45)
  ) +
  labs(
    x = "Score",
    y = "Average marginal effect",
    title = "Life satisfaction"
  )

# Healthy life expectancy at birth
dat <- metareg_satlife_iyes_mi_adj %>%
  mutate(weights = weights(hale_satlife_iyes_mi_adj))

dat_ci <- metafor::predict.rma(hale_satlife_iyes_mi_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_satlife_iyes_mi_adj$healthy_life_expectancy)

bubble_hale_satlife <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = healthy_life_expectancy, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = healthy_life_expectancy, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(hale_satlife_iyes_mi_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(hale_satlife_iyes_mi_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(65.2, 72.8)
  ) +
  scale_y_continuous(
    limits = c(-0.1, 0.45)
  ) +
  labs(
    x = "Years",
    y = "Average marginal effect",
    title = "Life satisfaction"
  )

# Internet use rate
dat <- metareg_satlife_iyes_mi_adj %>%
  mutate(weights = weights(iuse_satlife_iyes_mi_adj))

dat_ci <- metafor::predict.rma(iuse_satlife_iyes_mi_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_satlife_iyes_mi_adj$internet_use_rate)

bubble_iuse_satlife <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = internet_use_rate, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = internet_use_rate, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(iuse_satlife_iyes_mi_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(iuse_satlife_iyes_mi_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(75, 99)
  ) +
  scale_y_continuous(
    limits = c(-0.2, 0.45)
  ) +
  labs(
    x = "Rate (%)",
    y = "Average marginal effect",
    title = "Life satisfaction"
  )

# Digital skills among active population
dat <- metareg_satlife_iyes_mi_adj %>%
  mutate(weights = weights(dskill_satlife_iyes_mi_adj))

dat_ci <- metafor::predict.rma(dskill_satlife_iyes_mi_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_satlife_iyes_mi_adj$digital_skills_score)

bubble_dskill_satlife <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = digital_skills_score, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = digital_skills_score, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(dskill_satlife_iyes_mi_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(dskill_satlife_iyes_mi_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(34, 79)
  ) +
  scale_y_continuous(
    limits = c(-0.2, 0.45)
  ) +
  labs(
    x = "Score",
    y = "Average marginal effect",
    title = "Life satisfaction"
  )


#### Self-rated health ####
# GDP per capita
dat <- metareg_shlt_iyes_mi_adj %>%
  mutate(weights = weights(gdp_shlt_iyes_mi_adj))

dat_ci <- metafor::predict.rma(gdp_shlt_iyes_mi_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_shlt_iyes_mi_adj$GDP_per_capita)

bubble_gdp_shlt <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3
    ) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = GDP_per_capita, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = GDP_per_capita, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(gdp_shlt_iyes_mi_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(gdp_shlt_iyes_mi_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(8500, 130000)
  ) +
  scale_y_continuous(
    limits = c(-0.05, 0.35)
  ) +
  labs(
    x = "$US",
    y = "Average marginal effect",
    title = "Self-reported health"
  )
  

# Gini index
dat <- metareg_shlt_iyes_mi_adj %>%
  mutate(weights = weights(gini_shlt_iyes_mi_adj))

dat_ci <- metafor::predict.rma(gini_shlt_iyes_mi_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_shlt_iyes_mi_adj$gini)

bubble_gini_shlt <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = gini, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = gini, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(gini_shlt_iyes_mi_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(gini_shlt_iyes_mi_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(24, 54)
  ) +
  scale_y_continuous(
    limits = c(-0.05, 0.35)
  ) +
  labs(
    x = "Score",
    y = "Average marginal effect",
    title = "Self-reported health"
  )
  
# World happiness index
dat <- metareg_shlt_iyes_mi_adj %>%
  mutate(weights = weights(whi_shlt_iyes_mi_adj))

dat_ci <- metafor::predict.rma(whi_shlt_iyes_mi_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_shlt_iyes_mi_adj$world_happiness_index)

bubble_whi_shlt <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = world_happiness_index, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = world_happiness_index, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(whi_shlt_iyes_mi_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(whi_shlt_iyes_mi_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(5.8, 7.68)
  ) +
  scale_y_continuous(
    limits = c(-0.05, 0.35)
  ) +
  labs(
    x = "Score",
    y = "Average marginal effect",
    title = "Self-reported health"
  )

# Hofstede’s index
dat <- metareg_shlt_iyes_mi_adj %>%
  mutate(weights = weights(indiv_shlt_iyes_mi_adj))

dat_ci <- metafor::predict.rma(indiv_shlt_iyes_mi_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_shlt_iyes_mi_adj$individualism_score)

bubble_indiv_shlt <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = individualism_score, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = individualism_score, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(indiv_shlt_iyes_mi_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(indiv_shlt_iyes_mi_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(34, 101)
  ) +
  scale_y_continuous(
    limits = c(-0.05, 0.35)
  ) +
  labs(
    x = "Score",
    y = "Average marginal effect",
    title = "Self-reported health"
  )

# Healthy life expectancy at birth
dat <- metareg_shlt_iyes_mi_adj %>%
  mutate(weights = weights(hale_shlt_iyes_mi_adj))

dat_ci <- metafor::predict.rma(hale_shlt_iyes_mi_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_shlt_iyes_mi_adj$healthy_life_expectancy)

bubble_hale_shlt <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = healthy_life_expectancy, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF",
    ) + 
  geom_text(
    aes(x = healthy_life_expectancy, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(hale_shlt_iyes_mi_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(hale_shlt_iyes_mi_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(65.2, 72.8)
  ) +
  scale_y_continuous(
    limits = c(-0.05, 0.35)
  ) +
  labs(
    x = "Years",
    y = "Average marginal effect",
    title = "Self-reported health"
  )

# Internet use rate
dat <- metareg_shlt_iyes_mi_adj %>%
  mutate(weights = weights(iuse_shlt_iyes_mi_adj))

dat_ci <- metafor::predict.rma(iuse_shlt_iyes_mi_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_shlt_iyes_mi_adj$internet_use_rate)

bubble_iuse_shlt <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = internet_use_rate, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = internet_use_rate, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(iuse_shlt_iyes_mi_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(iuse_shlt_iyes_mi_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(75, 99)
  ) +
  scale_y_continuous(
    limits = c(-0.05, 0.35)
  ) +
  labs(
    x = "Rate (%)",
    y = "Average marginal effect",
    title = "Self-reported health"
  )

# Digital skills among active population
dat <- metareg_shlt_iyes_mi_adj %>%
  mutate(weights = weights(dskill_shlt_iyes_mi_adj))

dat_ci <- metafor::predict.rma(dskill_shlt_iyes_mi_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_shlt_iyes_mi_adj$digital_skills_score)

bubble_dskill_shlt <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = digital_skills_score, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = digital_skills_score, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(dskill_shlt_iyes_mi_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(dskill_shlt_iyes_mi_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5),
    ) +
  scale_x_continuous(
    limits = c(34, 79)
  ) +
  scale_y_continuous(
    limits = c(-0.05, 0.35)
  ) +
  labs(
    x = "Score",
    y = "Average marginal effect",
    title = "Self-reported health"
  )


#### Pool ####
p_gdp <- wrap_elements(
  bubble_gdp_cesd + bubble_gdp_satlife + bubble_gdp_shlt + 
  plot_annotation(
    title = expression(paste(bold("a"), "  GDP per capita")),
    theme = theme(plot.title = element_text(size = 16))
    )
  )

p_gini <- wrap_elements(
  bubble_gini_cesd + bubble_gini_satlife + bubble_gini_shlt + 
  plot_annotation(
    title = expression(paste(bold("b"), "  Gini index")),
    theme = theme(plot.title = element_text(size = 16))
    )
  )

p_whi <- wrap_elements(
  bubble_whi_cesd + bubble_whi_satlife + bubble_whi_shlt + 
  plot_annotation(
    title = expression(paste(bold("c"), "  World happiness index")),
    theme = theme(plot.title = element_text(size = 16))
    )
  )

p_indiv <- wrap_elements(
  bubble_indiv_cesd + bubble_indiv_satlife + bubble_indiv_shlt + 
  plot_annotation(
    title = expression(paste(bold("d"), "  Hofstede’s index")),
    theme = theme(plot.title = element_text(size = 16))
    )
  )

p_hale <- wrap_elements(
  bubble_hale_cesd + bubble_hale_satlife + bubble_hale_shlt + 
  plot_annotation(
    title = expression(paste(bold("e"), "  Healthy life expectancy at birth")),
    theme = theme(plot.title = element_text(size = 16))
    )
  )

p_iuse <- wrap_elements(
  bubble_iuse_cesd + bubble_iuse_satlife + bubble_iuse_shlt + 
  plot_annotation(
    title = expression(paste(bold("f"), "  Internet use rate")),
    theme = theme(plot.title = element_text(size = 16))
    )
  )

p_dskill <- wrap_elements(
  bubble_dskill_cesd + bubble_dskill_satlife + bubble_dskill_shlt + 
  plot_annotation(
    title = expression(paste(bold("g"), "  Digital skills among active population")),
    theme = theme(plot.title = element_text(size = 16))
    )
  )

p_pool_bubble <- wrap_elements(
  p_gdp + p_gini + p_whi + p_indiv + p_hale + p_iuse + p_dskill +
  plot_layout(nrow = 7)
  )


ggsave(str_c(getwd(), "/results/Figure/Supplementary Figure 6_Bubble plot.tiff"), plot = p_pool_bubble, width = 12, height = 24, unit = "in", dpi = 500, device = "tiff")

rm(list = ls()[str_detect(string = ls(), pattern = "bubble_")])
rm(dat, dat_ci, p_gdp, p_gini, p_whi, p_indiv, p_hale, p_dskill, p_iuse, p_pool_bubble)

```

## Exclude the MHAS and ELSA

```{r}

#### CES-D ####
cesd_iyes_unadj_mi_meta_exclude <- rma(yi = estimate, sei = std.error, data = cesd_iyes_unadj_mi_results %>% filter(!country %in% c("Mexico", "England")), slab = country)

cesd_iyes_adj_mi_meta_exclude <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_mi_results %>% filter(!country %in% c("Mexico", "England")), slab = country)

#### Self-rated health ####
shlt_iyes_unadj_mi_meta_exclude <- rma(yi = estimate, sei = std.error, data = shlt_iyes_unadj_mi_results  %>% filter(!country %in% c("Mexico", "England")), slab = country)

shlt_iyes_adj_mi_meta_exclude <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_mi_results %>% filter(!country %in% c("Mexico", "England")), slab = country)

#### Life satisfaction ####
satlife_iyes_unadj_mi_meta_exclude <- rma(yi = estimate, sei = std.error, data = satlife_iyes_unadj_mi_results %>% filter(!country %in% c("Mexico", "England")), slab = country)

satlife_iyes_adj_mi_meta_exclude <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_mi_results %>% filter(!country %in% c("Mexico", "England")), slab = country)

```

### Supplementary Figure 7: Associations of Internet use with mental health excluding participants from the England and Mexico

```{r}

#### Theme setting ####
theme <- forestploter::forest_theme(
  core = list(bg_params = list(fill = c("white"))), 
  base_size = 10, 
  # base_family = "Arial",
  ci_pch = 15,
  ci_col = "#3B4992FF", 
  ci_alpha = 1,
  ci_lty = 1,
  ci_lwd = 1,
  ci_Theight = unit(0, "cm"),
  
  xaxis_lwd = 1,
  xaxis_cex = 1,
  
  summary_col = "#008B45FF", 
  refline_col = "gray", 
  refline_lwd = 2, 
  
  title_just = "center",
  title_cex = 1.2,
  title_fontface = "bold",
  title_col = "black",
  
  arrow_type = "closed",
  arrow_label_just = "end",
  arrow_length = 0.05,
  arrow_lwd = 1,
  arrow_fill = "black",
  arrow_col = "black"
  )

#### CES-D ####
# Data
dat <- cesd_iyes_adj_mi_results %>% filter(!country %in% c("Mexico", "England")) %>%
  mutate(weights = weights(cesd_iyes_adj_mi_meta_exclude)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(cesd_iyes_adj_mi_meta_exclude$beta),
      std.error = as.numeric(cesd_iyes_adj_mi_meta_exclude$se), 
      statistic = NA, df = NA, p.value = NA, p.sig = NA, 
      weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "AME (95% CI)", "Weight (%)")

p_cesd <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Fewer depressive symptoms","More depressive symptoms"),
  xlim = c(-0.5, 0.5),
  ticks_at = c(-0.5, -0.25, 0, 0.25, 0.5),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(cesd_iyes_adj_mi_meta_exclude$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(cesd_iyes_adj_mi_meta_exclude$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(cesd_iyes_adj_mi_meta_exclude$H2, digits = 2)))
    )

p_cesd <- add_text(
  p_cesd, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(cesd_iyes_adj_mi_meta_exclude$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(cesd_iyes_adj_mi_meta_exclude$k - cesd_iyes_adj_mi_meta_exclude$p), ") = ", 
        .(fmtx(cesd_iyes_adj_mi_meta_exclude$QE, digits = 2)), ", ",

        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(cesd_iyes_adj_mi_meta_exclude$k - cesd_iyes_adj_mi_meta_exclude$p), ") = ", 
        .(fmtx(cesd_iyes_adj_mi_meta_exclude$QE, digits = 2)), ", ",
        .(fmtp(cesd_iyes_adj_mi_meta_exclude$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
  }
  

p_cesd <- add_text(
  p_cesd, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(cesd_iyes_adj_mi_meta_exclude$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(cesd_iyes_adj_mi_meta_exclude$zval, digits = 2)), ", ",
        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(cesd_iyes_adj_mi_meta_exclude$zval, digits = 2)), ", ",
      .(fmtp(cesd_iyes_adj_mi_meta_exclude$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )    
  }

p_cesd <- add_text(
  p_cesd, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_cesd <- add_border(p_cesd, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))


#### Self-rated health ####
# Data
dat <- shlt_iyes_adj_mi_results %>% filter(!country %in% c("Mexico", "England")) %>%
  mutate(weights = weights(shlt_iyes_adj_mi_meta_exclude)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(shlt_iyes_adj_mi_meta_exclude$beta),
      std.error = as.numeric(shlt_iyes_adj_mi_meta_exclude$se), 
      statistic = NA, df = NA, p.value = NA, p.sig = NA, 
      weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "AME (95% CI)", "Weight (%)")

p_shlt <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Worse self-reported health","Better self-reported health"),
  xlim = c(-0.4, 0.4),
  ticks_at = c(-0.4, -0.2, 0, 0.2, 0.4),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(shlt_iyes_adj_mi_meta_exclude$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(shlt_iyes_adj_mi_meta_exclude$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(shlt_iyes_adj_mi_meta_exclude$H2, digits = 2)))
    )

p_shlt <- add_text(
  p_shlt, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(shlt_iyes_adj_mi_meta_exclude$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(shlt_iyes_adj_mi_meta_exclude$k - shlt_iyes_adj_mi_meta_exclude$p), ") = ", 
        .(fmtx(shlt_iyes_adj_mi_meta_exclude$QE, digits = 2)), ", ",

        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(shlt_iyes_adj_mi_meta_exclude$k - shlt_iyes_adj_mi_meta_exclude$p), ") = ", 
        .(fmtx(shlt_iyes_adj_mi_meta_exclude$QE, digits = 2)), ", ",
        .(fmtp(shlt_iyes_adj_mi_meta_exclude$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
  }

p_shlt <- add_text(
  p_shlt, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(shlt_iyes_adj_mi_meta_exclude$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(shlt_iyes_adj_mi_meta_exclude$zval, digits = 2)), ", ",
        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(shlt_iyes_adj_mi_meta_exclude$zval, digits = 2)), ", ",
      .(fmtp(shlt_iyes_adj_mi_meta_exclude$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )    
  }

p_shlt <- add_text(
  p_shlt, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_shlt <- add_border(p_shlt, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))


#### Life satisfaction ####
# Data
dat <- satlife_iyes_adj_mi_results %>% filter(!country %in% c("Mexico", "England")) %>%
  mutate(weights = weights(satlife_iyes_adj_mi_meta_exclude)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(satlife_iyes_adj_mi_meta_exclude$beta),
      std.error = as.numeric(satlife_iyes_adj_mi_meta_exclude$se), 
      statistic = NA, df = NA, p.value = NA, p.sig = NA, 
      weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "AME (95% CI)", "Weight (%)")

p_satlife <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Lower life satisfaction","Higher life satisfaction"),
  xlim = c(-0.2, 0.8),
  ticks_at = c(-0.2, 0, 0.2, 0.4, 0.6, 0.8),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(satlife_iyes_adj_mi_meta_exclude$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(satlife_iyes_adj_mi_meta_exclude$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(satlife_iyes_adj_mi_meta_exclude$H2, digits = 2)))
    )

p_satlife <- add_text(
  p_satlife, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(satlife_iyes_adj_mi_meta_exclude$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(satlife_iyes_adj_mi_meta_exclude$k - satlife_iyes_adj_mi_meta_exclude$p), ") = ", 
        .(fmtx(satlife_iyes_adj_mi_meta_exclude$QE, digits = 2)), ", ",

        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(satlife_iyes_adj_mi_meta_exclude$k - satlife_iyes_adj_mi_meta_exclude$p), ") = ", 
        .(fmtx(satlife_iyes_adj_mi_meta_exclude$QE, digits = 2)), ", ",
        .(fmtp(satlife_iyes_adj_mi_meta_exclude$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
  }

p_satlife <- add_text(
  p_satlife, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(satlife_iyes_adj_mi_meta_exclude$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(satlife_iyes_adj_mi_meta_exclude$zval, digits = 2)), ", ",
        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(satlife_iyes_adj_mi_meta_exclude$zval, digits = 2)), ", ",
      .(fmtp(satlife_iyes_adj_mi_meta_exclude$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )    
  }

p_satlife <- add_text(
  p_satlife, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_satlife <- add_border(p_satlife, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))

#### Pool ####
p_pool <- wrap_elements(
  wrap_elements(p_cesd) + wrap_elements(p_satlife) + wrap_elements(p_shlt) + 
    plot_layout(nrow = 2) + 
    plot_annotation(tag_levels = "a")
  ) 

ggsave(str_c(getwd(), "/results/Figure/Supplementary Figure 7_Forest plot_internet use_excluding ELSA and MHAS.tiff"), plot = p_pool, width = 16, height = 14, unit = "in", dpi = 500, device = "tiff")

rm(theme, dat, dat_fig, test_hetero, test_overall, p_cesd, p_satlife, p_shlt)

```


## Supplementary Figure 21: Unadjusted associations of Internet use with mental health

```{r}

#### Theme setting ####
theme <- forestploter::forest_theme(
  core = list(bg_params = list(fill = c("white"))), 
  base_size = 10,
  # base_family = "Arial",
  ci_pch = 15,
  ci_col = "#3B4992FF", 
  ci_alpha = 1,
  ci_lty = 1,
  ci_lwd = 1,
  ci_Theight = unit(0, "cm"),
  
  xaxis_lwd = 1,
  xaxis_cex = 1,
  
  summary_col = "#008B45FF", 
  refline_col = "gray", 
  refline_lwd = 2, 
  
  title_just = "center",
  title_cex = 1.2,
  title_fontface = "bold",
  title_col = "black",
  
  arrow_type = "closed",
  arrow_label_just = "end",
  arrow_length = 0.05,
  arrow_lwd = 1,
  arrow_fill = "black",
  arrow_col = "black"
  )

#### CES-D ####
# Data
dat <- cesd_iyes_unadj_mi_results %>%
  mutate(weights = weights(cesd_iyes_unadj_mi_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(cesd_iyes_unadj_mi_meta$beta),
      std.error = as.numeric(cesd_iyes_unadj_mi_meta$se), 
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "AME (95% CI)", "Weight (%)")

p_cesd <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Fewer depressive symptoms","More depressive symptoms"),
  xlim = c(-0.8, 1.6),
  ticks_at = c(-0.8, -0.4, 0, 0.4, 0.8, 1.2, 1.6),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(cesd_iyes_unadj_mi_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(cesd_iyes_unadj_mi_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(cesd_iyes_unadj_mi_meta$H2, digits = 2)))
    )

p_cesd <- add_text(
  p_cesd, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(cesd_iyes_unadj_mi_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(cesd_iyes_unadj_mi_meta$k - cesd_iyes_unadj_mi_meta$p), ") = ", 
        .(fmtx(cesd_iyes_unadj_mi_meta$QE, digits = 2)), ", ",

        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(cesd_iyes_unadj_mi_meta$k - cesd_iyes_unadj_mi_meta$p), ") = ", 
        .(fmtx(cesd_iyes_unadj_mi_meta$QE, digits = 2)), ", ",
        .(fmtp(cesd_iyes_unadj_mi_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
  }
  

p_cesd <- add_text(
  p_cesd, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(cesd_iyes_unadj_mi_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(cesd_iyes_unadj_mi_meta$zval, digits = 2)), ", ",
        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(cesd_iyes_unadj_mi_meta$zval, digits = 2)), ", ",
      .(fmtp(cesd_iyes_unadj_mi_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )    
  }

p_cesd <- add_text(
  p_cesd, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_cesd <- add_border(p_cesd, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))


#### Life satisfaction ####
# Data
dat <- satlife_iyes_unadj_mi_results %>%
  mutate(weights = weights(satlife_iyes_unadj_mi_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(satlife_iyes_unadj_mi_meta$beta),
      std.error = as.numeric(satlife_iyes_unadj_mi_meta$se), 
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "AME (95% CI)", "Weight (%)")

p_satlife <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Lower life satisfaction","Higher life satisfaction"),
  xlim = c(-0.2, 0.8),
  ticks_at = c(-0.2, 0, 0.2, 0.4, 0.6, 0.8),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(satlife_iyes_unadj_mi_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(satlife_iyes_unadj_mi_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(satlife_iyes_unadj_mi_meta$H2, digits = 2)))
    )

p_satlife <- add_text(
  p_satlife, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(satlife_iyes_unadj_mi_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(satlife_iyes_unadj_mi_meta$k - satlife_iyes_unadj_mi_meta$p), ") = ", 
        .(fmtx(satlife_iyes_unadj_mi_meta$QE, digits = 2)), ", ",

        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(satlife_iyes_unadj_mi_meta$k - satlife_iyes_unadj_mi_meta$p), ") = ", 
        .(fmtx(satlife_iyes_unadj_mi_meta$QE, digits = 2)), ", ",
        .(fmtp(satlife_iyes_unadj_mi_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
  }

p_satlife <- add_text(
  p_satlife, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(satlife_iyes_unadj_mi_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(satlife_iyes_unadj_mi_meta$zval, digits = 2)), ", ",
        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(satlife_iyes_unadj_mi_meta$zval, digits = 2)), ", ",
      .(fmtp(satlife_iyes_unadj_mi_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )    
  }

p_satlife <- add_text(
  p_satlife, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_satlife <- add_border(p_satlife, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))

#### Self-rated health ####
# Data
dat <- shlt_iyes_unadj_mi_results %>%
  mutate(weights = weights(shlt_iyes_unadj_mi_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(shlt_iyes_unadj_mi_meta$beta),
      std.error = as.numeric(shlt_iyes_unadj_mi_meta$se), 
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "AME (95% CI)", "Weight (%)")

p_shlt <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Worse self-reported health","Better self-reported health"),
  xlim = c(-0.2, 0.8),
  ticks_at = c(-0.2, 0, 0.2, 0.4, 0.6, 0.8),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(shlt_iyes_unadj_mi_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(shlt_iyes_unadj_mi_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(shlt_iyes_unadj_mi_meta$H2, digits = 2)))
    )

p_shlt <- add_text(
  p_shlt, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(shlt_iyes_unadj_mi_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(shlt_iyes_unadj_mi_meta$k - shlt_iyes_unadj_mi_meta$p), ") = ", 
        .(fmtx(shlt_iyes_unadj_mi_meta$QE, digits = 2)), ", ",

        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(shlt_iyes_unadj_mi_meta$k - shlt_iyes_unadj_mi_meta$p), ") = ", 
        .(fmtx(shlt_iyes_unadj_mi_meta$QE, digits = 2)), ", ",
        .(fmtp(shlt_iyes_unadj_mi_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
  }

p_shlt <- add_text(
  p_shlt, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(shlt_iyes_unadj_mi_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(shlt_iyes_unadj_mi_meta$zval, digits = 2)), ", ",
        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(shlt_iyes_unadj_mi_meta$zval, digits = 2)), ", ",
      .(fmtp(shlt_iyes_unadj_mi_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )    
  }

p_shlt <- add_text(
  p_shlt, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_shlt <- add_border(p_shlt, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))


#### Pool ####
p_pool <- wrap_elements(
  wrap_elements(p_cesd) + wrap_elements(p_satlife) + wrap_elements(p_shlt) + 
    plot_layout(nrow = 2) + 
    plot_annotation(tag_levels = "a")
  ) 

ggsave(str_c(getwd(), "/results/Figure/Supplementary Figure 21_Forest plot_internet use_unadjusted.tiff"), plot = p_pool, width = 16, height = 14, unit = "in", dpi = 500, device = "tiff")

rm(theme, dat, dat_fig, test_hetero, test_overall, p_cesd, p_satlife, p_shlt, p_pool)

```



# Subgroup analyses for Internet use (yes/no)

## Data for the overall interaction test

```{r}

subgroup_mi_iyes_merge <- list()
for(i in 1:10){
  subgroup_iyes <- mi_iyes_merge[[i]] %>%
    mutate(
      old = ifelse(age >= 65, "yes", "no"),
      old = factor(old),
      withdis = ifelse(dis >= 1, "yes", "no"),
      withdis = factor(withdis)
    )
  subgroup_mi_iyes_merge[[i]] <- subgroup_iyes
  rm(subgroup_iyes)
}

# Subgroup analyses needs 8 hours to complete.

```

## By age

### 50-64 years

```{r warning=FALSE}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

tic()
#### CES-D ####
#lme4
cesd_iyes_adj_mi_middle_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    cesd_iyes_adj_mi <- lmer(
      cesd_stand ~ internet_yes*cwave + 
        male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(age < 65), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    cesd_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      cesd_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    cesd_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        cesd_stand ~ internet_yes*cwave + 
          male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(age < 65), control = lmerControl(optimizer = 'bobyqa'))
      })
    cesd_iyes_adj_mi_result <- lapply(seq_along(cesd_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  cesd_iyes_adj_mi_middle_results <- cesd_iyes_adj_mi_middle_results %>% 
    bind_rows(., cesd_iyes_adj_mi_result)
  
  rm(cesd_iyes_adj_mi, cesd_iyes_adj_mi_result)
}

# metafor
cesd_iyes_adj_mi_middle_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_mi_middle_results, slab = country)

#### Life satisfaction ####
# lme4
satlife_iyes_adj_mi_middle_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    satlife_iyes_adj_mi <- lmer(
      satlife_stand ~ internet_yes*cwave + 
        male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(age < 65), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    satlife_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      satlife_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    satlife_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        satlife_stand ~ internet_yes*cwave + 
          male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(age < 65), control = lmerControl(optimizer = 'bobyqa'))
      })
    satlife_iyes_adj_mi_result <- lapply(seq_along(satlife_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  satlife_iyes_adj_mi_middle_results <- satlife_iyes_adj_mi_middle_results %>% 
    bind_rows(., satlife_iyes_adj_mi_result)
  
  rm(satlife_iyes_adj_mi, satlife_iyes_adj_mi_result)
}

# metafor
satlife_iyes_adj_mi_middle_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_mi_middle_results, slab = country)

#### Self-rated health ####
# lme4
shlt_iyes_adj_mi_middle_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    shlt_iyes_adj_mi <- lmer(
      shlt_stand ~ internet_yes*cwave + 
        male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(age < 65), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    shlt_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      shlt_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    shlt_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        shlt_stand ~ internet_yes*cwave + 
          male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(age < 65), control = lmerControl(optimizer = 'bobyqa'))
      })
    shlt_iyes_adj_mi_result <- lapply(seq_along(shlt_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  shlt_iyes_adj_mi_middle_results <- shlt_iyes_adj_mi_middle_results %>% 
    bind_rows(., shlt_iyes_adj_mi_result)
  
  rm(shlt_iyes_adj_mi, shlt_iyes_adj_mi_result)
}

# metafor
shlt_iyes_adj_mi_middle_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_mi_middle_results, slab = country)

toc() # 1229.61 sec elapsed

```

### ≥65 years

```{r warning=FALSE}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

# Poland: no older adults use internet
# See Complete cases

tic()
#### CES-D  ####
# lme4
cesd_iyes_adj_mi_old_results <- tibble()
for(i in c(1:17,19:23)){
  
  if(i==3){
    cesd_iyes_adj_mi <- lmer(
      cesd_stand ~ internet_yes*cwave + 
        male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(age >= 65), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    cesd_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      cesd_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    cesd_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        cesd_stand ~ internet_yes*cwave + 
          male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(age >= 65), control = lmerControl(optimizer = 'bobyqa'))
      })
    cesd_iyes_adj_mi_result <- lapply(seq_along(cesd_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  cesd_iyes_adj_mi_old_results <- cesd_iyes_adj_mi_old_results %>% 
    bind_rows(., cesd_iyes_adj_mi_result)
  
  rm(cesd_iyes_adj_mi, cesd_iyes_adj_mi_result)
}

# metafor
cesd_iyes_adj_mi_old_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_mi_old_results, slab = country)

#### Life satisfaction #### 
# lme4
satlife_iyes_adj_mi_old_results <- tibble()
for(i in c(1:17,19:23)){
  
  if(i==3){
    satlife_iyes_adj_mi <- lmer(
      satlife_stand ~ internet_yes*cwave + 
        male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(age >= 65), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    satlife_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      satlife_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    satlife_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        satlife_stand ~ internet_yes*cwave + 
          male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(age >= 65), control = lmerControl(optimizer = 'bobyqa'))
      })
    satlife_iyes_adj_mi_result <- lapply(seq_along(satlife_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  satlife_iyes_adj_mi_old_results <- satlife_iyes_adj_mi_old_results %>% 
    bind_rows(., satlife_iyes_adj_mi_result)
  
  rm(satlife_iyes_adj_mi, satlife_iyes_adj_mi_result)
}

# metafor
satlife_iyes_adj_mi_old_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_mi_old_results, slab = country)


#### Self-rated health #### 
# lme4
shlt_iyes_adj_mi_old_results <- tibble()
for(i in c(1:17,19:23)){
  
  if(i==3){
    shlt_iyes_adj_mi <- lmer(
      shlt_stand ~ internet_yes*cwave + 
        male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(age >= 65), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    shlt_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      shlt_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    shlt_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        shlt_stand ~ internet_yes*cwave + 
          male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(age >= 65), control = lmerControl(optimizer = 'bobyqa'))
      })
    shlt_iyes_adj_mi_result <- lapply(seq_along(shlt_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  shlt_iyes_adj_mi_old_results <- shlt_iyes_adj_mi_old_results %>% 
    bind_rows(., shlt_iyes_adj_mi_result)
  
  rm(shlt_iyes_adj_mi, shlt_iyes_adj_mi_result)
}

# metafor
shlt_iyes_adj_mi_old_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_mi_old_results, slab = country)

toc() # 1031.61 sec elapsed

```

### Meta analysis subgroup analysis

```{r}

#### CES-D ####
cesd_iyes_adj_mi_age_results <- cesd_iyes_adj_mi_middle_results %>%
  mutate(subgroup = "middle") %>%
  bind_rows(., cesd_iyes_adj_mi_old_results %>% mutate(subgroup = "old"))

cesd_iyes_adj_mi_age_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = cesd_iyes_adj_mi_age_results, slab = country)


#### Life satisfaction ####
satlife_iyes_adj_mi_age_results <- satlife_iyes_adj_mi_middle_results %>%
  mutate(subgroup = "middle") %>%
  bind_rows(., satlife_iyes_adj_mi_old_results %>% mutate(subgroup = "old"))

satlife_iyes_adj_mi_age_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = satlife_iyes_adj_mi_age_results, slab = country)


#### Self-reported health ####
shlt_iyes_adj_mi_age_results <- shlt_iyes_adj_mi_middle_results %>%
  mutate(subgroup = "middle") %>%
  bind_rows(., shlt_iyes_adj_mi_old_results %>% mutate(subgroup = "old"))

shlt_iyes_adj_mi_age_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = shlt_iyes_adj_mi_age_results, slab = country)

```


## By gender

### Male

```{r warning=FALSE}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

tic()
#### CES-D  ####
# lme4
cesd_iyes_adj_mi_male_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    cesd_iyes_adj_mi <- lmer(
      cesd_stand ~ internet_yes*cwave + 
        age + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(male == "male"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    cesd_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      cesd_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    cesd_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        cesd_stand ~ internet_yes*cwave + 
          age + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(male == "male"), control = lmerControl(optimizer = 'bobyqa'))
      })
    cesd_iyes_adj_mi_result <- lapply(seq_along(cesd_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  cesd_iyes_adj_mi_male_results <- cesd_iyes_adj_mi_male_results %>% 
    bind_rows(., cesd_iyes_adj_mi_result)
  
  rm(cesd_iyes_adj_mi, cesd_iyes_adj_mi_result)
}

# metafor
cesd_iyes_adj_mi_male_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_mi_male_results, slab = country)


#### Life satisfaction #### 
# lme4
satlife_iyes_adj_mi_male_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    satlife_iyes_adj_mi <- lmer(
      satlife_stand ~ internet_yes*cwave + 
        age + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(male == "male"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    satlife_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      satlife_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    satlife_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        satlife_stand ~ internet_yes*cwave + 
          age + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(male == "male"), control = lmerControl(optimizer = 'bobyqa'))
      })
    satlife_iyes_adj_mi_result <- lapply(seq_along(satlife_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  satlife_iyes_adj_mi_male_results <- satlife_iyes_adj_mi_male_results %>% 
    bind_rows(., satlife_iyes_adj_mi_result)
  
  rm(satlife_iyes_adj_mi, satlife_iyes_adj_mi_result)
}

# metafor
satlife_iyes_adj_mi_male_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_mi_male_results, slab = country)

#### Self-rated health #### 
# lme4
shlt_iyes_adj_mi_male_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    shlt_iyes_adj_mi <- lmer(
      shlt_stand ~ internet_yes*cwave + 
        age + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(male == "male"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    shlt_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      shlt_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    shlt_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        shlt_stand ~ internet_yes*cwave + 
          age + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(male == "male"), control = lmerControl(optimizer = 'bobyqa'))
      })
    shlt_iyes_adj_mi_result <- lapply(seq_along(shlt_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  shlt_iyes_adj_mi_male_results <- shlt_iyes_adj_mi_male_results %>% 
    bind_rows(., shlt_iyes_adj_mi_result)
  
  rm(shlt_iyes_adj_mi, shlt_iyes_adj_mi_result)
}

# metafor
shlt_iyes_adj_mi_male_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_mi_male_results, slab = country)

toc() # 1359.5 sec elapsed

```

### Female

```{r warning=FALSE}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

tic()
#### CES-D ####
# lme4
cesd_iyes_adj_mi_female_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    cesd_iyes_adj_mi <- lmer(
      cesd_stand ~ internet_yes*cwave + 
        age + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(male == "female"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    cesd_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      cesd_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    cesd_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        cesd_stand ~ internet_yes*cwave + 
          age + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(male == "female"), control = lmerControl(optimizer = 'bobyqa'))
      })
    cesd_iyes_adj_mi_result <- lapply(seq_along(cesd_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  cesd_iyes_adj_mi_female_results <- cesd_iyes_adj_mi_female_results %>% 
    bind_rows(., cesd_iyes_adj_mi_result)
  
  rm(cesd_iyes_adj_mi, cesd_iyes_adj_mi_result)
}

# metafor
cesd_iyes_adj_mi_female_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_mi_female_results, slab = country)


#### Life satisfaction #### 
# lme4
satlife_iyes_adj_mi_female_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    satlife_iyes_adj_mi <- lmer(
      satlife_stand ~ internet_yes*cwave + 
        age + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(male == "female"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    satlife_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      satlife_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    satlife_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        satlife_stand ~ internet_yes*cwave + 
          age + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(male == "female"), control = lmerControl(optimizer = 'bobyqa'))
      })
    satlife_iyes_adj_mi_result <- lapply(seq_along(satlife_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  satlife_iyes_adj_mi_female_results <- satlife_iyes_adj_mi_female_results %>% 
    bind_rows(., satlife_iyes_adj_mi_result)
  
  rm(satlife_iyes_adj_mi, satlife_iyes_adj_mi_result)
}

# metafor
satlife_iyes_adj_mi_female_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_mi_female_results, slab = country)


#### Self-rated health #### 
# lme4
shlt_iyes_adj_mi_female_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    shlt_iyes_adj_mi <- lmer(
      shlt_stand ~ internet_yes*cwave + 
        age + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(male == "female"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    shlt_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      shlt_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    shlt_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        shlt_stand ~ internet_yes*cwave + 
          age + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(male == "female"), control = lmerControl(optimizer = 'bobyqa'))
      })
    shlt_iyes_adj_mi_result <- lapply(seq_along(shlt_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  shlt_iyes_adj_mi_female_results <- shlt_iyes_adj_mi_female_results %>% 
    bind_rows(., shlt_iyes_adj_mi_result)
  
  rm(shlt_iyes_adj_mi, shlt_iyes_adj_mi_result)
}

# metafor
shlt_iyes_adj_mi_female_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_mi_female_results, slab = country)

toc() # 1316.92 sec elapsed

```

### Meta analysis subgroup analysis

```{r}

#### CES-D ####
cesd_iyes_adj_mi_gender_results <- cesd_iyes_adj_mi_male_results %>%
  mutate(subgroup = "male") %>%
  bind_rows(., cesd_iyes_adj_mi_female_results %>% mutate(subgroup = "female"))

cesd_iyes_adj_mi_gender_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = cesd_iyes_adj_mi_gender_results, slab = country)


#### Life satisfaction ####
satlife_iyes_adj_mi_gender_results <- satlife_iyes_adj_mi_male_results %>%
  mutate(subgroup = "male") %>%
  bind_rows(., satlife_iyes_adj_mi_female_results %>% mutate(subgroup = "female"))

satlife_iyes_adj_mi_gender_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = satlife_iyes_adj_mi_gender_results, slab = country)


#### Self-reported health ####
shlt_iyes_adj_mi_gender_results <- shlt_iyes_adj_mi_male_results %>%
  mutate(subgroup = "male") %>%
  bind_rows(., shlt_iyes_adj_mi_female_results %>% mutate(subgroup = "female"))

shlt_iyes_adj_mi_gender_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = shlt_iyes_adj_mi_gender_results, slab = country)

```

## By marital status

### Married

```{r warning=FALSE}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

tic()
#### CES-D ####
# lme4
cesd_iyes_adj_mi_married_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    cesd_iyes_adj_mi <- lmer(
      cesd_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(nonmarried == "no"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    cesd_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      cesd_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    cesd_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        cesd_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(nonmarried == "no"), control = lmerControl(optimizer = 'bobyqa'))
      })
    cesd_iyes_adj_mi_result <- lapply(seq_along(cesd_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  cesd_iyes_adj_mi_married_results <- cesd_iyes_adj_mi_married_results %>% 
    bind_rows(., cesd_iyes_adj_mi_result)
  
  rm(cesd_iyes_adj_mi, cesd_iyes_adj_mi_result)
}

# metafor
cesd_iyes_adj_mi_married_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_mi_married_results, slab = country)


#### Life satisfaction ####
# lme4
satlife_iyes_adj_mi_married_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    satlife_iyes_adj_mi <- lmer(
      satlife_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(nonmarried == "no"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    satlife_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      satlife_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    satlife_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        satlife_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(nonmarried == "no"), control = lmerControl(optimizer = 'bobyqa'))
      })
    satlife_iyes_adj_mi_result <- lapply(seq_along(satlife_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  satlife_iyes_adj_mi_married_results <- satlife_iyes_adj_mi_married_results %>% 
    bind_rows(., satlife_iyes_adj_mi_result)
  
  rm(satlife_iyes_adj_mi, satlife_iyes_adj_mi_result)
}

# metafor
satlife_iyes_adj_mi_married_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_mi_married_results, slab = country)


#### Self-rated health #### 
# lme4
shlt_iyes_adj_mi_married_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    shlt_iyes_adj_mi <- lmer(
      shlt_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(nonmarried == "no"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    shlt_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      shlt_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    shlt_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        shlt_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(nonmarried == "no"), control = lmerControl(optimizer = 'bobyqa'))
      })
    shlt_iyes_adj_mi_result <- lapply(seq_along(shlt_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  shlt_iyes_adj_mi_married_results <- shlt_iyes_adj_mi_married_results %>% 
    bind_rows(., shlt_iyes_adj_mi_result)
  
  rm(shlt_iyes_adj_mi, shlt_iyes_adj_mi_result)
}

# metafor
shlt_iyes_adj_mi_married_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_mi_married_results, slab = country)

toc() # 1910.61 sec elapsed

```


### Nonmarried

```{r warning=FALSE}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

tic()
#### CES-D ####
# lme4
cesd_iyes_adj_mi_nonmarried_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    cesd_iyes_adj_mi <- lmer(
      cesd_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(nonmarried == "yes"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    cesd_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      cesd_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    cesd_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        cesd_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(nonmarried == "yes"), control = lmerControl(optimizer = 'bobyqa'))
      })
    cesd_iyes_adj_mi_result <- lapply(seq_along(cesd_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  cesd_iyes_adj_mi_nonmarried_results <- cesd_iyes_adj_mi_nonmarried_results %>% 
    bind_rows(., cesd_iyes_adj_mi_result)
  
  rm(cesd_iyes_adj_mi, cesd_iyes_adj_mi_result)
}

# metafor
cesd_iyes_adj_mi_nonmarried_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_mi_nonmarried_results, slab = country)


#### Life satisfaction #### 
# lme4
satlife_iyes_adj_mi_nonmarried_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    satlife_iyes_adj_mi <- lmer(
      satlife_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(nonmarried == "yes"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    satlife_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      satlife_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    satlife_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        satlife_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(nonmarried == "yes"), control = lmerControl(optimizer = 'bobyqa'))
      })
    satlife_iyes_adj_mi_result <- lapply(seq_along(satlife_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  satlife_iyes_adj_mi_nonmarried_results <- satlife_iyes_adj_mi_nonmarried_results %>% 
    bind_rows(., satlife_iyes_adj_mi_result)
  
  rm(satlife_iyes_adj_mi, satlife_iyes_adj_mi_result)
}

# metafor
satlife_iyes_adj_mi_nonmarried_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_mi_nonmarried_results, slab = country)


#### Self-rated health ####
# lme4
shlt_iyes_adj_mi_nonmarried_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    shlt_iyes_adj_mi <- lmer(
      shlt_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(nonmarried == "yes"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    shlt_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      shlt_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    shlt_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        shlt_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(nonmarried == "yes"), control = lmerControl(optimizer = 'bobyqa'))
      })
    shlt_iyes_adj_mi_result <- lapply(seq_along(shlt_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  shlt_iyes_adj_mi_nonmarried_results <- shlt_iyes_adj_mi_nonmarried_results %>% 
    bind_rows(., shlt_iyes_adj_mi_result)
  
  rm(shlt_iyes_adj_mi, shlt_iyes_adj_mi_result)
}

# metafor
shlt_iyes_adj_mi_nonmarried_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_mi_nonmarried_results, slab = country)

toc() # 714.69 sec elapsed

```

### Meta analysis subgroup analysis

```{r}

#### CES-D ####
cesd_iyes_adj_mi_marry_results <- cesd_iyes_adj_mi_married_results %>%
  mutate(subgroup = "married") %>%
  bind_rows(., cesd_iyes_adj_mi_nonmarried_results %>% mutate(subgroup = "nonmarried"))

cesd_iyes_adj_mi_marry_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = cesd_iyes_adj_mi_marry_results, slab = country)


#### Life satisfaction ####
satlife_iyes_adj_mi_marry_results <- satlife_iyes_adj_mi_married_results %>%
  mutate(subgroup = "married") %>%
  bind_rows(., satlife_iyes_adj_mi_nonmarried_results %>% mutate(subgroup = "nonmarried"))

satlife_iyes_adj_mi_marry_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = satlife_iyes_adj_mi_marry_results, slab = country)


#### Self-reported health ####
shlt_iyes_adj_mi_marry_results <- shlt_iyes_adj_mi_married_results %>%
  mutate(subgroup = "married") %>%
  bind_rows(., shlt_iyes_adj_mi_nonmarried_results %>% mutate(subgroup = "nonmarried"))

shlt_iyes_adj_mi_marry_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = shlt_iyes_adj_mi_marry_results, slab = country)

```


## By contact with others

### Weekly contact

```{r warning=FALSE}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

tic()
#### CES-D ####
# lme4
cesd_iyes_adj_mi_contact_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    cesd_iyes_adj_mi <- lmer(
      cesd_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(contact == "yes"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    cesd_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      cesd_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    cesd_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        cesd_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(contact == "yes"), control = lmerControl(optimizer = 'bobyqa'))
      })
    cesd_iyes_adj_mi_result <- lapply(seq_along(cesd_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  cesd_iyes_adj_mi_contact_results <- cesd_iyes_adj_mi_contact_results %>% 
    bind_rows(., cesd_iyes_adj_mi_result)
  
  rm(cesd_iyes_adj_mi, cesd_iyes_adj_mi_result)
}

# metafor
cesd_iyes_adj_mi_contact_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_mi_contact_results, slab = country)


#### Life satisfaction #### 
# lme4
satlife_iyes_adj_mi_contact_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    satlife_iyes_adj_mi <- lmer(
      satlife_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(contact == "yes"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    satlife_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      satlife_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    satlife_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        satlife_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(contact == "yes"), control = lmerControl(optimizer = 'bobyqa'))
      })
    satlife_iyes_adj_mi_result <- lapply(seq_along(satlife_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  satlife_iyes_adj_mi_contact_results <- satlife_iyes_adj_mi_contact_results %>% 
    bind_rows(., satlife_iyes_adj_mi_result)
  
  rm(satlife_iyes_adj_mi, satlife_iyes_adj_mi_result)
}

# metafor
satlife_iyes_adj_mi_contact_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_mi_contact_results, slab = country)


#### Self-rated health #### 
# lme4
shlt_iyes_adj_mi_contact_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    shlt_iyes_adj_mi <- lmer(
      shlt_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(contact == "yes"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    shlt_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      shlt_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    shlt_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        shlt_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(contact == "yes"), control = lmerControl(optimizer = 'bobyqa'))
      })
    shlt_iyes_adj_mi_result <- lapply(seq_along(shlt_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  shlt_iyes_adj_mi_contact_results <- shlt_iyes_adj_mi_contact_results %>% 
    bind_rows(., shlt_iyes_adj_mi_result)
  
  rm(shlt_iyes_adj_mi, shlt_iyes_adj_mi_result)
}

# metafor
shlt_iyes_adj_mi_contact_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_mi_contact_results, slab = country)

toc() # 2528.05 sec elapsed

```


### Less than weekly contact

```{r warning=FALSE}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

# Poland: too few observations to fit the model
nrow(subgroup_mi_iyes_merge[[1]] %>% filter(country_names == "Poland") %>% filter(contact == "no")) # 7

tic()
#### CES-D ####
# lme4
cesd_iyes_adj_mi_nocontact_results <- tibble()
for(i in c(1:17,19:23)){
  
  if(i==3){
    cesd_iyes_adj_mi <- lmer(
      cesd_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(contact == "no"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    cesd_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      cesd_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    cesd_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        cesd_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(contact == "no"), control = lmerControl(optimizer = 'bobyqa'))
      })
    cesd_iyes_adj_mi_result <- lapply(seq_along(cesd_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  cesd_iyes_adj_mi_nocontact_results <- cesd_iyes_adj_mi_nocontact_results %>% 
    bind_rows(., cesd_iyes_adj_mi_result)
  
  rm(cesd_iyes_adj_mi, cesd_iyes_adj_mi_result)
}

# metafor
cesd_iyes_adj_mi_nocontact_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_mi_nocontact_results, slab = country)


#### Life satisfaction #### 
# lme4
satlife_iyes_adj_mi_nocontact_results <- tibble()
for(i in c(1:17,19:23)){
  
  if(i==3){
    satlife_iyes_adj_mi <- lmer(
      satlife_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(contact == "no"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    satlife_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      satlife_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    satlife_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        satlife_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(contact == "no"), control = lmerControl(optimizer = 'bobyqa'))
      })
    satlife_iyes_adj_mi_result <- lapply(seq_along(satlife_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  satlife_iyes_adj_mi_nocontact_results <- satlife_iyes_adj_mi_nocontact_results %>% 
    bind_rows(., satlife_iyes_adj_mi_result)
  
  rm(satlife_iyes_adj_mi, satlife_iyes_adj_mi_result)
}

# metafor
satlife_iyes_adj_mi_nocontact_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_mi_nocontact_results, slab = country)

#### Self-rated health ####
# lme4
shlt_iyes_adj_mi_nocontact_results <- tibble()
for(i in c(1:17,19:23)){
  
  if(i==3){
    shlt_iyes_adj_mi <- lmer(
      shlt_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(contact == "no"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    shlt_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      shlt_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    shlt_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        shlt_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(contact == "no"), control = lmerControl(optimizer = 'bobyqa'))
      })
    shlt_iyes_adj_mi_result <- lapply(seq_along(shlt_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  shlt_iyes_adj_mi_nocontact_results <- shlt_iyes_adj_mi_nocontact_results %>% 
    bind_rows(., shlt_iyes_adj_mi_result)
  
  rm(shlt_iyes_adj_mi, shlt_iyes_adj_mi_result)
}

# metafor
shlt_iyes_adj_mi_nocontact_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_mi_nocontact_results, slab = country)

toc() # 412.75 sec elapsed

```

### Meta analysis subgroup analysis

```{r}

#### CES-D ####
cesd_iyes_adj_mi_wcontact_results <- cesd_iyes_adj_mi_contact_results %>%
  mutate(subgroup = "contact") %>%
  bind_rows(., cesd_iyes_adj_mi_nocontact_results %>% mutate(subgroup = "nocontact"))

cesd_iyes_adj_mi_wcontact_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = cesd_iyes_adj_mi_wcontact_results, slab = country)


#### Life satisfaction ####
satlife_iyes_adj_mi_wcontact_results <- satlife_iyes_adj_mi_contact_results %>%
  mutate(subgroup = "contact") %>%
  bind_rows(., satlife_iyes_adj_mi_nocontact_results %>% mutate(subgroup = "nocontact"))

satlife_iyes_adj_mi_wcontact_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = satlife_iyes_adj_mi_wcontact_results, slab = country) # Significant


#### Self-reported health ####
shlt_iyes_adj_mi_wcontact_results <- shlt_iyes_adj_mi_contact_results %>%
  mutate(subgroup = "contact") %>%
  bind_rows(., shlt_iyes_adj_mi_nocontact_results %>% mutate(subgroup = "nocontact"))

shlt_iyes_adj_mi_wcontact_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = shlt_iyes_adj_mi_wcontact_results, slab = country)

```

## By education

### Primary

```{r warning=FALSE}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

tic()
#### CES-D ####
# lme4
cesd_iyes_adj_mi_pedu_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    cesd_iyes_adj_mi <- lmer(
      cesd_stand ~ internet_yes*cwave + 
        age + male + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(lowedu == "primary"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    cesd_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      cesd_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    cesd_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        cesd_stand ~ internet_yes*cwave + 
          age + male + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lowedu == "primary"), control = lmerControl(optimizer = 'bobyqa'))
      })
    cesd_iyes_adj_mi_result <- lapply(seq_along(cesd_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  cesd_iyes_adj_mi_pedu_results <- cesd_iyes_adj_mi_pedu_results %>% 
    bind_rows(., cesd_iyes_adj_mi_result)
  
  rm(cesd_iyes_adj_mi, cesd_iyes_adj_mi_result)
}

# metafor
cesd_iyes_adj_mi_pedu_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_mi_pedu_results, slab = country)


#### Life satisfaction ####
# lme4
satlife_iyes_adj_mi_pedu_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    satlife_iyes_adj_mi <- lmer(
      satlife_stand ~ internet_yes*cwave + 
        age + male + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(lowedu == "primary"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    satlife_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      satlife_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    satlife_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        satlife_stand ~ internet_yes*cwave + 
          age + male + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lowedu == "primary"), control = lmerControl(optimizer = 'bobyqa'))
      })
    satlife_iyes_adj_mi_result <- lapply(seq_along(satlife_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  satlife_iyes_adj_mi_pedu_results <- satlife_iyes_adj_mi_pedu_results %>% 
    bind_rows(., satlife_iyes_adj_mi_result)
  
  rm(satlife_iyes_adj_mi, satlife_iyes_adj_mi_result)
}

# metafor
satlife_iyes_adj_mi_pedu_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_mi_pedu_results, slab = country)


#### Self-rated health ####
# lme4
shlt_iyes_adj_mi_pedu_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    shlt_iyes_adj_mi <- lmer(
      shlt_stand ~ internet_yes*cwave + 
        age + male + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(lowedu == "primary"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    shlt_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      shlt_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    shlt_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        shlt_stand ~ internet_yes*cwave + 
          age + male + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lowedu == "primary"), control = lmerControl(optimizer = 'bobyqa'))
      })
    shlt_iyes_adj_mi_result <- lapply(seq_along(shlt_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  shlt_iyes_adj_mi_pedu_results <- shlt_iyes_adj_mi_pedu_results %>% 
    bind_rows(., shlt_iyes_adj_mi_result)
  
  rm(shlt_iyes_adj_mi, shlt_iyes_adj_mi_result)
}

# metafor
shlt_iyes_adj_mi_pedu_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_mi_pedu_results, slab = country)

toc() # 1007.93 sec elapsed

```


### Secondary

```{r warning=FALSE}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

tic()
#### CES-D ####
# lme4
cesd_iyes_adj_mi_sedu_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    cesd_iyes_adj_mi <- lmer(
      cesd_stand ~ internet_yes*cwave + 
        age + male + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(lowedu == "secondary"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    cesd_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      cesd_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    cesd_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        cesd_stand ~ internet_yes*cwave + 
          age + male + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lowedu == "secondary"), control = lmerControl(optimizer = 'bobyqa'))
      })
    cesd_iyes_adj_mi_result <- lapply(seq_along(cesd_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  cesd_iyes_adj_mi_sedu_results <- cesd_iyes_adj_mi_sedu_results %>% 
    bind_rows(., cesd_iyes_adj_mi_result)
  
  rm(cesd_iyes_adj_mi, cesd_iyes_adj_mi_result)
}

# metafor
cesd_iyes_adj_mi_sedu_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_mi_sedu_results, slab = country)


#### Life satisfaction ####
# lme4
satlife_iyes_adj_mi_sedu_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    satlife_iyes_adj_mi <- lmer(
      satlife_stand ~ internet_yes*cwave + 
        age + male + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(lowedu == "secondary"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    satlife_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      satlife_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    satlife_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        satlife_stand ~ internet_yes*cwave + 
          age + male + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lowedu == "secondary"), control = lmerControl(optimizer = 'bobyqa'))
      })
    satlife_iyes_adj_mi_result <- lapply(seq_along(satlife_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  satlife_iyes_adj_mi_sedu_results <- satlife_iyes_adj_mi_sedu_results %>% 
    bind_rows(., satlife_iyes_adj_mi_result)
  
  rm(satlife_iyes_adj_mi, satlife_iyes_adj_mi_result)
}

# metafor
satlife_iyes_adj_mi_sedu_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_mi_sedu_results, slab = country)


#### Self-rated health ####
# lme4
shlt_iyes_adj_mi_sedu_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    shlt_iyes_adj_mi <- lmer(
      shlt_stand ~ internet_yes*cwave + 
        age + male + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(lowedu == "secondary"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    shlt_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      shlt_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    shlt_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        shlt_stand ~ internet_yes*cwave + 
          age + male + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lowedu == "secondary"), control = lmerControl(optimizer = 'bobyqa'))
      })
    shlt_iyes_adj_mi_result <- lapply(seq_along(shlt_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  shlt_iyes_adj_mi_sedu_results <- shlt_iyes_adj_mi_sedu_results %>% 
    bind_rows(., shlt_iyes_adj_mi_result)
  
  rm(shlt_iyes_adj_mi, shlt_iyes_adj_mi_result)
}

# metafor
shlt_iyes_adj_mi_sedu_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_mi_sedu_results, slab = country)

toc() # 1043.79 sec elapsed

```

### Tertiary

```{r warning=FALSE}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

# Poland: too few observations to fit the model
nrow(subgroup_mi_iyes_merge[[1]] %>% filter(country_names == "Poland") %>% filter(lowedu == "tertiary")) # 43

tic()
#### CES-D ####
# lme4
cesd_iyes_adj_mi_tedu_results <- tibble()
for(i in c(1:17,19:23)){
  
  if(i==3){
    cesd_iyes_adj_mi <- lmer(
      cesd_stand ~ internet_yes*cwave + 
        age + male + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(lowedu == "tertiary"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    cesd_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      cesd_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    cesd_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        cesd_stand ~ internet_yes*cwave + 
          age + male + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lowedu == "tertiary"), control = lmerControl(optimizer = 'bobyqa'))
      })
    cesd_iyes_adj_mi_result <- lapply(seq_along(cesd_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  cesd_iyes_adj_mi_tedu_results <- cesd_iyes_adj_mi_tedu_results %>% 
    bind_rows(., cesd_iyes_adj_mi_result)
  
  rm(cesd_iyes_adj_mi, cesd_iyes_adj_mi_result)
}

# metafor
cesd_iyes_adj_mi_tedu_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_mi_tedu_results, slab = country)


#### Life satisfaction ####
# lme4
satlife_iyes_adj_mi_tedu_results <- tibble()
for(i in c(1:17,19:23)){
  
  if(i==3){
    satlife_iyes_adj_mi <- lmer(
      satlife_stand ~ internet_yes*cwave + 
        age + male + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(lowedu == "tertiary"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    satlife_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      satlife_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    satlife_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        satlife_stand ~ internet_yes*cwave + 
          age + male + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lowedu == "tertiary"), control = lmerControl(optimizer = 'bobyqa'))
      })
    satlife_iyes_adj_mi_result <- lapply(seq_along(satlife_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  satlife_iyes_adj_mi_tedu_results <- satlife_iyes_adj_mi_tedu_results %>% 
    bind_rows(., satlife_iyes_adj_mi_result)
  
  rm(satlife_iyes_adj_mi, satlife_iyes_adj_mi_result)
}

# metafor
satlife_iyes_adj_mi_tedu_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_mi_tedu_results, slab = country)


#### Self-rated health ####
# lme4
shlt_iyes_adj_mi_tedu_results <- tibble()
for(i in c(1:17,19:23)){
  
  if(i==3){
    shlt_iyes_adj_mi <- lmer(
      shlt_stand ~ internet_yes*cwave + 
        age + male + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(lowedu == "tertiary"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    shlt_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      shlt_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    shlt_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        shlt_stand ~ internet_yes*cwave + 
          age + male + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lowedu == "tertiary"), control = lmerControl(optimizer = 'bobyqa'))
      })
    shlt_iyes_adj_mi_result <- lapply(seq_along(shlt_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  shlt_iyes_adj_mi_tedu_results <- shlt_iyes_adj_mi_tedu_results %>% 
    bind_rows(., shlt_iyes_adj_mi_result)
  
  rm(shlt_iyes_adj_mi, shlt_iyes_adj_mi_result)
}

# metafor
shlt_iyes_adj_mi_tedu_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_mi_tedu_results, slab = country)

toc() # 572.13 sec elapsed

```

### Meta analysis subgroup analysis

```{r}

#### CES-D ####
cesd_iyes_adj_mi_edu_results <- cesd_iyes_adj_mi_pedu_results %>%
  mutate(subgroup = "pedu") %>%
  bind_rows(., cesd_iyes_adj_mi_sedu_results %>% mutate(subgroup = "sedu")) %>%
  bind_rows(., cesd_iyes_adj_mi_tedu_results %>% mutate(subgroup = "tedu"))

cesd_iyes_adj_mi_edu_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = cesd_iyes_adj_mi_edu_results, slab = country)


#### Life satisfaction ####
satlife_iyes_adj_mi_edu_results <- satlife_iyes_adj_mi_pedu_results %>%
  mutate(subgroup = "pedu") %>%
  bind_rows(., satlife_iyes_adj_mi_sedu_results %>% mutate(subgroup = "sedu")) %>%
  bind_rows(., satlife_iyes_adj_mi_tedu_results %>% mutate(subgroup = "tedu"))

satlife_iyes_adj_mi_edu_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = satlife_iyes_adj_mi_edu_results, slab = country)


#### Self-reported health ####
shlt_iyes_adj_mi_edu_results <- shlt_iyes_adj_mi_pedu_results %>%
  mutate(subgroup = "pedu") %>%
  bind_rows(., shlt_iyes_adj_mi_sedu_results %>% mutate(subgroup = "sedu")) %>%
  bind_rows(., shlt_iyes_adj_mi_tedu_results %>% mutate(subgroup = "tedu"))

shlt_iyes_adj_mi_edu_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = shlt_iyes_adj_mi_edu_results, slab = country)

```

## By household wealth

### Low

```{r warning=FALSE}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

tic()
#### CES-D ####
# lme4
cesd_iyes_adj_mi_lwealth_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    cesd_iyes_adj_mi <- lmer(
      cesd_stand ~ internet_yes*cwave + 
        age + male + lowedu + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(lowwealth == 3), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    cesd_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      cesd_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    cesd_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        cesd_stand ~ internet_yes*cwave + 
          age + male + lowedu + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lowwealth == 3), control = lmerControl(optimizer = 'bobyqa'))
      })
    cesd_iyes_adj_mi_result <- lapply(seq_along(cesd_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  cesd_iyes_adj_mi_lwealth_results <- cesd_iyes_adj_mi_lwealth_results %>% 
    bind_rows(., cesd_iyes_adj_mi_result)
  
  rm(cesd_iyes_adj_mi, cesd_iyes_adj_mi_result)
}

# metafor
cesd_iyes_adj_mi_lwealth_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_mi_lwealth_results, slab = country)


#### Life satisfaction ####
# lme4
satlife_iyes_adj_mi_lwealth_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    satlife_iyes_adj_mi <- lmer(
      satlife_stand ~ internet_yes*cwave + 
        age + male + lowedu + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(lowwealth == 3), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    satlife_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      satlife_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    satlife_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        satlife_stand ~ internet_yes*cwave + 
          age + male + lowedu + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lowwealth == 3), control = lmerControl(optimizer = 'bobyqa'))
      })
    satlife_iyes_adj_mi_result <- lapply(seq_along(satlife_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  satlife_iyes_adj_mi_lwealth_results <- satlife_iyes_adj_mi_lwealth_results %>% 
    bind_rows(., satlife_iyes_adj_mi_result)
  
  rm(satlife_iyes_adj_mi, satlife_iyes_adj_mi_result)
}

# metafor
satlife_iyes_adj_mi_lwealth_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_mi_lwealth_results, slab = country)


#### Self-rated health ####
# lme4
shlt_iyes_adj_mi_lwealth_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    shlt_iyes_adj_mi <- lmer(
      shlt_stand ~ internet_yes*cwave + 
        age + male + lowedu + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(lowwealth == 3), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    shlt_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      shlt_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    shlt_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        shlt_stand ~ internet_yes*cwave + 
          age + male + lowedu + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lowwealth == 3), control = lmerControl(optimizer = 'bobyqa'))
      })
    shlt_iyes_adj_mi_result <- lapply(seq_along(shlt_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  shlt_iyes_adj_mi_lwealth_results <- shlt_iyes_adj_mi_lwealth_results %>% 
    bind_rows(., shlt_iyes_adj_mi_result)
  
  rm(shlt_iyes_adj_mi, shlt_iyes_adj_mi_result)
}

# metafor
shlt_iyes_adj_mi_lwealth_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_mi_lwealth_results, slab = country)

toc() # 781.29 sec elapsed

```

### Middle

```{r warning=FALSE}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

# Poland: all observations are weekly contacting with other people --> do not adjust contact in the model
table(subgroup_mi_iyes_merge[[1]] %>% filter(country_names == "Poland") %>% filter(lowwealth == 2) %>% pull(contact))

tic()
#### CES-D ####
# lme4
cesd_iyes_adj_mi_mwealth_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    cesd_iyes_adj_mi <- lmer(
      cesd_stand ~ internet_yes*cwave + 
        age + male + lowedu + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(lowwealth == 2), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    cesd_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      cesd_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else if(i==18){
    cesd_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        cesd_stand ~ internet_yes*cwave + 
          age + male + lowedu + lbrf + 
          nonmarried + hhres + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lowwealth == 2), control = lmerControl(optimizer = 'bobyqa'))
      })
    cesd_iyes_adj_mi_result <- lapply(seq_along(cesd_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }else{
    cesd_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        cesd_stand ~ internet_yes*cwave + 
          age + male + lowedu + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lowwealth == 2), control = lmerControl(optimizer = 'bobyqa'))
      })
    cesd_iyes_adj_mi_result <- lapply(seq_along(cesd_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  cesd_iyes_adj_mi_mwealth_results <- cesd_iyes_adj_mi_mwealth_results %>% 
    bind_rows(., cesd_iyes_adj_mi_result)
  
  rm(cesd_iyes_adj_mi, cesd_iyes_adj_mi_result)
}

# metafor
cesd_iyes_adj_mi_mwealth_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_mi_mwealth_results, slab = country)


#### Life satisfaction ####
# lme4
satlife_iyes_adj_mi_mwealth_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    satlife_iyes_adj_mi <- lmer(
      satlife_stand ~ internet_yes*cwave + 
        age + male + lowedu + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(lowwealth == 2), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    satlife_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      satlife_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else if(i==18){
    satlife_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        satlife_stand ~ internet_yes*cwave + 
          age + male + lowedu + lbrf + 
          nonmarried + hhres + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lowwealth == 2), control = lmerControl(optimizer = 'bobyqa'))
      })
    satlife_iyes_adj_mi_result <- lapply(seq_along(satlife_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }else{
    satlife_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        satlife_stand ~ internet_yes*cwave + 
          age + male + lowedu + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lowwealth == 2), control = lmerControl(optimizer = 'bobyqa'))
      })
    satlife_iyes_adj_mi_result <- lapply(seq_along(satlife_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  satlife_iyes_adj_mi_mwealth_results <- satlife_iyes_adj_mi_mwealth_results %>% 
    bind_rows(., satlife_iyes_adj_mi_result)
  
  rm(satlife_iyes_adj_mi, satlife_iyes_adj_mi_result)
}

# metafor
satlife_iyes_adj_mi_mwealth_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_mi_mwealth_results, slab = country)


#### Self-rated health
# lme4
shlt_iyes_adj_mi_mwealth_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    shlt_iyes_adj_mi <- lmer(
      shlt_stand ~ internet_yes*cwave + 
        age + male + lowedu + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(lowwealth == 2), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    shlt_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      shlt_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else if(i==18){
    shlt_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        shlt_stand ~ internet_yes*cwave + 
          age + male + lowedu + lbrf + 
          nonmarried + hhres + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lowwealth == 2), control = lmerControl(optimizer = 'bobyqa'))
      })
    shlt_iyes_adj_mi_result <- lapply(seq_along(shlt_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }else{
    shlt_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        shlt_stand ~ internet_yes*cwave + 
          age + male + lowedu + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lowwealth == 2), control = lmerControl(optimizer = 'bobyqa'))
      })
    shlt_iyes_adj_mi_result <- lapply(seq_along(shlt_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  shlt_iyes_adj_mi_mwealth_results <- shlt_iyes_adj_mi_mwealth_results %>% 
    bind_rows(., shlt_iyes_adj_mi_result)
  
  rm(shlt_iyes_adj_mi, shlt_iyes_adj_mi_result)
}

# metafor
shlt_iyes_adj_mi_mwealth_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_mi_mwealth_results, slab = country)

toc() # 794.86 sec elapsed

```

### High 

```{r warning=FALSE}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

# Poland: all observations are weekly contacting with other people --> do not adjust contact in the model
table(subgroup_mi_iyes_merge[[1]] %>% filter(country_names == "Poland") %>% filter(lowwealth == 1) %>% pull(contact))

tic()
#### CES-D ####
# lme4
cesd_iyes_adj_mi_hwealth_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    cesd_iyes_adj_mi <- lmer(
      cesd_stand ~ internet_yes*cwave + 
        age + male + lowedu + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(lowwealth == 1), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    cesd_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      cesd_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else if(i==18){
    cesd_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        cesd_stand ~ internet_yes*cwave + 
          age + male + lowedu + lbrf + 
          nonmarried + hhres + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lowwealth == 1), control = lmerControl(optimizer = 'bobyqa'))
      })
    cesd_iyes_adj_mi_result <- lapply(seq_along(cesd_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }else{
    cesd_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        cesd_stand ~ internet_yes*cwave + 
          age + male + lowedu + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lowwealth == 1), control = lmerControl(optimizer = 'bobyqa'))
      })
    cesd_iyes_adj_mi_result <- lapply(seq_along(cesd_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  cesd_iyes_adj_mi_hwealth_results <- cesd_iyes_adj_mi_hwealth_results %>% 
    bind_rows(., cesd_iyes_adj_mi_result)
  
  rm(cesd_iyes_adj_mi, cesd_iyes_adj_mi_result)
}

# metafor
cesd_iyes_adj_mi_hwealth_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_mi_hwealth_results, slab = country)


#### Life satisfaction ####
# lme4
satlife_iyes_adj_mi_hwealth_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    satlife_iyes_adj_mi <- lmer(
      satlife_stand ~ internet_yes*cwave + 
        age + male + lowedu + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(lowwealth == 1), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    satlife_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      satlife_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else if(i==18){
    satlife_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        satlife_stand ~ internet_yes*cwave + 
          age + male + lowedu + lbrf + 
          nonmarried + hhres + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lowwealth == 1), control = lmerControl(optimizer = 'bobyqa'))
      })
    satlife_iyes_adj_mi_result <- lapply(seq_along(satlife_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    satlife_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        satlife_stand ~ internet_yes*cwave + 
          age + male + lowedu + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lowwealth == 1), control = lmerControl(optimizer = 'bobyqa'))
      })
    satlife_iyes_adj_mi_result <- lapply(seq_along(satlife_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  satlife_iyes_adj_mi_hwealth_results <- satlife_iyes_adj_mi_hwealth_results %>% 
    bind_rows(., satlife_iyes_adj_mi_result)
  
  rm(satlife_iyes_adj_mi, satlife_iyes_adj_mi_result)
}

# metafor
satlife_iyes_adj_mi_hwealth_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_mi_hwealth_results, slab = country)


#### Self-rated health ####
# lme4
shlt_iyes_adj_mi_hwealth_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    shlt_iyes_adj_mi <- lmer(
      shlt_stand ~ internet_yes*cwave + 
        age + male + lowedu + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(lowwealth == 1), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    shlt_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      shlt_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else if(i==18){
    shlt_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        shlt_stand ~ internet_yes*cwave + 
          age + male + lowedu + lbrf + 
          nonmarried + hhres + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lowwealth == 1), control = lmerControl(optimizer = 'bobyqa'))
      })
    shlt_iyes_adj_mi_result <- lapply(seq_along(shlt_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    shlt_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        shlt_stand ~ internet_yes*cwave + 
          age + male + lowedu + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lowwealth == 1), control = lmerControl(optimizer = 'bobyqa'))
      })
    shlt_iyes_adj_mi_result <- lapply(seq_along(shlt_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  shlt_iyes_adj_mi_hwealth_results <- shlt_iyes_adj_mi_hwealth_results %>% 
    bind_rows(., shlt_iyes_adj_mi_result)
  
  rm(shlt_iyes_adj_mi, shlt_iyes_adj_mi_result)
}

# metafor
shlt_iyes_adj_mi_hwealth_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_mi_hwealth_results, slab = country)

toc() # 801.98 sec elapsed

```

### Meta analysis subgroup analysis

```{r}

#### CES-D ####
cesd_iyes_adj_mi_wealth_results <- cesd_iyes_adj_mi_lwealth_results %>%
  mutate(subgroup = "lwealth") %>%
  bind_rows(., cesd_iyes_adj_mi_mwealth_results %>% mutate(subgroup = "mwealth")) %>%
  bind_rows(., cesd_iyes_adj_mi_hwealth_results %>% mutate(subgroup = "hwealth"))

cesd_iyes_adj_mi_wealth_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = cesd_iyes_adj_mi_wealth_results, slab = country)


#### Life satisfaction ####
satlife_iyes_adj_mi_wealth_results <- satlife_iyes_adj_mi_lwealth_results %>%
  mutate(subgroup = "lwealth") %>%
  bind_rows(., satlife_iyes_adj_mi_mwealth_results %>% mutate(subgroup = "mwealth")) %>%
  bind_rows(., satlife_iyes_adj_mi_hwealth_results %>% mutate(subgroup = "hwealth"))

satlife_iyes_adj_mi_wealth_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = satlife_iyes_adj_mi_wealth_results, slab = country)


#### Self-reported health ####
shlt_iyes_adj_mi_wealth_results <- shlt_iyes_adj_mi_lwealth_results %>%
  mutate(subgroup = "lwealth") %>%
  bind_rows(., shlt_iyes_adj_mi_mwealth_results %>% mutate(subgroup = "mwealth")) %>%
  bind_rows(., shlt_iyes_adj_mi_hwealth_results %>% mutate(subgroup = "hwealth"))

shlt_iyes_adj_mi_wealth_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = shlt_iyes_adj_mi_wealth_results, slab = country)

```

## By labor force status

### Working

```{r warning=FALSE}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

# Poland: all observations are weekly contacting with other people --> do not adjust contact in the model
table(subgroup_mi_iyes_merge[[1]] %>% filter(country_names == "Poland") %>% filter(lbrf == "employed") %>% pull(contact))

tic()
#### CES-D ####
# lme4
cesd_iyes_adj_mi_work_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    cesd_iyes_adj_mi <- lmer(
      cesd_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(lbrf == "employed"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    cesd_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      cesd_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else if(i==18){
    cesd_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        cesd_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + 
          nonmarried + hhres + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lbrf == "employed"), control = lmerControl(optimizer = 'bobyqa'))
      })
    cesd_iyes_adj_mi_result <- lapply(seq_along(cesd_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    cesd_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        cesd_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lbrf == "employed"), control = lmerControl(optimizer = 'bobyqa'))
      })
    cesd_iyes_adj_mi_result <- lapply(seq_along(cesd_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  cesd_iyes_adj_mi_work_results <- cesd_iyes_adj_mi_work_results %>% 
    bind_rows(., cesd_iyes_adj_mi_result)
  
  rm(cesd_iyes_adj_mi, cesd_iyes_adj_mi_result)
}

# metafor
cesd_iyes_adj_mi_work_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_mi_work_results, slab = country)


#### Life satisfaction ####
# lme4
satlife_iyes_adj_mi_work_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    satlife_iyes_adj_mi <- lmer(
      satlife_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(lbrf == "employed"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    satlife_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      satlife_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else if(i==18){
    satlife_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        satlife_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + 
          nonmarried + hhres + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lbrf == "employed"), control = lmerControl(optimizer = 'bobyqa'))
      })
    satlife_iyes_adj_mi_result <- lapply(seq_along(satlife_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    satlife_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        satlife_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lbrf == "employed"), control = lmerControl(optimizer = 'bobyqa'))
      })
    satlife_iyes_adj_mi_result <- lapply(seq_along(satlife_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  satlife_iyes_adj_mi_work_results <- satlife_iyes_adj_mi_work_results %>% 
    bind_rows(., satlife_iyes_adj_mi_result)
  
  rm(satlife_iyes_adj_mi, satlife_iyes_adj_mi_result)
}

# metafor
satlife_iyes_adj_mi_work_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_mi_work_results, slab = country)


#### Self-rated health ####
# lme4
shlt_iyes_adj_mi_work_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    shlt_iyes_adj_mi <- lmer(
      shlt_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(lbrf == "employed"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    shlt_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      shlt_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else if(i==18){
    shlt_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        shlt_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + 
          nonmarried + hhres + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lbrf == "employed"), control = lmerControl(optimizer = 'bobyqa'))
      })
    shlt_iyes_adj_mi_result <- lapply(seq_along(shlt_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    shlt_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        shlt_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lbrf == "employed"), control = lmerControl(optimizer = 'bobyqa'))
      })
    shlt_iyes_adj_mi_result <- lapply(seq_along(shlt_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  shlt_iyes_adj_mi_work_results <- shlt_iyes_adj_mi_work_results %>% 
    bind_rows(., shlt_iyes_adj_mi_result)
  
  rm(shlt_iyes_adj_mi, shlt_iyes_adj_mi_result)
}

# metafor
shlt_iyes_adj_mi_work_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_mi_work_results, slab = country)

toc() # 910.53 sec elapsed

```

### Retired

```{r warning=FALSE}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

tic()
#### CES-D ####
# lme4
cesd_iyes_adj_mi_retired_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    cesd_iyes_adj_mi <- lmer(
      cesd_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(lbrf == "retired"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    cesd_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      cesd_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    cesd_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        cesd_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lbrf == "retired"), control = lmerControl(optimizer = 'bobyqa'))
      })
    cesd_iyes_adj_mi_result <- lapply(seq_along(cesd_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  cesd_iyes_adj_mi_retired_results <- cesd_iyes_adj_mi_retired_results %>% 
    bind_rows(., cesd_iyes_adj_mi_result)
  
  rm(cesd_iyes_adj_mi, cesd_iyes_adj_mi_result)
}

# metafor
cesd_iyes_adj_mi_retired_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_mi_retired_results, slab = country)


#### Life satisfaction ####
# lme4
satlife_iyes_adj_mi_retired_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    satlife_iyes_adj_mi <- lmer(
      satlife_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(lbrf == "retired"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    satlife_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      satlife_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    satlife_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        satlife_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lbrf == "retired"), control = lmerControl(optimizer = 'bobyqa'))
      })
    satlife_iyes_adj_mi_result <- lapply(seq_along(satlife_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  satlife_iyes_adj_mi_retired_results <- satlife_iyes_adj_mi_retired_results %>% 
    bind_rows(., satlife_iyes_adj_mi_result)
  
  rm(satlife_iyes_adj_mi, satlife_iyes_adj_mi_result)
}

# metafor
satlife_iyes_adj_mi_retired_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_mi_retired_results, slab = country)


#### Self-rated health ####
# lme4
shlt_iyes_adj_mi_retired_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    shlt_iyes_adj_mi <- lmer(
      shlt_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(lbrf == "retired"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    shlt_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      shlt_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    shlt_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        shlt_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lbrf == "retired"), control = lmerControl(optimizer = 'bobyqa'))
      })
    shlt_iyes_adj_mi_result <- lapply(seq_along(shlt_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  shlt_iyes_adj_mi_retired_results <- shlt_iyes_adj_mi_retired_results %>% 
    bind_rows(., shlt_iyes_adj_mi_result)
  
  rm(shlt_iyes_adj_mi, shlt_iyes_adj_mi_result)
}

# metafor
shlt_iyes_adj_mi_retired_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_mi_retired_results, slab = country)

toc() # 1048.24 sec elapsed

```

### Others

```{r warning=FALSE}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

# China: no people who were not working use internet
# See Complete cases

tic()
#### CES-D ####
# lme4
cesd_iyes_adj_mi_others_results <- tibble()
for(i in c(1:3,5:23)){
  
  if(i==3){
    cesd_iyes_adj_mi <- lmer(
      cesd_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(lbrf == "others"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    cesd_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      cesd_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    cesd_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        cesd_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lbrf == "others"), control = lmerControl(optimizer = 'bobyqa'))
      })
    cesd_iyes_adj_mi_result <- lapply(seq_along(cesd_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  cesd_iyes_adj_mi_others_results <- cesd_iyes_adj_mi_others_results %>% 
    bind_rows(., cesd_iyes_adj_mi_result)
  
  rm(cesd_iyes_adj_mi, cesd_iyes_adj_mi_result)
}

# metafor
cesd_iyes_adj_mi_others_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_mi_others_results, slab = country)


#### Life satisfaction ####
# lme4
satlife_iyes_adj_mi_others_results <- tibble()
for(i in c(1:3,5:23)){
  
  if(i==3){
    satlife_iyes_adj_mi <- lmer(
      satlife_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(lbrf == "others"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    satlife_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      satlife_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    satlife_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        satlife_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lbrf == "others"), control = lmerControl(optimizer = 'bobyqa'))
      })
    satlife_iyes_adj_mi_result <- lapply(seq_along(satlife_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  satlife_iyes_adj_mi_others_results <- satlife_iyes_adj_mi_others_results %>% 
    bind_rows(., satlife_iyes_adj_mi_result)
  
  rm(satlife_iyes_adj_mi, satlife_iyes_adj_mi_result)
}

# metafor
satlife_iyes_adj_mi_others_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_mi_others_results, slab = country)


#### Self-rated health ####
# lme4
shlt_iyes_adj_mi_others_results <- tibble()
for(i in c(1:3,5:23)){
  
  if(i==3){
    shlt_iyes_adj_mi <- lmer(
      shlt_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(lbrf == "others"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    shlt_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      shlt_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    shlt_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        shlt_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(lbrf == "others"), control = lmerControl(optimizer = 'bobyqa'))
      })
    shlt_iyes_adj_mi_result <- lapply(seq_along(shlt_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  shlt_iyes_adj_mi_others_results <- shlt_iyes_adj_mi_others_results %>% 
    bind_rows(., shlt_iyes_adj_mi_result)
  
  rm(shlt_iyes_adj_mi, shlt_iyes_adj_mi_result)
}

# metafor
shlt_iyes_adj_mi_others_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_mi_others_results, slab = country)

toc() # 572.52 sec elapsed

```

### Meta analysis subgroup analysis

```{r}

#### CES-D ####
cesd_iyes_adj_mi_lbrf_results <- cesd_iyes_adj_mi_work_results %>%
  mutate(subgroup = "work") %>%
  bind_rows(., cesd_iyes_adj_mi_retired_results %>% mutate(subgroup = "retired")) %>%
  bind_rows(., cesd_iyes_adj_mi_others_results %>% mutate(subgroup = "others"))

cesd_iyes_adj_mi_lbrf_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = cesd_iyes_adj_mi_lbrf_results, slab = country)


#### Life satisfaction ####
satlife_iyes_adj_mi_lbrf_results <- satlife_iyes_adj_mi_work_results %>%
  mutate(subgroup = "work") %>%
  bind_rows(., satlife_iyes_adj_mi_retired_results %>% mutate(subgroup = "retired")) %>%
  bind_rows(., satlife_iyes_adj_mi_others_results %>% mutate(subgroup = "others"))

satlife_iyes_adj_mi_lbrf_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = satlife_iyes_adj_mi_lbrf_results, slab = country)


#### Self-reported health ####
shlt_iyes_adj_mi_lbrf_results <- shlt_iyes_adj_mi_work_results %>%
  mutate(subgroup = "work") %>%
  bind_rows(., shlt_iyes_adj_mi_retired_results %>% mutate(subgroup = "retired")) %>%
  bind_rows(., shlt_iyes_adj_mi_others_results %>% mutate(subgroup = "others"))

shlt_iyes_adj_mi_lbrf_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = shlt_iyes_adj_mi_lbrf_results, slab = country)

```

## By current smoking 

### Current smoking

```{r warning=FALSE}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

tic()
#### CES-D ####
# lme4
cesd_iyes_adj_mi_smoke_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    cesd_iyes_adj_mi <- lmer(
      cesd_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(smoken == "yes"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    cesd_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      cesd_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    cesd_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        cesd_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(smoken == "yes"), control = lmerControl(optimizer = 'bobyqa'))
      })
    cesd_iyes_adj_mi_result <- lapply(seq_along(cesd_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  cesd_iyes_adj_mi_smoke_results <- cesd_iyes_adj_mi_smoke_results %>% 
    bind_rows(., cesd_iyes_adj_mi_result)
  
  rm(cesd_iyes_adj_mi, cesd_iyes_adj_mi_result)
}

# metafor
cesd_iyes_adj_mi_smoke_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_mi_smoke_results, slab = country)


#### Life satisfaction ####
# lme4
satlife_iyes_adj_mi_smoke_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    satlife_iyes_adj_mi <- lmer(
      satlife_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(smoken == "yes"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    satlife_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      satlife_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    satlife_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        satlife_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(smoken == "yes"), control = lmerControl(optimizer = 'bobyqa'))
      })
    satlife_iyes_adj_mi_result <- lapply(seq_along(satlife_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  satlife_iyes_adj_mi_smoke_results <- satlife_iyes_adj_mi_smoke_results %>% 
    bind_rows(., satlife_iyes_adj_mi_result)
  
  rm(satlife_iyes_adj_mi, satlife_iyes_adj_mi_result)
}

# metafor
satlife_iyes_adj_mi_smoke_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_mi_smoke_results, slab = country)


#### Self-rated health ####
# lme4
shlt_iyes_adj_mi_smoke_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    shlt_iyes_adj_mi <- lmer(
      shlt_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(smoken == "yes"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    shlt_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      shlt_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    shlt_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        shlt_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(smoken == "yes"), control = lmerControl(optimizer = 'bobyqa'))
      })
    shlt_iyes_adj_mi_result <- lapply(seq_along(shlt_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  shlt_iyes_adj_mi_smoke_results <- shlt_iyes_adj_mi_smoke_results %>% 
    bind_rows(., shlt_iyes_adj_mi_result)
  
  rm(shlt_iyes_adj_mi, shlt_iyes_adj_mi_result)
}

# metafor
shlt_iyes_adj_mi_smoke_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_mi_smoke_results, slab = country)

toc() # 515.6 sec elapsed

```

### No smoking

```{r warning=FALSE}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

tic()
#### CES-D ####
# lme4
cesd_iyes_adj_mi_nosmoke_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    cesd_iyes_adj_mi <- lmer(
      cesd_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(smoken == "no"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    cesd_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      cesd_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    cesd_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        cesd_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(smoken == "no"), control = lmerControl(optimizer = 'bobyqa'))
      })
    cesd_iyes_adj_mi_result <- lapply(seq_along(cesd_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  cesd_iyes_adj_mi_nosmoke_results <- cesd_iyes_adj_mi_nosmoke_results %>% 
    bind_rows(., cesd_iyes_adj_mi_result)
  
  rm(cesd_iyes_adj_mi, cesd_iyes_adj_mi_result)
}

# metafor
cesd_iyes_adj_mi_nosmoke_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_mi_nosmoke_results, slab = country)


#### Life satisfaction ####
# lme4
satlife_iyes_adj_mi_nosmoke_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    satlife_iyes_adj_mi <- lmer(
      satlife_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(smoken == "no"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    satlife_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      satlife_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    satlife_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        satlife_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(smoken == "no"), control = lmerControl(optimizer = 'bobyqa'))
      })
    satlife_iyes_adj_mi_result <- lapply(seq_along(satlife_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  satlife_iyes_adj_mi_nosmoke_results <- satlife_iyes_adj_mi_nosmoke_results %>% 
    bind_rows(., satlife_iyes_adj_mi_result)
  
  rm(satlife_iyes_adj_mi, satlife_iyes_adj_mi_result)
}

# metafor
satlife_iyes_adj_mi_nosmoke_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_mi_nosmoke_results, slab = country)


#### Self-rated health ####
# lme4
shlt_iyes_adj_mi_nosmoke_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    shlt_iyes_adj_mi <- lmer(
      shlt_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(smoken == "no"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    shlt_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      shlt_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    shlt_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        shlt_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(smoken == "no"), control = lmerControl(optimizer = 'bobyqa'))
      })
    shlt_iyes_adj_mi_result <- lapply(seq_along(shlt_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  shlt_iyes_adj_mi_nosmoke_results <- shlt_iyes_adj_mi_nosmoke_results %>% 
    bind_rows(., shlt_iyes_adj_mi_result)
  
  rm(shlt_iyes_adj_mi, shlt_iyes_adj_mi_result)
}

# metafor
shlt_iyes_adj_mi_nosmoke_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_mi_nosmoke_results, slab = country)

toc() # 2350.95 sec elapsed

```

### Meta analysis subgroup analysis

```{r}

#### CES-D ####
cesd_iyes_adj_mi_smokeall_results <- cesd_iyes_adj_mi_smoke_results %>%
  mutate(subgroup = "smoke") %>%
  bind_rows(., cesd_iyes_adj_mi_nosmoke_results %>% mutate(subgroup = "nosmoke"))

cesd_iyes_adj_mi_smokeall_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = cesd_iyes_adj_mi_smokeall_results, slab = country)


#### Life satisfaction ####
satlife_iyes_adj_mi_smokeall_results <- satlife_iyes_adj_mi_smoke_results %>%
  mutate(subgroup = "smoke") %>%
  bind_rows(., satlife_iyes_adj_mi_nosmoke_results %>% mutate(subgroup = "nosmoke"))

satlife_iyes_adj_mi_smokeall_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = satlife_iyes_adj_mi_smokeall_results, slab = country)


#### Self-reported health ####
shlt_iyes_adj_mi_smokeall_results <- shlt_iyes_adj_mi_smoke_results %>%
  mutate(subgroup = "smoke") %>%
  bind_rows(., shlt_iyes_adj_mi_nosmoke_results %>% mutate(subgroup = "nosmoke"))

shlt_iyes_adj_mi_smokeall_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = shlt_iyes_adj_mi_smokeall_results, slab = country)

```

## By alcohol consumption

### Weekly alcohol use

```{r warning=FALSE}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

tic()
#### CES-D ####
# lme4
cesd_iyes_adj_mi_drink_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    cesd_iyes_adj_mi <- lmer(
      cesd_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(weekdrink == "yes"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    cesd_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      cesd_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    cesd_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        cesd_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(weekdrink == "yes"), control = lmerControl(optimizer = 'bobyqa'))
      })
    cesd_iyes_adj_mi_result <- lapply(seq_along(cesd_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  cesd_iyes_adj_mi_drink_results <- cesd_iyes_adj_mi_drink_results %>% 
    bind_rows(., cesd_iyes_adj_mi_result)
  
  rm(cesd_iyes_adj_mi, cesd_iyes_adj_mi_result)
}

# metafor
cesd_iyes_adj_mi_drink_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_mi_drink_results, slab = country)


#### Life satisfaction ####
# lme4
satlife_iyes_adj_mi_drink_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    satlife_iyes_adj_mi <- lmer(
      satlife_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(weekdrink == "yes"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    satlife_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      satlife_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    satlife_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        satlife_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(weekdrink == "yes"), control = lmerControl(optimizer = 'bobyqa'))
      })
    satlife_iyes_adj_mi_result <- lapply(seq_along(satlife_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  satlife_iyes_adj_mi_drink_results <- satlife_iyes_adj_mi_drink_results %>% 
    bind_rows(., satlife_iyes_adj_mi_result)
  
  rm(satlife_iyes_adj_mi, satlife_iyes_adj_mi_result)
}

# metafor
satlife_iyes_adj_mi_drink_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_mi_drink_results, slab = country)


#### Self-rated health ####
# lme4
shlt_iyes_adj_mi_drink_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    shlt_iyes_adj_mi <- lmer(
      shlt_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(weekdrink == "yes"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    shlt_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      shlt_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    shlt_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        shlt_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(weekdrink == "yes"), control = lmerControl(optimizer = 'bobyqa'))
      })
    shlt_iyes_adj_mi_result <- lapply(seq_along(shlt_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  shlt_iyes_adj_mi_drink_results <- shlt_iyes_adj_mi_drink_results %>% 
    bind_rows(., shlt_iyes_adj_mi_result)
  
  rm(shlt_iyes_adj_mi, shlt_iyes_adj_mi_result)
}

# metafor
shlt_iyes_adj_mi_drink_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_mi_drink_results, slab = country)

toc() # 960.03 sec elapsed

```

### Less than weekly alcohol use

```{r warning=FALSE}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

tic()
#### CES-D ####
# lme4
cesd_iyes_adj_mi_nodrink_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    cesd_iyes_adj_mi <- lmer(
      cesd_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(weekdrink == "no"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    cesd_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      cesd_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    cesd_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        cesd_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(weekdrink == "no"), control = lmerControl(optimizer = 'bobyqa'))
      })
    cesd_iyes_adj_mi_result <- lapply(seq_along(cesd_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  cesd_iyes_adj_mi_nodrink_results <- cesd_iyes_adj_mi_nodrink_results %>% 
    bind_rows(., cesd_iyes_adj_mi_result)
  
  rm(cesd_iyes_adj_mi, cesd_iyes_adj_mi_result)
}

# metafor
cesd_iyes_adj_mi_nodrink_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_mi_nodrink_results, slab = country)


#### Life satisfaction ####
# lme4
satlife_iyes_adj_mi_nodrink_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    satlife_iyes_adj_mi <- lmer(
      satlife_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(weekdrink == "no"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    satlife_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      satlife_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    satlife_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        satlife_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(weekdrink == "no"), control = lmerControl(optimizer = 'bobyqa'))
      })
    satlife_iyes_adj_mi_result <- lapply(seq_along(satlife_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  satlife_iyes_adj_mi_nodrink_results <- satlife_iyes_adj_mi_nodrink_results %>% 
    bind_rows(., satlife_iyes_adj_mi_result)
  
  rm(satlife_iyes_adj_mi, satlife_iyes_adj_mi_result)
}

# metafor
satlife_iyes_adj_mi_nodrink_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_mi_nodrink_results, slab = country)


#### Self-rated health ####
# lme4
shlt_iyes_adj_mi_nodrink_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    shlt_iyes_adj_mi <- lmer(
      shlt_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(weekdrink == "no"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    shlt_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      shlt_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    shlt_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        shlt_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(weekdrink == "no"), control = lmerControl(optimizer = 'bobyqa'))
      })
    shlt_iyes_adj_mi_result <- lapply(seq_along(shlt_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  shlt_iyes_adj_mi_nodrink_results <- shlt_iyes_adj_mi_nodrink_results %>% 
    bind_rows(., shlt_iyes_adj_mi_result)
  
  rm(shlt_iyes_adj_mi, shlt_iyes_adj_mi_result)
}

# metafor
shlt_iyes_adj_mi_nodrink_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_mi_nodrink_results, slab = country)

toc() # 1546.73 sec elapsed

```

### Meta analysis subgroup analysis

```{r}

#### CES-D ####
cesd_iyes_adj_mi_wdrink_results <- cesd_iyes_adj_mi_drink_results %>%
  mutate(subgroup = "drink") %>%
  bind_rows(., cesd_iyes_adj_mi_nodrink_results %>% mutate(subgroup = "nodrink"))

cesd_iyes_adj_mi_wdrink_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = cesd_iyes_adj_mi_wdrink_results, slab = country)


#### Life satisfaction ####
satlife_iyes_adj_mi_wdrink_results <- satlife_iyes_adj_mi_drink_results %>%
  mutate(subgroup = "drink") %>%
  bind_rows(., satlife_iyes_adj_mi_nodrink_results %>% mutate(subgroup = "nodrink"))

satlife_iyes_adj_mi_wdrink_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = satlife_iyes_adj_mi_wdrink_results, slab = country)


#### Self-reported health ####
shlt_iyes_adj_mi_wdrink_results <- shlt_iyes_adj_mi_drink_results %>%
  mutate(subgroup = "drink") %>%
  bind_rows(., shlt_iyes_adj_mi_nodrink_results %>% mutate(subgroup = "nodrink"))

shlt_iyes_adj_mi_wdrink_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = shlt_iyes_adj_mi_wdrink_results, slab = country)

```


## By physical activity

### Physical inactivity

```{r warning=FALSE}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

# Poland: too few observations to fit the model
nrow(subgroup_mi_iyes_merge[[1]] %>% filter(country_names == "Poland") %>% filter(phyinact == "yes")) # 16

tic()
#### CES-D ####
# lme4
cesd_iyes_adj_mi_phyinact_results <- tibble()
for(i in c(1:17,19:23)){
  
  if(i==3){
    cesd_iyes_adj_mi <- lmer(
      cesd_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(phyinact == "yes"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    cesd_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      cesd_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    cesd_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        cesd_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(phyinact == "yes"), control = lmerControl(optimizer = 'bobyqa'))
      })
    cesd_iyes_adj_mi_result <- lapply(seq_along(cesd_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  cesd_iyes_adj_mi_phyinact_results <- cesd_iyes_adj_mi_phyinact_results %>% 
    bind_rows(., cesd_iyes_adj_mi_result)
  
  rm(cesd_iyes_adj_mi, cesd_iyes_adj_mi_result)
}

# metafor
cesd_iyes_adj_mi_phyinact_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_mi_phyinact_results, slab = country)


#### Life satisfaction ####
# lme4
satlife_iyes_adj_mi_phyinact_results <- tibble()
for(i in c(1:17,19:23)){
  
  if(i==3){
    satlife_iyes_adj_mi <- lmer(
      satlife_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(phyinact == "yes"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    satlife_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      satlife_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    satlife_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        satlife_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(phyinact == "yes"), control = lmerControl(optimizer = 'bobyqa'))
      })
    satlife_iyes_adj_mi_result <- lapply(seq_along(satlife_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  satlife_iyes_adj_mi_phyinact_results <- satlife_iyes_adj_mi_phyinact_results %>% 
    bind_rows(., satlife_iyes_adj_mi_result)
  
  rm(satlife_iyes_adj_mi, satlife_iyes_adj_mi_result)
}

# metafor
satlife_iyes_adj_mi_phyinact_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_mi_phyinact_results, slab = country)


#### Self-rated health ####
# lme4
shlt_iyes_adj_mi_phyinact_results <- tibble()
for(i in c(1:17,19:23)){
  
  if(i==3){
    shlt_iyes_adj_mi <- lmer(
      shlt_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(phyinact == "yes"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    shlt_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      shlt_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    shlt_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        shlt_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(phyinact == "yes"), control = lmerControl(optimizer = 'bobyqa'))
      })
    shlt_iyes_adj_mi_result <- lapply(seq_along(shlt_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  shlt_iyes_adj_mi_phyinact_results <- shlt_iyes_adj_mi_phyinact_results %>% 
    bind_rows(., shlt_iyes_adj_mi_result)
  
  rm(shlt_iyes_adj_mi, shlt_iyes_adj_mi_result)
}

# metafor
shlt_iyes_adj_mi_phyinact_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_mi_phyinact_results, slab = country)

toc() # 634.89 sec elapsed

```


### Physical activity

```{r warning=FALSE}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

tic()
#### CES-D ####
# lme4
cesd_iyes_adj_mi_phyact_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    cesd_iyes_adj_mi <- lmer(
      cesd_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(phyinact == "no"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    cesd_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      cesd_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    cesd_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        cesd_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(phyinact == "no"), control = lmerControl(optimizer = 'bobyqa'))
      })
    cesd_iyes_adj_mi_result <- lapply(seq_along(cesd_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  cesd_iyes_adj_mi_phyact_results <- cesd_iyes_adj_mi_phyact_results %>% 
    bind_rows(., cesd_iyes_adj_mi_result)
  
  rm(cesd_iyes_adj_mi, cesd_iyes_adj_mi_result)
}

# metafor
cesd_iyes_adj_mi_phyact_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_mi_phyact_results, slab = country)


#### Life satisfaction ####
# lme4
satlife_iyes_adj_mi_phyact_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    satlife_iyes_adj_mi <- lmer(
      satlife_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(phyinact == "no"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    satlife_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      satlife_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    satlife_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        satlife_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(phyinact == "no"), control = lmerControl(optimizer = 'bobyqa'))
      })
    satlife_iyes_adj_mi_result <- lapply(seq_along(satlife_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  satlife_iyes_adj_mi_phyact_results <- satlife_iyes_adj_mi_phyact_results %>% 
    bind_rows(., satlife_iyes_adj_mi_result)
  
  rm(satlife_iyes_adj_mi, satlife_iyes_adj_mi_result)
}

# metafor
satlife_iyes_adj_mi_phyact_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_mi_phyact_results, slab = country)


#### Self-rated health ####
# lme4
shlt_iyes_adj_mi_phyact_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    shlt_iyes_adj_mi <- lmer(
      shlt_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(phyinact == "no"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    shlt_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      shlt_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    shlt_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        shlt_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(phyinact == "no"), control = lmerControl(optimizer = 'bobyqa'))
      })
    shlt_iyes_adj_mi_result <- lapply(seq_along(shlt_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  shlt_iyes_adj_mi_phyact_results <- shlt_iyes_adj_mi_phyact_results %>% 
    bind_rows(., shlt_iyes_adj_mi_result)
  
  rm(shlt_iyes_adj_mi, shlt_iyes_adj_mi_result)
}

# metafor
shlt_iyes_adj_mi_phyact_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_mi_phyact_results, slab = country)

toc() # 2220.03 sec elapsed

```

### Meta analysis subgroup analysis

```{r}

#### CES-D ####
cesd_iyes_adj_mi_pact_results <- cesd_iyes_adj_mi_phyinact_results %>%
  mutate(subgroup = "phyinact") %>%
  bind_rows(., cesd_iyes_adj_mi_phyact_results %>% mutate(subgroup = "phyact"))

cesd_iyes_adj_mi_pact_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = cesd_iyes_adj_mi_pact_results, slab = country) # Significant


#### Life satisfaction ####
satlife_iyes_adj_mi_pact_results <- satlife_iyes_adj_mi_phyinact_results %>%
  mutate(subgroup = "phyinact") %>%
  bind_rows(., satlife_iyes_adj_mi_phyact_results %>% mutate(subgroup = "phyact"))

satlife_iyes_adj_mi_pact_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = satlife_iyes_adj_mi_pact_results, slab = country)


#### Self-reported health ####
shlt_iyes_adj_mi_pact_results <- shlt_iyes_adj_mi_phyinact_results %>%
  mutate(subgroup = "phyinact") %>%
  bind_rows(., shlt_iyes_adj_mi_phyact_results %>% mutate(subgroup = "phyact"))

shlt_iyes_adj_mi_pact_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = shlt_iyes_adj_mi_pact_results, slab = country)

```

## By ADL disability

### ADL disability

```{r warning=FALSE}


iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

# Poland: too few observations to fit the model
nrow(subgroup_mi_iyes_merge[[1]] %>% filter(country_names == "Poland") %>% filter(adl_any == "yes")) # 27

tic()
#### CES-D ####
# lme4
cesd_iyes_adj_mi_adl_results <- tibble()
for(i in c(1:17,19:23)){
  
  if(i==3){
    cesd_iyes_adj_mi <- lmer(
      cesd_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(adl_any == "yes"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    cesd_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      cesd_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    cesd_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        cesd_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(adl_any == "yes"), control = lmerControl(optimizer = 'bobyqa'))
      })
    cesd_iyes_adj_mi_result <- lapply(seq_along(cesd_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  cesd_iyes_adj_mi_adl_results <- cesd_iyes_adj_mi_adl_results %>% 
    bind_rows(., cesd_iyes_adj_mi_result)
  
  rm(cesd_iyes_adj_mi, cesd_iyes_adj_mi_result)
}

# metafor
cesd_iyes_adj_mi_adl_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_mi_adl_results, slab = country)


#### Life satisfaction ####
# lme4
satlife_iyes_adj_mi_adl_results <- tibble()
for(i in c(1:17,19:23)){
  
  if(i==3){
    satlife_iyes_adj_mi <- lmer(
      satlife_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(adl_any == "yes"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    satlife_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      satlife_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    satlife_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        satlife_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(adl_any == "yes"), control = lmerControl(optimizer = 'bobyqa'))
      })
    satlife_iyes_adj_mi_result <- lapply(seq_along(satlife_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  satlife_iyes_adj_mi_adl_results <- satlife_iyes_adj_mi_adl_results %>% 
    bind_rows(., satlife_iyes_adj_mi_result)
  
  rm(satlife_iyes_adj_mi, satlife_iyes_adj_mi_result)
}

# metafor
satlife_iyes_adj_mi_adl_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_mi_adl_results, slab = country)


#### Self-rated health ####
# lme4
shlt_iyes_adj_mi_adl_results <- tibble()
for(i in c(1:17,19:23)){
  
  if(i==3){
    shlt_iyes_adj_mi <- lmer(
      shlt_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(adl_any == "yes"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    shlt_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      shlt_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    shlt_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        shlt_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(adl_any == "yes"), control = lmerControl(optimizer = 'bobyqa'))
      })
    shlt_iyes_adj_mi_result <- lapply(seq_along(shlt_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  shlt_iyes_adj_mi_adl_results <- shlt_iyes_adj_mi_adl_results %>% 
    bind_rows(., shlt_iyes_adj_mi_result)
  
  rm(shlt_iyes_adj_mi, shlt_iyes_adj_mi_result)
}

# metafor
shlt_iyes_adj_mi_adl_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_mi_adl_results, slab = country)

toc() # 441.8 sec elapsed

```

### No ADL limitation

```{r warning=FALSE}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

tic()
#### CES-D ####
# lme4
cesd_iyes_adj_mi_noadl_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    cesd_iyes_adj_mi <- lmer(
      cesd_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(adl_any == "no"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    cesd_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      cesd_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    cesd_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        cesd_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(adl_any == "no"), control = lmerControl(optimizer = 'bobyqa'))
      })
    cesd_iyes_adj_mi_result <- lapply(seq_along(cesd_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  cesd_iyes_adj_mi_noadl_results <- cesd_iyes_adj_mi_noadl_results %>% 
    bind_rows(., cesd_iyes_adj_mi_result)
  
  rm(cesd_iyes_adj_mi, cesd_iyes_adj_mi_result)
}

# metafor
cesd_iyes_adj_mi_noadl_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_mi_noadl_results, slab = country)


#### Life satisfaction ####
# lme4
satlife_iyes_adj_mi_noadl_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    satlife_iyes_adj_mi <- lmer(
      satlife_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(adl_any == "no"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    satlife_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      satlife_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    satlife_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        satlife_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(adl_any == "no"), control = lmerControl(optimizer = 'bobyqa'))
      })
    satlife_iyes_adj_mi_result <- lapply(seq_along(satlife_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  satlife_iyes_adj_mi_noadl_results <- satlife_iyes_adj_mi_noadl_results %>% 
    bind_rows(., satlife_iyes_adj_mi_result)
  
  rm(satlife_iyes_adj_mi, satlife_iyes_adj_mi_result)
}

# metafor
satlife_iyes_adj_mi_noadl_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_mi_noadl_results, slab = country)


#### Self-rated health ####
# lme4
shlt_iyes_adj_mi_noadl_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    shlt_iyes_adj_mi <- lmer(
      shlt_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(adl_any == "no"), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    shlt_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      shlt_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    shlt_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        shlt_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(adl_any == "no"), control = lmerControl(optimizer = 'bobyqa'))
      })
    shlt_iyes_adj_mi_result <- lapply(seq_along(shlt_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  shlt_iyes_adj_mi_noadl_results <- shlt_iyes_adj_mi_noadl_results %>% 
    bind_rows(., shlt_iyes_adj_mi_result)
  
  rm(shlt_iyes_adj_mi, shlt_iyes_adj_mi_result)
}

# metafor
shlt_iyes_adj_mi_noadl_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_mi_noadl_results, slab = country)

toc() # 2639.69 sec elapsed

```

### Meta analysis subgroup analysis

```{r}

#### CES-D ####
cesd_iyes_adj_mi_adlall_results <- cesd_iyes_adj_mi_adl_results %>%
  mutate(subgroup = "adl") %>%
  bind_rows(., cesd_iyes_adj_mi_noadl_results %>% mutate(subgroup = "noadl"))

cesd_iyes_adj_mi_adlall_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = cesd_iyes_adj_mi_adlall_results, slab = country) # Significant


#### Life satisfaction ####
satlife_iyes_adj_mi_adlall_results <- satlife_iyes_adj_mi_adl_results %>%
  mutate(subgroup = "adl") %>%
  bind_rows(., satlife_iyes_adj_mi_noadl_results %>% mutate(subgroup = "noadl"))

satlife_iyes_adj_mi_adlall_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = satlife_iyes_adj_mi_adlall_results, slab = country)


#### Self-reported health ####
shlt_iyes_adj_mi_adlall_results <- shlt_iyes_adj_mi_adl_results %>%
  mutate(subgroup = "adl") %>%
  bind_rows(., shlt_iyes_adj_mi_noadl_results %>% mutate(subgroup = "noadl"))

shlt_iyes_adj_mi_adlall_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = shlt_iyes_adj_mi_adlall_results, slab = country)

```

## By chronic conditions

### ≥1 chronic conditions

```{r warning=FALSE}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

tic()
#### CES-D ####
# lme4
cesd_iyes_adj_mi_dis_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    cesd_iyes_adj_mi <- lmer(
      cesd_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(dis > 0), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    cesd_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      cesd_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    cesd_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        cesd_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(dis > 0), control = lmerControl(optimizer = 'bobyqa'))
      })
    cesd_iyes_adj_mi_result <- lapply(seq_along(cesd_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  cesd_iyes_adj_mi_dis_results <- cesd_iyes_adj_mi_dis_results %>% 
    bind_rows(., cesd_iyes_adj_mi_result)
  
  rm(cesd_iyes_adj_mi, cesd_iyes_adj_mi_result)
}

# metafor
cesd_iyes_adj_mi_dis_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_mi_dis_results, slab = country)


#### Life satisfaction ####
# lme4
satlife_iyes_adj_mi_dis_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    satlife_iyes_adj_mi <- lmer(
      satlife_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(dis > 0), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    satlife_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      satlife_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    satlife_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        satlife_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(dis > 0), control = lmerControl(optimizer = 'bobyqa'))
      })
    satlife_iyes_adj_mi_result <- lapply(seq_along(satlife_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  satlife_iyes_adj_mi_dis_results <- satlife_iyes_adj_mi_dis_results %>% 
    bind_rows(., satlife_iyes_adj_mi_result)
  
  rm(satlife_iyes_adj_mi, satlife_iyes_adj_mi_result)
}

# metafor
satlife_iyes_adj_mi_dis_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_mi_dis_results, slab = country)


#### Self-rated health ####
# lme4
shlt_iyes_adj_mi_dis_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    shlt_iyes_adj_mi <- lmer(
      shlt_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(dis > 0), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    shlt_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      shlt_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    shlt_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        shlt_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(dis > 0), control = lmerControl(optimizer = 'bobyqa'))
      })
    shlt_iyes_adj_mi_result <- lapply(seq_along(shlt_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  shlt_iyes_adj_mi_dis_results <- shlt_iyes_adj_mi_dis_results %>% 
    bind_rows(., shlt_iyes_adj_mi_result)
  
  rm(shlt_iyes_adj_mi, shlt_iyes_adj_mi_result)
}

# metafor
shlt_iyes_adj_mi_dis_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_mi_dis_results, slab = country)

toc() # 1933.41 sec elapsed

```

### No chronic conditions

```{r warning=FALSE}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

tic()
#### CES-D ####
# lme4
cesd_iyes_adj_mi_nodis_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    cesd_iyes_adj_mi <- lmer(
      cesd_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(dis == 0), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    cesd_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      cesd_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    cesd_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        cesd_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(dis == 0), control = lmerControl(optimizer = 'bobyqa'))
      })
    cesd_iyes_adj_mi_result <- lapply(seq_along(cesd_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  cesd_iyes_adj_mi_nodis_results <- cesd_iyes_adj_mi_nodis_results %>% 
    bind_rows(., cesd_iyes_adj_mi_result)
  
  rm(cesd_iyes_adj_mi, cesd_iyes_adj_mi_result)
}

# metafor
cesd_iyes_adj_mi_nodis_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_mi_nodis_results, slab = country)


#### Life satisfaction ####
# lme4
satlife_iyes_adj_mi_nodis_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    satlife_iyes_adj_mi <- lmer(
      satlife_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(dis == 0), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    satlife_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      satlife_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    satlife_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        satlife_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(dis == 0), control = lmerControl(optimizer = 'bobyqa'))
      })
    satlife_iyes_adj_mi_result <- lapply(seq_along(satlife_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  satlife_iyes_adj_mi_nodis_results <- satlife_iyes_adj_mi_nodis_results %>% 
    bind_rows(., satlife_iyes_adj_mi_result)
  
  rm(satlife_iyes_adj_mi, satlife_iyes_adj_mi_result)
}

# metafor
satlife_iyes_adj_mi_nodis_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_mi_nodis_results, slab = country)


#### Self-rated health ####
# lme4
shlt_iyes_adj_mi_nodis_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    shlt_iyes_adj_mi <- lmer(
      shlt_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% filter(dis == 0), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    shlt_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      shlt_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    shlt_iyes_adj_mi <- lapply(subgroup_mi_iyes_merge, function(x){
      lmer(
        shlt_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]) %>% filter(dis == 0), control = lmerControl(optimizer = 'bobyqa'))
      })
    shlt_iyes_adj_mi_result <- lapply(seq_along(shlt_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
    }
  
  shlt_iyes_adj_mi_nodis_results <- shlt_iyes_adj_mi_nodis_results %>% 
    bind_rows(., shlt_iyes_adj_mi_result)
  
  rm(shlt_iyes_adj_mi, shlt_iyes_adj_mi_result)
}

# metafor
shlt_iyes_adj_mi_nodis_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_mi_nodis_results, slab = country)

toc() # 764.91 sec elapsed

```

### Meta analysis subgroup analysis

```{r}

#### CES-D ####
cesd_iyes_adj_mi_disall_results <- cesd_iyes_adj_mi_dis_results %>%
  mutate(subgroup = "dis") %>%
  bind_rows(., cesd_iyes_adj_mi_nodis_results %>% mutate(subgroup = "nodis"))

cesd_iyes_adj_mi_disall_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = cesd_iyes_adj_mi_disall_results, slab = country)


#### Life satisfaction ####
satlife_iyes_adj_mi_disall_results <- satlife_iyes_adj_mi_dis_results %>%
  mutate(subgroup = "dis") %>%
  bind_rows(., satlife_iyes_adj_mi_nodis_results %>% mutate(subgroup = "nodis"))

satlife_iyes_adj_mi_disall_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = satlife_iyes_adj_mi_disall_results, slab = country)


#### Self-reported health ####
shlt_iyes_adj_mi_disall_results <- shlt_iyes_adj_mi_dis_results %>%
  mutate(subgroup = "dis") %>%
  bind_rows(., shlt_iyes_adj_mi_nodis_results %>% mutate(subgroup = "nodis"))

shlt_iyes_adj_mi_disall_meta <- rma(yi = estimate, sei = std.error, mods = ~ subgroup, data = shlt_iyes_adj_mi_disall_results, slab = country)

```

## By genetic risk

### Depressive symptoms PGS

```{r warning=FALSE}

tic()
#### CES-D ####
# HRS
cesd_iyes_adj_mi_deprepgs_low_hrs <- lapply(mi_iyes_pgs_hrs, function(x){
  lmer(
    cesd_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highdeprepgs == "low"), control = lmerControl(optimizer = 'bobyqa'))
  })

cesd_iyes_adj_mi_deprepgs_interm_hrs <- lapply(mi_iyes_pgs_hrs, function(x){
  lmer(
    cesd_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highdeprepgs == "intermediate"), control = lmerControl(optimizer = 'bobyqa'))
  })

cesd_iyes_adj_mi_deprepgs_high_hrs <- lapply(mi_iyes_pgs_hrs, function(x){
  lmer(
    cesd_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highdeprepgs == "high"), control = lmerControl(optimizer = 'bobyqa'))
  })

cesd_iyes_adj_mi_deprepgs_re_hrs <- 
  lapply(seq_along(cesd_iyes_adj_mi_deprepgs_low_hrs), \(j) marginaleffects::avg_comparisons(cesd_iyes_adj_mi_deprepgs_low_hrs[[j]], variables = "internet_yes", re.form = NA)) %>%
  mice::pool() %>%
  tidy() %>%
  mutate(deprepgs = "low") %>%
  bind_rows(
    lapply(seq_along(cesd_iyes_adj_mi_deprepgs_low_hrs), \(j) marginaleffects::avg_comparisons(cesd_iyes_adj_mi_deprepgs_interm_hrs[[j]], variables = "internet_yes", re.form = NA)) %>% mice::pool() %>% tidy() %>% mutate(deprepgs = "intermediate")
    ) %>%
  bind_rows(
    lapply(seq_along(cesd_iyes_adj_mi_deprepgs_low_hrs), \(j) marginaleffects::avg_comparisons(cesd_iyes_adj_mi_deprepgs_high_hrs[[j]], variables = "internet_yes", re.form = NA)) %>% mice::pool() %>% tidy() %>% mutate(deprepgs = "high")
    ) %>%
  mutate(country = "USA", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  select(country, deprepgs, term, contrast, estimate, std.error, statistic, p.value, p.sig)


# ELSA
cesd_iyes_adj_mi_deprepgs_low_elsa <- lapply(mi_iyes_pgs_elsa, function(x){
  lmer(
    cesd_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highdeprepgs == "low"), control = lmerControl(optimizer = 'bobyqa'))
  })

cesd_iyes_adj_mi_deprepgs_interm_elsa <- lapply(mi_iyes_pgs_elsa, function(x){
  lmer(
    cesd_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highdeprepgs == "intermediate"), control = lmerControl(optimizer = 'bobyqa'))
  })

cesd_iyes_adj_mi_deprepgs_high_elsa <- lapply(mi_iyes_pgs_elsa, function(x){
  lmer(
    cesd_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highdeprepgs == "high"), control = lmerControl(optimizer = 'bobyqa'))
  })

cesd_iyes_adj_mi_deprepgs_re_elsa <- 
  lapply(seq_along(cesd_iyes_adj_mi_deprepgs_low_elsa), \(j) marginaleffects::avg_comparisons(cesd_iyes_adj_mi_deprepgs_low_elsa[[j]], variables = "internet_yes", re.form = NA)) %>%
  mice::pool() %>%
  tidy() %>%
  mutate(deprepgs = "low") %>%
  bind_rows(
    lapply(seq_along(cesd_iyes_adj_mi_deprepgs_low_elsa), \(j) marginaleffects::avg_comparisons(cesd_iyes_adj_mi_deprepgs_interm_elsa[[j]], variables = "internet_yes", re.form = NA)) %>% mice::pool() %>% tidy() %>% mutate(deprepgs = "intermediate")
    ) %>%
  bind_rows(
    lapply(seq_along(cesd_iyes_adj_mi_deprepgs_low_elsa), \(j) marginaleffects::avg_comparisons(cesd_iyes_adj_mi_deprepgs_high_elsa[[j]], variables = "internet_yes", re.form = NA)) %>% mice::pool() %>% tidy() %>% mutate(deprepgs = "high")
    ) %>%
  mutate(country = "England", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  select(country, deprepgs, term, contrast, estimate, std.error, statistic, p.value, p.sig)

cesd_iyes_adj_mi_deprepgs_re <- bind_rows(cesd_iyes_adj_mi_deprepgs_re_hrs, cesd_iyes_adj_mi_deprepgs_re_elsa)


#### Life satisfaction ####
# HRS
satlife_iyes_adj_mi_deprepgs_low_hrs <- lapply(mi_iyes_pgs_hrs, function(x){
  lmer(
    satlife_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highdeprepgs == "low"), control = lmerControl(optimizer = 'bobyqa'))
  })

satlife_iyes_adj_mi_deprepgs_interm_hrs <- lapply(mi_iyes_pgs_hrs, function(x){
  lmer(
    satlife_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highdeprepgs == "intermediate"), control = lmerControl(optimizer = 'bobyqa'))
  })

satlife_iyes_adj_mi_deprepgs_high_hrs <- lapply(mi_iyes_pgs_hrs, function(x){
  lmer(
    satlife_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highdeprepgs == "high"), control = lmerControl(optimizer = 'bobyqa'))
  })

satlife_iyes_adj_mi_deprepgs_re_hrs <- 
  lapply(seq_along(satlife_iyes_adj_mi_deprepgs_low_hrs), \(j) marginaleffects::avg_comparisons(satlife_iyes_adj_mi_deprepgs_low_hrs[[j]], variables = "internet_yes", re.form = NA)) %>%
  mice::pool() %>%
  tidy() %>%
  mutate(deprepgs = "low") %>%
  bind_rows(
    lapply(seq_along(satlife_iyes_adj_mi_deprepgs_low_hrs), \(j) marginaleffects::avg_comparisons(satlife_iyes_adj_mi_deprepgs_interm_hrs[[j]], variables = "internet_yes", re.form = NA)) %>% mice::pool() %>% tidy() %>% mutate(deprepgs = "intermediate")
    ) %>%
  bind_rows(
    lapply(seq_along(satlife_iyes_adj_mi_deprepgs_low_hrs), \(j) marginaleffects::avg_comparisons(satlife_iyes_adj_mi_deprepgs_high_hrs[[j]], variables = "internet_yes", re.form = NA)) %>% mice::pool() %>% tidy() %>% mutate(deprepgs = "high")
    ) %>%
  mutate(country = "USA", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  select(country, deprepgs, term, contrast, estimate, std.error, statistic, p.value, p.sig)


# ELSA
satlife_iyes_adj_mi_deprepgs_low_elsa <- lapply(mi_iyes_pgs_elsa, function(x){
  lmer(
    satlife_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highdeprepgs == "low"), control = lmerControl(optimizer = 'bobyqa'))
  })

satlife_iyes_adj_mi_deprepgs_interm_elsa <- lapply(mi_iyes_pgs_elsa, function(x){
  lmer(
    satlife_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highdeprepgs == "intermediate"), control = lmerControl(optimizer = 'bobyqa'))
  })

satlife_iyes_adj_mi_deprepgs_high_elsa <- lapply(mi_iyes_pgs_elsa, function(x){
  lmer(
    satlife_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highdeprepgs == "high"), control = lmerControl(optimizer = 'bobyqa'))
  })

satlife_iyes_adj_mi_deprepgs_re_elsa <- 
  lapply(seq_along(satlife_iyes_adj_mi_deprepgs_low_elsa), \(j) marginaleffects::avg_comparisons(satlife_iyes_adj_mi_deprepgs_low_elsa[[j]], variables = "internet_yes", re.form = NA)) %>%
  mice::pool() %>%
  tidy() %>%
  mutate(deprepgs = "low") %>%
  bind_rows(
    lapply(seq_along(satlife_iyes_adj_mi_deprepgs_low_elsa), \(j) marginaleffects::avg_comparisons(satlife_iyes_adj_mi_deprepgs_interm_elsa[[j]], variables = "internet_yes", re.form = NA)) %>% mice::pool() %>% tidy() %>% mutate(deprepgs = "intermediate")
    ) %>%
  bind_rows(
    lapply(seq_along(satlife_iyes_adj_mi_deprepgs_low_elsa), \(j) marginaleffects::avg_comparisons(satlife_iyes_adj_mi_deprepgs_high_elsa[[j]], variables = "internet_yes", re.form = NA)) %>% mice::pool() %>% tidy() %>% mutate(deprepgs = "high")
    ) %>%
  mutate(country = "England", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  select(country, deprepgs, term, contrast, estimate, std.error, statistic, p.value, p.sig)

satlife_iyes_adj_mi_deprepgs_re <- bind_rows(satlife_iyes_adj_mi_deprepgs_re_hrs, satlife_iyes_adj_mi_deprepgs_re_elsa)



#### Self-rated health ####
# HRS
shlt_iyes_adj_mi_deprepgs_low_hrs <- lapply(mi_iyes_pgs_hrs, function(x){
  lmer(
    shlt_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highdeprepgs == "low"), control = lmerControl(optimizer = 'bobyqa'))
  })

shlt_iyes_adj_mi_deprepgs_interm_hrs <- lapply(mi_iyes_pgs_hrs, function(x){
  lmer(
    shlt_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highdeprepgs == "intermediate"), control = lmerControl(optimizer = 'bobyqa'))
  })

shlt_iyes_adj_mi_deprepgs_high_hrs <- lapply(mi_iyes_pgs_hrs, function(x){
  lmer(
    shlt_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highdeprepgs == "high"), control = lmerControl(optimizer = 'bobyqa'))
  })

shlt_iyes_adj_mi_deprepgs_re_hrs <- 
  lapply(seq_along(shlt_iyes_adj_mi_deprepgs_low_hrs), \(j) marginaleffects::avg_comparisons(shlt_iyes_adj_mi_deprepgs_low_hrs[[j]], variables = "internet_yes", re.form = NA)) %>%
  mice::pool() %>%
  tidy() %>%
  mutate(deprepgs = "low") %>%
  bind_rows(
    lapply(seq_along(shlt_iyes_adj_mi_deprepgs_low_hrs), \(j) marginaleffects::avg_comparisons(shlt_iyes_adj_mi_deprepgs_interm_hrs[[j]], variables = "internet_yes", re.form = NA)) %>% mice::pool() %>% tidy() %>% mutate(deprepgs = "intermediate")
    ) %>%
  bind_rows(
    lapply(seq_along(shlt_iyes_adj_mi_deprepgs_low_hrs), \(j) marginaleffects::avg_comparisons(shlt_iyes_adj_mi_deprepgs_high_hrs[[j]], variables = "internet_yes", re.form = NA)) %>% mice::pool() %>% tidy() %>% mutate(deprepgs = "high")
    ) %>%
  mutate(country = "USA", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  select(country, deprepgs, term, contrast, estimate, std.error, statistic, p.value, p.sig)


# ELSA
shlt_iyes_adj_mi_deprepgs_low_elsa <- lapply(mi_iyes_pgs_elsa, function(x){
  lmer(
    shlt_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highdeprepgs == "low"), control = lmerControl(optimizer = 'bobyqa'))
  })

shlt_iyes_adj_mi_deprepgs_interm_elsa <- lapply(mi_iyes_pgs_elsa, function(x){
  lmer(
    shlt_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highdeprepgs == "intermediate"), control = lmerControl(optimizer = 'bobyqa'))
  })

shlt_iyes_adj_mi_deprepgs_high_elsa <- lapply(mi_iyes_pgs_elsa, function(x){
  lmer(
    shlt_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highdeprepgs == "high"), control = lmerControl(optimizer = 'bobyqa'))
  })

shlt_iyes_adj_mi_deprepgs_re_elsa <- 
  lapply(seq_along(shlt_iyes_adj_mi_deprepgs_low_elsa), \(j) marginaleffects::avg_comparisons(shlt_iyes_adj_mi_deprepgs_low_elsa[[j]], variables = "internet_yes", re.form = NA)) %>%
  mice::pool() %>%
  tidy() %>%
  mutate(deprepgs = "low") %>%
  bind_rows(
    lapply(seq_along(shlt_iyes_adj_mi_deprepgs_low_elsa), \(j) marginaleffects::avg_comparisons(shlt_iyes_adj_mi_deprepgs_interm_elsa[[j]], variables = "internet_yes", re.form = NA)) %>% mice::pool() %>% tidy() %>% mutate(deprepgs = "intermediate")
    ) %>%
  bind_rows(
    lapply(seq_along(shlt_iyes_adj_mi_deprepgs_low_elsa), \(j) marginaleffects::avg_comparisons(shlt_iyes_adj_mi_deprepgs_high_elsa[[j]], variables = "internet_yes", re.form = NA)) %>% mice::pool() %>% tidy() %>% mutate(deprepgs = "high")
    ) %>%
  mutate(country = "England", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  select(country, deprepgs, term, contrast, estimate, std.error, statistic, p.value, p.sig)

shlt_iyes_adj_mi_deprepgs_re <- bind_rows(shlt_iyes_adj_mi_deprepgs_re_hrs, shlt_iyes_adj_mi_deprepgs_re_elsa)

toc() # 452.8 sec elapsed

```

### Subjective well-being PGS

```{r warning=FALSE}

tic()
#### CES-D ####
# HRS
cesd_iyes_adj_mi_wellbpgs_low_hrs <- lapply(mi_iyes_pgs_hrs, function(x){
  lmer(
    cesd_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highwellbpgs == "low"), control = lmerControl(optimizer = 'bobyqa'))
  })

cesd_iyes_adj_mi_wellbpgs_interm_hrs <- lapply(mi_iyes_pgs_hrs, function(x){
  lmer(
    cesd_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highwellbpgs == "intermediate"), control = lmerControl(optimizer = 'bobyqa'))
  })

cesd_iyes_adj_mi_wellbpgs_high_hrs <- lapply(mi_iyes_pgs_hrs, function(x){
  lmer(
    cesd_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highwellbpgs == "high"), control = lmerControl(optimizer = 'bobyqa'))
  })

cesd_iyes_adj_mi_wellbpgs_re_hrs <- 
  lapply(seq_along(cesd_iyes_adj_mi_wellbpgs_low_hrs), \(j) marginaleffects::avg_comparisons(cesd_iyes_adj_mi_wellbpgs_low_hrs[[j]], variables = "internet_yes", re.form = NA)) %>%
  mice::pool() %>%
  tidy() %>%
  mutate(wellbpgs = "low") %>%
  bind_rows(
    lapply(seq_along(cesd_iyes_adj_mi_wellbpgs_low_hrs), \(j) marginaleffects::avg_comparisons(cesd_iyes_adj_mi_wellbpgs_interm_hrs[[j]], variables = "internet_yes", re.form = NA)) %>% mice::pool() %>% tidy() %>% mutate(wellbpgs = "intermediate")
    ) %>%
  bind_rows(
    lapply(seq_along(cesd_iyes_adj_mi_wellbpgs_low_hrs), \(j) marginaleffects::avg_comparisons(cesd_iyes_adj_mi_wellbpgs_high_hrs[[j]], variables = "internet_yes", re.form = NA)) %>% mice::pool() %>% tidy() %>% mutate(wellbpgs = "high")
    ) %>%
  mutate(country = "USA", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  select(country, wellbpgs, term, contrast, estimate, std.error, statistic, p.value, p.sig)


# ELSA
cesd_iyes_adj_mi_wellbpgs_low_elsa <- lapply(mi_iyes_pgs_elsa, function(x){
  lmer(
    cesd_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highwellbpgs == "low"), control = lmerControl(optimizer = 'bobyqa'))
  })

cesd_iyes_adj_mi_wellbpgs_interm_elsa <- lapply(mi_iyes_pgs_elsa, function(x){
  lmer(
    cesd_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highwellbpgs == "intermediate"), control = lmerControl(optimizer = 'bobyqa'))
  })

cesd_iyes_adj_mi_wellbpgs_high_elsa <- lapply(mi_iyes_pgs_elsa, function(x){
  lmer(
    cesd_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highwellbpgs == "high"), control = lmerControl(optimizer = 'bobyqa'))
  })

cesd_iyes_adj_mi_wellbpgs_re_elsa <- 
  lapply(seq_along(cesd_iyes_adj_mi_wellbpgs_low_elsa), \(j) marginaleffects::avg_comparisons(cesd_iyes_adj_mi_wellbpgs_low_elsa[[j]], variables = "internet_yes", re.form = NA)) %>%
  mice::pool() %>%
  tidy() %>%
  mutate(wellbpgs = "low") %>%
  bind_rows(
    lapply(seq_along(cesd_iyes_adj_mi_wellbpgs_low_elsa), \(j) marginaleffects::avg_comparisons(cesd_iyes_adj_mi_wellbpgs_interm_elsa[[j]], variables = "internet_yes", re.form = NA)) %>% mice::pool() %>% tidy() %>% mutate(wellbpgs = "intermediate")
    ) %>%
  bind_rows(
    lapply(seq_along(cesd_iyes_adj_mi_wellbpgs_low_elsa), \(j) marginaleffects::avg_comparisons(cesd_iyes_adj_mi_wellbpgs_high_elsa[[j]], variables = "internet_yes", re.form = NA)) %>% mice::pool() %>% tidy() %>% mutate(wellbpgs = "high")
    ) %>%
  mutate(country = "England", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  select(country, wellbpgs, term, contrast, estimate, std.error, statistic, p.value, p.sig)

cesd_iyes_adj_mi_wellbpgs_re <- bind_rows(cesd_iyes_adj_mi_wellbpgs_re_hrs, cesd_iyes_adj_mi_wellbpgs_re_elsa)


#### Life satisfaction ####
# HRS
satlife_iyes_adj_mi_wellbpgs_low_hrs <- lapply(mi_iyes_pgs_hrs, function(x){
  lmer(
    satlife_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highwellbpgs == "low"), control = lmerControl(optimizer = 'bobyqa'))
  })

satlife_iyes_adj_mi_wellbpgs_interm_hrs <- lapply(mi_iyes_pgs_hrs, function(x){
  lmer(
    satlife_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highwellbpgs == "intermediate"), control = lmerControl(optimizer = 'bobyqa'))
  })

satlife_iyes_adj_mi_wellbpgs_high_hrs <- lapply(mi_iyes_pgs_hrs, function(x){
  lmer(
    satlife_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highwellbpgs == "high"), control = lmerControl(optimizer = 'bobyqa'))
  })

satlife_iyes_adj_mi_wellbpgs_re_hrs <- 
  lapply(seq_along(satlife_iyes_adj_mi_wellbpgs_low_hrs), \(j) marginaleffects::avg_comparisons(satlife_iyes_adj_mi_wellbpgs_low_hrs[[j]], variables = "internet_yes", re.form = NA)) %>%
  mice::pool() %>%
  tidy() %>%
  mutate(wellbpgs = "low") %>%
  bind_rows(
    lapply(seq_along(satlife_iyes_adj_mi_wellbpgs_low_hrs), \(j) marginaleffects::avg_comparisons(satlife_iyes_adj_mi_wellbpgs_interm_hrs[[j]], variables = "internet_yes", re.form = NA)) %>% mice::pool() %>% tidy() %>% mutate(wellbpgs = "intermediate")
    ) %>%
  bind_rows(
    lapply(seq_along(satlife_iyes_adj_mi_wellbpgs_low_hrs), \(j) marginaleffects::avg_comparisons(satlife_iyes_adj_mi_wellbpgs_high_hrs[[j]], variables = "internet_yes", re.form = NA)) %>% mice::pool() %>% tidy() %>% mutate(wellbpgs = "high")
    ) %>%
  mutate(country = "USA", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  select(country, wellbpgs, term, contrast, estimate, std.error, statistic, p.value, p.sig)


# ELSA
satlife_iyes_adj_mi_wellbpgs_low_elsa <- lapply(mi_iyes_pgs_elsa, function(x){
  lmer(
    satlife_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highwellbpgs == "low"), control = lmerControl(optimizer = 'bobyqa'))
  })

satlife_iyes_adj_mi_wellbpgs_interm_elsa <- lapply(mi_iyes_pgs_elsa, function(x){
  lmer(
    satlife_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highwellbpgs == "intermediate"), control = lmerControl(optimizer = 'bobyqa'))
  })

satlife_iyes_adj_mi_wellbpgs_high_elsa <- lapply(mi_iyes_pgs_elsa, function(x){
  lmer(
    satlife_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highwellbpgs == "high"), control = lmerControl(optimizer = 'bobyqa'))
  })

satlife_iyes_adj_mi_wellbpgs_re_elsa <- 
  lapply(seq_along(satlife_iyes_adj_mi_wellbpgs_low_elsa), \(j) marginaleffects::avg_comparisons(satlife_iyes_adj_mi_wellbpgs_low_elsa[[j]], variables = "internet_yes", re.form = NA)) %>%
  mice::pool() %>%
  tidy() %>%
  mutate(wellbpgs = "low") %>%
  bind_rows(
    lapply(seq_along(satlife_iyes_adj_mi_wellbpgs_low_elsa), \(j) marginaleffects::avg_comparisons(satlife_iyes_adj_mi_wellbpgs_interm_elsa[[j]], variables = "internet_yes", re.form = NA)) %>% mice::pool() %>% tidy() %>% mutate(wellbpgs = "intermediate")
    ) %>%
  bind_rows(
    lapply(seq_along(satlife_iyes_adj_mi_wellbpgs_low_elsa), \(j) marginaleffects::avg_comparisons(satlife_iyes_adj_mi_wellbpgs_high_elsa[[j]], variables = "internet_yes", re.form = NA)) %>% mice::pool() %>% tidy() %>% mutate(wellbpgs = "high")
    ) %>%
  mutate(country = "England", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  select(country, wellbpgs, term, contrast, estimate, std.error, statistic, p.value, p.sig)

satlife_iyes_adj_mi_wellbpgs_re <- bind_rows(satlife_iyes_adj_mi_wellbpgs_re_hrs, satlife_iyes_adj_mi_wellbpgs_re_elsa)



#### Self-rated health ####
# HRS
shlt_iyes_adj_mi_wellbpgs_low_hrs <- lapply(mi_iyes_pgs_hrs, function(x){
  lmer(
    shlt_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highwellbpgs == "low"), control = lmerControl(optimizer = 'bobyqa'))
  })

shlt_iyes_adj_mi_wellbpgs_interm_hrs <- lapply(mi_iyes_pgs_hrs, function(x){
  lmer(
    shlt_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highwellbpgs == "intermediate"), control = lmerControl(optimizer = 'bobyqa'))
  })

shlt_iyes_adj_mi_wellbpgs_high_hrs <- lapply(mi_iyes_pgs_hrs, function(x){
  lmer(
    shlt_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highwellbpgs == "high"), control = lmerControl(optimizer = 'bobyqa'))
  })

shlt_iyes_adj_mi_wellbpgs_re_hrs <- 
  lapply(seq_along(shlt_iyes_adj_mi_wellbpgs_low_hrs), \(j) marginaleffects::avg_comparisons(shlt_iyes_adj_mi_wellbpgs_low_hrs[[j]], variables = "internet_yes", re.form = NA)) %>%
  mice::pool() %>%
  tidy() %>%
  mutate(wellbpgs = "low") %>%
  bind_rows(
    lapply(seq_along(shlt_iyes_adj_mi_wellbpgs_low_hrs), \(j) marginaleffects::avg_comparisons(shlt_iyes_adj_mi_wellbpgs_interm_hrs[[j]], variables = "internet_yes", re.form = NA)) %>% mice::pool() %>% tidy() %>% mutate(wellbpgs = "intermediate")
    ) %>%
  bind_rows(
    lapply(seq_along(shlt_iyes_adj_mi_wellbpgs_low_hrs), \(j) marginaleffects::avg_comparisons(shlt_iyes_adj_mi_wellbpgs_high_hrs[[j]], variables = "internet_yes", re.form = NA)) %>% mice::pool() %>% tidy() %>% mutate(wellbpgs = "high")
    ) %>%
  mutate(country = "USA", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  select(country, wellbpgs, term, contrast, estimate, std.error, statistic, p.value, p.sig)


# ELSA
shlt_iyes_adj_mi_wellbpgs_low_elsa <- lapply(mi_iyes_pgs_elsa, function(x){
  lmer(
    shlt_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highwellbpgs == "low"), control = lmerControl(optimizer = 'bobyqa'))
  })

shlt_iyes_adj_mi_wellbpgs_interm_elsa <- lapply(mi_iyes_pgs_elsa, function(x){
  lmer(
    shlt_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highwellbpgs == "intermediate"), control = lmerControl(optimizer = 'bobyqa'))
  })

shlt_iyes_adj_mi_wellbpgs_high_elsa <- lapply(mi_iyes_pgs_elsa, function(x){
  lmer(
    shlt_stand ~ internet_yes*cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl +  
      (1 | id),
    data = x %>% filter(highwellbpgs == "high"), control = lmerControl(optimizer = 'bobyqa'))
  })

shlt_iyes_adj_mi_wellbpgs_re_elsa <- 
  lapply(seq_along(shlt_iyes_adj_mi_wellbpgs_low_elsa), \(j) marginaleffects::avg_comparisons(shlt_iyes_adj_mi_wellbpgs_low_elsa[[j]], variables = "internet_yes", re.form = NA)) %>%
  mice::pool() %>%
  tidy() %>%
  mutate(wellbpgs = "low") %>%
  bind_rows(
    lapply(seq_along(shlt_iyes_adj_mi_wellbpgs_low_elsa), \(j) marginaleffects::avg_comparisons(shlt_iyes_adj_mi_wellbpgs_interm_elsa[[j]], variables = "internet_yes", re.form = NA)) %>% mice::pool() %>% tidy() %>% mutate(wellbpgs = "intermediate")
    ) %>%
  bind_rows(
    lapply(seq_along(shlt_iyes_adj_mi_wellbpgs_low_elsa), \(j) marginaleffects::avg_comparisons(shlt_iyes_adj_mi_wellbpgs_high_elsa[[j]], variables = "internet_yes", re.form = NA)) %>% mice::pool() %>% tidy() %>% mutate(wellbpgs = "high")
    ) %>%
  mutate(country = "England", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  select(country, wellbpgs, term, contrast, estimate, std.error, statistic, p.value, p.sig)

shlt_iyes_adj_mi_wellbpgs_re <- bind_rows(shlt_iyes_adj_mi_wellbpgs_re_hrs, shlt_iyes_adj_mi_wellbpgs_re_elsa)

toc() # 390.38 sec elapsed

```

### Test for interaction

#### Depressive symptoms PGS

```{r}

dat_hrs <- lapply(mi_iyes_pgs_hrs, as.data.table) %>%
  lapply(., as.data.frame) %>%
  miceadds::datlist2mids()

dat_elsa <- lapply(mi_iyes_pgs_elsa, as.data.table) %>%
  lapply(., as.data.frame) %>%
  miceadds::datlist2mids()

tic()

p_deprepgs_int <- tibble()
#### CES-D ####
# HRS
cesd_iyes_adj_deprepgs <- with(dat_hrs, lmer(
    cesd_stand  ~ internet_yes*cwave + highdeprepgs +
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id), control = lmerControl(optimizer = "bobyqa")))

cesd_iyes_adj_deprepgs_int <- with(dat_hrs, lmer(
    cesd_stand  ~ internet_yes*cwave + internet_yes*highdeprepgs +
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id), control = lmerControl(optimizer = "bobyqa")))

p_deprepgs_int <- p_deprepgs_int %>% 
  bind_rows(., mice::D1(cesd_iyes_adj_deprepgs_int, cesd_iyes_adj_deprepgs)$result %>% as_tibble() %>% mutate(outcome = "cesd", country = "USA"))


# ELSA
cesd_iyes_adj_deprepgs <- with(dat_elsa, lmer(
    cesd_stand  ~ internet_yes*cwave + highdeprepgs +
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id), control = lmerControl(optimizer = "bobyqa")))

cesd_iyes_adj_deprepgs_int <- with(dat_elsa, lmer(
    cesd_stand  ~ internet_yes*cwave + internet_yes*highdeprepgs +
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id), control = lmerControl(optimizer = "bobyqa")))

p_deprepgs_int <- p_deprepgs_int %>% 
  bind_rows(., mice::D1(cesd_iyes_adj_deprepgs_int, cesd_iyes_adj_deprepgs)$result %>% as_tibble() %>% mutate(outcome = "cesd", country = "England"))


#### Life satisfaction ####
# HRS
satlife_iyes_adj_deprepgs <- with(dat_hrs, lmer(
    satlife_stand  ~ internet_yes*cwave + highdeprepgs +
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id), control = lmerControl(optimizer = "bobyqa")))

satlife_iyes_adj_deprepgs_int <- with(dat_hrs, lmer(
    satlife_stand  ~ internet_yes*cwave + internet_yes*highdeprepgs +
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id), control = lmerControl(optimizer = "bobyqa")))

p_deprepgs_int <- p_deprepgs_int %>% 
  bind_rows(., mice::D1(satlife_iyes_adj_deprepgs_int, satlife_iyes_adj_deprepgs)$result %>% as_tibble() %>% mutate(outcome = "satlife", country = "USA"))

# ELSA
satlife_iyes_adj_deprepgs <- with(dat_elsa, lmer(
    satlife_stand  ~ internet_yes*cwave + highdeprepgs +
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id), control = lmerControl(optimizer = "bobyqa")))

satlife_iyes_adj_deprepgs_int <- with(dat_elsa, lmer(
    satlife_stand  ~ internet_yes*cwave + internet_yes*highdeprepgs +
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id), control = lmerControl(optimizer = "bobyqa")))

p_deprepgs_int <- p_deprepgs_int %>% 
  bind_rows(., mice::D1(satlife_iyes_adj_deprepgs_int, satlife_iyes_adj_deprepgs)$result %>% as_tibble() %>% mutate(outcome = "satlife", country = "England"))

#### Self-reported health ####
# HRS
shlt_iyes_adj_deprepgs <- with(dat_hrs, lmer(
    shlt_stand  ~ internet_yes*cwave + highdeprepgs +
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id), control = lmerControl(optimizer = "bobyqa")))

shlt_iyes_adj_deprepgs_int <- with(dat_hrs, lmer(
    shlt_stand  ~ internet_yes*cwave + internet_yes*highdeprepgs +
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id), control = lmerControl(optimizer = "bobyqa")))

p_deprepgs_int <- p_deprepgs_int %>% 
  bind_rows(., mice::D1(shlt_iyes_adj_deprepgs_int, shlt_iyes_adj_deprepgs)$result %>% as_tibble() %>% mutate(outcome = "shlt", country = "USA"))

# ELSA
shlt_iyes_adj_deprepgs <- with(dat_elsa, lmer(
    shlt_stand  ~ internet_yes*cwave + highdeprepgs +
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id), control = lmerControl(optimizer = "bobyqa")))

shlt_iyes_adj_deprepgs_int <- with(dat_elsa, lmer(
    shlt_stand  ~ internet_yes*cwave + internet_yes*highdeprepgs +
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id), control = lmerControl(optimizer = "bobyqa")))

p_deprepgs_int <- p_deprepgs_int %>% 
  bind_rows(., mice::D1(shlt_iyes_adj_deprepgs_int, shlt_iyes_adj_deprepgs)$result %>% as_tibble() %>% mutate(outcome = "shlt", country = "England"))

toc() # 171.39 sec elapsed

rm(cesd_iyes_adj_deprepgs, cesd_iyes_adj_deprepgs_int, satlife_iyes_adj_deprepgs, satlife_iyes_adj_deprepgs_int, shlt_iyes_adj_deprepgs, shlt_iyes_adj_deprepgs_int)

```


#### Subjective well-being PGS

```{r}

tic()

p_wellbpgs_int <- tibble()
#### CES-D ####
# HRS
cesd_iyes_adj_wellbpgs <- with(dat_hrs, lmer(
    cesd_stand  ~ internet_yes*cwave + highwellbpgs +
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id), control = lmerControl(optimizer = "bobyqa")))

cesd_iyes_adj_wellbpgs_int <- with(dat_hrs, lmer(
    cesd_stand  ~ internet_yes*cwave + internet_yes*highwellbpgs +
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id), control = lmerControl(optimizer = "bobyqa")))

p_wellbpgs_int <- p_wellbpgs_int %>% 
  bind_rows(., mice::D1(cesd_iyes_adj_wellbpgs_int, cesd_iyes_adj_wellbpgs)$result %>% as_tibble() %>% mutate(outcome = "cesd", country = "USA"))


# ELSA
cesd_iyes_adj_wellbpgs <- with(dat_elsa, lmer(
    cesd_stand  ~ internet_yes*cwave + highwellbpgs +
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id), control = lmerControl(optimizer = "bobyqa")))

cesd_iyes_adj_wellbpgs_int <- with(dat_elsa, lmer(
    cesd_stand  ~ internet_yes*cwave + internet_yes*highwellbpgs +
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id), control = lmerControl(optimizer = "bobyqa")))

p_wellbpgs_int <- p_wellbpgs_int %>% 
  bind_rows(., mice::D1(cesd_iyes_adj_wellbpgs_int, cesd_iyes_adj_wellbpgs)$result %>% as_tibble() %>% mutate(outcome = "cesd", country = "England"))


#### Life satisfaction ####
# HRS
satlife_iyes_adj_wellbpgs <- with(dat_hrs, lmer(
    satlife_stand  ~ internet_yes*cwave + highwellbpgs +
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id), control = lmerControl(optimizer = "bobyqa")))

satlife_iyes_adj_wellbpgs_int <- with(dat_hrs, lmer(
    satlife_stand  ~ internet_yes*cwave + internet_yes*highwellbpgs +
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id), control = lmerControl(optimizer = "bobyqa")))

p_wellbpgs_int <- p_wellbpgs_int %>% 
  bind_rows(., mice::D1(satlife_iyes_adj_wellbpgs_int, satlife_iyes_adj_wellbpgs)$result %>% as_tibble() %>% mutate(outcome = "satlife", country = "USA"))

# ELSA
satlife_iyes_adj_wellbpgs <- with(dat_elsa, lmer(
    satlife_stand  ~ internet_yes*cwave + highwellbpgs +
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id), control = lmerControl(optimizer = "bobyqa")))

satlife_iyes_adj_wellbpgs_int <- with(dat_elsa, lmer(
    satlife_stand  ~ internet_yes*cwave + internet_yes*highwellbpgs +
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id), control = lmerControl(optimizer = "bobyqa")))

p_wellbpgs_int <- p_wellbpgs_int %>% 
  bind_rows(., mice::D1(satlife_iyes_adj_wellbpgs_int, satlife_iyes_adj_wellbpgs)$result %>% as_tibble() %>% mutate(outcome = "satlife", country = "England"))

#### Self-reported health ####
# HRS
shlt_iyes_adj_wellbpgs <- with(dat_hrs, lmer(
    shlt_stand  ~ internet_yes*cwave + highwellbpgs +
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id), control = lmerControl(optimizer = "bobyqa")))

shlt_iyes_adj_wellbpgs_int <- with(dat_hrs, lmer(
    shlt_stand  ~ internet_yes*cwave + internet_yes*highwellbpgs +
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id), control = lmerControl(optimizer = "bobyqa")))

p_wellbpgs_int <- p_wellbpgs_int %>% 
  bind_rows(., mice::D1(shlt_iyes_adj_wellbpgs_int, shlt_iyes_adj_wellbpgs)$result %>% as_tibble() %>% mutate(outcome = "shlt", country = "USA"))

# ELSA
shlt_iyes_adj_wellbpgs <- with(dat_elsa, lmer(
    shlt_stand  ~ internet_yes*cwave + highwellbpgs +
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id), control = lmerControl(optimizer = "bobyqa")))

shlt_iyes_adj_wellbpgs_int <- with(dat_elsa, lmer(
    shlt_stand  ~ internet_yes*cwave + internet_yes*highwellbpgs +
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id), control = lmerControl(optimizer = "bobyqa")))

p_wellbpgs_int <- p_wellbpgs_int %>% 
  bind_rows(., mice::D1(shlt_iyes_adj_wellbpgs_int, shlt_iyes_adj_wellbpgs)$result %>% as_tibble() %>% mutate(outcome = "shlt", country = "England"))

toc() # 173.77 sec elapsed

rm(cesd_iyes_adj_wellbpgs, cesd_iyes_adj_wellbpgs_int, satlife_iyes_adj_wellbpgs, satlife_iyes_adj_wellbpgs_int, shlt_iyes_adj_wellbpgs, shlt_iyes_adj_wellbpgs_int)

```


## Overall

### CES-D

```{r}

#### Data preparation ####
# Age
dat_middle <- cesd_iyes_adj_mi_middle_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(cesd_iyes_adj_mi_middle_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_mi_middle_meta$se), 
      statistic = NA, 
      p.value = cesd_iyes_adj_mi_middle_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "middle")
  
dat_old <- cesd_iyes_adj_mi_old_results %>% 
  bind_rows(
    tibble(
      country = "Poland", term = NA, contrast = NA,
      estimate = NA, std.error = NA, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(cesd_iyes_adj_mi_old_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_mi_old_meta$se), 
      statistic = NA, 
      p.value = cesd_iyes_adj_mi_old_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "old")

# Gender
dat_male <- cesd_iyes_adj_mi_male_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(cesd_iyes_adj_mi_male_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_mi_male_meta$se), 
      statistic = NA, 
      p.value = cesd_iyes_adj_mi_male_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "male")

dat_female <- cesd_iyes_adj_mi_female_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(cesd_iyes_adj_mi_female_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_mi_female_meta$se), 
      statistic = NA, 
      p.value = cesd_iyes_adj_mi_female_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "female")

# Marital status
dat_married <- cesd_iyes_adj_mi_married_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(cesd_iyes_adj_mi_married_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_mi_married_meta$se), 
      statistic = NA, 
      p.value = cesd_iyes_adj_mi_married_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "married")

dat_nonmarried <- cesd_iyes_adj_mi_nonmarried_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(cesd_iyes_adj_mi_nonmarried_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_mi_nonmarried_meta$se), 
      statistic = NA, 
      p.value = cesd_iyes_adj_mi_nonmarried_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "nonmarried")

# Contact with others
dat_contact <- cesd_iyes_adj_mi_contact_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(cesd_iyes_adj_mi_contact_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_mi_contact_meta$se), 
      statistic = NA, 
      p.value = cesd_iyes_adj_mi_contact_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "contact")

dat_nocontact <- cesd_iyes_adj_mi_nocontact_results %>%
  bind_rows(
    tibble(
      country = "Poland", term = NA, contrast = NA,
      estimate = NA, std.error = NA, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(cesd_iyes_adj_mi_nocontact_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_mi_nocontact_meta$se), 
      statistic = NA, 
      p.value = cesd_iyes_adj_mi_nocontact_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "nocontact")

# Education
dat_pedu <- cesd_iyes_adj_mi_pedu_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(cesd_iyes_adj_mi_pedu_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_mi_pedu_meta$se), 
      statistic = NA, 
      p.value = cesd_iyes_adj_mi_pedu_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "pedu")

dat_sedu <- cesd_iyes_adj_mi_sedu_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(cesd_iyes_adj_mi_sedu_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_mi_sedu_meta$se), 
      statistic = NA, 
      p.value = cesd_iyes_adj_mi_sedu_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "sedu")

dat_tedu <- cesd_iyes_adj_mi_tedu_results %>% 
  bind_rows(
    tibble(
      country = "Poland", term = NA, contrast = NA,
      estimate = NA, std.error = NA, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(cesd_iyes_adj_mi_tedu_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_mi_tedu_meta$se), 
      statistic = NA, 
      p.value = cesd_iyes_adj_mi_tedu_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "tedu")

# Household wealth
dat_lwealth <- cesd_iyes_adj_mi_lwealth_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(cesd_iyes_adj_mi_lwealth_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_mi_lwealth_meta$se), 
      statistic = NA, 
      p.value = cesd_iyes_adj_mi_lwealth_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "lwealth")

dat_mwealth <- cesd_iyes_adj_mi_mwealth_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(cesd_iyes_adj_mi_mwealth_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_mi_mwealth_meta$se), 
      statistic = NA, 
      p.value = cesd_iyes_adj_mi_mwealth_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "mwealth")

dat_hwealth <- cesd_iyes_adj_mi_hwealth_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(cesd_iyes_adj_mi_hwealth_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_mi_hwealth_meta$se), 
      statistic = NA, 
      p.value = cesd_iyes_adj_mi_hwealth_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "hwealth")

# Labor force status
dat_work <- cesd_iyes_adj_mi_work_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(cesd_iyes_adj_mi_work_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_mi_work_meta$se), 
      statistic = NA, 
      p.value = cesd_iyes_adj_mi_work_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "work")

dat_retired <- cesd_iyes_adj_mi_retired_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(cesd_iyes_adj_mi_retired_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_mi_retired_meta$se), 
      statistic = NA, 
      p.value = cesd_iyes_adj_mi_retired_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "retired")

dat_others <- cesd_iyes_adj_mi_others_results %>% 
  bind_rows(
    tibble(
      country = "China", term = NA, 
      estimate = NA, std.error = NA, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(cesd_iyes_adj_mi_others_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_mi_others_meta$se), 
      statistic = NA, 
      p.value = cesd_iyes_adj_mi_others_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "others")

# Current smoking
dat_smoke <- cesd_iyes_adj_mi_smoke_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(cesd_iyes_adj_mi_smoke_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_mi_smoke_meta$se), 
      statistic = NA, 
      p.value = cesd_iyes_adj_mi_smoke_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "smoke")

dat_nosmoke <- cesd_iyes_adj_mi_nosmoke_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(cesd_iyes_adj_mi_nosmoke_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_mi_nosmoke_meta$se), 
      statistic = NA, 
      p.value = cesd_iyes_adj_mi_nosmoke_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "nosmoke")

# Alcohol consumption
dat_drink <- cesd_iyes_adj_mi_drink_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(cesd_iyes_adj_mi_drink_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_mi_drink_meta$se), 
      statistic = NA, 
      p.value = cesd_iyes_adj_mi_drink_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "drink")

dat_nodrink <- cesd_iyes_adj_mi_nodrink_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(cesd_iyes_adj_mi_nodrink_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_mi_nodrink_meta$se), 
      statistic = NA, 
      p.value = cesd_iyes_adj_mi_nodrink_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "nodrink")

# Physical activity
dat_phyinact <- cesd_iyes_adj_mi_phyinact_results %>% 
  bind_rows(
    tibble(
      country = "Poland", term = NA, contrast = NA,
      estimate = NA, std.error = NA, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(cesd_iyes_adj_mi_phyinact_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_mi_phyinact_meta$se), 
      statistic = NA, 
      p.value = cesd_iyes_adj_mi_phyinact_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "phyinact")

dat_phyact <- cesd_iyes_adj_mi_phyact_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(cesd_iyes_adj_mi_phyact_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_mi_phyact_meta$se), 
      statistic = NA, 
      p.value = cesd_iyes_adj_mi_phyact_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "phyact")

# ADL disability
dat_adl <- cesd_iyes_adj_mi_adl_results %>% 
  bind_rows(
    tibble(
      country = "Poland", term = NA, contrast = NA,
      estimate = NA, std.error = NA, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(cesd_iyes_adj_mi_adl_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_mi_adl_meta$se), 
      statistic = NA, 
      p.value = cesd_iyes_adj_mi_adl_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "adl")

dat_noadl <- cesd_iyes_adj_mi_noadl_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(cesd_iyes_adj_mi_noadl_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_mi_noadl_meta$se), 
      statistic = NA, 
      p.value = cesd_iyes_adj_mi_noadl_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "noadl")

# Chronic conditions
dat_dis <- cesd_iyes_adj_mi_dis_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(cesd_iyes_adj_mi_dis_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_mi_dis_meta$se), 
      statistic = NA, 
      p.value = cesd_iyes_adj_mi_dis_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "dis")

dat_nodis <- cesd_iyes_adj_mi_nodis_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(cesd_iyes_adj_mi_nodis_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_mi_nodis_meta$se), 
      statistic = NA, 
      p.value = cesd_iyes_adj_mi_nodis_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "nodis")

# Genetic risk: Depressive symptoms PGS
dat_deprepgs_low <- cesd_iyes_adj_mi_deprepgs_re %>% 
  filter(deprepgs == "low") %>%
  select(-deprepgs) %>%
  bind_rows(
    tibble(
      country = c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland"), 
      term = rep("internet_yesyes", 21), contrast = rep(NA, 21), estimate = rep(NA, 21), 
      std.error = rep(NA, 21), statistic = rep(NA, 21), p.value = rep(NA, 21), p.sig = rep(NA, 21)
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = NA, std.error = NA, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(subgroup = "dlow")

dat_deprepgs_interm <- cesd_iyes_adj_mi_deprepgs_re %>% 
  filter(deprepgs == "intermediate") %>%
  select(-deprepgs) %>%
  bind_rows(
    tibble(
      country = c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland"), 
      term = rep("internet_yesyes", 21), contrast = rep(NA, 21), estimate = rep(NA, 21), 
      std.error = rep(NA, 21), statistic = rep(NA, 21), p.value = rep(NA, 21), p.sig = rep(NA, 21)
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = NA, std.error = NA, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(subgroup = "dinterm")

dat_deprepgs_high <- cesd_iyes_adj_mi_deprepgs_re %>% 
  filter(deprepgs == "high") %>%
  select(-deprepgs) %>%
  bind_rows(
    tibble(
      country = c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland"), 
      term = rep("internet_yesyes", 21), contrast = rep(NA, 21), estimate = rep(NA, 21), 
      std.error = rep(NA, 21), statistic = rep(NA, 21), p.value = rep(NA, 21), p.sig = rep(NA, 21)
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = NA, std.error = NA, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(subgroup = "dhigh")

# Genetic risk: Subjective well-being PGS
dat_wellbpgs_low <- cesd_iyes_adj_mi_wellbpgs_re %>% 
  filter(wellbpgs == "low") %>%
  select(-wellbpgs) %>%
  bind_rows(
    tibble(
      country = c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland"), 
      term = rep("internet_yesyes", 21), contrast = rep(NA, 21), estimate = rep(NA, 21), 
      std.error = rep(NA, 21), statistic = rep(NA, 21), p.value = rep(NA, 21), p.sig = rep(NA, 21)
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = NA, std.error = NA, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(subgroup = "wlow")

dat_wellbpgs_interm <- cesd_iyes_adj_mi_wellbpgs_re %>% 
  filter(wellbpgs == "intermediate") %>%
  select(-wellbpgs) %>%
  bind_rows(
    tibble(
      country = c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland"), 
      term = rep("internet_yesyes", 21), contrast = rep(NA, 21), estimate = rep(NA, 21), 
      std.error = rep(NA, 21), statistic = rep(NA, 21), p.value = rep(NA, 21), p.sig = rep(NA, 21)
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = NA, std.error = NA, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(subgroup = "winterm")

dat_wellbpgs_high <- cesd_iyes_adj_mi_wellbpgs_re %>% 
  filter(wellbpgs == "high") %>%
  select(-wellbpgs) %>%
  bind_rows(
    tibble(
      country = c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland"), 
      term = rep("internet_yesyes", 21), contrast = rep(NA, 21), estimate = rep(NA, 21), 
      std.error = rep(NA, 21), statistic = rep(NA, 21), p.value = rep(NA, 21), p.sig = rep(NA, 21)
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = NA, std.error = NA, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(subgroup = "whigh")

dat <- dat_middle %>%
  bind_rows(., dat_old) %>%
  bind_rows(., dat_male) %>%
  bind_rows(., dat_female) %>%
  bind_rows(., dat_married) %>%
  bind_rows(., dat_nonmarried) %>%
  bind_rows(., dat_contact) %>%
  bind_rows(., dat_nocontact) %>%
  bind_rows(., dat_pedu) %>%
  bind_rows(., dat_sedu) %>%
  bind_rows(., dat_tedu) %>%
  bind_rows(., dat_lwealth) %>%
  bind_rows(., dat_mwealth) %>%
  bind_rows(., dat_hwealth) %>%
  bind_rows(., dat_work) %>%
  bind_rows(., dat_retired) %>%
  bind_rows(., dat_others) %>%
  bind_rows(., dat_smoke) %>%
  bind_rows(., dat_nosmoke) %>%
  bind_rows(., dat_drink) %>%
  bind_rows(., dat_nodrink) %>%
  bind_rows(., dat_phyinact) %>%
  bind_rows(., dat_phyact) %>%
  bind_rows(., dat_adl) %>%
  bind_rows(., dat_noadl) %>%
  bind_rows(., dat_dis) %>%
  bind_rows(., dat_nodis) %>%
  bind_rows(., dat_deprepgs_low) %>%
  bind_rows(., dat_deprepgs_interm) %>%
  bind_rows(., dat_deprepgs_high) %>%
  bind_rows(., dat_wellbpgs_low) %>%
  bind_rows(., dat_wellbpgs_interm) %>%
  bind_rows(., dat_wellbpgs_high) %>%
  mutate(
    country_italic = ifelse(country == "Overall", glue("***{country}***"), glue("{country}")),
    country_italic = factor(country_italic, levels = c("***Overall***", rev(dat_middle$country)[-1])),
    subgroup = 
      factor(
        subgroup, 
        levels = c("middle", "old", "male", "female", "married", "nonmarried", "contact", "nocontact", "pedu", "sedu", "tedu", "lwealth", "mwealth", "hwealth", "work", "retired", "others", "smoke", "nosmoke", "drink", "nodrink", "phyact", "phyinact", "noadl", "adl", "nodis", "dis", "dlow", "dinterm", "dhigh", "wlow", "winterm", "whigh"),
        labels = c("50-64 years", "≥65 years", "Male", "Female", "Married", "Unmarried", "Weekly contact", "Less than weekly contact", "Primary", "Secondary", "Tertiary", "Low", "Middle", "High", "Working", "Retired", "Others", "Current smoking", "No smoking", "Weekly alcohol use", "Less than weekly alcohol use", "Physical activity", "Physical inactivity", "No ADL limitation", "ADL disability", "No chronic conditions", "≥1 chronic condition", "Low genetic risk (DS)", "Intermediate genetic risk (DS)", "High genetic risk (DS)", "Low genetic risk (SWB)", "Intermediate genetic risk (SWB)", "High genetic risk (SWB)")
),
    estimate_new = case_when(
      estimate < -0.5 ~ -0.5,
      estimate > 0.5 ~ 0.5,
      TRUE ~ estimate
    ),
    estimate_text = sprintf("%0.2f", estimate),
    p.sig = ifelse(p.sig == 1, "*", p.sig),
    estimate_p.sig = str_c(estimate_text, p.sig),
    overall_p.sig = ifelse(country == "Overall", estimate_p.sig, NA)
  )

#### Plot ####
rect_cesd <- ggplot(dat, aes(x = subgroup, y = country_italic, fill = estimate_new)) +
  # geom_tile(colour = "grey50") +
  geom_tile(colour = "black") +
  geom_text(
    aes(label = overall_p.sig), size = 4, vjust = 0.7, 
    ) + 
  theme_void() +
  theme(
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.text.x = element_blank(),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 16, vjust = 1, angle = 90, face = "bold"),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = .5, l = .25), "cm"),
    plot.title = element_text(size = 16, hjust = .5)
    ) +
  scale_fill_gradientn(
    colours = c("#58539f", "#bbbbd6", "#FFFFFFFF", "#eebabb", "#d86967"),
    limit = c(-0.5, 0.5),
    breaks = c(-0.5, -0.25, 0, 0.25, 0.5),
    labels = c("≤-0.5", -0.25, 0, 0.25, "≥0.5"),
    name = "AME",
    na.value = "#DCDCDC"
    ) +
  labs(
    x = NULL,
    y = NULL,
    title = NULL,
    labels = "AME"
  ) + 
  annotate(geom = "rect", xmin = 0.5, xmax = 2.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#FF9D9AFF") +
  annotate(geom = "rect", xmin = 2.5, xmax = 4.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#E15759FF") +
  annotate(geom = "rect", xmin = 4.5, xmax = 6.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#A0CBE8FF") +
  annotate(geom = "rect", xmin = 6.5, xmax = 8.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#4E79A7FF") +
  annotate(geom = "rect", xmin = 8.5, xmax = 11.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#FFBE7DFF") +
  annotate(geom = "rect", xmin = 11.5, xmax = 14.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#F28E2BFF") +
  annotate(geom = "rect", xmin = 14.5, xmax = 17.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#8CD17DFF") + 
  annotate(geom = "rect", xmin = 17.5, xmax = 19.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#59A14FFF") +
  annotate(geom = "rect", xmin = 19.5, xmax = 21.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#D7B5A6FF") +
  annotate(geom = "rect", xmin = 21.5, xmax = 23.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#9D7660FF") +
  annotate(geom = "rect", xmin = 23.5, xmax = 25.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#FABFD2FF") +
  annotate(geom = "rect", xmin = 25.5, xmax = 27.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#D37295FF") +
  annotate(geom = "rect", xmin = 27.5, xmax = 30.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#F1CE63FF") +
  annotate(geom = "rect", xmin = 30.5, xmax = 33.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#B6992DFF")

# library(paletteer)
# paletteer_d("ggthemes::Tableau_20")

rect_cesd_nopgs <- ggplot(dat %>% filter(!subgroup %in% c("Low genetic risk (DS)", "Intermediate genetic risk (DS)", "High genetic risk (DS)", "Low genetic risk (SWB)", "Intermediate genetic risk (SWB)", "High genetic risk (SWB)")), aes(x = subgroup, y = country_italic, fill = estimate_new)) +
  # geom_tile(colour = "grey50") +
  geom_tile(colour = "black") +
  geom_text(
    aes(label = overall_p.sig), size = 4, vjust = 0.7, 
    ) + 
  theme_void() +
  theme(
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.text.x = element_blank(),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 16, vjust = 1, angle = 90, face = "bold"),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = .5, l = .25), "cm"),
    plot.title = element_text(size = 16, hjust = .5)
    ) +
  scale_fill_gradientn(
    colours = c("#58539f", "#bbbbd6", "#FFFFFFFF", "#eebabb", "#d86967"),
    limit = c(-0.5, 0.5),
    breaks = c(-0.5, -0.25, 0, 0.25, 0.5),
    labels = c("≤-0.5", -0.25, 0, 0.25, "≥0.5"),
    name = "AME",
    na.value = "#DCDCDC"
    ) +
  labs(
    x = NULL,
    y = NULL,
    title = NULL,
    labels = "AME"
  ) + 
  annotate(geom = "rect", xmin = 0.5, xmax = 2.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#FF9D9AFF") +
  annotate(geom = "rect", xmin = 2.5, xmax = 4.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#E15759FF") +
  annotate(geom = "rect", xmin = 4.5, xmax = 6.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#A0CBE8FF") +
  annotate(geom = "rect", xmin = 6.5, xmax = 8.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#4E79A7FF") +
  annotate(geom = "rect", xmin = 8.5, xmax = 11.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#FFBE7DFF") +
  annotate(geom = "rect", xmin = 11.5, xmax = 14.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#F28E2BFF") +
  annotate(geom = "rect", xmin = 14.5, xmax = 17.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#8CD17DFF") + 
  annotate(geom = "rect", xmin = 17.5, xmax = 19.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#59A14FFF") +
  annotate(geom = "rect", xmin = 19.5, xmax = 21.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#D7B5A6FF") +
  annotate(geom = "rect", xmin = 21.5, xmax = 23.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#9D7660FF") +
  annotate(geom = "rect", xmin = 23.5, xmax = 25.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#FABFD2FF") +
  annotate(geom = "rect", xmin = 25.5, xmax = 27.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#D37295FF")

#### Table with confidence intervals ####
dat_table <- dat %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f\n[%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = case_when(
      is.na(estimate) ~ NA,
      !is.na(estimate) & p.value >= 0.05 ~ beta_ci,
      !is.na(estimate) & p.value < 0.05 ~ str_c(beta_ci, p.sig),
      TRUE ~ NA_character_
    )
  ) %>%
  select(country, subgroup, beta_ci) %>%
  pivot_wider(names_from = subgroup, values_from = beta_ci)

write_csv(dat_table, str_c(getwd(), "/results/Table/Supplementary Table 6_Subgroup effect sizes (CI) for depressive symptoms.csv"))

```

### Life satisfaction

```{r}

#### Data preparation ####
# Age
dat_middle <- satlife_iyes_adj_mi_middle_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA, 
      estimate = as.numeric(satlife_iyes_adj_mi_middle_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_mi_middle_meta$se), 
      statistic = NA, 
      p.value = satlife_iyes_adj_mi_middle_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "middle")
  
dat_old <- satlife_iyes_adj_mi_old_results %>% 
  bind_rows(
    tibble(
      country = "Poland", term = NA, contrast = NA,
      estimate = NA, std.error = NA, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(satlife_iyes_adj_mi_old_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_mi_old_meta$se), 
      statistic = NA, 
      p.value = satlife_iyes_adj_mi_old_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "old")

# Gender
dat_male <- satlife_iyes_adj_mi_male_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(satlife_iyes_adj_mi_male_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_mi_male_meta$se), 
      statistic = NA, 
      p.value = satlife_iyes_adj_mi_male_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "male")

dat_female <- satlife_iyes_adj_mi_female_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(satlife_iyes_adj_mi_female_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_mi_female_meta$se), 
      statistic = NA, 
      p.value = satlife_iyes_adj_mi_female_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "female")

# Marital status
dat_married <- satlife_iyes_adj_mi_married_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(satlife_iyes_adj_mi_married_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_mi_married_meta$se), 
      statistic = NA, 
      p.value = satlife_iyes_adj_mi_married_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "married")

dat_nonmarried <- satlife_iyes_adj_mi_nonmarried_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(satlife_iyes_adj_mi_nonmarried_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_mi_nonmarried_meta$se), 
      statistic = NA, 
      p.value = satlife_iyes_adj_mi_nonmarried_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "nonmarried")

# Contact with others
dat_contact <- satlife_iyes_adj_mi_contact_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(satlife_iyes_adj_mi_contact_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_mi_contact_meta$se), 
      statistic = NA, 
      p.value = satlife_iyes_adj_mi_contact_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "contact")

dat_nocontact <- satlife_iyes_adj_mi_nocontact_results %>%
  bind_rows(
    tibble(
      country = "Poland", term = NA, contrast = NA,
      estimate = NA, std.error = NA, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(satlife_iyes_adj_mi_nocontact_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_mi_nocontact_meta$se), 
      statistic = NA, 
      p.value = satlife_iyes_adj_mi_nocontact_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "nocontact")

# Education
dat_pedu <- satlife_iyes_adj_mi_pedu_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(satlife_iyes_adj_mi_pedu_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_mi_pedu_meta$se), 
      statistic = NA, 
      p.value = satlife_iyes_adj_mi_pedu_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "pedu")

dat_sedu <- satlife_iyes_adj_mi_sedu_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(satlife_iyes_adj_mi_sedu_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_mi_sedu_meta$se), 
      statistic = NA, 
      p.value = satlife_iyes_adj_mi_sedu_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "sedu")

dat_tedu <- satlife_iyes_adj_mi_tedu_results %>% 
  bind_rows(
    tibble(
      country = "Poland", term = NA, contrast = NA,
      estimate = NA, std.error = NA, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(satlife_iyes_adj_mi_tedu_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_mi_tedu_meta$se), 
      statistic = NA, 
      p.value = satlife_iyes_adj_mi_tedu_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "tedu")

# Household wealth
dat_lwealth <- satlife_iyes_adj_mi_lwealth_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(satlife_iyes_adj_mi_lwealth_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_mi_lwealth_meta$se), 
      statistic = NA, 
      p.value = satlife_iyes_adj_mi_lwealth_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "lwealth")

dat_mwealth <- satlife_iyes_adj_mi_mwealth_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(satlife_iyes_adj_mi_mwealth_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_mi_mwealth_meta$se), 
      statistic = NA, 
      p.value = satlife_iyes_adj_mi_mwealth_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "mwealth")

dat_hwealth <- satlife_iyes_adj_mi_hwealth_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(satlife_iyes_adj_mi_hwealth_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_mi_hwealth_meta$se), 
      statistic = NA, 
      p.value = satlife_iyes_adj_mi_hwealth_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "hwealth")

# Labor force status
dat_work <- satlife_iyes_adj_mi_work_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(satlife_iyes_adj_mi_work_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_mi_work_meta$se), 
      statistic = NA, 
      p.value = satlife_iyes_adj_mi_work_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "work")

dat_retired <- satlife_iyes_adj_mi_retired_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(satlife_iyes_adj_mi_retired_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_mi_retired_meta$se), 
      statistic = NA, 
      p.value = satlife_iyes_adj_mi_retired_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "retired")

dat_others <- satlife_iyes_adj_mi_others_results %>% 
  bind_rows(
    tibble(
      country = "China", term = NA, 
      estimate = NA, std.error = NA, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(satlife_iyes_adj_mi_others_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_mi_others_meta$se), 
      statistic = NA, 
      p.value = satlife_iyes_adj_mi_others_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "others")

# Current smoking
dat_smoke <- satlife_iyes_adj_mi_smoke_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(satlife_iyes_adj_mi_smoke_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_mi_smoke_meta$se), 
      statistic = NA, 
      p.value = satlife_iyes_adj_mi_smoke_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "smoke")

dat_nosmoke <- satlife_iyes_adj_mi_nosmoke_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(satlife_iyes_adj_mi_nosmoke_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_mi_nosmoke_meta$se), 
      statistic = NA, 
      p.value = satlife_iyes_adj_mi_nosmoke_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "nosmoke")

# Alcohol consumption
dat_drink <- satlife_iyes_adj_mi_drink_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(satlife_iyes_adj_mi_drink_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_mi_drink_meta$se), 
      statistic = NA, 
      p.value = satlife_iyes_adj_mi_drink_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "drink")

dat_nodrink <- satlife_iyes_adj_mi_nodrink_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(satlife_iyes_adj_mi_nodrink_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_mi_nodrink_meta$se), 
      statistic = NA, 
      p.value = satlife_iyes_adj_mi_nodrink_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "nodrink")

# Physical activity
dat_phyinact <- satlife_iyes_adj_mi_phyinact_results %>% 
  bind_rows(
    tibble(
      country = "Poland", term = NA, contrast = NA,
      estimate = NA, std.error = NA, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(satlife_iyes_adj_mi_phyinact_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_mi_phyinact_meta$se), 
      statistic = NA, 
      p.value = satlife_iyes_adj_mi_phyinact_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "phyinact")

dat_phyact <- satlife_iyes_adj_mi_phyact_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(satlife_iyes_adj_mi_phyact_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_mi_phyact_meta$se), 
      statistic = NA, 
      p.value = satlife_iyes_adj_mi_phyact_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "phyact")

# ADL disability
dat_adl <- satlife_iyes_adj_mi_adl_results %>% 
  bind_rows(
    tibble(
      country = "Poland", term = NA, contrast = NA,
      estimate = NA, std.error = NA, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(satlife_iyes_adj_mi_adl_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_mi_adl_meta$se), 
      statistic = NA, 
      p.value = satlife_iyes_adj_mi_adl_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "adl")

dat_noadl <- satlife_iyes_adj_mi_noadl_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(satlife_iyes_adj_mi_noadl_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_mi_noadl_meta$se), 
      statistic = NA, 
      p.value = satlife_iyes_adj_mi_noadl_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "noadl")

# Chronic conditions
dat_dis <- satlife_iyes_adj_mi_dis_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(satlife_iyes_adj_mi_dis_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_mi_dis_meta$se), 
      statistic = NA, 
      p.value = satlife_iyes_adj_mi_dis_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "dis")

dat_nodis <- satlife_iyes_adj_mi_nodis_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(satlife_iyes_adj_mi_nodis_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_mi_nodis_meta$se), 
      statistic = NA, 
      p.value = satlife_iyes_adj_mi_nodis_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "nodis")

# Genetic risk: Depressive symptoms PGS
dat_deprepgs_low <- satlife_iyes_adj_mi_deprepgs_re %>% 
  filter(deprepgs == "low") %>%
  select(-deprepgs) %>%
  bind_rows(
    tibble(
      country = c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland"), 
      term = rep("internet_yesyes", 21), contrast = rep(NA, 21), estimate = rep(NA, 21), 
      std.error = rep(NA, 21), statistic = rep(NA, 21), p.value = rep(NA, 21), p.sig = rep(NA, 21)
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = NA, std.error = NA, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(subgroup = "dlow")

dat_deprepgs_interm <- satlife_iyes_adj_mi_deprepgs_re %>% 
  filter(deprepgs == "intermediate") %>%
  select(-deprepgs) %>%
  bind_rows(
    tibble(
      country = c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland"), 
      term = rep("internet_yesyes", 21), contrast = rep(NA, 21), estimate = rep(NA, 21), 
      std.error = rep(NA, 21), statistic = rep(NA, 21), p.value = rep(NA, 21), p.sig = rep(NA, 21)
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = NA, std.error = NA, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(subgroup = "dinterm")

dat_deprepgs_high <- satlife_iyes_adj_mi_deprepgs_re %>% 
  filter(deprepgs == "high") %>%
  select(-deprepgs) %>%
  bind_rows(
    tibble(
      country = c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland"), 
      term = rep("internet_yesyes", 21), contrast = rep(NA, 21), estimate = rep(NA, 21), 
      std.error = rep(NA, 21), statistic = rep(NA, 21), p.value = rep(NA, 21), p.sig = rep(NA, 21)
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = NA, std.error = NA, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(subgroup = "dhigh")

# Genetic risk: Subjective well-being PGS
dat_wellbpgs_low <- satlife_iyes_adj_mi_wellbpgs_re %>% 
  filter(wellbpgs == "low") %>%
  select(-wellbpgs) %>%
  bind_rows(
    tibble(
      country = c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland"), 
      term = rep("internet_yesyes", 21), contrast = rep(NA, 21), estimate = rep(NA, 21), 
      std.error = rep(NA, 21), statistic = rep(NA, 21), p.value = rep(NA, 21), p.sig = rep(NA, 21)
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = NA, std.error = NA, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(subgroup = "wlow")

dat_wellbpgs_interm <- satlife_iyes_adj_mi_wellbpgs_re %>% 
  filter(wellbpgs == "intermediate") %>%
  select(-wellbpgs) %>%
  bind_rows(
    tibble(
      country = c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland"), 
      term = rep("internet_yesyes", 21), contrast = rep(NA, 21), estimate = rep(NA, 21), 
      std.error = rep(NA, 21), statistic = rep(NA, 21), p.value = rep(NA, 21), p.sig = rep(NA, 21)
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = NA, std.error = NA, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(subgroup = "winterm")

dat_wellbpgs_high <- satlife_iyes_adj_mi_wellbpgs_re %>% 
  filter(wellbpgs == "high") %>%
  select(-wellbpgs) %>%
  bind_rows(
    tibble(
      country = c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland"), 
      term = rep("internet_yesyes", 21), contrast = rep(NA, 21), estimate = rep(NA, 21), 
      std.error = rep(NA, 21), statistic = rep(NA, 21), p.value = rep(NA, 21), p.sig = rep(NA, 21)
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = NA, std.error = NA, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(subgroup = "whigh")

dat <- dat_middle %>%
  bind_rows(., dat_old) %>%
  bind_rows(., dat_male) %>%
  bind_rows(., dat_female) %>%
  bind_rows(., dat_married) %>%
  bind_rows(., dat_nonmarried) %>%
  bind_rows(., dat_contact) %>%
  bind_rows(., dat_nocontact) %>%
  bind_rows(., dat_pedu) %>%
  bind_rows(., dat_sedu) %>%
  bind_rows(., dat_tedu) %>%
  bind_rows(., dat_lwealth) %>%
  bind_rows(., dat_mwealth) %>%
  bind_rows(., dat_hwealth) %>%
  bind_rows(., dat_work) %>%
  bind_rows(., dat_retired) %>%
  bind_rows(., dat_others) %>%
  bind_rows(., dat_smoke) %>%
  bind_rows(., dat_nosmoke) %>%
  bind_rows(., dat_drink) %>%
  bind_rows(., dat_nodrink) %>%
  bind_rows(., dat_phyinact) %>%
  bind_rows(., dat_phyact) %>%
  bind_rows(., dat_adl) %>%
  bind_rows(., dat_noadl) %>%
  bind_rows(., dat_dis) %>%
  bind_rows(., dat_nodis) %>%
  bind_rows(., dat_deprepgs_low) %>%
  bind_rows(., dat_deprepgs_interm) %>%
  bind_rows(., dat_deprepgs_high) %>%
  bind_rows(., dat_wellbpgs_low) %>%
  bind_rows(., dat_wellbpgs_interm) %>%
  bind_rows(., dat_wellbpgs_high) %>%
  mutate(
    country_italic = ifelse(country == "Overall", glue("***{country}***"), glue("{country}")),
    country_italic = factor(country_italic, levels = c("***Overall***", rev(dat_middle$country)[-1])),
    subgroup = 
      factor(
        subgroup, 
        levels = c("middle", "old", "male", "female", "married", "nonmarried", "contact", "nocontact", "pedu", "sedu", "tedu", "lwealth", "mwealth", "hwealth", "work", "retired", "others", "smoke", "nosmoke", "drink", "nodrink", "phyact", "phyinact", "noadl", "adl", "nodis", "dis", "dlow", "dinterm", "dhigh", "wlow", "winterm", "whigh"),
        labels = c("50-64 years", "≥65 years", "Male", "Female", "Married", "Unmarried", "Weekly contact", "Less than weekly contact", "Primary", "Secondary", "Tertiary", "Low", "Middle", "High", "Working", "Retired", "Others", "Current smoking", "No smoking", "Weekly alcohol use", "Less than weekly alcohol use", "Physical activity", "Physical inactivity", "No ADL limitation", "ADL disability", "No chronic conditions", "≥1 chronic condition", "Low genetic risk (DS)", "Intermediate genetic risk (DS)", "High genetic risk (DS)", "Low genetic risk (SWB)", "Intermediate genetic risk (SWB)", "High genetic risk (SWB)")
),
    estimate_new = case_when(
      estimate < -0.5 ~ -0.5,
      estimate > 0.5 ~ 0.5,
      TRUE ~ estimate
    ),
    estimate_text = sprintf("%0.2f", estimate),
    p.sig = ifelse(p.sig == 1, "*", p.sig),
    estimate_p.sig = str_c(estimate_text, p.sig),
    overall_p.sig = ifelse(country == "Overall", estimate_p.sig, NA)
  )

#### Plot ####
rect_satlife <- ggplot(dat, aes(x = subgroup, y = country_italic, fill = estimate_new)) +
  # geom_tile(colour = "grey50") +
  geom_tile(colour = "black") +
  geom_text(
    aes(label = overall_p.sig), size = 4, vjust = 0.7, 
    ) + 
  theme_void() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", hjust = 1, vjust = 1, angle = 45),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 16, vjust = 1, angle = 90, face = "bold"),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = .5, l = .25), "cm"),
    plot.title = element_text(size = 16, hjust = .5)
    ) +
  scale_fill_gradientn(
    colours = c("#58539f", "#bbbbd6", "#FFFFFFFF", "#eebabb", "#d86967"),
    limit = c(-0.5, 0.5),
    breaks = c(-0.5, -0.25, 0, 0.25, 0.5),
    labels = c("≤-0.5", -0.25, 0, 0.25, "≥0.5"),
    name = "AME",
    na.value = "#DCDCDC"
    ) +
  labs(
    x = NULL,
    y = NULL,
    title = NULL,
    labels = "AME"
  ) + 
  annotate(geom = "rect", xmin = 0.5, xmax = 2.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#FF9D9AFF") +
  annotate(geom = "rect", xmin = 2.5, xmax = 4.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#E15759FF") +
  annotate(geom = "rect", xmin = 4.5, xmax = 6.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#A0CBE8FF") +
  annotate(geom = "rect", xmin = 6.5, xmax = 8.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#4E79A7FF") +
  annotate(geom = "rect", xmin = 8.5, xmax = 11.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#FFBE7DFF") +
  annotate(geom = "rect", xmin = 11.5, xmax = 14.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#F28E2BFF") +
  annotate(geom = "rect", xmin = 14.5, xmax = 17.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#8CD17DFF") + 
  annotate(geom = "rect", xmin = 17.5, xmax = 19.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#59A14FFF") +
  annotate(geom = "rect", xmin = 19.5, xmax = 21.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#D7B5A6FF") +
  annotate(geom = "rect", xmin = 21.5, xmax = 23.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#9D7660FF") +
  annotate(geom = "rect", xmin = 23.5, xmax = 25.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#FABFD2FF") +
  annotate(geom = "rect", xmin = 25.5, xmax = 27.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#D37295FF") +
  annotate(geom = "rect", xmin = 27.5, xmax = 30.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#F1CE63FF") +
  annotate(geom = "rect", xmin = 30.5, xmax = 33.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#B6992DFF")


rect_satlife_nopgs <- ggplot(dat %>% filter(!subgroup %in% c("Low genetic risk (DS)", "Intermediate genetic risk (DS)", "High genetic risk (DS)", "Low genetic risk (SWB)", "Intermediate genetic risk (SWB)", "High genetic risk (SWB)")), aes(x = subgroup, y = country_italic, fill = estimate_new)) +
  # geom_tile(colour = "grey50") +
  geom_tile(colour = "black") +
  geom_text(
    aes(label = overall_p.sig), size = 4, vjust = 0.7, 
    ) + 
  theme_void() +
  theme(
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", hjust = 1, vjust = 1, angle = 45),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 16, vjust = 1, angle = 90, face = "bold"),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = .5, l = .25), "cm"),
    plot.title = element_text(size = 16, hjust = .5)
    ) +
  scale_fill_gradientn(
    colours = c("#58539f", "#bbbbd6", "#FFFFFFFF", "#eebabb", "#d86967"),
    limit = c(-0.5, 0.5),
    breaks = c(-0.5, -0.25, 0, 0.25, 0.5),
    labels = c("≤-0.5", -0.25, 0, 0.25, "≥0.5"),
    name = "AME",
    na.value = "#DCDCDC"
    ) +
  labs(
    x = NULL,
    y = NULL,
    title = NULL,
    labels = "AME"
  ) + 
  annotate(geom = "rect", xmin = 0.5, xmax = 2.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#FF9D9AFF") +
  annotate(geom = "rect", xmin = 2.5, xmax = 4.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#E15759FF") +
  annotate(geom = "rect", xmin = 4.5, xmax = 6.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#A0CBE8FF") +
  annotate(geom = "rect", xmin = 6.5, xmax = 8.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#4E79A7FF") +
  annotate(geom = "rect", xmin = 8.5, xmax = 11.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#FFBE7DFF") +
  annotate(geom = "rect", xmin = 11.5, xmax = 14.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#F28E2BFF") +
  annotate(geom = "rect", xmin = 14.5, xmax = 17.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#8CD17DFF") + 
  annotate(geom = "rect", xmin = 17.5, xmax = 19.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#59A14FFF") +
  annotate(geom = "rect", xmin = 19.5, xmax = 21.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#D7B5A6FF") +
  annotate(geom = "rect", xmin = 21.5, xmax = 23.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#9D7660FF") +
  annotate(geom = "rect", xmin = 23.5, xmax = 25.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#FABFD2FF") +
  annotate(geom = "rect", xmin = 25.5, xmax = 27.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#D37295FF")

#### Table with confidence intervals ####
dat_table <- dat %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f\n[%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = case_when(
      is.na(estimate) ~ NA,
      !is.na(estimate) & p.value >= 0.05 ~ beta_ci,
      !is.na(estimate) & p.value < 0.05 ~ str_c(beta_ci, p.sig),
      TRUE ~ NA_character_
    )
  ) %>%
  select(country, subgroup, beta_ci) %>%
  pivot_wider(names_from = subgroup, values_from = beta_ci)

write_csv(dat_table, str_c(getwd(), "/results/Table/Supplementary Table 7_Subgroup effect sizes (CI) for life satisfaction.csv"))

```

### Self-rated health

```{r}

#### Data preparation ####
# Age
dat_middle <- shlt_iyes_adj_mi_middle_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(shlt_iyes_adj_mi_middle_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_mi_middle_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_mi_middle_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "middle")
  
dat_old <- shlt_iyes_adj_mi_old_results %>% 
  bind_rows(
    tibble(
      country = "Poland", term = NA, contrast = NA,
      estimate = NA, std.error = NA, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(shlt_iyes_adj_mi_old_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_mi_old_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_mi_old_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "old")

# Gender
dat_male <- shlt_iyes_adj_mi_male_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(shlt_iyes_adj_mi_male_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_mi_male_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_mi_male_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "male")

dat_female <- shlt_iyes_adj_mi_female_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(shlt_iyes_adj_mi_female_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_mi_female_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_mi_female_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "female")

# Marital status
dat_married <- shlt_iyes_adj_mi_married_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(shlt_iyes_adj_mi_married_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_mi_married_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_mi_married_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "married")

dat_nonmarried <- shlt_iyes_adj_mi_nonmarried_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(shlt_iyes_adj_mi_nonmarried_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_mi_nonmarried_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_mi_nonmarried_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "nonmarried")

# Contact with others
dat_contact <- shlt_iyes_adj_mi_contact_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(shlt_iyes_adj_mi_contact_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_mi_contact_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_mi_contact_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "contact")

dat_nocontact <- shlt_iyes_adj_mi_nocontact_results %>%
  bind_rows(
    tibble(
      country = "Poland", term = NA, contrast = NA,
      estimate = NA, std.error = NA, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(shlt_iyes_adj_mi_nocontact_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_mi_nocontact_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_mi_nocontact_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "nocontact")

# Education
dat_pedu <- shlt_iyes_adj_mi_pedu_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(shlt_iyes_adj_mi_pedu_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_mi_pedu_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_mi_pedu_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "pedu")

dat_sedu <- shlt_iyes_adj_mi_sedu_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(shlt_iyes_adj_mi_sedu_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_mi_sedu_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_mi_sedu_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "sedu")

dat_tedu <- shlt_iyes_adj_mi_tedu_results %>% 
  bind_rows(
    tibble(
      country = "Poland", term = NA, contrast = NA,
      estimate = NA, std.error = NA, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(shlt_iyes_adj_mi_tedu_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_mi_tedu_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_mi_tedu_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "tedu")

# Household wealth
dat_lwealth <- shlt_iyes_adj_mi_lwealth_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(shlt_iyes_adj_mi_lwealth_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_mi_lwealth_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_mi_lwealth_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "lwealth")

dat_mwealth <- shlt_iyes_adj_mi_mwealth_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(shlt_iyes_adj_mi_mwealth_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_mi_mwealth_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_mi_mwealth_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "mwealth")

dat_hwealth <- shlt_iyes_adj_mi_hwealth_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(shlt_iyes_adj_mi_hwealth_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_mi_hwealth_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_mi_hwealth_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "hwealth")

# Labor force status
dat_work <- shlt_iyes_adj_mi_work_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(shlt_iyes_adj_mi_work_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_mi_work_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_mi_work_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "work")

dat_retired <- shlt_iyes_adj_mi_retired_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(shlt_iyes_adj_mi_retired_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_mi_retired_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_mi_retired_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "retired")

dat_others <- shlt_iyes_adj_mi_others_results %>% 
  bind_rows(
    tibble(
      country = "China", term = NA, 
      estimate = NA, std.error = NA, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(shlt_iyes_adj_mi_others_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_mi_others_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_mi_others_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "others")

# Current smoking
dat_smoke <- shlt_iyes_adj_mi_smoke_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(shlt_iyes_adj_mi_smoke_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_mi_smoke_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_mi_smoke_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "smoke")

dat_nosmoke <- shlt_iyes_adj_mi_nosmoke_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(shlt_iyes_adj_mi_nosmoke_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_mi_nosmoke_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_mi_nosmoke_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "nosmoke")

# Alcohol consumption
dat_drink <- shlt_iyes_adj_mi_drink_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(shlt_iyes_adj_mi_drink_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_mi_drink_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_mi_drink_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "drink")

dat_nodrink <- shlt_iyes_adj_mi_nodrink_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(shlt_iyes_adj_mi_nodrink_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_mi_nodrink_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_mi_nodrink_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "nodrink")

# Physical activity
dat_phyinact <- shlt_iyes_adj_mi_phyinact_results %>% 
  bind_rows(
    tibble(
      country = "Poland", term = NA, contrast = NA,
      estimate = NA, std.error = NA, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(shlt_iyes_adj_mi_phyinact_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_mi_phyinact_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_mi_phyinact_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "phyinact")

dat_phyact <- shlt_iyes_adj_mi_phyact_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(shlt_iyes_adj_mi_phyact_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_mi_phyact_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_mi_phyact_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "phyact")

# ADL disability
dat_adl <- shlt_iyes_adj_mi_adl_results %>% 
  bind_rows(
    tibble(
      country = "Poland", term = NA, contrast = NA,
      estimate = NA, std.error = NA, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(shlt_iyes_adj_mi_adl_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_mi_adl_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_mi_adl_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "adl")

dat_noadl <- shlt_iyes_adj_mi_noadl_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(shlt_iyes_adj_mi_noadl_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_mi_noadl_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_mi_noadl_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "noadl")

# Chronic conditions
dat_dis <- shlt_iyes_adj_mi_dis_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(shlt_iyes_adj_mi_dis_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_mi_dis_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_mi_dis_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "dis")

dat_nodis <- shlt_iyes_adj_mi_nodis_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(shlt_iyes_adj_mi_nodis_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_mi_nodis_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_mi_nodis_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "nodis")

# Genetic risk: Depressive symptoms PGS
dat_deprepgs_low <- shlt_iyes_adj_mi_deprepgs_re %>% 
  filter(deprepgs == "low") %>%
  select(-deprepgs) %>%
  bind_rows(
    tibble(
      country = c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland"), 
      term = rep("internet_yesyes", 21), contrast = rep(NA, 21), estimate = rep(NA, 21), 
      std.error = rep(NA, 21), statistic = rep(NA, 21), p.value = rep(NA, 21), p.sig = rep(NA, 21)
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = NA, std.error = NA, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(subgroup = "dlow")

dat_deprepgs_interm <- shlt_iyes_adj_mi_deprepgs_re %>% 
  filter(deprepgs == "intermediate") %>%
  select(-deprepgs) %>%
  bind_rows(
    tibble(
      country = c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland"), 
      term = rep("internet_yesyes", 21), contrast = rep(NA, 21), estimate = rep(NA, 21), 
      std.error = rep(NA, 21), statistic = rep(NA, 21), p.value = rep(NA, 21), p.sig = rep(NA, 21)
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = NA, std.error = NA, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(subgroup = "dinterm")

dat_deprepgs_high <- shlt_iyes_adj_mi_deprepgs_re %>% 
  filter(deprepgs == "high") %>%
  select(-deprepgs) %>%
  bind_rows(
    tibble(
      country = c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland"), 
      term = rep("internet_yesyes", 21), contrast = rep(NA, 21), estimate = rep(NA, 21), 
      std.error = rep(NA, 21), statistic = rep(NA, 21), p.value = rep(NA, 21), p.sig = rep(NA, 21)
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = NA, std.error = NA, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(subgroup = "dhigh")

# Genetic risk: Subjective well-being PGS
dat_wellbpgs_low <- shlt_iyes_adj_mi_wellbpgs_re %>% 
  filter(wellbpgs == "low") %>%
  select(-wellbpgs) %>%
  bind_rows(
    tibble(
      country = c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland"), 
      term = rep("internet_yesyes", 21), contrast = rep(NA, 21), estimate = rep(NA, 21), 
      std.error = rep(NA, 21), statistic = rep(NA, 21), p.value = rep(NA, 21), p.sig = rep(NA, 21)
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = NA, std.error = NA, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(subgroup = "wlow")

dat_wellbpgs_interm <- shlt_iyes_adj_mi_wellbpgs_re %>% 
  filter(wellbpgs == "intermediate") %>%
  select(-wellbpgs) %>%
  bind_rows(
    tibble(
      country = c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland"), 
      term = rep("internet_yesyes", 21), contrast = rep(NA, 21), estimate = rep(NA, 21), 
      std.error = rep(NA, 21), statistic = rep(NA, 21), p.value = rep(NA, 21), p.sig = rep(NA, 21)
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = NA, std.error = NA, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(subgroup = "winterm")

dat_wellbpgs_high <- shlt_iyes_adj_mi_wellbpgs_re %>% 
  filter(wellbpgs == "high") %>%
  select(-wellbpgs) %>%
  bind_rows(
    tibble(
      country = c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland"), 
      term = rep("internet_yesyes", 21), contrast = rep(NA, 21), estimate = rep(NA, 21), 
      std.error = rep(NA, 21), statistic = rep(NA, 21), p.value = rep(NA, 21), p.sig = rep(NA, 21)
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = NA, std.error = NA, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(subgroup = "whigh")

dat <- dat_middle %>%
  bind_rows(., dat_old) %>%
  bind_rows(., dat_male) %>%
  bind_rows(., dat_female) %>%
  bind_rows(., dat_married) %>%
  bind_rows(., dat_nonmarried) %>%
  bind_rows(., dat_contact) %>%
  bind_rows(., dat_nocontact) %>%
  bind_rows(., dat_pedu) %>%
  bind_rows(., dat_sedu) %>%
  bind_rows(., dat_tedu) %>%
  bind_rows(., dat_lwealth) %>%
  bind_rows(., dat_mwealth) %>%
  bind_rows(., dat_hwealth) %>%
  bind_rows(., dat_work) %>%
  bind_rows(., dat_retired) %>%
  bind_rows(., dat_others) %>%
  bind_rows(., dat_smoke) %>%
  bind_rows(., dat_nosmoke) %>%
  bind_rows(., dat_drink) %>%
  bind_rows(., dat_nodrink) %>%
  bind_rows(., dat_phyinact) %>%
  bind_rows(., dat_phyact) %>%
  bind_rows(., dat_adl) %>%
  bind_rows(., dat_noadl) %>%
  bind_rows(., dat_dis) %>%
  bind_rows(., dat_nodis) %>%
  bind_rows(., dat_deprepgs_low) %>%
  bind_rows(., dat_deprepgs_interm) %>%
  bind_rows(., dat_deprepgs_high) %>%
  bind_rows(., dat_wellbpgs_low) %>%
  bind_rows(., dat_wellbpgs_interm) %>%
  bind_rows(., dat_wellbpgs_high) %>%
  mutate(
    country_italic = ifelse(country == "Overall", glue("***{country}***"), glue("{country}")),
    country_italic = factor(country_italic, levels = c("***Overall***", rev(dat_middle$country)[-1])),
    subgroup = 
      factor(
        subgroup, 
        levels = c("middle", "old", "male", "female", "married", "nonmarried", "contact", "nocontact", "pedu", "sedu", "tedu", "lwealth", "mwealth", "hwealth", "work", "retired", "others", "smoke", "nosmoke", "drink", "nodrink", "phyact", "phyinact", "noadl", "adl", "nodis", "dis", "dlow", "dinterm", "dhigh", "wlow", "winterm", "whigh"),
        labels = c("50-64 years", "≥65 years", "Male", "Female", "Married", "Unmarried", "Weekly contact", "Less than weekly contact", "Primary", "Secondary", "Tertiary", "Low", "Middle", "High", "Working", "Retired", "Others", "Current smoking", "No smoking", "Weekly alcohol use", "Less than weekly alcohol use", "Physical activity", "Physical inactivity", "No ADL limitation", "ADL disability", "No chronic conditions", "≥1 chronic condition", "Low genetic risk (DS)", "Intermediate genetic risk (DS)", "High genetic risk (DS)", "Low genetic risk (SWB)", "Intermediate genetic risk (SWB)", "High genetic risk (SWB)")
),
    estimate_new = case_when(
      estimate < -0.5 ~ -0.5,
      estimate > 0.5 ~ 0.5,
      TRUE ~ estimate
    ),
    estimate_text = sprintf("%0.2f", estimate),
    p.sig = ifelse(p.sig == 1, "*", p.sig),
    estimate_p.sig = str_c(estimate_text, p.sig),
    overall_p.sig = ifelse(country == "Overall", estimate_p.sig, NA)
  )

#### Plot ####
rect_shlt <- ggplot(dat, aes(x = subgroup, y = country_italic, fill = estimate_new)) +
  # geom_tile(colour = "grey50") +
  geom_tile(colour = "black") +
  geom_text(
    aes(label = overall_p.sig), size = 4, vjust = 0.7, 
    ) + 
  theme_void() +
  theme(
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", hjust = 1, vjust = 1, angle = 45),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 16, vjust = 1, angle = 90, face = "bold"),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = .5, l = .25), "cm"),
    plot.title = element_text(size = 16, hjust = .5)
    ) +
  scale_fill_gradientn(
    colours = c("#58539f", "#bbbbd6", "#FFFFFFFF", "#eebabb", "#d86967"),
    limit = c(-0.5, 0.5),
    breaks = c(-0.5, -0.25, 0, 0.25, 0.5),
    labels = c("≤-0.5", -0.25, 0, 0.25, "≥0.5"),
    name = "AME",
    na.value = "#DCDCDC"
    ) +
  labs(
    x = NULL,
    y = NULL,
    title = NULL,
    labels = "AME"
  ) + 
  annotate(geom = "rect", xmin = 0.5, xmax = 2.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#FF9D9AFF") +
  annotate(geom = "rect", xmin = 2.5, xmax = 4.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#E15759FF") +
  annotate(geom = "rect", xmin = 4.5, xmax = 6.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#A0CBE8FF") +
  annotate(geom = "rect", xmin = 6.5, xmax = 8.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#4E79A7FF") +
  annotate(geom = "rect", xmin = 8.5, xmax = 11.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#FFBE7DFF") +
  annotate(geom = "rect", xmin = 11.5, xmax = 14.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#F28E2BFF") +
  annotate(geom = "rect", xmin = 14.5, xmax = 17.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#8CD17DFF") + 
  annotate(geom = "rect", xmin = 17.5, xmax = 19.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#59A14FFF") +
  annotate(geom = "rect", xmin = 19.5, xmax = 21.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#D7B5A6FF") +
  annotate(geom = "rect", xmin = 21.5, xmax = 23.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#9D7660FF") +
  annotate(geom = "rect", xmin = 23.5, xmax = 25.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#FABFD2FF") +
  annotate(geom = "rect", xmin = 25.5, xmax = 27.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#D37295FF") +
  annotate(geom = "rect", xmin = 27.5, xmax = 30.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#F1CE63FF") +
  annotate(geom = "rect", xmin = 30.5, xmax = 33.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#B6992DFF")


rect_shlt_nopgs <- ggplot(dat %>% filter(!subgroup %in% c("Low genetic risk (DS)", "Intermediate genetic risk (DS)", "High genetic risk (DS)", "Low genetic risk (SWB)", "Intermediate genetic risk (SWB)", "High genetic risk (SWB)")), aes(x = subgroup, y = country_italic, fill = estimate_new)) +
  # geom_tile(colour = "grey50") +
  geom_tile(colour = "black") +
  geom_text(
    aes(label = overall_p.sig), size = 4, vjust = 0.7, 
    ) + 
  theme_void() +
  theme(
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", hjust = 1, vjust = 1, angle = 45),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 16, vjust = 1, angle = 90, face = "bold"),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = .5, l = .25), "cm"),
    plot.title = element_text(size = 16, hjust = .5)
    ) +
  scale_fill_gradientn(
    colours = c("#58539f", "#bbbbd6", "#FFFFFFFF", "#eebabb", "#d86967"),
    limit = c(-0.5, 0.5),
    breaks = c(-0.5, -0.25, 0, 0.25, 0.5),
    labels = c("≤-0.5", -0.25, 0, 0.25, "≥0.5"),
    name = "AME",
    na.value = "#DCDCDC"
    ) +
  labs(
    x = NULL,
    y = NULL,
    title = NULL,
    labels = "AME"
  ) + 
  annotate(geom = "rect", xmin = 0.5, xmax = 2.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#FF9D9AFF") +
  annotate(geom = "rect", xmin = 2.5, xmax = 4.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#E15759FF") +
  annotate(geom = "rect", xmin = 4.5, xmax = 6.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#A0CBE8FF") +
  annotate(geom = "rect", xmin = 6.5, xmax = 8.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#4E79A7FF") +
  annotate(geom = "rect", xmin = 8.5, xmax = 11.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#FFBE7DFF") +
  annotate(geom = "rect", xmin = 11.5, xmax = 14.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#F28E2BFF") +
  annotate(geom = "rect", xmin = 14.5, xmax = 17.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#8CD17DFF") + 
  annotate(geom = "rect", xmin = 17.5, xmax = 19.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#59A14FFF") +
  annotate(geom = "rect", xmin = 19.5, xmax = 21.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#D7B5A6FF") +
  annotate(geom = "rect", xmin = 21.5, xmax = 23.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#9D7660FF") +
  annotate(geom = "rect", xmin = 23.5, xmax = 25.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#FABFD2FF") +
  annotate(geom = "rect", xmin = 25.5, xmax = 27.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#D37295FF")


#### Table with confidence intervals ####
dat_table <- dat %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f\n[%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = case_when(
      is.na(estimate) ~ NA,
      !is.na(estimate) & p.value >= 0.05 ~ beta_ci,
      !is.na(estimate) & p.value < 0.05 ~ str_c(beta_ci, p.sig),
      TRUE ~ NA_character_
    )
  ) %>%
  select(country, subgroup, beta_ci) %>%
  pivot_wider(names_from = subgroup, values_from = beta_ci)

write_csv(dat_table, str_c(getwd(), "/results/Table/Supplementary Table 8_Subgroup effect sizes (CI) for self-reported health.csv"))

```

### Figure 2: Associations of Internet use frequency with mental health by subgroups

```{r}

dat_legend <- dat %>%  
  mutate(
    category = case_when(
      subgroup %in% c("50-64 years", "≥65 years") ~ "age",
      subgroup %in% c("Male", "Female") ~ "gender",
      subgroup %in% c("Married", "Unmarried") ~ "marital",
      subgroup %in% c("Weekly contact", "Less than weekly contact") ~ "contact",

      subgroup %in% c("Primary", "Secondary", "Tertiary") ~ "edu",
      subgroup %in% c("Low", "Middle", "High") ~ "wealth",
      subgroup %in% c("Working", "Retired", "Others") ~ "lbrf",
      
      subgroup %in% c("Current smoking", "No smoking") ~ "smoke",
      subgroup %in% c("Weekly alcohol use", "Less than weekly alcohol use") ~ "drink",
      subgroup %in% c("Physical activity", "Physical inactivity") ~ "phyact",
      
      subgroup %in% c("No chronic conditions", "≥1 chronic condition") ~ "disease",
      subgroup %in% c("No ADL limitation", "ADL disability") ~ "disability",
      
      subgroup %in% c("Low genetic risk (DS)", "Intermediate genetic risk (DS)", "High genetic risk (DS)") ~ "dpgs",
      subgroup %in% c("Low genetic risk (SWB)", "Intermediate genetic risk (SWB)", "High genetic risk (SWB)") ~ "wpgs",
      TRUE ~ NA_character_
    ),
    category = factor(category, levels = c("age", "gender", "marital", "contact", "edu", "wealth", "lbrf", "smoke", "drink", "phyact", "disease", "disability", "dpgs", "wpgs"), labels = c("Age", "Gender", "Marital status", "Contact with others", "Education", "Household wealth", "Labor force status", "Current smoking", "Alcohol consumption", "Physical activity status", "ADL disability", "Chronic conditions", "Depressive symptoms PGS", "Subjective well-being PGS"))
  )

legend_1 <- ggplot(dat_legend, aes(x = category, y = estimate, fill = category)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(
    values = c("#FF9D9AFF", "#E15759FF", "#A0CBE8FF", "#4E79A7FF", "#FFBE7DFF", "#F28E2BFF", "#8CD17DFF", "#59A14FFF", "#D7B5A6FF", "#9D7660FF", "#FABFD2FF", "#D37295FF", "#F1CE63FF", "#B6992DFF"),
  ) + 
  guides(fill = guide_legend(byrow = T)) +
  theme(
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "right",
    legend.key.size = unit(1.5, "lines")
    )
  
legend_2 <- ggplot(dat, aes(x = subgroup, y = country_italic, fill = estimate_new)) +
  geom_tile(colour = "grey50") +
  theme_void() +
  theme(
    legend.position = "right"
    ) +
  scale_fill_gradientn(
    colours = c("#58539f", "#bbbbd6", "#FFFFFFFF", "#eebabb", "#d86967"),
    limit = c(-0.5, 0.5),
    breaks = c(-0.5, -0.25, 0, 0.25, 0.5),
    labels = c("<-0.5", -0.25, 0, 0.25, ">0.5"),
    name = "AME"
    ) +
  labs(
    x = NULL,
    y = NULL,
    title = NULL
  ) & 
  guides(fill =
    guide_colourbar(
      barwidth = unit(0.3, "in"), barheight = unit(3, "in"),
      label.theme = element_text(size = 16, colour = "black", angle = 0),
      title.theme = element_text(size = 16, colour = "black", angle = 0, hjust = 0.1)
  )
)

rect_pool <- wrap_elements(
  wrap_elements(rect_cesd) + wrap_elements(rect_satlife) + 
    plot_layout(nrow = 2, heights = c(0.75, 1)) &
    plot_annotation(tag_levels = "a")
  )

design <- "
AAAAAAAAAA##
AAAAAAAAAABB
AAAAAAAAAABB
AAAAAAAAAAC#
AAAAAAAAAAC#
AAAAAAAAAA##
"

heatmap_pool <- wrap_plots(
  rect_pool, wrap_elements(get_legend(legend_1)), wrap_elements(get_legend(legend_2)), 
  design = design
  )

ggsave(str_c(getwd(), "/results/Figure/Figure 2_Heatmap.tiff"), plot = heatmap_pool, width = 20, height = 18, unit = "in", dpi = 300, device = "tiff")

ggsave(str_c(getwd(), "/results/Figure/Figure 2_Heatmap.pdf"), plot = heatmap_pool, width = 20, height = 18, unit = "in", dpi = 300, device = "pdf")

```

### Supplementary Figure 8: Associations of Internet use with self-reported health by subgroups

```{r}

design <- "
AAAAAAAAAABB
AAAAAAAAAAC#
"

# Self-reported health only
heatmap_shlt <- wrap_plots(
  rect_shlt, wrap_elements(get_legend(legend_1)), wrap_elements(get_legend(legend_2)), 
  design = design
  )

ggsave(str_c(getwd(), "/results/Figure/Supplementary Figure 8_Heatmap.tiff"), plot = heatmap_shlt, width = 20, height = 10, unit = "in", dpi = 300, device = "tiff")

rm(list = ls()[str_detect(string = ls(), pattern = "dat_")])
rm(list = ls()[str_detect(string = ls(), pattern = "rect_")])
rm(legend_1, legend_2, design, heatmap_pool, heatmap_shlt)

```


## Supplementary Table 9: Subgroup analyses by Internet use measures in the meta-analysis

```{r}

#### CES-D ####
cesd_binary <- rma(yi = estimate, sei = std.error, data = metareg_cesd_iyes_mi_adj, subset = measure == "binary")
cesd_freq <- rma(yi = estimate, sei = std.error, data = metareg_cesd_iyes_mi_adj, subset = measure == "frequency")
cesd_home <- rma(yi = estimate, sei = std.error, data = metareg_cesd_iyes_mi_adj, subset = measure == "home_level")

dat_comp_cesd <- tibble(
  estimate = c(coef(cesd_binary), coef(cesd_freq), coef(cesd_home)), 
  std.error = c(cesd_binary$se, cesd_freq$se, cesd_home$se),
  meta = c("binary", "frequency", "home_level"), 
  I2 = round(c(cesd_binary$I2, cesd_freq$I2, cesd_home$I2),3),
  tau2 = round(c(cesd_binary$tau2, cesd_freq$tau2, cesd_home$tau2),3),
  H2 = round(c(cesd_binary$H2, cesd_freq$H2, cesd_home$H2),3)
  ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    outcome = "cesd"
  )

measure_cesd_iyes_mi_adj_fe <- rma(estimate, sei = std.error, mods = ~ meta, method = "FE", data = dat_comp_cesd, digits = 3)

#### Life satisfaction ####
satlife_binary <- rma(yi = estimate, sei = std.error, data = metareg_satlife_iyes_mi_adj, subset = measure == "binary")
satlife_freq <- rma(yi = estimate, sei = std.error, data = metareg_satlife_iyes_mi_adj, subset = measure == "frequency")
satlife_home <- rma(yi = estimate, sei = std.error, data = metareg_satlife_iyes_mi_adj, subset = measure == "home_level")

dat_comp_satlife <- tibble(
  estimate = c(coef(satlife_binary), coef(satlife_freq), coef(satlife_home)), 
  std.error = c(satlife_binary$se, satlife_freq$se, satlife_home$se),
  meta = c("binary", "frequency", "home_level"), 
  I2 = round(c(satlife_binary$I2, satlife_freq$I2, satlife_home$I2),3),
  tau2 = round(c(satlife_binary$tau2, satlife_freq$tau2, satlife_home$tau2),3),
  H2 = round(c(satlife_binary$H2, satlife_freq$H2, satlife_home$H2),3)
  ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    outcome = "satlife"
  )

measure_satlife_iyes_mi_adj_fe <- rma(estimate, sei = std.error, mods = ~ meta, method = "FE", data = dat_comp_satlife, digits = 3)

#### Self-rated health ####
shlt_binary <- rma(yi = estimate, sei = std.error, data = metareg_shlt_iyes_mi_adj, subset = measure == "binary")
shlt_freq <- rma(yi = estimate, sei = std.error, data = metareg_shlt_iyes_mi_adj, subset = measure == "frequency")
shlt_home <- rma(yi = estimate, sei = std.error, data = metareg_shlt_iyes_mi_adj, subset = measure == "home_level")

dat_comp_shlt <- tibble(
  estimate = c(coef(shlt_binary), coef(shlt_freq), coef(shlt_home)), 
  std.error = c(shlt_binary$se, shlt_freq$se, shlt_home$se),
  meta = c("binary", "frequency", "home_level"), 
  I2 = round(c(shlt_binary$I2, shlt_freq$I2, shlt_home$I2),3),
  tau2 = round(c(shlt_binary$tau2, shlt_freq$tau2, shlt_home$tau2),3),
  H2 = round(c(shlt_binary$H2, shlt_freq$H2, shlt_home$H2),3)
  ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    outcome = "shlt"
  )

measure_shlt_iyes_mi_adj_fe <- rma(estimate, sei = std.error, mods = ~ meta, method = "FE", data = dat_comp_shlt, digits = 3)

dat_comp_all <- dat_comp_cesd %>%
  bind_rows(., dat_comp_satlife) %>%
  bind_rows(., dat_comp_shlt)

write.csv(dat_comp_all, file = str_c(getwd(), "/results/Table/Supplementary Table 9_Subgroup analyses by internet use measures.csv"))

rm(cesd_binary, cesd_freq, cesd_home, satlife_binary, satlife_freq, satlife_home, shlt_binary, shlt_freq, shlt_home, dat_comp_cesd, dat_comp_satlife, dat_comp_shlt, dat_comp_all, measure_cesd_iyes_mi_adj_fe, measure_satlife_iyes_mi_adj_fe, measure_shlt_iyes_mi_adj_fe)

```



# Internet use frequency

## Linear mixed model and meta analysis

```{r warning=FALSE}

#### Merge data ####
iso <- c(156, 826, 840)

names <- c("China", "England", "USA")

mi_ifreq_merge <- list()
for(i in 1:10){
  mi_ifreq <- mi_ifreq_hrs[[i]] %>% mutate(id = as.character(id)) %>% 
    bind_rows(., mi_ifreq_elsa[[i]] %>% mutate(id = as.character(id))) %>%
    bind_rows(., mi_ifreq_charls[[i]] %>% mutate(id = as.character(id))) %>%
    mutate(
      country_names = case_when(
        country == iso[1] ~ names[1],
        country == iso[2] ~ names[2],
        country == iso[3] ~ names[3]
      )
    )
  mi_ifreq_merge[[i]] <- mi_ifreq
  rm(mi_ifreq)
}

tic()
#### CES-D ####
cesd_ifreq_unadj_mi_results <- tibble()
for(i in 1:3){
  cesd_ifreq_unadj_mi <- lapply(mi_ifreq_merge, function(x){
    lmer(
      cesd_stand ~ internet_freq*cwave + (1 | id),
      data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'))
  })
  
  cesd_ifreq_unadj_mi_result <- lapply(seq_along(cesd_ifreq_unadj_mi), \(j) 
    marginaleffects::avg_comparisons(
      cesd_ifreq_unadj_mi[[j]], variables = "internet_freq", re.form = NA)
    ) %>%
    mice::pool() %>%
    tidy() %>%
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  
  cesd_ifreq_unadj_mi_results <- cesd_ifreq_unadj_mi_results %>% 
    bind_rows(., cesd_ifreq_unadj_mi_result)
  
  rm(cesd_ifreq_unadj_mi, cesd_ifreq_unadj_mi_result)
}

cesd_ifreq_adj_mi_results <- tibble()
for(i in 1:3){
  cesd_ifreq_adj_mi <- lapply(mi_ifreq_merge, function(x){
    lmer(
      cesd_stand ~ internet_freq*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'))
  })
  
  cesd_ifreq_adj_mi_result <- lapply(seq_along(cesd_ifreq_adj_mi), \(j) 
    marginaleffects::avg_comparisons(
      cesd_ifreq_adj_mi[[j]], variables = "internet_freq", re.form = NA)
    ) %>%
    mice::pool() %>%
    tidy() %>%
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  
  cesd_ifreq_adj_mi_results <- cesd_ifreq_adj_mi_results %>% 
    bind_rows(., cesd_ifreq_adj_mi_result)
  
  rm(cesd_ifreq_adj_mi, cesd_ifreq_adj_mi_result)
}

#### Life satisfaction ####
satlife_ifreq_unadj_mi_results <- tibble()
for(i in 1:3){
  satlife_ifreq_unadj_mi <- lapply(mi_ifreq_merge, function(x){
    lmer(
      satlife_stand ~ internet_freq*cwave + (1 | id),
      data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'))
  })
  
  satlife_ifreq_unadj_mi_result <- lapply(seq_along(satlife_ifreq_unadj_mi), \(j) 
    marginaleffects::avg_comparisons(
      satlife_ifreq_unadj_mi[[j]], variables = "internet_freq", re.form = NA)
    ) %>%
    mice::pool() %>%
    tidy() %>%
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  
  satlife_ifreq_unadj_mi_results <- satlife_ifreq_unadj_mi_results %>% 
    bind_rows(., satlife_ifreq_unadj_mi_result)
  
  rm(satlife_ifreq_unadj_mi, satlife_ifreq_unadj_mi_result)
}

satlife_ifreq_adj_mi_results <- tibble()
for(i in 1:3){
  satlife_ifreq_adj_mi <- lapply(mi_ifreq_merge, function(x){
    lmer(
      satlife_stand ~ internet_freq*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'))
  })
  
  satlife_ifreq_adj_mi_result <- lapply(seq_along(satlife_ifreq_adj_mi), \(j) 
    marginaleffects::avg_comparisons(
      satlife_ifreq_adj_mi[[j]], variables = "internet_freq", re.form = NA)
    ) %>%
    mice::pool() %>%
    tidy() %>%
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  
  satlife_ifreq_adj_mi_results <- satlife_ifreq_adj_mi_results %>% 
    bind_rows(., satlife_ifreq_adj_mi_result)
  
  rm(satlife_ifreq_adj_mi, satlife_ifreq_adj_mi_result)
}

#### Self-rated health ####
shlt_ifreq_unadj_mi_results <- tibble()
for(i in 1:3){
  shlt_ifreq_unadj_mi <- lapply(mi_ifreq_merge, function(x){
    lmer(
      shlt_stand ~ internet_freq*cwave + (1 | id),
      data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'))
  })
  
  shlt_ifreq_unadj_mi_result <- lapply(seq_along(shlt_ifreq_unadj_mi), \(j) 
    marginaleffects::avg_comparisons(
      shlt_ifreq_unadj_mi[[j]], variables = "internet_freq", re.form = NA)
    ) %>%
    mice::pool() %>%
    tidy() %>%
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  
  shlt_ifreq_unadj_mi_results <- shlt_ifreq_unadj_mi_results %>% 
    bind_rows(., shlt_ifreq_unadj_mi_result)
  
  rm(shlt_ifreq_unadj_mi, shlt_ifreq_unadj_mi_result)
}

shlt_ifreq_adj_mi_results <- tibble()
for(i in 1:3){
  shlt_ifreq_adj_mi <- lapply(mi_ifreq_merge, function(x){
    lmer(
      shlt_stand ~ internet_freq*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'))
  })
  
  shlt_ifreq_adj_mi_result <- lapply(seq_along(shlt_ifreq_adj_mi), \(j) 
    marginaleffects::avg_comparisons(
      shlt_ifreq_adj_mi[[j]], variables = "internet_freq", re.form = NA)
    ) %>%
    mice::pool() %>%
    tidy() %>%
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  
  shlt_ifreq_adj_mi_results <- shlt_ifreq_adj_mi_results %>% 
    bind_rows(., shlt_ifreq_adj_mi_result)
  
  rm(shlt_ifreq_adj_mi, shlt_ifreq_adj_mi_result)
}
toc()

```

## Figure 3: Associations of Internet use frequency with mental health (imputed data)

```{r}

#### Theme setting ####
theme <- forestploter::forest_theme(
  core = list(bg_params = list(fill = c("white"))),
  base_size = 10, 
  # base_family = "Arial",
  ci_pch = 15,
  ci_col = "#3B4992FF", 
  ci_alpha = 1,
  ci_lty = 1,
  ci_lwd = 1,
  ci_Theight = unit(0, "cm"),
  
  xaxis_lwd = 1,
  xaxis_cex = 1,
  
  summary_col = "#008B45FF", 
  refline_col = "gray", 
  refline_lwd = 2, 
  
  title_just = "center",
  title_cex = 1.2,
  title_fontface = "bold",
  title_col = "black",
  
  arrow_type = "closed",
  arrow_label_just = "end",
  arrow_length = 0.05,
  arrow_lwd = 1,
  arrow_fill = "black",
  arrow_col = "black"
  )

#### CES-D ####
dat <- cesd_ifreq_adj_mi_results %>%
  bind_rows(
    tibble(
      country = "China", contrast = "never",
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "England", contrast = "never",
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "USA", contrast = "never",
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = ifelse(contrast == "never", "Reference", beta_ci),
    blank = paste(rep(" ", 10), collapse = " "),
    plot_ci = paste(rep(" ", 20), collapse = " "),
    contrast = factor(contrast, levels = c("never", "notregularly - none", "weekly - none", "daily - none"), labels = c("  Never", "  Less than weekly", "  Weekly", "  Daily"))
  ) %>%
  arrange(country, contrast)

dat_fig <- dat %>%
  select(country, contrast, estimate, lower, upper, beta_ci, blank, plot_ci) %>%
  pivot_wider(
    names_from = country,
    values_from = c(estimate, lower, upper, beta_ci, blank, plot_ci)
  ) %>%
  select(
    contrast, estimate_China, estimate_England, estimate_USA, 
    lower_China, lower_England, lower_USA,
    upper_China, upper_England, upper_USA, 
    plot_ci_China, beta_ci_China, blank_China,
    plot_ci_England, beta_ci_England, blank_England,
    plot_ci_USA, beta_ci_USA
    )
colnames(dat_fig)[colnames(dat_fig) == "contrast"] <- "Internet use frequency"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_China"] <- "China"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_England"] <- "England"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_USA"] <- "USA"
colnames(dat_fig)[colnames(dat_fig) %in% c("beta_ci_China", "beta_ci_England", "beta_ci_USA")] <- "AME (95% CI)"
colnames(dat_fig)[colnames(dat_fig) %in% c("blank_China", "blank_England", "blank_USA")] <- " "


p_cesd <- forestploter::forest(
  dat_fig[,c(1, 11:18)],
  est = list(
    dat_fig$estimate_China,
    dat_fig$estimate_England,
    dat_fig$estimate_USA
  ),
  lower = list(
    dat_fig$lower_China,
    dat_fig$lower_England,
    dat_fig$lower_USA
  ),
  upper = list(
    dat_fig$upper_China,
    dat_fig$upper_England,
    dat_fig$upper_USA
  ),
  ci_column = c(2, 5, 8),
  ref_line = c(0, 0, 0),
  sizes = 0.7,
  xlim = list(
    c(-1.22, 1.2), 
    c(-1.22, 1.2),
    c(-1.22, 1.2)
    ),            
  ticks_at = list(
    c(-1.2, -0.6, 0, 0.6, 1.2), 
    c(-1.2, -0.6, 0, 0.6, 1.2), 
    c(-1.2, -0.6, 0, 0.6, 1.2)
    ),  
  
  arrow_lab = c("Fewer depressive symptoms","More depressive symptoms"),
  theme = theme
  )

# Add border
p_cesd <- add_border(p_cesd, part = "header", row = 1, col = c(1:9), gp = gpar(lwd = 1))


#### Life satisfaction ####
dat <- satlife_ifreq_adj_mi_results %>%
  bind_rows(
    tibble(
      country = "China", contrast = "never", 
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "England", contrast = "never", 
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "USA", contrast = "never", 
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = ifelse(contrast == "never", "Reference", beta_ci),
    blank = paste(rep(" ", 10), collapse = " "),
    plot_ci = paste(rep(" ", 20), collapse = " "),
    contrast = factor(contrast, levels = c("never", "notregularly - none", "weekly - none", "daily - none"), labels = c("  Never", "  Less than weekly", "  Weekly", "  Daily"))
  ) %>%
  arrange(country, contrast)

dat_fig <- dat %>%
  select(country, contrast, estimate, lower, upper, beta_ci, blank, plot_ci) %>%
  pivot_wider(
    names_from = country,
    values_from = c(estimate, lower, upper, beta_ci, blank, plot_ci)
  ) %>%
  select(
    contrast, estimate_China, estimate_England, estimate_USA, 
    lower_China, lower_England, lower_USA,
    upper_China, upper_England, upper_USA, 
    plot_ci_China, beta_ci_China, blank_China,
    plot_ci_England, beta_ci_England, blank_England,
    plot_ci_USA, beta_ci_USA
    )
colnames(dat_fig)[colnames(dat_fig) == "contrast"] <- "Internet use frequency"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_China"] <- "China"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_England"] <- "England"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_USA"] <- "USA"
colnames(dat_fig)[colnames(dat_fig) %in% c("beta_ci_China", "beta_ci_England", "beta_ci_USA")] <- "AME (95% CI)"
colnames(dat_fig)[colnames(dat_fig) %in% c("blank_China", "blank_England", "blank_USA")] <- " "


p_satlife <- forestploter::forest(
  dat_fig[,c(1, 11:18)],
  est = list(
    dat_fig$estimate_China,
    dat_fig$estimate_England,
    dat_fig$estimate_USA
  ),
  lower = list(
    dat_fig$lower_China,
    dat_fig$lower_England,
    dat_fig$lower_USA
  ),
  upper = list(
    dat_fig$upper_China,
    dat_fig$upper_England,
    dat_fig$upper_USA
  ),
  ci_column = c(2, 5, 8),
  ref_line = c(0, 0, 0),
  sizes = 0.7,
  xlim = list(
    c(-1.4, 0.7), 
    c(-1.4, 0.7),
    c(-1.4, 0.7)
    ),            
  ticks_at = list(
    c(-1.4, -0.7, 0, 0.7), 
    c(-1.4, -0.7, 0, 0.7), 
    c(-1.4, -0.7, 0, 0.7)
    ),  
  arrow_lab = c("Lower life satisfaction","Higher life satisfaction"),
  theme = theme
  )

# Add border
p_satlife <- add_border(p_satlife, part = "header", row = 1, col = c(1:9), gp = gpar(lwd = 1))


#### Self-rated health ####
dat <- shlt_ifreq_adj_mi_results %>%
  bind_rows(
    tibble(
      country = "China", contrast = "never", 
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "England", contrast = "never", 
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "USA", contrast = "never", 
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = ifelse(contrast == "never", "Reference", beta_ci),
    blank = paste(rep(" ", 10), collapse = " "),
    plot_ci = paste(rep(" ", 20), collapse = " "),
    contrast = factor(contrast, levels = c("never", "notregularly - none", "weekly - none", "daily - none"), labels = c("  Never", "  Less than weekly", "  Weekly", "  Daily"))
  ) %>%
  arrange(country, contrast)

dat_fig <- dat %>%
  select(country, contrast, estimate, lower, upper, beta_ci, blank, plot_ci) %>%
  pivot_wider(
    names_from = country,
    values_from = c(estimate, lower, upper, beta_ci, blank, plot_ci)
  ) %>%
  select(
    contrast, estimate_China, estimate_England, estimate_USA, 
    lower_China, lower_England, lower_USA,
    upper_China, upper_England, upper_USA, 
    plot_ci_China, beta_ci_China, blank_China,
    plot_ci_England, beta_ci_England, blank_England,
    plot_ci_USA, beta_ci_USA
    )
colnames(dat_fig)[colnames(dat_fig) == "contrast"] <- "Internet use frequency"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_China"] <- "China"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_England"] <- "England"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_USA"] <- "USA"
colnames(dat_fig)[colnames(dat_fig) %in% c("beta_ci_China", "beta_ci_England", "beta_ci_USA")] <- "AME (95% CI)"
colnames(dat_fig)[colnames(dat_fig) %in% c("blank_China", "blank_England", "blank_USA")] <- " "


p_shlt <- forestploter::forest(
  dat_fig[,c(1, 11:18)],
  est = list(
    dat_fig$estimate_China,
    dat_fig$estimate_England,
    dat_fig$estimate_USA
  ),
  lower = list(
    dat_fig$lower_China,
    dat_fig$lower_England,
    dat_fig$lower_USA
  ),
  upper = list(
    dat_fig$upper_China,
    dat_fig$upper_England,
    dat_fig$upper_USA
  ),
  ci_column = c(2, 5, 8),
  ref_line = c(0, 0, 0),
  sizes = 0.7,
  xlim = list(
    c(-0.7, 1.4), 
    c(-0.7, 1.4),
    c(-0.7, 1.4)
    ),            
  ticks_at = list(
    c(-0.7, 0, 0.7, 1.4), 
    c(-0.7, 0, 0.7, 1.4), 
    c(-0.7, 0, 0.7, 1.4)
    ),  
  arrow_lab = c("Worse self-reported health","Better self-reported health"),
  theme = theme
  )

# Add border
p_shlt <- add_border(p_shlt, part = "header", row = 1, col = c(1:9), gp = gpar(lwd = 1))


#### Pool ####
p_pool <- wrap_elements(
  wrap_elements(p_cesd) + wrap_elements(p_satlife) +
    plot_layout(nrow = 2) + 
    plot_annotation(tag_levels = "a")
  ) 

ggsave(str_c(getwd(), "/results/Figure/Figure 3_Forest plot_internet use frequency_mice.tiff"), plot = p_pool, width = 13, height = 5, unit = "in", dpi = 500, device = "tiff")

ggsave(str_c(getwd(), "/results/Figure/Figure 3_Forest plot_internet use frequency_mice.pdf"), plot = p_pool, width = 13, height = 5, unit = "in", dpi = 300, device = "pdf")

```

## Supplementary Figure 9: Associations of Internet use frequency with self-reported health

```{r}

# Self-reported health only
ggsave(str_c(getwd(), "/results/Figure/Supplementary Figure 9_Forest plot_internet use frequency_self-reported health_mice.tiff"), plot = p_shlt, width = 12, height = 2.5, unit = "in", dpi = 500, device = "tiff")

rm(theme, dat, dat_fig, p_cesd, p_satlife, p_shlt, p_pool)

```


## Supplementary Figure 22: Unadjusted associations of Internet use frequency with mental health

```{r}

#### Theme setting ####
theme <- forestploter::forest_theme(
  core = list(bg_params = list(fill = c("white"))),
  base_size = 10, 
  # base_family = "Arial",
  ci_pch = 15,
  ci_col = "#3B4992FF", 
  ci_alpha = 1,
  ci_lty = 1,
  ci_lwd = 1,
  ci_Theight = unit(0, "cm"),
  
  xaxis_lwd = 1,
  xaxis_cex = 1,
  
  summary_col = "#008B45FF", 
  refline_col = "gray", 
  refline_lwd = 2, 
  
  title_just = "center",
  title_cex = 1.2,
  title_fontface = "bold",
  title_col = "black",
  
  arrow_type = "closed",
  arrow_label_just = "end",
  arrow_length = 0.05,
  arrow_lwd = 1,
  arrow_fill = "black",
  arrow_col = "black"
  )

#### CES-D ####
dat <- cesd_ifreq_unadj_mi_results %>%
  bind_rows(
    tibble(
      country = "China", contrast = "never",
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "England", contrast = "never",
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "USA", contrast = "never",
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = ifelse(contrast == "never", "Reference", beta_ci),
    blank = paste(rep(" ", 10), collapse = " "),
    plot_ci = paste(rep(" ", 20), collapse = " "),
    contrast = factor(contrast, levels = c("never", "notregularly - none", "weekly - none", "daily - none"), labels = c("  Never", "  Less than weekly", "  Weekly", "  Daily"))
  ) %>%
  arrange(country, contrast)

dat_fig <- dat %>%
  select(country, contrast, estimate, lower, upper, beta_ci, blank, plot_ci) %>%
  pivot_wider(
    names_from = country,
    values_from = c(estimate, lower, upper, beta_ci, blank, plot_ci)
  ) %>%
  select(
    contrast, estimate_China, estimate_England, estimate_USA, 
    lower_China, lower_England, lower_USA,
    upper_China, upper_England, upper_USA, 
    plot_ci_China, beta_ci_China, blank_China,
    plot_ci_England, beta_ci_England, blank_England,
    plot_ci_USA, beta_ci_USA
    )
colnames(dat_fig)[colnames(dat_fig) == "contrast"] <- "Internet use frequency"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_China"] <- "China"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_England"] <- "England"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_USA"] <- "USA"
colnames(dat_fig)[colnames(dat_fig) %in% c("beta_ci_China", "beta_ci_England", "beta_ci_USA")] <- "AME (95% CI)"
colnames(dat_fig)[colnames(dat_fig) %in% c("blank_China", "blank_England", "blank_USA")] <- " "


p_cesd <- forestploter::forest(
  dat_fig[,c(1, 11:18)],
  est = list(
    dat_fig$estimate_China,
    dat_fig$estimate_England,
    dat_fig$estimate_USA
  ),
  lower = list(
    dat_fig$lower_China,
    dat_fig$lower_England,
    dat_fig$lower_USA
  ),
  upper = list(
    dat_fig$upper_China,
    dat_fig$upper_England,
    dat_fig$upper_USA
  ),
  ci_column = c(2, 5, 8),
  ref_line = c(0, 0, 0),
  sizes = 0.7,
  xlim = list(
    c(-1.8, 0.6), 
    c(-1.8, 0.6),
    c(-1.8, 0.6)
    ),            
  ticks_at = list(
    c(-1.8, -1.2, -0.6, 0, 0.6), 
    c(-1.8, -1.2, -0.6, 0, 0.6), 
    c(-1.8, -1.2, -0.6, 0, 0.6)
    ),  
  
  arrow_lab = c("Fewer depressive symptoms","More depressive symptoms"),
  theme = theme
  )

# Add border
p_cesd <- add_border(p_cesd, part = "header", row = 1, col = c(1:9), gp = gpar(lwd = 1))


#### Life satisfaction ####
dat <- satlife_ifreq_unadj_mi_results %>%
  bind_rows(
    tibble(
      country = "China", contrast = "never", 
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "England", contrast = "never", 
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "USA", contrast = "never", 
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = ifelse(contrast == "never", "Reference", beta_ci),
    blank = paste(rep(" ", 10), collapse = " "),
    plot_ci = paste(rep(" ", 20), collapse = " "),
    contrast = factor(contrast, levels = c("never", "notregularly - none", "weekly - none", "daily - none"), labels = c("  Never", "  Less than weekly", "  Weekly", "  Daily"))
  ) %>%
  arrange(country, contrast)

dat_fig <- dat %>%
  select(country, contrast, estimate, lower, upper, beta_ci, blank, plot_ci) %>%
  pivot_wider(
    names_from = country,
    values_from = c(estimate, lower, upper, beta_ci, blank, plot_ci)
  ) %>%
  select(
    contrast, estimate_China, estimate_England, estimate_USA, 
    lower_China, lower_England, lower_USA,
    upper_China, upper_England, upper_USA, 
    plot_ci_China, beta_ci_China, blank_China,
    plot_ci_England, beta_ci_England, blank_England,
    plot_ci_USA, beta_ci_USA
    )
colnames(dat_fig)[colnames(dat_fig) == "contrast"] <- "Internet use frequency"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_China"] <- "China"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_England"] <- "England"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_USA"] <- "USA"
colnames(dat_fig)[colnames(dat_fig) %in% c("beta_ci_China", "beta_ci_England", "beta_ci_USA")] <- "AME (95% CI)"
colnames(dat_fig)[colnames(dat_fig) %in% c("blank_China", "blank_England", "blank_USA")] <- " "


p_satlife <- forestploter::forest(
  dat_fig[,c(1, 11:18)],
  est = list(
    dat_fig$estimate_China,
    dat_fig$estimate_England,
    dat_fig$estimate_USA
  ),
  lower = list(
    dat_fig$lower_China,
    dat_fig$lower_England,
    dat_fig$lower_USA
  ),
  upper = list(
    dat_fig$upper_China,
    dat_fig$upper_England,
    dat_fig$upper_USA
  ),
  ci_column = c(2, 5, 8),
  ref_line = c(0, 0, 0),
  sizes = 0.7,
  xlim = list(
    c(-1.4, 0.7), 
    c(-1.4, 0.7),
    c(-1.4, 0.7)
    ),            
  ticks_at = list(
    c(-1.4, -0.7, 0, 0.7), 
    c(-1.4, -0.7, 0, 0.7), 
    c(-1.4, -0.7, 0, 0.7)
    ),  
  arrow_lab = c("Lower life satisfaction","Higher life satisfaction"),
  theme = theme
  )

# Add border
p_satlife <- add_border(p_satlife, part = "header", row = 1, col = c(1:9), gp = gpar(lwd = 1))


#### Self-rated health ####
dat <- shlt_ifreq_unadj_mi_results %>%
  bind_rows(
    tibble(
      country = "China", contrast = "never", 
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "England", contrast = "never", 
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "USA", contrast = "never", 
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = ifelse(contrast == "never", "Reference", beta_ci),
    blank = paste(rep(" ", 10), collapse = " "),
    plot_ci = paste(rep(" ", 20), collapse = " "),
    contrast = factor(contrast, levels = c("never", "notregularly - none", "weekly - none", "daily - none"), labels = c("  Never", "  Less than weekly", "  Weekly", "  Daily"))
  ) %>%
  arrange(country, contrast)

dat_fig <- dat %>%
  select(country, contrast, estimate, lower, upper, beta_ci, blank, plot_ci) %>%
  pivot_wider(
    names_from = country,
    values_from = c(estimate, lower, upper, beta_ci, blank, plot_ci)
  ) %>%
  select(
    contrast, estimate_China, estimate_England, estimate_USA, 
    lower_China, lower_England, lower_USA,
    upper_China, upper_England, upper_USA, 
    plot_ci_China, beta_ci_China, blank_China,
    plot_ci_England, beta_ci_England, blank_England,
    plot_ci_USA, beta_ci_USA
    )
colnames(dat_fig)[colnames(dat_fig) == "contrast"] <- "Internet use frequency"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_China"] <- "China"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_England"] <- "England"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_USA"] <- "USA"
colnames(dat_fig)[colnames(dat_fig) %in% c("beta_ci_China", "beta_ci_England", "beta_ci_USA")] <- "AME (95% CI)"
colnames(dat_fig)[colnames(dat_fig) %in% c("blank_China", "blank_England", "blank_USA")] <- " "


p_shlt <- forestploter::forest(
  dat_fig[,c(1, 11:18)],
  est = list(
    dat_fig$estimate_China,
    dat_fig$estimate_England,
    dat_fig$estimate_USA
  ),
  lower = list(
    dat_fig$lower_China,
    dat_fig$lower_England,
    dat_fig$lower_USA
  ),
  upper = list(
    dat_fig$upper_China,
    dat_fig$upper_England,
    dat_fig$upper_USA
  ),
  ci_column = c(2, 5, 8),
  ref_line = c(0, 0, 0),
  sizes = 0.7,
  xlim = list(
    c(-0.8, 1.62), 
    c(-0.8, 1.62),
    c(-0.8, 1.62)
    ),            
  ticks_at = list(
    c(-0.8, 0, 0.8, 1.6), 
    c(-0.8, 0, 0.8, 1.6), 
    c(-0.8, 0, 0.8, 1.6)
    ),  
  arrow_lab = c("Worse self-reported health","Better self-reported health"),
  theme = theme
  )

# Add border
p_shlt <- add_border(p_shlt, part = "header", row = 1, col = c(1:9), gp = gpar(lwd = 1))


#### Pool ####
p_pool <- wrap_elements(
  wrap_elements(p_cesd) + wrap_elements(p_satlife) + wrap_elements(p_shlt) +
    plot_layout(nrow = 3) + 
    plot_annotation(tag_levels = "a")
  ) 

ggsave(str_c(getwd(), "/results/Figure/Supplementary Figure 22_Forest plot_internet use frequency_mice_unadjusted.tiff"), plot = p_pool, width = 13, height = 8, unit = "in", dpi = 500, device = "tiff")

rm(theme, dat, dat_fig, p_cesd, p_satlife, p_shlt, p_pool)

```


# Cumulative Internet use

## Linear mixed model and meta analysis

```{r warning=FALSE}

#### Merge data ####
iso <- c(40, 56, 156, 203, 208, 826, 233, 250, 276, 376, 380, 442, 484, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "China", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Israel", "Italy", "Luxembourg", "Mexico", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

mi_icum_merge <- list()
for(i in 1:10){
  mi_icum <- mi_icum_hrs[[i]] %>% 
    mutate(id = as.character(id)) %>% 
    bind_rows(., mi_icum_elsa[[i]] %>% mutate(id = as.character(id))) %>%
    bind_rows(., mi_icum_charls[[i]] %>% mutate(id = as.character(id))) %>%
    bind_rows(., mi_icum_share[[i]]) %>%
    mutate(
      country_names = case_when(
        country == iso[1] ~ names[1],
        country == iso[2] ~ names[2],
        country == iso[3] ~ names[3],
        country == iso[4] ~ names[4],
        country == iso[5] ~ names[5],
        country == iso[6] ~ names[6],
        country == iso[7] ~ names[7],
        country == iso[8] ~ names[8],
        country == iso[9] ~ names[9],
        country == iso[10] ~ names[10],
        country == iso[11] ~ names[11],
        country == iso[12] ~ names[12],
        country == iso[13] ~ names[13],
        country == iso[14] ~ names[14],
        country == iso[15] ~ names[15],
        country == iso[16] ~ names[16],
        country == iso[17] ~ names[17],
        country == iso[18] ~ names[18]
      )
    )
  mi_icum_merge[[i]] <- mi_icum
  rm(mi_icum)
}

tic()
#### CES-D ####
# lme4
cesd_icum_unadj_mi_results <- tibble()
for(i in 1:18){
  
  if(i==13){
    cesd_icum_unadj_mi <- lmer(
      cesd_stand ~ internet_cum*cwave + (1 | id),
      data = final_icum_mhas, 
      control = lmerControl(optimizer = "bobyqa")
      ) # Mexico doesn't have missing values
    cesd_icum_unadj_mi_result <- marginaleffects::avg_comparisons(
      cesd_icum_unadj_mi, variables = "internet_cum", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    cesd_icum_unadj_mi <- lapply(mi_icum_merge, function(x){
      lmer(
        cesd_stand ~ internet_cum*cwave + (1 | id),
        data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'))
        })
    cesd_icum_unadj_mi_result <- lapply(seq_along(cesd_icum_unadj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_icum_unadj_mi[[j]], variables = "internet_cum", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }
  
  cesd_icum_unadj_mi_results <- cesd_icum_unadj_mi_results %>% 
    bind_rows(., cesd_icum_unadj_mi_result)
  
  rm(cesd_icum_unadj_mi, cesd_icum_unadj_mi_result)
}

cesd_icum_adj_mi_results <- tibble()
for(i in 1:18){
  
  if(i==13){
    cesd_icum_adj_mi <- lmer(
      cesd_stand ~ internet_cum*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),      
      data = final_icum_mhas, 
      control = lmerControl(optimizer = "bobyqa")
      ) # Mexico don't have missing values
    cesd_icum_adj_mi_result <- marginaleffects::avg_comparisons(
      cesd_icum_adj_mi, variables = "internet_cum", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    cesd_icum_adj_mi <- lapply(mi_icum_merge, function(x){
      lmer(
        cesd_stand ~ internet_cum*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl + 
          (1 | id),
        data = x %>% filter(country_names == names[i]), 
        control = lmerControl(optimizer = 'bobyqa')
        )
      })
    
    cesd_icum_adj_mi_result <- lapply(seq_along(cesd_icum_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_icum_adj_mi[[j]], variables = "internet_cum", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }
  
  cesd_icum_adj_mi_results <- cesd_icum_adj_mi_results %>% 
    bind_rows(., cesd_icum_adj_mi_result)
  
  rm(cesd_icum_adj_mi, cesd_icum_adj_mi_result)
}

# metafor
cesd_icum_unadj_mi_meta <- rma(yi = estimate, sei = std.error, data = cesd_icum_unadj_mi_results, slab = country)

cesd_icum_adj_mi_meta <- rma(yi = estimate, sei = std.error, data = cesd_icum_adj_mi_results, slab = country)


#### Life satisfaction ####
# lme4
satlife_icum_unadj_mi_results <- tibble()
for(i in 1:18){
  
  if(i==13){
    satlife_icum_unadj_mi <- lmer(
      satlife_stand ~ internet_cum*cwave + (1 | id),
      data = final_icum_mhas, 
      control = lmerControl(optimizer = "bobyqa")
      ) # Mexico doesn't have missing values
    satlife_icum_unadj_mi_result <- marginaleffects::avg_comparisons(
      satlife_icum_unadj_mi, variables = "internet_cum", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    satlife_icum_unadj_mi <- lapply(mi_icum_merge, function(x){
      lmer(
        satlife_stand ~ internet_cum*cwave + (1 | id),
        data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'))
        })
    satlife_icum_unadj_mi_result <- lapply(seq_along(satlife_icum_unadj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_icum_unadj_mi[[j]], variables = "internet_cum", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }
  
  satlife_icum_unadj_mi_results <- satlife_icum_unadj_mi_results %>% 
    bind_rows(., satlife_icum_unadj_mi_result)
  
  rm(satlife_icum_unadj_mi, satlife_icum_unadj_mi_result)
}

satlife_icum_adj_mi_results <- tibble()
for(i in 1:18){
  
  if(i==13){
    satlife_icum_adj_mi <- lmer(
      satlife_stand ~ internet_cum*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),      
      data = final_icum_mhas, 
      control = lmerControl(optimizer = "bobyqa")
      ) # Mexico doesn't have missing values
    satlife_icum_adj_mi_result <- marginaleffects::avg_comparisons(
      satlife_icum_adj_mi, variables = "internet_cum", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    satlife_icum_adj_mi <- lapply(mi_icum_merge, function(x){
      lmer(
        satlife_stand ~ internet_cum*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl + 
          (1 | id),
        data = x %>% filter(country_names == names[i]), 
        control = lmerControl(optimizer = 'bobyqa')
        )
      })
    
    satlife_icum_adj_mi_result <- lapply(seq_along(satlife_icum_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_icum_adj_mi[[j]], variables = "internet_cum", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }
  
  satlife_icum_adj_mi_results <- satlife_icum_adj_mi_results %>% 
    bind_rows(., satlife_icum_adj_mi_result)
  
  rm(satlife_icum_adj_mi, satlife_icum_adj_mi_result)
}

# metafor
satlife_icum_unadj_mi_meta <- rma(yi = estimate, sei = std.error, data = satlife_icum_unadj_mi_results, slab = country)

satlife_icum_adj_mi_meta <- rma(yi = estimate, sei = std.error, data = satlife_icum_adj_mi_results, slab = country)


#### Self-rated health ####
# lme4
shlt_icum_unadj_mi_results <- tibble()
for(i in 1:18){
  
  if(i==13){
    shlt_icum_unadj_mi <- lmer(
      shlt_stand ~ internet_cum*cwave + (1 | id),
      data = final_icum_mhas, 
      control = lmerControl(optimizer = "bobyqa")
      ) # Mexico doesn't have missing values
    shlt_icum_unadj_mi_result <- marginaleffects::avg_comparisons(
      shlt_icum_unadj_mi, variables = "internet_cum", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    shlt_icum_unadj_mi <- lapply(mi_icum_merge, function(x){
      lmer(
        shlt_stand ~ internet_cum*cwave + (1 | id),
        data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'))
        })
    shlt_icum_unadj_mi_result <- lapply(seq_along(shlt_icum_unadj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_icum_unadj_mi[[j]], variables = "internet_cum", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }
  
  shlt_icum_unadj_mi_results <- shlt_icum_unadj_mi_results %>% 
    bind_rows(., shlt_icum_unadj_mi_result)
  
  rm(shlt_icum_unadj_mi, shlt_icum_unadj_mi_result)
}

shlt_icum_adj_mi_results <- tibble()
for(i in 1:18){
  
  if(i==13){
    shlt_icum_adj_mi <- lmer(
      shlt_stand ~ internet_cum*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),      
      data = final_icum_mhas, 
      control = lmerControl(optimizer = "bobyqa")
      ) # Mexico doesn't have missing values
    shlt_icum_adj_mi_result <- marginaleffects::avg_comparisons(
      shlt_icum_adj_mi, variables = "internet_cum", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    shlt_icum_adj_mi <- lapply(mi_icum_merge, function(x){
      lmer(
        shlt_stand ~ internet_cum*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl + 
          (1 | id),
        data = x %>% filter(country_names == names[i]), 
        control = lmerControl(optimizer = 'bobyqa')
        )
      })
    
    shlt_icum_adj_mi_result <- lapply(seq_along(shlt_icum_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_icum_adj_mi[[j]], variables = "internet_cum", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }
  
  shlt_icum_adj_mi_results <- shlt_icum_adj_mi_results %>% 
    bind_rows(., shlt_icum_adj_mi_result)
  
  rm(shlt_icum_adj_mi, shlt_icum_adj_mi_result)
}

# metafor
shlt_icum_unadj_mi_meta <- rma(yi = estimate, sei = std.error, data = shlt_icum_unadj_mi_results, slab = country)

shlt_icum_adj_mi_meta <- rma(yi = estimate, sei = std.error, data = shlt_icum_adj_mi_results, slab = country)

toc()

```

## Figure 4: Associations of cumulative Internet use with mental health (imputed data)

```{r}

#### Theme setting ####
theme <- forestploter::forest_theme(
  core = list(bg_params = list(fill = c("white"))), 
  base_size = 10, 
  # base_family = "Arial",
  ci_pch = 15,
  ci_col = "#3B4992FF", 
  ci_alpha = 1,
  ci_lty = 1,
  ci_lwd = 1,
  ci_Theight = unit(0, "cm"),
  
  xaxis_lwd = 1,
  xaxis_cex = 1,
  
  summary_col = "#008B45FF", 
  refline_col = "gray", 
  refline_lwd = 2, 
  
  title_just = "center",
  title_cex = 1.2,
  title_fontface = "bold",
  title_col = "black",
  
  arrow_type = "closed",
  arrow_label_just = "end",
  arrow_length = 0.05,
  arrow_lwd = 1,
  arrow_fill = "black",
  arrow_col = "black"
  )

#### CES-D ####
# Data
dat <- cesd_icum_adj_mi_results %>%
  mutate(weights = weights(cesd_icum_adj_mi_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(cesd_icum_adj_mi_meta$beta),
      std.error = as.numeric(cesd_icum_adj_mi_meta$se), 
      statistic = NA, p.value = NA, p.sig = NA, 
      weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "AME (95% CI)", "Weight (%)")
# colnames(dat_fig) <- c("Country", "", "", "", "Weight (%)")

p_cesd <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Fewer depressive symptoms","More depressive symptoms"),
  xlim = c(-0.4, 0.1),
  ticks_at = c(-0.4, -0.3, -0.2, -0.1, 0, 0.1),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(cesd_icum_adj_mi_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(cesd_icum_adj_mi_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(cesd_icum_adj_mi_meta$H2, digits = 2)))
    )

p_cesd <- add_text(
  p_cesd, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- bquote(
    paste(
      "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
      "Q (", .(cesd_icum_adj_mi_meta$k - cesd_icum_adj_mi_meta$p), ") = ", 
      .(fmtx(cesd_icum_adj_mi_meta$QE, digits = 2)), ", ",
      # .(fmtp(cesd_icum_adj_mi_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      italic(P), " < 0.001"
      )
)

test_hetero <- 
  if(cesd_icum_adj_mi_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(cesd_icum_adj_mi_meta$k - cesd_icum_adj_mi_meta$p), ") = ", 
        .(fmtx(cesd_icum_adj_mi_meta$QE, digits = 2)), ", ",
        
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(cesd_icum_adj_mi_meta$k - cesd_icum_adj_mi_meta$p), ") = ", 
        .(fmtx(cesd_icum_adj_mi_meta$QE, digits = 2)), ", ",
        .(fmtp(cesd_icum_adj_mi_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )
  }

p_cesd <- add_text(
  p_cesd, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(cesd_icum_adj_mi_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(cesd_icum_adj_mi_meta$zval, digits = 2)), ", ",
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(cesd_icum_adj_mi_meta$zval, digits = 2)), ", ",
        .(fmtp(cesd_icum_adj_mi_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )    
  }

p_cesd <- add_text(
  p_cesd, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_cesd <- add_border(p_cesd, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))


#### Life satisfaction ####
# Data
dat <- satlife_icum_adj_mi_results %>%
  mutate(weights = weights(satlife_icum_adj_mi_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(satlife_icum_adj_mi_meta$beta),
      std.error = as.numeric(satlife_icum_adj_mi_meta$se), 
      statistic = NA, p.value = NA, p.sig = NA, 
      weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "AME (95% CI)", "Weight (%)")
# colnames(dat_fig) <- c("Country", "", "", "", "Weight (%)")


p_satlife <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Lower life satisfaction","Higher life satisfaction"),
  xlim = c(-0.2, 0.3),
  ticks_at = c(-0.2, -0.1, 0, 0.1, 0.2, 0.3),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(satlife_icum_adj_mi_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(satlife_icum_adj_mi_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(satlife_icum_adj_mi_meta$H2, digits = 2)))
    )

p_satlife <- add_text(
  p_satlife, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(satlife_icum_adj_mi_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(satlife_icum_adj_mi_meta$k - satlife_icum_adj_mi_meta$p), ") = ", 
        .(fmtx(satlife_icum_adj_mi_meta$QE, digits = 2)), ", ",
        
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(satlife_icum_adj_mi_meta$k - satlife_icum_adj_mi_meta$p), ") = ", 
        .(fmtx(satlife_icum_adj_mi_meta$QE, digits = 2)), ", ",
        .(fmtp(satlife_icum_adj_mi_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )
  }

p_satlife <- add_text(
  p_satlife, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(satlife_icum_adj_mi_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(satlife_icum_adj_mi_meta$zval, digits = 2)), ", ",
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(satlife_icum_adj_mi_meta$zval, digits = 2)), ", ",
        .(fmtp(satlife_icum_adj_mi_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )    
  }

p_satlife <- add_text(
  p_satlife, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_satlife <- add_border(p_satlife, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))

#### Self-rated health ####
# Data
dat <- shlt_icum_adj_mi_results %>%
  mutate(weights = weights(shlt_icum_adj_mi_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(shlt_icum_adj_mi_meta$beta),
      std.error = as.numeric(shlt_icum_adj_mi_meta$se), 
      statistic = NA, p.value = NA, p.sig = NA, 
      weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "AME (95% CI)", "Weight (%)")
# colnames(dat_fig) <- c("Country", "", "", "", "Weight (%)")


p_shlt <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Worse self-reported health","Better self-reported health"),
  xlim = c(-0.1, 0.3),
  ticks_at = c(-0.1, 0, 0.1, 0.2, 0.3),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(shlt_icum_adj_mi_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(shlt_icum_adj_mi_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(shlt_icum_adj_mi_meta$H2, digits = 2)))
    )

p_shlt <- add_text(
  p_shlt, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(shlt_icum_adj_mi_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(shlt_icum_adj_mi_meta$k - shlt_icum_adj_mi_meta$p), ") = ", 
        .(fmtx(shlt_icum_adj_mi_meta$QE, digits = 2)), ", ",
        
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(shlt_icum_adj_mi_meta$k - shlt_icum_adj_mi_meta$p), ") = ", 
        .(fmtx(shlt_icum_adj_mi_meta$QE, digits = 2)), ", ",
        .(fmtp(shlt_icum_adj_mi_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )
  }

p_shlt <- add_text(
  p_shlt, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(shlt_icum_adj_mi_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(shlt_icum_adj_mi_meta$zval, digits = 2)), ", ",
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(shlt_icum_adj_mi_meta$zval, digits = 2)), ", ",
        .(fmtp(shlt_icum_adj_mi_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )    
  }

p_shlt <- add_text(
  p_shlt, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_shlt <- add_border(p_shlt, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))



#### Pool ####
p_pool <- wrap_elements(
  wrap_elements(p_cesd) + wrap_elements(p_satlife) + 
    plot_layout(nrow = 1) + 
    plot_annotation(tag_levels = "a")
  ) 

ggsave(str_c(getwd(), "/results/Figure/Figure 4_Forest plot_cumulative internet use_mice.tiff"), plot = p_pool, width = 16, height = 6, unit = "in", dpi = 500, device = "tiff")

ggsave(str_c(getwd(), "/results/Figure/Figure 4_Forest plot_cumulative internet use_mice.pdf"), plot = p_pool, width = 16, height = 6, unit = "in", dpi = 300, device = "pdf")

```

## Supplementary Figure 10: Associations of cumulative Internet use with self-reported health

```{r}

# Self-reported health only
ggsave(str_c(getwd(), "/results/Figure/Supplementary Figure 10_Forest plot_cumulative internet use_self-reported health_mice.tiff"), plot = p_shlt, width = 8, height = 6, unit = "in", dpi = 500, device = "tiff")

rm(theme, dat, dat_fig, test_hetero, test_overall, p_cesd, p_satlife, p_shlt)

```

## Supplementary Figure 23: Unadjusted associations of cumulative Internet use with mental health (imputed data)

```{r}

#### Theme setting ####
theme <- forestploter::forest_theme(
  core = list(bg_params = list(fill = c("white"))), 
  base_size = 10, 
  # base_family = "Arial",
  ci_pch = 15,
  ci_col = "#3B4992FF", 
  ci_alpha = 1,
  ci_lty = 1,
  ci_lwd = 1,
  ci_Theight = unit(0, "cm"),
  
  xaxis_lwd = 1,
  xaxis_cex = 1,
  
  summary_col = "#008B45FF", 
  refline_col = "gray", 
  refline_lwd = 2, 
  
  title_just = "center",
  title_cex = 1.2,
  title_fontface = "bold",
  title_col = "black",
  
  arrow_type = "closed",
  arrow_label_just = "end",
  arrow_length = 0.05,
  arrow_lwd = 1,
  arrow_fill = "black",
  arrow_col = "black"
  )

#### CES-D ####
# Data
dat <- cesd_icum_unadj_mi_results %>%
  mutate(weights = weights(cesd_icum_unadj_mi_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(cesd_icum_unadj_mi_meta$beta),
      std.error = as.numeric(cesd_icum_unadj_mi_meta$se), 
      statistic = NA, p.value = NA, p.sig = NA, 
      weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "AME (95% CI)", "Weight (%)")
# colnames(dat_fig) <- c("Country", "", "", "", "Weight (%)")

p_cesd <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Fewer depressive symptoms","More depressive symptoms"),
  xlim = c(-0.6, 0),
  ticks_at = c(-0.6, -0.4, -0.2, 0),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(cesd_icum_unadj_mi_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(cesd_icum_unadj_mi_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(cesd_icum_unadj_mi_meta$H2, digits = 2)))
    )

p_cesd <- add_text(
  p_cesd, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- bquote(
    paste(
      "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
      "Q (", .(cesd_icum_unadj_mi_meta$k - cesd_icum_unadj_mi_meta$p), ") = ", 
      .(fmtx(cesd_icum_unadj_mi_meta$QE, digits = 2)), ", ",
      # .(fmtp(cesd_icum_unadj_mi_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      italic(P), " < 0.001"
      )
)

test_hetero <- 
  if(cesd_icum_unadj_mi_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(cesd_icum_unadj_mi_meta$k - cesd_icum_unadj_mi_meta$p), ") = ", 
        .(fmtx(cesd_icum_unadj_mi_meta$QE, digits = 2)), ", ",
        
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(cesd_icum_unadj_mi_meta$k - cesd_icum_unadj_mi_meta$p), ") = ", 
        .(fmtx(cesd_icum_unadj_mi_meta$QE, digits = 2)), ", ",
        .(fmtp(cesd_icum_unadj_mi_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )
  }

p_cesd <- add_text(
  p_cesd, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(cesd_icum_unadj_mi_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(cesd_icum_unadj_mi_meta$zval, digits = 2)), ", ",
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(cesd_icum_unadj_mi_meta$zval, digits = 2)), ", ",
        .(fmtp(cesd_icum_unadj_mi_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )    
  }

p_cesd <- add_text(
  p_cesd, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_cesd <- add_border(p_cesd, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))


#### Life satisfaction ####
# Data
dat <- satlife_icum_unadj_mi_results %>%
  mutate(weights = weights(satlife_icum_unadj_mi_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(satlife_icum_unadj_mi_meta$beta),
      std.error = as.numeric(satlife_icum_unadj_mi_meta$se), 
      statistic = NA, p.value = NA, p.sig = NA, 
      weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "AME (95% CI)", "Weight (%)")
# colnames(dat_fig) <- c("Country", "", "", "", "Weight (%)")


p_satlife <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Lower life satisfaction","Higher life satisfaction"),
  xlim = c(-0.8, 0.4),
  ticks_at = c(-0.8, -0.4, 0, 0.4),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(satlife_icum_unadj_mi_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(satlife_icum_unadj_mi_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(satlife_icum_unadj_mi_meta$H2, digits = 2)))
    )

p_satlife <- add_text(
  p_satlife, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(satlife_icum_unadj_mi_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(satlife_icum_unadj_mi_meta$k - satlife_icum_unadj_mi_meta$p), ") = ", 
        .(fmtx(satlife_icum_unadj_mi_meta$QE, digits = 2)), ", ",
        
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(satlife_icum_unadj_mi_meta$k - satlife_icum_unadj_mi_meta$p), ") = ", 
        .(fmtx(satlife_icum_unadj_mi_meta$QE, digits = 2)), ", ",
        .(fmtp(satlife_icum_unadj_mi_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )
  }

p_satlife <- add_text(
  p_satlife, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(satlife_icum_unadj_mi_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(satlife_icum_unadj_mi_meta$zval, digits = 2)), ", ",
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(satlife_icum_unadj_mi_meta$zval, digits = 2)), ", ",
        .(fmtp(satlife_icum_unadj_mi_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )    
  }

p_satlife <- add_text(
  p_satlife, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_satlife <- add_border(p_satlife, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))

#### Self-rated health ####
# Data
dat <- shlt_icum_unadj_mi_results %>%
  mutate(weights = weights(shlt_icum_unadj_mi_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(shlt_icum_unadj_mi_meta$beta),
      std.error = as.numeric(shlt_icum_unadj_mi_meta$se), 
      statistic = NA, p.value = NA, p.sig = NA, 
      weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "AME (95% CI)", "Weight (%)")
# colnames(dat_fig) <- c("Country", "", "", "", "Weight (%)")


p_shlt <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Worse self-reported health","Better self-reported health"),
  xlim = c(0, 0.45),
  ticks_at = c(0, 0.15, 0.3, 0.45),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(shlt_icum_unadj_mi_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(shlt_icum_unadj_mi_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(shlt_icum_unadj_mi_meta$H2, digits = 2)))
    )

p_shlt <- add_text(
  p_shlt, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(shlt_icum_unadj_mi_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(shlt_icum_unadj_mi_meta$k - shlt_icum_unadj_mi_meta$p), ") = ", 
        .(fmtx(shlt_icum_unadj_mi_meta$QE, digits = 2)), ", ",
        
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(shlt_icum_unadj_mi_meta$k - shlt_icum_unadj_mi_meta$p), ") = ", 
        .(fmtx(shlt_icum_unadj_mi_meta$QE, digits = 2)), ", ",
        .(fmtp(shlt_icum_unadj_mi_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )
  }

p_shlt <- add_text(
  p_shlt, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(shlt_icum_unadj_mi_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(shlt_icum_unadj_mi_meta$zval, digits = 2)), ", ",
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(shlt_icum_unadj_mi_meta$zval, digits = 2)), ", ",
        .(fmtp(shlt_icum_unadj_mi_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )    
  }

p_shlt <- add_text(
  p_shlt, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_shlt <- add_border(p_shlt, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))



#### Pool ####
p_pool <- wrap_elements(
  wrap_elements(p_cesd) + wrap_elements(p_satlife) + wrap_elements(p_shlt) + 
    plot_layout(nrow = 2) + 
    plot_annotation(tag_levels = "a")
  ) 

ggsave(str_c(getwd(), "/results/Figure/Supplementary Figure 23_Forest plot_cumulative internet use_mice_unadjusted.tiff"), plot = p_pool, width = 16, height = 12, unit = "in", dpi = 500, device = "tiff")

rm(theme, dat, dat_fig, test_hetero, test_overall, p_cesd, p_satlife, p_shlt)

```

# Sustained Internet use

## G-formula

```{r}

#### Merge data ####
iso <- c(40, 56, 156, 203, 208, 826, 233, 250, 276, 376, 380, 442, 484, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "China", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Israel", "Italy", "Luxembourg", "Mexico", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

mi_icum_gformula_merge <- list()
for(i in 1:10){
  baseline_share <- mi_icum_gformula_share[[i]] %>%
    group_by(id) %>%
    slice(1) %>%
    ungroup() %>%
    mutate(rowid = row_number()) %>%
    select(id, rowid)
  
  mi_icum <- mi_icum_gformula_share[[i]] %>%
    left_join(., baseline_share, by = "id") %>%
    mutate(id = rowid) %>%
    select(-rowid) %>%
    as.data.table() %>%
    bind_rows(., mi_icum_gformula_hrs[[i]] %>% as.data.table()) %>%
    bind_rows(., mi_icum_gformula_elsa[[i]] %>% as.data.table()) %>%
    bind_rows(., mi_icum_gformula_charls[[i]] %>% as.data.table()) %>%
    bind_rows(., mi_icum_gformula_mhas[[i]] %>% mutate(id = as.numeric(id)) %>% as.data.table()) %>%
    mutate(
      country_names = case_when(
        country == iso[1] ~ names[1],
        country == iso[2] ~ names[2],
        country == iso[3] ~ names[3],
        country == iso[4] ~ names[4],
        country == iso[5] ~ names[5],
        country == iso[6] ~ names[6],
        country == iso[7] ~ names[7],
        country == iso[8] ~ names[8],
        country == iso[9] ~ names[9],
        country == iso[10] ~ names[10],
        country == iso[11] ~ names[11],
        country == iso[12] ~ names[12],
        country == iso[13] ~ names[13],
        country == iso[14] ~ names[14],
        country == iso[15] ~ names[15],
        country == iso[16] ~ names[16],
        country == iso[17] ~ names[17],
        country == iso[18] ~ names[18]
      )
    )
  mi_icum_gformula_merge[[i]] <- mi_icum
  rm(baseline_share, mi_icum)
}

#### g-formula settings ####
covnames <- c(
  "internet_yes", "lowwealth", "lbrf", "nonmarried", "hhres", "contact", 
  "smoken", "weekdrink", "phyinact", "dis", "adl_any", "iadl"
  )
covtypes <- c(
  "binary", "categorical", "categorical", "binary", "normal", "binary",
  "binary", "binary", "binary", "normal", "binary", "normal"
  )
histories <- c(lagged)
histvars <- list(c("internet_yes", "lowwealth", "lbrf", "nonmarried", "hhres", "contact", "smoken", "weekdrink", "phyinact", "dis", "adl_any", "iadl"))

covparams <- list(covmodels = c(
  internet_yes ~ lag1_internet_yes + lag1_lowwealth + lag1_lbrf + lag1_nonmarried + lag1_hhres + lag1_contact + lag1_smoken + lag1_weekdrink + lag1_phyinact + lag1_dis + lag1_adl_any + lag1_iadl + age + male + lowedu + wave_num,
  
  lowwealth ~ lag1_internet_yes + lag1_lowwealth + lag1_lbrf + lag1_nonmarried + lag1_hhres + lag1_contact + lag1_smoken + lag1_weekdrink + lag1_phyinact + lag1_dis + lag1_adl_any + lag1_iadl + age + male + lowedu + wave_num,
  
  lbrf ~ lag1_internet_yes + lag1_lowwealth + lag1_lbrf + lag1_nonmarried + lag1_hhres + lag1_contact + lag1_smoken + lag1_weekdrink + lag1_phyinact + lag1_dis + lag1_adl_any + lag1_iadl + age + male + lowedu + wave_num,
  
  nonmarried ~ lag1_internet_yes + lag1_lowwealth + lag1_lbrf + lag1_nonmarried + lag1_hhres + lag1_contact + lag1_smoken + lag1_weekdrink + lag1_phyinact + lag1_dis + lag1_adl_any + lag1_iadl + age + male + lowedu + wave_num,
  
  hhres ~ lag1_internet_yes + lag1_lowwealth + lag1_lbrf + lag1_nonmarried + lag1_hhres + lag1_contact + lag1_smoken + lag1_weekdrink + lag1_phyinact + lag1_dis + lag1_adl_any + lag1_iadl + age + male + lowedu + wave_num,
  
  contact ~ lag1_internet_yes + lag1_lowwealth + lag1_lbrf + lag1_nonmarried + lag1_hhres + lag1_contact + lag1_smoken + lag1_weekdrink + lag1_phyinact + lag1_dis + lag1_adl_any + lag1_iadl + age + male + lowedu + wave_num,
  
  smoken ~ lag1_internet_yes + lag1_lowwealth + lag1_lbrf + lag1_nonmarried + lag1_hhres + lag1_contact + lag1_smoken + lag1_weekdrink + lag1_phyinact + lag1_dis + lag1_adl_any + lag1_iadl + age + male + lowedu + wave_num,
  
  weekdrink ~ lag1_internet_yes + lag1_lowwealth + lag1_lbrf + lag1_nonmarried + lag1_hhres + lag1_contact + lag1_smoken + lag1_weekdrink + lag1_phyinact + lag1_dis + lag1_adl_any + lag1_iadl + age + male + lowedu + wave_num,
  
  phyinact ~ lag1_internet_yes + lag1_lowwealth + lag1_lbrf + lag1_nonmarried + lag1_hhres + lag1_contact + lag1_smoken + lag1_weekdrink + lag1_phyinact + lag1_dis + lag1_adl_any + lag1_iadl + age + male + lowedu + wave_num,
  
  dis ~ lag1_internet_yes + lag1_lowwealth + lag1_lbrf + lag1_nonmarried + lag1_hhres + lag1_contact + lag1_smoken + lag1_weekdrink + lag1_phyinact + lag1_dis + lag1_adl_any + lag1_iadl + age + male + lowedu + wave_num,
  
  adl_any ~ lag1_internet_yes + lag1_lowwealth + lag1_lbrf + lag1_nonmarried + lag1_hhres + lag1_contact + lag1_smoken + lag1_weekdrink + lag1_phyinact + lag1_dis + lag1_adl_any + lag1_iadl + age + male + lowedu + wave_num,
  
  iadl ~ lag1_internet_yes + lag1_lowwealth + lag1_lbrf + lag1_nonmarried + lag1_hhres + lag1_contact + lag1_smoken + lag1_weekdrink + lag1_phyinact + lag1_dis + lag1_adl_any + lag1_iadl + age + male + lowedu + wave_num
  ))

intvars <- list("internet_yes", "internet_yes")
int_descript <- c("Never use", "Always use")


#### CES-D ####
ymodel <- cesd_stand ~ internet_yes + lowwealth + lbrf + nonmarried + hhres + contact + smoken + weekdrink + phyinact + dis + adl_any + iadl + lag1_internet_yes + lag1_lowwealth + lag1_lbrf + lag1_nonmarried + lag1_hhres + lag1_contact + lag1_smoken + lag1_weekdrink + lag1_phyinact + lag1_dis + lag1_adl_any + lag1_iadl + age + male + lowedu

gformula_cesd_results <- tibble()

# 1-5
tic()
for(j in 1:5){
  
  gformula_boot_results <- tibble()
  
  for(i in 1:10){
    data <- mi_icum_gformula_merge[[i]] %>% filter(country_names == names[j])
    time_points <- max(data$wave_num) + 1
    interventions <- list(
      list(c(static, rep(0, time_points))), list(c(static, rep(1, time_points)))
      )
    
    # calculate point estimate for `Always use` - `Natural course` using imputed, but not yet bootstrapped data
    gform_point <- gformula(
      obs_data = data, 
      outcome_type = "continuous_eof", outcome_name = "cesd_stand",
      id = "id", time_points = time_points, time_name = "wave_num",
      covnames = covnames, covtypes = covtypes, covparams = covparams,
      ymodel = ymodel, intvars = intvars,
      interventions = interventions, int_descript = int_descript, 
      histories = histories, histvars = histvars, basecovs = c("age", "male", "lowedu"), 
      nsimul = nrow(data), seed = 12345
    )
    
    # calculate bootstrap standard error for `Always use` - `Natural course`
    gform_boot <- gformula(
      obs_data = data, 
      outcome_type = "continuous_eof", outcome_name = "cesd_stand",
      id = "id", time_points = time_points, time_name = "wave_num",
      covnames = covnames, covtypes = covtypes, covparams = covparams,
      ymodel = ymodel, intvars = intvars,
      interventions = interventions, int_descript = int_descript, 
      histories = histories, histvars = histvars, basecovs = c("age", "male", "lowedu"), 
      seed = 12345, nsamples = 100, parallel = TRUE, ncores = 4, 
      ci_method = "normal", boot_diag = TRUE
    )
    
    boot_result <- gform_boot$bootests %>% 
      rowwise() %>%
      mutate(
        au_nc = `Always use` - `Natural course`
      ) %>%
      ungroup()
    
    # 10 point estimates and 10 bootstrap standard errors
    gformula_boot_result <- tibble(
      mi = i, 
      estimate = gform_point$result$`Mean difference`[3], 
      sd = sd(boot_result$au_nc)
    )
    
    gformula_boot_results <- gformula_boot_results %>%
      bind_rows(., gformula_boot_result)
    
    rm(data, time_points, interventions, gform_point, gform_boot, boot_result, gformula_boot_result)
  }
  
  gformula_result <- tibble(
    country = names[j],
    term = "Always use - Natural course",
    mi = gformula_boot_results$mi,
    estimate = gformula_boot_results$estimate,
    sd = gformula_boot_results$sd
  )
  
  gformula_cesd_results <- gformula_cesd_results %>%
    bind_rows(., gformula_result)
  
  rm(gformula_boot_results, gformula_result)
  
}
toc() # 4447.89 sec elapsed

# 6-13
tic()
for(j in 6:13){
  
  gformula_boot_results <- tibble()
  
  for(i in 1:10){
    data <- mi_icum_gformula_merge[[i]] %>% filter(country_names == names[j])
    time_points <- max(data$wave_num) + 1
    interventions <- list(
      list(c(static, rep(0, time_points))), list(c(static, rep(1, time_points)))
      )
    
    # calculate point estimate for `Always use` - `Natural course` using imputed, but not yet bootstrapped data
    gform_point <- gformula(
      obs_data = data, 
      outcome_type = "continuous_eof", outcome_name = "cesd_stand",
      id = "id", time_points = time_points, time_name = "wave_num",
      covnames = covnames, covtypes = covtypes, covparams = covparams,
      ymodel = ymodel, intvars = intvars,
      interventions = interventions, int_descript = int_descript, 
      histories = histories, histvars = histvars, basecovs = c("age", "male", "lowedu"), 
      nsimul = nrow(data), seed = 12345
    )
    
    # calculate bootstrap standard error for `Always use` - `Natural course`
    gform_boot <- gformula(
      obs_data = data, 
      outcome_type = "continuous_eof", outcome_name = "cesd_stand",
      id = "id", time_points = time_points, time_name = "wave_num",
      covnames = covnames, covtypes = covtypes, covparams = covparams,
      ymodel = ymodel, intvars = intvars,
      interventions = interventions, int_descript = int_descript, 
      histories = histories, histvars = histvars, basecovs = c("age", "male", "lowedu"), 
      seed = 12345, nsamples = 100, parallel = TRUE, ncores = 4, 
      ci_method = "normal", boot_diag = TRUE
    )
    
    boot_result <- gform_boot$bootests %>% 
      rowwise() %>%
      mutate(
        au_nc = `Always use` - `Natural course`
      ) %>%
      ungroup()
    
    # 10 point estimates and 10 bootstrap standard errors
    gformula_boot_result <- tibble(
      mi = i, 
      estimate = gform_point$result$`Mean difference`[3], 
      sd = sd(boot_result$au_nc)
    )
    
    gformula_boot_results <- gformula_boot_results %>%
      bind_rows(., gformula_boot_result)
    
    rm(data, time_points, interventions, gform_point, gform_boot, boot_result, gformula_boot_result)
  }
  
  gformula_result <- tibble(
    country = names[j],
    term = "Always use - Natural course",
    mi = gformula_boot_results$mi,
    estimate = gformula_boot_results$estimate,
    sd = gformula_boot_results$sd
  )
  
  gformula_cesd_results <- gformula_cesd_results %>%
    bind_rows(., gformula_result)
  
  rm(gformula_boot_results, gformula_result)
  
}
toc() # 7372.89 sec elapsed

# 14-18
tic()
for(j in 14:18){
  
  gformula_boot_results <- tibble()
  
  for(i in 1:10){
    data <- mi_icum_gformula_merge[[i]] %>% filter(country_names == names[j])
    time_points <- max(data$wave_num) + 1
    interventions <- list(
      list(c(static, rep(0, time_points))), list(c(static, rep(1, time_points)))
      )
    
    # calculate point estimate for `Always use` - `Natural course` using imputed, but not yet bootstrapped data
    gform_point <- gformula(
      obs_data = data, 
      outcome_type = "continuous_eof", outcome_name = "cesd_stand",
      id = "id", time_points = time_points, time_name = "wave_num",
      covnames = covnames, covtypes = covtypes, covparams = covparams,
      ymodel = ymodel, intvars = intvars,
      interventions = interventions, int_descript = int_descript, 
      histories = histories, histvars = histvars, basecovs = c("age", "male", "lowedu"), 
      nsimul = nrow(data), seed = 12345
    )
    
    # calculate bootstrap standard error for `Always use` - `Natural course`
    gform_boot <- gformula(
      obs_data = data, 
      outcome_type = "continuous_eof", outcome_name = "cesd_stand",
      id = "id", time_points = time_points, time_name = "wave_num",
      covnames = covnames, covtypes = covtypes, covparams = covparams,
      ymodel = ymodel, intvars = intvars,
      interventions = interventions, int_descript = int_descript, 
      histories = histories, histvars = histvars, basecovs = c("age", "male", "lowedu"), 
      seed = 12345, nsamples = 100, parallel = TRUE, ncores = 4, 
      ci_method = "normal", boot_diag = TRUE
    )
    
    boot_result <- gform_boot$bootests %>% 
      rowwise() %>%
      mutate(
        au_nc = `Always use` - `Natural course`
      ) %>%
      ungroup()
    
    # 10 point estimates and 10 bootstrap standard errors
    gformula_boot_result <- tibble(
      mi = i, 
      estimate = gform_point$result$`Mean difference`[3], 
      sd = sd(boot_result$au_nc)
    )
    
    gformula_boot_results <- gformula_boot_results %>%
      bind_rows(., gformula_boot_result)
    
    rm(data, time_points, interventions, gform_point, gform_boot, boot_result, gformula_boot_result)
  }
  
  gformula_result <- tibble(
    country = names[j],
    term = "Always use - Natural course",
    mi = gformula_boot_results$mi,
    estimate = gformula_boot_results$estimate,
    sd = gformula_boot_results$sd
  )
  
  gformula_cesd_results <- gformula_cesd_results %>%
    bind_rows(., gformula_result)
  
  rm(gformula_boot_results, gformula_result)
  
}
toc() # 9338.22 sec elapsed


#### Life satisfaction ####
ymodel <- satlife_stand ~ internet_yes + lowwealth + lbrf + nonmarried + hhres + contact + smoken + weekdrink + phyinact + dis + adl_any + iadl + lag1_internet_yes + lag1_lowwealth + lag1_lbrf + lag1_nonmarried + lag1_hhres + lag1_contact + lag1_smoken + lag1_weekdrink + lag1_phyinact + lag1_dis + lag1_adl_any + lag1_iadl + age + male + lowedu

gformula_satlife_results <- tibble()

# 1-5
tic()
for(j in 1:5){
  
  gformula_boot_results <- tibble()
  
  for(i in 1:10){
    data <- mi_icum_gformula_merge[[i]] %>% filter(country_names == names[j])
    time_points <- max(data$wave_num) + 1
    interventions <- list(
      list(c(static, rep(0, time_points))), list(c(static, rep(1, time_points)))
      )
    
    # calculate point estimate for `Always use` - `Natural course` using imputed, but not yet bootstrapped data
    gform_point <- gformula(
      obs_data = data, 
      outcome_type = "continuous_eof", outcome_name = "satlife_stand",
      id = "id", time_points = time_points, time_name = "wave_num",
      covnames = covnames, covtypes = covtypes, covparams = covparams,
      ymodel = ymodel, intvars = intvars,
      interventions = interventions, int_descript = int_descript, 
      histories = histories, histvars = histvars, basecovs = c("age", "male", "lowedu"), 
      nsimul = nrow(data), seed = 12345
    )
    
    # calculate bootstrap standard error for `Always use` - `Natural course`
    gform_boot <- gformula(
      obs_data = data, 
      outcome_type = "continuous_eof", outcome_name = "satlife_stand",
      id = "id", time_points = time_points, time_name = "wave_num",
      covnames = covnames, covtypes = covtypes, covparams = covparams,
      ymodel = ymodel, intvars = intvars,
      interventions = interventions, int_descript = int_descript, 
      histories = histories, histvars = histvars, basecovs = c("age", "male", "lowedu"), 
      seed = 12345, nsamples = 100, parallel = TRUE, ncores = 4, 
      ci_method = "normal", boot_diag = TRUE
    )
    
    boot_result <- gform_boot$bootests %>% 
      rowwise() %>%
      mutate(
        au_nc = `Always use` - `Natural course`
      ) %>%
      ungroup()
    
    # 10 point estimates and 10 bootstrap standard errors
    gformula_boot_result <- tibble(
      mi = i, 
      estimate = gform_point$result$`Mean difference`[3], 
      sd = sd(boot_result$au_nc)
    )
    
    gformula_boot_results <- gformula_boot_results %>%
      bind_rows(., gformula_boot_result)
    
    rm(data, time_points, interventions, gform_point, gform_boot, boot_result, gformula_boot_result)
  }
  
  gformula_result <- tibble(
    country = names[j],
    term = "Always use - Natural course",
    mi = gformula_boot_results$mi,
    estimate = gformula_boot_results$estimate,
    sd = gformula_boot_results$sd
  )
  
  gformula_satlife_results <- gformula_satlife_results %>%
    bind_rows(., gformula_result)
  
  rm(gformula_boot_results, gformula_result)
  
}
toc() # 4077.59 sec elapsed

# 6-13
tic()
for(j in 6:13){
  
  gformula_boot_results <- tibble()
  
  for(i in 1:10){
    data <- mi_icum_gformula_merge[[i]] %>% filter(country_names == names[j])
    time_points <- max(data$wave_num) + 1
    interventions <- list(
      list(c(static, rep(0, time_points))), list(c(static, rep(1, time_points)))
      )
    
    # calculate point estimate for `Always use` - `Natural course` using imputed, but not yet bootstrapped data
    gform_point <- gformula(
      obs_data = data, 
      outcome_type = "continuous_eof", outcome_name = "satlife_stand",
      id = "id", time_points = time_points, time_name = "wave_num",
      covnames = covnames, covtypes = covtypes, covparams = covparams,
      ymodel = ymodel, intvars = intvars,
      interventions = interventions, int_descript = int_descript, 
      histories = histories, histvars = histvars, basecovs = c("age", "male", "lowedu"), 
      nsimul = nrow(data), seed = 12345
    )
    
    # calculate bootstrap standard error for `Always use` - `Natural course`
    gform_boot <- gformula(
      obs_data = data, 
      outcome_type = "continuous_eof", outcome_name = "satlife_stand",
      id = "id", time_points = time_points, time_name = "wave_num",
      covnames = covnames, covtypes = covtypes, covparams = covparams,
      ymodel = ymodel, intvars = intvars,
      interventions = interventions, int_descript = int_descript, 
      histories = histories, histvars = histvars, basecovs = c("age", "male", "lowedu"), 
      seed = 12345, nsamples = 100, parallel = TRUE, ncores = 4, 
      ci_method = "normal", boot_diag = TRUE
    )
    
    boot_result <- gform_boot$bootests %>% 
      rowwise() %>%
      mutate(
        au_nc = `Always use` - `Natural course`
      ) %>%
      ungroup()
    
    # 10 point estimates and 10 bootstrap standard errors
    gformula_boot_result <- tibble(
      mi = i, 
      estimate = gform_point$result$`Mean difference`[3], 
      sd = sd(boot_result$au_nc)
    )
    
    gformula_boot_results <- gformula_boot_results %>%
      bind_rows(., gformula_boot_result)
    
    rm(data, time_points, interventions, gform_point, gform_boot, boot_result, gformula_boot_result)
  }
  
  gformula_result <- tibble(
    country = names[j],
    term = "Always use - Natural course",
    mi = gformula_boot_results$mi,
    estimate = gformula_boot_results$estimate,
    sd = gformula_boot_results$sd
  )
  
  gformula_satlife_results <- gformula_satlife_results %>%
    bind_rows(., gformula_result)
  
  rm(gformula_boot_results, gformula_result)
  
}
toc() # 7502.73 sec elapsed

# 14-18
tic()
for(j in 14:18){
  
  gformula_boot_results <- tibble()
  
  for(i in 1:10){
    data <- mi_icum_gformula_merge[[i]] %>% filter(country_names == names[j])
    time_points <- max(data$wave_num) + 1
    interventions <- list(
      list(c(static, rep(0, time_points))), list(c(static, rep(1, time_points)))
      )
    
    # calculate point estimate for `Always use` - `Natural course` using imputed, but not yet bootstrapped data
    gform_point <- gformula(
      obs_data = data, 
      outcome_type = "continuous_eof", outcome_name = "satlife_stand",
      id = "id", time_points = time_points, time_name = "wave_num",
      covnames = covnames, covtypes = covtypes, covparams = covparams,
      ymodel = ymodel, intvars = intvars,
      interventions = interventions, int_descript = int_descript, 
      histories = histories, histvars = histvars, basecovs = c("age", "male", "lowedu"), 
      nsimul = nrow(data), seed = 12345
    )
    
    # calculate bootstrap standard error for `Always use` - `Natural course`
    gform_boot <- gformula(
      obs_data = data, 
      outcome_type = "continuous_eof", outcome_name = "satlife_stand",
      id = "id", time_points = time_points, time_name = "wave_num",
      covnames = covnames, covtypes = covtypes, covparams = covparams,
      ymodel = ymodel, intvars = intvars,
      interventions = interventions, int_descript = int_descript, 
      histories = histories, histvars = histvars, basecovs = c("age", "male", "lowedu"), 
      seed = 12345, nsamples = 100, parallel = TRUE, ncores = 4, 
      ci_method = "normal", boot_diag = TRUE
    )
    
    boot_result <- gform_boot$bootests %>% 
      rowwise() %>%
      mutate(
        au_nc = `Always use` - `Natural course`
      ) %>%
      ungroup()
    
    # 10 point estimates and 10 bootstrap standard errors
    gformula_boot_result <- tibble(
      mi = i, 
      estimate = gform_point$result$`Mean difference`[3], 
      sd = sd(boot_result$au_nc)
    )
    
    gformula_boot_results <- gformula_boot_results %>%
      bind_rows(., gformula_boot_result)
    
    rm(data, time_points, interventions, gform_point, gform_boot, boot_result, gformula_boot_result)
  }
  
  gformula_result <- tibble(
    country = names[j],
    term = "Always use - Natural course",
    mi = gformula_boot_results$mi,
    estimate = gformula_boot_results$estimate,
    sd = gformula_boot_results$sd
  )
  
  gformula_satlife_results <- gformula_satlife_results %>%
    bind_rows(., gformula_result)
  
  rm(gformula_boot_results, gformula_result)
  
}
toc() # 9210.47 sec elapsed


#### Self-reported health ####
ymodel <- shlt_stand ~ internet_yes + lowwealth + lbrf + nonmarried + hhres + contact + smoken + weekdrink + phyinact + dis + adl_any + iadl + lag1_internet_yes + lag1_lowwealth + lag1_lbrf + lag1_nonmarried + lag1_hhres + lag1_contact + lag1_smoken + lag1_weekdrink + lag1_phyinact + lag1_dis + lag1_adl_any + lag1_iadl + age + male + lowedu

gformula_shlt_results <- tibble()

# 1-5
tic()
for(j in 1:5){
  
  gformula_boot_results <- tibble()
  
  for(i in 1:10){
    data <- mi_icum_gformula_merge[[i]] %>% filter(country_names == names[j])
    time_points <- max(data$wave_num) + 1
    interventions <- list(
      list(c(static, rep(0, time_points))), list(c(static, rep(1, time_points)))
      )
    
    # calculate point estimate for `Always use` - `Natural course` using imputed, but not yet bootstrapped data
    gform_point <- gformula(
      obs_data = data, 
      outcome_type = "continuous_eof", outcome_name = "shlt_stand",
      id = "id", time_points = time_points, time_name = "wave_num",
      covnames = covnames, covtypes = covtypes, covparams = covparams,
      ymodel = ymodel, intvars = intvars,
      interventions = interventions, int_descript = int_descript, 
      histories = histories, histvars = histvars, basecovs = c("age", "male", "lowedu"), 
      nsimul = nrow(data), seed = 12345
    )
    
    # calculate bootstrap standard error for `Always use` - `Natural course`
    gform_boot <- gformula(
      obs_data = data, 
      outcome_type = "continuous_eof", outcome_name = "shlt_stand",
      id = "id", time_points = time_points, time_name = "wave_num",
      covnames = covnames, covtypes = covtypes, covparams = covparams,
      ymodel = ymodel, intvars = intvars,
      interventions = interventions, int_descript = int_descript, 
      histories = histories, histvars = histvars, basecovs = c("age", "male", "lowedu"), 
      seed = 12345, nsamples = 100, parallel = TRUE, ncores = 4, 
      ci_method = "normal", boot_diag = TRUE
    )
    
    boot_result <- gform_boot$bootests %>% 
      rowwise() %>%
      mutate(
        au_nc = `Always use` - `Natural course`
      ) %>%
      ungroup()
    
    # 10 point estimates and 10 bootstrap standard errors
    gformula_boot_result <- tibble(
      mi = i, 
      estimate = gform_point$result$`Mean difference`[3], 
      sd = sd(boot_result$au_nc)
    )
    
    gformula_boot_results <- gformula_boot_results %>%
      bind_rows(., gformula_boot_result)
    
    rm(data, time_points, interventions, gform_point, gform_boot, boot_result, gformula_boot_result)
  }
  
  gformula_result <- tibble(
    country = names[j],
    term = "Always use - Natural course",
    mi = gformula_boot_results$mi,
    estimate = gformula_boot_results$estimate,
    sd = gformula_boot_results$sd
  )
  
  gformula_shlt_results <- gformula_shlt_results %>%
    bind_rows(., gformula_result)
  
  rm(gformula_boot_results, gformula_result)
  
}
toc() # 4296.16 sec elapsed


# 6-13
tic()
for(j in 6:13){
  
  gformula_boot_results <- tibble()
  
  for(i in 1:10){
    data <- mi_icum_gformula_merge[[i]] %>% filter(country_names == names[j])
    time_points <- max(data$wave_num) + 1
    interventions <- list(
      list(c(static, rep(0, time_points))), list(c(static, rep(1, time_points)))
      )
    
    # calculate point estimate for `Always use` - `Natural course` using imputed, but not yet bootstrapped data
    gform_point <- gformula(
      obs_data = data, 
      outcome_type = "continuous_eof", outcome_name = "shlt_stand",
      id = "id", time_points = time_points, time_name = "wave_num",
      covnames = covnames, covtypes = covtypes, covparams = covparams,
      ymodel = ymodel, intvars = intvars,
      interventions = interventions, int_descript = int_descript, 
      histories = histories, histvars = histvars, basecovs = c("age", "male", "lowedu"), 
      nsimul = nrow(data), seed = 12345
    )
    
    # calculate bootstrap standard error for `Always use` - `Natural course`
    gform_boot <- gformula(
      obs_data = data, 
      outcome_type = "continuous_eof", outcome_name = "shlt_stand",
      id = "id", time_points = time_points, time_name = "wave_num",
      covnames = covnames, covtypes = covtypes, covparams = covparams,
      ymodel = ymodel, intvars = intvars,
      interventions = interventions, int_descript = int_descript, 
      histories = histories, histvars = histvars, basecovs = c("age", "male", "lowedu"), 
      seed = 12345, nsamples = 100, parallel = TRUE, ncores = 4, 
      ci_method = "normal", boot_diag = TRUE
    )
    
    boot_result <- gform_boot$bootests %>% 
      rowwise() %>%
      mutate(
        au_nc = `Always use` - `Natural course`
      ) %>%
      ungroup()
    
    # 10 point estimates and 10 bootstrap standard errors
    gformula_boot_result <- tibble(
      mi = i, 
      estimate = gform_point$result$`Mean difference`[3], 
      sd = sd(boot_result$au_nc)
    )
    
    gformula_boot_results <- gformula_boot_results %>%
      bind_rows(., gformula_boot_result)
    
    rm(data, time_points, interventions, gform_point, gform_boot, boot_result, gformula_boot_result)
  }
  
  gformula_result <- tibble(
    country = names[j],
    term = "Always use - Natural course",
    mi = gformula_boot_results$mi,
    estimate = gformula_boot_results$estimate,
    sd = gformula_boot_results$sd
  )
  
  gformula_shlt_results <- gformula_shlt_results %>%
    bind_rows(., gformula_result)
  
  rm(gformula_boot_results, gformula_result)
  
}
toc() # 7568.29 sec elapsed

# 14-18
tic()
for(j in 14:18){
  
  gformula_boot_results <- tibble()
  
  for(i in 1:10){
    data <- mi_icum_gformula_merge[[i]] %>% filter(country_names == names[j])
    time_points <- max(data$wave_num) + 1
    interventions <- list(
      list(c(static, rep(0, time_points))), list(c(static, rep(1, time_points)))
      )
    
    # calculate point estimate for `Always use` - `Natural course` using imputed, but not yet bootstrapped data
    gform_point <- gformula(
      obs_data = data, 
      outcome_type = "continuous_eof", outcome_name = "shlt_stand",
      id = "id", time_points = time_points, time_name = "wave_num",
      covnames = covnames, covtypes = covtypes, covparams = covparams,
      ymodel = ymodel, intvars = intvars,
      interventions = interventions, int_descript = int_descript, 
      histories = histories, histvars = histvars, basecovs = c("age", "male", "lowedu"), 
      nsimul = nrow(data), seed = 12345
    )
    
    # calculate bootstrap standard error for `Always use` - `Natural course`
    gform_boot <- gformula(
      obs_data = data, 
      outcome_type = "continuous_eof", outcome_name = "shlt_stand",
      id = "id", time_points = time_points, time_name = "wave_num",
      covnames = covnames, covtypes = covtypes, covparams = covparams,
      ymodel = ymodel, intvars = intvars,
      interventions = interventions, int_descript = int_descript, 
      histories = histories, histvars = histvars, basecovs = c("age", "male", "lowedu"), 
      seed = 12345, nsamples = 100, parallel = TRUE, ncores = 4, 
      ci_method = "normal", boot_diag = TRUE
    )
    
    boot_result <- gform_boot$bootests %>% 
      rowwise() %>%
      mutate(
        au_nc = `Always use` - `Natural course`
      ) %>%
      ungroup()
    
    # 10 point estimates and 10 bootstrap standard errors
    gformula_boot_result <- tibble(
      mi = i, 
      estimate = gform_point$result$`Mean difference`[3], 
      sd = sd(boot_result$au_nc)
    )
    
    gformula_boot_results <- gformula_boot_results %>%
      bind_rows(., gformula_boot_result)
    
    rm(data, time_points, interventions, gform_point, gform_boot, boot_result, gformula_boot_result)
  }
  
  gformula_result <- tibble(
    country = names[j],
    term = "Always use - Natural course",
    mi = gformula_boot_results$mi,
    estimate = gformula_boot_results$estimate,
    sd = gformula_boot_results$sd
  )
  
  gformula_shlt_results <- gformula_shlt_results %>%
    bind_rows(., gformula_result)
  
  rm(gformula_boot_results, gformula_result)
  
}
toc() # 10102.92 sec elapsed

rm(covnames, covtypes, covparams, ymodel, intvars, int_descript, histories, histvars)


#### Pooling ####
# Self-constructed function to pool g-formula results
pool_gformula_results <- function(country_data) {
  Q <- country_data$estimate
  U <- country_data$sd^2
  n <- unique(country_data$n)
  
  pooled_results <- pool.scalar(Q, U, n = n, k = 1, rule = "rubin1987")
  
  pooled_results_df <- tibble(
    m = pooled_results$m,
    estimate = pooled_results$qbar,
    std.error = sqrt(pooled_results$ubar),
    b = pooled_results$b,
    t = pooled_results$t,
    df = pooled_results$df,
    r = pooled_results$r,
    fmi = pooled_results$fmi
  )
  
  return(pooled_results_df)
}

# Number of observations in each country
for(j in 1:18){
  data <- mi_icum_gformula_merge[[1]] %>% filter(country_names == names[j])
  print(paste(names[j], ": ", nrow(data), sep = ""))
}

country_counts <- data.frame(
  country = c("Austria", "Belgium", "China", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Israel", "Italy", "Luxembourg", "Mexico", "Slovenia", "Spain", "Sweden", "Switzerland", "USA"),
  n = c(4342, 6551, 9366, 7978, 7339, 17561, 7168, 5606, 9166, 1841, 6044, 1807, 25992, 4008, 5705, 7699, 6052, 70805)
)

gformula_cesd_pool_results <- gformula_cesd_results %>%
  left_join(country_counts, by = "country") %>%
  group_by(country) %>%
  summarise(pooled = list(pool_gformula_results(cur_data()))) %>%
  unnest(cols = c(pooled))

gformula_satlife_pool_results <- gformula_satlife_results %>%
  left_join(country_counts, by = "country") %>%
  group_by(country) %>%
  summarise(pooled = list(pool_gformula_results(cur_data()))) %>%
  unnest(cols = c(pooled))

gformula_shlt_pool_results <- gformula_shlt_results %>%
  left_join(country_counts, by = "country") %>%
  group_by(country) %>%
  summarise(pooled = list(pool_gformula_results(cur_data()))) %>%
  unnest(cols = c(pooled))

```

## Figure 5: g-formula

```{r}

#### Theme setting ####
theme <- forestploter::forest_theme(
  core = list(bg_params = list(fill = c("white"))), 
  base_size = 10, 
  # base_family = "Arial",
  ci_pch = 15,
  ci_col = "#3B4992FF", 
  ci_alpha = 1,
  ci_lty = 1,
  ci_lwd = 1,
  ci_Theight = unit(0, "cm"),
  
  xaxis_lwd = 1,
  xaxis_cex = 1,
  
  summary_col = "#008B45FF", 
  refline_col = "gray", 
  refline_lwd = 2, 
  
  title_just = "center",
  title_cex = 1.2,
  title_fontface = "bold",
  title_col = "black",
  
  arrow_type = "closed",
  arrow_label_just = "end",
  arrow_length = 0.05,
  arrow_lwd = 1,
  arrow_fill = "black",
  arrow_col = "black"
  )

#### CES-D ####
# Data
dat <- gformula_cesd_pool_results %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "MD (95% CI)")

p_cesd <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = 0.75,
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Fewer depressive symptoms","More depressive symptoms"),
  xlim = c(-1, 0.25),
  ticks_at = c(-1, -0.75, -0.5, -0.25, 0, 0.25),
  theme = theme
  )

# Add border
p_cesd <- add_border(p_cesd, part = "header", row = 1, col = c(1:4), gp = gpar(lwd = 1))


#### Life satisfaction ####
# Data
dat <- gformula_satlife_pool_results %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "MD (95% CI)")

p_satlife <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = 0.75,
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Lower life satisfaction","Higher life satisfaction"),
  xlim = c(-0.11, 0.5),
  ticks_at = c(-0.1, 0, 0.1, 0.2, 0.3, 0.4, 0.5),
  theme = theme
  )

# Add border
p_satlife <- add_border(p_satlife, part = "header", row = 1, col = c(1:4), gp = gpar(lwd = 1))


#### Self-rated health ####
# Data
dat <- gformula_shlt_pool_results %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "MD (95% CI)")

p_shlt <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = 0.75,
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Worse self-reported health","Better self-reported health"),
  xlim = c(-0.2, 0.6),
  ticks_at = c(-0.2, 0, 0.2, 0.4, 0.6),
  theme = theme
  )

# Add border
p_shlt <- add_border(p_shlt, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))


#### Pool ####
p_pool <- wrap_elements(
  wrap_elements(p_cesd) + wrap_elements(p_satlife) + 
    plot_layout(nrow = 1) + 
    plot_annotation(tag_levels = "a")
  ) 

ggsave(str_c(getwd(), "/results/Figure/Figure 5_Forest plot_gformula.tiff"), plot = p_pool, width = 14, height = 6, unit = "in", dpi = 500, device = "tiff")

ggsave(str_c(getwd(), "/results/Figure/Figure 5_Forest plot_gformula.pdf"), plot = p_pool, width = 14, height = 6, unit = "in", dpi = 300, device = "pdf")

```

## Supplementary Figure 11: g-formula for self-reported health

```{r}

# Self-reported health only
ggsave(str_c(getwd(), "/results/Figure/Supplementary Figure 11_Forest plot_internet use frequency_self-reported health_mice.tiff"), plot = p_shlt, width = 7, height = 6, unit = "in", dpi = 500, device = "tiff")

rm(theme, dat, dat_fig, p_cesd, p_satlife, p_shlt, p_pool)

```


# Sentivity analyses

## Complete cases

### Internet use (yes/no)

#### Linear mixed model and meta analysis

```{r warning=FALSE}

#### Merge data ####
iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

final_iyes_merge <- final_iyes_hrs %>%
  bind_rows(., final_iyes_elsa) %>%
  bind_rows(., final_iyes_charls) %>%
  bind_rows(., final_iyes_share) %>%
  bind_rows(., final_iyes_mhas) %>%
  bind_rows(., final_iyes_elsi) %>%
  mutate(
    country_names = case_when(
      country == iso[1] ~ names[1],
      country == iso[2] ~ names[2],
      country == iso[3] ~ names[3],
      country == iso[4] ~ names[4],
      country == iso[5] ~ names[5],
      country == iso[6] ~ names[6],
      country == iso[7] ~ names[7],
      country == iso[8] ~ names[8],
      country == iso[9] ~ names[9],
      country == iso[10] ~ names[10],
      country == iso[11] ~ names[11],
      country == iso[12] ~ names[12],
      country == iso[13] ~ names[13],
      country == iso[14] ~ names[14],
      country == iso[15] ~ names[15],
      country == iso[16] ~ names[16],
      country == iso[17] ~ names[17],
      country == iso[18] ~ names[18],
      country == iso[19] ~ names[19],
      country == iso[20] ~ names[20],
      country == iso[21] ~ names[21],
      country == iso[22] ~ names[22],
      country == iso[23] ~ names[23]
    )
  )

tic()
### CES-D ####
# lme4
cesd_iyes_adj_results <- tibble()
for(i in 1:23){
  cesd_iyes_adj <- lmer(
    cesd_stand  ~ internet_yes*cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_adj_result <- marginaleffects::avg_comparisons(
    cesd_iyes_adj, variables = "internet_yes", re.form = NA
    ) %>% 
    tidy() %>%
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)

  cesd_iyes_adj_results <- cesd_iyes_adj_results %>% 
    bind_rows(., cesd_iyes_adj_result)
  rm(cesd_iyes_adj, cesd_iyes_adj_result)
}

# metafor
cesd_iyes_adj_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_results, slab = country)

#### Life satisfaction ####
# lme4
satlife_iyes_adj_results <- tibble()
for(i in 1:23){
  satlife_iyes_adj <- lmer(
    satlife_stand  ~ internet_yes*cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_adj_result <- marginaleffects::avg_comparisons(
    satlife_iyes_adj, variables = "internet_yes", re.form = NA
    ) %>% 
    tidy() %>%
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  
  satlife_iyes_adj_results <- satlife_iyes_adj_results %>% 
    bind_rows(., satlife_iyes_adj_result)
  rm(satlife_iyes_adj, satlife_iyes_adj_result)
}

# metafor
satlife_iyes_adj_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_results, slab = country)


#### Self-rated health ####
# lme4
shlt_iyes_adj_results <- tibble()
for(i in 1:23){
  shlt_iyes_adj <- lmer(
    shlt_stand  ~ internet_yes*cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_adj_result <- marginaleffects::avg_comparisons(
    shlt_iyes_adj, variables = "internet_yes", re.form = NA
    ) %>% 
    tidy() %>%
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  
  shlt_iyes_adj_results <- shlt_iyes_adj_results %>% 
    bind_rows(., shlt_iyes_adj_result)
  rm(shlt_iyes_adj, shlt_iyes_adj_result)
}

# metafor
shlt_iyes_adj_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_results, slab = country)

toc()

```

####  Supplementary Figure 12: Associations of Internet use with mental health (complete cases)

```{r}

#### Theme setting ####
theme <- forestploter::forest_theme(
  core = list(bg_params = list(fill = c("white"))), 
  base_size = 10,
  # base_family = "Arial",
  ci_pch = 15,
  ci_col = "#3B4992FF", 
  ci_alpha = 1,
  ci_lty = 1,
  ci_lwd = 1,
  ci_Theight = unit(0, "cm"),
  
  xaxis_lwd = 1,
  xaxis_cex = 1,
  
  summary_col = "#008B45FF", 
  refline_col = "gray", 
  refline_lwd = 2, 
  
  title_just = "center",
  title_cex = 1.2,
  title_fontface = "bold",
  title_col = "black",
  
  arrow_type = "closed",
  arrow_label_just = "end",
  arrow_length = 0.05,
  arrow_lwd = 1,
  arrow_fill = "black",
  arrow_col = "black"
  )

#### CES-D ####
# Data
dat <- cesd_iyes_adj_results %>%
  mutate(weights = weights(cesd_iyes_adj_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(cesd_iyes_adj_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_meta$se), 
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "AME (95% CI)", "Weight (%)")

p_cesd <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Fewer depressive symptoms","More depressive symptoms"),
  xlim = c(-0.5, 0.5),
  ticks_at = c(-0.5, -0.25, 0, 0.25, 0.5),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(cesd_iyes_adj_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(cesd_iyes_adj_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(cesd_iyes_adj_meta$H2, digits = 2)))
    )

p_cesd <- add_text(
  p_cesd, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(cesd_iyes_adj_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(cesd_iyes_adj_meta$k - cesd_iyes_adj_meta$p), ") = ", 
        .(fmtx(cesd_iyes_adj_meta$QE, digits = 2)), ", ",

        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(cesd_iyes_adj_meta$k - cesd_iyes_adj_meta$p), ") = ", 
        .(fmtx(cesd_iyes_adj_meta$QE, digits = 2)), ", ",
        .(fmtp(cesd_iyes_adj_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
  }
  

p_cesd <- add_text(
  p_cesd, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(cesd_iyes_adj_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(cesd_iyes_adj_meta$zval, digits = 2)), ", ",
        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(cesd_iyes_adj_meta$zval, digits = 2)), ", ",
      .(fmtp(cesd_iyes_adj_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )    
  }

p_cesd <- add_text(
  p_cesd, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_cesd <- add_border(p_cesd, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))


#### Life satisfaction ####
# Data
dat <- satlife_iyes_adj_results %>%
  mutate(weights = weights(satlife_iyes_adj_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(satlife_iyes_adj_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_meta$se), 
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "AME (95% CI)", "Weight (%)")

p_satlife <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Lower life satisfaction","Higher life satisfaction"),
  xlim = c(-0.2, 0.8),
  ticks_at = c(-0.2, 0, 0.2, 0.4, 0.6, 0.8),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(satlife_iyes_adj_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(satlife_iyes_adj_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(satlife_iyes_adj_meta$H2, digits = 2)))
    )

p_satlife <- add_text(
  p_satlife, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(satlife_iyes_adj_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(satlife_iyes_adj_meta$k - satlife_iyes_adj_meta$p), ") = ", 
        .(fmtx(satlife_iyes_adj_meta$QE, digits = 2)), ", ",

        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(satlife_iyes_adj_meta$k - satlife_iyes_adj_meta$p), ") = ", 
        .(fmtx(satlife_iyes_adj_meta$QE, digits = 2)), ", ",
        .(fmtp(satlife_iyes_adj_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
  }

p_satlife <- add_text(
  p_satlife, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(satlife_iyes_adj_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(satlife_iyes_adj_meta$zval, digits = 2)), ", ",
        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(satlife_iyes_adj_meta$zval, digits = 2)), ", ",
      .(fmtp(satlife_iyes_adj_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )    
  }

p_satlife <- add_text(
  p_satlife, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_satlife <- add_border(p_satlife, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))

#### Self-rated health ####
# Data
dat <- shlt_iyes_adj_results %>%
  mutate(weights = weights(shlt_iyes_adj_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(shlt_iyes_adj_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_meta$se), 
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "AME (95% CI)", "Weight (%)")

p_shlt <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Worse self-reported health","Better self-reported health"),
  xlim = c(-0.4, 0.4),
  ticks_at = c(-0.4, -0.2, 0, 0.2, 0.4),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(shlt_iyes_adj_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(shlt_iyes_adj_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(shlt_iyes_adj_meta$H2, digits = 2)))
    )

p_shlt <- add_text(
  p_shlt, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(shlt_iyes_adj_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(shlt_iyes_adj_meta$k - shlt_iyes_adj_meta$p), ") = ", 
        .(fmtx(shlt_iyes_adj_meta$QE, digits = 2)), ", ",

        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(shlt_iyes_adj_meta$k - shlt_iyes_adj_meta$p), ") = ", 
        .(fmtx(shlt_iyes_adj_meta$QE, digits = 2)), ", ",
        .(fmtp(shlt_iyes_adj_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
  }

p_shlt <- add_text(
  p_shlt, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(shlt_iyes_adj_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(shlt_iyes_adj_meta$zval, digits = 2)), ", ",
        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(shlt_iyes_adj_meta$zval, digits = 2)), ", ",
      .(fmtp(shlt_iyes_adj_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )    
  }

p_shlt <- add_text(
  p_shlt, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_shlt <- add_border(p_shlt, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))


#### Pool ####
p_pool <- wrap_elements(
  wrap_elements(p_cesd) + wrap_elements(p_satlife) + wrap_elements(p_shlt) + 
    plot_layout(nrow = 2) + 
    plot_annotation(tag_levels = "a")
  ) 

ggsave(str_c(getwd(), "/results/Figure/Supplementary Figure 12_Forest plot_internet use_complete cases.tiff"), plot = p_pool, width = 16, height = 14, unit = "in", dpi = 500, device = "tiff")

rm(theme, dat, dat_fig, test_hetero, test_overall, p_cesd, p_satlife, p_shlt)

```

#### Supplementary Table 1: baseline characteristics 

```{r}

baseline_cov <- final_iyes_merge %>% 
  group_by(id) %>%
  slice(1) %>%
  ungroup() %>%
  mutate(
    depression = ifelse(depression == 1, "yes", "no"), 
    depression = relevel(factor(depression), ref = "no")
    ) %>%
  dplyr::select(
    country_names, wave,
    internet_yes, depression,
    age, male, lowedu, lowwealth, lbrf,
    nonmarried, hhres, contact, smoken, weekdrink, phyinact,
    dis, adl_any, iadl
  )

var_need <- c("internet_yes", "wave", "depression", "age", "male", "nonmarried", "hhres", "contact", "lowedu", "lowwealth", "lbrf", "smoken", "weekdrink", "phyinact", "dis", "adl_any", "iadl")

var_name <- c(
  "Internet use",
  
  "Survey year",
  "Depression",
  "Age (years)",
  "Male",
  "Unmarried",  
  "Household size",
  "Weekly contact",
  
  "Education",
  "Wealth",
  "Labor force status",

  "Current smoker",
  "Weekly alcohol use",
  "Physical inactivity",
  
  "Number of chronic conditions",
  "ADL disability", 
  "IADL"
)

label_list <- list()
for (i in 1:length(var_name)) {
  formula_str <- paste0(var_need[i], " ~ ", "\"", gsub("'", "'", var_name[i]), "\"")
  label_list[[i]] <- as.formula(formula_str)
}

tbl <- baseline_cov %>%
  mutate(
    male = relevel(factor(male, labels = c("no", "yes")), ref = "no"),
    lowedu = factor(lowedu, levels = c("primary", "secondary", "tertiary"), labels = c("Primary", "Secondary", "Tertiary")),
    lowwealth = factor(lowwealth, levels = c("3", "2", "1"), labels = c("Low", "Middle", "High")),
    lbrf = factor(lbrf, levels = c("employed", "retired", "others"), labels = c("Working", "Retired", "Others"))
  ) %>%
  tbl_summary(
    by = country_names,
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      wave ~ "{median}",
      all_categorical() ~ "{n} ({p}%)"
    ),
    label = label_list,
    type = list(wave ~ "continuous", hhres ~ "continuous", dis ~ "continuous",  iadl ~ "continuous"),
    digits = list(all_continuous() ~ 1, all_categorical() ~ c(0, 1)),
    missing = "no"
    )

tbl %>%
  as_flex_table() %>%
  flextable::save_as_docx(path = str_c(getwd(), "/results/Table/Supplementary Table 1_Baseline characteristics by countries_internet use.docx"))

rm(baseline_cov, var_need, var_name, label_list, tbl)

```

#### Extended Data Figure 2: Prevalence of Internet use

```{r}

data_internet_pre <- final_iyes_merge %>% 
  group_by(id) %>% 
  slice(1) %>% 
  ungroup() %>% 
  mutate(internet_yes = as.numeric(internet_yes) - 1) %>%
  group_by(country_names) %>% 
  summarise(prevalence = mean(internet_yes)*100) %>%
  ungroup() %>%
  arrange(prevalence) %>%
  mutate(
    prevalence_label = format(round(prevalence, 1), big.mark = ","),
    country_names = factor(country_names, levels = country_names)
    )
  
p_internet_pre <- ggplot(data = data_internet_pre, aes(x = country_names, y = prevalence, fill = prevalence)) +
  geom_bar(stat = "identity")+
  geom_text(aes(label = prevalence_label), hjust = -0.2, size = 4, fontface = "bold")+
  theme_void() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 16, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 16, vjust = 1, angle = 90, face = "bold"),
    axis.line.x = element_line(colour = "grey", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 1, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 16, hjust = .5)
    ) +
  scale_y_continuous(
    limits = c(0, 100)
  ) +
  scale_fill_gradientn(
    colours = c("#58539f", "#bbbbd6", "#eebabb", "#d86967"),
    breaks = seq(0, 90, by = 10),
    limit = c(0, 90)
    ) +
  coord_flip() +
  labs(
    x = NULL,
    y = "Prevalence (%)",
    title = NULL
  )

ggsave(str_c(getwd(), "/results/Figure/Extended Data Figure 2_Bar plot_internet use prevalence by country.tiff"), plot = p_internet_pre, width = 6, height = 12, unit = "in", dpi = 300, device = "tiff")

ggsave(str_c(getwd(), "/results/Figure/Extended Data Figure 2_Bar plot_internet use prevalence by country.pdf"), plot = p_internet_pre, width = 6, height = 12, unit = "in", dpi = 300, device = "pdf")

ggsave(str_c(getwd(), "/results/Figure/Extended Data Figure 2_Bar plot_internet use prevalence by country.jpeg"), plot = p_internet_pre, width = 6, height = 12, unit = "in", dpi = 300, device = "jpeg")

rm(p_internet_pre)

```

#### Supplementary Figure 5: Correlation between Internet use prevalence and country-level factors

```{r}

dat <- data_internet_pre %>%
  left_join(country_factor, by = join_by(country_names == country))

# GDP per capita
cor <- cor.test(dat$GDP_per_capita, dat$prevalence)

dot_internet_gdp <- ggplot(data = dat) +
  geom_point(
    aes(x = GDP_per_capita, y = prevalence), color = "#3B4992FF", alpha = 1, size = 1.5
    ) + 
  geom_text(
    aes(x = GDP_per_capita, y = prevalence, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = -Inf, parse = F, hjust = 1.05, vjust = 0, size = 4,
    label = bquote(
      paste(
        italic(r), " = ", .(fmtx(cor$estimate, digits = 2)), ", ",
        .(fmtp(cor$p.value, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(8500, 130000)
  ) +
  scale_y_continuous(
    limits = c(0, 90)
  ) +
  labs(
    x = "GDP per capita ($US)",
    y = "Prevalence (%)",
    title = NULL
  )

# Gini index
cor <- cor.test(dat$gini, dat$prevalence)

dot_internet_gini <- ggplot(data = dat) +
  geom_point(
    aes(x = gini, y = prevalence), color = "#3B4992FF", alpha = 1, size = 1.5
    ) + 
  geom_text(
    aes(x = gini, y = prevalence, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = -Inf, parse = F, hjust = 1.05, vjust = 0, size = 4,
    label = bquote(
      paste(
        italic(r), " = ", .(fmtx(cor$estimate, digits = 2)), ", ",
        .(fmtp(cor$p.value, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(24, 54)
  ) +
  scale_y_continuous(
    limits = c(0, 90)
  ) +
  labs(
    x = "Gini index",
    y = "Prevalence (%)",
    title = NULL
  )

# World happiness index
cor <- cor.test(dat$world_happiness_index, dat$prevalence)

dot_internet_whi <- ggplot(data = dat) +
  geom_point(
    aes(x = world_happiness_index, y = prevalence), color = "#3B4992FF", alpha = 1, size = 1.5
    ) + 
  geom_text(
    aes(x = world_happiness_index, y = prevalence, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = -Inf, parse = F, hjust = 1.05, vjust = 0, size = 4,
    label = bquote(
      paste(
        italic(r), " = ", .(fmtx(cor$estimate, digits = 2)), ", ",
        .(fmtp(cor$p.value, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(5.8, 7.68)
  ) +
  scale_y_continuous(
    limits = c(0, 90)
  ) +
  labs(
    x = "World happiness index",
    y = "Prevalence (%)",
    title = NULL
  )

# Hofstede’s index
cor <- cor.test(dat$individualism_score, dat$prevalence)

dot_internet_indiv <- ggplot(data = dat) +
  geom_point(
    aes(x = individualism_score, y = prevalence), color = "#3B4992FF", alpha = 1, size = 1.5
    ) + 
  geom_text(
    aes(x = individualism_score, y = prevalence, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = -Inf, parse = F, hjust = 1.05, vjust = 0, size = 4,
    label = bquote(
      paste(
        italic(r), " = ", .(fmtx(cor$estimate, digits = 2)), ", ",
        .(fmtp(cor$p.value, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(34, 101.5)
  ) +
  scale_y_continuous(
    limits = c(0, 90)
  ) +
  labs(
    x = "Hofstede’s index",
    y = "Prevalence (%)",
    title = NULL
  )

# Healthy life expectancy at birth
cor <- cor.test(dat$healthy_life_expectancy, dat$prevalence)

dot_internet_hale <- ggplot(data = dat) +
  geom_point(
    aes(x = healthy_life_expectancy, y = prevalence), color = "#3B4992FF", alpha = 1, size = 1.5
    ) + 
  geom_text(
    aes(x = healthy_life_expectancy, y = prevalence, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = -Inf, parse = F, hjust = 1.05, vjust = 0, size = 4,
    label = bquote(
      paste(
        italic(r), " = ", .(fmtx(cor$estimate, digits = 2)), ", ",
        .(fmtp(cor$p.value, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(65.2, 72.8)
  ) +
  scale_y_continuous(
    limits = c(0, 90)
  ) +
  labs(
    x = "Healthy life expectancy at birth (years)",
    y = "Prevalence (%)",
    title = NULL
  )


# Internet use rate
cor <- cor.test(dat$internet_use_rate, dat$prevalence)

dot_internet_iuse <- ggplot(data = dat) +
  geom_point(
    aes(x = internet_use_rate, y = prevalence), color = "#3B4992FF", alpha = 1, size = 1.5
    ) + 
  geom_text(
    aes(x = internet_use_rate, y = prevalence, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = -Inf, parse = F, hjust = 1.05, vjust = 0, size = 4,
    label = bquote(
      paste(
        italic(r), " = ", .(fmtx(cor$estimate, digits = 2)), ", ",
        .(fmtp(cor$p.value, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5),
    ) +
  scale_x_continuous(
    limits = c(75, 99)
  ) +
  scale_y_continuous(
    limits = c(0, 90)
  ) +
  labs(
    x = "Internet use rate (%)",
    y = "Prevalence (%)",
    title = NULL
  )

# Digital skills among active population
cor <- cor.test(dat$digital_skills_score, dat$prevalence)

dot_internet_dskill <- ggplot(data = dat) +
  geom_point(
    aes(x = digital_skills_score, y = prevalence), color = "#3B4992FF", alpha = 1, size = 1.5
    ) + 
  geom_text(
    aes(x = digital_skills_score, y = prevalence, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = -Inf, parse = F, hjust = 1.05, vjust = 0, size = 4,
    label = bquote(
      paste(
        italic(r), " = ", .(fmtx(cor$estimate, digits = 2)), ", ",
        .(fmtp(cor$p.value, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5),
    ) +
  scale_x_continuous(
    limits = c(34, 79)
  ) +
  scale_y_continuous(
    limits = c(0, 90)
  ) +
  labs(
    x = "Digital skills among active population",
    y = "Prevalence (%)",
    title = NULL
  )


#### Pool ####
p_pool_dot <- wrap_elements(
  dot_internet_gdp + dot_internet_gini + dot_internet_whi + dot_internet_indiv + 
    dot_internet_hale + dot_internet_iuse + dot_internet_dskill + 
    plot_annotation(tag_levels = "a") +
    plot_layout(nrow = 3)
  )

ggsave(str_c(getwd(), "/results/Figure/Supplementary Figure 5_Dot plot_correlation.tiff"), plot = p_pool_dot, width = 12, height = 12, unit = "in", dpi = 300, device = "tiff")

rm(data_internet_pre, dat, cor, dat, dot_internet_gdp, dot_internet_gini, dot_internet_whi, dot_internet_indiv, dot_internet_hale, dot_internet_iuse, dot_internet_dskill)

```


### Internet use frequency

#### Linear mixed model and meta analysis

```{r warning=FALSE}

#### Merge data ####
iso <- c(156, 826, 840)

names <- c("China", "England", "USA")

final_ifreq_merge <- final_ifreq_hrs %>% mutate(id = as.character(id)) %>%
  bind_rows(., final_ifreq_elsa %>% mutate(id = as.character(id))) %>%
  bind_rows(., final_ifreq_charls %>% mutate(id = as.character(id))) %>%
  mutate(
    country_names = case_when(
      country == iso[1] ~ names[1],
      country == iso[2] ~ names[2],
      country == iso[3] ~ names[3]
    )
  )

tic()
### CES-D ####
cesd_ifreq_adj_results <- tibble()
for(i in 1:3){
  cesd_ifreq_adj <- lmer(
    cesd_stand ~ internet_freq*cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_ifreq_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_ifreq_adj_result <- marginaleffects::avg_comparisons(
    cesd_ifreq_adj, variables = "internet_freq", re.form = NA
    ) %>%
    tidy() %>%
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  
  cesd_ifreq_adj_results <- cesd_ifreq_adj_results %>% 
    bind_rows(., cesd_ifreq_adj_result)
  rm(cesd_ifreq_adj, cesd_ifreq_adj_result)
}


### Life satisfaction ####
satlife_ifreq_adj_results <- tibble()
for(i in 1:3){
  satlife_ifreq_adj <- lmer(
    satlife_stand ~ internet_freq*cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_ifreq_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_ifreq_adj_result <- marginaleffects::avg_comparisons(
    satlife_ifreq_adj, variables = "internet_freq", re.form = NA
    ) %>%
    tidy() %>%
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  
  satlife_ifreq_adj_results <- satlife_ifreq_adj_results %>% 
    bind_rows(., satlife_ifreq_adj_result)
  rm(satlife_ifreq_adj, satlife_ifreq_adj_result)
}

### Self-rated health ####
shlt_ifreq_adj_results <- tibble()
for(i in 1:3){
  shlt_ifreq_adj <- lmer(
    shlt_stand ~ internet_freq*cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_ifreq_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_ifreq_adj_result <- marginaleffects::avg_comparisons(
    shlt_ifreq_adj, variables = "internet_freq", re.form = NA
    ) %>%
    tidy() %>%
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  
  shlt_ifreq_adj_results <- shlt_ifreq_adj_results %>% 
    bind_rows(., shlt_ifreq_adj_result)
  rm(shlt_ifreq_adj, shlt_ifreq_adj_result)
}

toc()

```

#### Supplementary Figure 13: Associations of Internet use frequency with mental health (complete cases)

```{r}

#### Theme setting ####
theme <- forestploter::forest_theme(
  core = list(bg_params = list(fill = c("white"))),
  base_size = 10, 
  # base_family = "Arial",
  ci_pch = 15,
  ci_col = "#3B4992FF", 
  ci_alpha = 1,
  ci_lty = 1,
  ci_lwd = 1,
  ci_Theight = unit(0, "cm"),
  
  xaxis_lwd = 1,
  xaxis_cex = 1,
  
  summary_col = "#008B45FF", 
  refline_col = "gray", 
  refline_lwd = 2, 
  
  title_just = "center",
  title_cex = 1.2,
  title_fontface = "bold",
  title_col = "black",
  
  arrow_type = "closed",
  arrow_label_just = "end",
  arrow_length = 0.05,
  arrow_lwd = 1,
  arrow_fill = "black",
  arrow_col = "black"
  )

#### CES-D ####
dat <- cesd_ifreq_adj_results %>%
  bind_rows(
    tibble(
      country = "China", contrast = "never",
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "England", contrast = "never",
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "USA", contrast = "never",
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = ifelse(contrast == "never", "Reference", beta_ci),
    blank = paste(rep(" ", 10), collapse = " "),
    plot_ci = paste(rep(" ", 20), collapse = " "),
    contrast = factor(contrast, levels = c("never", "notregularly - none", "weekly - none", "daily - none"), labels = c("  Never", "  Less than weekly", "  Weekly", "  Daily"))
  ) %>%
  arrange(country, contrast)

dat_fig <- dat %>%
  select(country, contrast, estimate, lower, upper, beta_ci, blank, plot_ci) %>%
  pivot_wider(
    names_from = country,
    values_from = c(estimate, lower, upper, beta_ci, blank, plot_ci)
  ) %>%
  select(
    contrast, estimate_China, estimate_England, estimate_USA, 
    lower_China, lower_England, lower_USA,
    upper_China, upper_England, upper_USA, 
    plot_ci_China, beta_ci_China, blank_China,
    plot_ci_England, beta_ci_England, blank_England,
    plot_ci_USA, beta_ci_USA
    )
colnames(dat_fig)[colnames(dat_fig) == "contrast"] <- "Internet use frequency"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_China"] <- "China"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_England"] <- "England"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_USA"] <- "USA"
colnames(dat_fig)[colnames(dat_fig) %in% c("beta_ci_China", "beta_ci_England", "beta_ci_USA")] <- "AME (95% CI)"
colnames(dat_fig)[colnames(dat_fig) %in% c("blank_China", "blank_England", "blank_USA")] <- " "


p_cesd <- forestploter::forest(
  dat_fig[,c(1, 11:18)],
  est = list(
    dat_fig$estimate_China,
    dat_fig$estimate_England,
    dat_fig$estimate_USA
  ),
  lower = list(
    dat_fig$lower_China,
    dat_fig$lower_England,
    dat_fig$lower_USA
  ),
  upper = list(
    dat_fig$upper_China,
    dat_fig$upper_England,
    dat_fig$upper_USA
  ),
  ci_column = c(2, 5, 8),
  ref_line = c(0, 0, 0),
  sizes = 0.7,
  xlim = list(
    c(-1.21, 1.2), 
    c(-1.21, 1.2),
    c(-1.21, 1.2)
    ),            
  ticks_at = list(
    c(-1.2, -0.6, 0, 0.6, 1.2), 
    c(-1.2, -0.6, 0, 0.6, 1.2), 
    c(-1.2, -0.6, 0, 0.6, 1.2)
    ),  
  
  arrow_lab = c("Fewer depressive symptoms","More depressive symptoms"),
  theme = theme
  )

# Add border
p_cesd <- add_border(p_cesd, part = "header", row = 1, col = c(1:9), gp = gpar(lwd = 1))


#### Life satisfaction ####
dat <- satlife_ifreq_adj_results %>%
  bind_rows(
    tibble(
      country = "China", contrast = "never", 
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "England", contrast = "never", 
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "USA", contrast = "never", 
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = ifelse(contrast == "never", "Reference", beta_ci),
    blank = paste(rep(" ", 10), collapse = " "),
    plot_ci = paste(rep(" ", 20), collapse = " "),
    contrast = factor(contrast, levels = c("never", "notregularly - none", "weekly - none", "daily - none"), labels = c("  Never", "  Less than weekly", "  Weekly", "  Daily"))
  ) %>%
  arrange(country, contrast)

dat_fig <- dat %>%
  select(country, contrast, estimate, lower, upper, beta_ci, blank, plot_ci) %>%
  pivot_wider(
    names_from = country,
    values_from = c(estimate, lower, upper, beta_ci, blank, plot_ci)
  ) %>%
  select(
    contrast, estimate_China, estimate_England, estimate_USA, 
    lower_China, lower_England, lower_USA,
    upper_China, upper_England, upper_USA, 
    plot_ci_China, beta_ci_China, blank_China,
    plot_ci_England, beta_ci_England, blank_England,
    plot_ci_USA, beta_ci_USA
    )
colnames(dat_fig)[colnames(dat_fig) == "contrast"] <- "Internet use frequency"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_China"] <- "China"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_England"] <- "England"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_USA"] <- "USA"
colnames(dat_fig)[colnames(dat_fig) %in% c("beta_ci_China", "beta_ci_England", "beta_ci_USA")] <- "AME (95% CI)"
colnames(dat_fig)[colnames(dat_fig) %in% c("blank_China", "blank_England", "blank_USA")] <- " "


p_satlife <- forestploter::forest(
  dat_fig[,c(1, 11:18)],
  est = list(
    dat_fig$estimate_China,
    dat_fig$estimate_England,
    dat_fig$estimate_USA
  ),
  lower = list(
    dat_fig$lower_China,
    dat_fig$lower_England,
    dat_fig$lower_USA
  ),
  upper = list(
    dat_fig$upper_China,
    dat_fig$upper_England,
    dat_fig$upper_USA
  ),
  ci_column = c(2, 5, 8),
  ref_line = c(0, 0, 0),
  sizes = 0.7,
  xlim = list(
    c(-1.4, 0.7), 
    c(-1.4, 0.7),
    c(-1.4, 0.7)
    ),            
  ticks_at = list(
    c(-1.4, -0.7, 0, 0.7), 
    c(-1.4, -0.7, 0, 0.7), 
    c(-1.4, -0.7, 0, 0.7)
    ),  
  arrow_lab = c("Lower life satisfaction","Higher life satisfaction"),
  theme = theme
  )

# Add border
p_satlife <- add_border(p_satlife, part = "header", row = 1, col = c(1:9), gp = gpar(lwd = 1))


#### Self-rated health ####
dat <- shlt_ifreq_adj_results %>%
  bind_rows(
    tibble(
      country = "China", contrast = "never", 
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "England", contrast = "never", 
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "USA", contrast = "never", 
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = ifelse(contrast == "never", "Reference", beta_ci),
    blank = paste(rep(" ", 10), collapse = " "),
    plot_ci = paste(rep(" ", 20), collapse = " "),
    contrast = factor(contrast, levels = c("never", "notregularly - none", "weekly - none", "daily - none"), labels = c("  Never", "  Less than weekly", "  Weekly", "  Daily"))
  ) %>%
  arrange(country, contrast)

dat_fig <- dat %>%
  select(country, contrast, estimate, lower, upper, beta_ci, blank, plot_ci) %>%
  pivot_wider(
    names_from = country,
    values_from = c(estimate, lower, upper, beta_ci, blank, plot_ci)
  ) %>%
  select(
    contrast, estimate_China, estimate_England, estimate_USA, 
    lower_China, lower_England, lower_USA,
    upper_China, upper_England, upper_USA, 
    plot_ci_China, beta_ci_China, blank_China,
    plot_ci_England, beta_ci_England, blank_England,
    plot_ci_USA, beta_ci_USA
    )
colnames(dat_fig)[colnames(dat_fig) == "contrast"] <- "Internet use frequency"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_China"] <- "China"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_England"] <- "England"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_USA"] <- "USA"
colnames(dat_fig)[colnames(dat_fig) %in% c("beta_ci_China", "beta_ci_England", "beta_ci_USA")] <- "AME (95% CI)"
colnames(dat_fig)[colnames(dat_fig) %in% c("blank_China", "blank_England", "blank_USA")] <- " "


p_shlt <- forestploter::forest(
  dat_fig[,c(1, 11:18)],
  est = list(
    dat_fig$estimate_China,
    dat_fig$estimate_England,
    dat_fig$estimate_USA
  ),
  lower = list(
    dat_fig$lower_China,
    dat_fig$lower_England,
    dat_fig$lower_USA
  ),
  upper = list(
    dat_fig$upper_China,
    dat_fig$upper_England,
    dat_fig$upper_USA
  ),
  ci_column = c(2, 5, 8),
  ref_line = c(0, 0, 0),
  sizes = 0.7,
  xlim = list(
    c(-0.7, 1.4), 
    c(-0.7, 1.4),
    c(-0.7, 1.4)
    ),            
  ticks_at = list(
    c(-0.7, 0, 0.7, 1.4), 
    c(-0.7, 0, 0.7, 1.4), 
    c(-0.7, 0, 0.7, 1.4)
    ),  
  arrow_lab = c("Worse self-reported health","Better self-reported health"),
  theme = theme
  )

# Add border
p_shlt <- add_border(p_shlt, part = "header", row = 1, col = c(1:9), gp = gpar(lwd = 1))


#### Pool ####
p_pool <- wrap_elements(
  wrap_elements(p_cesd) + wrap_elements(p_satlife) + wrap_elements(p_shlt) +
    plot_layout(nrow = 3) + 
    plot_annotation(tag_levels = "a")
  ) 

ggsave(str_c(getwd(), "/results/Figure/Supplementary Figure 13_Forest plot_internet use frequency_complete cases.tiff"), plot = p_pool, width = 13, height = 8, unit = "in", dpi = 500, device = "tiff")

rm(theme, dat, dat_fig, p_cesd, p_satlife, p_shlt)

```

#### Supplementary Table 3: baseline characteristics 

```{r}

baseline_cov <- final_ifreq_merge %>% 
  group_by(id) %>%
  slice(1) %>%
  ungroup() %>%
  dplyr::select(
    country_names,
    internet_freq, 
    age, male, lowedu, lowwealth, lbrf,
    nonmarried, hhres, contact, smoken, weekdrink, phyinact,
    dis, adl_any, iadl
  )

var_need <- c("internet_freq", "age", "male", "nonmarried", "hhres", "contact", "lowedu", "lowwealth", "lbrf", "smoken", "weekdrink", "phyinact", "dis", "adl_any", "iadl")

var_name <- c(
  "Internet use frequency",
  
  "Age (years)",
  "Male",
  "Unmarried",  
  "Household size",
  "Weekly contact",
  
  "Education",
  "Wealth",
  "Labor force status",

  "Current smoker",
  "Weekly alcohol use",
  "Physical inactivity",
  
  "Number of chronic conditions",
  "ADL disability", 
  "IADL"
)

label_list <- list()
for (i in 1:length(var_name)) {
  formula_str <- paste0(var_need[i], " ~ ", "\"", gsub("'", "'", var_name[i]), "\"")
  label_list[[i]] <- as.formula(formula_str)
}

tbl <- baseline_cov %>%
  mutate(
    internet_freq = factor(internet_freq, levels = c("none", "notregularly", "weekly", "daily"), labels = c("Never", "Less than weekly", "Weekly", "Daily")),
    male = relevel(factor(male, labels = c("no", "yes")), ref = "no"),
    lowedu = factor(lowedu, levels = c("primary", "secondary", "tertiary"), labels = c("Primary", "Secondary", "Tertiary")),
    lowwealth = factor(lowwealth, levels = c("3", "2", "1"), labels = c("Low", "Middle", "High")),
    lbrf = factor(lbrf, levels = c("employed", "retired", "others"), labels = c("Working", "Retired", "Others"))
  ) %>%
  tbl_summary(
    by = country_names,
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    label = label_list,
    type = list(hhres ~ "continuous", dis ~ "continuous",  iadl ~ "continuous"),
    digits = list(all_continuous() ~ 1, all_categorical() ~ c(0, 1)),
    missing = "no"
    )

tbl %>%
  as_flex_table() %>%
  flextable::save_as_docx(path = str_c(getwd(), "/results/Table/Supplementary Table 3_Baseline characteristics by countries_internet use frequency.docx"))

rm(baseline_cov, var_need, var_name, label_list, tbl)

```



### Cumulative internet use

#### Linear mixed model and meta analysis

```{r warning=FALSE}

iso <- c(40, 56, 156, 203, 208, 826, 233, 250, 276, 376, 380, 442, 484, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "China", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Israel", "Italy", "Luxembourg", "Mexico", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

final_icum_merge <- final_icum_hrs %>% mutate(id = as.character(id)) %>%
  bind_rows(., final_icum_elsa %>% mutate(id = as.character(id))) %>%
  bind_rows(., final_icum_charls %>% mutate(id = as.character(id))) %>%
  bind_rows(., final_icum_share) %>%
  bind_rows(., final_icum_mhas) %>%
  mutate(
    country_names = case_when(
      country == iso[1] ~ names[1],
      country == iso[2] ~ names[2],
      country == iso[3] ~ names[3],
      country == iso[4] ~ names[4],
      country == iso[5] ~ names[5],
      country == iso[6] ~ names[6],
      country == iso[7] ~ names[7],
      country == iso[8] ~ names[8],
      country == iso[9] ~ names[9],
      country == iso[10] ~ names[10],
      country == iso[11] ~ names[11],
      country == iso[12] ~ names[12],
      country == iso[13] ~ names[13],
      country == iso[14] ~ names[14],
      country == iso[15] ~ names[15],
      country == iso[16] ~ names[16],
      country == iso[17] ~ names[17],
      country == iso[18] ~ names[18]
    )
  )

tic()
#### CES-D ####
# lme4
cesd_icum_adj_results <- tibble()
for(i in c(1:18)){
  cesd_icum_adj <- lmer(
    cesd_stand ~ internet_cum*cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_icum_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_icum_adj_result <- marginaleffects::avg_comparisons(
    cesd_icum_adj, variables = "internet_cum", re.form = NA
    ) %>% 
    tidy() %>%
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  
  cesd_icum_adj_results <- cesd_icum_adj_results %>% 
    bind_rows(., cesd_icum_adj_result)
  rm(cesd_icum_adj, cesd_icum_adj_result)
}

# metafor
cesd_icum_adj_meta <- rma(yi = estimate, sei = std.error, data = cesd_icum_adj_results, slab = country)


#### Life satisfaction ####
# lme4
satlife_icum_adj_results <- tibble()
for(i in c(1:18)){
  satlife_icum_adj <- lmer(
    satlife_stand ~ internet_cum*cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_icum_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_icum_adj_result <- marginaleffects::avg_comparisons(
    satlife_icum_adj, variables = "internet_cum", re.form = NA
    ) %>% 
    tidy() %>%
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  
  satlife_icum_adj_results <- satlife_icum_adj_results %>% 
    bind_rows(., satlife_icum_adj_result)
  rm(satlife_icum_adj, satlife_icum_adj_result)
}

# metafor
satlife_icum_adj_meta <- rma(yi = estimate, sei = std.error, data = satlife_icum_adj_results, slab = country)


#### Self-rated health ####
# lme4
shlt_icum_adj_results <- tibble()
for(i in c(1:18)){
  shlt_icum_adj <- lmer(
    shlt_stand ~ internet_cum*cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_icum_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_icum_adj_result <- marginaleffects::avg_comparisons(
    shlt_icum_adj, variables = "internet_cum", re.form = NA
    ) %>% 
    tidy() %>%
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  
  shlt_icum_adj_results <- shlt_icum_adj_results %>% 
    bind_rows(., shlt_icum_adj_result)
  rm(shlt_icum_adj, shlt_icum_adj_result)
}

# metafor
shlt_icum_adj_meta <- rma(yi = estimate, sei = std.error, data = shlt_icum_adj_results, slab = country)

toc()

```

#### Supplementary Figure 14: Associations of cumulative Internet use with mental health

```{r}

#### Theme setting ####
theme <- forestploter::forest_theme(
  core = list(bg_params = list(fill = c("white"))), 
  base_size = 10, 
  # base_family = "Arial",
  ci_pch = 15,
  ci_col = "#3B4992FF", 
  ci_alpha = 1,
  ci_lty = 1,
  ci_lwd = 1,
  ci_Theight = unit(0, "cm"),
  
  xaxis_lwd = 1,
  xaxis_cex = 1,
  
  summary_col = "#008B45FF", 
  refline_col = "gray", 
  refline_lwd = 2, 
  
  title_just = "center",
  title_cex = 1.2,
  title_fontface = "bold",
  title_col = "black",
  
  arrow_type = "closed",
  arrow_label_just = "end",
  arrow_length = 0.05,
  arrow_lwd = 1,
  arrow_fill = "black",
  arrow_col = "black"
  )

#### CES-D ####
# Data
dat <- cesd_icum_adj_results %>%
  mutate(weights = weights(cesd_icum_adj_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(cesd_icum_adj_meta$beta),
      std.error = as.numeric(cesd_icum_adj_meta$se), 
      statistic = NA, p.value = NA, p.sig = NA, 
      weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "AME (95% CI)", "Weight (%)")
# colnames(dat_fig) <- c("Country", "", "", "", "Weight (%)")

p_cesd <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Fewer depressive symptoms","More depressive symptoms"),
  xlim = c(-0.4, 0.1),
  ticks_at = c(-0.4, -0.3, -0.2, -0.1, 0, 0.1),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(cesd_icum_adj_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(cesd_icum_adj_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(cesd_icum_adj_meta$H2, digits = 2)))
    )

p_cesd <- add_text(
  p_cesd, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- bquote(
    paste(
      "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
      "Q (", .(cesd_icum_adj_meta$k - cesd_icum_adj_meta$p), ") = ", 
      .(fmtx(cesd_icum_adj_meta$QE, digits = 2)), ", ",
      # .(fmtp(cesd_icum_adj_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      italic(P), " < 0.001"
      )
)

test_hetero <- 
  if(cesd_icum_adj_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(cesd_icum_adj_meta$k - cesd_icum_adj_meta$p), ") = ", 
        .(fmtx(cesd_icum_adj_meta$QE, digits = 2)), ", ",
        
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(cesd_icum_adj_meta$k - cesd_icum_adj_meta$p), ") = ", 
        .(fmtx(cesd_icum_adj_meta$QE, digits = 2)), ", ",
        .(fmtp(cesd_icum_adj_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )
  }

p_cesd <- add_text(
  p_cesd, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(cesd_icum_adj_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(cesd_icum_adj_meta$zval, digits = 2)), ", ",
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(cesd_icum_adj_meta$zval, digits = 2)), ", ",
        .(fmtp(cesd_icum_adj_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )    
  }

p_cesd <- add_text(
  p_cesd, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_cesd <- add_border(p_cesd, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))


#### Life satisfaction ####
# Data
dat <- satlife_icum_adj_results %>%
  mutate(weights = weights(satlife_icum_adj_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(satlife_icum_adj_meta$beta),
      std.error = as.numeric(satlife_icum_adj_meta$se), 
      statistic = NA, p.value = NA, p.sig = NA, 
      weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "AME (95% CI)", "Weight (%)")
# colnames(dat_fig) <- c("Country", "", "", "", "Weight (%)")


p_satlife <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Lower life satisfaction","Higher life satisfaction"),
  xlim = c(-0.2, 0.3),
  ticks_at = c(-0.2, -0.1, 0, 0.1, 0.2, 0.3),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(satlife_icum_adj_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(satlife_icum_adj_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(satlife_icum_adj_meta$H2, digits = 2)))
    )

p_satlife <- add_text(
  p_satlife, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(satlife_icum_adj_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(satlife_icum_adj_meta$k - satlife_icum_adj_meta$p), ") = ", 
        .(fmtx(satlife_icum_adj_meta$QE, digits = 2)), ", ",
        
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(satlife_icum_adj_meta$k - satlife_icum_adj_meta$p), ") = ", 
        .(fmtx(satlife_icum_adj_meta$QE, digits = 2)), ", ",
        .(fmtp(satlife_icum_adj_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )
  }

p_satlife <- add_text(
  p_satlife, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(satlife_icum_adj_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(satlife_icum_adj_meta$zval, digits = 2)), ", ",
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(satlife_icum_adj_meta$zval, digits = 2)), ", ",
        .(fmtp(satlife_icum_adj_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )    
  }

p_satlife <- add_text(
  p_satlife, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_satlife <- add_border(p_satlife, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))

#### Self-rated health ####
# Data
dat <- shlt_icum_adj_results %>%
  mutate(weights = weights(shlt_icum_adj_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(shlt_icum_adj_meta$beta),
      std.error = as.numeric(shlt_icum_adj_meta$se), 
      statistic = NA, p.value = NA, p.sig = NA, 
      weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "AME (95% CI)", "Weight (%)")
# colnames(dat_fig) <- c("Country", "", "", "", "Weight (%)")


p_shlt <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Worse self-reported health","Better self-reported health"),
  xlim = c(-0.1, 0.3),
  ticks_at = c(-0.1, 0, 0.1, 0.2, 0.3),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(shlt_icum_adj_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(shlt_icum_adj_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(shlt_icum_adj_meta$H2, digits = 2)))
    )

p_shlt <- add_text(
  p_shlt, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(shlt_icum_adj_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(shlt_icum_adj_meta$k - shlt_icum_adj_meta$p), ") = ", 
        .(fmtx(shlt_icum_adj_meta$QE, digits = 2)), ", ",
        
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(shlt_icum_adj_meta$k - shlt_icum_adj_meta$p), ") = ", 
        .(fmtx(shlt_icum_adj_meta$QE, digits = 2)), ", ",
        .(fmtp(shlt_icum_adj_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )
  }

p_shlt <- add_text(
  p_shlt, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(shlt_icum_adj_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(shlt_icum_adj_meta$zval, digits = 2)), ", ",
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(shlt_icum_adj_meta$zval, digits = 2)), ", ",
        .(fmtp(shlt_icum_adj_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )    
  }

p_shlt <- add_text(
  p_shlt, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_shlt <- add_border(p_shlt, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))


#### Pool ####
p_pool <- wrap_elements(
  wrap_elements(p_cesd) + wrap_elements(p_satlife) + wrap_elements(p_shlt) + 
    plot_layout(nrow = 2) + 
    plot_annotation(tag_levels = "a")
  ) 

ggsave(str_c(getwd(), "/results/Figure/Supplementary Figure 14_Forest plot_cumulative internet use_complete cases.tiff"), plot = p_pool, width = 16, height = 12, unit = "in", dpi = 500, device = "tiff")

```

#### Supplementary Table 2: baseline characteristics 

```{r}

baseline_cov <- final_icum_merge %>% 
  group_by(id) %>%
  slice(1) %>%
  ungroup() %>%
  dplyr::select(
    country_names, 
    internet_cum, 
    age, male, lowedu, lowwealth, lbrf,
    nonmarried, hhres, contact, smoken, weekdrink, phyinact,
    dis, adl_any, iadl
  )

var_need <- c("internet_cum", "age", "male", "nonmarried", "hhres", "contact", "lowedu", "lowwealth", "lbrf", "smoken", "weekdrink", "phyinact", "dis", "adl_any", "iadl")

var_name <- c(
  "Cumulative internet use",
  
  "Age (years)",
  "Male",
  "Unmarried",  
  "Household size",
  "Weekly contact",
  
  "Education",
  "Wealth",
  "Labor force status",

  "Current smoker",
  "Weekly alcohol use",
  "Physical inactivity",
  
  "Number of chronic conditions",
  "ADL disability", 
  "IADL"
)

label_list <- list()
for (i in 1:length(var_name)) {
  formula_str <- paste0(var_need[i], " ~ ", "\"", gsub("'", "'", var_name[i]), "\"")
  label_list[[i]] <- as.formula(formula_str)
}

tbl <- baseline_cov %>%
  mutate(
    male = relevel(factor(male, labels = c("no", "yes")), ref = "no"),
    lowedu = factor(lowedu, levels = c("primary", "secondary", "tertiary"), labels = c("Primary", "Secondary", "Tertiary")),
    lowwealth = factor(lowwealth, levels = c("3", "2", "1"), labels = c("Low", "Middle", "High")),
    lbrf = factor(lbrf, levels = c("employed", "retired", "others"), labels = c("Working", "Retired", "Others"))
  ) %>%
  tbl_summary(
    by = country_names,
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    label = label_list,
    type = list(dis ~ "continuous",  iadl ~ "continuous"),
    digits = list(all_continuous() ~ 1, all_categorical() ~ c(0, 1)),
    missing = "no"
    )

tbl %>%
  as_flex_table() %>%
  flextable::save_as_docx(path = str_c(getwd(), "/results/Table/Supplementary Table 2_Baseline characteristics by countries_cumulative internet use.docx"))

rm(baseline_cov, var_need, var_name, label_list, tbl)

```


### Internet use and genetic risk

#### Supplementary Table 1: baseline characteristics 

```{r}

iso <- c(826, 840)

names <- c("England", "USA")

final_iyes_pgs_merge <- final_iyes_pgs_hrs %>%
  bind_rows(., final_iyes_pgs_elsa) %>%
  mutate(
    country_names = case_when(
      country == iso[1] ~ names[1],
      country == iso[2] ~ names[2]
    )
  )

baseline_cov <- final_iyes_pgs_merge %>% 
  group_by(id) %>%
  slice(1) %>%
  ungroup() %>%
  dplyr::select(
    country_names, 
    internet_yes, highdeprepgs, highwellbpgs, 
    age, male, lowedu, lowwealth, lbrf,
    nonmarried, hhres, contact, smoken, weekdrink, phyinact,
    dis, adl_any, iadl
  )

var_need <- c("internet_yes", "highdeprepgs", "highwellbpgs", "age", "male", "nonmarried", "hhres", "contact", "lowedu", "lowwealth", "lbrf", "smoken", "weekdrink", "phyinact", "dis", "adl_any", "iadl")

var_name <- c(
  "Internet use",
  "Polygenic score for depressive symptoms",
  "Polygenic score for subjective well-being",
  
  "Age (years)",
  "Male",
  "Unmarried",  
  "Household size",
  "Weekly contact",
  
  "Education",
  "Wealth",
  "Labor force status",

  "Current smoker",
  "Weekly alcohol use",
  "Physical inactivity",
  
  "Number of chronic conditions",
  "ADL disability", 
  "IADL"
)

label_list <- list()
for (i in 1:length(var_name)) {
  formula_str <- paste0(var_need[i], " ~ ", "\"", gsub("'", "'", var_name[i]), "\"")
  label_list[[i]] <- as.formula(formula_str)
}

tbl <- baseline_cov %>%
  mutate(
    male = relevel(factor(male, labels = c("no", "yes")), ref = "no"),
    lowedu = factor(lowedu, levels = c("primary", "secondary", "tertiary"), labels = c("Primary", "Secondary", "Tertiary")),
    lowwealth = factor(lowwealth, levels = c("3", "2", "1"), labels = c("Low", "Middle", "High")),
    lbrf = factor(lbrf, levels = c("employed", "retired", "others"), labels = c("Working", "Retired", "Others"))
  ) %>%
  tbl_summary(
    by = country_names,
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    label = label_list,
    type = list(hhres ~ "continuous", dis ~ "continuous",  iadl ~ "continuous"),
    digits = list(all_continuous() ~ 1, all_categorical() ~ c(0, 1)),
    missing = "no"
    )

tbl %>%
  as_flex_table() %>%
  flextable::save_as_docx(path = str_c(getwd(), "/results/Table/Supplementary Table 4_Baseline characteristics by countries_pgs.docx"))

rm(baseline_cov, var_need, var_name, label_list, tbl)

```

### Median follow-up time + total number of observations and participants

```{r}

# Number of participants
length(unique(final_iyes_merge$id)) # 87559
length(unique(final_ifreq_merge$id)) # 15363
length(unique(final_icum_merge$id)) # 50644
length(unique(final_iyes_pgs_merge$id)) # 13453

# Number of observations
nrow(final_iyes_merge) # 298199

# Median of follow-up
end <- final_iyes_merge %>% 
  group_by(id) %>%
  slice(n()) %>%
  ungroup() %>%
  dplyr::select(
    country_names, cwave
  ) 
skim(end)
print(end %>% group_by(country_names) %>% summarise(median(cwave)), n = 50)

```

## Inverse probability weighting

### Internet use (yes/no)

#### Linear mixed model and meta analysis

```{r warning=FALSE}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

tic()
#### CES-D ####
# lme4
cesd_iyes_adj_mi_attr_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    cesd_iyes_adj_mi <- lmer(
      cesd_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi, 
      control = lmerControl(optimizer = "bobyqa"), weights = attrition_ipw
      ) # Brazil dont have missing values

    cesd_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      cesd_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    cesd_iyes_adj_mi <- lapply(mi_iyes_merge, function(x){
      lmer(
        cesd_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'), weights = attrition_ipw)
      })
    cesd_iyes_adj_mi_result <- lapply(seq_along(cesd_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }
  
  cesd_iyes_adj_mi_attr_results <- cesd_iyes_adj_mi_attr_results %>% 
    bind_rows(., cesd_iyes_adj_mi_result)
  
  rm(cesd_iyes_adj_mi, cesd_iyes_adj_mi_result)
}
toc()

# metafor
cesd_iyes_adj_mi_attr_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_mi_attr_results, slab = country)


#### Life satisfaction ####
# lme4
satlife_iyes_adj_mi_attr_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    satlife_iyes_adj_mi <- lmer(
      satlife_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi, 
      control = lmerControl(optimizer = "bobyqa"), weights = attrition_ipw
      ) # Brazil dont have missing values

    satlife_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      satlife_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    satlife_iyes_adj_mi <- lapply(mi_iyes_merge, function(x){
      lmer(
        satlife_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'), weights = attrition_ipw)
      })
    satlife_iyes_adj_mi_result <- lapply(seq_along(satlife_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }
  
  satlife_iyes_adj_mi_attr_results <- satlife_iyes_adj_mi_attr_results %>% 
    bind_rows(., satlife_iyes_adj_mi_result)
  
  rm(satlife_iyes_adj_mi, satlife_iyes_adj_mi_result)
}
toc()

# metafor
satlife_iyes_adj_mi_attr_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_mi_attr_results, slab = country)


#### Self-rated health ####
# lme4
shlt_iyes_adj_mi_attr_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    shlt_iyes_adj_mi <- lmer(
      shlt_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi, 
      control = lmerControl(optimizer = "bobyqa"), weights = attrition_ipw
      ) # Brazil dont have missing values

    shlt_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      shlt_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    shlt_iyes_adj_mi <- lapply(mi_iyes_merge, function(x){
      lmer(
        shlt_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'), weights = attrition_ipw)
      })
    shlt_iyes_adj_mi_result <- lapply(seq_along(shlt_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }
  
  shlt_iyes_adj_mi_attr_results <- shlt_iyes_adj_mi_attr_results %>% 
    bind_rows(., shlt_iyes_adj_mi_result)
  
  rm(shlt_iyes_adj_mi, shlt_iyes_adj_mi_result)
}
toc()

# metafor
shlt_iyes_adj_mi_attr_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_mi_attr_results, slab = country)

```

#### Supplementary Figure 15: Associations of Internet use with mental health - inverse probability weighting

```{r}

#### Theme setting ####
theme <- forestploter::forest_theme(
  core = list(bg_params = list(fill = c("white"))), 
  base_size = 10, 
  # base_family = "Arial",
  ci_pch = 15,
  ci_col = "#3B4992FF", 
  ci_alpha = 1,
  ci_lty = 1,
  ci_lwd = 1,
  ci_Theight = unit(0, "cm"),
  
  xaxis_lwd = 1,
  xaxis_cex = 1,
  
  summary_col = "#008B45FF", 
  refline_col = "gray", 
  refline_lwd = 2, 
  
  title_just = "center",
  title_cex = 1.2,
  title_fontface = "bold",
  title_col = "black",
  
  arrow_type = "closed",
  arrow_label_just = "end",
  arrow_length = 0.05,
  arrow_lwd = 1,
  arrow_fill = "black",
  arrow_col = "black"
  )

#### CES-D ####
# Data
dat <- cesd_iyes_adj_mi_attr_results %>%
  mutate(weights = weights(cesd_iyes_adj_mi_attr_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(cesd_iyes_adj_mi_attr_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_mi_attr_meta$se), 
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "AME (95% CI)", "Weight (%)")

p_cesd <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Fewer depressive symptoms","More depressive symptoms"),
  xlim = c(-0.5, 0.5),
  ticks_at = c(-0.5, -0.25, 0, 0.25, 0.5),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(cesd_iyes_adj_mi_attr_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(cesd_iyes_adj_mi_attr_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(cesd_iyes_adj_mi_attr_meta$H2, digits = 2)))
    )

p_cesd <- add_text(
  p_cesd, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(cesd_iyes_adj_mi_attr_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(cesd_iyes_adj_mi_attr_meta$k - cesd_iyes_adj_mi_attr_meta$p), ") = ", 
        .(fmtx(cesd_iyes_adj_mi_attr_meta$QE, digits = 2)), ", ",

        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(cesd_iyes_adj_mi_attr_meta$k - cesd_iyes_adj_mi_attr_meta$p), ") = ", 
        .(fmtx(cesd_iyes_adj_mi_attr_meta$QE, digits = 2)), ", ",
        .(fmtp(cesd_iyes_adj_mi_attr_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
  }
  

p_cesd <- add_text(
  p_cesd, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(cesd_iyes_adj_mi_attr_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(cesd_iyes_adj_mi_attr_meta$zval, digits = 2)), ", ",
        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(cesd_iyes_adj_mi_attr_meta$zval, digits = 2)), ", ",
      .(fmtp(cesd_iyes_adj_mi_attr_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )    
  }

p_cesd <- add_text(
  p_cesd, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_cesd <- add_border(p_cesd, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))


#### Life satisfaction ####
# Data
dat <- satlife_iyes_adj_mi_attr_results %>%
  mutate(weights = weights(satlife_iyes_adj_mi_attr_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(satlife_iyes_adj_mi_attr_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_mi_attr_meta$se), 
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "AME (95% CI)", "Weight (%)")

p_satlife <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Lower life satisfaction","Higher life satisfaction"),
  xlim = c(-0.2, 0.8),
  ticks_at = c(-0.2, 0, 0.2, 0.4, 0.6, 0.8),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(satlife_iyes_adj_mi_attr_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(satlife_iyes_adj_mi_attr_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(satlife_iyes_adj_mi_attr_meta$H2, digits = 2)))
    )

p_satlife <- add_text(
  p_satlife, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(satlife_iyes_adj_mi_attr_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(satlife_iyes_adj_mi_attr_meta$k - satlife_iyes_adj_mi_attr_meta$p), ") = ", 
        .(fmtx(satlife_iyes_adj_mi_attr_meta$QE, digits = 2)), ", ",

        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(satlife_iyes_adj_mi_attr_meta$k - satlife_iyes_adj_mi_attr_meta$p), ") = ", 
        .(fmtx(satlife_iyes_adj_mi_attr_meta$QE, digits = 2)), ", ",
        .(fmtp(satlife_iyes_adj_mi_attr_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
  }

p_satlife <- add_text(
  p_satlife, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(satlife_iyes_adj_mi_attr_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(satlife_iyes_adj_mi_attr_meta$zval, digits = 2)), ", ",
        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(satlife_iyes_adj_mi_attr_meta$zval, digits = 2)), ", ",
      .(fmtp(satlife_iyes_adj_mi_attr_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )    
  }

p_satlife <- add_text(
  p_satlife, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_satlife <- add_border(p_satlife, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))

#### Self-rated health ####
# Data
dat <- shlt_iyes_adj_mi_attr_results %>%
  mutate(weights = weights(shlt_iyes_adj_mi_attr_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(shlt_iyes_adj_mi_attr_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_mi_attr_meta$se), 
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "AME (95% CI)", "Weight (%)")

p_shlt <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Worse self-reported health","Better self-reported health"),
  xlim = c(-0.4, 0.4),
  ticks_at = c(-0.4, -0.2, 0, 0.2, 0.4),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(shlt_iyes_adj_mi_attr_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(shlt_iyes_adj_mi_attr_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(shlt_iyes_adj_mi_attr_meta$H2, digits = 2)))
    )

p_shlt <- add_text(
  p_shlt, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(shlt_iyes_adj_mi_attr_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(shlt_iyes_adj_mi_attr_meta$k - shlt_iyes_adj_mi_attr_meta$p), ") = ", 
        .(fmtx(shlt_iyes_adj_mi_attr_meta$QE, digits = 2)), ", ",

        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(shlt_iyes_adj_mi_attr_meta$k - shlt_iyes_adj_mi_attr_meta$p), ") = ", 
        .(fmtx(shlt_iyes_adj_mi_attr_meta$QE, digits = 2)), ", ",
        .(fmtp(shlt_iyes_adj_mi_attr_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
  }

p_shlt <- add_text(
  p_shlt, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(shlt_iyes_adj_mi_attr_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(shlt_iyes_adj_mi_attr_meta$zval, digits = 2)), ", ",
        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(shlt_iyes_adj_mi_attr_meta$zval, digits = 2)), ", ",
      .(fmtp(shlt_iyes_adj_mi_attr_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )    
  }

p_shlt <- add_text(
  p_shlt, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_shlt <- add_border(p_shlt, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))


#### Pool ####
p_pool <- wrap_elements(
  wrap_elements(p_cesd) + wrap_elements(p_satlife) + wrap_elements(p_shlt) + 
    plot_layout(nrow = 2) + 
    plot_annotation(tag_levels = "a")
  ) 

ggsave(str_c(getwd(), "/results/Figure/Supplementary Figure 15_Forest plot_internet use_mice_attr_iptw.tiff"), plot = p_pool, width = 16, height = 14, unit = "in", dpi = 500, device = "tiff")

rm(theme, dat, dat_fig, test_hetero, test_overall, p_cesd, p_satlife, p_shlt)

```

### Internet use frequency

#### Linear mixed model and meta analysis

```{r warning=FALSE}

#### Merge data ####
iso <- c(156, 826, 840)

names <- c("China", "England", "USA")

tic()
#### CES-D ####
cesd_ifreq_adj_mi_attr_results <- tibble()
for(i in 1:3){
  cesd_ifreq_adj_mi <- lapply(mi_ifreq_merge, function(x){
    lmer(
      cesd_stand ~ internet_freq*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'), weights = attrition_ipw)
  })
  
  cesd_ifreq_adj_mi_attr_result <- lapply(seq_along(cesd_ifreq_adj_mi), \(j) 
    marginaleffects::avg_comparisons(
      cesd_ifreq_adj_mi[[j]], variables = "internet_freq", re.form = NA)
    ) %>%
    mice::pool() %>%
    tidy() %>%
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  
  cesd_ifreq_adj_mi_attr_results <- cesd_ifreq_adj_mi_attr_results %>% 
    bind_rows(., cesd_ifreq_adj_mi_attr_result)
  
  rm(cesd_ifreq_adj_mi, cesd_ifreq_adj_mi_attr_result)
}

#### Life satisfaction ####
satlife_ifreq_adj_mi_attr_results <- tibble()
for(i in 1:3){
  satlife_ifreq_adj_mi <- lapply(mi_ifreq_merge, function(x){
    lmer(
      satlife_stand ~ internet_freq*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'), weights = attrition_ipw)
  })
  
  satlife_ifreq_adj_mi_attr_result <- lapply(seq_along(satlife_ifreq_adj_mi), \(j) 
    marginaleffects::avg_comparisons(
      satlife_ifreq_adj_mi[[j]], variables = "internet_freq", re.form = NA)
    ) %>%
    mice::pool() %>%
    tidy() %>%
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  
  satlife_ifreq_adj_mi_attr_results <- satlife_ifreq_adj_mi_attr_results %>% 
    bind_rows(., satlife_ifreq_adj_mi_attr_result)
  
  rm(satlife_ifreq_adj_mi, satlife_ifreq_adj_mi_attr_result)
}

#### Self-rated health ####
shlt_ifreq_adj_mi_attr_results <- tibble()
for(i in 1:3){
  shlt_ifreq_adj_mi <- lapply(mi_ifreq_merge, function(x){
    lmer(
      shlt_stand ~ internet_freq*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'), weights = attrition_ipw)
  })
  
  shlt_ifreq_adj_mi_attr_result <- lapply(seq_along(shlt_ifreq_adj_mi), \(j) 
    marginaleffects::avg_comparisons(
      shlt_ifreq_adj_mi[[j]], variables = "internet_freq", re.form = NA)
    ) %>%
    mice::pool() %>%
    tidy() %>%
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  
  shlt_ifreq_adj_mi_attr_results <- shlt_ifreq_adj_mi_attr_results %>% 
    bind_rows(., shlt_ifreq_adj_mi_attr_result)
  
  rm(shlt_ifreq_adj_mi, shlt_ifreq_adj_mi_attr_result)
}

toc()

```

#### Supplementary Figure 16: Associations of Internet use frequency with mental health

```{r}

#### Theme setting ####
theme <- forestploter::forest_theme(
  core = list(bg_params = list(fill = c("white"))),
  base_size = 10, 
  # base_family = "Arial",
  ci_pch = 15,
  ci_col = "#3B4992FF", 
  ci_alpha = 1,
  ci_lty = 1,
  ci_lwd = 1,
  ci_Theight = unit(0, "cm"),
  
  xaxis_lwd = 1,
  xaxis_cex = 1,
  
  summary_col = "#008B45FF", 
  refline_col = "gray", 
  refline_lwd = 2, 
  
  title_just = "center",
  title_cex = 1.2,
  title_fontface = "bold",
  title_col = "black",
  
  arrow_type = "closed",
  arrow_label_just = "end",
  arrow_length = 0.05,
  arrow_lwd = 1,
  arrow_fill = "black",
  arrow_col = "black"
  )

#### CES-D ####
dat <- cesd_ifreq_adj_mi_attr_results %>%
  bind_rows(
    tibble(
      country = "China", contrast = "never",
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "England", contrast = "never",
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "USA", contrast = "never",
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = ifelse(contrast == "never", "Reference", beta_ci),
    blank = paste(rep(" ", 10), collapse = " "),
    plot_ci = paste(rep(" ", 20), collapse = " "),
    contrast = factor(contrast, levels = c("never", "notregularly - none", "weekly - none", "daily - none"), labels = c("  Never", "  Less than weekly", "  Weekly", "  Daily"))
  ) %>%
  arrange(country, contrast)

dat_fig <- dat %>%
  select(country, contrast, estimate, lower, upper, beta_ci, blank, plot_ci) %>%
  pivot_wider(
    names_from = country,
    values_from = c(estimate, lower, upper, beta_ci, blank, plot_ci)
  ) %>%
  select(
    contrast, estimate_China, estimate_England, estimate_USA, 
    lower_China, lower_England, lower_USA,
    upper_China, upper_England, upper_USA, 
    plot_ci_China, beta_ci_China, blank_China,
    plot_ci_England, beta_ci_England, blank_England,
    plot_ci_USA, beta_ci_USA
    )
colnames(dat_fig)[colnames(dat_fig) == "contrast"] <- "Internet use frequency"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_China"] <- "China"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_England"] <- "England"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_USA"] <- "USA"
colnames(dat_fig)[colnames(dat_fig) %in% c("beta_ci_China", "beta_ci_England", "beta_ci_USA")] <- "AME (95% CI)"
colnames(dat_fig)[colnames(dat_fig) %in% c("blank_China", "blank_England", "blank_USA")] <- " "


p_cesd <- forestploter::forest(
  dat_fig[,c(1, 11:18)],
  est = list(
    dat_fig$estimate_China,
    dat_fig$estimate_England,
    dat_fig$estimate_USA
  ),
  lower = list(
    dat_fig$lower_China,
    dat_fig$lower_England,
    dat_fig$lower_USA
  ),
  upper = list(
    dat_fig$upper_China,
    dat_fig$upper_England,
    dat_fig$upper_USA
  ),
  ci_column = c(2, 5, 8),
  ref_line = c(0, 0, 0),
  sizes = 0.7,
  xlim = list(
    c(-1.22, 1.2), 
    c(-1.22, 1.2),
    c(-1.22, 1.2)
    ),            
  ticks_at = list(
    c(-1.2, -0.6, 0, 0.6, 1.2), 
    c(-1.2, -0.6, 0, 0.6, 1.2), 
    c(-1.2, -0.6, 0, 0.6, 1.2)
    ),  
  
  arrow_lab = c("Fewer depressive symptoms","More depressive symptoms"),
  theme = theme
  )

# Add border
p_cesd <- add_border(p_cesd, part = "header", row = 1, col = c(1:9), gp = gpar(lwd = 1))


#### Life satisfaction ####
dat <- satlife_ifreq_adj_mi_attr_results %>%
  bind_rows(
    tibble(
      country = "China", contrast = "never", 
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "England", contrast = "never", 
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "USA", contrast = "never", 
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = ifelse(contrast == "never", "Reference", beta_ci),
    blank = paste(rep(" ", 10), collapse = " "),
    plot_ci = paste(rep(" ", 20), collapse = " "),
    contrast = factor(contrast, levels = c("never", "notregularly - none", "weekly - none", "daily - none"), labels = c("  Never", "  Less than weekly", "  Weekly", "  Daily"))
  ) %>%
  arrange(country, contrast)

dat_fig <- dat %>%
  select(country, contrast, estimate, lower, upper, beta_ci, blank, plot_ci) %>%
  pivot_wider(
    names_from = country,
    values_from = c(estimate, lower, upper, beta_ci, blank, plot_ci)
  ) %>%
  select(
    contrast, estimate_China, estimate_England, estimate_USA, 
    lower_China, lower_England, lower_USA,
    upper_China, upper_England, upper_USA, 
    plot_ci_China, beta_ci_China, blank_China,
    plot_ci_England, beta_ci_England, blank_England,
    plot_ci_USA, beta_ci_USA
    )
colnames(dat_fig)[colnames(dat_fig) == "contrast"] <- "Internet use frequency"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_China"] <- "China"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_England"] <- "England"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_USA"] <- "USA"
colnames(dat_fig)[colnames(dat_fig) %in% c("beta_ci_China", "beta_ci_England", "beta_ci_USA")] <- "AME (95% CI)"
colnames(dat_fig)[colnames(dat_fig) %in% c("blank_China", "blank_England", "blank_USA")] <- " "


p_satlife <- forestploter::forest(
  dat_fig[,c(1, 11:18)],
  est = list(
    dat_fig$estimate_China,
    dat_fig$estimate_England,
    dat_fig$estimate_USA
  ),
  lower = list(
    dat_fig$lower_China,
    dat_fig$lower_England,
    dat_fig$lower_USA
  ),
  upper = list(
    dat_fig$upper_China,
    dat_fig$upper_England,
    dat_fig$upper_USA
  ),
  ci_column = c(2, 5, 8),
  ref_line = c(0, 0, 0),
  sizes = 0.7,
  xlim = list(
    c(-1.4, 0.7), 
    c(-1.4, 0.7),
    c(-1.4, 0.7)
    ),            
  ticks_at = list(
    c(-1.4, -0.7, 0, 0.7), 
    c(-1.4, -0.7, 0, 0.7), 
    c(-1.4, -0.7, 0, 0.7)
    ),  
  arrow_lab = c("Lower life satisfaction","Higher life satisfaction"),
  theme = theme
  )

# Add border
p_satlife <- add_border(p_satlife, part = "header", row = 1, col = c(1:9), gp = gpar(lwd = 1))


#### Self-rated health ####
dat <- shlt_ifreq_adj_mi_attr_results %>%
  bind_rows(
    tibble(
      country = "China", contrast = "never", 
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "England", contrast = "never", 
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "USA", contrast = "never", 
      estimate = 0, std.error = 0, statistic = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = ifelse(contrast == "never", "Reference", beta_ci),
    blank = paste(rep(" ", 10), collapse = " "),
    plot_ci = paste(rep(" ", 20), collapse = " "),
    contrast = factor(contrast, levels = c("never", "notregularly - none", "weekly - none", "daily - none"), labels = c("  Never", "  Less than weekly", "  Weekly", "  Daily"))
  ) %>%
  arrange(country, contrast)

dat_fig <- dat %>%
  select(country, contrast, estimate, lower, upper, beta_ci, blank, plot_ci) %>%
  pivot_wider(
    names_from = country,
    values_from = c(estimate, lower, upper, beta_ci, blank, plot_ci)
  ) %>%
  select(
    contrast, estimate_China, estimate_England, estimate_USA, 
    lower_China, lower_England, lower_USA,
    upper_China, upper_England, upper_USA, 
    plot_ci_China, beta_ci_China, blank_China,
    plot_ci_England, beta_ci_England, blank_England,
    plot_ci_USA, beta_ci_USA
    )
colnames(dat_fig)[colnames(dat_fig) == "contrast"] <- "Internet use frequency"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_China"] <- "China"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_England"] <- "England"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_USA"] <- "USA"
colnames(dat_fig)[colnames(dat_fig) %in% c("beta_ci_China", "beta_ci_England", "beta_ci_USA")] <- "AME (95% CI)"
colnames(dat_fig)[colnames(dat_fig) %in% c("blank_China", "blank_England", "blank_USA")] <- " "


p_shlt <- forestploter::forest(
  dat_fig[,c(1, 11:18)],
  est = list(
    dat_fig$estimate_China,
    dat_fig$estimate_England,
    dat_fig$estimate_USA
  ),
  lower = list(
    dat_fig$lower_China,
    dat_fig$lower_England,
    dat_fig$lower_USA
  ),
  upper = list(
    dat_fig$upper_China,
    dat_fig$upper_England,
    dat_fig$upper_USA
  ),
  ci_column = c(2, 5, 8),
  ref_line = c(0, 0, 0),
  sizes = 0.7,
  xlim = list(
    c(-0.7, 1.4), 
    c(-0.7, 1.4),
    c(-0.7, 1.4)
    ),            
  ticks_at = list(
    c(-0.7, 0, 0.7, 1.4), 
    c(-0.7, 0, 0.7, 1.4), 
    c(-0.7, 0, 0.7, 1.4)
    ),  
  arrow_lab = c("Worse self-reported health","Better self-reported health"),
  theme = theme
  )

# Add border
p_shlt <- add_border(p_shlt, part = "header", row = 1, col = c(1:9), gp = gpar(lwd = 1))


#### Pool ####
p_pool <- wrap_elements(
  wrap_elements(p_cesd) + wrap_elements(p_satlife) + wrap_elements(p_shlt) +
    plot_layout(nrow = 3) + 
    plot_annotation(tag_levels = "a")
  ) 

ggsave(str_c(getwd(), "/results/Figure/Supplementary Figure 16_Forest plot_internet use frequency_mice_iptw.tiff"), plot = p_pool, width = 13, height = 8, unit = "in", dpi = 500, device = "tiff")


rm(theme, dat, dat_fig, p_cesd, p_satlife, p_shlt, p_pool)


```

### Cumulative internet use

#### Linear mixed model and meta analysis

```{r warning=FALSE}

#### Merge data ####
iso <- c(40, 56, 156, 203, 208, 826, 233, 250, 276, 376, 380, 442, 484, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "China", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Israel", "Italy", "Luxembourg", "Mexico", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

tic()
#### CES-D ####
# lme4
cesd_icum_adj_mi_attr_results <- tibble()
for(i in 1:18){
  
  if(i==13){
    cesd_icum_adj_mi <- lmer(
      cesd_stand ~ internet_cum*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),      
      data = final_icum_mhas, 
      control = lmerControl(optimizer = "bobyqa"), weights = attrition_ipw
      ) # Mexico don't have missing values
    cesd_icum_adj_mi_attr_result <- marginaleffects::avg_comparisons(
      cesd_icum_adj_mi, variables = "internet_cum", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    cesd_icum_adj_mi <- lapply(mi_icum_merge, function(x){
      lmer(
        cesd_stand ~ internet_cum*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl + 
          (1 | id),
        data = x %>% filter(country_names == names[i]), 
        control = lmerControl(optimizer = 'bobyqa'), weights = attrition_ipw
        )
      })
    
    cesd_icum_adj_mi_attr_result <- lapply(seq_along(cesd_icum_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_icum_adj_mi[[j]], variables = "internet_cum", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }
  
  cesd_icum_adj_mi_attr_results <- cesd_icum_adj_mi_attr_results %>% 
    bind_rows(., cesd_icum_adj_mi_attr_result)
  
  rm(cesd_icum_adj_mi, cesd_icum_adj_mi_attr_result)
}

# metafor
cesd_icum_adj_mi_attr_meta <- rma(yi = estimate, sei = std.error, data = cesd_icum_adj_mi_attr_results, slab = country)


#### Life satisfaction ####
# lme4
satlife_icum_adj_mi_attr_results <- tibble()
for(i in 1:18){
  
  if(i==13){
    satlife_icum_adj_mi <- lmer(
      satlife_stand ~ internet_cum*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),      
      data = final_icum_mhas, 
      control = lmerControl(optimizer = "bobyqa"), weights = attrition_ipw
      ) # Mexico doesn't have missing values
    satlife_icum_adj_mi_attr_result <- marginaleffects::avg_comparisons(
      satlife_icum_adj_mi, variables = "internet_cum", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    satlife_icum_adj_mi <- lapply(mi_icum_merge, function(x){
      lmer(
        satlife_stand ~ internet_cum*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl + 
          (1 | id),
        data = x %>% filter(country_names == names[i]), 
        control = lmerControl(optimizer = 'bobyqa'), weights = attrition_ipw
        )
      })
    
    satlife_icum_adj_mi_attr_result <- lapply(seq_along(satlife_icum_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_icum_adj_mi[[j]], variables = "internet_cum", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }
  
  satlife_icum_adj_mi_attr_results <- satlife_icum_adj_mi_attr_results %>% 
    bind_rows(., satlife_icum_adj_mi_attr_result)
  
  rm(satlife_icum_adj_mi, satlife_icum_adj_mi_attr_result)
}

# metafor
satlife_icum_adj_mi_attr_meta <- rma(yi = estimate, sei = std.error, data = satlife_icum_adj_mi_attr_results, slab = country)


#### Self-rated health ####
# lme4
shlt_icum_adj_mi_attr_results <- tibble()
for(i in 1:18){
  
  if(i==13){
    shlt_icum_adj_mi <- lmer(
      shlt_stand ~ internet_cum*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),      
      data = final_icum_mhas, 
      control = lmerControl(optimizer = "bobyqa"), weights = attrition_ipw
      ) # Mexico doesn't have missing values
    shlt_icum_adj_mi_attr_result <- marginaleffects::avg_comparisons(
      shlt_icum_adj_mi, variables = "internet_cum", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    shlt_icum_adj_mi <- lapply(mi_icum_merge, function(x){
      lmer(
        shlt_stand ~ internet_cum*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl + 
          (1 | id),
        data = x %>% filter(country_names == names[i]), 
        control = lmerControl(optimizer = 'bobyqa'), weights = attrition_ipw
        )
      })
    
    shlt_icum_adj_mi_attr_result <- lapply(seq_along(shlt_icum_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_icum_adj_mi[[j]], variables = "internet_cum", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }
  
  shlt_icum_adj_mi_attr_results <- shlt_icum_adj_mi_attr_results %>% 
    bind_rows(., shlt_icum_adj_mi_attr_result)
  
  rm(shlt_icum_adj_mi, shlt_icum_adj_mi_attr_result)
}

# metafor
shlt_icum_adj_mi_attr_meta <- rma(yi = estimate, sei = std.error, data = shlt_icum_adj_mi_attr_results, slab = country)

toc()

```

#### Supplementary Figure 17: Associations of cumulative Internet use with mental health

```{r}

#### Theme setting ####
theme <- forestploter::forest_theme(
  core = list(bg_params = list(fill = c("white"))), 
  base_size = 10, 
  # base_family = "Arial",
  ci_pch = 15,
  ci_col = "#3B4992FF", 
  ci_alpha = 1,
  ci_lty = 1,
  ci_lwd = 1,
  ci_Theight = unit(0, "cm"),
  
  xaxis_lwd = 1,
  xaxis_cex = 1,
  
  summary_col = "#008B45FF", 
  refline_col = "gray", 
  refline_lwd = 2, 
  
  title_just = "center",
  title_cex = 1.2,
  title_fontface = "bold",
  title_col = "black",
  
  arrow_type = "closed",
  arrow_label_just = "end",
  arrow_length = 0.05,
  arrow_lwd = 1,
  arrow_fill = "black",
  arrow_col = "black"
  )

#### CES-D ####
# Data
dat <- cesd_icum_adj_mi_attr_results %>%
  mutate(weights = weights(cesd_icum_adj_mi_attr_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(cesd_icum_adj_mi_attr_meta$beta),
      std.error = as.numeric(cesd_icum_adj_mi_attr_meta$se), 
      statistic = NA, p.value = NA, p.sig = NA, 
      weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "AME (95% CI)", "Weight (%)")
# colnames(dat_fig) <- c("Country", "", "", "", "Weight (%)")

p_cesd <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Fewer depressive symptoms","More depressive symptoms"),
  xlim = c(-0.4, 0.1),
  ticks_at = c(-0.4, -0.3, -0.2, -0.1, 0, 0.1),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(cesd_icum_adj_mi_attr_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(cesd_icum_adj_mi_attr_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(cesd_icum_adj_mi_attr_meta$H2, digits = 2)))
    )

p_cesd <- add_text(
  p_cesd, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- bquote(
    paste(
      "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
      "Q (", .(cesd_icum_adj_mi_attr_meta$k - cesd_icum_adj_mi_attr_meta$p), ") = ", 
      .(fmtx(cesd_icum_adj_mi_attr_meta$QE, digits = 2)), ", ",
      # .(fmtp(cesd_icum_adj_mi_attr_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      italic(P), " < 0.001"
      )
)

test_hetero <- 
  if(cesd_icum_adj_mi_attr_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(cesd_icum_adj_mi_attr_meta$k - cesd_icum_adj_mi_attr_meta$p), ") = ", 
        .(fmtx(cesd_icum_adj_mi_attr_meta$QE, digits = 2)), ", ",
        
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(cesd_icum_adj_mi_attr_meta$k - cesd_icum_adj_mi_attr_meta$p), ") = ", 
        .(fmtx(cesd_icum_adj_mi_attr_meta$QE, digits = 2)), ", ",
        .(fmtp(cesd_icum_adj_mi_attr_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )
  }

p_cesd <- add_text(
  p_cesd, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(cesd_icum_adj_mi_attr_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(cesd_icum_adj_mi_attr_meta$zval, digits = 2)), ", ",
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(cesd_icum_adj_mi_attr_meta$zval, digits = 2)), ", ",
        .(fmtp(cesd_icum_adj_mi_attr_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )    
  }

p_cesd <- add_text(
  p_cesd, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_cesd <- add_border(p_cesd, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))


#### Life satisfaction ####
# Data
dat <- satlife_icum_adj_mi_attr_results %>%
  mutate(weights = weights(satlife_icum_adj_mi_attr_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(satlife_icum_adj_mi_attr_meta$beta),
      std.error = as.numeric(satlife_icum_adj_mi_attr_meta$se), 
      statistic = NA, p.value = NA, p.sig = NA, 
      weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "AME (95% CI)", "Weight (%)")
# colnames(dat_fig) <- c("Country", "", "", "", "Weight (%)")


p_satlife <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Lower life satisfaction","Higher life satisfaction"),
  xlim = c(-0.2, 0.3),
  ticks_at = c(-0.2, -0.1, 0, 0.1, 0.2, 0.3),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(satlife_icum_adj_mi_attr_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(satlife_icum_adj_mi_attr_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(satlife_icum_adj_mi_attr_meta$H2, digits = 2)))
    )

p_satlife <- add_text(
  p_satlife, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(satlife_icum_adj_mi_attr_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(satlife_icum_adj_mi_attr_meta$k - satlife_icum_adj_mi_attr_meta$p), ") = ", 
        .(fmtx(satlife_icum_adj_mi_attr_meta$QE, digits = 2)), ", ",
        
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(satlife_icum_adj_mi_attr_meta$k - satlife_icum_adj_mi_attr_meta$p), ") = ", 
        .(fmtx(satlife_icum_adj_mi_attr_meta$QE, digits = 2)), ", ",
        .(fmtp(satlife_icum_adj_mi_attr_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )
  }

p_satlife <- add_text(
  p_satlife, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(satlife_icum_adj_mi_attr_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(satlife_icum_adj_mi_attr_meta$zval, digits = 2)), ", ",
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(satlife_icum_adj_mi_attr_meta$zval, digits = 2)), ", ",
        .(fmtp(satlife_icum_adj_mi_attr_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )    
  }

p_satlife <- add_text(
  p_satlife, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_satlife <- add_border(p_satlife, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))

#### Self-rated health ####
# Data
dat <- shlt_icum_adj_mi_attr_results %>%
  mutate(weights = weights(shlt_icum_adj_mi_attr_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(shlt_icum_adj_mi_attr_meta$beta),
      std.error = as.numeric(shlt_icum_adj_mi_attr_meta$se), 
      statistic = NA, p.value = NA, p.sig = NA, 
      weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "AME (95% CI)", "Weight (%)")
# colnames(dat_fig) <- c("Country", "", "", "", "Weight (%)")


p_shlt <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Worse self-reported health","Better self-reported health"),
  xlim = c(-0.1, 0.3),
  ticks_at = c(-0.1, 0, 0.1, 0.2, 0.3),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(shlt_icum_adj_mi_attr_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(shlt_icum_adj_mi_attr_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(shlt_icum_adj_mi_attr_meta$H2, digits = 2)))
    )

p_shlt <- add_text(
  p_shlt, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(shlt_icum_adj_mi_attr_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(shlt_icum_adj_mi_attr_meta$k - shlt_icum_adj_mi_attr_meta$p), ") = ", 
        .(fmtx(shlt_icum_adj_mi_attr_meta$QE, digits = 2)), ", ",
        
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(shlt_icum_adj_mi_attr_meta$k - shlt_icum_adj_mi_attr_meta$p), ") = ", 
        .(fmtx(shlt_icum_adj_mi_attr_meta$QE, digits = 2)), ", ",
        .(fmtp(shlt_icum_adj_mi_attr_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )
  }

p_shlt <- add_text(
  p_shlt, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(shlt_icum_adj_mi_attr_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(shlt_icum_adj_mi_attr_meta$zval, digits = 2)), ", ",
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(shlt_icum_adj_mi_attr_meta$zval, digits = 2)), ", ",
        .(fmtp(shlt_icum_adj_mi_attr_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )    
  }

p_shlt <- add_text(
  p_shlt, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_shlt <- add_border(p_shlt, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))


#### Pool ####
p_pool <- wrap_elements(
  wrap_elements(p_cesd) + wrap_elements(p_satlife) + wrap_elements(p_shlt) + 
    plot_layout(nrow = 2) + 
    plot_annotation(tag_levels = "a")
  ) 

ggsave(str_c(getwd(), "/results/Figure/Supplementary Figure 17_Forest plot_cumulative internet use_mice_iptw.tiff"), plot = p_pool, width = 16, height = 12, unit = "in", dpi = 500, device = "tiff")

rm(theme, dat, dat_fig, test_hetero, test_overall, p_cesd, p_satlife, p_shlt)

```


## Internet use (yes/no) - excluding participants with depression at baseline

#### Linear mixed model and meta analysis

```{r warning=FALSE}

#### Merge data ####
iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

mi_iyes_nodep_merge <- list()
for(i in 1:10){
  mi_iyes <- mi_iyes_hrs[[i]] %>% group_by(id) %>% filter(first(depression == 0)) %>% ungroup() %>% mutate(id = as.character(id), cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)) %>% 
    bind_rows(., mi_iyes_elsa[[i]] %>% group_by(id) %>% filter(first(depression == 0)) %>% ungroup() %>% mutate(id = as.character(id), cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife))) %>%
    bind_rows(., mi_iyes_charls[[i]] %>% group_by(id) %>% filter(first(depression == 0)) %>% ungroup() %>% mutate(id = as.character(id), cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife))) %>%
    bind_rows(., mi_iyes_share[[i]] %>% group_by(id) %>% filter(first(depression == 0)) %>% ungroup() %>% mutate(id = as.character(id), cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife))) %>%
    bind_rows(., mi_iyes_mhas[[i]] %>% group_by(id) %>% filter(first(depression == 0)) %>% ungroup() %>% mutate(id = as.character(id), cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife))) %>%
    mutate(
      country_names = case_when(
        country == iso[1] ~ names[1],
        country == iso[2] ~ names[2],
        country == iso[3] ~ names[3],
        country == iso[4] ~ names[4],
        country == iso[5] ~ names[5],
        country == iso[6] ~ names[6],
        country == iso[7] ~ names[7],
        country == iso[8] ~ names[8],
        country == iso[9] ~ names[9],
        country == iso[10] ~ names[10],
        country == iso[11] ~ names[11],
        country == iso[12] ~ names[12],
        country == iso[13] ~ names[13],
        country == iso[14] ~ names[14],
        country == iso[15] ~ names[15],
        country == iso[16] ~ names[16],
        country == iso[17] ~ names[17],
        country == iso[18] ~ names[18],
        country == iso[19] ~ names[19],
        country == iso[20] ~ names[20],
        country == iso[21] ~ names[21],
        country == iso[22] ~ names[22],
        country == iso[23] ~ names[23]
      )
    )
  mi_iyes_nodep_merge[[i]] <- mi_iyes
  rm(mi_iyes)
}


tic()
#### CES-D ####
# lme4
cesd_iyes_adj_mi_nodep_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    cesd_iyes_adj_mi <- lmer(
      cesd_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% group_by(id) %>% filter(first(depression == 0)) %>% ungroup() %>% mutate(id = as.character(id), cesd_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values

    cesd_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      cesd_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    cesd_iyes_adj_mi <- lapply(mi_iyes_nodep_merge, function(x){
      lmer(
        cesd_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'))
      })
    cesd_iyes_adj_mi_result <- lapply(seq_along(cesd_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        cesd_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }
  
  cesd_iyes_adj_mi_nodep_results <- cesd_iyes_adj_mi_nodep_results %>% 
    bind_rows(., cesd_iyes_adj_mi_result)
  
  rm(cesd_iyes_adj_mi, cesd_iyes_adj_mi_result)
}

# metafor
cesd_iyes_adj_mi_nodep_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_mi_nodep_results, slab = country)


#### Life satisfaction ####
# lme4
satlife_iyes_adj_mi_nodep_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    satlife_iyes_adj_mi <- lmer(
      satlife_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% group_by(id) %>% filter(first(depression == 0)) %>% ungroup() %>% mutate(id = as.character(id), satlife_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values

    satlife_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      satlife_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    satlife_iyes_adj_mi <- lapply(mi_iyes_nodep_merge, function(x){
      lmer(
        satlife_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'))
      })
    satlife_iyes_adj_mi_result <- lapply(seq_along(satlife_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        satlife_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }
  
  satlife_iyes_adj_mi_nodep_results <- satlife_iyes_adj_mi_nodep_results %>% 
    bind_rows(., satlife_iyes_adj_mi_result)
  
  rm(satlife_iyes_adj_mi, satlife_iyes_adj_mi_result)
}

# metafor
satlife_iyes_adj_mi_nodep_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_mi_nodep_results, slab = country)


#### Self-rated health ####
# lme4
shlt_iyes_adj_mi_nodep_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    shlt_iyes_adj_mi <- lmer(
      shlt_stand ~ internet_yes*cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi %>% group_by(id) %>% filter(first(depression == 0)) %>% ungroup() %>% mutate(id = as.character(id), shlt_stand = scale(cesd), shlt_stand = scale(shlt), satlife_stand = scale(satlife)), 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values

    shlt_iyes_adj_mi_result <- marginaleffects::avg_comparisons(
      shlt_iyes_adj_mi, variables = "internet_yes", re.form = NA
      ) %>% 
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }else{
    shlt_iyes_adj_mi <- lapply(mi_iyes_nodep_merge, function(x){
      lmer(
        shlt_stand ~ internet_yes*cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'))
      })
    shlt_iyes_adj_mi_result <- lapply(seq_along(shlt_iyes_adj_mi), \(j) 
      marginaleffects::avg_comparisons(
        shlt_iyes_adj_mi[[j]], variables = "internet_yes", re.form = NA)
      ) %>%
      mice::pool() %>%
      tidy() %>%
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      select(country, term, contrast, estimate, std.error, statistic, p.value, p.sig)
  }
  
  shlt_iyes_adj_mi_nodep_results <- shlt_iyes_adj_mi_nodep_results %>% 
    bind_rows(., shlt_iyes_adj_mi_result)
  
  rm(shlt_iyes_adj_mi, shlt_iyes_adj_mi_result)
}

# metafor
shlt_iyes_adj_mi_nodep_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_mi_nodep_results, slab = country)

toc()

rm(mi_iyes_nodep_merge)

```


### Supplementary Figure 18: Associations of Internet use with mental health

```{r}

#### Theme setting ####
theme <- forestploter::forest_theme(
  core = list(bg_params = list(fill = c("white"))), 
  base_size = 10, 
  # base_family = "Arial",
  ci_pch = 15,
  ci_col = "#3B4992FF", 
  ci_alpha = 1,
  ci_lty = 1,
  ci_lwd = 1,
  ci_Theight = unit(0, "cm"),
  
  xaxis_lwd = 1,
  xaxis_cex = 1,
  
  summary_col = "#008B45FF", 
  refline_col = "gray", 
  refline_lwd = 2, 
  
  title_just = "center",
  title_cex = 1.2,
  title_fontface = "bold",
  title_col = "black",
  
  arrow_type = "closed",
  arrow_label_just = "end",
  arrow_length = 0.05,
  arrow_lwd = 1,
  arrow_fill = "black",
  arrow_col = "black"
  )

#### CES-D ####
# Data
dat <- cesd_iyes_adj_mi_nodep_results %>%
  mutate(weights = weights(cesd_iyes_adj_mi_nodep_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(cesd_iyes_adj_mi_nodep_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_mi_nodep_meta$se), 
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "AME (95% CI)", "Weight (%)")

p_cesd <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Fewer depressive symptoms","More depressive symptoms"),
  xlim = c(-0.5, 0.52),
  ticks_at = c(-0.5, -0.25, 0, 0.25, 0.5),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(cesd_iyes_adj_mi_nodep_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(cesd_iyes_adj_mi_nodep_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(cesd_iyes_adj_mi_nodep_meta$H2, digits = 2)))
    )

p_cesd <- add_text(
  p_cesd, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(cesd_iyes_adj_mi_nodep_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(cesd_iyes_adj_mi_nodep_meta$k - cesd_iyes_adj_mi_nodep_meta$p), ") = ", 
        .(fmtx(cesd_iyes_adj_mi_nodep_meta$QE, digits = 2)), ", ",

        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(cesd_iyes_adj_mi_nodep_meta$k - cesd_iyes_adj_mi_nodep_meta$p), ") = ", 
        .(fmtx(cesd_iyes_adj_mi_nodep_meta$QE, digits = 2)), ", ",
        .(fmtp(cesd_iyes_adj_mi_nodep_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
  }
  

p_cesd <- add_text(
  p_cesd, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(cesd_iyes_adj_mi_nodep_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(cesd_iyes_adj_mi_nodep_meta$zval, digits = 2)), ", ",
        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(cesd_iyes_adj_mi_nodep_meta$zval, digits = 2)), ", ",
      .(fmtp(cesd_iyes_adj_mi_nodep_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )    
  }

p_cesd <- add_text(
  p_cesd, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_cesd <- add_border(p_cesd, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))


#### Life satisfaction ####
# Data
dat <- satlife_iyes_adj_mi_nodep_results %>%
  mutate(weights = weights(satlife_iyes_adj_mi_nodep_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(satlife_iyes_adj_mi_nodep_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_mi_nodep_meta$se), 
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "AME (95% CI)", "Weight (%)")

p_satlife <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Lower life satisfaction","Higher life satisfaction"),
  xlim = c(-0.24, 0.8),
  ticks_at = c(-0.2, 0, 0.2, 0.4, 0.6, 0.8),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(satlife_iyes_adj_mi_nodep_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(satlife_iyes_adj_mi_nodep_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(satlife_iyes_adj_mi_nodep_meta$H2, digits = 2)))
    )

p_satlife <- add_text(
  p_satlife, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(satlife_iyes_adj_mi_nodep_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(satlife_iyes_adj_mi_nodep_meta$k - satlife_iyes_adj_mi_nodep_meta$p), ") = ", 
        .(fmtx(satlife_iyes_adj_mi_nodep_meta$QE, digits = 2)), ", ",

        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(satlife_iyes_adj_mi_nodep_meta$k - satlife_iyes_adj_mi_nodep_meta$p), ") = ", 
        .(fmtx(satlife_iyes_adj_mi_nodep_meta$QE, digits = 2)), ", ",
        .(fmtp(satlife_iyes_adj_mi_nodep_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
  }

p_satlife <- add_text(
  p_satlife, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(satlife_iyes_adj_mi_nodep_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(satlife_iyes_adj_mi_nodep_meta$zval, digits = 2)), ", ",
        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(satlife_iyes_adj_mi_nodep_meta$zval, digits = 2)), ", ",
      .(fmtp(satlife_iyes_adj_mi_nodep_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )    
  }

p_satlife <- add_text(
  p_satlife, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_satlife <- add_border(p_satlife, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))

#### Self-rated health ####
# Data
dat <- shlt_iyes_adj_mi_nodep_results %>%
  mutate(weights = weights(shlt_iyes_adj_mi_nodep_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(shlt_iyes_adj_mi_nodep_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_mi_nodep_meta$se), 
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "AME (95% CI)", "Weight (%)")

p_shlt <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Worse self-reported health","Better self-reported health"),
  xlim = c(-0.5, 0.5),
  ticks_at = c(-0.5, -0.25, 0, 0.25, 0.5),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(shlt_iyes_adj_mi_nodep_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(shlt_iyes_adj_mi_nodep_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(shlt_iyes_adj_mi_nodep_meta$H2, digits = 2)))
    )

p_shlt <- add_text(
  p_shlt, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(shlt_iyes_adj_mi_nodep_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(shlt_iyes_adj_mi_nodep_meta$k - shlt_iyes_adj_mi_nodep_meta$p), ") = ", 
        .(fmtx(shlt_iyes_adj_mi_nodep_meta$QE, digits = 2)), ", ",

        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(shlt_iyes_adj_mi_nodep_meta$k - shlt_iyes_adj_mi_nodep_meta$p), ") = ", 
        .(fmtx(shlt_iyes_adj_mi_nodep_meta$QE, digits = 2)), ", ",
        .(fmtp(shlt_iyes_adj_mi_nodep_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
  }

p_shlt <- add_text(
  p_shlt, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(shlt_iyes_adj_mi_nodep_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(shlt_iyes_adj_mi_nodep_meta$zval, digits = 2)), ", ",
        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(shlt_iyes_adj_mi_nodep_meta$zval, digits = 2)), ", ",
      .(fmtp(shlt_iyes_adj_mi_nodep_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )    
  }

p_shlt <- add_text(
  p_shlt, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_shlt <- add_border(p_shlt, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))


#### Pool ####
p_pool <- wrap_elements(
  wrap_elements(p_cesd) + wrap_elements(p_satlife) + wrap_elements(p_shlt) + 
    plot_layout(nrow = 2) + 
    plot_annotation(tag_levels = "a")
  ) 

ggsave(str_c(getwd(), "/results/Figure/Supplementary Figure 18_Forest plot_internet use_mice_nodep.tiff"), plot = p_pool, width = 16, height = 14, unit = "in", dpi = 500, device = "tiff")

rm(theme, dat, dat_fig, test_hetero, test_overall, p_cesd, p_satlife, p_shlt)

```


## Incident depression

### Cox regression

```{r}

#### Merge data ####
iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

mi_iyes_inc_merge <- list()
for(i in 1:10){
  mi_iyes <- mi_iyes_inc_hrs[[i]] %>% mutate(id = as.character(id)) %>% 
    bind_rows(., mi_iyes_inc_elsa[[i]] %>% mutate(id = as.character(id))) %>%
    bind_rows(., mi_iyes_inc_charls[[i]] %>% mutate(id = as.character(id))) %>%
    bind_rows(., mi_iyes_inc_share[[i]]) %>%
    bind_rows(., mi_iyes_inc_mhas[[i]]) %>%
    mutate(
      country_names = case_when(
        country == iso[1] ~ names[1],
        country == iso[2] ~ names[2],
        country == iso[3] ~ names[3],
        country == iso[4] ~ names[4],
        country == iso[5] ~ names[5],
        country == iso[6] ~ names[6],
        country == iso[7] ~ names[7],
        country == iso[8] ~ names[8],
        country == iso[9] ~ names[9],
        country == iso[10] ~ names[10],
        country == iso[11] ~ names[11],
        country == iso[12] ~ names[12],
        country == iso[13] ~ names[13],
        country == iso[14] ~ names[14],
        country == iso[15] ~ names[15],
        country == iso[16] ~ names[16],
        country == iso[17] ~ names[17],
        country == iso[18] ~ names[18],
        country == iso[19] ~ names[19],
        country == iso[20] ~ names[20],
        country == iso[21] ~ names[21],
        country == iso[22] ~ names[22],
        country == iso[23] ~ names[23]
      )
    )
  mi_iyes_inc_merge[[i]] <- mi_iyes
  rm(mi_iyes)
}

length(unique(mi_iyes_inc_merge[[1]]$id)) # 66368
length(unique(final_iyes_inc_elsi$id)) # 3002

#### Depression ####
dep_iyes_unadj_mi_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    dep_iyes_unadj_mi <- coxph(
      Surv(cmonth, depression) ~ internet_yes,
      data = final_iyes_inc_elsi
      ) # Brazil dont have missing values
    dep_iyes_unadj_mi_result <- broom::tidy(dep_iyes_unadj_mi) %>% 
      slice(1) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, p.value, p.sig)
  }else{
    dep_iyes_unadj_mi <- lapply(mi_iyes_inc_merge, function(x){
      coxph(
        Surv(cmonth, depression) ~ internet_yes,
        data = x %>% filter(country_names == names[i]))
      })
    
    dep_iyes_unadj_mi_result <- broom.mixed::tidy(pool(dep_iyes_unadj_mi)) %>% 
      slice(1) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, p.value, p.sig)
  }
  
  dep_iyes_unadj_mi_results <- dep_iyes_unadj_mi_results %>% 
    bind_rows(., dep_iyes_unadj_mi_result)
  
  rm(dep_iyes_unadj_mi, dep_iyes_unadj_mi_result)
}

dep_iyes_adj_mi_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    dep_iyes_adj_mi <- coxph(
      Surv(cmonth, depression) ~ internet_yes +
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl,
      data = final_iyes_inc_elsi
      ) # Brazil dont have missing values
    dep_iyes_adj_mi_result <- broom::tidy(dep_iyes_adj_mi) %>% 
      slice(1) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, p.value, p.sig)
  }else{
    dep_iyes_adj_mi <- lapply(mi_iyes_inc_merge, function(x){
      coxph(
        Surv(cmonth, depression) ~ internet_yes + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl,
        data = x %>% filter(country_names == names[i]))
      })
    
    dep_iyes_adj_mi_result <- broom.mixed::tidy(pool(dep_iyes_adj_mi)) %>% 
      slice(1) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, p.value, p.sig)
  }
  
  dep_iyes_adj_mi_results <- dep_iyes_adj_mi_results %>% 
    bind_rows(., dep_iyes_adj_mi_result)
  
  rm(dep_iyes_adj_mi, dep_iyes_adj_mi_result)
}

# metafor
dep_iyes_unadj_mi_meta <- rma(yi = estimate, sei = std.error, data = dep_iyes_unadj_mi_results, slab = country)

# forest(dep_iyes_unadj_mi_meta, showweights = T, header = T)

dep_iyes_adj_mi_meta <- rma(yi = estimate, sei = std.error, data = dep_iyes_adj_mi_results, slab = country)

rm(mi_iyes_inc_merge)

```

### Supplementary Figure 19: Associations of Internet use with incident depression

```{r}

#### Theme setting ####
theme <- forestploter::forest_theme(
  core = list(bg_params = list(fill = c("white"))), 
  base_size = 10, 
  # base_family = "Arial",
  ci_pch = 15,
  ci_col = "#3B4992FF", 
  ci_alpha = 1,
  ci_lty = 1,
  ci_lwd = 1,
  ci_Theight = unit(0, "cm"),
  
  xaxis_lwd = 1,
  xaxis_cex = 1,
  
  summary_col = "#008B45FF", 
  refline_col = "gray", 
  refline_lwd = 2, 
  
  title_just = "center",
  title_cex = 1.2,
  title_fontface = "bold",
  title_col = "black",
  
  arrow_type = "closed",
  arrow_label_just = "end",
  arrow_length = 0.05,
  arrow_lwd = 1,
  arrow_fill = "black",
  arrow_col = "black"
  )

#### Depression ####
# Data
dat <- dep_iyes_adj_mi_results %>%
  mutate(weights = weights(dep_iyes_adj_mi_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(dep_iyes_adj_mi_meta$beta),
      std.error = as.numeric(dep_iyes_adj_mi_meta$se), 
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    hr = exp(estimate),
    lower = exp(estimate - 1.96*std.error),
    upper = exp(estimate + 1.96*std.error),
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", hr, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "HR (95% CI)", "Weight (%)")

p_cesd <- forestploter::forest(
  dat_fig,
  est = dat$hr,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 1,
  arrow_lab = c("Fewer depressive symptoms","More depressive symptoms"),
  xlim = c(0, 3.5),
  ticks_at = c(0, 0.5, 1, 1.5, 2, 2.5, 3, 3.5),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(dep_iyes_adj_mi_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(dep_iyes_adj_mi_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(dep_iyes_adj_mi_meta$H2, digits = 2)))
    )

p_cesd <- add_text(
  p_cesd, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(dep_iyes_adj_mi_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(dep_iyes_adj_mi_meta$k - dep_iyes_adj_mi_meta$p), ") = ", 
        .(fmtx(dep_iyes_adj_mi_meta$QE, digits = 2)), ", ",

        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(dep_iyes_adj_mi_meta$k - dep_iyes_adj_mi_meta$p), ") = ", 
        .(fmtx(dep_iyes_adj_mi_meta$QE, digits = 2)), ", ",
        .(fmtp(dep_iyes_adj_mi_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
  }
  

p_cesd <- add_text(
  p_cesd, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(dep_iyes_adj_mi_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(dep_iyes_adj_mi_meta$zval, digits = 2)), ", ",
        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(dep_iyes_adj_mi_meta$zval, digits = 2)), ", ",
      .(fmtp(dep_iyes_adj_mi_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )    
  }

p_cesd <- add_text(
  p_cesd, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_cesd <- add_border(p_cesd, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))


ggsave(str_c(getwd(), "/results/Figure/Supplementary Figure 19_Forest plot_internet use_mice_cox.tiff"), plot = p_cesd, width = 8, height = 7, unit = "in", dpi = 500, device = "tiff")

rm(theme, dat, dat_fig, test_hetero, test_overall, p_cesd)

```

## Bidirectional association: mental health and Internet use

### Generalized estimating equation model

```{r}

#### Merge data ####
iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

mi_bidirec_merge <- list()
for(i in 1:10){
  mi_iyes <- mi_bidirec_hrs[[i]] %>% mutate(id = factor(id), internet_yes = as.numeric(internet_yes)-1) %>% 
    bind_rows(., mi_bidirec_elsa[[i]] %>% mutate(id = factor(id), internet_yes = as.numeric(internet_yes)-1)) %>%
    bind_rows(., mi_bidirec_charls[[i]] %>% mutate(id = factor(id), internet_yes = as.numeric(internet_yes)-1)) %>%
    bind_rows(., mi_bidirec_share[[i]] %>% mutate(id = factor(id), internet_yes = as.numeric(internet_yes)-1)) %>%
    bind_rows(., mi_bidirec_mhas[[i]] %>% mutate(id = factor(id), internet_yes = as.numeric(internet_yes)-1)) %>%
    mutate(
      country_names = case_when(
        country == iso[1] ~ names[1],
        country == iso[2] ~ names[2],
        country == iso[3] ~ names[3],
        country == iso[4] ~ names[4],
        country == iso[5] ~ names[5],
        country == iso[6] ~ names[6],
        country == iso[7] ~ names[7],
        country == iso[8] ~ names[8],
        country == iso[9] ~ names[9],
        country == iso[10] ~ names[10],
        country == iso[11] ~ names[11],
        country == iso[12] ~ names[12],
        country == iso[13] ~ names[13],
        country == iso[14] ~ names[14],
        country == iso[15] ~ names[15],
        country == iso[16] ~ names[16],
        country == iso[17] ~ names[17],
        country == iso[18] ~ names[18],
        country == iso[19] ~ names[19],
        country == iso[20] ~ names[20],
        country == iso[21] ~ names[21],
        country == iso[22] ~ names[22],
        country == iso[23] ~ names[23]
      )
    )
  mi_bidirec_merge[[i]] <- mi_iyes
  rm(mi_iyes)
}

length(unique(mi_bidirec_merge[[1]]$id)) # 85433
length(unique(final_bidirec_elsi$id)) # 4984

tic()
#### CES-D ####
# geepack
cesd_bidirec_mi_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    cesd_bidirec_mi <- geepack::geeglm(
      internet_yes  ~ cesd_stand + cwave + age + male + lowedu + lowwealth + lbrf +
        nonmarried + hhres + contact + smoken + weekdrink + phyinact +
        dis + adl_any + iadl,
      data = final_bidirec_elsi %>% mutate(id = factor(id), internet_yes = as.numeric(internet_yes)-1), id = id,
      family = binomial, corstr = "exchangeable"
      ) # Brazil dont have missing values

    cesd_bidirec_mi_result <- broom.mixed::tidy(cesd_bidirec_mi) %>% 
      slice(2) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, p.value, p.sig)
  }else if(i==18){
    cesd_bidirec_mi <- lapply(mi_bidirec_merge, function(x){
      geepack::geeglm(
        internet_yes ~ cesd_stand + cwave + age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl,
        data = x %>% filter(country_names == names[i]) %>% droplevels(), id = id,
        family = binomial, corstr = "exchangeable"
        )
      })
    cesd_bidirec_mi_result <- broom.mixed::tidy(pool(cesd_bidirec_mi)) %>% 
      slice(2) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, p.value, p.sig)
  }else{
    cesd_bidirec_mi <- lapply(mi_bidirec_merge, function(x){
      geepack::geeglm(
        internet_yes ~ cesd_stand + cwave + age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl,
        data = x %>% filter(country_names == names[i]), id = id,
        family = binomial, corstr = "exchangeable"
        )
      })
    cesd_bidirec_mi_result <- broom.mixed::tidy(pool(cesd_bidirec_mi)) %>% 
      slice(2) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, p.value, p.sig)
  }
  
  cesd_bidirec_mi_results <- cesd_bidirec_mi_results %>% 
    bind_rows(., cesd_bidirec_mi_result)
  
  rm(cesd_bidirec_mi, cesd_bidirec_mi_result)
}

# metafor
cesd_bidirec_mi_meta <- rma(yi = estimate, sei = std.error, data = cesd_bidirec_mi_results, slab = country)


#### Life satisfaction ####
# geepack
satlife_bidirec_mi_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    satlife_bidirec_mi <- geepack::geeglm(
      internet_yes  ~ satlife_stand + cwave + age + male + lowedu + lowwealth + lbrf +
        nonmarried + hhres + contact + smoken + weekdrink + phyinact +
        dis + adl_any + iadl,
      data = final_bidirec_elsi %>% mutate(id = factor(id), internet_yes = as.numeric(internet_yes)-1), id = id,
      family = binomial, corstr = "exchangeable"
      ) # Brazil dont have missing values

    satlife_bidirec_mi_result <- broom.mixed::tidy(satlife_bidirec_mi) %>% 
      slice(2) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, p.value, p.sig)
  }else if(i==18){
    satlife_bidirec_mi <- lapply(mi_bidirec_merge, function(x){
      geepack::geeglm(
        internet_yes ~ satlife_stand + cwave + age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl,
        data = x %>% filter(country_names == names[i]) %>% droplevels(), id = id,
        family = binomial, corstr = "exchangeable"
        )
      })
    satlife_bidirec_mi_result <- broom.mixed::tidy(pool(satlife_bidirec_mi)) %>% 
      slice(2) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, p.value, p.sig)
  }else{
    satlife_bidirec_mi <- lapply(mi_bidirec_merge, function(x){
      geepack::geeglm(
        internet_yes ~ satlife_stand + cwave + age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl,
        data = x %>% filter(country_names == names[i]), id = id,
        family = binomial, corstr = "exchangeable"
        )
      })
    satlife_bidirec_mi_result <- broom.mixed::tidy(pool(satlife_bidirec_mi)) %>% 
      slice(2) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, p.value, p.sig)
  }
  
  satlife_bidirec_mi_results <- satlife_bidirec_mi_results %>% 
    bind_rows(., satlife_bidirec_mi_result)
  
  rm(satlife_bidirec_mi, satlife_bidirec_mi_result)
}

# metafor
satlife_bidirec_mi_meta <- rma(yi = estimate, sei = std.error, data = satlife_bidirec_mi_results, slab = country)


#### Self-reported health ####
# geepack
shlt_bidirec_mi_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    shlt_bidirec_mi <- geepack::geeglm(
      internet_yes  ~ shlt_stand + cwave + age + male + lowedu + lowwealth + lbrf +
        nonmarried + hhres + contact + smoken + weekdrink + phyinact +
        dis + adl_any + iadl,
      data = final_bidirec_elsi %>% mutate(id = factor(id), internet_yes = as.numeric(internet_yes)-1), id = id,
      family = binomial, corstr = "exchangeable"
      ) # Brazil dont have missing values

    shlt_bidirec_mi_result <- broom.mixed::tidy(shlt_bidirec_mi) %>% 
      slice(2) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, p.value, p.sig)
  }else if(i==18){
    shlt_bidirec_mi <- lapply(mi_bidirec_merge, function(x){
      geepack::geeglm(
        internet_yes ~ shlt_stand + cwave + age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl,
        data = x %>% filter(country_names == names[i]) %>% droplevels(), id = id,
        family = binomial, corstr = "exchangeable"
        )
      })
    shlt_bidirec_mi_result <- broom.mixed::tidy(pool(shlt_bidirec_mi)) %>% 
      slice(2) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, p.value, p.sig)
  }else{
    shlt_bidirec_mi <- lapply(mi_bidirec_merge, function(x){
      geepack::geeglm(
        internet_yes ~ shlt_stand + cwave + age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + contact + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl,
        data = x %>% filter(country_names == names[i]), id = id,
        family = binomial, corstr = "exchangeable"
        )
      })
    shlt_bidirec_mi_result <- broom.mixed::tidy(pool(shlt_bidirec_mi)) %>% 
      slice(2) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, p.value, p.sig)
  }
  
  shlt_bidirec_mi_results <- shlt_bidirec_mi_results %>% 
    bind_rows(., shlt_bidirec_mi_result)
  
  rm(shlt_bidirec_mi, shlt_bidirec_mi_result)
}

# metafor
shlt_bidirec_mi_meta <- rma(yi = estimate, sei = std.error, data = shlt_bidirec_mi_results, slab = country)

toc()

```

### Supplementary Figure 20: Bidirectional association: mental health and Internet use

```{r}

#### Theme setting ####
theme <- forestploter::forest_theme(
  core = list(bg_params = list(fill = c("white"))), 
  base_size = 10, 
  # base_family = "Arial",
  ci_pch = 15,
  ci_col = "#3B4992FF", 
  ci_alpha = 1,
  ci_lty = 1,
  ci_lwd = 1,
  ci_Theight = unit(0, "cm"),
  
  xaxis_lwd = 1,
  xaxis_cex = 1,
  
  summary_col = "#008B45FF", 
  refline_col = "gray", 
  refline_lwd = 2, 
  
  title_just = "center",
  title_cex = 1.2,
  title_fontface = "bold",
  title_col = "black",
  
  arrow_type = "closed",
  arrow_label_just = "end",
  arrow_length = 0.05,
  arrow_lwd = 1,
  arrow_fill = "black",
  arrow_col = "black"
  )

#### CES-D ####
# Data
dat <- cesd_bidirec_mi_results %>%
  mutate(weights = weights(cesd_bidirec_mi_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(cesd_bidirec_mi_meta$beta),
      std.error = as.numeric(cesd_bidirec_mi_meta$se), 
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    or = exp(estimate),
    lower = exp(estimate - 1.96*std.error),
    upper = exp(estimate + 1.96*std.error),
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", or, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "OR (95% CI)", "Weight (%)")

p_cesd <- forestploter::forest(
  dat_fig,
  est = dat$or,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 1,
  arrow_lab = c("Fewer depressive symptoms","More depressive symptoms"),
  xlim = c(0, 1.2),
  ticks_at = c(0, 0.3, 0.6, 0.9, 1.2),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(cesd_bidirec_mi_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(cesd_bidirec_mi_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(cesd_bidirec_mi_meta$H2, digits = 2)))
    )

p_cesd <- add_text(
  p_cesd, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(cesd_bidirec_mi_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(cesd_bidirec_mi_meta$k - cesd_bidirec_mi_meta$p), ") = ", 
        .(fmtx(cesd_bidirec_mi_meta$QE, digits = 2)), ", ",

        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(cesd_bidirec_mi_meta$k - cesd_bidirec_mi_meta$p), ") = ", 
        .(fmtx(cesd_bidirec_mi_meta$QE, digits = 2)), ", ",
        .(fmtp(cesd_bidirec_mi_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
  }
  

p_cesd <- add_text(
  p_cesd, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(cesd_bidirec_mi_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(cesd_bidirec_mi_meta$zval, digits = 2)), ", ",
        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(cesd_bidirec_mi_meta$zval, digits = 2)), ", ",
      .(fmtp(cesd_bidirec_mi_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )    
  }

p_cesd <- add_text(
  p_cesd, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_cesd <- add_border(p_cesd, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))


#### Life satisfaction ####
# Data
dat <- satlife_bidirec_mi_results %>%
  mutate(weights = weights(satlife_bidirec_mi_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(satlife_bidirec_mi_meta$beta),
      std.error = as.numeric(satlife_bidirec_mi_meta$se), 
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    or = exp(estimate),
    lower = exp(estimate - 1.96*std.error),
    upper = exp(estimate + 1.96*std.error),
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", or, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "OR (95% CI)", "Weight (%)")

p_satlife <- forestploter::forest(
  dat_fig,
  est = dat$or,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 1,
  arrow_lab = c("Lower life satisfaction","Higher life satisfaction"),
  xlim = c(0, 1.8),
  ticks_at = c(0, 0.6, 1.2, 1.8),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(satlife_bidirec_mi_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(satlife_bidirec_mi_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(satlife_bidirec_mi_meta$H2, digits = 2)))
    )

p_satlife <- add_text(
  p_satlife, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(satlife_bidirec_mi_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(satlife_bidirec_mi_meta$k - satlife_bidirec_mi_meta$p), ") = ", 
        .(fmtx(satlife_bidirec_mi_meta$QE, digits = 2)), ", ",

        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(satlife_bidirec_mi_meta$k - satlife_bidirec_mi_meta$p), ") = ", 
        .(fmtx(satlife_bidirec_mi_meta$QE, digits = 2)), ", ",
        .(fmtp(satlife_bidirec_mi_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
  }

p_satlife <- add_text(
  p_satlife, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(satlife_bidirec_mi_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(satlife_bidirec_mi_meta$zval, digits = 2)), ", ",
        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(satlife_bidirec_mi_meta$zval, digits = 2)), ", ",
      .(fmtp(satlife_bidirec_mi_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )    
  }

p_satlife <- add_text(
  p_satlife, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_satlife <- add_border(p_satlife, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))

#### Self-rated health ####
# Data
dat <- shlt_bidirec_mi_results %>%
  mutate(weights = weights(shlt_bidirec_mi_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA, contrast = NA,
      estimate = as.numeric(shlt_bidirec_mi_meta$beta),
      std.error = as.numeric(shlt_bidirec_mi_meta$se), 
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, contrast = NA, estimate = NA, std.error = NA,
      statistic = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    or = exp(estimate),
    lower = exp(estimate - 1.96*std.error),
    upper = exp(estimate + 1.96*std.error),
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", or, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "OR (95% CI)", "Weight (%)")

p_shlt <- forestploter::forest(
  dat_fig,
  est = dat$or,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 1,
  arrow_lab = c("Worse self-reported health","Better self-reported health"),
  xlim = c(0, 1.83),
  ticks_at = c(0, 0.6, 1.2, 1.8),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(shlt_bidirec_mi_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(shlt_bidirec_mi_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(shlt_bidirec_mi_meta$H2, digits = 2)))
    )

p_shlt <- add_text(
  p_shlt, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(shlt_bidirec_mi_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(shlt_bidirec_mi_meta$k - shlt_bidirec_mi_meta$p), ") = ", 
        .(fmtx(shlt_bidirec_mi_meta$QE, digits = 2)), ", ",

        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(shlt_bidirec_mi_meta$k - shlt_bidirec_mi_meta$p), ") = ", 
        .(fmtx(shlt_bidirec_mi_meta$QE, digits = 2)), ", ",
        .(fmtp(shlt_bidirec_mi_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
  }

p_shlt <- add_text(
  p_shlt, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(shlt_bidirec_mi_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(shlt_bidirec_mi_meta$zval, digits = 2)), ", ",
        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(shlt_bidirec_mi_meta$zval, digits = 2)), ", ",
      .(fmtp(shlt_bidirec_mi_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )    
  }

p_shlt <- add_text(
  p_shlt, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_shlt <- add_border(p_shlt, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))


#### Pool ####
p_pool <- wrap_elements(
  wrap_elements(p_cesd) + wrap_elements(p_satlife) + wrap_elements(p_shlt) + 
    plot_layout(nrow = 2) + 
    plot_annotation(tag_levels = "a")
  ) 

ggsave(str_c(getwd(), "/results/Figure/Supplementary Figure 20_Forest plot_bidirectional_mice.tiff"), plot = p_pool, width = 16, height = 14, unit = "in", dpi = 500, device = "tiff")

rm(theme, dat, dat_fig, test_hetero, test_overall, p_cesd, p_satlife, p_shlt)

```

