---
title: "Internet use and mental health"
author: "Yan Luo"
date: '2023-10-01'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Make sure the working directory is "your path/internet-use-mental-health"
knitr::opts_knit$set(root.dir = "D:/github_project/internet-use-mental-health")

# data processing
library(tidyverse)
library(readxl)
library(skimr)
library(mice)
library(gtsummary)

# visualization
library(forestploter)
library(ggplot2)
library(ggpubr)
library(ggtext)
library(patchwork)
library(grid)
library(glue)

# statistical analysis
library(lmerTest)
library(metafor)

```

# Import processed data

```{r}

print(getwd())

file_list <- list.files(path = str_c(getwd(), "/data/processed"), full.names = T)

lapply(file_list, load, .GlobalEnv)

country_factor <- read_excel(str_c(getwd(), "/data/country_level_factors.xlsx"))

```


# Internet use (yes/no)

## Merge data

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

final_iyes_merge <- final_iyes_hrs %>%
  bind_rows(., final_iyes_elsa) %>%
  bind_rows(., final_iyes_charls) %>%
  bind_rows(., final_iyes_share) %>%
  bind_rows(., final_iyes_mhas) %>%
  bind_rows(., final_iyes_elsi) %>%
  mutate(
    country_names = case_when(
      country == iso[1] ~ names[1],
      country == iso[2] ~ names[2],
      country == iso[3] ~ names[3],
      country == iso[4] ~ names[4],
      country == iso[5] ~ names[5],
      country == iso[6] ~ names[6],
      country == iso[7] ~ names[7],
      country == iso[8] ~ names[8],
      country == iso[9] ~ names[9],
      country == iso[10] ~ names[10],
      country == iso[11] ~ names[11],
      country == iso[12] ~ names[12],
      country == iso[13] ~ names[13],
      country == iso[14] ~ names[14],
      country == iso[15] ~ names[15],
      country == iso[16] ~ names[16],
      country == iso[17] ~ names[17],
      country == iso[18] ~ names[18],
      country == iso[19] ~ names[19],
      country == iso[20] ~ names[20],
      country == iso[21] ~ names[21],
      country == iso[22] ~ names[22],
      country == iso[23] ~ names[23]
    )
  )

```

## Linear mixed model and meta analysis

### CES-D

```{r}

#### lme4 ####
cesd_iyes_unadj_results <- tibble()
for(i in 1:23){
  cesd_iyes_unadj <- lmer(
    cesd_stand ~ internet_yes + cwave + (1 | id),
    data = final_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_unadj_result <- broom.mixed::tidy(cesd_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_unadj_results <- cesd_iyes_unadj_results %>% 
    bind_rows(., cesd_iyes_unadj_result)
  rm(cesd_iyes_unadj, cesd_iyes_unadj_result)
}

cesd_iyes_adj_results <- tibble()
for(i in 1:23){
  cesd_iyes_adj <- lmer(
    cesd_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_adj_result <- broom.mixed::tidy(cesd_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_adj_results <- cesd_iyes_adj_results %>% 
    bind_rows(., cesd_iyes_adj_result)
  rm(cesd_iyes_adj, cesd_iyes_adj_result)
}

#### metafor ####
cesd_iyes_unadj_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_unadj_results, slab = country)

cesd_iyes_adj_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_results, slab = country)

# meta regression
metareg_cesd_iyes_adj <- cesd_iyes_adj_results %>% 
  left_join(country_factor, by = "country") %>%
  mutate(
    measure = case_when(
      country == "Mexico" ~ "home_level",
      country != "Mexico" &  country != "England" ~ "binary",
      country == "England" ~ "frequency",
      TRUE ~ NA_character_
    ),
    measure = factor(measure, levels = c("binary", "home_level", "frequency")),
  )

## country-level factors
gdp_cesd_iyes_adj <- rma(yi = estimate, sei = std.error, mods = ~ GDP_per_capita, data = metareg_cesd_iyes_adj, slab = country)

gini_cesd_iyes_adj <- rma(yi = estimate, sei = std.error, mods = ~ gini, data = metareg_cesd_iyes_adj, slab = country)

whi_cesd_iyes_adj <- rma(yi = estimate, sei = std.error, mods = ~ world_happiness_index, data = metareg_cesd_iyes_adj, slab = country)

indiv_cesd_iyes_adj <- rma(yi = estimate, sei = std.error, mods = ~ individualism_score, data = metareg_cesd_iyes_adj, slab = country)

dskill_cesd_iyes_adj <- rma(yi = estimate, sei = std.error, mods = ~ digital_skills_score, data = metareg_cesd_iyes_adj, slab = country)

iuse_cesd_iyes_adj <- rma(yi = estimate, sei = std.error, mods = ~ internet_use_rate, data = metareg_cesd_iyes_adj, slab = country)

hale_cesd_iyes_adj <- rma(yi = estimate, sei = std.error, mods = ~ healthy_life_expectancy, data = metareg_cesd_iyes_adj, slab = country)

## measurement of Internet use
measure_cesd_iyes_adj <- rma(yi = estimate, sei = std.error, mods = ~ measure, data = metareg_cesd_iyes_adj, slab = country)

```

### Life satisfaction

```{r}

#### lme4 ####
satlife_iyes_unadj_results <- tibble()
for(i in 1:23){
  satlife_iyes_unadj <- lmer(
    satlife_stand  ~ internet_yes + cwave + (1 | id),
    data = final_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_unadj_result <- broom.mixed::tidy(satlife_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_unadj_results <- satlife_iyes_unadj_results %>% 
    bind_rows(., satlife_iyes_unadj_result)
  rm(satlife_iyes_unadj, satlife_iyes_unadj_result)
}

satlife_iyes_adj_results <- tibble()
for(i in 1:23){
  satlife_iyes_adj <- lmer(
    satlife_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_adj_result <- broom.mixed::tidy(satlife_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_adj_results <- satlife_iyes_adj_results %>% 
    bind_rows(., satlife_iyes_adj_result)
  rm(satlife_iyes_adj, satlife_iyes_adj_result)
}

#### metafor ####
satlife_iyes_unadj_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_unadj_results, slab = country)

satlife_iyes_adj_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_results, slab = country)

# meta regression
metareg_satlife_iyes_adj <- satlife_iyes_adj_results %>% 
  left_join(country_factor, by = "country") %>%
  mutate(
    measure = case_when(
      country == "Mexico" ~ "home_level",
      country != "Mexico" &  country != "England" ~ "binary",
      country == "England" ~ "frequency",
      TRUE ~ NA_character_
    ),
    measure = factor(measure, levels = c("binary", "home_level", "frequency")),
  )


## country-level factors
gdp_satlife_iyes_adj <- rma(yi = estimate, sei = std.error, mods = ~ GDP_per_capita, data = metareg_satlife_iyes_adj, slab = country)

gini_satlife_iyes_adj <- rma(yi = estimate, sei = std.error, mods = ~ gini, data = metareg_satlife_iyes_adj, slab = country)

whi_satlife_iyes_adj <- rma(yi = estimate, sei = std.error, mods = ~ world_happiness_index, data = metareg_satlife_iyes_adj, slab = country)

indiv_satlife_iyes_adj <- rma(yi = estimate, sei = std.error, mods = ~ individualism_score, data = metareg_satlife_iyes_adj, slab = country)

dskill_satlife_iyes_adj <- rma(yi = estimate, sei = std.error, mods = ~ digital_skills_score, data = metareg_satlife_iyes_adj, slab = country)

iuse_satlife_iyes_adj <- rma(yi = estimate, sei = std.error, mods = ~ internet_use_rate, data = metareg_satlife_iyes_adj, slab = country)

hale_satlife_iyes_adj <- rma(yi = estimate, sei = std.error, mods = ~ healthy_life_expectancy, data = metareg_satlife_iyes_adj, slab = country)

## measurement of Internet use
measure_satlife_iyes_adj <- rma(yi = estimate, sei = std.error, mods = ~ measure, data = metareg_satlife_iyes_adj, slab = country)

```

### Self-rated health

```{r}

#### lme4 ####
shlt_iyes_unadj_results <- tibble()
for(i in 1:23){
  shlt_iyes_unadj <- lmer(
    shlt_stand  ~ internet_yes + cwave + (1 | id),
    data = final_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_unadj_result <- broom.mixed::tidy(shlt_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_unadj_results <- shlt_iyes_unadj_results %>% 
    bind_rows(., shlt_iyes_unadj_result)
  rm(shlt_iyes_unadj, shlt_iyes_unadj_result)
}

shlt_iyes_adj_results <- tibble()
for(i in 1:23){
  shlt_iyes_adj <- lmer(
    shlt_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_adj_result <- broom.mixed::tidy(shlt_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_adj_results <- shlt_iyes_adj_results %>% 
    bind_rows(., shlt_iyes_adj_result)
  rm(shlt_iyes_adj, shlt_iyes_adj_result)
}

#### metafor ####
shlt_iyes_unadj_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_unadj_results, slab = country)

shlt_iyes_adj_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_results, slab = country)


# meta regression
metareg_shlt_iyes_adj <- shlt_iyes_adj_results %>% 
  left_join(country_factor, by = "country") %>%
  mutate(
    measure = case_when(
      country == "Mexico" ~ "home_level",
      country != "Mexico" &  country != "England" ~ "binary",
      country == "England" ~ "frequency",
      TRUE ~ NA_character_
    ),
    measure = factor(measure, levels = c("binary", "home_level", "frequency")),
  )

## country-level factors
gdp_shlt_iyes_adj <- rma(yi = estimate, sei = std.error, mods = ~ GDP_per_capita, data = metareg_shlt_iyes_adj, slab = country)

gini_shlt_iyes_adj <- rma(yi = estimate, sei = std.error, mods = ~ gini, data = metareg_shlt_iyes_adj, slab = country)

whi_shlt_iyes_adj <- rma(yi = estimate, sei = std.error, mods = ~ world_happiness_index, data = metareg_shlt_iyes_adj, slab = country)

indiv_shlt_iyes_adj <- rma(yi = estimate, sei = std.error, mods = ~ individualism_score, data = metareg_shlt_iyes_adj, slab = country)

dskill_shlt_iyes_adj <- rma(yi = estimate, sei = std.error, mods = ~ digital_skills_score, data = metareg_shlt_iyes_adj, slab = country)

iuse_shlt_iyes_adj <- rma(yi = estimate, sei = std.error, mods = ~ internet_use_rate, data = metareg_shlt_iyes_adj, slab = country)

hale_shlt_iyes_adj <- rma(yi = estimate, sei = std.error, mods = ~ healthy_life_expectancy, data = metareg_shlt_iyes_adj, slab = country)

## measurement of Internet use
measure_shlt_iyes_adj <- rma(yi = estimate, sei = std.error, mods = ~ measure, data = metareg_shlt_iyes_adj, slab = country)

```

## Figure 1: Associations of Internet use with mental health

```{r}

#### Theme setting ####
theme <- forestploter::forest_theme(
  core = list(bg_params = list(fill = c("white"))), 
  base_size = 10,
  # base_family = "Arial",
  ci_pch = 15,
  ci_col = "#3B4992FF", 
  ci_alpha = 1,
  ci_lty = 1,
  ci_lwd = 1,
  ci_Theight = unit(0, "cm"),
  
  xaxis_lwd = 1,
  xaxis_cex = 1,
  
  summary_col = "#008B45FF", 
  refline_col = "gray", 
  refline_lwd = 2, 
  
  title_just = "center",
  title_cex = 1.2,
  title_fontface = "bold",
  title_col = "black",
  
  arrow_type = "closed",
  arrow_label_just = "end",
  arrow_length = 0.05,
  arrow_lwd = 1,
  arrow_fill = "black",
  arrow_col = "black"
  )

#### CES-D ####
# Data
dat <- cesd_iyes_adj_results %>%
  mutate(weights = weights(cesd_iyes_adj_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(cesd_iyes_adj_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_meta$se), 
      statistic = NA, df = NA, p.value = NA, p.sig = NA, 
      weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "β (95% CI)", "Weight (%)")

p_cesd <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Fewer depressive symptoms","More depressive symptoms"),
  xlim = c(-0.5, 0.5),
  ticks_at = c(-0.5, -0.25, 0, 0.25, 0.5),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(cesd_iyes_adj_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(cesd_iyes_adj_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(cesd_iyes_adj_meta$H2, digits = 2)))
    )

p_cesd <- add_text(
  p_cesd, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(cesd_iyes_adj_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(cesd_iyes_adj_meta$k - cesd_iyes_adj_meta$p), ") = ", 
        .(fmtx(cesd_iyes_adj_meta$QE, digits = 2)), ", ",

        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(cesd_iyes_adj_meta$k - cesd_iyes_adj_meta$p), ") = ", 
        .(fmtx(cesd_iyes_adj_meta$QE, digits = 2)), ", ",
        .(fmtp(cesd_iyes_adj_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
  }
  

p_cesd <- add_text(
  p_cesd, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(cesd_iyes_adj_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(cesd_iyes_adj_meta$zval, digits = 2)), ", ",
        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(cesd_iyes_adj_meta$zval, digits = 2)), ", ",
      .(fmtp(cesd_iyes_adj_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )    
  }

p_cesd <- add_text(
  p_cesd, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_cesd <- add_border(p_cesd, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))


#### Self-rated health ####
# Data
dat <- shlt_iyes_adj_results %>%
  mutate(weights = weights(shlt_iyes_adj_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(shlt_iyes_adj_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_meta$se), 
      statistic = NA, df = NA, p.value = NA, p.sig = NA, 
      weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "β (95% CI)", "Weight (%)")

p_shlt <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Worse self-reported health","Better self-reported health"),
  xlim = c(-0.4, 0.4),
  ticks_at = c(-0.4, -0.2, 0, 0.2, 0.4),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(shlt_iyes_adj_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(shlt_iyes_adj_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(shlt_iyes_adj_meta$H2, digits = 2)))
    )

p_shlt <- add_text(
  p_shlt, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(shlt_iyes_adj_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(shlt_iyes_adj_meta$k - shlt_iyes_adj_meta$p), ") = ", 
        .(fmtx(shlt_iyes_adj_meta$QE, digits = 2)), ", ",

        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(shlt_iyes_adj_meta$k - shlt_iyes_adj_meta$p), ") = ", 
        .(fmtx(shlt_iyes_adj_meta$QE, digits = 2)), ", ",
        .(fmtp(shlt_iyes_adj_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
  }

p_shlt <- add_text(
  p_shlt, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(shlt_iyes_adj_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(shlt_iyes_adj_meta$zval, digits = 2)), ", ",
        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(shlt_iyes_adj_meta$zval, digits = 2)), ", ",
      .(fmtp(shlt_iyes_adj_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )    
  }

p_shlt <- add_text(
  p_shlt, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_shlt <- add_border(p_shlt, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))


#### Life satisfaction ####
# Data
dat <- satlife_iyes_adj_results %>%
  mutate(weights = weights(satlife_iyes_adj_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(satlife_iyes_adj_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_meta$se), 
      statistic = NA, df = NA, p.value = NA, p.sig = NA, 
      weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "β (95% CI)", "Weight (%)")

p_satlife <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Lower life satisfaction","Higher life satisfaction"),
  xlim = c(-0.2, 0.8),
  ticks_at = c(-0.2, 0, 0.2, 0.4, 0.6, 0.8),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(satlife_iyes_adj_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(satlife_iyes_adj_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(satlife_iyes_adj_meta$H2, digits = 2)))
    )

p_satlife <- add_text(
  p_satlife, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(satlife_iyes_adj_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(satlife_iyes_adj_meta$k - satlife_iyes_adj_meta$p), ") = ", 
        .(fmtx(satlife_iyes_adj_meta$QE, digits = 2)), ", ",

        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(satlife_iyes_adj_meta$k - satlife_iyes_adj_meta$p), ") = ", 
        .(fmtx(satlife_iyes_adj_meta$QE, digits = 2)), ", ",
        .(fmtp(satlife_iyes_adj_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
  }

p_satlife <- add_text(
  p_satlife, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(satlife_iyes_adj_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(satlife_iyes_adj_meta$zval, digits = 2)), ", ",
        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(satlife_iyes_adj_meta$zval, digits = 2)), ", ",
      .(fmtp(satlife_iyes_adj_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )    
  }

p_satlife <- add_text(
  p_satlife, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_satlife <- add_border(p_satlife, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))

#### Pool ####
p_pool <- wrap_elements(
  wrap_elements(p_cesd) + wrap_elements(p_satlife) + wrap_elements(p_shlt) + 
    plot_layout(nrow = 2) + 
    plot_annotation(tag_levels = "a")
  ) 

ggsave(str_c(getwd(), "/results/Figure/Figure 1_Forest plot_internet use.tiff"), plot = p_pool, width = 16, height = 14, unit = "in", dpi = 500, device = "tiff")

```

## Figure 2: Bubble plot with fitted meta regression line of the β coefficient for three mental wellbeing outcomes and country-level factors

```{r}

#### CES-D ####
# GDP per capita
dat <- metareg_cesd_iyes_adj %>%
  mutate(weights = weights(gdp_cesd_iyes_adj))

dat_ci <- metafor::predict.rma(gdp_cesd_iyes_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_cesd_iyes_adj$GDP_per_capita)

bubble_gdp_cesd <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = GDP_per_capita, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = GDP_per_capita, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(gdp_cesd_iyes_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(gdp_cesd_iyes_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(8500, 130000)
  ) +
  scale_y_continuous(
    limits = c(-0.25, 0.15)
  ) +
  labs(
    x = "$US",
    y = "β",
    title = "Depressive symptoms"
  )
  

# Gini index
dat <- metareg_cesd_iyes_adj %>%
  mutate(weights = weights(gini_cesd_iyes_adj))

dat_ci <- metafor::predict.rma(gini_cesd_iyes_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_cesd_iyes_adj$gini)

bubble_gini_cesd <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = gini, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = gini, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(gini_cesd_iyes_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(gini_cesd_iyes_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(24, 54)
  ) +
  scale_y_continuous(
    limits = c(-0.25, 0.15)
  ) +
  labs(
    x = "Score",
    y = "β",
    title = "Depressive symptoms"
  )
  
# World happiness index
dat <- metareg_cesd_iyes_adj %>%
  mutate(weights = weights(whi_cesd_iyes_adj))

dat_ci <- metafor::predict.rma(whi_cesd_iyes_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_cesd_iyes_adj$world_happiness_index)

bubble_whi_cesd <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = world_happiness_index, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF",
    ) + 
  geom_text(
    aes(x = world_happiness_index, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(whi_cesd_iyes_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(whi_cesd_iyes_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(5.8, 7.68)
  ) +
  scale_y_continuous(
    limits = c(-0.25, 0.15)
  ) +
  labs(
    x = "Score",
    y = "β",
    title = "Depressive symptoms"
  )

# Hofstede’s index
dat <- metareg_cesd_iyes_adj %>%
  mutate(weights = weights(indiv_cesd_iyes_adj))

dat_ci <- metafor::predict.rma(indiv_cesd_iyes_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_cesd_iyes_adj$individualism_score)

bubble_indiv_cesd <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = individualism_score, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = individualism_score, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(indiv_cesd_iyes_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(indiv_cesd_iyes_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(34, 101)
  ) +
  scale_y_continuous(
    limits = c(-0.25, 0.15)
  ) +
  labs(
    x = "Score",
    y = "β",
    title = "Depressive symptoms"
  )

# Internet use rate
dat <- metareg_cesd_iyes_adj %>%
  mutate(weights = weights(iuse_cesd_iyes_adj))

dat_ci <- metafor::predict.rma(iuse_cesd_iyes_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_cesd_iyes_adj$internet_use_rate)

bubble_iuse_cesd <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = internet_use_rate, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = internet_use_rate, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(iuse_cesd_iyes_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(iuse_cesd_iyes_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(75, 99)
  ) +
  scale_y_continuous(
    limits = c(-0.25, 0.15)
  ) +
  labs(
    x = "Rate (%)",
    y = "β",
    title = "Depressive symptoms"
  )

# Digital skills among active population
dat <- metareg_cesd_iyes_adj %>%
  mutate(weights = weights(dskill_cesd_iyes_adj))

dat_ci <- metafor::predict.rma(dskill_cesd_iyes_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_cesd_iyes_adj$digital_skills_score)

bubble_dskill_cesd <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = digital_skills_score, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = digital_skills_score, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(dskill_cesd_iyes_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(dskill_cesd_iyes_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(34, 79)
  ) +
  scale_y_continuous(
    limits = c(-0.25, 0.15)
  ) +
  labs(
    x = "Score",
    y = "β",
    title = "Depressive symptoms"
  )

# Healthy life expectancy at birth
dat <- metareg_cesd_iyes_adj %>%
  mutate(weights = weights(hale_cesd_iyes_adj))

dat_ci <- metafor::predict.rma(hale_cesd_iyes_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_cesd_iyes_adj$healthy_life_expectancy)

bubble_hale_cesd <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = healthy_life_expectancy, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = healthy_life_expectancy, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(hale_cesd_iyes_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(hale_cesd_iyes_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(65.2, 72.8)
  ) +
  scale_y_continuous(
    limits = c(-0.25, 0.15)
  ) +
  labs(
    x = "Years",
    y = "β",
    title = "Depressive symptoms"
  )


#### Self-rated health ####
# GDP per capita
dat <- metareg_shlt_iyes_adj %>%
  mutate(weights = weights(gdp_shlt_iyes_adj))

dat_ci <- metafor::predict.rma(gdp_shlt_iyes_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_shlt_iyes_adj$GDP_per_capita)

bubble_gdp_shlt <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3
    ) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = GDP_per_capita, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = GDP_per_capita, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(gdp_shlt_iyes_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(gdp_shlt_iyes_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(8500, 130000)
  ) +
  scale_y_continuous(
    limits = c(-0.05, 0.35)
  ) +
  labs(
    x = "$US",
    y = "β",
    title = "Self-reported health"
  )
  

# Gini index
dat <- metareg_shlt_iyes_adj %>%
  mutate(weights = weights(gini_shlt_iyes_adj))

dat_ci <- metafor::predict.rma(gini_shlt_iyes_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_shlt_iyes_adj$gini)

bubble_gini_shlt <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = gini, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = gini, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(gini_shlt_iyes_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(gini_shlt_iyes_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(24, 54)
  ) +
  scale_y_continuous(
    limits = c(-0.05, 0.35)
  ) +
  labs(
    x = "Score",
    y = "β",
    title = "Self-reported health"
  )
  
# World happiness index
dat <- metareg_shlt_iyes_adj %>%
  mutate(weights = weights(whi_shlt_iyes_adj))

dat_ci <- metafor::predict.rma(whi_shlt_iyes_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_shlt_iyes_adj$world_happiness_index)

bubble_whi_shlt <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = world_happiness_index, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = world_happiness_index, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(whi_shlt_iyes_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(whi_shlt_iyes_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(5.8, 7.68)
  ) +
  scale_y_continuous(
    limits = c(-0.05, 0.35)
  ) +
  labs(
    x = "Score",
    y = "β",
    title = "Self-reported health"
  )

# Hofstede’s index
dat <- metareg_shlt_iyes_adj %>%
  mutate(weights = weights(indiv_shlt_iyes_adj))

dat_ci <- metafor::predict.rma(indiv_shlt_iyes_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_shlt_iyes_adj$individualism_score)

bubble_indiv_shlt <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = individualism_score, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = individualism_score, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(indiv_shlt_iyes_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(indiv_shlt_iyes_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(34, 101)
  ) +
  scale_y_continuous(
    limits = c(-0.05, 0.35)
  ) +
  labs(
    x = "Score",
    y = "β",
    title = "Self-reported health"
  )

# Internet use rate
dat <- metareg_shlt_iyes_adj %>%
  mutate(weights = weights(iuse_shlt_iyes_adj))

dat_ci <- metafor::predict.rma(iuse_shlt_iyes_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_shlt_iyes_adj$internet_use_rate)

bubble_iuse_shlt <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = internet_use_rate, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = internet_use_rate, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(iuse_shlt_iyes_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(iuse_shlt_iyes_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(75, 99)
  ) +
  scale_y_continuous(
    limits = c(-0.05, 0.35)
  ) +
  labs(
    x = "Rate (%)",
    y = "β",
    title = "Self-reported health"
  )

# Digital skills among active population
dat <- metareg_shlt_iyes_adj %>%
  mutate(weights = weights(dskill_shlt_iyes_adj))

dat_ci <- metafor::predict.rma(dskill_shlt_iyes_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_shlt_iyes_adj$digital_skills_score)

bubble_dskill_shlt <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = digital_skills_score, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = digital_skills_score, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(dskill_shlt_iyes_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(dskill_shlt_iyes_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5),
    ) +
  scale_x_continuous(
    limits = c(34, 79)
  ) +
  scale_y_continuous(
    limits = c(-0.05, 0.35)
  ) +
  labs(
    x = "Score",
    y = "β",
    title = "Self-reported health"
  )

# Healthy life expectancy at birth
dat <- metareg_shlt_iyes_adj %>%
  mutate(weights = weights(hale_shlt_iyes_adj))

dat_ci <- metafor::predict.rma(hale_shlt_iyes_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_shlt_iyes_adj$healthy_life_expectancy)

bubble_hale_shlt <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = healthy_life_expectancy, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF",
    ) + 
  geom_text(
    aes(x = healthy_life_expectancy, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(hale_shlt_iyes_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(hale_shlt_iyes_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(65.2, 72.8)
  ) +
  scale_y_continuous(
    limits = c(-0.05, 0.35)
  ) +
  labs(
    x = "Years",
    y = "β",
    title = "Self-reported health"
  )


#### Life satisfaction ####
# GDP per capita
dat <- metareg_satlife_iyes_adj %>%
  mutate(weights = weights(gdp_satlife_iyes_adj))

dat_ci <- metafor::predict.rma(gdp_satlife_iyes_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_satlife_iyes_adj$GDP_per_capita)

bubble_gdp_satlife <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3
    ) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = GDP_per_capita, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = GDP_per_capita, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(gdp_satlife_iyes_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(gdp_satlife_iyes_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(8500, 130000)
  ) +
  scale_y_continuous(
    limits = c(-0.1, 0.45)
  ) +
  labs(
    x = "$US",
    y = "β",
    title = "Life satisfaction"
  )
  

# Gini index
dat <- metareg_satlife_iyes_adj %>%
  mutate(weights = weights(gini_satlife_iyes_adj))

dat_ci <- metafor::predict.rma(gini_satlife_iyes_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_satlife_iyes_adj$gini)

bubble_gini_satlife <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = gini, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = gini, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(gini_satlife_iyes_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(gini_satlife_iyes_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(24, 54)
  ) +
  scale_y_continuous(
    limits = c(-0.1, 0.45)
  ) +
  labs(
    x = "Score",
    y = "β",
    title = "Life satisfaction"
  )
  
# World happiness index
dat <- metareg_satlife_iyes_adj %>%
  mutate(weights = weights(whi_satlife_iyes_adj))

dat_ci <- metafor::predict.rma(whi_satlife_iyes_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_satlife_iyes_adj$world_happiness_index)

bubble_whi_satlife <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = world_happiness_index, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = world_happiness_index, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(whi_satlife_iyes_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(whi_satlife_iyes_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(5.8, 7.68)
  ) +
  scale_y_continuous(
    limits = c(-0.1, 0.45)
  ) +
  labs(
    x = "Score",
    y = "β",
    title = "Life satisfaction"
  )

# Hofstede’s index
dat <- metareg_satlife_iyes_adj %>%
  mutate(weights = weights(indiv_satlife_iyes_adj))

dat_ci <- metafor::predict.rma(indiv_satlife_iyes_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_satlife_iyes_adj$individualism_score)

bubble_indiv_satlife <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = individualism_score, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = individualism_score, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(indiv_satlife_iyes_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(indiv_satlife_iyes_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(34, 101)
  ) +
  scale_y_continuous(
    limits = c(-0.1, 0.45)
  ) +
  labs(
    x = "Score",
    y = "β",
    title = "Life satisfaction"
  )

# Internet use rate
dat <- metareg_satlife_iyes_adj %>%
  mutate(weights = weights(iuse_satlife_iyes_adj))

dat_ci <- metafor::predict.rma(iuse_satlife_iyes_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_satlife_iyes_adj$internet_use_rate)

bubble_iuse_satlife <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = internet_use_rate, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = internet_use_rate, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(iuse_satlife_iyes_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(iuse_satlife_iyes_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(75, 99)
  ) +
  scale_y_continuous(
    limits = c(-0.1, 0.45)
  ) +
  labs(
    x = "Rate (%)",
    y = "β",
    title = "Life satisfaction"
  )

# Digital skills among active population
dat <- metareg_satlife_iyes_adj %>%
  mutate(weights = weights(dskill_satlife_iyes_adj))

dat_ci <- metafor::predict.rma(dskill_satlife_iyes_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_satlife_iyes_adj$digital_skills_score)

bubble_dskill_satlife <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = digital_skills_score, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = digital_skills_score, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(dskill_satlife_iyes_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(dskill_satlife_iyes_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(34, 79)
  ) +
  scale_y_continuous(
    limits = c(-0.1, 0.45)
  ) +
  labs(
    x = "Score",
    y = "β",
    title = "Life satisfaction"
  )

# Healthy life expectancy at birth
dat <- metareg_satlife_iyes_adj %>%
  mutate(weights = weights(hale_satlife_iyes_adj))

dat_ci <- metafor::predict.rma(hale_satlife_iyes_adj) %>%
  as_tibble() %>%
  mutate(x = metareg_satlife_iyes_adj$healthy_life_expectancy)

bubble_hale_satlife <- ggplot(data = dat) +
  geom_ribbon(
    aes(x = x, ymin = ci.lb, ymax = ci.ub), data = dat_ci, 
    fill = "#F39B7FFF", alpha = 0.3) +
  geom_line(aes(x = x, y = pred), data = dat_ci, color = "#F39B7FFF", linewidth = 1.25) +
  geom_hline(yintercept = 0, color = "#DC0000FF", linewidth = 1, linetype = 2) +
  geom_point(
    aes(x = healthy_life_expectancy, y = estimate), 
    size = dat$weights, alpha = 0.5, color = "#3B4992FF", 
    ) + 
  geom_text(
    aes(x = healthy_life_expectancy, y = estimate, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = Inf, parse = F, hjust = 1.05, vjust = 1.1, size = 4,
    label = bquote(
      paste(
        italic(R)^2, " = ", .(fmtx(hale_satlife_iyes_adj$R2, digits = 2)), "%", "; ",
        .(fmtp(hale_satlife_iyes_adj$QMp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(65.2, 72.8)
  ) +
  scale_y_continuous(
    limits = c(-0.1, 0.45)
  ) +
  labs(
    x = "Years",
    y = "β",
    title = "Life satisfaction"
  )

#### Pool ####
p_gdp <- wrap_elements(
  bubble_gdp_cesd + bubble_gdp_satlife + bubble_gdp_shlt + 
  plot_annotation(
    title = expression(paste(bold("a"), "  GDP per capita")),
    theme = theme(plot.title = element_text(size = 16))
    )
  )

p_gini <- wrap_elements(
  bubble_gini_cesd + bubble_gini_satlife + bubble_gini_shlt + 
  plot_annotation(
    title = expression(paste(bold("b"), "  Gini index")),
    theme = theme(plot.title = element_text(size = 16))
    )
  )

p_whi <- wrap_elements(
  bubble_whi_cesd + bubble_whi_satlife + bubble_whi_shlt + 
  plot_annotation(
    title = expression(paste(bold("c"), "  World happiness index")),
    theme = theme(plot.title = element_text(size = 16))
    )
  )

p_indiv <- wrap_elements(
  bubble_indiv_cesd + bubble_indiv_satlife + bubble_indiv_shlt + 
  plot_annotation(
    title = expression(paste(bold("d"), "  Hofstede’s index")),
    theme = theme(plot.title = element_text(size = 16))
    )
  )

p_iuse <- wrap_elements(
  bubble_iuse_cesd + bubble_iuse_satlife + bubble_iuse_shlt + 
  plot_annotation(
    title = expression(paste(bold("e"), "  Internet use rate")),
    theme = theme(plot.title = element_text(size = 16))
    )
  )

p_dskill <- wrap_elements(
  bubble_dskill_cesd + bubble_dskill_satlife + bubble_dskill_shlt + 
  plot_annotation(
    title = expression(paste(bold("f"), "  Digital skills among active population")),
    theme = theme(plot.title = element_text(size = 16))
    )
  )

p_hale <- wrap_elements(
  bubble_hale_cesd + bubble_hale_satlife + bubble_hale_shlt + 
  plot_annotation(
    title = expression(paste(bold("g"), "  Healthy life expectancy at birth")),
    theme = theme(plot.title = element_text(size = 16))
    )
  )

p_pool_bubble <- wrap_elements(
  p_gdp + p_gini + p_whi + p_indiv + p_iuse + p_dskill + p_hale +
  plot_layout(nrow = 7)
  )


ggsave(str_c(getwd(), "/results/Figure/Figure 2_Bubble plot.tiff"), plot = p_pool_bubble, width = 12, height = 24, unit = "in", dpi = 500, device = "tiff")

```

# Subgroup analyses: Internet use (yes/no)

## Data for the overall interaction test

```{r}

subgroup_iyes_merge <- final_iyes_merge %>%
  mutate(
    old = ifelse(age >= 65, "yes", "no"),
    old = factor(old),
    withdis = ifelse(dis >= 1, "yes", "no"),
    withdis = factor(withdis)
  )

```

## By age

### 50-64 years

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

middle_iyes_merge <- middle_iyes_hrs %>% mutate(id = as.character(id)) %>%
  bind_rows(., middle_iyes_elsa %>% mutate(id = as.character(id))) %>%
  bind_rows(., middle_iyes_charls %>% mutate(id = as.character(id))) %>%
  bind_rows(., middle_iyes_share) %>%
  bind_rows(., middle_iyes_mhas) %>%
  bind_rows(., middle_iyes_elsi %>% mutate(id = as.character(id))) %>%
  mutate(
    country_names = case_when(
      country == iso[1] ~ names[1],
      country == iso[2] ~ names[2],
      country == iso[3] ~ names[3],
      country == iso[4] ~ names[4],
      country == iso[5] ~ names[5],
      country == iso[6] ~ names[6],
      country == iso[7] ~ names[7],
      country == iso[8] ~ names[8],
      country == iso[9] ~ names[9],
      country == iso[10] ~ names[10],
      country == iso[11] ~ names[11],
      country == iso[12] ~ names[12],
      country == iso[13] ~ names[13],
      country == iso[14] ~ names[14],
      country == iso[15] ~ names[15],
      country == iso[16] ~ names[16],
      country == iso[17] ~ names[17],
      country == iso[18] ~ names[18],
      country == iso[19] ~ names[19],
      country == iso[20] ~ names[20],
      country == iso[21] ~ names[21],
      country == iso[22] ~ names[22],
      country == iso[23] ~ names[23]
    )
  )

```

#### CES-D

```{r}

#### lme4 ####
cesd_iyes_unadj_middle_results <- tibble()
for(i in 1:23){
  cesd_iyes_unadj <- lmer(
    cesd_stand ~ internet_yes + cwave + (1 | id),
    data = middle_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_unadj_result <- broom.mixed::tidy(cesd_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_unadj_middle_results <- cesd_iyes_unadj_middle_results %>% 
    bind_rows(., cesd_iyes_unadj_result)
  rm(cesd_iyes_unadj, cesd_iyes_unadj_result)
}

cesd_iyes_adj_middle_results <- tibble()
for(i in 1:23){
  cesd_iyes_adj <- lmer(
    cesd_stand ~ internet_yes + cwave + 
      male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = middle_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_adj_result <- broom.mixed::tidy(cesd_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_adj_middle_results <- cesd_iyes_adj_middle_results %>% 
    bind_rows(., cesd_iyes_adj_result)
  rm(cesd_iyes_adj, cesd_iyes_adj_result)
}

#### metafor ####
cesd_iyes_unadj_middle_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_unadj_middle_results, slab = country)

cesd_iyes_adj_middle_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_middle_results, slab = country)

```

#### Self-rated health

```{r}

#### lme4 ####
shlt_iyes_unadj_middle_results <- tibble()
for(i in 1:23){
  shlt_iyes_unadj <- lmer(
    shlt_stand ~ internet_yes + cwave + (1 | id),
    data = middle_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_unadj_result <- broom.mixed::tidy(shlt_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_unadj_middle_results <- shlt_iyes_unadj_middle_results %>% 
    bind_rows(., shlt_iyes_unadj_result)
  rm(shlt_iyes_unadj, shlt_iyes_unadj_result)
}

shlt_iyes_adj_middle_results <- tibble()
for(i in 1:23){
  shlt_iyes_adj <- lmer(
    shlt_stand ~ internet_yes + cwave + 
      male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = middle_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_adj_result <- broom.mixed::tidy(shlt_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_adj_middle_results <- shlt_iyes_adj_middle_results %>% 
    bind_rows(., shlt_iyes_adj_result)
  rm(shlt_iyes_adj, shlt_iyes_adj_result)
}


#### metafor ####
shlt_iyes_unadj_middle_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_unadj_middle_results, slab = country)

shlt_iyes_adj_middle_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_middle_results, slab = country)

```

#### Life satisfaction

```{r}

#### lme4 ####
satlife_iyes_unadj_middle_results <- tibble()
for(i in 1:23){
  satlife_iyes_unadj <- lmer(
    satlife_stand ~ internet_yes + cwave + (1 | id),
    data = middle_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_unadj_result <- broom.mixed::tidy(satlife_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_unadj_middle_results <- satlife_iyes_unadj_middle_results %>% 
    bind_rows(., satlife_iyes_unadj_result)
  rm(satlife_iyes_unadj, satlife_iyes_unadj_result)
}

satlife_iyes_adj_middle_results <- tibble()
for(i in 1:23){
  satlife_iyes_adj <- lmer(
    satlife_stand ~ internet_yes + cwave + 
      male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = middle_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_adj_result <- broom.mixed::tidy(satlife_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_adj_middle_results <- satlife_iyes_adj_middle_results %>% 
    bind_rows(., satlife_iyes_adj_result)
  rm(satlife_iyes_adj, satlife_iyes_adj_result)
}


#### metafor ####
satlife_iyes_unadj_middle_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_unadj_middle_results, slab = country)

satlife_iyes_adj_middle_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_middle_results, slab = country)

```

### ≥65 years

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

old_iyes_merge <- old_iyes_hrs %>% mutate(id = as.character(id)) %>%
  bind_rows(., old_iyes_elsa %>% mutate(id = as.character(id))) %>%
  bind_rows(., old_iyes_charls %>% mutate(id = as.character(id))) %>%
  bind_rows(., old_iyes_share) %>%
  bind_rows(., old_iyes_mhas) %>%
  bind_rows(., old_iyes_elsi %>% mutate(id = as.character(id))) %>%
  mutate(
    country_names = case_when(
      country == iso[1] ~ names[1],
      country == iso[2] ~ names[2],
      country == iso[3] ~ names[3],
      country == iso[4] ~ names[4],
      country == iso[5] ~ names[5],
      country == iso[6] ~ names[6],
      country == iso[7] ~ names[7],
      country == iso[8] ~ names[8],
      country == iso[9] ~ names[9],
      country == iso[10] ~ names[10],
      country == iso[11] ~ names[11],
      country == iso[12] ~ names[12],
      country == iso[13] ~ names[13],
      country == iso[14] ~ names[14],
      country == iso[15] ~ names[15],
      country == iso[16] ~ names[16],
      country == iso[17] ~ names[17],
      country == iso[18] ~ names[18],
      country == iso[19] ~ names[19],
      country == iso[20] ~ names[20],
      country == iso[21] ~ names[21],
      country == iso[22] ~ names[22],
      country == iso[23] ~ names[23]
    )
  )

print(old_iyes_merge %>% 
  group_by(id) %>% 
  slice(1) %>% 
  ungroup() %>% 
  mutate(internet_yes = as.numeric(internet_yes) - 1) %>%
  group_by(country_names) %>% 
  summarise(mean(internet_yes)*100), n = 50)
# Poland: no older adults use internet

```

#### CES-D

```{r}

#### lme4 ####
cesd_iyes_unadj_old_results <- tibble()
for(i in c(1:17,19:23)){
  cesd_iyes_unadj <- lmer(
    cesd_stand ~ internet_yes + cwave + (1 | id),
    data = old_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_unadj_result <- broom.mixed::tidy(cesd_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_unadj_old_results <- cesd_iyes_unadj_old_results %>% 
    bind_rows(., cesd_iyes_unadj_result)
  rm(cesd_iyes_unadj, cesd_iyes_unadj_result)
}

cesd_iyes_adj_old_results <- tibble()
for(i in c(1:17,19:23)){
  cesd_iyes_adj <- lmer(
    cesd_stand ~ internet_yes + cwave + 
      male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = old_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_adj_result <- broom.mixed::tidy(cesd_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_adj_old_results <- cesd_iyes_adj_old_results %>% 
    bind_rows(., cesd_iyes_adj_result)
  rm(cesd_iyes_adj, cesd_iyes_adj_result)
}

#### metafor ####
cesd_iyes_unadj_old_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_unadj_old_results, slab = country)

cesd_iyes_adj_old_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_old_results, slab = country)

```

#### Self-rated health

```{r}

#### lme4 ####
shlt_iyes_unadj_old_results <- tibble()
for(i in c(1:17,19:23)){
  shlt_iyes_unadj <- lmer(
    shlt_stand ~ internet_yes + cwave + (1 | id),
    data = old_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_unadj_result <- broom.mixed::tidy(shlt_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_unadj_old_results <- shlt_iyes_unadj_old_results %>% 
    bind_rows(., shlt_iyes_unadj_result)
  rm(shlt_iyes_unadj, shlt_iyes_unadj_result)
}

shlt_iyes_adj_old_results <- tibble()
for(i in c(1:17,19:23)){
  shlt_iyes_adj <- lmer(
    shlt_stand ~ internet_yes + cwave + 
      male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = old_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_adj_result <- broom.mixed::tidy(shlt_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_adj_old_results <- shlt_iyes_adj_old_results %>% 
    bind_rows(., shlt_iyes_adj_result)
  rm(shlt_iyes_adj, shlt_iyes_adj_result)
}


#### metafor ####
shlt_iyes_unadj_old_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_unadj_old_results, slab = country)

shlt_iyes_adj_old_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_old_results, slab = country)


```

#### Life satisfaction

```{r}

#### lme4 ####
satlife_iyes_unadj_old_results <- tibble()
for(i in c(1:17,19:23)){
  satlife_iyes_unadj <- lmer(
    satlife_stand ~ internet_yes + cwave + (1 | id),
    data = old_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_unadj_result <- broom.mixed::tidy(satlife_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_unadj_old_results <- satlife_iyes_unadj_old_results %>% 
    bind_rows(., satlife_iyes_unadj_result)
  rm(satlife_iyes_unadj, satlife_iyes_unadj_result)
}

satlife_iyes_adj_old_results <- tibble()
for(i in c(1:17,19:23)){
  satlife_iyes_adj <- lmer(
    satlife_stand ~ internet_yes + cwave + 
      male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = old_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_adj_result <- broom.mixed::tidy(satlife_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_adj_old_results <- satlife_iyes_adj_old_results %>% 
    bind_rows(., satlife_iyes_adj_result)
  rm(satlife_iyes_adj, satlife_iyes_adj_result)
}


#### metafor ####
satlife_iyes_unadj_old_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_unadj_old_results, slab = country)

satlife_iyes_adj_old_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_old_results, slab = country)

```

#### Test for interaction

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

outcomes <- c("cesd_stand", "shlt_stand", "satlife_stand")

p4interaction_age <- tibble()

for(i in 1:3){
  for(j in 1:23){
    formula_reduced <- as.formula(paste(outcomes[i], "~ internet_yes + cwave + old + male + lowedu + lowwealth + lbrf + nonmarried + hhres + smoken + weekdrink + phyinact + dis + adl_any + iadl + (1 | id)"))
    
    interact_reduced <- lmer(
      formula_reduced,
      data = subgroup_iyes_merge %>% filter(country_names == names[j]), 
      control = lmerControl(optimizer = "bobyqa")
      )
    
    formula <- as.formula(paste(outcomes[i], "~ internet_yes*old + cwave + male + lowedu + lowwealth + lbrf + nonmarried + hhres + smoken + weekdrink + phyinact + dis + adl_any + iadl + (1 | id)"))
    
    interact <- lmer(
      formula,
      data = subgroup_iyes_merge %>% filter(country_names == names[j]), 
      control = lmerControl(optimizer = "bobyqa")
      )
    
    interaction_re <- tibble(
      outcome = outcomes[i], country = names[j], 
      p4interaction = anova(interact_reduced, interact, refit = T)$`Pr(>Chisq)`[2]
    )
    
    p4interaction_age <- p4interaction_age %>% 
      bind_rows(., interaction_re)
    
    rm(formula_reduced, interact_reduced, formula, interact, interaction_re)
  }
}


```

## By gender

### Male

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

male_iyes_merge <- male_iyes_hrs %>% mutate(id = as.character(id)) %>%
  bind_rows(., male_iyes_elsa %>% mutate(id = as.character(id))) %>%
  bind_rows(., male_iyes_charls %>% mutate(id = as.character(id))) %>%
  bind_rows(., male_iyes_share) %>%
  bind_rows(., male_iyes_mhas) %>%
  bind_rows(., male_iyes_elsi %>% mutate(id = as.character(id))) %>%
  mutate(
    country_names = case_when(
      country == iso[1] ~ names[1],
      country == iso[2] ~ names[2],
      country == iso[3] ~ names[3],
      country == iso[4] ~ names[4],
      country == iso[5] ~ names[5],
      country == iso[6] ~ names[6],
      country == iso[7] ~ names[7],
      country == iso[8] ~ names[8],
      country == iso[9] ~ names[9],
      country == iso[10] ~ names[10],
      country == iso[11] ~ names[11],
      country == iso[12] ~ names[12],
      country == iso[13] ~ names[13],
      country == iso[14] ~ names[14],
      country == iso[15] ~ names[15],
      country == iso[16] ~ names[16],
      country == iso[17] ~ names[17],
      country == iso[18] ~ names[18],
      country == iso[19] ~ names[19],
      country == iso[20] ~ names[20],
      country == iso[21] ~ names[21],
      country == iso[22] ~ names[22],
      country == iso[23] ~ names[23]
    )
  )

```

#### CES-D

```{r}

#### lme4 ####
cesd_iyes_unadj_male_results <- tibble()
for(i in 1:23){
  cesd_iyes_unadj <- lmer(
    cesd_stand ~ internet_yes + cwave + (1 | id),
    data = male_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_unadj_result <- broom.mixed::tidy(cesd_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_unadj_male_results <- cesd_iyes_unadj_male_results %>% 
    bind_rows(., cesd_iyes_unadj_result)
  rm(cesd_iyes_unadj, cesd_iyes_unadj_result)
}

cesd_iyes_adj_male_results <- tibble()
for(i in 1:23){
  cesd_iyes_adj <- lmer(
    cesd_stand ~ internet_yes + cwave + 
      age + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = male_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_adj_result <- broom.mixed::tidy(cesd_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_adj_male_results <- cesd_iyes_adj_male_results %>% 
    bind_rows(., cesd_iyes_adj_result)
  rm(cesd_iyes_adj, cesd_iyes_adj_result)
}

#### metafor ####
cesd_iyes_unadj_male_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_unadj_male_results, slab = country)

cesd_iyes_adj_male_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_male_results, slab = country)

```

#### Self-rated health

```{r}

#### lme4 ####
shlt_iyes_unadj_male_results <- tibble()
for(i in 1:23){
  shlt_iyes_unadj <- lmer(
    shlt_stand ~ internet_yes + cwave + (1 | id),
    data = male_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_unadj_result <- broom.mixed::tidy(shlt_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_unadj_male_results <- shlt_iyes_unadj_male_results %>% 
    bind_rows(., shlt_iyes_unadj_result)
  rm(shlt_iyes_unadj, shlt_iyes_unadj_result)
}

shlt_iyes_adj_male_results <- tibble()
for(i in 1:23){
  shlt_iyes_adj <- lmer(
    shlt_stand ~ internet_yes + cwave + 
      age + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = male_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_adj_result <- broom.mixed::tidy(shlt_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_adj_male_results <- shlt_iyes_adj_male_results %>% 
    bind_rows(., shlt_iyes_adj_result)
  rm(shlt_iyes_adj, shlt_iyes_adj_result)
}


#### metafor ####
shlt_iyes_unadj_male_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_unadj_male_results, slab = country)

shlt_iyes_adj_male_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_male_results, slab = country)


```

#### Life satisfaction

```{r}

#### lme4 ####
satlife_iyes_unadj_male_results <- tibble()
for(i in 1:23){
  satlife_iyes_unadj <- lmer(
    satlife_stand ~ internet_yes + cwave + (1 | id),
    data = male_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_unadj_result <- broom.mixed::tidy(satlife_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_unadj_male_results <- satlife_iyes_unadj_male_results %>% 
    bind_rows(., satlife_iyes_unadj_result)
  rm(satlife_iyes_unadj, satlife_iyes_unadj_result)
}

satlife_iyes_adj_male_results <- tibble()
for(i in 1:23){
  satlife_iyes_adj <- lmer(
    satlife_stand ~ internet_yes + cwave + 
      age + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = male_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_adj_result <- broom.mixed::tidy(satlife_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_adj_male_results <- satlife_iyes_adj_male_results %>% 
    bind_rows(., satlife_iyes_adj_result)
  rm(satlife_iyes_adj, satlife_iyes_adj_result)
}


#### metafor ####
satlife_iyes_unadj_male_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_unadj_male_results, slab = country)

satlife_iyes_adj_male_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_male_results, slab = country)

```

### Female

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

female_iyes_merge <- female_iyes_hrs %>% mutate(id = as.character(id)) %>%
  bind_rows(., female_iyes_elsa %>% mutate(id = as.character(id))) %>%
  bind_rows(., female_iyes_charls %>% mutate(id = as.character(id))) %>%
  bind_rows(., female_iyes_share) %>%
  bind_rows(., female_iyes_mhas) %>%
  bind_rows(., female_iyes_elsi %>% mutate(id = as.character(id))) %>%
  mutate(
    country_names = case_when(
      country == iso[1] ~ names[1],
      country == iso[2] ~ names[2],
      country == iso[3] ~ names[3],
      country == iso[4] ~ names[4],
      country == iso[5] ~ names[5],
      country == iso[6] ~ names[6],
      country == iso[7] ~ names[7],
      country == iso[8] ~ names[8],
      country == iso[9] ~ names[9],
      country == iso[10] ~ names[10],
      country == iso[11] ~ names[11],
      country == iso[12] ~ names[12],
      country == iso[13] ~ names[13],
      country == iso[14] ~ names[14],
      country == iso[15] ~ names[15],
      country == iso[16] ~ names[16],
      country == iso[17] ~ names[17],
      country == iso[18] ~ names[18],
      country == iso[19] ~ names[19],
      country == iso[20] ~ names[20],
      country == iso[21] ~ names[21],
      country == iso[22] ~ names[22],
      country == iso[23] ~ names[23]
    )
  )

```

#### CES-D

```{r}

#### lme4 ####
cesd_iyes_unadj_female_results <- tibble()
for(i in 1:23){
  cesd_iyes_unadj <- lmer(
    cesd_stand ~ internet_yes + cwave + (1 | id),
    data = female_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_unadj_result <- broom.mixed::tidy(cesd_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_unadj_female_results <- cesd_iyes_unadj_female_results %>% 
    bind_rows(., cesd_iyes_unadj_result)
  rm(cesd_iyes_unadj, cesd_iyes_unadj_result)
}

cesd_iyes_adj_female_results <- tibble()
for(i in 1:23){
  cesd_iyes_adj <- lmer(
    cesd_stand ~ internet_yes + cwave + 
      age + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = female_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_adj_result <- broom.mixed::tidy(cesd_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_adj_female_results <- cesd_iyes_adj_female_results %>% 
    bind_rows(., cesd_iyes_adj_result)
  rm(cesd_iyes_adj, cesd_iyes_adj_result)
}

#### metafor ####
cesd_iyes_unadj_female_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_unadj_female_results, slab = country)

cesd_iyes_adj_female_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_female_results, slab = country)

```

#### Self-rated health

```{r}

#### lme4 ####
shlt_iyes_unadj_female_results <- tibble()
for(i in 1:23){
  shlt_iyes_unadj <- lmer(
    shlt_stand ~ internet_yes + cwave + (1 | id),
    data = female_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_unadj_result <- broom.mixed::tidy(shlt_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_unadj_female_results <- shlt_iyes_unadj_female_results %>% 
    bind_rows(., shlt_iyes_unadj_result)
  rm(shlt_iyes_unadj, shlt_iyes_unadj_result)
}

shlt_iyes_adj_female_results <- tibble()
for(i in 1:23){
  shlt_iyes_adj <- lmer(
    shlt_stand ~ internet_yes + cwave + 
      age + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = female_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_adj_result <- broom.mixed::tidy(shlt_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_adj_female_results <- shlt_iyes_adj_female_results %>% 
    bind_rows(., shlt_iyes_adj_result)
  rm(shlt_iyes_adj, shlt_iyes_adj_result)
}


#### metafor ####
shlt_iyes_unadj_female_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_unadj_female_results, slab = country)

shlt_iyes_adj_female_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_female_results, slab = country)

```

#### Life satisfaction

```{r}

#### lme4 ####
satlife_iyes_unadj_female_results <- tibble()
for(i in 1:23){
  satlife_iyes_unadj <- lmer(
    satlife_stand ~ internet_yes + cwave + (1 | id),
    data = female_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_unadj_result <- broom.mixed::tidy(satlife_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_unadj_female_results <- satlife_iyes_unadj_female_results %>% 
    bind_rows(., satlife_iyes_unadj_result)
  rm(satlife_iyes_unadj, satlife_iyes_unadj_result)
}

satlife_iyes_adj_female_results <- tibble()
for(i in 1:23){
  satlife_iyes_adj <- lmer(
    satlife_stand ~ internet_yes + cwave + 
      age + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = female_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_adj_result <- broom.mixed::tidy(satlife_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_adj_female_results <- satlife_iyes_adj_female_results %>% 
    bind_rows(., satlife_iyes_adj_result)
  rm(satlife_iyes_adj, satlife_iyes_adj_result)
}


#### metafor ####
satlife_iyes_unadj_female_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_unadj_female_results, slab = country)

satlife_iyes_adj_female_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_female_results, slab = country)

```

#### Test for interaction

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

outcomes <- c("cesd_stand", "shlt_stand", "satlife_stand")

p4interaction_male <- tibble()

for(i in 1:3){
  for(j in 1:23){
    formula_reduced <- as.formula(paste(outcomes[i], "~ internet_yes + cwave + age + male + lowedu + lowwealth + lbrf + nonmarried + hhres + smoken + weekdrink + phyinact + dis + adl_any + iadl + (1 | id)"))
    
    interact_reduced <- lmer(
      formula_reduced,
      data = subgroup_iyes_merge %>% filter(country_names == names[j]), 
      control = lmerControl(optimizer = "bobyqa")
      )
    
    formula <- as.formula(paste(outcomes[i], "~ internet_yes*male + cwave + age + lowedu + lowwealth + lbrf + nonmarried + hhres + smoken + weekdrink + phyinact + dis + adl_any + iadl + (1 | id)"))
    
    interact <- lmer(
      formula,
      data = subgroup_iyes_merge %>% filter(country_names == names[j]), 
      control = lmerControl(optimizer = "bobyqa")
      )
    
    interaction_re <- tibble(
      outcome = outcomes[i], country = names[j], 
      p4interaction = anova(interact_reduced, interact, refit = T)$`Pr(>Chisq)`[2]
    )
    
    p4interaction_male <- p4interaction_male %>% 
      bind_rows(., interaction_re)
    
    rm(formula_reduced, interact_reduced, formula, interact, interaction_re)
  }
}


```

## By marital status

### Married

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

married_iyes_merge <- married_iyes_hrs %>% mutate(id = as.character(id)) %>%
  bind_rows(., married_iyes_elsa %>% mutate(id = as.character(id))) %>%
  bind_rows(., married_iyes_charls %>% mutate(id = as.character(id))) %>%
  bind_rows(., married_iyes_share) %>%
  bind_rows(., married_iyes_mhas) %>%
  bind_rows(., married_iyes_elsi %>% mutate(id = as.character(id))) %>%
  mutate(
    country_names = case_when(
      country == iso[1] ~ names[1],
      country == iso[2] ~ names[2],
      country == iso[3] ~ names[3],
      country == iso[4] ~ names[4],
      country == iso[5] ~ names[5],
      country == iso[6] ~ names[6],
      country == iso[7] ~ names[7],
      country == iso[8] ~ names[8],
      country == iso[9] ~ names[9],
      country == iso[10] ~ names[10],
      country == iso[11] ~ names[11],
      country == iso[12] ~ names[12],
      country == iso[13] ~ names[13],
      country == iso[14] ~ names[14],
      country == iso[15] ~ names[15],
      country == iso[16] ~ names[16],
      country == iso[17] ~ names[17],
      country == iso[18] ~ names[18],
      country == iso[19] ~ names[19],
      country == iso[20] ~ names[20],
      country == iso[21] ~ names[21],
      country == iso[22] ~ names[22],
      country == iso[23] ~ names[23]
    )
  )

```

#### CES-D

```{r}

#### lme4 ####
cesd_iyes_unadj_married_results <- tibble()
for(i in 1:23){
  cesd_iyes_unadj <- lmer(
    cesd_stand ~ internet_yes + cwave + (1 | id),
    data = married_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_unadj_result <- broom.mixed::tidy(cesd_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_unadj_married_results <- cesd_iyes_unadj_married_results %>% 
    bind_rows(., cesd_iyes_unadj_result)
  rm(cesd_iyes_unadj, cesd_iyes_unadj_result)
}

cesd_iyes_adj_married_results <- tibble()
for(i in 1:23){
  cesd_iyes_adj <- lmer(
    cesd_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = married_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_adj_result <- broom.mixed::tidy(cesd_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_adj_married_results <- cesd_iyes_adj_married_results %>% 
    bind_rows(., cesd_iyes_adj_result)
  rm(cesd_iyes_adj, cesd_iyes_adj_result)
}

#### metafor ####
cesd_iyes_unadj_married_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_unadj_married_results, slab = country)

cesd_iyes_adj_married_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_married_results, slab = country)

```

#### Self-rated health

```{r}

#### lme4 ####
shlt_iyes_unadj_married_results <- tibble()
for(i in 1:23){
  shlt_iyes_unadj <- lmer(
    shlt_stand ~ internet_yes + cwave + (1 | id),
    data = married_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_unadj_result <- broom.mixed::tidy(shlt_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_unadj_married_results <- shlt_iyes_unadj_married_results %>% 
    bind_rows(., shlt_iyes_unadj_result)
  rm(shlt_iyes_unadj, shlt_iyes_unadj_result)
}

shlt_iyes_adj_married_results <- tibble()
for(i in 1:23){
  shlt_iyes_adj <- lmer(
    shlt_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = married_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_adj_result <- broom.mixed::tidy(shlt_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_adj_married_results <- shlt_iyes_adj_married_results %>% 
    bind_rows(., shlt_iyes_adj_result)
  rm(shlt_iyes_adj, shlt_iyes_adj_result)
}


#### metafor ####
shlt_iyes_unadj_married_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_unadj_married_results, slab = country)

shlt_iyes_adj_married_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_married_results, slab = country)

```

#### Life satisfaction

```{r}

#### lme4 ####
satlife_iyes_unadj_married_results <- tibble()
for(i in 1:23){
  satlife_iyes_unadj <- lmer(
    satlife_stand ~ internet_yes + cwave + (1 | id),
    data = married_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_unadj_result <- broom.mixed::tidy(satlife_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_unadj_married_results <- satlife_iyes_unadj_married_results %>% 
    bind_rows(., satlife_iyes_unadj_result)
  rm(satlife_iyes_unadj, satlife_iyes_unadj_result)
}

satlife_iyes_adj_married_results <- tibble()
for(i in 1:23){
  satlife_iyes_adj <- lmer(
    satlife_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = married_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_adj_result <- broom.mixed::tidy(satlife_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_adj_married_results <- satlife_iyes_adj_married_results %>% 
    bind_rows(., satlife_iyes_adj_result)
  rm(satlife_iyes_adj, satlife_iyes_adj_result)
}


#### metafor ####
satlife_iyes_unadj_married_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_unadj_married_results, slab = country)

satlife_iyes_adj_married_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_married_results, slab = country)

```

### Nonmarried

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

nonmarried_iyes_merge <- nonmarried_iyes_hrs %>% mutate(id = as.character(id)) %>%
  bind_rows(., nonmarried_iyes_elsa %>% mutate(id = as.character(id))) %>%
  bind_rows(., nonmarried_iyes_charls %>% mutate(id = as.character(id))) %>%
  bind_rows(., nonmarried_iyes_share) %>%
  bind_rows(., nonmarried_iyes_mhas) %>%
  bind_rows(., nonmarried_iyes_elsi %>% mutate(id = as.character(id))) %>%
  mutate(
    country_names = case_when(
      country == iso[1] ~ names[1],
      country == iso[2] ~ names[2],
      country == iso[3] ~ names[3],
      country == iso[4] ~ names[4],
      country == iso[5] ~ names[5],
      country == iso[6] ~ names[6],
      country == iso[7] ~ names[7],
      country == iso[8] ~ names[8],
      country == iso[9] ~ names[9],
      country == iso[10] ~ names[10],
      country == iso[11] ~ names[11],
      country == iso[12] ~ names[12],
      country == iso[13] ~ names[13],
      country == iso[14] ~ names[14],
      country == iso[15] ~ names[15],
      country == iso[16] ~ names[16],
      country == iso[17] ~ names[17],
      country == iso[18] ~ names[18],
      country == iso[19] ~ names[19],
      country == iso[20] ~ names[20],
      country == iso[21] ~ names[21],
      country == iso[22] ~ names[22],
      country == iso[23] ~ names[23]
    )
  )

```

#### CES-D

```{r}

#### lme4 ####
cesd_iyes_unadj_nonmarried_results <- tibble()
for(i in 1:23){
  cesd_iyes_unadj <- lmer(
    cesd_stand ~ internet_yes + cwave + (1 | id),
    data = nonmarried_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_unadj_result <- broom.mixed::tidy(cesd_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_unadj_nonmarried_results <- cesd_iyes_unadj_nonmarried_results %>% 
    bind_rows(., cesd_iyes_unadj_result)
  rm(cesd_iyes_unadj, cesd_iyes_unadj_result)
}

cesd_iyes_adj_nonmarried_results <- tibble()
for(i in 1:23){
  cesd_iyes_adj <- lmer(
    cesd_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = nonmarried_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_adj_result <- broom.mixed::tidy(cesd_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_adj_nonmarried_results <- cesd_iyes_adj_nonmarried_results %>% 
    bind_rows(., cesd_iyes_adj_result)
  rm(cesd_iyes_adj, cesd_iyes_adj_result)
}

#### metafor ####
cesd_iyes_unadj_nonmarried_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_unadj_nonmarried_results, slab = country)

cesd_iyes_adj_nonmarried_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_nonmarried_results, slab = country)

```

#### Self-rated health

```{r}

#### lme4 ####
shlt_iyes_unadj_nonmarried_results <- tibble()
for(i in 1:23){
  shlt_iyes_unadj <- lmer(
    shlt_stand ~ internet_yes + cwave + (1 | id),
    data = nonmarried_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_unadj_result <- broom.mixed::tidy(shlt_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_unadj_nonmarried_results <- shlt_iyes_unadj_nonmarried_results %>% 
    bind_rows(., shlt_iyes_unadj_result)
  rm(shlt_iyes_unadj, shlt_iyes_unadj_result)
}

shlt_iyes_adj_nonmarried_results <- tibble()
for(i in 1:23){
  shlt_iyes_adj <- lmer(
    shlt_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = nonmarried_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_adj_result <- broom.mixed::tidy(shlt_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_adj_nonmarried_results <- shlt_iyes_adj_nonmarried_results %>% 
    bind_rows(., shlt_iyes_adj_result)
  rm(shlt_iyes_adj, shlt_iyes_adj_result)
}


#### metafor ####
shlt_iyes_unadj_nonmarried_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_unadj_nonmarried_results, slab = country)

shlt_iyes_adj_nonmarried_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_nonmarried_results, slab = country)

```

#### Life satisfaction

```{r}

#### lme4 ####
satlife_iyes_unadj_nonmarried_results <- tibble()
for(i in 1:23){
  satlife_iyes_unadj <- lmer(
    satlife_stand ~ internet_yes + cwave + (1 | id),
    data = nonmarried_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_unadj_result <- broom.mixed::tidy(satlife_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_unadj_nonmarried_results <- satlife_iyes_unadj_nonmarried_results %>% 
    bind_rows(., satlife_iyes_unadj_result)
  rm(satlife_iyes_unadj, satlife_iyes_unadj_result)
}

satlife_iyes_adj_nonmarried_results <- tibble()
for(i in 1:23){
  satlife_iyes_adj <- lmer(
    satlife_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = nonmarried_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_adj_result <- broom.mixed::tidy(satlife_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_adj_nonmarried_results <- satlife_iyes_adj_nonmarried_results %>% 
    bind_rows(., satlife_iyes_adj_result)
  rm(satlife_iyes_adj, satlife_iyes_adj_result)
}


#### metafor ####
satlife_iyes_unadj_nonmarried_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_unadj_nonmarried_results, slab = country)

satlife_iyes_adj_nonmarried_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_nonmarried_results, slab = country)

```

#### Test for interaction

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

outcomes <- c("cesd_stand", "shlt_stand", "satlife_stand")

p4interaction_nonmarried <- tibble()

for(i in 1:3){
  for(j in 1:23){
    formula_reduced <- as.formula(paste(outcomes[i], "~ internet_yes + cwave + age + male + lowedu + lowwealth + lbrf + nonmarried + hhres + smoken + weekdrink + phyinact + dis + adl_any + iadl + (1 | id)"))
    
    interact_reduced <- lmer(
      formula_reduced,
      data = subgroup_iyes_merge %>% filter(country_names == names[j]), 
      control = lmerControl(optimizer = "bobyqa")
      )
    
    formula <- as.formula(paste(outcomes[i], "~ internet_yes*nonmarried + cwave + age + male + lowedu + lowwealth + lbrf + hhres + smoken + weekdrink + phyinact + dis + adl_any + iadl + (1 | id)"))
    
    interact <- lmer(
      formula,
      data = subgroup_iyes_merge %>% filter(country_names == names[j]), 
      control = lmerControl(optimizer = "bobyqa")
      )
    
    interaction_re <- tibble(
      outcome = outcomes[i], country = names[j], 
      p4interaction = anova(interact_reduced, interact, refit = T)$`Pr(>Chisq)`[2]
    )
    
    p4interaction_nonmarried <- p4interaction_nonmarried %>% 
      bind_rows(., interaction_re)
    
    rm(formula_reduced, interact_reduced, formula, interact, interaction_re)
  }
}


```

## By education

### Primary

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

pedu_iyes_merge <- pedu_iyes_hrs %>% mutate(id = as.character(id)) %>%
  bind_rows(., pedu_iyes_elsa %>% mutate(id = as.character(id))) %>%
  bind_rows(., pedu_iyes_charls %>% mutate(id = as.character(id))) %>%
  bind_rows(., pedu_iyes_share) %>%
  bind_rows(., pedu_iyes_mhas) %>%
  bind_rows(., pedu_iyes_elsi %>% mutate(id = as.character(id))) %>%
  mutate(
    country_names = case_when(
      country == iso[1] ~ names[1],
      country == iso[2] ~ names[2],
      country == iso[3] ~ names[3],
      country == iso[4] ~ names[4],
      country == iso[5] ~ names[5],
      country == iso[6] ~ names[6],
      country == iso[7] ~ names[7],
      country == iso[8] ~ names[8],
      country == iso[9] ~ names[9],
      country == iso[10] ~ names[10],
      country == iso[11] ~ names[11],
      country == iso[12] ~ names[12],
      country == iso[13] ~ names[13],
      country == iso[14] ~ names[14],
      country == iso[15] ~ names[15],
      country == iso[16] ~ names[16],
      country == iso[17] ~ names[17],
      country == iso[18] ~ names[18],
      country == iso[19] ~ names[19],
      country == iso[20] ~ names[20],
      country == iso[21] ~ names[21],
      country == iso[22] ~ names[22],
      country == iso[23] ~ names[23]
    )
  )

```

#### CES-D

```{r}

#### lme4 ####
cesd_iyes_unadj_pedu_results <- tibble()
for(i in 1:23){
  cesd_iyes_unadj <- lmer(
    cesd_stand ~ internet_yes + cwave + (1 | id),
    data = pedu_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_unadj_result <- broom.mixed::tidy(cesd_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_unadj_pedu_results <- cesd_iyes_unadj_pedu_results %>% 
    bind_rows(., cesd_iyes_unadj_result)
  rm(cesd_iyes_unadj, cesd_iyes_unadj_result)
}

cesd_iyes_adj_pedu_results <- tibble()
for(i in 1:23){
  cesd_iyes_adj <- lmer(
    cesd_stand ~ internet_yes + cwave + 
      age + male + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = pedu_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_adj_result <- broom.mixed::tidy(cesd_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_adj_pedu_results <- cesd_iyes_adj_pedu_results %>% 
    bind_rows(., cesd_iyes_adj_result)
  rm(cesd_iyes_adj, cesd_iyes_adj_result)
}

#### metafor ####
cesd_iyes_unadj_pedu_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_unadj_pedu_results, slab = country)

cesd_iyes_adj_pedu_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_pedu_results, slab = country)

```

#### Self-rated health

```{r}

#### lme4 ####
shlt_iyes_unadj_pedu_results <- tibble()
for(i in 1:23){
  shlt_iyes_unadj <- lmer(
    shlt_stand ~ internet_yes + cwave + (1 | id),
    data = pedu_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_unadj_result <- broom.mixed::tidy(shlt_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_unadj_pedu_results <- shlt_iyes_unadj_pedu_results %>% 
    bind_rows(., shlt_iyes_unadj_result)
  rm(shlt_iyes_unadj, shlt_iyes_unadj_result)
}

shlt_iyes_adj_pedu_results <- tibble()
for(i in 1:23){
  shlt_iyes_adj <- lmer(
    shlt_stand ~ internet_yes + cwave + 
      age + male + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = pedu_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_adj_result <- broom.mixed::tidy(shlt_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_adj_pedu_results <- shlt_iyes_adj_pedu_results %>% 
    bind_rows(., shlt_iyes_adj_result)
  rm(shlt_iyes_adj, shlt_iyes_adj_result)
}


#### metafor ####
shlt_iyes_unadj_pedu_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_unadj_pedu_results, slab = country)

shlt_iyes_adj_pedu_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_pedu_results, slab = country)

```

#### Life satisfaction

```{r}

#### lme4 ####
satlife_iyes_unadj_pedu_results <- tibble()
for(i in 1:23){
  satlife_iyes_unadj <- lmer(
    satlife_stand ~ internet_yes + cwave + (1 | id),
    data = pedu_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_unadj_result <- broom.mixed::tidy(satlife_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_unadj_pedu_results <- satlife_iyes_unadj_pedu_results %>% 
    bind_rows(., satlife_iyes_unadj_result)
  rm(satlife_iyes_unadj, satlife_iyes_unadj_result)
}

satlife_iyes_adj_pedu_results <- tibble()
for(i in 1:23){
  satlife_iyes_adj <- lmer(
    satlife_stand ~ internet_yes + cwave + 
      age + male + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = pedu_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_adj_result <- broom.mixed::tidy(satlife_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_adj_pedu_results <- satlife_iyes_adj_pedu_results %>% 
    bind_rows(., satlife_iyes_adj_result)
  rm(satlife_iyes_adj, satlife_iyes_adj_result)
}


#### metafor ####
satlife_iyes_unadj_pedu_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_unadj_pedu_results, slab = country)

satlife_iyes_adj_pedu_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_pedu_results, slab = country)

```

### Secondary

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

sedu_iyes_merge <- sedu_iyes_hrs %>% mutate(id = as.character(id)) %>%
  bind_rows(., sedu_iyes_elsa %>% mutate(id = as.character(id))) %>%
  bind_rows(., sedu_iyes_charls %>% mutate(id = as.character(id))) %>%
  bind_rows(., sedu_iyes_share) %>%
  bind_rows(., sedu_iyes_mhas) %>%
  bind_rows(., sedu_iyes_elsi %>% mutate(id = as.character(id))) %>%
  mutate(
    country_names = case_when(
      country == iso[1] ~ names[1],
      country == iso[2] ~ names[2],
      country == iso[3] ~ names[3],
      country == iso[4] ~ names[4],
      country == iso[5] ~ names[5],
      country == iso[6] ~ names[6],
      country == iso[7] ~ names[7],
      country == iso[8] ~ names[8],
      country == iso[9] ~ names[9],
      country == iso[10] ~ names[10],
      country == iso[11] ~ names[11],
      country == iso[12] ~ names[12],
      country == iso[13] ~ names[13],
      country == iso[14] ~ names[14],
      country == iso[15] ~ names[15],
      country == iso[16] ~ names[16],
      country == iso[17] ~ names[17],
      country == iso[18] ~ names[18],
      country == iso[19] ~ names[19],
      country == iso[20] ~ names[20],
      country == iso[21] ~ names[21],
      country == iso[22] ~ names[22],
      country == iso[23] ~ names[23]
    )
  )

```

#### CES-D

```{r}

#### lme4 ####
cesd_iyes_unadj_sedu_results <- tibble()
for(i in 1:23){
  cesd_iyes_unadj <- lmer(
    cesd_stand ~ internet_yes + cwave + (1 | id),
    data = sedu_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_unadj_result <- broom.mixed::tidy(cesd_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_unadj_sedu_results <- cesd_iyes_unadj_sedu_results %>% 
    bind_rows(., cesd_iyes_unadj_result)
  rm(cesd_iyes_unadj, cesd_iyes_unadj_result)
}

cesd_iyes_adj_sedu_results <- tibble()
for(i in 1:23){
  cesd_iyes_adj <- lmer(
    cesd_stand ~ internet_yes + cwave + 
      age + male + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = sedu_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_adj_result <- broom.mixed::tidy(cesd_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_adj_sedu_results <- cesd_iyes_adj_sedu_results %>% 
    bind_rows(., cesd_iyes_adj_result)
  rm(cesd_iyes_adj, cesd_iyes_adj_result)
}

#### metafor ####
cesd_iyes_unadj_sedu_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_unadj_sedu_results, slab = country)

cesd_iyes_adj_sedu_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_sedu_results, slab = country)

```

#### Self-rated health

```{r}

#### lme4 ####
shlt_iyes_unadj_sedu_results <- tibble()
for(i in 1:23){
  shlt_iyes_unadj <- lmer(
    shlt_stand ~ internet_yes + cwave + (1 | id),
    data = sedu_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_unadj_result <- broom.mixed::tidy(shlt_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_unadj_sedu_results <- shlt_iyes_unadj_sedu_results %>% 
    bind_rows(., shlt_iyes_unadj_result)
  rm(shlt_iyes_unadj, shlt_iyes_unadj_result)
}

shlt_iyes_adj_sedu_results <- tibble()
for(i in 1:23){
  shlt_iyes_adj <- lmer(
    shlt_stand ~ internet_yes + cwave + 
      age + male + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = sedu_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_adj_result <- broom.mixed::tidy(shlt_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_adj_sedu_results <- shlt_iyes_adj_sedu_results %>% 
    bind_rows(., shlt_iyes_adj_result)
  rm(shlt_iyes_adj, shlt_iyes_adj_result)
}


#### metafor ####
shlt_iyes_unadj_sedu_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_unadj_sedu_results, slab = country)

shlt_iyes_adj_sedu_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_sedu_results, slab = country)

```

#### Life satisfaction

```{r}

#### lme4 ####
satlife_iyes_unadj_sedu_results <- tibble()
for(i in 1:23){
  satlife_iyes_unadj <- lmer(
    satlife_stand ~ internet_yes + cwave + (1 | id),
    data = sedu_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_unadj_result <- broom.mixed::tidy(satlife_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_unadj_sedu_results <- satlife_iyes_unadj_sedu_results %>% 
    bind_rows(., satlife_iyes_unadj_result)
  rm(satlife_iyes_unadj, satlife_iyes_unadj_result)
}

satlife_iyes_adj_sedu_results <- tibble()
for(i in 1:23){
  satlife_iyes_adj <- lmer(
    satlife_stand ~ internet_yes + cwave + 
      age + male + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = sedu_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_adj_result <- broom.mixed::tidy(satlife_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_adj_sedu_results <- satlife_iyes_adj_sedu_results %>% 
    bind_rows(., satlife_iyes_adj_result)
  rm(satlife_iyes_adj, satlife_iyes_adj_result)
}


#### metafor ####
satlife_iyes_unadj_sedu_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_unadj_sedu_results, slab = country)

satlife_iyes_adj_sedu_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_sedu_results, slab = country)

```


### Tertiary

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

tedu_iyes_merge <- tedu_iyes_hrs %>% mutate(id = as.character(id)) %>%
  bind_rows(., tedu_iyes_elsa %>% mutate(id = as.character(id))) %>%
  bind_rows(., tedu_iyes_charls %>% mutate(id = as.character(id))) %>%
  bind_rows(., tedu_iyes_share) %>%
  bind_rows(., tedu_iyes_mhas) %>%
  bind_rows(., tedu_iyes_elsi %>% mutate(id = as.character(id))) %>%
  mutate(
    country_names = case_when(
      country == iso[1] ~ names[1],
      country == iso[2] ~ names[2],
      country == iso[3] ~ names[3],
      country == iso[4] ~ names[4],
      country == iso[5] ~ names[5],
      country == iso[6] ~ names[6],
      country == iso[7] ~ names[7],
      country == iso[8] ~ names[8],
      country == iso[9] ~ names[9],
      country == iso[10] ~ names[10],
      country == iso[11] ~ names[11],
      country == iso[12] ~ names[12],
      country == iso[13] ~ names[13],
      country == iso[14] ~ names[14],
      country == iso[15] ~ names[15],
      country == iso[16] ~ names[16],
      country == iso[17] ~ names[17],
      country == iso[18] ~ names[18],
      country == iso[19] ~ names[19],
      country == iso[20] ~ names[20],
      country == iso[21] ~ names[21],
      country == iso[22] ~ names[22],
      country == iso[23] ~ names[23]
    )
  )

nrow(tedu_iyes_merge[tedu_iyes_merge$country_names == "Poland",]) # 43

```

#### CES-D

```{r}

#### lme4 ####
cesd_iyes_unadj_tedu_results <- tibble()
for(i in c(1:17,19:23)){
  cesd_iyes_unadj <- lmer(
    cesd_stand ~ internet_yes + cwave + (1 | id),
    data = tedu_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_unadj_result <- broom.mixed::tidy(cesd_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_unadj_tedu_results <- cesd_iyes_unadj_tedu_results %>% 
    bind_rows(., cesd_iyes_unadj_result)
  rm(cesd_iyes_unadj, cesd_iyes_unadj_result)
}

cesd_iyes_adj_tedu_results <- tibble()
for(i in c(1:17,19:23)){
  cesd_iyes_adj <- lmer(
    cesd_stand ~ internet_yes + cwave + 
      age + male + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = tedu_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_adj_result <- broom.mixed::tidy(cesd_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_adj_tedu_results <- cesd_iyes_adj_tedu_results %>% 
    bind_rows(., cesd_iyes_adj_result)
  rm(cesd_iyes_adj, cesd_iyes_adj_result)
}

#### metafor ####
cesd_iyes_unadj_tedu_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_unadj_tedu_results, slab = country)

cesd_iyes_adj_tedu_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_tedu_results, slab = country)

```

#### Self-rated health

```{r}

#### lme4 ####
shlt_iyes_unadj_tedu_results <- tibble()
for(i in c(1:17,19:23)){
  shlt_iyes_unadj <- lmer(
    shlt_stand ~ internet_yes + cwave + (1 | id),
    data = tedu_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_unadj_result <- broom.mixed::tidy(shlt_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_unadj_tedu_results <- shlt_iyes_unadj_tedu_results %>% 
    bind_rows(., shlt_iyes_unadj_result)
  rm(shlt_iyes_unadj, shlt_iyes_unadj_result)
}

shlt_iyes_adj_tedu_results <- tibble()
for(i in c(1:17,19:23)){
  shlt_iyes_adj <- lmer(
    shlt_stand ~ internet_yes + cwave + 
      age + male + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = tedu_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_adj_result <- broom.mixed::tidy(shlt_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_adj_tedu_results <- shlt_iyes_adj_tedu_results %>% 
    bind_rows(., shlt_iyes_adj_result)
  rm(shlt_iyes_adj, shlt_iyes_adj_result)
}


#### metafor ####
shlt_iyes_unadj_tedu_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_unadj_tedu_results, slab = country)

shlt_iyes_adj_tedu_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_tedu_results, slab = country)

```

#### Life satisfaction

```{r}

#### lme4 ####
satlife_iyes_unadj_tedu_results <- tibble()
for(i in c(1:17,19:23)){
  satlife_iyes_unadj <- lmer(
    satlife_stand ~ internet_yes + cwave + (1 | id),
    data = tedu_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_unadj_result <- broom.mixed::tidy(satlife_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_unadj_tedu_results <- satlife_iyes_unadj_tedu_results %>% 
    bind_rows(., satlife_iyes_unadj_result)
  rm(satlife_iyes_unadj, satlife_iyes_unadj_result)
}

satlife_iyes_adj_tedu_results <- tibble()
for(i in c(1:17,19:23)){
  satlife_iyes_adj <- lmer(
    satlife_stand ~ internet_yes + cwave + 
      age + male + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = tedu_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_adj_result <- broom.mixed::tidy(satlife_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_adj_tedu_results <- satlife_iyes_adj_tedu_results %>% 
    bind_rows(., satlife_iyes_adj_result)
  rm(satlife_iyes_adj, satlife_iyes_adj_result)
}


#### metafor ####
satlife_iyes_unadj_tedu_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_unadj_tedu_results, slab = country)

satlife_iyes_adj_tedu_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_tedu_results, slab = country)

```

#### Test for interaction

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

outcomes <- c("cesd_stand", "shlt_stand", "satlife_stand")

p4interaction_edu <- tibble()

for(i in 1:3){
  for(j in 1:23){
    formula_reduced <- as.formula(paste(outcomes[i], "~ internet_yes + cwave + age + male + lowedu + lowwealth + lbrf + nonmarried + hhres + smoken + weekdrink + phyinact + dis + adl_any + iadl + (1 | id)"))
    
    interact_reduced <- lmer(
      formula_reduced,
      data = subgroup_iyes_merge %>% filter(country_names == names[j]), 
      control = lmerControl(optimizer = "bobyqa")
      )
    
    formula <- as.formula(paste(outcomes[i], "~ internet_yes*lowedu + cwave + age + male + lowwealth + lbrf + nonmarried + hhres + smoken + weekdrink + phyinact + dis + adl_any + iadl + (1 | id)"))
    
    interact <- lmer(
      formula,
      data = subgroup_iyes_merge %>% filter(country_names == names[j]), 
      control = lmerControl(optimizer = "bobyqa")
      )
    
    interaction_re <- tibble(
      outcome = outcomes[i], country = names[j], 
      p4interaction = anova(interact_reduced, interact, refit = T)$`Pr(>Chisq)`[2]
    )
    
    p4interaction_edu <- p4interaction_edu %>% 
      bind_rows(., interaction_re)
    
    rm(formula_reduced, interact_reduced, formula, interact, interaction_re)
  }
}


```

## By household wealth

### Low

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

lwealth_iyes_merge <- lwealth_iyes_hrs %>% mutate(id = as.character(id)) %>%
  bind_rows(., lwealth_iyes_elsa %>% mutate(id = as.character(id))) %>%
  bind_rows(., lwealth_iyes_charls %>% mutate(id = as.character(id))) %>%
  bind_rows(., lwealth_iyes_share) %>%
  bind_rows(., lwealth_iyes_mhas) %>%
  bind_rows(., lwealth_iyes_elsi %>% mutate(id = as.character(id))) %>%
  mutate(
    country_names = case_when(
      country == iso[1] ~ names[1],
      country == iso[2] ~ names[2],
      country == iso[3] ~ names[3],
      country == iso[4] ~ names[4],
      country == iso[5] ~ names[5],
      country == iso[6] ~ names[6],
      country == iso[7] ~ names[7],
      country == iso[8] ~ names[8],
      country == iso[9] ~ names[9],
      country == iso[10] ~ names[10],
      country == iso[11] ~ names[11],
      country == iso[12] ~ names[12],
      country == iso[13] ~ names[13],
      country == iso[14] ~ names[14],
      country == iso[15] ~ names[15],
      country == iso[16] ~ names[16],
      country == iso[17] ~ names[17],
      country == iso[18] ~ names[18],
      country == iso[19] ~ names[19],
      country == iso[20] ~ names[20],
      country == iso[21] ~ names[21],
      country == iso[22] ~ names[22],
      country == iso[23] ~ names[23]
    )
  )

```

#### CES-D

```{r}

#### lme4 ####
cesd_iyes_unadj_lwealth_results <- tibble()
for(i in 1:23){
  cesd_iyes_unadj <- lmer(
    cesd_stand ~ internet_yes + cwave + (1 | id),
    data = lwealth_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_unadj_result <- broom.mixed::tidy(cesd_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_unadj_lwealth_results <- cesd_iyes_unadj_lwealth_results %>% 
    bind_rows(., cesd_iyes_unadj_result)
  rm(cesd_iyes_unadj, cesd_iyes_unadj_result)
}

cesd_iyes_adj_lwealth_results <- tibble()
for(i in 1:23){
  cesd_iyes_adj <- lmer(
    cesd_stand ~ internet_yes + cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = lwealth_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_adj_result <- broom.mixed::tidy(cesd_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_adj_lwealth_results <- cesd_iyes_adj_lwealth_results %>% 
    bind_rows(., cesd_iyes_adj_result)
  rm(cesd_iyes_adj, cesd_iyes_adj_result)
}

#### metafor ####
cesd_iyes_unadj_lwealth_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_unadj_lwealth_results, slab = country)

cesd_iyes_adj_lwealth_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_lwealth_results, slab = country)

```

#### Self-rated health

```{r}

#### lme4 ####
shlt_iyes_unadj_lwealth_results <- tibble()
for(i in 1:23){
  shlt_iyes_unadj <- lmer(
    shlt_stand ~ internet_yes + cwave + (1 | id),
    data = lwealth_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_unadj_result <- broom.mixed::tidy(shlt_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_unadj_lwealth_results <- shlt_iyes_unadj_lwealth_results %>% 
    bind_rows(., shlt_iyes_unadj_result)
  rm(shlt_iyes_unadj, shlt_iyes_unadj_result)
}

shlt_iyes_adj_lwealth_results <- tibble()
for(i in 1:23){
  shlt_iyes_adj <- lmer(
    shlt_stand ~ internet_yes + cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = lwealth_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_adj_result <- broom.mixed::tidy(shlt_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_adj_lwealth_results <- shlt_iyes_adj_lwealth_results %>% 
    bind_rows(., shlt_iyes_adj_result)
  rm(shlt_iyes_adj, shlt_iyes_adj_result)
}


#### metafor ####
shlt_iyes_unadj_lwealth_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_unadj_lwealth_results, slab = country)

shlt_iyes_adj_lwealth_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_lwealth_results, slab = country)

```

#### Life satisfaction

```{r}

#### lme4 ####
satlife_iyes_unadj_lwealth_results <- tibble()
for(i in 1:23){
  satlife_iyes_unadj <- lmer(
    satlife_stand ~ internet_yes + cwave + (1 | id),
    data = lwealth_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_unadj_result <- broom.mixed::tidy(satlife_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_unadj_lwealth_results <- satlife_iyes_unadj_lwealth_results %>% 
    bind_rows(., satlife_iyes_unadj_result)
  rm(satlife_iyes_unadj, satlife_iyes_unadj_result)
}

satlife_iyes_adj_lwealth_results <- tibble()
for(i in 1:23){
  satlife_iyes_adj <- lmer(
    satlife_stand ~ internet_yes + cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = lwealth_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_adj_result <- broom.mixed::tidy(satlife_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_adj_lwealth_results <- satlife_iyes_adj_lwealth_results %>% 
    bind_rows(., satlife_iyes_adj_result)
  rm(satlife_iyes_adj, satlife_iyes_adj_result)
}


#### metafor ####
satlife_iyes_unadj_lwealth_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_unadj_lwealth_results, slab = country)

satlife_iyes_adj_lwealth_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_lwealth_results, slab = country)

```

### Middle

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

mwealth_iyes_merge <- mwealth_iyes_hrs %>% mutate(id = as.character(id)) %>%
  bind_rows(., mwealth_iyes_elsa %>% mutate(id = as.character(id))) %>%
  bind_rows(., mwealth_iyes_charls %>% mutate(id = as.character(id))) %>%
  bind_rows(., mwealth_iyes_share) %>%
  bind_rows(., mwealth_iyes_mhas) %>%
  bind_rows(., mwealth_iyes_elsi %>% mutate(id = as.character(id))) %>%
  mutate(
    country_names = case_when(
      country == iso[1] ~ names[1],
      country == iso[2] ~ names[2],
      country == iso[3] ~ names[3],
      country == iso[4] ~ names[4],
      country == iso[5] ~ names[5],
      country == iso[6] ~ names[6],
      country == iso[7] ~ names[7],
      country == iso[8] ~ names[8],
      country == iso[9] ~ names[9],
      country == iso[10] ~ names[10],
      country == iso[11] ~ names[11],
      country == iso[12] ~ names[12],
      country == iso[13] ~ names[13],
      country == iso[14] ~ names[14],
      country == iso[15] ~ names[15],
      country == iso[16] ~ names[16],
      country == iso[17] ~ names[17],
      country == iso[18] ~ names[18],
      country == iso[19] ~ names[19],
      country == iso[20] ~ names[20],
      country == iso[21] ~ names[21],
      country == iso[22] ~ names[22],
      country == iso[23] ~ names[23]
    )
  )

```

#### CES-D

```{r}

#### lme4 ####
cesd_iyes_unadj_mwealth_results <- tibble()
for(i in 1:23){
  cesd_iyes_unadj <- lmer(
    cesd_stand ~ internet_yes + cwave + (1 | id),
    data = mwealth_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_unadj_result <- broom.mixed::tidy(cesd_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_unadj_mwealth_results <- cesd_iyes_unadj_mwealth_results %>% 
    bind_rows(., cesd_iyes_unadj_result)
  rm(cesd_iyes_unadj, cesd_iyes_unadj_result)
}

cesd_iyes_adj_mwealth_results <- tibble()
for(i in 1:23){
  cesd_iyes_adj <- lmer(
    cesd_stand ~ internet_yes + cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = mwealth_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_adj_result <- broom.mixed::tidy(cesd_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_adj_mwealth_results <- cesd_iyes_adj_mwealth_results %>% 
    bind_rows(., cesd_iyes_adj_result)
  rm(cesd_iyes_adj, cesd_iyes_adj_result)
}

#### metafor ####
cesd_iyes_unadj_mwealth_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_unadj_mwealth_results, slab = country)

cesd_iyes_adj_mwealth_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_mwealth_results, slab = country)

```

#### Self-rated health

```{r}

#### lme4 ####
shlt_iyes_unadj_mwealth_results <- tibble()
for(i in 1:23){
  shlt_iyes_unadj <- lmer(
    shlt_stand ~ internet_yes + cwave + (1 | id),
    data = mwealth_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_unadj_result <- broom.mixed::tidy(shlt_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_unadj_mwealth_results <- shlt_iyes_unadj_mwealth_results %>% 
    bind_rows(., shlt_iyes_unadj_result)
  rm(shlt_iyes_unadj, shlt_iyes_unadj_result)
}

shlt_iyes_adj_mwealth_results <- tibble()
for(i in 1:23){
  shlt_iyes_adj <- lmer(
    shlt_stand ~ internet_yes + cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = mwealth_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_adj_result <- broom.mixed::tidy(shlt_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_adj_mwealth_results <- shlt_iyes_adj_mwealth_results %>% 
    bind_rows(., shlt_iyes_adj_result)
  rm(shlt_iyes_adj, shlt_iyes_adj_result)
}


#### metafor ####
shlt_iyes_unadj_mwealth_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_unadj_mwealth_results, slab = country)

shlt_iyes_adj_mwealth_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_mwealth_results, slab = country)

```

#### Life satisfaction

```{r}

#### lme4 ####
satlife_iyes_unadj_mwealth_results <- tibble()
for(i in 1:23){
  satlife_iyes_unadj <- lmer(
    satlife_stand ~ internet_yes + cwave + (1 | id),
    data = mwealth_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_unadj_result <- broom.mixed::tidy(satlife_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_unadj_mwealth_results <- satlife_iyes_unadj_mwealth_results %>% 
    bind_rows(., satlife_iyes_unadj_result)
  rm(satlife_iyes_unadj, satlife_iyes_unadj_result)
}

satlife_iyes_adj_mwealth_results <- tibble()
for(i in 1:23){
  satlife_iyes_adj <- lmer(
    satlife_stand ~ internet_yes + cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = mwealth_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_adj_result <- broom.mixed::tidy(satlife_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_adj_mwealth_results <- satlife_iyes_adj_mwealth_results %>% 
    bind_rows(., satlife_iyes_adj_result)
  rm(satlife_iyes_adj, satlife_iyes_adj_result)
}


#### metafor ####
satlife_iyes_unadj_mwealth_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_unadj_mwealth_results, slab = country)

satlife_iyes_adj_mwealth_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_mwealth_results, slab = country)

```

### High 

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

hwealth_iyes_merge <- hwealth_iyes_hrs %>% mutate(id = as.character(id)) %>%
  bind_rows(., hwealth_iyes_elsa %>% mutate(id = as.character(id))) %>%
  bind_rows(., hwealth_iyes_charls %>% mutate(id = as.character(id))) %>%
  bind_rows(., hwealth_iyes_share) %>%
  bind_rows(., hwealth_iyes_mhas) %>%
  bind_rows(., hwealth_iyes_elsi %>% mutate(id = as.character(id))) %>%
  mutate(
    country_names = case_when(
      country == iso[1] ~ names[1],
      country == iso[2] ~ names[2],
      country == iso[3] ~ names[3],
      country == iso[4] ~ names[4],
      country == iso[5] ~ names[5],
      country == iso[6] ~ names[6],
      country == iso[7] ~ names[7],
      country == iso[8] ~ names[8],
      country == iso[9] ~ names[9],
      country == iso[10] ~ names[10],
      country == iso[11] ~ names[11],
      country == iso[12] ~ names[12],
      country == iso[13] ~ names[13],
      country == iso[14] ~ names[14],
      country == iso[15] ~ names[15],
      country == iso[16] ~ names[16],
      country == iso[17] ~ names[17],
      country == iso[18] ~ names[18],
      country == iso[19] ~ names[19],
      country == iso[20] ~ names[20],
      country == iso[21] ~ names[21],
      country == iso[22] ~ names[22],
      country == iso[23] ~ names[23]
    )
  )

```

#### CES-D

```{r}

#### lme4 ####
cesd_iyes_unadj_hwealth_results <- tibble()
for(i in 1:23){
  cesd_iyes_unadj <- lmer(
    cesd_stand ~ internet_yes + cwave + (1 | id),
    data = hwealth_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_unadj_result <- broom.mixed::tidy(cesd_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_unadj_hwealth_results <- cesd_iyes_unadj_hwealth_results %>% 
    bind_rows(., cesd_iyes_unadj_result)
  rm(cesd_iyes_unadj, cesd_iyes_unadj_result)
}

cesd_iyes_adj_hwealth_results <- tibble()
for(i in 1:23){
  cesd_iyes_adj <- lmer(
    cesd_stand ~ internet_yes + cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = hwealth_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_adj_result <- broom.mixed::tidy(cesd_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_adj_hwealth_results <- cesd_iyes_adj_hwealth_results %>% 
    bind_rows(., cesd_iyes_adj_result)
  rm(cesd_iyes_adj, cesd_iyes_adj_result)
}

#### metafor ####
cesd_iyes_unadj_hwealth_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_unadj_hwealth_results, slab = country)

cesd_iyes_adj_hwealth_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_hwealth_results, slab = country)

```

#### Self-rated health

```{r}

#### lme4 ####
shlt_iyes_unadj_hwealth_results <- tibble()
for(i in 1:23){
  shlt_iyes_unadj <- lmer(
    shlt_stand ~ internet_yes + cwave + (1 | id),
    data = hwealth_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_unadj_result <- broom.mixed::tidy(shlt_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_unadj_hwealth_results <- shlt_iyes_unadj_hwealth_results %>% 
    bind_rows(., shlt_iyes_unadj_result)
  rm(shlt_iyes_unadj, shlt_iyes_unadj_result)
}

shlt_iyes_adj_hwealth_results <- tibble()
for(i in 1:23){
  shlt_iyes_adj <- lmer(
    shlt_stand ~ internet_yes + cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = hwealth_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_adj_result <- broom.mixed::tidy(shlt_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_adj_hwealth_results <- shlt_iyes_adj_hwealth_results %>% 
    bind_rows(., shlt_iyes_adj_result)
  rm(shlt_iyes_adj, shlt_iyes_adj_result)
}


#### metafor ####
shlt_iyes_unadj_hwealth_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_unadj_hwealth_results, slab = country)

shlt_iyes_adj_hwealth_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_hwealth_results, slab = country)

```

#### Life satisfaction

```{r}

#### lme4 ####
satlife_iyes_unadj_hwealth_results <- tibble()
for(i in 1:23){
  satlife_iyes_unadj <- lmer(
    satlife_stand ~ internet_yes + cwave + (1 | id),
    data = hwealth_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_unadj_result <- broom.mixed::tidy(satlife_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_unadj_hwealth_results <- satlife_iyes_unadj_hwealth_results %>% 
    bind_rows(., satlife_iyes_unadj_result)
  rm(satlife_iyes_unadj, satlife_iyes_unadj_result)
}

satlife_iyes_adj_hwealth_results <- tibble()
for(i in 1:23){
  satlife_iyes_adj <- lmer(
    satlife_stand ~ internet_yes + cwave + 
      age + male + lowedu + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = hwealth_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_adj_result <- broom.mixed::tidy(satlife_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_adj_hwealth_results <- satlife_iyes_adj_hwealth_results %>% 
    bind_rows(., satlife_iyes_adj_result)
  rm(satlife_iyes_adj, satlife_iyes_adj_result)
}


#### metafor ####
satlife_iyes_unadj_hwealth_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_unadj_hwealth_results, slab = country)

satlife_iyes_adj_hwealth_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_hwealth_results, slab = country)

```

#### Test for interaction

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

outcomes <- c("cesd_stand", "shlt_stand", "satlife_stand")

p4interaction_wealth <- tibble()

for(i in 1:3){
  for(j in 1:23){
    formula_reduced <- as.formula(paste(outcomes[i], "~ internet_yes + cwave + age + male + lowedu + lowwealth + lbrf + nonmarried + hhres + smoken + weekdrink + phyinact + dis + adl_any + iadl + (1 | id)"))
    
    interact_reduced <- lmer(
      formula_reduced,
      data = subgroup_iyes_merge %>% filter(country_names == names[j]), 
      control = lmerControl(optimizer = "bobyqa")
      )
    
    formula <- as.formula(paste(outcomes[i], "~ internet_yes*lowwealth + cwave + age + male + lowedu + lbrf + nonmarried + hhres + smoken + weekdrink + phyinact + dis + adl_any + iadl + (1 | id)"))
    
    interact <- lmer(
      formula,
      data = subgroup_iyes_merge %>% filter(country_names == names[j]), 
      control = lmerControl(optimizer = "bobyqa")
      )
    
    interaction_re <- tibble(
      outcome = outcomes[i], country = names[j], 
      p4interaction = anova(interact_reduced, interact, refit = T)$`Pr(>Chisq)`[2]
    )
    
    p4interaction_wealth <- p4interaction_wealth %>% 
      bind_rows(., interaction_re)
    
    rm(formula_reduced, interact_reduced, formula, interact, interaction_re)
  }
}


```

## By labor force status

### Working

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

work_iyes_merge <- work_iyes_hrs %>% mutate(id = as.character(id)) %>%
  bind_rows(., work_iyes_elsa %>% mutate(id = as.character(id))) %>%
  bind_rows(., work_iyes_charls %>% mutate(id = as.character(id))) %>%
  bind_rows(., work_iyes_share) %>%
  bind_rows(., work_iyes_mhas) %>%
  bind_rows(., work_iyes_elsi %>% mutate(id = as.character(id))) %>%
  mutate(
    country_names = case_when(
      country == iso[1] ~ names[1],
      country == iso[2] ~ names[2],
      country == iso[3] ~ names[3],
      country == iso[4] ~ names[4],
      country == iso[5] ~ names[5],
      country == iso[6] ~ names[6],
      country == iso[7] ~ names[7],
      country == iso[8] ~ names[8],
      country == iso[9] ~ names[9],
      country == iso[10] ~ names[10],
      country == iso[11] ~ names[11],
      country == iso[12] ~ names[12],
      country == iso[13] ~ names[13],
      country == iso[14] ~ names[14],
      country == iso[15] ~ names[15],
      country == iso[16] ~ names[16],
      country == iso[17] ~ names[17],
      country == iso[18] ~ names[18],
      country == iso[19] ~ names[19],
      country == iso[20] ~ names[20],
      country == iso[21] ~ names[21],
      country == iso[22] ~ names[22],
      country == iso[23] ~ names[23]
    )
  )

```

#### CES-D

```{r}

#### lme4 ####
cesd_iyes_unadj_work_results <- tibble()
for(i in 1:23){
  cesd_iyes_unadj <- lmer(
    cesd_stand ~ internet_yes + cwave + (1 | id),
    data = work_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_unadj_result <- broom.mixed::tidy(cesd_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_unadj_work_results <- cesd_iyes_unadj_work_results %>% 
    bind_rows(., cesd_iyes_unadj_result)
  rm(cesd_iyes_unadj, cesd_iyes_unadj_result)
}

cesd_iyes_adj_work_results <- tibble()
for(i in 1:23){
  cesd_iyes_adj <- lmer(
    cesd_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = work_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_adj_result <- broom.mixed::tidy(cesd_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_adj_work_results <- cesd_iyes_adj_work_results %>% 
    bind_rows(., cesd_iyes_adj_result)
  rm(cesd_iyes_adj, cesd_iyes_adj_result)
}

#### metafor ####
cesd_iyes_unadj_work_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_unadj_work_results, slab = country)

cesd_iyes_adj_work_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_work_results, slab = country)

```

#### Self-rated health

```{r}

#### lme4 ####
shlt_iyes_unadj_work_results <- tibble()
for(i in 1:23){
  shlt_iyes_unadj <- lmer(
    shlt_stand ~ internet_yes + cwave + (1 | id),
    data = work_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_unadj_result <- broom.mixed::tidy(shlt_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_unadj_work_results <- shlt_iyes_unadj_work_results %>% 
    bind_rows(., shlt_iyes_unadj_result)
  rm(shlt_iyes_unadj, shlt_iyes_unadj_result)
}

shlt_iyes_adj_work_results <- tibble()
for(i in 1:23){
  shlt_iyes_adj <- lmer(
    shlt_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = work_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_adj_result <- broom.mixed::tidy(shlt_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_adj_work_results <- shlt_iyes_adj_work_results %>% 
    bind_rows(., shlt_iyes_adj_result)
  rm(shlt_iyes_adj, shlt_iyes_adj_result)
}


#### metafor ####
shlt_iyes_unadj_work_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_unadj_work_results, slab = country)

shlt_iyes_adj_work_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_work_results, slab = country)

```

#### Life satisfaction

```{r}

#### lme4 ####
satlife_iyes_unadj_work_results <- tibble()
for(i in 1:23){
  satlife_iyes_unadj <- lmer(
    satlife_stand ~ internet_yes + cwave + (1 | id),
    data = work_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_unadj_result <- broom.mixed::tidy(satlife_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_unadj_work_results <- satlife_iyes_unadj_work_results %>% 
    bind_rows(., satlife_iyes_unadj_result)
  rm(satlife_iyes_unadj, satlife_iyes_unadj_result)
}

satlife_iyes_adj_work_results <- tibble()
for(i in 1:23){
  satlife_iyes_adj <- lmer(
    satlife_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = work_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_adj_result <- broom.mixed::tidy(satlife_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_adj_work_results <- satlife_iyes_adj_work_results %>% 
    bind_rows(., satlife_iyes_adj_result)
  rm(satlife_iyes_adj, satlife_iyes_adj_result)
}


#### metafor ####
satlife_iyes_unadj_work_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_unadj_work_results, slab = country)

satlife_iyes_adj_work_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_work_results, slab = country)

```


### Retired

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

retired_iyes_merge <- retired_iyes_hrs %>% mutate(id = as.character(id)) %>%
  bind_rows(., retired_iyes_elsa %>% mutate(id = as.character(id))) %>%
  bind_rows(., retired_iyes_charls %>% mutate(id = as.character(id))) %>%
  bind_rows(., retired_iyes_share) %>%
  bind_rows(., retired_iyes_mhas) %>%
  bind_rows(., retired_iyes_elsi %>% mutate(id = as.character(id))) %>%
  mutate(
    country_names = case_when(
      country == iso[1] ~ names[1],
      country == iso[2] ~ names[2],
      country == iso[3] ~ names[3],
      country == iso[4] ~ names[4],
      country == iso[5] ~ names[5],
      country == iso[6] ~ names[6],
      country == iso[7] ~ names[7],
      country == iso[8] ~ names[8],
      country == iso[9] ~ names[9],
      country == iso[10] ~ names[10],
      country == iso[11] ~ names[11],
      country == iso[12] ~ names[12],
      country == iso[13] ~ names[13],
      country == iso[14] ~ names[14],
      country == iso[15] ~ names[15],
      country == iso[16] ~ names[16],
      country == iso[17] ~ names[17],
      country == iso[18] ~ names[18],
      country == iso[19] ~ names[19],
      country == iso[20] ~ names[20],
      country == iso[21] ~ names[21],
      country == iso[22] ~ names[22],
      country == iso[23] ~ names[23]
    )
  )

```

#### CES-D

```{r}

#### lme4 ####
cesd_iyes_unadj_retired_results <- tibble()
for(i in 1:23){
  cesd_iyes_unadj <- lmer(
    cesd_stand ~ internet_yes + cwave + (1 | id),
    data = retired_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_unadj_result <- broom.mixed::tidy(cesd_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_unadj_retired_results <- cesd_iyes_unadj_retired_results %>% 
    bind_rows(., cesd_iyes_unadj_result)
  rm(cesd_iyes_unadj, cesd_iyes_unadj_result)
}

cesd_iyes_adj_retired_results <- tibble()
for(i in 1:23){
  cesd_iyes_adj <- lmer(
    cesd_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = retired_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_adj_result <- broom.mixed::tidy(cesd_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_adj_retired_results <- cesd_iyes_adj_retired_results %>% 
    bind_rows(., cesd_iyes_adj_result)
  rm(cesd_iyes_adj, cesd_iyes_adj_result)
}

#### metafor ####
cesd_iyes_unadj_resulttired_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_unadj_retired_results, slab = country)

cesd_iyes_adj_resulttired_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_retired_results, slab = country)

```

#### Self-rated health

```{r}

#### lme4 ####
shlt_iyes_unadj_retired_results <- tibble()
for(i in 1:23){
  shlt_iyes_unadj <- lmer(
    shlt_stand ~ internet_yes + cwave + (1 | id),
    data = retired_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_unadj_result <- broom.mixed::tidy(shlt_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_unadj_retired_results <- shlt_iyes_unadj_retired_results %>% 
    bind_rows(., shlt_iyes_unadj_result)
  rm(shlt_iyes_unadj, shlt_iyes_unadj_result)
}

shlt_iyes_adj_retired_results <- tibble()
for(i in 1:23){
  shlt_iyes_adj <- lmer(
    shlt_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = retired_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_adj_result <- broom.mixed::tidy(shlt_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_adj_retired_results <- shlt_iyes_adj_retired_results %>% 
    bind_rows(., shlt_iyes_adj_result)
  rm(shlt_iyes_adj, shlt_iyes_adj_result)
}


#### metafor ####
shlt_iyes_unadj_resulttired_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_unadj_retired_results, slab = country)

shlt_iyes_adj_resulttired_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_retired_results, slab = country)

```

#### Life satisfaction

```{r}

#### lme4 ####
satlife_iyes_unadj_retired_results <- tibble()
for(i in 1:23){
  satlife_iyes_unadj <- lmer(
    satlife_stand ~ internet_yes + cwave + (1 | id),
    data = retired_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_unadj_result <- broom.mixed::tidy(satlife_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_unadj_retired_results <- satlife_iyes_unadj_retired_results %>% 
    bind_rows(., satlife_iyes_unadj_result)
  rm(satlife_iyes_unadj, satlife_iyes_unadj_result)
}

satlife_iyes_adj_retired_results <- tibble()
for(i in 1:23){
  satlife_iyes_adj <- lmer(
    satlife_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = retired_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_adj_result <- broom.mixed::tidy(satlife_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_adj_retired_results <- satlife_iyes_adj_retired_results %>% 
    bind_rows(., satlife_iyes_adj_result)
  rm(satlife_iyes_adj, satlife_iyes_adj_result)
}


#### metafor ####
satlife_iyes_unadj_resulttired_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_unadj_retired_results, slab = country)

satlife_iyes_adj_resulttired_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_retired_results, slab = country)

```


### Others

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

others_iyes_merge <- others_iyes_hrs %>% mutate(id = as.character(id)) %>%
  bind_rows(., others_iyes_elsa %>% mutate(id = as.character(id))) %>%
  bind_rows(., others_iyes_charls %>% mutate(id = as.character(id))) %>%
  bind_rows(., others_iyes_share) %>%
  bind_rows(., others_iyes_mhas) %>%
  bind_rows(., others_iyes_elsi %>% mutate(id = as.character(id))) %>%
  mutate(
    country_names = case_when(
      country == iso[1] ~ names[1],
      country == iso[2] ~ names[2],
      country == iso[3] ~ names[3],
      country == iso[4] ~ names[4],
      country == iso[5] ~ names[5],
      country == iso[6] ~ names[6],
      country == iso[7] ~ names[7],
      country == iso[8] ~ names[8],
      country == iso[9] ~ names[9],
      country == iso[10] ~ names[10],
      country == iso[11] ~ names[11],
      country == iso[12] ~ names[12],
      country == iso[13] ~ names[13],
      country == iso[14] ~ names[14],
      country == iso[15] ~ names[15],
      country == iso[16] ~ names[16],
      country == iso[17] ~ names[17],
      country == iso[18] ~ names[18],
      country == iso[19] ~ names[19],
      country == iso[20] ~ names[20],
      country == iso[21] ~ names[21],
      country == iso[22] ~ names[22],
      country == iso[23] ~ names[23]
    )
  )

print(others_iyes_merge %>% 
  group_by(id) %>% 
  slice(1) %>% 
  ungroup() %>% 
  mutate(internet_yes = as.numeric(internet_yes) - 1) %>%
  group_by(country_names) %>% 
  summarise(mean(internet_yes)*100), n = 50)
# China: no people who were not working use internet

nrow(others_iyes_merge[others_iyes_merge$country_names == "Poland",]) # 201


```

#### CES-D

```{r}

#### lme4 ####
cesd_iyes_unadj_others_results <- tibble()
for(i in c(1:3,5:23)){
  cesd_iyes_unadj <- lmer(
    cesd_stand ~ internet_yes + cwave + (1 | id),
    data = others_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_unadj_result <- broom.mixed::tidy(cesd_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_unadj_others_results <- cesd_iyes_unadj_others_results %>% 
    bind_rows(., cesd_iyes_unadj_result)
  rm(cesd_iyes_unadj, cesd_iyes_unadj_result)
}

cesd_iyes_adj_others_results <- tibble()
for(i in c(1:3,5:23)){
  cesd_iyes_adj <- lmer(
    cesd_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = others_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_adj_result <- broom.mixed::tidy(cesd_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_adj_others_results <- cesd_iyes_adj_others_results %>% 
    bind_rows(., cesd_iyes_adj_result)
  rm(cesd_iyes_adj, cesd_iyes_adj_result)
}

#### metafor ####
cesd_iyes_unadj_others_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_unadj_others_results, slab = country)

cesd_iyes_adj_others_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_others_results, slab = country)

```

#### Self-rated health

```{r}

#### lme4 ####
shlt_iyes_unadj_others_results <- tibble()
for(i in c(1:3,5:23)){
  shlt_iyes_unadj <- lmer(
    shlt_stand ~ internet_yes + cwave + (1 | id),
    data = others_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_unadj_result <- broom.mixed::tidy(shlt_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_unadj_others_results <- shlt_iyes_unadj_others_results %>% 
    bind_rows(., shlt_iyes_unadj_result)
  rm(shlt_iyes_unadj, shlt_iyes_unadj_result)
}

shlt_iyes_adj_others_results <- tibble()
for(i in c(1:3,5:23)){
  shlt_iyes_adj <- lmer(
    shlt_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth +
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = others_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_adj_result <- broom.mixed::tidy(shlt_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_adj_others_results <- shlt_iyes_adj_others_results %>% 
    bind_rows(., shlt_iyes_adj_result)
  rm(shlt_iyes_adj, shlt_iyes_adj_result)
}


#### metafor ####
shlt_iyes_unadj_others_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_unadj_others_results, slab = country)

shlt_iyes_adj_others_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_others_results, slab = country)

```

#### Life satisfaction

```{r}

#### lme4 ####
satlife_iyes_unadj_others_results <- tibble()
for(i in c(1:3,5:23)){
  satlife_iyes_unadj <- lmer(
    satlife_stand ~ internet_yes + cwave + (1 | id),
    data = others_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_unadj_result <- broom.mixed::tidy(satlife_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_unadj_others_results <- satlife_iyes_unadj_others_results %>% 
    bind_rows(., satlife_iyes_unadj_result)
  rm(satlife_iyes_unadj, satlife_iyes_unadj_result)
}

satlife_iyes_adj_others_results <- tibble()
for(i in c(1:3,5:23)){
  satlife_iyes_adj <- lmer(
    satlife_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth +
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = others_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_adj_result <- broom.mixed::tidy(satlife_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_adj_others_results <- satlife_iyes_adj_others_results %>% 
    bind_rows(., satlife_iyes_adj_result)
  rm(satlife_iyes_adj, satlife_iyes_adj_result)
}


#### metafor ####
satlife_iyes_unadj_others_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_unadj_others_results, slab = country)

satlife_iyes_adj_others_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_others_results, slab = country)

```

#### Test for interaction

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

outcomes <- c("cesd_stand", "shlt_stand", "satlife_stand")

p4interaction_lbrf <- tibble()

for(i in 1:3){
  for(j in 1:23){
    formula_reduced <- as.formula(paste(outcomes[i], "~ internet_yes + cwave + age + male + lowedu + lowwealth + lbrf + nonmarried + hhres + smoken + weekdrink + phyinact + dis + adl_any + iadl + (1 | id)"))
    
    interact_reduced <- lmer(
      formula_reduced,
      data = subgroup_iyes_merge %>% filter(country_names == names[j]), 
      control = lmerControl(optimizer = "bobyqa")
      )
    
    formula <- as.formula(paste(outcomes[i], "~ internet_yes*lbrf + cwave + age + male + lowedu + lowwealth + nonmarried + hhres + smoken + weekdrink + phyinact + dis + adl_any + iadl + (1 | id)"))
    
    interact <- lmer(
      formula,
      data = subgroup_iyes_merge %>% filter(country_names == names[j]), 
      control = lmerControl(optimizer = "bobyqa")
      )
    
    interaction_re <- tibble(
      outcome = outcomes[i], country = names[j], 
      p4interaction = anova(interact_reduced, interact, refit = T)$`Pr(>Chisq)`[2]
    )
    
    p4interaction_lbrf <- p4interaction_lbrf %>% 
      bind_rows(., interaction_re)
    
    rm(formula_reduced, interact_reduced, formula, interact, interaction_re)
  }
}


```

## By current smoking 

### Current smoking

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

smoke_iyes_merge <- smoke_iyes_hrs %>% mutate(id = as.character(id)) %>%
  bind_rows(., smoke_iyes_elsa %>% mutate(id = as.character(id))) %>%
  bind_rows(., smoke_iyes_charls %>% mutate(id = as.character(id))) %>%
  bind_rows(., smoke_iyes_share) %>%
  bind_rows(., smoke_iyes_mhas) %>%
  bind_rows(., smoke_iyes_elsi %>% mutate(id = as.character(id))) %>%
  mutate(
    country_names = case_when(
      country == iso[1] ~ names[1],
      country == iso[2] ~ names[2],
      country == iso[3] ~ names[3],
      country == iso[4] ~ names[4],
      country == iso[5] ~ names[5],
      country == iso[6] ~ names[6],
      country == iso[7] ~ names[7],
      country == iso[8] ~ names[8],
      country == iso[9] ~ names[9],
      country == iso[10] ~ names[10],
      country == iso[11] ~ names[11],
      country == iso[12] ~ names[12],
      country == iso[13] ~ names[13],
      country == iso[14] ~ names[14],
      country == iso[15] ~ names[15],
      country == iso[16] ~ names[16],
      country == iso[17] ~ names[17],
      country == iso[18] ~ names[18],
      country == iso[19] ~ names[19],
      country == iso[20] ~ names[20],
      country == iso[21] ~ names[21],
      country == iso[22] ~ names[22],
      country == iso[23] ~ names[23]
    )
  )

```

#### CES-D

```{r}

#### lme4 ####
cesd_iyes_unadj_smoke_results <- tibble()
for(i in 1:23){
  cesd_iyes_unadj <- lmer(
    cesd_stand ~ internet_yes + cwave + (1 | id),
    data = smoke_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_unadj_result <- broom.mixed::tidy(cesd_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_unadj_smoke_results <- cesd_iyes_unadj_smoke_results %>% 
    bind_rows(., cesd_iyes_unadj_result)
  rm(cesd_iyes_unadj, cesd_iyes_unadj_result)
}

cesd_iyes_adj_smoke_results <- tibble()
for(i in 1:23){
  cesd_iyes_adj <- lmer(
    cesd_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = smoke_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_adj_result <- broom.mixed::tidy(cesd_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_adj_smoke_results <- cesd_iyes_adj_smoke_results %>% 
    bind_rows(., cesd_iyes_adj_result)
  rm(cesd_iyes_adj, cesd_iyes_adj_result)
}

#### metafor ####
cesd_iyes_unadj_smoke_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_unadj_smoke_results, slab = country)

cesd_iyes_adj_smoke_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_smoke_results, slab = country)

```

#### Self-rated health

```{r}

#### lme4 ####
shlt_iyes_unadj_smoke_results <- tibble()
for(i in 1:23){
  shlt_iyes_unadj <- lmer(
    shlt_stand ~ internet_yes + cwave + (1 | id),
    data = smoke_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_unadj_result <- broom.mixed::tidy(shlt_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_unadj_smoke_results <- shlt_iyes_unadj_smoke_results %>% 
    bind_rows(., shlt_iyes_unadj_result)
  rm(shlt_iyes_unadj, shlt_iyes_unadj_result)
}

shlt_iyes_adj_smoke_results <- tibble()
for(i in 1:23){
  shlt_iyes_adj <- lmer(
    shlt_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = smoke_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_adj_result <- broom.mixed::tidy(shlt_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_adj_smoke_results <- shlt_iyes_adj_smoke_results %>% 
    bind_rows(., shlt_iyes_adj_result)
  rm(shlt_iyes_adj, shlt_iyes_adj_result)
}


#### metafor ####
shlt_iyes_unadj_smoke_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_unadj_smoke_results, slab = country)

shlt_iyes_adj_smoke_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_smoke_results, slab = country)

```

#### Life satisfaction

```{r}

#### lme4 ####
satlife_iyes_unadj_smoke_results <- tibble()
for(i in 1:23){
  satlife_iyes_unadj <- lmer(
    satlife_stand ~ internet_yes + cwave + (1 | id),
    data = smoke_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_unadj_result <- broom.mixed::tidy(satlife_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_unadj_smoke_results <- satlife_iyes_unadj_smoke_results %>% 
    bind_rows(., satlife_iyes_unadj_result)
  rm(satlife_iyes_unadj, satlife_iyes_unadj_result)
}

satlife_iyes_adj_smoke_results <- tibble()
for(i in 1:23){
  satlife_iyes_adj <- lmer(
    satlife_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = smoke_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_adj_result <- broom.mixed::tidy(satlife_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_adj_smoke_results <- satlife_iyes_adj_smoke_results %>% 
    bind_rows(., satlife_iyes_adj_result)
  rm(satlife_iyes_adj, satlife_iyes_adj_result)
}


#### metafor ####
satlife_iyes_unadj_smoke_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_unadj_smoke_results, slab = country)

satlife_iyes_adj_smoke_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_smoke_results, slab = country)

```

### No smoking

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

nosmoke_iyes_merge <- nosmoke_iyes_hrs %>% mutate(id = as.character(id)) %>%
  bind_rows(., nosmoke_iyes_elsa %>% mutate(id = as.character(id))) %>%
  bind_rows(., nosmoke_iyes_charls %>% mutate(id = as.character(id))) %>%
  bind_rows(., nosmoke_iyes_share) %>%
  bind_rows(., nosmoke_iyes_mhas) %>%
  bind_rows(., nosmoke_iyes_elsi %>% mutate(id = as.character(id))) %>%
  mutate(
    country_names = case_when(
      country == iso[1] ~ names[1],
      country == iso[2] ~ names[2],
      country == iso[3] ~ names[3],
      country == iso[4] ~ names[4],
      country == iso[5] ~ names[5],
      country == iso[6] ~ names[6],
      country == iso[7] ~ names[7],
      country == iso[8] ~ names[8],
      country == iso[9] ~ names[9],
      country == iso[10] ~ names[10],
      country == iso[11] ~ names[11],
      country == iso[12] ~ names[12],
      country == iso[13] ~ names[13],
      country == iso[14] ~ names[14],
      country == iso[15] ~ names[15],
      country == iso[16] ~ names[16],
      country == iso[17] ~ names[17],
      country == iso[18] ~ names[18],
      country == iso[19] ~ names[19],
      country == iso[20] ~ names[20],
      country == iso[21] ~ names[21],
      country == iso[22] ~ names[22],
      country == iso[23] ~ names[23]
    )
  )

```

#### CES-D

```{r}

#### lme4 ####
cesd_iyes_unadj_nosmoke_results <- tibble()
for(i in 1:23){
  cesd_iyes_unadj <- lmer(
    cesd_stand ~ internet_yes + cwave + (1 | id),
    data = nosmoke_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_unadj_result <- broom.mixed::tidy(cesd_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_unadj_nosmoke_results <- cesd_iyes_unadj_nosmoke_results %>% 
    bind_rows(., cesd_iyes_unadj_result)
  rm(cesd_iyes_unadj, cesd_iyes_unadj_result)
}

cesd_iyes_adj_nosmoke_results <- tibble()
for(i in 1:23){
  cesd_iyes_adj <- lmer(
    cesd_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = nosmoke_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_adj_result <- broom.mixed::tidy(cesd_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_adj_nosmoke_results <- cesd_iyes_adj_nosmoke_results %>% 
    bind_rows(., cesd_iyes_adj_result)
  rm(cesd_iyes_adj, cesd_iyes_adj_result)
}

#### metafor ####
cesd_iyes_unadj_nosmoke_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_unadj_nosmoke_results, slab = country)

cesd_iyes_adj_nosmoke_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_nosmoke_results, slab = country)

```

#### Self-rated health

```{r}

#### lme4 ####
shlt_iyes_unadj_nosmoke_results <- tibble()
for(i in 1:23){
  shlt_iyes_unadj <- lmer(
    shlt_stand ~ internet_yes + cwave + (1 | id),
    data = nosmoke_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_unadj_result <- broom.mixed::tidy(shlt_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_unadj_nosmoke_results <- shlt_iyes_unadj_nosmoke_results %>% 
    bind_rows(., shlt_iyes_unadj_result)
  rm(shlt_iyes_unadj, shlt_iyes_unadj_result)
}

shlt_iyes_adj_nosmoke_results <- tibble()
for(i in 1:23){
  shlt_iyes_adj <- lmer(
    shlt_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = nosmoke_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_adj_result <- broom.mixed::tidy(shlt_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_adj_nosmoke_results <- shlt_iyes_adj_nosmoke_results %>% 
    bind_rows(., shlt_iyes_adj_result)
  rm(shlt_iyes_adj, shlt_iyes_adj_result)
}


#### metafor ####
shlt_iyes_unadj_nosmoke_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_unadj_nosmoke_results, slab = country)

shlt_iyes_adj_nosmoke_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_nosmoke_results, slab = country)

```

#### Life satisfaction

```{r}

#### lme4 ####
satlife_iyes_unadj_nosmoke_results <- tibble()
for(i in 1:23){
  satlife_iyes_unadj <- lmer(
    satlife_stand ~ internet_yes + cwave + (1 | id),
    data = nosmoke_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_unadj_result <- broom.mixed::tidy(satlife_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_unadj_nosmoke_results <- satlife_iyes_unadj_nosmoke_results %>% 
    bind_rows(., satlife_iyes_unadj_result)
  rm(satlife_iyes_unadj, satlife_iyes_unadj_result)
}

satlife_iyes_adj_nosmoke_results <- tibble()
for(i in 1:23){
  satlife_iyes_adj <- lmer(
    satlife_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = nosmoke_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_adj_result <- broom.mixed::tidy(satlife_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_adj_nosmoke_results <- satlife_iyes_adj_nosmoke_results %>% 
    bind_rows(., satlife_iyes_adj_result)
  rm(satlife_iyes_adj, satlife_iyes_adj_result)
}


#### metafor ####
satlife_iyes_unadj_nosmoke_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_unadj_nosmoke_results, slab = country)

satlife_iyes_adj_nosmoke_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_nosmoke_results, slab = country)

```

#### Test for interaction

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

outcomes <- c("cesd_stand", "shlt_stand", "satlife_stand")

p4interaction_smoke <- tibble()

for(i in 1:3){
  for(j in 1:23){
    formula_reduced <- as.formula(paste(outcomes[i], "~ internet_yes + cwave + age + male + lowedu + lowwealth + lbrf + nonmarried + hhres + smoken + weekdrink + phyinact + dis + adl_any + iadl + (1 | id)"))
    
    interact_reduced <- lmer(
      formula_reduced,
      data = subgroup_iyes_merge %>% filter(country_names == names[j]), 
      control = lmerControl(optimizer = "bobyqa")
      )
    
    formula <- as.formula(paste(outcomes[i], "~ internet_yes*smoken + cwave + age + male + lowedu + lowwealth + lbrf + nonmarried + hhres + weekdrink + phyinact + dis + adl_any + iadl + (1 | id)"))
    
    interact <- lmer(
      formula,
      data = subgroup_iyes_merge %>% filter(country_names == names[j]), 
      control = lmerControl(optimizer = "bobyqa")
      )
    
    interaction_re <- tibble(
      outcome = outcomes[i], country = names[j], 
      p4interaction = anova(interact_reduced, interact, refit = T)$`Pr(>Chisq)`[2]
    )
    
    p4interaction_smoke <- p4interaction_smoke %>% 
      bind_rows(., interaction_re)
    
    rm(formula_reduced, interact_reduced, formula, interact, interaction_re)
  }
}


```

## By alcohol consumption

### Weekly alcohol use

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

drink_iyes_merge <- drink_iyes_hrs %>% mutate(id = as.character(id)) %>%
  bind_rows(., drink_iyes_elsa %>% mutate(id = as.character(id))) %>%
  bind_rows(., drink_iyes_charls %>% mutate(id = as.character(id))) %>%
  bind_rows(., drink_iyes_share) %>%
  bind_rows(., drink_iyes_mhas) %>%
  bind_rows(., drink_iyes_elsi %>% mutate(id = as.character(id))) %>%
  mutate(
    country_names = case_when(
      country == iso[1] ~ names[1],
      country == iso[2] ~ names[2],
      country == iso[3] ~ names[3],
      country == iso[4] ~ names[4],
      country == iso[5] ~ names[5],
      country == iso[6] ~ names[6],
      country == iso[7] ~ names[7],
      country == iso[8] ~ names[8],
      country == iso[9] ~ names[9],
      country == iso[10] ~ names[10],
      country == iso[11] ~ names[11],
      country == iso[12] ~ names[12],
      country == iso[13] ~ names[13],
      country == iso[14] ~ names[14],
      country == iso[15] ~ names[15],
      country == iso[16] ~ names[16],
      country == iso[17] ~ names[17],
      country == iso[18] ~ names[18],
      country == iso[19] ~ names[19],
      country == iso[20] ~ names[20],
      country == iso[21] ~ names[21],
      country == iso[22] ~ names[22],
      country == iso[23] ~ names[23]
    )
  )

```

#### CES-D

```{r}

#### lme4 ####
cesd_iyes_unadj_drink_results <- tibble()
for(i in 1:23){
  cesd_iyes_unadj <- lmer(
    cesd_stand ~ internet_yes + cwave + (1 | id),
    data = drink_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_unadj_result <- broom.mixed::tidy(cesd_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_unadj_drink_results <- cesd_iyes_unadj_drink_results %>% 
    bind_rows(., cesd_iyes_unadj_result)
  rm(cesd_iyes_unadj, cesd_iyes_unadj_result)
}

cesd_iyes_adj_drink_results <- tibble()
for(i in 1:23){
  cesd_iyes_adj <- lmer(
    cesd_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = drink_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_adj_result <- broom.mixed::tidy(cesd_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_adj_drink_results <- cesd_iyes_adj_drink_results %>% 
    bind_rows(., cesd_iyes_adj_result)
  rm(cesd_iyes_adj, cesd_iyes_adj_result)
}

#### metafor ####
cesd_iyes_unadj_drink_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_unadj_drink_results, slab = country)

cesd_iyes_adj_drink_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_drink_results, slab = country)

```

#### Self-rated health

```{r}

#### lme4 ####
shlt_iyes_unadj_drink_results <- tibble()
for(i in 1:23){
  shlt_iyes_unadj <- lmer(
    shlt_stand ~ internet_yes + cwave + (1 | id),
    data = drink_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_unadj_result <- broom.mixed::tidy(shlt_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_unadj_drink_results <- shlt_iyes_unadj_drink_results %>% 
    bind_rows(., shlt_iyes_unadj_result)
  rm(shlt_iyes_unadj, shlt_iyes_unadj_result)
}

shlt_iyes_adj_drink_results <- tibble()
for(i in 1:23){
  shlt_iyes_adj <- lmer(
    shlt_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = drink_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_adj_result <- broom.mixed::tidy(shlt_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_adj_drink_results <- shlt_iyes_adj_drink_results %>% 
    bind_rows(., shlt_iyes_adj_result)
  rm(shlt_iyes_adj, shlt_iyes_adj_result)
}


#### metafor ####
shlt_iyes_unadj_drink_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_unadj_drink_results, slab = country)

shlt_iyes_adj_drink_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_drink_results, slab = country)

```

#### Life satisfaction

```{r}

#### lme4 ####
satlife_iyes_unadj_drink_results <- tibble()
for(i in 1:23){
  satlife_iyes_unadj <- lmer(
    satlife_stand ~ internet_yes + cwave + (1 | id),
    data = drink_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_unadj_result <- broom.mixed::tidy(satlife_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_unadj_drink_results <- satlife_iyes_unadj_drink_results %>% 
    bind_rows(., satlife_iyes_unadj_result)
  rm(satlife_iyes_unadj, satlife_iyes_unadj_result)
}

satlife_iyes_adj_drink_results <- tibble()
for(i in 1:23){
  satlife_iyes_adj <- lmer(
    satlife_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = drink_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_adj_result <- broom.mixed::tidy(satlife_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_adj_drink_results <- satlife_iyes_adj_drink_results %>% 
    bind_rows(., satlife_iyes_adj_result)
  rm(satlife_iyes_adj, satlife_iyes_adj_result)
}


#### metafor ####
satlife_iyes_unadj_drink_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_unadj_drink_results, slab = country)

satlife_iyes_adj_drink_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_drink_results, slab = country)

```

### Less than weekly alcohol use

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

nodrink_iyes_merge <- nodrink_iyes_hrs %>% mutate(id = as.character(id)) %>%
  bind_rows(., nodrink_iyes_elsa %>% mutate(id = as.character(id))) %>%
  bind_rows(., nodrink_iyes_charls %>% mutate(id = as.character(id))) %>%
  bind_rows(., nodrink_iyes_share) %>%
  bind_rows(., nodrink_iyes_mhas) %>%
  bind_rows(., nodrink_iyes_elsi %>% mutate(id = as.character(id))) %>%
  mutate(
    country_names = case_when(
      country == iso[1] ~ names[1],
      country == iso[2] ~ names[2],
      country == iso[3] ~ names[3],
      country == iso[4] ~ names[4],
      country == iso[5] ~ names[5],
      country == iso[6] ~ names[6],
      country == iso[7] ~ names[7],
      country == iso[8] ~ names[8],
      country == iso[9] ~ names[9],
      country == iso[10] ~ names[10],
      country == iso[11] ~ names[11],
      country == iso[12] ~ names[12],
      country == iso[13] ~ names[13],
      country == iso[14] ~ names[14],
      country == iso[15] ~ names[15],
      country == iso[16] ~ names[16],
      country == iso[17] ~ names[17],
      country == iso[18] ~ names[18],
      country == iso[19] ~ names[19],
      country == iso[20] ~ names[20],
      country == iso[21] ~ names[21],
      country == iso[22] ~ names[22],
      country == iso[23] ~ names[23]
    )
  )

```

#### CES-D

```{r}

#### lme4 ####
cesd_iyes_unadj_nodrink_results <- tibble()
for(i in 1:23){
  cesd_iyes_unadj <- lmer(
    cesd_stand ~ internet_yes + cwave + (1 | id),
    data = nodrink_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_unadj_result <- broom.mixed::tidy(cesd_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_unadj_nodrink_results <- cesd_iyes_unadj_nodrink_results %>% 
    bind_rows(., cesd_iyes_unadj_result)
  rm(cesd_iyes_unadj, cesd_iyes_unadj_result)
}

cesd_iyes_adj_nodrink_results <- tibble()
for(i in 1:23){
  cesd_iyes_adj <- lmer(
    cesd_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = nodrink_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_adj_result <- broom.mixed::tidy(cesd_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_adj_nodrink_results <- cesd_iyes_adj_nodrink_results %>% 
    bind_rows(., cesd_iyes_adj_result)
  rm(cesd_iyes_adj, cesd_iyes_adj_result)
}

#### metafor ####
cesd_iyes_unadj_nodrink_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_unadj_nodrink_results, slab = country)

cesd_iyes_adj_nodrink_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_nodrink_results, slab = country)

```

#### Self-rated health

```{r}

#### lme4 ####
shlt_iyes_unadj_nodrink_results <- tibble()
for(i in 1:23){
  shlt_iyes_unadj <- lmer(
    shlt_stand ~ internet_yes + cwave + (1 | id),
    data = nodrink_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_unadj_result <- broom.mixed::tidy(shlt_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_unadj_nodrink_results <- shlt_iyes_unadj_nodrink_results %>% 
    bind_rows(., shlt_iyes_unadj_result)
  rm(shlt_iyes_unadj, shlt_iyes_unadj_result)
}

shlt_iyes_adj_nodrink_results <- tibble()
for(i in 1:23){
  shlt_iyes_adj <- lmer(
    shlt_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = nodrink_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_adj_result <- broom.mixed::tidy(shlt_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_adj_nodrink_results <- shlt_iyes_adj_nodrink_results %>% 
    bind_rows(., shlt_iyes_adj_result)
  rm(shlt_iyes_adj, shlt_iyes_adj_result)
}


#### metafor ####
shlt_iyes_unadj_nodrink_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_unadj_nodrink_results, slab = country)

shlt_iyes_adj_nodrink_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_nodrink_results, slab = country)

```

#### Life satisfaction

```{r}

#### lme4 ####
satlife_iyes_unadj_nodrink_results <- tibble()
for(i in 1:23){
  satlife_iyes_unadj <- lmer(
    satlife_stand ~ internet_yes + cwave + (1 | id),
    data = nodrink_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_unadj_result <- broom.mixed::tidy(satlife_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_unadj_nodrink_results <- satlife_iyes_unadj_nodrink_results %>% 
    bind_rows(., satlife_iyes_unadj_result)
  rm(satlife_iyes_unadj, satlife_iyes_unadj_result)
}

satlife_iyes_adj_nodrink_results <- tibble()
for(i in 1:23){
  satlife_iyes_adj <- lmer(
    satlife_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = nodrink_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_adj_result <- broom.mixed::tidy(satlife_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_adj_nodrink_results <- satlife_iyes_adj_nodrink_results %>% 
    bind_rows(., satlife_iyes_adj_result)
  rm(satlife_iyes_adj, satlife_iyes_adj_result)
}


#### metafor ####
satlife_iyes_unadj_nodrink_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_unadj_nodrink_results, slab = country)

satlife_iyes_adj_nodrink_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_nodrink_results, slab = country)

```

#### Test for interaction

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

outcomes <- c("cesd_stand", "shlt_stand", "satlife_stand")

p4interaction_drink <- tibble()

for(i in 1:3){
  for(j in 1:23){
    formula_reduced <- as.formula(paste(outcomes[i], "~ internet_yes + cwave + age + male + lowedu + lowwealth + lbrf + nonmarried + hhres + smoken + weekdrink + phyinact + dis + adl_any + iadl + (1 | id)"))
    
    interact_reduced <- lmer(
      formula_reduced,
      data = subgroup_iyes_merge %>% filter(country_names == names[j]), 
      control = lmerControl(optimizer = "bobyqa")
      )
    
    formula <- as.formula(paste(outcomes[i], "~ internet_yes*weekdrink + cwave + age + male + lowedu + lowwealth + lbrf + nonmarried + hhres + smoken + phyinact + dis + adl_any + iadl + (1 | id)"))
    
    interact <- lmer(
      formula,
      data = subgroup_iyes_merge %>% filter(country_names == names[j]), 
      control = lmerControl(optimizer = "bobyqa")
      )
    
    interaction_re <- tibble(
      outcome = outcomes[i], country = names[j], 
      p4interaction = anova(interact_reduced, interact, refit = T)$`Pr(>Chisq)`[2]
    )
    
    p4interaction_drink <- p4interaction_drink %>% 
      bind_rows(., interaction_re)
    
    rm(formula_reduced, interact_reduced, formula, interact, interaction_re)
  }
}


```

## By physical activity

### Physical inactivity

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

phyinact_iyes_merge <- phyinact_iyes_hrs %>% mutate(id = as.character(id)) %>%
  bind_rows(., phyinact_iyes_elsa %>% mutate(id = as.character(id))) %>%
  bind_rows(., phyinact_iyes_charls %>% mutate(id = as.character(id))) %>%
  bind_rows(., phyinact_iyes_share) %>%
  bind_rows(., phyinact_iyes_mhas) %>%
  bind_rows(., phyinact_iyes_elsi %>% mutate(id = as.character(id))) %>%
  mutate(
    country_names = case_when(
      country == iso[1] ~ names[1],
      country == iso[2] ~ names[2],
      country == iso[3] ~ names[3],
      country == iso[4] ~ names[4],
      country == iso[5] ~ names[5],
      country == iso[6] ~ names[6],
      country == iso[7] ~ names[7],
      country == iso[8] ~ names[8],
      country == iso[9] ~ names[9],
      country == iso[10] ~ names[10],
      country == iso[11] ~ names[11],
      country == iso[12] ~ names[12],
      country == iso[13] ~ names[13],
      country == iso[14] ~ names[14],
      country == iso[15] ~ names[15],
      country == iso[16] ~ names[16],
      country == iso[17] ~ names[17],
      country == iso[18] ~ names[18],
      country == iso[19] ~ names[19],
      country == iso[20] ~ names[20],
      country == iso[21] ~ names[21],
      country == iso[22] ~ names[22],
      country == iso[23] ~ names[23]
    )
  )

nrow(phyinact_iyes_merge[phyinact_iyes_merge$country_names == "Poland",]) # 16

```

#### CES-D

```{r}

#### lme4 ####
cesd_iyes_unadj_phyinact_results <- tibble()
for(i in c(1:17,19:23)){
  cesd_iyes_unadj <- lmer(
    cesd_stand ~ internet_yes + cwave + (1 | id),
    data = phyinact_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_unadj_result <- broom.mixed::tidy(cesd_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_unadj_phyinact_results <- cesd_iyes_unadj_phyinact_results %>% 
    bind_rows(., cesd_iyes_unadj_result)
  rm(cesd_iyes_unadj, cesd_iyes_unadj_result)
}

cesd_iyes_adj_phyinact_results <- tibble()
for(i in c(1:17,19:23)){
  cesd_iyes_adj <- lmer(
    cesd_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + 
      dis + adl_any + iadl + 
      (1 | id),
    data = phyinact_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_adj_result <- broom.mixed::tidy(cesd_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_adj_phyinact_results <- cesd_iyes_adj_phyinact_results %>% 
    bind_rows(., cesd_iyes_adj_result)
  rm(cesd_iyes_adj, cesd_iyes_adj_result)
}

#### metafor ####
cesd_iyes_unadj_phyinact_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_unadj_phyinact_results, slab = country)

cesd_iyes_adj_phyinact_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_phyinact_results, slab = country)

```

#### Self-rated health

```{r}

#### lme4 ####
shlt_iyes_unadj_phyinact_results <- tibble()
for(i in c(1:17,19:23)){
  shlt_iyes_unadj <- lmer(
    shlt_stand ~ internet_yes + cwave + (1 | id),
    data = phyinact_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_unadj_result <- broom.mixed::tidy(shlt_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_unadj_phyinact_results <- shlt_iyes_unadj_phyinact_results %>% 
    bind_rows(., shlt_iyes_unadj_result)
  rm(shlt_iyes_unadj, shlt_iyes_unadj_result)
}

shlt_iyes_adj_phyinact_results <- tibble()
for(i in c(1:17,19:23)){
  shlt_iyes_adj <- lmer(
    shlt_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + 
      dis + adl_any + iadl + 
      (1 | id),
    data = phyinact_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_adj_result <- broom.mixed::tidy(shlt_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_adj_phyinact_results <- shlt_iyes_adj_phyinact_results %>% 
    bind_rows(., shlt_iyes_adj_result)
  rm(shlt_iyes_adj, shlt_iyes_adj_result)
}


#### metafor ####
shlt_iyes_unadj_phyinact_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_unadj_phyinact_results, slab = country)

shlt_iyes_adj_phyinact_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_phyinact_results, slab = country, control = list(maxiter = 1000))

```

#### Life satisfaction

```{r}

#### lme4 ####
satlife_iyes_unadj_phyinact_results <- tibble()
for(i in c(1:17,19:23)){
  satlife_iyes_unadj <- lmer(
    satlife_stand ~ internet_yes + cwave + (1 | id),
    data = phyinact_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_unadj_result <- broom.mixed::tidy(satlife_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_unadj_phyinact_results <- satlife_iyes_unadj_phyinact_results %>% 
    bind_rows(., satlife_iyes_unadj_result)
  rm(satlife_iyes_unadj, satlife_iyes_unadj_result)
}

satlife_iyes_adj_phyinact_results <- tibble()
for(i in c(1:17,19:23)){
  satlife_iyes_adj <- lmer(
    satlife_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + 
      dis + adl_any + iadl + 
      (1 | id),
    data = phyinact_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_adj_result <- broom.mixed::tidy(satlife_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_adj_phyinact_results <- satlife_iyes_adj_phyinact_results %>% 
    bind_rows(., satlife_iyes_adj_result)
  rm(satlife_iyes_adj, satlife_iyes_adj_result)
}


#### metafor ####
satlife_iyes_unadj_phyinact_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_unadj_phyinact_results, slab = country)

satlife_iyes_adj_phyinact_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_phyinact_results, slab = country)

```

### Physical activity

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

phyact_iyes_merge <- phyact_iyes_hrs %>% mutate(id = as.character(id)) %>%
  bind_rows(., phyact_iyes_elsa %>% mutate(id = as.character(id))) %>%
  bind_rows(., phyact_iyes_charls %>% mutate(id = as.character(id))) %>%
  bind_rows(., phyact_iyes_share) %>%
  bind_rows(., phyact_iyes_mhas) %>%
  bind_rows(., phyact_iyes_elsi %>% mutate(id = as.character(id))) %>%
  mutate(
    country_names = case_when(
      country == iso[1] ~ names[1],
      country == iso[2] ~ names[2],
      country == iso[3] ~ names[3],
      country == iso[4] ~ names[4],
      country == iso[5] ~ names[5],
      country == iso[6] ~ names[6],
      country == iso[7] ~ names[7],
      country == iso[8] ~ names[8],
      country == iso[9] ~ names[9],
      country == iso[10] ~ names[10],
      country == iso[11] ~ names[11],
      country == iso[12] ~ names[12],
      country == iso[13] ~ names[13],
      country == iso[14] ~ names[14],
      country == iso[15] ~ names[15],
      country == iso[16] ~ names[16],
      country == iso[17] ~ names[17],
      country == iso[18] ~ names[18],
      country == iso[19] ~ names[19],
      country == iso[20] ~ names[20],
      country == iso[21] ~ names[21],
      country == iso[22] ~ names[22],
      country == iso[23] ~ names[23]
    )
  )

```

#### CES-D

```{r}

#### lme4 ####
cesd_iyes_unadj_phyact_results <- tibble()
for(i in 1:23){
  cesd_iyes_unadj <- lmer(
    cesd_stand ~ internet_yes + cwave + (1 | id),
    data = phyact_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_unadj_result <- broom.mixed::tidy(cesd_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_unadj_phyact_results <- cesd_iyes_unadj_phyact_results %>% 
    bind_rows(., cesd_iyes_unadj_result)
  rm(cesd_iyes_unadj, cesd_iyes_unadj_result)
}

cesd_iyes_adj_phyact_results <- tibble()
for(i in 1:23){
  cesd_iyes_adj <- lmer(
    cesd_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink +  
      dis + adl_any + iadl + 
      (1 | id),
    data = phyact_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_adj_result <- broom.mixed::tidy(cesd_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_adj_phyact_results <- cesd_iyes_adj_phyact_results %>% 
    bind_rows(., cesd_iyes_adj_result)
  rm(cesd_iyes_adj, cesd_iyes_adj_result)
}

#### metafor ####
cesd_iyes_unadj_phyact_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_unadj_phyact_results, slab = country)

cesd_iyes_adj_phyact_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_phyact_results, slab = country)

```

#### Self-rated health

```{r}

#### lme4 ####
shlt_iyes_unadj_phyact_results <- tibble()
for(i in 1:23){
  shlt_iyes_unadj <- lmer(
    shlt_stand ~ internet_yes + cwave + (1 | id),
    data = phyact_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_unadj_result <- broom.mixed::tidy(shlt_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_unadj_phyact_results <- shlt_iyes_unadj_phyact_results %>% 
    bind_rows(., shlt_iyes_unadj_result)
  rm(shlt_iyes_unadj, shlt_iyes_unadj_result)
}

shlt_iyes_adj_phyact_results <- tibble()
for(i in 1:23){
  shlt_iyes_adj <- lmer(
    shlt_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink +  
      dis + adl_any + iadl + 
      (1 | id),
    data = phyact_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_adj_result <- broom.mixed::tidy(shlt_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_adj_phyact_results <- shlt_iyes_adj_phyact_results %>% 
    bind_rows(., shlt_iyes_adj_result)
  rm(shlt_iyes_adj, shlt_iyes_adj_result)
}


#### metafor ####
shlt_iyes_unadj_phyact_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_unadj_phyact_results, slab = country)

shlt_iyes_adj_phyact_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_phyact_results, slab = country)

```

#### Life satisfaction

```{r}

#### lme4 ####
satlife_iyes_unadj_phyact_results <- tibble()
for(i in 1:23){
  satlife_iyes_unadj <- lmer(
    satlife_stand ~ internet_yes + cwave + (1 | id),
    data = phyact_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_unadj_result <- broom.mixed::tidy(satlife_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_unadj_phyact_results <- satlife_iyes_unadj_phyact_results %>% 
    bind_rows(., satlife_iyes_unadj_result)
  rm(satlife_iyes_unadj, satlife_iyes_unadj_result)
}

satlife_iyes_adj_phyact_results <- tibble()
for(i in 1:23){
  satlife_iyes_adj <- lmer(
    satlife_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink +  
      dis + adl_any + iadl + 
      (1 | id),
    data = phyact_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_adj_result <- broom.mixed::tidy(satlife_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_adj_phyact_results <- satlife_iyes_adj_phyact_results %>% 
    bind_rows(., satlife_iyes_adj_result)
  rm(satlife_iyes_adj, satlife_iyes_adj_result)
}


#### metafor ####
satlife_iyes_unadj_phyact_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_unadj_phyact_results, slab = country)

satlife_iyes_adj_phyact_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_phyact_results, slab = country)

```

#### Test for interaction

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

outcomes <- c("cesd_stand", "shlt_stand", "satlife_stand")

p4interaction_phyinact <- tibble()

for(i in 1:3){
  for(j in 1:23){
    formula_reduced <- as.formula(paste(outcomes[i], "~ internet_yes + cwave + age + male + lowedu + lowwealth + lbrf + nonmarried + hhres + smoken + weekdrink + phyinact + dis + adl_any + iadl + (1 | id)"))
    
    interact_reduced <- lmer(
      formula_reduced,
      data = subgroup_iyes_merge %>% filter(country_names == names[j]), 
      control = lmerControl(optimizer = "bobyqa")
      )
    
    formula <- as.formula(paste(outcomes[i], "~ internet_yes*phyinact + cwave + age + male + lowedu + lowwealth + lbrf + nonmarried + hhres + smoken + weekdrink + dis + adl_any + iadl + (1 | id)"))
    
    interact <- lmer(
      formula,
      data = subgroup_iyes_merge %>% filter(country_names == names[j]), 
      control = lmerControl(optimizer = "bobyqa")
      )
    
    interaction_re <- tibble(
      outcome = outcomes[i], country = names[j], 
      p4interaction = anova(interact_reduced, interact, refit = T)$`Pr(>Chisq)`[2]
    )
    
    p4interaction_phyinact <- p4interaction_phyinact %>% 
      bind_rows(., interaction_re)
    
    rm(formula_reduced, interact_reduced, formula, interact, interaction_re)
  }
}


```

## By ADL disability

### ADL disability

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

adl_iyes_merge <- adl_iyes_hrs %>% mutate(id = as.character(id)) %>%
  bind_rows(., adl_iyes_elsa %>% mutate(id = as.character(id))) %>%
  bind_rows(., adl_iyes_charls %>% mutate(id = as.character(id))) %>%
  bind_rows(., adl_iyes_share) %>%
  bind_rows(., adl_iyes_mhas) %>%
  bind_rows(., adl_iyes_elsi %>% mutate(id = as.character(id))) %>%
  mutate(
    country_names = case_when(
      country == iso[1] ~ names[1],
      country == iso[2] ~ names[2],
      country == iso[3] ~ names[3],
      country == iso[4] ~ names[4],
      country == iso[5] ~ names[5],
      country == iso[6] ~ names[6],
      country == iso[7] ~ names[7],
      country == iso[8] ~ names[8],
      country == iso[9] ~ names[9],
      country == iso[10] ~ names[10],
      country == iso[11] ~ names[11],
      country == iso[12] ~ names[12],
      country == iso[13] ~ names[13],
      country == iso[14] ~ names[14],
      country == iso[15] ~ names[15],
      country == iso[16] ~ names[16],
      country == iso[17] ~ names[17],
      country == iso[18] ~ names[18],
      country == iso[19] ~ names[19],
      country == iso[20] ~ names[20],
      country == iso[21] ~ names[21],
      country == iso[22] ~ names[22],
      country == iso[23] ~ names[23]
    )
  )

nrow(adl_iyes_merge[adl_iyes_merge$country_names == "Poland",]) # 27

```

#### CES-D

```{r}

#### lme4 ####
cesd_iyes_unadj_adl_results <- tibble()
for(i in c(1:17,19:23)){
  cesd_iyes_unadj <- lmer(
    cesd_stand ~ internet_yes + cwave + (1 | id),
    data = adl_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_unadj_result <- broom.mixed::tidy(cesd_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_unadj_adl_results <- cesd_iyes_unadj_adl_results %>% 
    bind_rows(., cesd_iyes_unadj_result)
  rm(cesd_iyes_unadj, cesd_iyes_unadj_result)
}

cesd_iyes_adj_adl_results <- tibble()
for(i in c(1:17,19:23)){
  cesd_iyes_adj <- lmer(
    cesd_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + iadl + 
      (1 | id),
    data = adl_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_adj_result <- broom.mixed::tidy(cesd_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_adj_adl_results <- cesd_iyes_adj_adl_results %>% 
    bind_rows(., cesd_iyes_adj_result)
  rm(cesd_iyes_adj, cesd_iyes_adj_result)
}

#### metafor ####
cesd_iyes_unadj_adl_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_unadj_adl_results, slab = country)

cesd_iyes_adj_adl_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_adl_results, slab = country)

```

#### Self-rated health

```{r}

#### lme4 ####
shlt_iyes_unadj_adl_results <- tibble()
for(i in c(1:17,19:23)){
  shlt_iyes_unadj <- lmer(
    shlt_stand ~ internet_yes + cwave + (1 | id),
    data = adl_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_unadj_result <- broom.mixed::tidy(shlt_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_unadj_adl_results <- shlt_iyes_unadj_adl_results %>% 
    bind_rows(., shlt_iyes_unadj_result)
  rm(shlt_iyes_unadj, shlt_iyes_unadj_result)
}

shlt_iyes_adj_adl_results <- tibble()
for(i in c(1:17,19:23)){
  shlt_iyes_adj <- lmer(
    shlt_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + iadl + 
      (1 | id),
    data = adl_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_adj_result <- broom.mixed::tidy(shlt_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_adj_adl_results <- shlt_iyes_adj_adl_results %>% 
    bind_rows(., shlt_iyes_adj_result)
  rm(shlt_iyes_adj, shlt_iyes_adj_result)
}


#### metafor ####
shlt_iyes_unadj_adl_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_unadj_adl_results, slab = country)

shlt_iyes_adj_adl_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_adl_results, slab = country)

```

#### Life satisfaction

```{r}

#### lme4 ####
satlife_iyes_unadj_adl_results <- tibble()
for(i in c(1:17,19:23)){
  satlife_iyes_unadj <- lmer(
    satlife_stand ~ internet_yes + cwave + (1 | id),
    data = adl_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_unadj_result <- broom.mixed::tidy(satlife_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_unadj_adl_results <- satlife_iyes_unadj_adl_results %>% 
    bind_rows(., satlife_iyes_unadj_result)
  rm(satlife_iyes_unadj, satlife_iyes_unadj_result)
}

satlife_iyes_adj_adl_results <- tibble()
for(i in c(1:17,19:23)){
  satlife_iyes_adj <- lmer(
    satlife_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + iadl + 
      (1 | id),
    data = adl_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_adj_result <- broom.mixed::tidy(satlife_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_adj_adl_results <- satlife_iyes_adj_adl_results %>% 
    bind_rows(., satlife_iyes_adj_result)
  rm(satlife_iyes_adj, satlife_iyes_adj_result)
}


#### metafor ####
satlife_iyes_unadj_adl_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_unadj_adl_results, slab = country)

satlife_iyes_adj_adl_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_adl_results, slab = country)

```

### No ADL limitation

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

noadl_iyes_merge <- noadl_iyes_hrs %>% mutate(id = as.character(id)) %>%
  bind_rows(., noadl_iyes_elsa %>% mutate(id = as.character(id))) %>%
  bind_rows(., noadl_iyes_charls %>% mutate(id = as.character(id))) %>%
  bind_rows(., noadl_iyes_share) %>%
  bind_rows(., noadl_iyes_mhas) %>%
  bind_rows(., noadl_iyes_elsi %>% mutate(id = as.character(id))) %>%
  mutate(
    country_names = case_when(
      country == iso[1] ~ names[1],
      country == iso[2] ~ names[2],
      country == iso[3] ~ names[3],
      country == iso[4] ~ names[4],
      country == iso[5] ~ names[5],
      country == iso[6] ~ names[6],
      country == iso[7] ~ names[7],
      country == iso[8] ~ names[8],
      country == iso[9] ~ names[9],
      country == iso[10] ~ names[10],
      country == iso[11] ~ names[11],
      country == iso[12] ~ names[12],
      country == iso[13] ~ names[13],
      country == iso[14] ~ names[14],
      country == iso[15] ~ names[15],
      country == iso[16] ~ names[16],
      country == iso[17] ~ names[17],
      country == iso[18] ~ names[18],
      country == iso[19] ~ names[19],
      country == iso[20] ~ names[20],
      country == iso[21] ~ names[21],
      country == iso[22] ~ names[22],
      country == iso[23] ~ names[23]
    )
  )

```

#### CES-D

```{r}

#### lme4 ####
cesd_iyes_unadj_noadl_results <- tibble()
for(i in 1:23){
  cesd_iyes_unadj <- lmer(
    cesd_stand ~ internet_yes + cwave + (1 | id),
    data = noadl_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_unadj_result <- broom.mixed::tidy(cesd_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_unadj_noadl_results <- cesd_iyes_unadj_noadl_results %>% 
    bind_rows(., cesd_iyes_unadj_result)
  rm(cesd_iyes_unadj, cesd_iyes_unadj_result)
}

cesd_iyes_adj_noadl_results <- tibble()
for(i in 1:23){
  cesd_iyes_adj <- lmer(
    cesd_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + iadl + 
      (1 | id),
    data = noadl_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_adj_result <- broom.mixed::tidy(cesd_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_adj_noadl_results <- cesd_iyes_adj_noadl_results %>% 
    bind_rows(., cesd_iyes_adj_result)
  rm(cesd_iyes_adj, cesd_iyes_adj_result)
}

#### metafor ####
cesd_iyes_unadj_noadl_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_unadj_noadl_results, slab = country)

cesd_iyes_adj_noadl_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_noadl_results, slab = country)

```

#### Self-rated health

```{r}

#### lme4 ####
shlt_iyes_unadj_noadl_results <- tibble()
for(i in 1:23){
  shlt_iyes_unadj <- lmer(
    shlt_stand ~ internet_yes + cwave + (1 | id),
    data = noadl_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_unadj_result <- broom.mixed::tidy(shlt_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_unadj_noadl_results <- shlt_iyes_unadj_noadl_results %>% 
    bind_rows(., shlt_iyes_unadj_result)
  rm(shlt_iyes_unadj, shlt_iyes_unadj_result)
}

shlt_iyes_adj_noadl_results <- tibble()
for(i in 1:23){
  shlt_iyes_adj <- lmer(
    shlt_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + iadl + 
      (1 | id),
    data = noadl_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_adj_result <- broom.mixed::tidy(shlt_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_adj_noadl_results <- shlt_iyes_adj_noadl_results %>% 
    bind_rows(., shlt_iyes_adj_result)
  rm(shlt_iyes_adj, shlt_iyes_adj_result)
}


#### metafor ####
shlt_iyes_unadj_noadl_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_unadj_noadl_results, slab = country)

shlt_iyes_adj_noadl_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_noadl_results, slab = country)

```

#### Life satisfaction

```{r}

#### lme4 ####
satlife_iyes_unadj_noadl_results <- tibble()
for(i in 1:23){
  satlife_iyes_unadj <- lmer(
    satlife_stand ~ internet_yes + cwave + (1 | id),
    data = noadl_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_unadj_result <- broom.mixed::tidy(satlife_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_unadj_noadl_results <- satlife_iyes_unadj_noadl_results %>% 
    bind_rows(., satlife_iyes_unadj_result)
  rm(satlife_iyes_unadj, satlife_iyes_unadj_result)
}

satlife_iyes_adj_noadl_results <- tibble()
for(i in 1:23){
  satlife_iyes_adj <- lmer(
    satlife_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + iadl + 
      (1 | id),
    data = noadl_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_adj_result <- broom.mixed::tidy(satlife_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_adj_noadl_results <- satlife_iyes_adj_noadl_results %>% 
    bind_rows(., satlife_iyes_adj_result)
  rm(satlife_iyes_adj, satlife_iyes_adj_result)
}


#### metafor ####
satlife_iyes_unadj_noadl_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_unadj_noadl_results, slab = country)

satlife_iyes_adj_noadl_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_noadl_results, slab = country)

```

#### Test for interaction

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

outcomes <- c("cesd_stand", "shlt_stand", "satlife_stand")

p4interaction_adl <- tibble()

for(i in 1:3){
  for(j in 1:23){
    formula_reduced <- as.formula(paste(outcomes[i], "~ internet_yes + cwave + age + male + lowedu + lowwealth + lbrf + nonmarried + hhres + smoken + weekdrink + phyinact + dis + adl_any + iadl + (1 | id)"))
    
    interact_reduced <- lmer(
      formula_reduced,
      data = subgroup_iyes_merge %>% filter(country_names == names[j]), 
      control = lmerControl(optimizer = "bobyqa")
      )
    
    formula <- as.formula(paste(outcomes[i], "~ internet_yes*adl_any + cwave + age + male + lowedu + lowwealth + lbrf + nonmarried + hhres + smoken + weekdrink + phyinact + dis + iadl + (1 | id)"))
    
    interact <- lmer(
      formula,
      data = subgroup_iyes_merge %>% filter(country_names == names[j]), 
      control = lmerControl(optimizer = "bobyqa")
      )
    
    interaction_re <- tibble(
      outcome = outcomes[i], country = names[j], 
      p4interaction = anova(interact_reduced, interact, refit = T)$`Pr(>Chisq)`[2]
    )
    
    p4interaction_adl <- p4interaction_adl %>% 
      bind_rows(., interaction_re)
    
    rm(formula_reduced, interact_reduced, formula, interact, interaction_re)
  }
}


```

## By chronic conditions

### ≥1 chronic conditions

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

dis_iyes_merge <- dis_iyes_hrs %>% mutate(id = as.character(id)) %>%
  bind_rows(., dis_iyes_elsa %>% mutate(id = as.character(id))) %>%
  bind_rows(., dis_iyes_charls %>% mutate(id = as.character(id))) %>%
  bind_rows(., dis_iyes_share) %>%
  bind_rows(., dis_iyes_mhas) %>%
  bind_rows(., dis_iyes_elsi %>% mutate(id = as.character(id))) %>%
  mutate(
    country_names = case_when(
      country == iso[1] ~ names[1],
      country == iso[2] ~ names[2],
      country == iso[3] ~ names[3],
      country == iso[4] ~ names[4],
      country == iso[5] ~ names[5],
      country == iso[6] ~ names[6],
      country == iso[7] ~ names[7],
      country == iso[8] ~ names[8],
      country == iso[9] ~ names[9],
      country == iso[10] ~ names[10],
      country == iso[11] ~ names[11],
      country == iso[12] ~ names[12],
      country == iso[13] ~ names[13],
      country == iso[14] ~ names[14],
      country == iso[15] ~ names[15],
      country == iso[16] ~ names[16],
      country == iso[17] ~ names[17],
      country == iso[18] ~ names[18],
      country == iso[19] ~ names[19],
      country == iso[20] ~ names[20],
      country == iso[21] ~ names[21],
      country == iso[22] ~ names[22],
      country == iso[23] ~ names[23]
    )
  )

```

#### CES-D

```{r}

#### lme4 ####
cesd_iyes_unadj_dis_results <- tibble()
for(i in 1:23){
  cesd_iyes_unadj <- lmer(
    cesd_stand ~ internet_yes + cwave + (1 | id),
    data = dis_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_unadj_result <- broom.mixed::tidy(cesd_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_unadj_dis_results <- cesd_iyes_unadj_dis_results %>% 
    bind_rows(., cesd_iyes_unadj_result)
  rm(cesd_iyes_unadj, cesd_iyes_unadj_result)
}

cesd_iyes_adj_dis_results <- tibble()
for(i in 1:23){
  cesd_iyes_adj <- lmer(
    cesd_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      adl_any + iadl + 
      (1 | id),
    data = dis_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_adj_result <- broom.mixed::tidy(cesd_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_adj_dis_results <- cesd_iyes_adj_dis_results %>% 
    bind_rows(., cesd_iyes_adj_result)
  rm(cesd_iyes_adj, cesd_iyes_adj_result)
}

#### metafor ####
cesd_iyes_unadj_dis_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_unadj_dis_results, slab = country)

cesd_iyes_adj_dis_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_dis_results, slab = country)

```

#### Self-rated health

```{r}

#### lme4 ####
shlt_iyes_unadj_dis_results <- tibble()
for(i in 1:23){
  shlt_iyes_unadj <- lmer(
    shlt_stand ~ internet_yes + cwave + (1 | id),
    data = dis_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_unadj_result <- broom.mixed::tidy(shlt_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_unadj_dis_results <- shlt_iyes_unadj_dis_results %>% 
    bind_rows(., shlt_iyes_unadj_result)
  rm(shlt_iyes_unadj, shlt_iyes_unadj_result)
}

shlt_iyes_adj_dis_results <- tibble()
for(i in 1:23){
  shlt_iyes_adj <- lmer(
    shlt_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      adl_any + iadl + 
      (1 | id),
    data = dis_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_adj_result <- broom.mixed::tidy(shlt_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_adj_dis_results <- shlt_iyes_adj_dis_results %>% 
    bind_rows(., shlt_iyes_adj_result)
  rm(shlt_iyes_adj, shlt_iyes_adj_result)
}


#### metafor ####
shlt_iyes_unadj_dis_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_unadj_dis_results, slab = country)

shlt_iyes_adj_dis_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_dis_results, slab = country)

```

#### Life satisfaction

```{r}

#### lme4 ####
satlife_iyes_unadj_dis_results <- tibble()
for(i in 1:23){
  satlife_iyes_unadj <- lmer(
    satlife_stand ~ internet_yes + cwave + (1 | id),
    data = dis_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_unadj_result <- broom.mixed::tidy(satlife_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_unadj_dis_results <- satlife_iyes_unadj_dis_results %>% 
    bind_rows(., satlife_iyes_unadj_result)
  rm(satlife_iyes_unadj, satlife_iyes_unadj_result)
}

satlife_iyes_adj_dis_results <- tibble()
for(i in 1:23){
  satlife_iyes_adj <- lmer(
    satlife_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      adl_any + iadl + 
      (1 | id),
    data = dis_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_adj_result <- broom.mixed::tidy(satlife_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_adj_dis_results <- satlife_iyes_adj_dis_results %>% 
    bind_rows(., satlife_iyes_adj_result)
  rm(satlife_iyes_adj, satlife_iyes_adj_result)
}


#### metafor ####
satlife_iyes_unadj_dis_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_unadj_dis_results, slab = country)

satlife_iyes_adj_dis_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_dis_results, slab = country)

```

### No chronic conditions

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

nodis_iyes_merge <- nodis_iyes_hrs %>% mutate(id = as.character(id)) %>%
  bind_rows(., nodis_iyes_elsa %>% mutate(id = as.character(id))) %>%
  bind_rows(., nodis_iyes_charls %>% mutate(id = as.character(id))) %>%
  bind_rows(., nodis_iyes_share) %>%
  bind_rows(., nodis_iyes_mhas) %>%
  bind_rows(., nodis_iyes_elsi %>% mutate(id = as.character(id))) %>%
  mutate(
    country_names = case_when(
      country == iso[1] ~ names[1],
      country == iso[2] ~ names[2],
      country == iso[3] ~ names[3],
      country == iso[4] ~ names[4],
      country == iso[5] ~ names[5],
      country == iso[6] ~ names[6],
      country == iso[7] ~ names[7],
      country == iso[8] ~ names[8],
      country == iso[9] ~ names[9],
      country == iso[10] ~ names[10],
      country == iso[11] ~ names[11],
      country == iso[12] ~ names[12],
      country == iso[13] ~ names[13],
      country == iso[14] ~ names[14],
      country == iso[15] ~ names[15],
      country == iso[16] ~ names[16],
      country == iso[17] ~ names[17],
      country == iso[18] ~ names[18],
      country == iso[19] ~ names[19],
      country == iso[20] ~ names[20],
      country == iso[21] ~ names[21],
      country == iso[22] ~ names[22],
      country == iso[23] ~ names[23]
    )
  )

```

#### CES-D

```{r}

#### lme4 ####
cesd_iyes_unadj_nodis_results <- tibble()
for(i in 1:23){
  cesd_iyes_unadj <- lmer(
    cesd_stand ~ internet_yes + cwave + (1 | id),
    data = nodis_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_unadj_result <- broom.mixed::tidy(cesd_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_unadj_nodis_results <- cesd_iyes_unadj_nodis_results %>% 
    bind_rows(., cesd_iyes_unadj_result)
  rm(cesd_iyes_unadj, cesd_iyes_unadj_result)
}

cesd_iyes_adj_nodis_results <- tibble()
for(i in 1:23){
  cesd_iyes_adj <- lmer(
    cesd_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      adl_any + iadl + 
      (1 | id),
    data = nodis_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_iyes_adj_result <- broom.mixed::tidy(cesd_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_iyes_adj_nodis_results <- cesd_iyes_adj_nodis_results %>% 
    bind_rows(., cesd_iyes_adj_result)
  rm(cesd_iyes_adj, cesd_iyes_adj_result)
}

#### metafor ####
cesd_iyes_unadj_nodis_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_unadj_nodis_results, slab = country)

cesd_iyes_adj_nodis_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_nodis_results, slab = country)

```

#### Self-rated health

```{r}

#### lme4 ####
shlt_iyes_unadj_nodis_results <- tibble()
for(i in 1:23){
  shlt_iyes_unadj <- lmer(
    shlt_stand ~ internet_yes + cwave + (1 | id),
    data = nodis_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_unadj_result <- broom.mixed::tidy(shlt_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_unadj_nodis_results <- shlt_iyes_unadj_nodis_results %>% 
    bind_rows(., shlt_iyes_unadj_result)
  rm(shlt_iyes_unadj, shlt_iyes_unadj_result)
}

shlt_iyes_adj_nodis_results <- tibble()
for(i in 1:23){
  shlt_iyes_adj <- lmer(
    shlt_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      adl_any + iadl + 
      (1 | id),
    data = nodis_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_iyes_adj_result <- broom.mixed::tidy(shlt_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_iyes_adj_nodis_results <- shlt_iyes_adj_nodis_results %>% 
    bind_rows(., shlt_iyes_adj_result)
  rm(shlt_iyes_adj, shlt_iyes_adj_result)
}


#### metafor ####
shlt_iyes_unadj_nodis_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_unadj_nodis_results, slab = country)

shlt_iyes_adj_nodis_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_nodis_results, slab = country)

```

#### Life satisfaction

```{r}

#### lme4 ####
satlife_iyes_unadj_nodis_results <- tibble()
for(i in 1:23){
  satlife_iyes_unadj <- lmer(
    satlife_stand ~ internet_yes + cwave + (1 | id),
    data = nodis_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_unadj_result <- broom.mixed::tidy(satlife_iyes_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_unadj_nodis_results <- satlife_iyes_unadj_nodis_results %>% 
    bind_rows(., satlife_iyes_unadj_result)
  rm(satlife_iyes_unadj, satlife_iyes_unadj_result)
}

satlife_iyes_adj_nodis_results <- tibble()
for(i in 1:23){
  satlife_iyes_adj <- lmer(
    satlife_stand ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      adl_any + iadl + 
      (1 | id),
    data = nodis_iyes_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_iyes_adj_result <- broom.mixed::tidy(satlife_iyes_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_iyes_adj_nodis_results <- satlife_iyes_adj_nodis_results %>% 
    bind_rows(., satlife_iyes_adj_result)
  rm(satlife_iyes_adj, satlife_iyes_adj_result)
}


#### metafor ####
satlife_iyes_unadj_nodis_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_unadj_nodis_results, slab = country)

satlife_iyes_adj_nodis_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_nodis_results, slab = country)

```

#### Test for interaction

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

outcomes <- c("cesd_stand", "shlt_stand", "satlife_stand")

p4interaction_dis <- tibble()

for(i in 1:3){
  for(j in 1:23){
    formula_reduced <- as.formula(paste(outcomes[i], "~ internet_yes + cwave + age + male + lowedu + lowwealth + lbrf + nonmarried + hhres + smoken + weekdrink + phyinact + dis + adl_any + iadl + (1 | id)"))
    
    interact_reduced <- lmer(
      formula_reduced,
      data = subgroup_iyes_merge %>% filter(country_names == names[j]), 
      control = lmerControl(optimizer = "bobyqa")
      )
    
    formula <- as.formula(paste(outcomes[i], "~ internet_yes*dis + cwave + age + male + lowedu + lowwealth + lbrf + nonmarried + hhres + smoken + weekdrink + phyinact + adl_any + iadl + (1 | id)"))
    
    interact <- lmer(
      formula,
      data = subgroup_iyes_merge %>% filter(country_names == names[j]), 
      control = lmerControl(optimizer = "bobyqa")
      )
    
    interaction_re <- tibble(
      outcome = outcomes[i], country = names[j], 
      p4interaction = anova(interact_reduced, interact, refit = T)$`Pr(>Chisq)`[2]
    )
    
    p4interaction_dis <- p4interaction_dis %>% 
      bind_rows(., interaction_re)
    
    rm(formula_reduced, interact_reduced, formula, interact, interaction_re)
  }
}


```

## Overall

### CES-D

```{r}

#### Data preparation ####
# Age
dat_middle <- cesd_iyes_adj_middle_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(cesd_iyes_adj_middle_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_middle_meta$se), 
      statistic = NA, df = NA, 
      p.value = cesd_iyes_adj_middle_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "middle")
  
dat_old <- cesd_iyes_adj_old_results %>% 
  bind_rows(
    tibble(
      country = "Poland", term = NA, 
      estimate = NA, std.error = NA, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(cesd_iyes_adj_old_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_old_meta$se), 
      statistic = NA, df = NA, 
      p.value = cesd_iyes_adj_old_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "old")

# Gender
dat_male <- cesd_iyes_adj_male_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(cesd_iyes_adj_male_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_male_meta$se), 
      statistic = NA, df = NA, 
      p.value = cesd_iyes_adj_male_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "male")

dat_female <- cesd_iyes_adj_female_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(cesd_iyes_adj_female_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_female_meta$se), 
      statistic = NA, df = NA, 
      p.value = cesd_iyes_adj_female_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "female")

# Marital status
dat_married <- cesd_iyes_adj_married_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(cesd_iyes_adj_married_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_married_meta$se), 
      statistic = NA, df = NA, 
      p.value = cesd_iyes_adj_married_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "married")

dat_nonmarried <- cesd_iyes_adj_nonmarried_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(cesd_iyes_adj_nonmarried_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_nonmarried_meta$se), 
      statistic = NA, df = NA, 
      p.value = cesd_iyes_adj_nonmarried_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "nonmarried")

# Education
dat_pedu <- cesd_iyes_adj_pedu_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(cesd_iyes_adj_pedu_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_pedu_meta$se), 
      statistic = NA, df = NA, 
      p.value = cesd_iyes_adj_pedu_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "pedu")

dat_sedu <- cesd_iyes_adj_sedu_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(cesd_iyes_adj_sedu_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_sedu_meta$se), 
      statistic = NA, df = NA, 
      p.value = cesd_iyes_adj_sedu_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "sedu")

dat_tedu <- cesd_iyes_adj_tedu_results %>% 
  bind_rows(
    tibble(
      country = "Poland", term = NA, 
      estimate = NA, std.error = NA, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(cesd_iyes_adj_tedu_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_tedu_meta$se), 
      statistic = NA, df = NA, 
      p.value = cesd_iyes_adj_tedu_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "tedu")

# Household wealth
dat_lwealth <- cesd_iyes_adj_lwealth_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(cesd_iyes_adj_lwealth_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_lwealth_meta$se), 
      statistic = NA, df = NA, 
      p.value = cesd_iyes_adj_lwealth_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "lwealth")

dat_mwealth <- cesd_iyes_adj_mwealth_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(cesd_iyes_adj_mwealth_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_mwealth_meta$se), 
      statistic = NA, df = NA, 
      p.value = cesd_iyes_adj_mwealth_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "mwealth")

dat_hwealth <- cesd_iyes_adj_hwealth_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(cesd_iyes_adj_hwealth_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_hwealth_meta$se), 
      statistic = NA, df = NA, 
      p.value = cesd_iyes_adj_hwealth_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "hwealth")

# Labor force status
dat_work <- cesd_iyes_adj_work_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(cesd_iyes_adj_work_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_work_meta$se), 
      statistic = NA, df = NA, 
      p.value = cesd_iyes_adj_work_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "work")

dat_retired <- cesd_iyes_adj_retired_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(cesd_iyes_adj_resulttired_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_resulttired_meta$se), 
      statistic = NA, df = NA, 
      p.value = cesd_iyes_adj_resulttired_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "retired")

dat_others <- cesd_iyes_adj_others_results %>% 
  bind_rows(
    tibble(
      country = "China", term = NA, 
      estimate = NA, std.error = NA, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(cesd_iyes_adj_others_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_others_meta$se), 
      statistic = NA, df = NA, 
      p.value = cesd_iyes_adj_others_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "others")

# Current smoking
dat_smoke <- cesd_iyes_adj_smoke_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(cesd_iyes_adj_smoke_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_smoke_meta$se), 
      statistic = NA, df = NA, 
      p.value = cesd_iyes_adj_smoke_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "smoke")

dat_nosmoke <- cesd_iyes_adj_nosmoke_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(cesd_iyes_adj_nosmoke_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_nosmoke_meta$se), 
      statistic = NA, df = NA, 
      p.value = cesd_iyes_adj_nosmoke_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "nosmoke")

# Alcohol consumption
dat_drink <- cesd_iyes_adj_drink_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(cesd_iyes_adj_drink_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_drink_meta$se), 
      statistic = NA, df = NA, 
      p.value = cesd_iyes_adj_drink_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "drink")

dat_nodrink <- cesd_iyes_adj_nodrink_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(cesd_iyes_adj_nodrink_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_nodrink_meta$se), 
      statistic = NA, df = NA, 
      p.value = cesd_iyes_adj_nodrink_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "nodrink")

# Physical activity
dat_phyinact <- cesd_iyes_adj_phyinact_results %>% 
  bind_rows(
    tibble(
      country = "Poland", term = NA, 
      estimate = NA, std.error = NA, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(cesd_iyes_adj_phyinact_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_phyinact_meta$se), 
      statistic = NA, df = NA, 
      p.value = cesd_iyes_adj_phyinact_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "phyinact")

dat_phyact <- cesd_iyes_adj_phyact_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(cesd_iyes_adj_phyact_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_phyact_meta$se), 
      statistic = NA, df = NA, 
      p.value = cesd_iyes_adj_phyact_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "phyact")

# ADL disability
dat_adl <- cesd_iyes_adj_adl_results %>% 
  bind_rows(
    tibble(
      country = "Poland", term = NA, 
      estimate = NA, std.error = NA, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(cesd_iyes_adj_adl_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_adl_meta$se), 
      statistic = NA, df = NA, 
      p.value = cesd_iyes_adj_adl_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "adl")

dat_noadl <- cesd_iyes_adj_noadl_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(cesd_iyes_adj_noadl_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_noadl_meta$se), 
      statistic = NA, df = NA, 
      p.value = cesd_iyes_adj_noadl_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "noadl")

# Chronic conditions
dat_dis <- cesd_iyes_adj_dis_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(cesd_iyes_adj_dis_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_dis_meta$se), 
      statistic = NA, df = NA, 
      p.value = cesd_iyes_adj_dis_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "dis")

dat_nodis <- cesd_iyes_adj_nodis_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(cesd_iyes_adj_nodis_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_nodis_meta$se), 
      statistic = NA, df = NA, 
      p.value = cesd_iyes_adj_nodis_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "nodis")

p4interaction_cesd <- p4interaction_age %>% filter(outcome == "cesd_stand") %>% mutate(subgroup = "middle") %>%
  bind_rows(., p4interaction_male %>% filter(outcome == "cesd_stand") %>% mutate(subgroup = "male")) %>%
  bind_rows(., p4interaction_nonmarried %>% filter(outcome == "cesd_stand") %>% mutate(subgroup = "married")) %>%
  bind_rows(., p4interaction_edu %>% filter(outcome == "cesd_stand") %>% mutate(subgroup = "pedu")) %>%
  bind_rows(., p4interaction_wealth %>% filter(outcome == "cesd_stand") %>% mutate(subgroup = "lwealth")) %>%
  bind_rows(., p4interaction_lbrf %>% filter(outcome == "cesd_stand") %>% mutate(subgroup = "work")) %>%
  bind_rows(., p4interaction_smoke %>% filter(outcome == "cesd_stand") %>% mutate(subgroup = "smoke")) %>%
  bind_rows(., p4interaction_drink %>% filter(outcome == "cesd_stand") %>% mutate(subgroup = "drink")) %>%
  bind_rows(., p4interaction_phyinact %>% filter(outcome == "cesd_stand") %>% mutate(subgroup = "phyact")) %>%
  bind_rows(., p4interaction_adl %>% filter(outcome == "cesd_stand") %>% mutate(subgroup = "noadl")) %>%
  bind_rows(., p4interaction_dis %>% filter(outcome == "cesd_stand") %>% mutate(subgroup = "nodis"))

dat <- dat_middle %>%
  bind_rows(., dat_old) %>%
  bind_rows(., dat_male) %>%
  bind_rows(., dat_female) %>%
  bind_rows(., dat_married) %>%
  bind_rows(., dat_nonmarried) %>%
  bind_rows(., dat_pedu) %>%
  bind_rows(., dat_sedu) %>%
  bind_rows(., dat_tedu) %>%
  bind_rows(., dat_lwealth) %>%
  bind_rows(., dat_mwealth) %>%
  bind_rows(., dat_hwealth) %>%
  bind_rows(., dat_work) %>%
  bind_rows(., dat_retired) %>%
  bind_rows(., dat_others) %>%
  bind_rows(., dat_smoke) %>%
  bind_rows(., dat_nosmoke) %>%
  bind_rows(., dat_drink) %>%
  bind_rows(., dat_nodrink) %>%
  bind_rows(., dat_phyinact) %>%
  bind_rows(., dat_phyact) %>%
  bind_rows(., dat_adl) %>%
  bind_rows(., dat_noadl) %>%
  bind_rows(., dat_dis) %>%
  bind_rows(., dat_nodis) %>%
  left_join(., p4interaction_cesd, by = c("country", "subgroup")) %>%
  mutate(
    country_italic = ifelse(country == "Overall", glue("***{country}***"), glue("{country}")),
    country_italic = factor(country_italic, levels = c("***Overall***", rev(dat_middle$country)[-1])),
    subgroup = 
      factor(
        subgroup, 
        levels = c("middle", "old", "male", "female", "married", "nonmarried", "pedu", "sedu", "tedu", "lwealth", "mwealth", "hwealth", "work", "retired", "others", "smoke", "nosmoke", "drink", "nodrink", "phyact", "phyinact", "noadl", "adl", "nodis", "dis"),
        labels = c("50-64 years", "≥65 years", "Male", "Female", "Married", "Unmarried", "Primary", "Secondary", "Tertiary", "Low", "Middle", "High", "Working", "Retired", "Others", "Current smoking", "No smoking", "Weekly alcohol use", "Less than weekly alcohol use", "Physical activity", "Physical inactivity", "No ADL limitation", "ADL disability", "No chronic conditions", "≥1 chronic conditions")
),
    estimate_new = case_when(
      estimate < -0.5 ~ -0.5,
      estimate > 0.5 ~ 0.5,
      TRUE ~ estimate
    ),
    estimate_text = sprintf("%0.2f", estimate),
    p.sig = ifelse(p.sig == 1, "*", p.sig),
    estimate_p.sig = str_c(estimate_text, p.sig),
    overall_p.sig = ifelse(country == "Overall", estimate_p.sig, NA),
    p4interaction_text = ifelse(p4interaction < 0.05, sprintf("P[int] < 0.05"), NA)
  )

#### Plot ####
rect_cesd <- ggplot(dat, aes(x = subgroup, y = country_italic, fill = estimate_new)) +
  geom_tile(colour = "grey50") +
  geom_text(
    aes(label = overall_p.sig), size = 4, vjust = 0.7, 
    ) + 
  geom_text(
    aes(label = p4interaction_text), parse = T, size = 4, vjust = 0.7, hjust = 0.2
    ) +
  theme_void() +
  theme(
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.text.x = element_blank(),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 16, vjust = 1, angle = 90, face = "bold"),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = .5, l = .25), "cm"),
    plot.title = element_text(size = 16, hjust = .5)
    ) +
  scale_fill_gradientn(
    colours = c("#58539f", "#bbbbd6", "#FFFFFFFF", "#eebabb", "#d86967"),
    limit = c(-0.5, 0.5),
    breaks = c(-0.5, -0.25, 0, 0.25, 0.5),
    labels = c("≤-0.5", -0.25, 0, 0.25, "≥0.5"),
    name = "β"
    ) +
  labs(
    x = NULL,
    y = NULL,
    title = NULL,
    labels = "β"
  ) + 
  annotate(geom = "rect", xmin = 0.5, xmax = 2.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#a6cee3") +
  annotate(geom = "rect", xmin = 2.5, xmax = 4.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#1f78b4") +
  annotate(geom = "rect", xmin = 4.5, xmax = 6.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#b2df8a") +
  annotate(geom = "rect", xmin = 6.5, xmax = 9.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#33a02c") +
  annotate(geom = "rect", xmin = 9.5, xmax = 12.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#fb9a99") +
  annotate(geom = "rect", xmin = 12.5, xmax = 15.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#e31a1c") +
  annotate(geom = "rect", xmin = 15.5, xmax = 17.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#fdbf6f") + 
  annotate(geom = "rect", xmin = 17.5, xmax = 19.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#ff7f00") +
  annotate(geom = "rect", xmin = 19.5, xmax = 21.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#cab2d6") +
  annotate(geom = "rect", xmin = 21.5, xmax = 23.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#6a3d9a") +
  annotate(geom = "rect", xmin = 23.5, xmax = 25.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#ffff99")

```

### Life satisfaction

```{r}

#### Data preparation ####
# Age
dat_middle <- satlife_iyes_adj_middle_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(satlife_iyes_adj_middle_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_middle_meta$se), 
      statistic = NA, df = NA, 
      p.value = satlife_iyes_adj_middle_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "middle")
  
dat_old <- satlife_iyes_adj_old_results %>% 
  bind_rows(
    tibble(
      country = "Poland", term = NA, 
      estimate = NA, std.error = NA, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(satlife_iyes_adj_old_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_old_meta$se), 
      statistic = NA, df = NA, 
      p.value = satlife_iyes_adj_old_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "old")

# Gender
dat_male <- satlife_iyes_adj_male_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(satlife_iyes_adj_male_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_male_meta$se), 
      statistic = NA, df = NA, 
      p.value = satlife_iyes_adj_male_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "male")

dat_female <- satlife_iyes_adj_female_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(satlife_iyes_adj_female_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_female_meta$se), 
      statistic = NA, df = NA, 
      p.value = satlife_iyes_adj_female_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "female")

# Marital status
dat_married <- satlife_iyes_adj_married_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(satlife_iyes_adj_married_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_married_meta$se), 
      statistic = NA, df = NA, 
      p.value = satlife_iyes_adj_married_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "married")

dat_nonmarried <- satlife_iyes_adj_nonmarried_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(satlife_iyes_adj_nonmarried_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_nonmarried_meta$se), 
      statistic = NA, df = NA, 
      p.value = satlife_iyes_adj_nonmarried_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "nonmarried")

# Education
dat_pedu <- satlife_iyes_adj_pedu_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(satlife_iyes_adj_pedu_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_pedu_meta$se), 
      statistic = NA, df = NA, 
      p.value = satlife_iyes_adj_pedu_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "pedu")

dat_sedu <- satlife_iyes_adj_sedu_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(satlife_iyes_adj_sedu_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_sedu_meta$se), 
      statistic = NA, df = NA, 
      p.value = satlife_iyes_adj_sedu_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "sedu")

dat_tedu <- satlife_iyes_adj_tedu_results %>% 
  bind_rows(
    tibble(
      country = "Poland", term = NA, 
      estimate = NA, std.error = NA, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(satlife_iyes_adj_tedu_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_tedu_meta$se), 
      statistic = NA, df = NA, 
      p.value = satlife_iyes_adj_tedu_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "tedu")

# Household wealth
dat_lwealth <- satlife_iyes_adj_lwealth_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(satlife_iyes_adj_lwealth_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_lwealth_meta$se), 
      statistic = NA, df = NA, 
      p.value = satlife_iyes_adj_lwealth_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "lwealth")

dat_mwealth <- satlife_iyes_adj_mwealth_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(satlife_iyes_adj_mwealth_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_mwealth_meta$se), 
      statistic = NA, df = NA, 
      p.value = satlife_iyes_adj_mwealth_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "mwealth")

dat_hwealth <- satlife_iyes_adj_hwealth_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(satlife_iyes_adj_hwealth_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_hwealth_meta$se), 
      statistic = NA, df = NA, 
      p.value = satlife_iyes_adj_hwealth_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "hwealth")

# Labor force status
dat_work <- satlife_iyes_adj_work_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(satlife_iyes_adj_work_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_work_meta$se), 
      statistic = NA, df = NA, 
      p.value = satlife_iyes_adj_work_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "work")

dat_retired <- satlife_iyes_adj_retired_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(satlife_iyes_adj_resulttired_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_resulttired_meta$se), 
      statistic = NA, df = NA, 
      p.value = satlife_iyes_adj_resulttired_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "retired")

dat_others <- satlife_iyes_adj_others_results %>% 
  bind_rows(
    tibble(
      country = "China", term = NA, 
      estimate = NA, std.error = NA, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(satlife_iyes_adj_others_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_others_meta$se), 
      statistic = NA, df = NA, 
      p.value = satlife_iyes_adj_others_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "others")

# Current smoking
dat_smoke <- satlife_iyes_adj_smoke_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(satlife_iyes_adj_smoke_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_smoke_meta$se), 
      statistic = NA, df = NA, 
      p.value = satlife_iyes_adj_smoke_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "smoke")

dat_nosmoke <- satlife_iyes_adj_nosmoke_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(satlife_iyes_adj_nosmoke_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_nosmoke_meta$se), 
      statistic = NA, df = NA, 
      p.value = satlife_iyes_adj_nosmoke_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "nosmoke")

# Alcohol consumption
dat_drink <- satlife_iyes_adj_drink_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(satlife_iyes_adj_drink_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_drink_meta$se), 
      statistic = NA, df = NA, 
      p.value = satlife_iyes_adj_drink_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "drink")

dat_nodrink <- satlife_iyes_adj_nodrink_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(satlife_iyes_adj_nodrink_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_nodrink_meta$se), 
      statistic = NA, df = NA, 
      p.value = satlife_iyes_adj_nodrink_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "nodrink")

# Physical activity
dat_phyinact <- satlife_iyes_adj_phyinact_results %>% 
  bind_rows(
    tibble(
      country = "Poland", term = NA, 
      estimate = NA, std.error = NA, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(satlife_iyes_adj_phyinact_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_phyinact_meta$se), 
      statistic = NA, df = NA, 
      p.value = satlife_iyes_adj_phyinact_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "phyinact")

dat_phyact <- satlife_iyes_adj_phyact_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(satlife_iyes_adj_phyact_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_phyact_meta$se), 
      statistic = NA, df = NA, 
      p.value = satlife_iyes_adj_phyact_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "phyact")

# ADL disability
dat_adl <- satlife_iyes_adj_adl_results %>% 
  bind_rows(
    tibble(
      country = "Poland", term = NA, 
      estimate = NA, std.error = NA, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(satlife_iyes_adj_adl_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_adl_meta$se), 
      statistic = NA, df = NA, 
      p.value = satlife_iyes_adj_adl_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "adl")

dat_noadl <- satlife_iyes_adj_noadl_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(satlife_iyes_adj_noadl_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_noadl_meta$se), 
      statistic = NA, df = NA, 
      p.value = satlife_iyes_adj_noadl_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "noadl")

# Chronic conditions
dat_dis <- satlife_iyes_adj_dis_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(satlife_iyes_adj_dis_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_dis_meta$se), 
      statistic = NA, df = NA, 
      p.value = satlife_iyes_adj_dis_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "dis")

dat_nodis <- satlife_iyes_adj_nodis_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(satlife_iyes_adj_nodis_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_nodis_meta$se), 
      statistic = NA, df = NA, 
      p.value = satlife_iyes_adj_nodis_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "nodis")

p4interaction_satlife <- p4interaction_age %>% filter(outcome == "satlife_stand") %>% mutate(subgroup = "middle") %>%
  bind_rows(., p4interaction_male %>% filter(outcome == "satlife_stand") %>% mutate(subgroup = "male")) %>%
  bind_rows(., p4interaction_nonmarried %>% filter(outcome == "satlife_stand") %>% mutate(subgroup = "married")) %>%
  bind_rows(., p4interaction_edu %>% filter(outcome == "satlife_stand") %>% mutate(subgroup = "pedu")) %>%
  bind_rows(., p4interaction_wealth %>% filter(outcome == "satlife_stand") %>% mutate(subgroup = "lwealth")) %>%
  bind_rows(., p4interaction_lbrf %>% filter(outcome == "satlife_stand") %>% mutate(subgroup = "work")) %>%
  bind_rows(., p4interaction_smoke %>% filter(outcome == "satlife_stand") %>% mutate(subgroup = "smoke")) %>%
  bind_rows(., p4interaction_drink %>% filter(outcome == "satlife_stand") %>% mutate(subgroup = "drink")) %>%
  bind_rows(., p4interaction_phyinact %>% filter(outcome == "satlife_stand") %>% mutate(subgroup = "phyact")) %>%
  bind_rows(., p4interaction_adl %>% filter(outcome == "satlife_stand") %>% mutate(subgroup = "noadl")) %>%
  bind_rows(., p4interaction_dis %>% filter(outcome == "satlife_stand") %>% mutate(subgroup = "nodis"))

dat <- dat_middle %>%
  bind_rows(., dat_old) %>%
  bind_rows(., dat_male) %>%
  bind_rows(., dat_female) %>%
  bind_rows(., dat_married) %>%
  bind_rows(., dat_nonmarried) %>%
  bind_rows(., dat_pedu) %>%
  bind_rows(., dat_sedu) %>%
  bind_rows(., dat_tedu) %>%
  bind_rows(., dat_lwealth) %>%
  bind_rows(., dat_mwealth) %>%
  bind_rows(., dat_hwealth) %>%
  bind_rows(., dat_work) %>%
  bind_rows(., dat_retired) %>%
  bind_rows(., dat_others) %>%
  bind_rows(., dat_smoke) %>%
  bind_rows(., dat_nosmoke) %>%
  bind_rows(., dat_drink) %>%
  bind_rows(., dat_nodrink) %>%
  bind_rows(., dat_phyinact) %>%
  bind_rows(., dat_phyact) %>%
  bind_rows(., dat_adl) %>%
  bind_rows(., dat_noadl) %>%
  bind_rows(., dat_dis) %>%
  bind_rows(., dat_nodis) %>%
  left_join(., p4interaction_satlife, by = c("country", "subgroup")) %>%
  mutate(
    country_italic = ifelse(country == "Overall", glue("***{country}***"), glue("{country}")),
    country_italic = factor(country_italic, levels = c("***Overall***", rev(dat_middle$country)[-1])),
    subgroup = 
      factor(
        subgroup, 
        levels = c("middle", "old", "male", "female", "married", "nonmarried", "pedu", "sedu", "tedu", "lwealth", "mwealth", "hwealth", "work", "retired", "others", "smoke", "nosmoke", "drink", "nodrink", "phyact", "phyinact", "noadl", "adl", "nodis", "dis"),
        labels = c("50-64 years", "≥65 years", "Male", "Female", "Married", "Unmarried", "Primary", "Secondary", "Tertiary", "Low", "Middle", "High", "Working", "Retired", "Others", "Current smoking", "No smoking", "Weekly alcohol use", "Less than weekly alcohol use", "Physical activity", "Physical inactivity", "No ADL limitation", "ADL disability", "No chronic conditions", "≥1 chronic conditions")
),
    estimate_new = case_when(
      estimate < -0.5 ~ -0.5,
      estimate > 0.5 ~ 0.5,
      TRUE ~ estimate
    ),
    estimate_text = sprintf("%0.2f", estimate),
    p.sig = ifelse(p.sig == 1, "*", p.sig),
    estimate_p.sig = str_c(estimate_text, p.sig),
    overall_p.sig = ifelse(country == "Overall", estimate_p.sig, NA),
    p4interaction_text = ifelse(p4interaction < 0.05, sprintf("P[int] < 0.05"), NA)
  ) 
dat[dat$country == "Overall" & dat$subgroup %in% c("Unmarried", "Working", "Physical inactivity"), "overall_p.sig"] <- dat[dat$country == "Overall" & dat$subgroup %in% c("Unmarried", "Working", "Physical inactivity"), "estimate_text"]
  
#### Plot ####
rect_satlife <- ggplot(dat, aes(x = subgroup, y = country_italic, fill = estimate_new)) +
  geom_tile(colour = "grey50") +
  geom_text(
    aes(label = overall_p.sig), size = 4, vjust = 0.7,
    ) + 
  geom_text(
    aes(label = p4interaction_text), parse = T, size = 4, vjust = 0.7, hjust = 0.2
    ) +
  theme_void() +
  theme(
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.text.x = element_blank(),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 16, vjust = 1, angle = 90, face = "bold"),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = .5, l = .25), "cm"),
    plot.title = element_text(size = 16, hjust = .5)
    ) +
  scale_fill_gradientn(
    colours = c("#58539f", "#bbbbd6", "#FFFFFFFF", "#eebabb", "#d86967"),
    limit = c(-0.5, 0.5),
    breaks = c(-0.5, -0.25, 0, 0.25, 0.5),
    labels = c("≤-0.5", -0.25, 0, 0.25, "≥0.5"),
    name = "β"
    ) +
  labs(
    x = NULL,
    y = NULL,
    title = NULL,
    labels = "β"
  ) + 
  annotate(geom = "rect", xmin = 0.5, xmax = 2.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#a6cee3") + 
  annotate(geom = "rect", xmin = 2.5, xmax = 4.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#1f78b4") +
  annotate(geom = "rect", xmin = 4.5, xmax = 6.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#b2df8a") +
  annotate(geom = "rect", xmin = 6.5, xmax = 9.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#33a02c") +
  annotate(geom = "rect", xmin = 9.5, xmax = 12.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#fb9a99") +
  annotate(geom = "rect", xmin = 12.5, xmax = 15.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#e31a1c") +
  annotate(geom = "rect", xmin = 15.5, xmax = 17.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#fdbf6f") + 
  annotate(geom = "rect", xmin = 17.5, xmax = 19.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#ff7f00") +
  annotate(geom = "rect", xmin = 19.5, xmax = 21.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#cab2d6") +
  annotate(geom = "rect", xmin = 21.5, xmax = 23.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#6a3d9a") +
  annotate(geom = "rect", xmin = 23.5, xmax = 25.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#ffff99")

```

### Self-rated health

```{r}

#### Data preparation ####
# Age
dat_middle <- shlt_iyes_adj_middle_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(shlt_iyes_adj_middle_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_middle_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_middle_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "middle")
  
dat_old <- shlt_iyes_adj_old_results %>% 
  bind_rows(
    tibble(
      country = "Poland", term = NA, 
      estimate = NA, std.error = NA, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(shlt_iyes_adj_old_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_old_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_old_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "old")

# Gender
dat_male <- shlt_iyes_adj_male_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(shlt_iyes_adj_male_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_male_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_male_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "male")

dat_female <- shlt_iyes_adj_female_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(shlt_iyes_adj_female_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_female_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_female_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "female")

# Marital status
dat_married <- shlt_iyes_adj_married_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(shlt_iyes_adj_married_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_married_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_married_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "married")

dat_nonmarried <- shlt_iyes_adj_nonmarried_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(shlt_iyes_adj_nonmarried_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_nonmarried_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_nonmarried_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "nonmarried")

# Education
dat_pedu <- shlt_iyes_adj_pedu_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(shlt_iyes_adj_pedu_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_pedu_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_pedu_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "pedu")

dat_sedu <- shlt_iyes_adj_sedu_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(shlt_iyes_adj_sedu_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_sedu_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_sedu_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "sedu")

dat_tedu <- shlt_iyes_adj_tedu_results %>% 
  bind_rows(
    tibble(
      country = "Poland", term = NA, 
      estimate = NA, std.error = NA, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(shlt_iyes_adj_tedu_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_tedu_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_tedu_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "tedu")

# Household wealth
dat_lwealth <- shlt_iyes_adj_lwealth_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(shlt_iyes_adj_lwealth_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_lwealth_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_lwealth_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "lwealth")

dat_mwealth <- shlt_iyes_adj_mwealth_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(shlt_iyes_adj_mwealth_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_mwealth_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_mwealth_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "mwealth")

dat_hwealth <- shlt_iyes_adj_hwealth_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(shlt_iyes_adj_hwealth_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_hwealth_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_hwealth_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "hwealth")

# Labor force status
dat_work <- shlt_iyes_adj_work_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(shlt_iyes_adj_work_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_work_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_work_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "work")

dat_retired <- shlt_iyes_adj_retired_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(shlt_iyes_adj_resulttired_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_resulttired_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_resulttired_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "retired")

dat_others <- shlt_iyes_adj_others_results %>% 
  bind_rows(
    tibble(
      country = "China", term = NA, 
      estimate = NA, std.error = NA, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(shlt_iyes_adj_others_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_others_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_others_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "others")

# Current smoking
dat_smoke <- shlt_iyes_adj_smoke_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(shlt_iyes_adj_smoke_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_smoke_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_smoke_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "smoke")

dat_nosmoke <- shlt_iyes_adj_nosmoke_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(shlt_iyes_adj_nosmoke_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_nosmoke_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_nosmoke_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "nosmoke")

# Alcohol consumption
dat_drink <- shlt_iyes_adj_drink_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(shlt_iyes_adj_drink_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_drink_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_drink_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "drink")

dat_nodrink <- shlt_iyes_adj_nodrink_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(shlt_iyes_adj_nodrink_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_nodrink_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_nodrink_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "nodrink")

# Physical activity
dat_phyinact <- shlt_iyes_adj_phyinact_results %>% 
  bind_rows(
    tibble(
      country = "Poland", term = NA, 
      estimate = NA, std.error = NA, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(shlt_iyes_adj_phyinact_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_phyinact_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_phyinact_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "phyinact")

dat_phyact <- shlt_iyes_adj_phyact_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(shlt_iyes_adj_phyact_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_phyact_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_phyact_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "phyact")

# ADL disability
dat_adl <- shlt_iyes_adj_adl_results %>% 
  bind_rows(
    tibble(
      country = "Poland", term = NA, 
      estimate = NA, std.error = NA, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  arrange(country) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(shlt_iyes_adj_adl_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_adl_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_adl_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "adl")

dat_noadl <- shlt_iyes_adj_noadl_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(shlt_iyes_adj_noadl_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_noadl_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_noadl_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "noadl")

# Chronic conditions
dat_dis <- shlt_iyes_adj_dis_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(shlt_iyes_adj_dis_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_dis_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_dis_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "dis")

dat_nodis <- shlt_iyes_adj_nodis_results %>% 
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(shlt_iyes_adj_nodis_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_nodis_meta$se), 
      statistic = NA, df = NA, 
      p.value = shlt_iyes_adj_nodis_meta$pval, p.sig = ifelse(p.value < 0.05, 1, NA)
      )
    ) %>% 
  mutate(subgroup = "nodis")

p4interaction_shlt <- p4interaction_age %>% filter(outcome == "shlt_stand") %>% mutate(subgroup = "middle") %>%
  bind_rows(., p4interaction_male %>% filter(outcome == "shlt_stand") %>% mutate(subgroup = "male")) %>%
  bind_rows(., p4interaction_nonmarried %>% filter(outcome == "shlt_stand") %>% mutate(subgroup = "married")) %>%
  bind_rows(., p4interaction_edu %>% filter(outcome == "shlt_stand") %>% mutate(subgroup = "pedu")) %>%
  bind_rows(., p4interaction_wealth %>% filter(outcome == "shlt_stand") %>% mutate(subgroup = "lwealth")) %>%
  bind_rows(., p4interaction_lbrf %>% filter(outcome == "shlt_stand") %>% mutate(subgroup = "work")) %>%
  bind_rows(., p4interaction_smoke %>% filter(outcome == "shlt_stand") %>% mutate(subgroup = "smoke")) %>%
  bind_rows(., p4interaction_drink %>% filter(outcome == "shlt_stand") %>% mutate(subgroup = "drink")) %>%
  bind_rows(., p4interaction_phyinact %>% filter(outcome == "shlt_stand") %>% mutate(subgroup = "phyact")) %>%
  bind_rows(., p4interaction_adl %>% filter(outcome == "shlt_stand") %>% mutate(subgroup = "noadl")) %>%
  bind_rows(., p4interaction_dis %>% filter(outcome == "shlt_stand") %>% mutate(subgroup = "nodis"))

dat <- dat_middle %>%
  bind_rows(., dat_old) %>%
  bind_rows(., dat_male) %>%
  bind_rows(., dat_female) %>%
  bind_rows(., dat_married) %>%
  bind_rows(., dat_nonmarried) %>%
  bind_rows(., dat_pedu) %>%
  bind_rows(., dat_sedu) %>%
  bind_rows(., dat_tedu) %>%
  bind_rows(., dat_lwealth) %>%
  bind_rows(., dat_mwealth) %>%
  bind_rows(., dat_hwealth) %>%
  bind_rows(., dat_work) %>%
  bind_rows(., dat_retired) %>%
  bind_rows(., dat_others) %>%
  bind_rows(., dat_smoke) %>%
  bind_rows(., dat_nosmoke) %>%
  bind_rows(., dat_drink) %>%
  bind_rows(., dat_nodrink) %>%
  bind_rows(., dat_phyinact) %>%
  bind_rows(., dat_phyact) %>%
  bind_rows(., dat_adl) %>%
  bind_rows(., dat_noadl) %>%
  bind_rows(., dat_dis) %>%
  bind_rows(., dat_nodis) %>%
  left_join(., p4interaction_shlt, by = c("country", "subgroup")) %>%
  mutate(
    country_italic = ifelse(country == "Overall", glue("***{country}***"), glue("{country}")),
    country_italic = factor(country_italic, levels = c("***Overall***", rev(dat_middle$country)[-1])),
    subgroup = 
      factor(
        subgroup, 
        levels = c("middle", "old", "male", "female", "married", "nonmarried", "pedu", "sedu", "tedu", "lwealth", "mwealth", "hwealth", "work", "retired", "others", "smoke", "nosmoke", "drink", "nodrink", "phyact", "phyinact", "noadl", "adl", "nodis", "dis"),
        labels = c("50-64 years", "≥65 years", "Male", "Female", "Married", "Unmarried", "Primary", "Secondary", "Tertiary", "Low", "Middle", "High", "Working", "Retired", "Others", "Current smoking", "No smoking", "Weekly alcohol use", "Less than weekly alcohol use", "Physical activity", "Physical inactivity", "No ADL limitation", "ADL disability", "No chronic conditions", "≥1 chronic conditions")
),
    estimate_new = case_when(
      estimate < -0.5 ~ -0.5,
      estimate > 0.5 ~ 0.5,
      TRUE ~ estimate
    ),
    estimate_text = sprintf("%0.2f", estimate),
    p.sig = ifelse(p.sig == 1, "*", p.sig),
    estimate_p.sig = str_c(estimate_text, p.sig),
    overall_p.sig = ifelse(country == "Overall", estimate_p.sig, NA),
    p4interaction_text = ifelse(p4interaction < 0.05, sprintf("P[int] < 0.05"), NA)
  )
  
#### Plot ####
rect_shlt <- ggplot(dat, aes(x = subgroup, y = country_italic, fill = estimate_new)) +
  geom_tile(colour = "grey50") +
  geom_text(
    aes(label = overall_p.sig), size = 4, vjust = 0.7,
    ) + 
  geom_text(
    aes(label = p4interaction_text), parse = T, size = 4, vjust = 0.7, hjust = 0.2
    ) +
  theme_void() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", hjust = 1, vjust = 1, angle = 45),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 16, vjust = 1, angle = 90, face = "bold"),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = .5, l = .25), "cm"),
    plot.title = element_text(size = 16, hjust = .5)
    ) +
  scale_fill_gradientn(
    colours = c("#58539f", "#bbbbd6", "#FFFFFFFF", "#eebabb", "#d86967"),
    limit = c(-0.5, 0.5),
    breaks = c(-0.5, -0.25, 0, 0.25, 0.5),
    labels = c("≤-0.5", -0.25, 0, 0.25, "≥0.5"),
    name = "β"
    ) +
  labs(
    x = NULL,
    y = NULL,
    title = NULL,
    labels = "β"
  ) + 
  annotate(geom = "rect", xmin = 0.5, xmax = 2.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#a6cee3") + 
  annotate(geom = "rect", xmin = 2.5, xmax = 4.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#1f78b4") +
  annotate(geom = "rect", xmin = 4.5, xmax = 6.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#b2df8a") +
  annotate(geom = "rect", xmin = 6.5, xmax = 9.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#33a02c") +
  annotate(geom = "rect", xmin = 9.5, xmax = 12.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#fb9a99") +
  annotate(geom = "rect", xmin = 12.5, xmax = 15.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#e31a1c") +
  annotate(geom = "rect", xmin = 15.5, xmax = 17.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#fdbf6f") + 
  annotate(geom = "rect", xmin = 17.5, xmax = 19.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#ff7f00") +
  annotate(geom = "rect", xmin = 19.5, xmax = 21.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#cab2d6") +
  annotate(geom = "rect", xmin = 21.5, xmax = 23.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#6a3d9a") +
  annotate(geom = "rect", xmin = 23.5, xmax = 25.5, ymin = -0.5, ymax = 0.2, alpha = 1, fill = "#ffff99")


```

### Figure 3: Associations of Internet use frequency with mental health by subgroups

```{r}

dat_legend <- dat %>%  
  mutate(
    category = case_when(
      subgroup %in% c("50-64 years", "≥65 years") ~ "age",
      subgroup %in% c("Male", "Female") ~ "gender",
      subgroup %in% c("Married", "Unmarried") ~ "marital",

      subgroup %in% c("Primary", "Secondary", "Tertiary") ~ "edu",
      subgroup %in% c("Low", "Middle", "High") ~ "wealth",
      subgroup %in% c("Working", "Retired", "Others") ~ "lbrf",
      
      subgroup %in% c("Current smoking", "No smoking") ~ "smoke",
      subgroup %in% c("Weekly alcohol use", "Less than weekly alcohol use") ~ "drink",
      subgroup %in% c("Physical activity", "Physical inactivity") ~ "phyact",
      
      subgroup %in% c("No chronic conditions", "≥1 chronic conditions") ~ "disease",
      subgroup %in% c("No ADL limitation", "ADL disability") ~ "disability",
      TRUE ~ NA_character_
    ),
    category = factor(category, levels = c("age", "gender", "marital", "edu", "wealth", "lbrf", "smoke", "drink", "phyact", "disease", "disability"), labels = c("Age", "Gender", "Marital status", "Education", "Household wealth", "Labor force status", "Current smoking", "Alcohol consumption", "Physical activity status", "ADL disability", "Chronic conditions"))
  )

legend_1 <- ggplot(dat_legend, aes(x = category, y = estimate, fill = category)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(
    values = c("#a6cee3", "#1f78b4", "#b2df8a", "#33a02c", "#fb9a99", "#e31a1c", "#fdbf6f", "#ff7f00", "#cab2d6", "#6a3d9a", "#ffff99"),
  ) + 
  guides(fill = guide_legend(byrow = T)) +
  theme(
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "right",
    legend.key.size = unit(1.5, "lines")
    )

legend_2 <- ggplot(dat, aes(x = subgroup, y = country_italic, fill = estimate_new)) +
  geom_tile(colour = "grey50") +
  theme_void() +
  theme(
    legend.position = "right"
    ) +
  scale_fill_gradientn(
    colours = c("#58539f", "#bbbbd6", "#FFFFFFFF", "#eebabb", "#d86967"),
    limit = c(-0.5, 0.5),
    breaks = c(-0.5, -0.25, 0, 0.25, 0.5),
    labels = c("≤-0.5", -0.25, 0, 0.25, "≥0.5"),
    name = "β"
    ) +
  labs(
    x = NULL,
    y = NULL,
    title = NULL
  ) & 
  guides(fill =
    guide_colourbar(
      barwidth = unit(0.3, "in"), barheight = unit(3, "in"),
      label.theme = element_text(size = 16, colour = "black", angle = 0),
      title.theme = element_text(size = 16, colour = "black", angle = 0, hjust = 0.1)
  )
)

rect_pool <- wrap_elements(
  wrap_elements(rect_cesd) + wrap_elements(rect_satlife) + wrap_elements(rect_shlt) + 
    plot_layout(nrow = 3, heights = c(0.75, 0.75, 1)) &
    plot_annotation(tag_levels = "a")
  )

design <- "
AAAAAAAAAA##
AAAAAAAAAA##
AAAAAAAAAABB
AAAAAAAAAABB
AAAAAAAAAAC#
AAAAAAAAAAC#
AAAAAAAAAA##
AAAAAAAAAA##
"

heatmap_pool <- wrap_plots(
  rect_pool, wrap_elements(get_legend(legend_1)), wrap_elements(get_legend(legend_2)), 
  design = design
  )

ggsave(str_c(getwd(), "/results/Figure/Figure 3_Heatmap.tiff"), plot = heatmap_pool, width = 16, height = 26, unit = "in", dpi = 300, device = "tiff")

```

# Internet use and genetic risk

```{r}

iso <- c(826, 840)

names <- c("England", "USA")

final_iyes_pgs_merge <- final_iyes_pgs_hrs %>% mutate(id = as.character(id)) %>%
  bind_rows(., final_iyes_pgs_elsa %>% mutate(id = as.character(id))) %>%
  mutate(
    country_names = case_when(
      country == iso[1] ~ names[1],
      country == iso[2] ~ names[2]
    )
  )

final_iyes_pgs_hrs <- final_iyes_pgs_hrs %>%
  mutate(
    jointdepre = str_c(internet_yes, highdeprepgs, sep = "."),
    jointdepre = factor(jointdepre, level = c("no.high", "yes.high", "no.intermediate", "yes.intermediate", "no.low", "yes.low")),
    jointwellb = str_c(internet_yes, highwellbpgs, sep = "."),
    jointwellb = factor(jointwellb, level = c("no.high", "yes.high", "no.intermediate", "yes.intermediate", "no.low", "yes.low"))
    )

final_iyes_pgs_elsa <- final_iyes_pgs_elsa %>%
  mutate(
    jointdepre = str_c(internet_yes, highdeprepgs, sep = "."),
    jointdepre = factor(jointdepre, level = c("no.high", "yes.high", "no.intermediate", "yes.intermediate", "no.low", "yes.low")),
    jointwellb = str_c(internet_yes, highwellbpgs, sep = "."),
    jointwellb = factor(jointwellb, level = c("no.high", "yes.high", "no.intermediate", "yes.intermediate", "no.low", "yes.low"))
    )

```

## Stratification analyses

### Depressive symptoms PGS

```{r}

#### CES-D ####
# HRS
cesd_iyes_adj_deprepgs_low_hrs <- lmer(
    cesd_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs %>% filter(highdeprepgs == "low"), 
    control = lmerControl(optimizer = "bobyqa")
    )

cesd_iyes_adj_deprepgs_interm_hrs <- lmer(
    cesd_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs %>% filter(highdeprepgs == "intermediate"), 
    control = lmerControl(optimizer = "bobyqa")
    )

cesd_iyes_adj_deprepgs_high_hrs <- lmer(
    cesd_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs %>% filter(highdeprepgs == "high"), 
    control = lmerControl(optimizer = "bobyqa")
    )

cesd_iyes_adj_deprepgs_re_hrs <- broom.mixed::tidy(cesd_iyes_adj_deprepgs_low_hrs) %>% slice(2) %>% mutate(deprepgs = "low") %>%
  bind_rows(broom.mixed::tidy(cesd_iyes_adj_deprepgs_interm_hrs) %>% slice(2) %>% mutate(deprepgs = "intermediate")) %>%
  bind_rows(broom.mixed::tidy(cesd_iyes_adj_deprepgs_high_hrs) %>% slice(2) %>% mutate(deprepgs = "high")) %>%
  mutate(country = "USA", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  dplyr::select(country, deprepgs, term, estimate, std.error, statistic, df, p.value, p.sig)

# ELSA
cesd_iyes_adj_deprepgs_low_elsa <- lmer(
    cesd_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa %>% filter(highdeprepgs == "low"), 
    control = lmerControl(optimizer = "bobyqa")
    )

cesd_iyes_adj_deprepgs_interm_elsa <- lmer(
    cesd_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa %>% filter(highdeprepgs == "intermediate"), 
    control = lmerControl(optimizer = "bobyqa")
    )

cesd_iyes_adj_deprepgs_high_elsa <- lmer(
    cesd_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa %>% filter(highdeprepgs == "high"), 
    control = lmerControl(optimizer = "bobyqa")
    )

cesd_iyes_adj_deprepgs_re_elsa <- broom.mixed::tidy(cesd_iyes_adj_deprepgs_low_elsa) %>% slice(2) %>% mutate(deprepgs = "low") %>%
  bind_rows(broom.mixed::tidy(cesd_iyes_adj_deprepgs_interm_elsa) %>% slice(2) %>% mutate(deprepgs = "intermediate")) %>%
  bind_rows(broom.mixed::tidy(cesd_iyes_adj_deprepgs_high_elsa) %>% slice(2) %>% mutate(deprepgs = "high")) %>%
  mutate(country = "England", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  dplyr::select(country, deprepgs, term, estimate, std.error, statistic, df, p.value, p.sig)

cesd_iyes_adj_deprepgs_re <- bind_rows(cesd_iyes_adj_deprepgs_re_hrs, cesd_iyes_adj_deprepgs_re_elsa)

cesd_iyes_adj_deprepgs_hrs <- lmer(
    cesd_stand  ~ internet_yes + highdeprepgs + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs, 
    control = lmerControl(optimizer = "bobyqa")
    )

cesd_iyes_adj_deprepgs_int_hrs <- lmer(
    cesd_stand  ~ internet_yes*highdeprepgs + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs, 
    control = lmerControl(optimizer = "bobyqa")
    )

p_cesd_deprepgs_int_hrs <- anova(cesd_iyes_adj_deprepgs_hrs, cesd_iyes_adj_deprepgs_int_hrs, refit = T)

cesd_iyes_adj_deprepgs_elsa <- lmer(
    cesd_stand  ~ internet_yes + highdeprepgs + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa, 
    control = lmerControl(optimizer = "bobyqa")
    )

cesd_iyes_adj_deprepgs_int_elsa <- lmer(
    cesd_stand  ~ internet_yes*highdeprepgs + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa, 
    control = lmerControl(optimizer = "bobyqa")
    )

p_cesd_deprepgs_int_elsa <- anova(cesd_iyes_adj_deprepgs_elsa, cesd_iyes_adj_deprepgs_int_elsa, refit = T)


#### Self-rated health ####
# HRS
shlt_iyes_adj_deprepgs_low_hrs <- lmer(
    shlt_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs %>% filter(highdeprepgs == "low"), 
    control = lmerControl(optimizer = "bobyqa")
    )

shlt_iyes_adj_deprepgs_interm_hrs <- lmer(
    shlt_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs %>% filter(highdeprepgs == "intermediate"), 
    control = lmerControl(optimizer = "bobyqa")
    )

shlt_iyes_adj_deprepgs_high_hrs <- lmer(
    shlt_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs %>% filter(highdeprepgs == "high"), 
    control = lmerControl(optimizer = "bobyqa")
    )

shlt_iyes_adj_deprepgs_re_hrs <- broom.mixed::tidy(shlt_iyes_adj_deprepgs_low_hrs) %>% slice(2) %>% mutate(deprepgs = "low") %>%
  bind_rows(broom.mixed::tidy(shlt_iyes_adj_deprepgs_interm_hrs) %>% slice(2) %>% mutate(deprepgs = "intermediate")) %>%
  bind_rows(broom.mixed::tidy(shlt_iyes_adj_deprepgs_high_hrs) %>% slice(2) %>% mutate(deprepgs = "high")) %>%
  mutate(country = "USA", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  dplyr::select(country, deprepgs, term, estimate, std.error, statistic, df, p.value, p.sig)


# ELSA
shlt_iyes_adj_deprepgs_low_elsa <- lmer(
    shlt_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa %>% filter(highdeprepgs == "low"), 
    control = lmerControl(optimizer = "bobyqa")
    )

shlt_iyes_adj_deprepgs_interm_elsa <- lmer(
    shlt_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa %>% filter(highdeprepgs == "intermediate"), 
    control = lmerControl(optimizer = "bobyqa")
    )

shlt_iyes_adj_deprepgs_high_elsa <- lmer(
    shlt_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa %>% filter(highdeprepgs == "high"), 
    control = lmerControl(optimizer = "bobyqa")
    )

shlt_iyes_adj_deprepgs_re_elsa <- broom.mixed::tidy(shlt_iyes_adj_deprepgs_low_elsa) %>% slice(2) %>% mutate(deprepgs = "low") %>%
  bind_rows(broom.mixed::tidy(shlt_iyes_adj_deprepgs_interm_elsa) %>% slice(2) %>% mutate(deprepgs = "intermediate")) %>%
  bind_rows(broom.mixed::tidy(shlt_iyes_adj_deprepgs_high_elsa) %>% slice(2) %>% mutate(deprepgs = "high")) %>%
  mutate(country = "England", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  dplyr::select(country, deprepgs, term, estimate, std.error, statistic, df, p.value, p.sig)

shlt_iyes_adj_deprepgs_re <- bind_rows(shlt_iyes_adj_deprepgs_re_hrs, shlt_iyes_adj_deprepgs_re_elsa)


shlt_iyes_adj_deprepgs_hrs <- lmer(
    shlt_stand  ~ internet_yes + highdeprepgs + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs, 
    control = lmerControl(optimizer = "bobyqa")
    )

shlt_iyes_adj_deprepgs_int_hrs <- lmer(
    shlt_stand  ~ internet_yes*highdeprepgs + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs, 
    control = lmerControl(optimizer = "bobyqa")
    )

p_shlt_deprepgs_int_hrs <- anova(shlt_iyes_adj_deprepgs_hrs, shlt_iyes_adj_deprepgs_int_hrs, refit = T)

shlt_iyes_adj_deprepgs_elsa <- lmer(
    shlt_stand  ~ internet_yes + highdeprepgs + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa, 
    control = lmerControl(optimizer = "bobyqa")
    )

shlt_iyes_adj_deprepgs_int_elsa <- lmer(
    shlt_stand  ~ internet_yes*highdeprepgs + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa, 
    control = lmerControl(optimizer = "bobyqa")
    )

p_shlt_deprepgs_int_elsa <- anova(shlt_iyes_adj_deprepgs_elsa, shlt_iyes_adj_deprepgs_int_elsa, refit = T)

#### Life satisfaction ####
# HRS
satlife_iyes_adj_deprepgs_low_hrs <- lmer(
    satlife_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs %>% filter(highdeprepgs == "low"), 
    control = lmerControl(optimizer = "bobyqa")
    )

satlife_iyes_adj_deprepgs_interm_hrs <- lmer(
    satlife_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs %>% filter(highdeprepgs == "intermediate"), 
    control = lmerControl(optimizer = "bobyqa")
    )

satlife_iyes_adj_deprepgs_high_hrs <- lmer(
    satlife_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs %>% filter(highdeprepgs == "high"), 
    control = lmerControl(optimizer = "bobyqa")
    )

satlife_iyes_adj_deprepgs_re_hrs <- broom.mixed::tidy(satlife_iyes_adj_deprepgs_low_hrs) %>% slice(2) %>% mutate(deprepgs = "low") %>%
  bind_rows(broom.mixed::tidy(satlife_iyes_adj_deprepgs_interm_hrs) %>% slice(2) %>% mutate(deprepgs = "intermediate")) %>%
  bind_rows(broom.mixed::tidy(satlife_iyes_adj_deprepgs_high_hrs) %>% slice(2) %>% mutate(deprepgs = "high")) %>%
  mutate(country = "USA", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  dplyr::select(country, deprepgs, term, estimate, std.error, statistic, df, p.value, p.sig)

# ELSA
satlife_iyes_adj_deprepgs_low_elsa <- lmer(
    satlife_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa %>% filter(highdeprepgs == "low"), 
    control = lmerControl(optimizer = "bobyqa")
    )

satlife_iyes_adj_deprepgs_interm_elsa <- lmer(
    satlife_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa %>% filter(highdeprepgs == "intermediate"), 
    control = lmerControl(optimizer = "bobyqa")
    )

satlife_iyes_adj_deprepgs_high_elsa <- lmer(
    satlife_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa %>% filter(highdeprepgs == "high"), 
    control = lmerControl(optimizer = "bobyqa")
    )

satlife_iyes_adj_deprepgs_re_elsa <- broom.mixed::tidy(satlife_iyes_adj_deprepgs_low_elsa) %>% slice(2) %>% mutate(deprepgs = "low") %>%
  bind_rows(broom.mixed::tidy(satlife_iyes_adj_deprepgs_interm_elsa) %>% slice(2) %>% mutate(deprepgs = "intermediate")) %>%
  bind_rows(broom.mixed::tidy(satlife_iyes_adj_deprepgs_high_elsa) %>% slice(2) %>% mutate(deprepgs = "high")) %>%
  mutate(country = "England", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  dplyr::select(country, deprepgs, term, estimate, std.error, statistic, df, p.value, p.sig)

satlife_iyes_adj_deprepgs_re <- bind_rows(satlife_iyes_adj_deprepgs_re_hrs, satlife_iyes_adj_deprepgs_re_elsa)


satlife_iyes_adj_deprepgs_hrs <- lmer(
    satlife_stand  ~ internet_yes + highdeprepgs + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs, 
    control = lmerControl(optimizer = "bobyqa")
    )

satlife_iyes_adj_deprepgs_int_hrs <- lmer(
    satlife_stand  ~ internet_yes*highdeprepgs + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs, 
    control = lmerControl(optimizer = "bobyqa")
    )

p_satlife_deprepgs_int_hrs <- anova(satlife_iyes_adj_deprepgs_hrs, satlife_iyes_adj_deprepgs_int_hrs, refit = T)

satlife_iyes_adj_deprepgs_elsa <- lmer(
    satlife_stand  ~ internet_yes + highdeprepgs + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa, 
    control = lmerControl(optimizer = "bobyqa")
    )

satlife_iyes_adj_deprepgs_int_elsa <- lmer(
    satlife_stand  ~ internet_yes*highdeprepgs + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa, 
    control = lmerControl(optimizer = "bobyqa")
    )

p_satlife_deprepgs_int_elsa <- anova(satlife_iyes_adj_deprepgs_elsa, satlife_iyes_adj_deprepgs_int_elsa, refit = T)

```

### Subjective well-being PGS

```{r}

#### CES-D ####
# HRS
cesd_iyes_adj_wellbpgs_low_hrs <- lmer(
    cesd_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs %>% filter(highwellbpgs == "low"), 
    control = lmerControl(optimizer = "bobyqa")
    )

cesd_iyes_adj_wellbpgs_interm_hrs <- lmer(
    cesd_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs %>% filter(highwellbpgs == "intermediate"), 
    control = lmerControl(optimizer = "bobyqa")
    )

cesd_iyes_adj_wellbpgs_high_hrs <- lmer(
    cesd_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs %>% filter(highwellbpgs == "high"), 
    control = lmerControl(optimizer = "bobyqa")
    )

cesd_iyes_adj_wellbpgs_re_hrs <- broom.mixed::tidy(cesd_iyes_adj_wellbpgs_low_hrs) %>% slice(2) %>% mutate(wellbpgs = "low") %>%
  bind_rows(broom.mixed::tidy(cesd_iyes_adj_wellbpgs_interm_hrs) %>% slice(2) %>% mutate(wellbpgs = "intermediate")) %>%
  bind_rows(broom.mixed::tidy(cesd_iyes_adj_wellbpgs_high_hrs) %>% slice(2) %>% mutate(wellbpgs = "high")) %>%
  mutate(country = "USA", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  dplyr::select(country, wellbpgs, term, estimate, std.error, statistic, df, p.value, p.sig)

# ELSA
cesd_iyes_adj_wellbpgs_low_elsa <- lmer(
    cesd_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa %>% filter(highwellbpgs == "low"), 
    control = lmerControl(optimizer = "bobyqa")
    )

cesd_iyes_adj_wellbpgs_interm_elsa <- lmer(
    cesd_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa %>% filter(highwellbpgs == "intermediate"), 
    control = lmerControl(optimizer = "bobyqa")
    )

cesd_iyes_adj_wellbpgs_high_elsa <- lmer(
    cesd_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa %>% filter(highwellbpgs == "high"), 
    control = lmerControl(optimizer = "bobyqa")
    )

cesd_iyes_adj_wellbpgs_re_elsa <- broom.mixed::tidy(cesd_iyes_adj_wellbpgs_low_elsa) %>% slice(2) %>% mutate(wellbpgs = "low") %>%
  bind_rows(broom.mixed::tidy(cesd_iyes_adj_wellbpgs_interm_elsa) %>% slice(2) %>% mutate(wellbpgs = "intermediate")) %>%
  bind_rows(broom.mixed::tidy(cesd_iyes_adj_wellbpgs_high_elsa) %>% slice(2) %>% mutate(wellbpgs = "high")) %>%
  mutate(country = "England", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  dplyr::select(country, wellbpgs, term, estimate, std.error, statistic, df, p.value, p.sig)

cesd_iyes_adj_wellbpgs_re <- bind_rows(cesd_iyes_adj_wellbpgs_re_hrs, cesd_iyes_adj_wellbpgs_re_elsa)

cesd_iyes_adj_wellbpgs_hrs <- lmer(
    cesd_stand  ~ internet_yes + highwellbpgs + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs, 
    control = lmerControl(optimizer = "bobyqa")
    )

cesd_iyes_adj_wellbpgs_int_hrs <- lmer(
    cesd_stand  ~ internet_yes*highwellbpgs + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs, 
    control = lmerControl(optimizer = "bobyqa")
    )

p_cesd_wellbpgs_int_hrs <- anova(cesd_iyes_adj_wellbpgs_hrs, cesd_iyes_adj_wellbpgs_int_hrs, refit = T)

cesd_iyes_adj_wellbpgs_elsa <- lmer(
    cesd_stand  ~ internet_yes + highwellbpgs + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa, 
    control = lmerControl(optimizer = "bobyqa")
    )

cesd_iyes_adj_wellbpgs_int_elsa <- lmer(
    cesd_stand  ~ internet_yes*highwellbpgs + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa, 
    control = lmerControl(optimizer = "bobyqa")
    )

p_cesd_wellbpgs_int_elsa <- anova(cesd_iyes_adj_wellbpgs_elsa, cesd_iyes_adj_wellbpgs_int_elsa, refit = T)


#### Self-rated health ####
# HRS
shlt_iyes_adj_wellbpgs_low_hrs <- lmer(
    shlt_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs %>% filter(highwellbpgs == "low"), 
    control = lmerControl(optimizer = "bobyqa")
    )

shlt_iyes_adj_wellbpgs_interm_hrs <- lmer(
    shlt_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs %>% filter(highwellbpgs == "intermediate"), 
    control = lmerControl(optimizer = "bobyqa")
    )

shlt_iyes_adj_wellbpgs_high_hrs <- lmer(
    shlt_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs %>% filter(highwellbpgs == "high"), 
    control = lmerControl(optimizer = "bobyqa")
    )

shlt_iyes_adj_wellbpgs_re_hrs <- broom.mixed::tidy(shlt_iyes_adj_wellbpgs_low_hrs) %>% slice(2) %>% mutate(wellbpgs = "low") %>%
  bind_rows(broom.mixed::tidy(shlt_iyes_adj_wellbpgs_interm_hrs) %>% slice(2) %>% mutate(wellbpgs = "intermediate")) %>%
  bind_rows(broom.mixed::tidy(shlt_iyes_adj_wellbpgs_high_hrs) %>% slice(2) %>% mutate(wellbpgs = "high")) %>%
  mutate(country = "USA", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  dplyr::select(country, wellbpgs, term, estimate, std.error, statistic, df, p.value, p.sig)


# ELSA
shlt_iyes_adj_wellbpgs_low_elsa <- lmer(
    shlt_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa %>% filter(highwellbpgs == "low"), 
    control = lmerControl(optimizer = "bobyqa")
    )

shlt_iyes_adj_wellbpgs_interm_elsa <- lmer(
    shlt_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa %>% filter(highwellbpgs == "intermediate"), 
    control = lmerControl(optimizer = "bobyqa")
    )

shlt_iyes_adj_wellbpgs_high_elsa <- lmer(
    shlt_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa %>% filter(highwellbpgs == "high"), 
    control = lmerControl(optimizer = "bobyqa")
    )

shlt_iyes_adj_wellbpgs_re_elsa <- broom.mixed::tidy(shlt_iyes_adj_wellbpgs_low_elsa) %>% slice(2) %>% mutate(wellbpgs = "low") %>%
  bind_rows(broom.mixed::tidy(shlt_iyes_adj_wellbpgs_interm_elsa) %>% slice(2) %>% mutate(wellbpgs = "intermediate")) %>%
  bind_rows(broom.mixed::tidy(shlt_iyes_adj_wellbpgs_high_elsa) %>% slice(2) %>% mutate(wellbpgs = "high")) %>%
  mutate(country = "England", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  dplyr::select(country, wellbpgs, term, estimate, std.error, statistic, df, p.value, p.sig)

shlt_iyes_adj_wellbpgs_re <- bind_rows(shlt_iyes_adj_wellbpgs_re_hrs, shlt_iyes_adj_wellbpgs_re_elsa)


shlt_iyes_adj_wellbpgs_hrs <- lmer(
    shlt_stand  ~ internet_yes + highwellbpgs + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs, 
    control = lmerControl(optimizer = "bobyqa")
    )

shlt_iyes_adj_wellbpgs_int_hrs <- lmer(
    shlt_stand  ~ internet_yes*highwellbpgs + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs, 
    control = lmerControl(optimizer = "bobyqa")
    )

p_shlt_wellbpgs_int_hrs <- anova(shlt_iyes_adj_wellbpgs_hrs, shlt_iyes_adj_wellbpgs_int_hrs, refit = T)

shlt_iyes_adj_wellbpgs_elsa <- lmer(
    shlt_stand  ~ internet_yes + highwellbpgs + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa, 
    control = lmerControl(optimizer = "bobyqa")
    )

shlt_iyes_adj_wellbpgs_int_elsa <- lmer(
    shlt_stand  ~ internet_yes*highwellbpgs + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa, 
    control = lmerControl(optimizer = "bobyqa")
    )

p_shlt_wellbpgs_int_elsa <- anova(shlt_iyes_adj_wellbpgs_elsa, shlt_iyes_adj_wellbpgs_int_elsa, refit = T)

#### Life satisfaction ####
# HRS
satlife_iyes_adj_wellbpgs_low_hrs <- lmer(
    satlife_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs %>% filter(highwellbpgs == "low"), 
    control = lmerControl(optimizer = "bobyqa")
    )

satlife_iyes_adj_wellbpgs_interm_hrs <- lmer(
    satlife_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs %>% filter(highwellbpgs == "intermediate"), 
    control = lmerControl(optimizer = "bobyqa")
    )

satlife_iyes_adj_wellbpgs_high_hrs <- lmer(
    satlife_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs %>% filter(highwellbpgs == "high"), 
    control = lmerControl(optimizer = "bobyqa")
    )

satlife_iyes_adj_wellbpgs_re_hrs <- broom.mixed::tidy(satlife_iyes_adj_wellbpgs_low_hrs) %>% slice(2) %>% mutate(wellbpgs = "low") %>%
  bind_rows(broom.mixed::tidy(satlife_iyes_adj_wellbpgs_interm_hrs) %>% slice(2) %>% mutate(wellbpgs = "intermediate")) %>%
  bind_rows(broom.mixed::tidy(satlife_iyes_adj_wellbpgs_high_hrs) %>% slice(2) %>% mutate(wellbpgs = "high")) %>%
  mutate(country = "USA", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  dplyr::select(country, wellbpgs, term, estimate, std.error, statistic, df, p.value, p.sig)

# ELSA
satlife_iyes_adj_wellbpgs_low_elsa <- lmer(
    satlife_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa %>% filter(highwellbpgs == "low"), 
    control = lmerControl(optimizer = "bobyqa")
    )

satlife_iyes_adj_wellbpgs_interm_elsa <- lmer(
    satlife_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa %>% filter(highwellbpgs == "intermediate"), 
    control = lmerControl(optimizer = "bobyqa")
    )

satlife_iyes_adj_wellbpgs_high_elsa <- lmer(
    satlife_stand  ~ internet_yes + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa %>% filter(highwellbpgs == "high"), 
    control = lmerControl(optimizer = "bobyqa")
    )

satlife_iyes_adj_wellbpgs_re_elsa <- broom.mixed::tidy(satlife_iyes_adj_wellbpgs_low_elsa) %>% slice(2) %>% mutate(wellbpgs = "low") %>%
  bind_rows(broom.mixed::tidy(satlife_iyes_adj_wellbpgs_interm_elsa) %>% slice(2) %>% mutate(wellbpgs = "intermediate")) %>%
  bind_rows(broom.mixed::tidy(satlife_iyes_adj_wellbpgs_high_elsa) %>% slice(2) %>% mutate(wellbpgs = "high")) %>%
  mutate(country = "England", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  dplyr::select(country, wellbpgs, term, estimate, std.error, statistic, df, p.value, p.sig)

satlife_iyes_adj_wellbpgs_re <- bind_rows(satlife_iyes_adj_wellbpgs_re_hrs, satlife_iyes_adj_wellbpgs_re_elsa)


satlife_iyes_adj_wellbpgs_hrs <- lmer(
    satlife_stand  ~ internet_yes + highwellbpgs + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs, 
    control = lmerControl(optimizer = "bobyqa")
    )

satlife_iyes_adj_wellbpgs_int_hrs <- lmer(
    satlife_stand  ~ internet_yes*highwellbpgs + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs, 
    control = lmerControl(optimizer = "bobyqa")
    )

p_satlife_wellbpgs_int_hrs <- anova(satlife_iyes_adj_wellbpgs_hrs, satlife_iyes_adj_wellbpgs_int_hrs, refit = T)

satlife_iyes_adj_wellbpgs_elsa <- lmer(
    satlife_stand  ~ internet_yes + highwellbpgs + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa, 
    control = lmerControl(optimizer = "bobyqa")
    )

satlife_iyes_adj_wellbpgs_int_elsa <- lmer(
    satlife_stand  ~ internet_yes*highwellbpgs + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa, 
    control = lmerControl(optimizer = "bobyqa")
    )

p_satlife_wellbpgs_int_elsa <- anova(satlife_iyes_adj_wellbpgs_elsa, satlife_iyes_adj_wellbpgs_int_elsa, refit = T)

```

## Joint effect

### Depressive symptoms PGS

```{r}

#### CES-D ####
# HRS
cesd_iyes_adj_deprepgs_joint_hrs <- lmer(
    cesd_stand  ~ jointdepre + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs, 
    control = lmerControl(optimizer = "bobyqa")
    )

# ELSA
cesd_iyes_adj_deprepgs_joint_elsa <- lmer(
    cesd_stand  ~ jointdepre + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa, 
    control = lmerControl(optimizer = "bobyqa")
    )


cesd_iyes_adj_deprepgs_joint_re_hrs <- broom.mixed::tidy(cesd_iyes_adj_deprepgs_joint_hrs) %>% 
  slice(2:6) %>% 
  mutate(country = "USA", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)

cesd_iyes_adj_deprepgs_joint_re_elsa <- broom.mixed::tidy(cesd_iyes_adj_deprepgs_joint_elsa) %>% 
  slice(2:6) %>% 
  mutate(country = "England", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)

cesd_iyes_adj_deprepgs_joint_re <- bind_rows(cesd_iyes_adj_deprepgs_joint_re_hrs, cesd_iyes_adj_deprepgs_joint_re_elsa)

#### Life satisfaction ####
# HRS
satlife_iyes_adj_deprepgs_joint_hrs <- lmer(
    satlife_stand  ~ jointdepre + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs, 
    control = lmerControl(optimizer = "bobyqa")
    )

# ELSA
satlife_iyes_adj_deprepgs_joint_elsa <- lmer(
    satlife_stand  ~ jointdepre + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa, 
    control = lmerControl(optimizer = "bobyqa")
    )

satlife_iyes_adj_deprepgs_joint_re_hrs <- broom.mixed::tidy(satlife_iyes_adj_deprepgs_joint_hrs) %>% 
  slice(2:6) %>% 
  mutate(country = "USA", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)

satlife_iyes_adj_deprepgs_joint_re_elsa <- broom.mixed::tidy(satlife_iyes_adj_deprepgs_joint_elsa) %>% 
  slice(2:6) %>% 
  mutate(country = "England", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)

satlife_iyes_adj_deprepgs_joint_re <- bind_rows(satlife_iyes_adj_deprepgs_joint_re_hrs, satlife_iyes_adj_deprepgs_joint_re_elsa)


#### Self-rated health ####
# HRS
shlt_iyes_adj_deprepgs_joint_hrs <- lmer(
    shlt_stand  ~ jointdepre + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs, 
    control = lmerControl(optimizer = "bobyqa")
    )

# ELSA
shlt_iyes_adj_deprepgs_joint_elsa <- lmer(
    shlt_stand  ~ jointdepre + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa, 
    control = lmerControl(optimizer = "bobyqa")
    )

shlt_iyes_adj_deprepgs_joint_re_hrs <- broom.mixed::tidy(shlt_iyes_adj_deprepgs_joint_hrs) %>% 
  slice(2:6) %>% 
  mutate(country = "USA", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)

shlt_iyes_adj_deprepgs_joint_re_elsa <- broom.mixed::tidy(shlt_iyes_adj_deprepgs_joint_elsa) %>% 
  slice(2:6) %>% 
  mutate(country = "England", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)

shlt_iyes_adj_deprepgs_joint_re <- bind_rows(shlt_iyes_adj_deprepgs_joint_re_hrs, shlt_iyes_adj_deprepgs_joint_re_elsa)

```

### Subjective well-being PGS

```{r}

#### CES-D ####
# HRS
cesd_iyes_adj_wellbpgs_joint_hrs <- lmer(
    cesd_stand  ~ jointwellb + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs, 
    control = lmerControl(optimizer = "bobyqa")
    )

# ELSA
cesd_iyes_adj_wellbpgs_joint_elsa <- lmer(
    cesd_stand  ~ jointwellb + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa, 
    control = lmerControl(optimizer = "bobyqa")
    )


cesd_iyes_adj_wellbpgs_joint_re_hrs <- broom.mixed::tidy(cesd_iyes_adj_wellbpgs_joint_hrs) %>% 
  slice(2:6) %>% 
  mutate(country = "USA", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)

cesd_iyes_adj_wellbpgs_joint_re_elsa <- broom.mixed::tidy(cesd_iyes_adj_wellbpgs_joint_elsa) %>% 
  slice(2:6) %>% 
  mutate(country = "England", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)

cesd_iyes_adj_wellbpgs_joint_re <- bind_rows(cesd_iyes_adj_wellbpgs_joint_re_hrs, cesd_iyes_adj_wellbpgs_joint_re_elsa)

#### Life satisfaction ####
# HRS
satlife_iyes_adj_wellbpgs_joint_hrs <- lmer(
    satlife_stand  ~ jointwellb + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs, 
    control = lmerControl(optimizer = "bobyqa")
    )

# ELSA
satlife_iyes_adj_wellbpgs_joint_elsa <- lmer(
    satlife_stand  ~ jointwellb + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa, 
    control = lmerControl(optimizer = "bobyqa")
    )

satlife_iyes_adj_wellbpgs_joint_re_hrs <- broom.mixed::tidy(satlife_iyes_adj_wellbpgs_joint_hrs) %>% 
  slice(2:6) %>% 
  mutate(country = "USA", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)

satlife_iyes_adj_wellbpgs_joint_re_elsa <- broom.mixed::tidy(satlife_iyes_adj_wellbpgs_joint_elsa) %>% 
  slice(2:6) %>% 
  mutate(country = "England", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)

satlife_iyes_adj_wellbpgs_joint_re <- bind_rows(satlife_iyes_adj_wellbpgs_joint_re_hrs, satlife_iyes_adj_wellbpgs_joint_re_elsa)


#### Self-rated health ####
# HRS
shlt_iyes_adj_wellbpgs_joint_hrs <- lmer(
    shlt_stand  ~ jointwellb + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_hrs, 
    control = lmerControl(optimizer = "bobyqa")
    )

# ELSA
shlt_iyes_adj_wellbpgs_joint_elsa <- lmer(
    shlt_stand  ~ jointwellb + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_iyes_pgs_elsa, 
    control = lmerControl(optimizer = "bobyqa")
    )

shlt_iyes_adj_wellbpgs_joint_re_hrs <- broom.mixed::tidy(shlt_iyes_adj_wellbpgs_joint_hrs) %>% 
  slice(2:6) %>% 
  mutate(country = "USA", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)

shlt_iyes_adj_wellbpgs_joint_re_elsa <- broom.mixed::tidy(shlt_iyes_adj_wellbpgs_joint_elsa) %>% 
  slice(2:6) %>% 
  mutate(country = "England", p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
  dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)

shlt_iyes_adj_wellbpgs_joint_re <- bind_rows(shlt_iyes_adj_wellbpgs_joint_re_hrs, shlt_iyes_adj_wellbpgs_joint_re_elsa)

```


## Forest plot

### Figure 4: Interaction and joint effect of baseline Internet use and polygenic score for depressive symptoms on mental well-being

```{r}

#### Theme setting ####
theme <- forestploter::forest_theme(
  core = list(bg_params = list(fill = c("white"))), 
  base_size = 10, 
  # base_family = "Arial",
  ci_pch = 15,
  ci_col = "#3B4992FF", 
  ci_alpha = 1,
  ci_lty = 1,
  ci_lwd = 1,
  ci_Theight = unit(0, "cm"),
  
  xaxis_lwd = 1,
  xaxis_cex = 1,
  
  summary_col = "#008B45FF", 
  refline_col = "gray", 
  refline_lwd = 2, 
  
  title_just = "center",
  title_cex = 1.2,
  title_fontface = "bold",
  title_col = "black",
  
  arrow_type = "closed",
  arrow_label_just = "end",
  arrow_length = 0.05,
  arrow_lwd = 1,
  arrow_fill = "black",
  arrow_col = "black",
  
  footnote_cex = 0.8
  )

#### CES-D ####
dat <- cesd_iyes_adj_deprepgs_re %>%
  bind_rows(
    tibble(
      country = "England", deprepgs = "low", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "England", deprepgs = "intermediate", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "England", deprepgs = "high", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
    bind_rows(
    tibble(
      country = "USA", deprepgs = "low", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "USA", deprepgs = "intermediate", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "USA", deprepgs = "high", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = ifelse(term == "no", "Reference", beta_ci),
    blank = paste(rep(" ", 10), collapse = " "),
    plot_ci = paste(rep(" ", 20), collapse = " "),
    term = str_c(deprepgs, term, sep = "."),
    term = factor(term, levels = c("low.no", "low.internet_yesyes", "intermediate.no", "intermediate.internet_yesyes", "high.no", "high.internet_yesyes"), labels = c("  No internet use", "  Internet use", "  No internet use", "  Internet use", "  No internet use", "  Internet use")),
    deprepgs = factor(deprepgs, levels = c("low", "intermediate", "high"), labels = c("Low genetic risk", "Intermediate genetic risk", "High genetic risk"))
  ) %>%
  arrange(country, deprepgs, term)


dat_fig <- dat %>%
  select(country, deprepgs, term, estimate, lower, upper, beta_ci, blank, plot_ci) %>%
  pivot_wider(
    names_from = country,
    values_from = c(estimate, lower, upper, beta_ci, blank, plot_ci)
  ) %>%
  add_row(
    term = "Low genetic risk",
    beta_ci_England = "", beta_ci_USA = "",
    plot_ci_England = paste(rep(" ", 20), collapse = " "), 
    blank_England = paste(rep(" ", 10), collapse = " "),
    plot_ci_USA = paste(rep(" ", 20), collapse = " ")
    ) %>%
  add_row(
    term = "Intermediate genetic risk",
    beta_ci_England = "", beta_ci_USA = "",
    plot_ci_England = paste(rep(" ", 20), collapse = " "), 
    blank_England = paste(rep(" ", 10), collapse = " "),
    plot_ci_USA = paste(rep(" ", 20), collapse = " ")
    ) %>%
  add_row(
    term = "High genetic risk",
    beta_ci_England = "", beta_ci_USA = "",
    plot_ci_England = paste(rep(" ", 20), collapse = " "), 
    blank_England = paste(rep(" ", 10), collapse = " "),
    plot_ci_USA = paste(rep(" ", 20), collapse = " ")
    ) %>%
  add_row(
    term = "",
    beta_ci_England = "", beta_ci_USA = "",
    plot_ci_England = paste(rep(" ", 20), collapse = " "),
    blank_England = paste(rep(" ", 10), collapse = " "),
    plot_ci_USA = paste(rep(" ", 20), collapse = " ")
    ) %>%
  add_row(
    term = "",
    beta_ci_England = "", beta_ci_USA = "",
    plot_ci_England = paste(rep(" ", 20), collapse = " "),
    blank_England = paste(rep(" ", 10), collapse = " "),
    plot_ci_USA = paste(rep(" ", 20), collapse = " ")
    ) %>%
  select(
    term, estimate_England, estimate_USA, 
    lower_England, lower_USA,
    upper_England, upper_USA, 
    plot_ci_England, beta_ci_England, blank_England,
    plot_ci_USA, beta_ci_USA
    )
dat_fig <- dat_fig[c(7,1:2,10, 8,3:4,11, 9,5:6),] 
colnames(dat_fig)[colnames(dat_fig) == "term"] <- "Groups"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_England"] <- "England"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_USA"] <- "USA"
colnames(dat_fig)[colnames(dat_fig) %in% c("beta_ci_England", "beta_ci_USA")] <- "β (95% CI)"
colnames(dat_fig)[colnames(dat_fig) %in% c("blank_England", "blank_USA")] <- " "

p_cesd_pgs <- forestploter::forest(
  dat_fig[,c(1, 8:12)],
  est = list(
    dat_fig$estimate_England,
    dat_fig$estimate_USA
  ),
  lower = list(
    dat_fig$lower_England,
    dat_fig$lower_USA
  ),
  upper = list(
    dat_fig$upper_England,
    dat_fig$upper_USA
  ),
  ci_column = c(2, 5),
  ref_line = c(0, 0),
  sizes = 0.7,
  xlim = list(
    c(-0.4, 0.2),
    c(-0.4, 0.2)
    ),            
  ticks_at = list(
    c(-0.4, -0.2, 0, 0.2), 
    c(-0.4, -0.2, 0, 0.2)
    ),
  arrow_lab = c("Fewer depressive symptoms","More depressive symptoms"),
  theme = theme
  )

# Add border
p_cesd_pgs <- add_border(p_cesd_pgs, part = "header", row = 1, col = c(1:6), gp = gpar(lwd = 1))

# Italic group name
p_cesd_pgs <- edit_plot(p_cesd_pgs, row = c(1, 5, 9), gp = gpar(fontface = "italic"))

#### Life satisfaction ####
dat <- satlife_iyes_adj_deprepgs_re %>%
  bind_rows(
    tibble(
      country = "England", deprepgs = "low", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "England", deprepgs = "intermediate", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "England", deprepgs = "high", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
    bind_rows(
    tibble(
      country = "USA", deprepgs = "low", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "USA", deprepgs = "intermediate", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "USA", deprepgs = "high", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = ifelse(term == "no", "Reference", beta_ci),
    blank = paste(rep(" ", 10), collapse = " "),
    plot_ci = paste(rep(" ", 20), collapse = " "),
    term = str_c(deprepgs, term, sep = "."),
    term = factor(term, levels = c("low.no", "low.internet_yesyes", "intermediate.no", "intermediate.internet_yesyes", "high.no", "high.internet_yesyes"), labels = c("  No internet use", "  Internet use", "  No internet use", "  Internet use", "  No internet use", "  Internet use")),
    deprepgs = factor(deprepgs, levels = c("low", "intermediate", "high"), labels = c("Low genetic risk", "Intermediate genetic risk", "High genetic risk"))
  ) %>%
  arrange(country, deprepgs, term)


dat_fig <- dat %>%
  select(country, deprepgs, term, estimate, lower, upper, beta_ci, blank, plot_ci) %>%
  pivot_wider(
    names_from = country,
    values_from = c(estimate, lower, upper, beta_ci, blank, plot_ci)
  ) %>%
  add_row(
    term = "Low genetic risk",
    beta_ci_England = "", beta_ci_USA = "",
    plot_ci_England = paste(rep(" ", 20), collapse = " "), 
    blank_England = paste(rep(" ", 10), collapse = " "),
    plot_ci_USA = paste(rep(" ", 20), collapse = " ")
    ) %>%
  add_row(
    term = "Intermediate genetic risk",
    beta_ci_England = "", beta_ci_USA = "",
    plot_ci_England = paste(rep(" ", 20), collapse = " "), 
    blank_England = paste(rep(" ", 10), collapse = " "),
    plot_ci_USA = paste(rep(" ", 20), collapse = " ")
    ) %>%
  add_row(
    term = "High genetic risk",
    beta_ci_England = "", beta_ci_USA = "",
    plot_ci_England = paste(rep(" ", 20), collapse = " "), 
    blank_England = paste(rep(" ", 10), collapse = " "),
    plot_ci_USA = paste(rep(" ", 20), collapse = " ")
    ) %>%
  add_row(
    term = "",
    beta_ci_England = "", beta_ci_USA = "",
    plot_ci_England = paste(rep(" ", 20), collapse = " "),
    blank_England = paste(rep(" ", 10), collapse = " "),
    plot_ci_USA = paste(rep(" ", 20), collapse = " ")
    ) %>%
  add_row(
    term = "",
    beta_ci_England = "", beta_ci_USA = "",
    plot_ci_England = paste(rep(" ", 20), collapse = " "),
    blank_England = paste(rep(" ", 10), collapse = " "),
    plot_ci_USA = paste(rep(" ", 20), collapse = " ")
    ) %>%
  select(
    term, estimate_England, estimate_USA, 
    lower_England, lower_USA,
    upper_England, upper_USA, 
    plot_ci_England, beta_ci_England, blank_England,
    plot_ci_USA, beta_ci_USA
    )
dat_fig <- dat_fig[c(7,1:2,10, 8,3:4,11, 9,5:6),] 
colnames(dat_fig)[colnames(dat_fig) == "term"] <- "Groups"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_England"] <- "England"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_USA"] <- "USA"
colnames(dat_fig)[colnames(dat_fig) %in% c("beta_ci_England", "beta_ci_USA")] <- "β (95% CI)"
colnames(dat_fig)[colnames(dat_fig) %in% c("blank_England", "blank_USA")] <- " "


p_satlife_pgs <- forestploter::forest(
  dat_fig[,c(1, 8:12)],
  est = list(
    dat_fig$estimate_England,
    dat_fig$estimate_USA
  ),
  lower = list(
    dat_fig$lower_England,
    dat_fig$lower_USA
  ),
  upper = list(
    dat_fig$upper_England,
    dat_fig$upper_USA
  ),
  ci_column = c(2, 5),
  ref_line = c(0, 0),
  sizes = 0.7,
  xlim = list(
    c(-0.3, 0.3),
    c(-0.3, 0.3)
    ),            
  ticks_at = list(
    c(-0.3, -0.15, 0, 0.15, 0.3), 
    c(-0.3, -0.15, 0, 0.15, 0.3)
    ),  
  arrow_lab = c("Lower life satisfaction","Higher life satisfaction"),
  theme = theme
  )

# Add border
p_satlife_pgs <- add_border(p_satlife_pgs, part = "header", row = 1, col = c(1:6), gp = gpar(lwd = 1))

# Italic group name
p_satlife_pgs <- edit_plot(p_satlife_pgs, row = c(1, 5, 9), gp = gpar(fontface = "italic"))

#### Self-rated health ####
dat <- shlt_iyes_adj_deprepgs_re %>%
  bind_rows(
    tibble(
      country = "England", deprepgs = "low", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "England", deprepgs = "intermediate", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "England", deprepgs = "high", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
    bind_rows(
    tibble(
      country = "USA", deprepgs = "low", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "USA", deprepgs = "intermediate", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "USA", deprepgs = "high", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = ifelse(term == "no", "Reference", beta_ci),
    blank = paste(rep(" ", 10), collapse = " "),
    plot_ci = paste(rep(" ", 20), collapse = " "),
    term = str_c(deprepgs, term, sep = "."),
    term = factor(term, levels = c("low.no", "low.internet_yesyes", "intermediate.no", "intermediate.internet_yesyes", "high.no", "high.internet_yesyes"), labels = c("  No internet use", "  Internet use", "  No internet use", "  Internet use", "  No internet use", "  Internet use")),
    deprepgs = factor(deprepgs, levels = c("low", "intermediate", "high"), labels = c("Low genetic risk", "Intermediate genetic risk", "High genetic risk"))
  ) %>%
  arrange(country, deprepgs, term)


dat_fig <- dat %>%
  select(country, deprepgs, term, estimate, lower, upper, beta_ci, blank, plot_ci) %>%
  pivot_wider(
    names_from = country,
    values_from = c(estimate, lower, upper, beta_ci, blank, plot_ci)
  ) %>%
  add_row(
    term = "Low genetic risk",
    beta_ci_England = "", beta_ci_USA = "",
    plot_ci_England = paste(rep(" ", 20), collapse = " "), 
    blank_England = paste(rep(" ", 10), collapse = " "),
    plot_ci_USA = paste(rep(" ", 20), collapse = " ")
    ) %>%
  add_row(
    term = "Intermediate genetic risk",
    beta_ci_England = "", beta_ci_USA = "",
    plot_ci_England = paste(rep(" ", 20), collapse = " "), 
    blank_England = paste(rep(" ", 10), collapse = " "),
    plot_ci_USA = paste(rep(" ", 20), collapse = " ")
    ) %>%
  add_row(
    term = "High genetic risk",
    beta_ci_England = "", beta_ci_USA = "",
    plot_ci_England = paste(rep(" ", 20), collapse = " "), 
    blank_England = paste(rep(" ", 10), collapse = " "),
    plot_ci_USA = paste(rep(" ", 20), collapse = " ")
    ) %>%
  add_row(
    term = "",
    beta_ci_England = "", beta_ci_USA = "",
    plot_ci_England = paste(rep(" ", 20), collapse = " "),
    blank_England = paste(rep(" ", 10), collapse = " "),
    plot_ci_USA = paste(rep(" ", 20), collapse = " ")
    ) %>%
  add_row(
    term = "",
    beta_ci_England = "", beta_ci_USA = "",
    plot_ci_England = paste(rep(" ", 20), collapse = " "),
    blank_England = paste(rep(" ", 10), collapse = " "),
    plot_ci_USA = paste(rep(" ", 20), collapse = " ")
    ) %>%
  select(
    term, estimate_England, estimate_USA, 
    lower_England, lower_USA,
    upper_England, upper_USA, 
    plot_ci_England, beta_ci_England, blank_England,
    plot_ci_USA, beta_ci_USA
    )
dat_fig <- dat_fig[c(7,1:2,10, 8,3:4,11, 9,5:6),]
colnames(dat_fig)[colnames(dat_fig) == "term"] <- "Groups"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_England"] <- "England"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_USA"] <- "USA"
colnames(dat_fig)[colnames(dat_fig) %in% c("beta_ci_England", "beta_ci_USA")] <- "β (95% CI)"
colnames(dat_fig)[colnames(dat_fig) %in% c("blank_England", "blank_USA")] <- " "

p_shlt_pgs <- forestploter::forest(
  dat_fig[,c(1, 8:12)],
  est = list(
    dat_fig$estimate_England,
    dat_fig$estimate_USA
  ),
  lower = list(
    dat_fig$lower_England,
    dat_fig$lower_USA
  ),
  upper = list(
    dat_fig$upper_England,
    dat_fig$upper_USA
  ),
  ci_column = c(2, 5),
  ref_line = c(0, 0),
  sizes = 0.7,
  xlim = list(
    c(-0.2, 0.4),
    c(-0.2, 0.4)
    ),            
  ticks_at = list(
    c(-0.2, 0, 0.2, 0.4), 
    c(-0.2, 0, 0.2, 0.4)
    ),  
  arrow_lab = c("Worse self-reported health","Better self-reported health"),
  theme = theme
  )

# Add border
p_shlt_pgs <- add_border(p_shlt_pgs, part = "header", row = 1, col = c(1:6), gp = gpar(lwd = 1))

# Italic group name
p_shlt_pgs <- edit_plot(p_shlt_pgs, row = c(1, 5, 9), gp = gpar(fontface = "italic"))


#### CES-D joint ####
dat <- cesd_iyes_adj_deprepgs_joint_re %>%
  add_row(
    country = "England", term = "jointdepreno.high", estimate = 0, std.error = 0
  ) %>%
  add_row(
    country = "USA", term = "jointdepreno.high", estimate = 0, std.error = 0
  ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = ifelse(term == "jointdepreno.high", "Reference", beta_ci),
    blank = paste(rep(" ", 10), collapse = " "),
    plot_ci = paste(rep(" ", 20), collapse = " "),
    term = factor(term, levels = c("jointdepreno.high", "jointdepreyes.high", "jointdepreno.intermediate", "jointdepreyes.intermediate", "jointdepreno.low", "jointdepreyes.low"))
  ) %>%
  arrange(country, term) %>%
  separate(term, c("internet_yes", "pgs")) %>%
  mutate(
    pgs = factor(pgs, levels = c("high", "intermediate", "low"), labels = c("High genetic risk", "Intermediate genetic risk", "Low genetic risk")),
    internet_yes = factor(internet_yes, levels = c("jointdepreno", "jointdepreyes"), labels = c("No", "Yes"))
  )


dat_fig <- dat %>%
  select(country, pgs, internet_yes, estimate, lower, upper, beta_ci, blank, plot_ci) %>%
  pivot_wider(
    names_from = country,
    values_from = c(estimate, lower, upper, beta_ci, blank, plot_ci)
  ) %>%
  select(
    pgs, internet_yes, estimate_England, estimate_USA, 
    lower_England, lower_USA,
    upper_England, upper_USA, 
    plot_ci_England, beta_ci_England, blank_England,
    plot_ci_USA, beta_ci_USA
    )
colnames(dat_fig)[colnames(dat_fig) == "pgs"] <- "Polygenic risk score"
colnames(dat_fig)[colnames(dat_fig) == "internet_yes"] <- "Internet use"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_England"] <- "England"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_USA"] <- "USA"
colnames(dat_fig)[colnames(dat_fig) %in% c("beta_ci_England", "beta_ci_USA")] <- "β (95% CI)"
colnames(dat_fig)[colnames(dat_fig) %in% c("blank_England", "blank_USA")] <- " "

p_cesd_joint <- forestploter::forest(
  dat_fig[,c(1,2, 9:13)],
  est = list(
    dat_fig$estimate_England,
    dat_fig$estimate_USA
  ),
  lower = list(
    dat_fig$lower_England,
    dat_fig$lower_USA
  ),
  upper = list(
    dat_fig$upper_England,
    dat_fig$upper_USA
  ),
  ci_column = c(3, 6),
  ref_line = c(0, 0),
  sizes = 0.7,
  xlim = list(
    c(-0.4, 0.1),
    c(-0.4, 0.1)
    ),            
  ticks_at = list(
    c(-0.4, -0.3, -0.2, -0.1, 0, 0.1), 
    c(-0.4, -0.3, -0.2, -0.1, 0, 0.1)
    ),  
  arrow_lab = c("Fewer depressive symptoms","More depressive symptoms"),
  theme = theme
  )

# Add border
p_cesd_joint <- add_border(p_cesd_joint, part = "header", row = 1, col = c(1:7), gp = gpar(lwd = 1))

#### Life satisfaction joint ####
dat <- satlife_iyes_adj_deprepgs_joint_re %>%
  add_row(
    country = "England", term = "jointdepreno.high", estimate = 0, std.error = 0
  ) %>%
  add_row(
    country = "USA", term = "jointdepreno.high", estimate = 0, std.error = 0
  ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = ifelse(term == "jointdepreno.high", "Reference", beta_ci),
    blank = paste(rep(" ", 10), collapse = " "),
    plot_ci = paste(rep(" ", 20), collapse = " "),
    term = factor(term, levels = c("jointdepreno.high", "jointdepreyes.high", "jointdepreno.intermediate", "jointdepreyes.intermediate", "jointdepreno.low", "jointdepreyes.low"))
  ) %>%
  arrange(country, term) %>%
  separate(term, c("internet_yes", "pgs")) %>%
  mutate(
    pgs = factor(pgs, levels = c("high", "intermediate", "low"), labels = c("High genetic risk", "Intermediate genetic risk", "Low genetic risk")),
    internet_yes = factor(internet_yes, levels = c("jointdepreno", "jointdepreyes"), labels = c("No", "Yes"))
  )


dat_fig <- dat %>%
  select(country, pgs, internet_yes, estimate, lower, upper, beta_ci, blank, plot_ci) %>%
  pivot_wider(
    names_from = country,
    values_from = c(estimate, lower, upper, beta_ci, blank, plot_ci)
  ) %>%
  select(
    pgs, internet_yes, estimate_England, estimate_USA, 
    lower_England, lower_USA,
    upper_England, upper_USA, 
    plot_ci_England, beta_ci_England, blank_England,
    plot_ci_USA, beta_ci_USA
    )
colnames(dat_fig)[colnames(dat_fig) == "pgs"] <- "Polygenic risk score"
colnames(dat_fig)[colnames(dat_fig) == "internet_yes"] <- "Internet use"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_England"] <- "England"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_USA"] <- "USA"
colnames(dat_fig)[colnames(dat_fig) %in% c("beta_ci_England", "beta_ci_USA")] <- "β (95% CI)"
colnames(dat_fig)[colnames(dat_fig) %in% c("blank_England", "blank_USA")] <- " "

p_satlife_joint <- forestploter::forest(
  dat_fig[,c(1,2, 9:13)],
  est = list(
    dat_fig$estimate_England,
    dat_fig$estimate_USA
  ),
  lower = list(
    dat_fig$lower_England,
    dat_fig$lower_USA
  ),
  upper = list(
    dat_fig$upper_England,
    dat_fig$upper_USA
  ),
  ci_column = c(3, 6),
  ref_line = c(0, 0),
  sizes = 0.7,
  xlim = list(
    c(-0.4, 0.2),
    c(-0.4, 0.2)
    ),            
  ticks_at = list(
    c(-0.4, -0.2, 0, 0.2), 
    c(-0.4, -0.2, 0, 0.2)
    ),  
  arrow_lab = c("Lower life satisfaction","Higher life satisfaction"),
  theme = theme
  )

# Add border
p_satlife_joint <- add_border(p_satlife_joint, part = "header", row = 1, col = c(1:7), gp = gpar(lwd = 1))

#### Self-rated health joint ####
dat <- shlt_iyes_adj_deprepgs_joint_re %>%
  add_row(
    country = "England", term = "jointdepreno.high", estimate = 0, std.error = 0
  ) %>%
  add_row(
    country = "USA", term = "jointdepreno.high", estimate = 0, std.error = 0
  ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = ifelse(term == "jointdepreno.high", "Reference", beta_ci),
    blank = paste(rep(" ", 10), collapse = " "),
    plot_ci = paste(rep(" ", 20), collapse = " "),
    term = factor(term, levels = c("jointdepreno.high", "jointdepreyes.high", "jointdepreno.intermediate", "jointdepreyes.intermediate", "jointdepreno.low", "jointdepreyes.low"))
  ) %>%
  arrange(country, term) %>%
  separate(term, c("internet_yes", "pgs")) %>%
  mutate(
    pgs = factor(pgs, levels = c("high", "intermediate", "low"), labels = c("High genetic risk", "Intermediate genetic risk", "Low genetic risk")),
    internet_yes = factor(internet_yes, levels = c("jointdepreno", "jointdepreyes"), labels = c("No", "Yes"))
  )


dat_fig <- dat %>%
  select(country, pgs, internet_yes, estimate, lower, upper, beta_ci, blank, plot_ci) %>%
  pivot_wider(
    names_from = country,
    values_from = c(estimate, lower, upper, beta_ci, blank, plot_ci)
  ) %>%
  select(
    pgs, internet_yes, estimate_England, estimate_USA, 
    lower_England, lower_USA,
    upper_England, upper_USA, 
    plot_ci_England, beta_ci_England, blank_England,
    plot_ci_USA, beta_ci_USA
    )
colnames(dat_fig)[colnames(dat_fig) == "pgs"] <- "Polygenic risk score"
colnames(dat_fig)[colnames(dat_fig) == "internet_yes"] <- "Internet use"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_England"] <- "England"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_USA"] <- "USA"
colnames(dat_fig)[colnames(dat_fig) %in% c("beta_ci_England", "beta_ci_USA")] <- "β (95% CI)"
colnames(dat_fig)[colnames(dat_fig) %in% c("blank_England", "blank_USA")] <- " "

p_shlt_joint <- forestploter::forest(
  dat_fig[,c(1,2, 9:13)],
  est = list(
    dat_fig$estimate_England,
    dat_fig$estimate_USA
  ),
  lower = list(
    dat_fig$lower_England,
    dat_fig$lower_USA
  ),
  upper = list(
    dat_fig$upper_England,
    dat_fig$upper_USA
  ),
  ci_column = c(3, 6),
  ref_line = c(0, 0),
  sizes = 0.7,
  xlim = list(
    c(-0.2, 0.4),
    c(-0.2, 0.4)
    ),            
  ticks_at = list(
    c(-0.2, 0, 0.2, 0.4), 
    c(-0.2, 0, 0.2, 0.4)
    ),  
  arrow_lab = c("Worse self-reported health","Better self-reported health"),
  theme = theme
  )

# Add border
p_shlt_joint <- add_border(p_shlt_joint, part = "header", row = 1, col = c(1:7), gp = gpar(lwd = 1))

#### Pool ####
p_pool_pgs <- wrap_elements(
  (wrap_elements(p_cesd_pgs) + labs(tag = "a")) + (wrap_elements(p_satlife_pgs) + labs(tag = "b")) + (wrap_elements(p_shlt_pgs) + labs(tag = "c")) +
    plot_layout(nrow = 3)
  )

p_pool_joint <- wrap_elements(
  (wrap_elements(p_cesd_joint) + labs(tag = "d")) + (wrap_elements(p_satlife_joint) + labs(tag = "e")) + (wrap_elements(p_shlt_joint) + labs(tag = "f")) +
    plot_layout(nrow = 3)
  )

p_pool <- wrap_elements(
  p_pool_pgs + p_pool_joint +
    plot_layout(ncol = 2)
  )

ggsave(str_c(getwd(), "/results/Figure/Figure 4_Forest plot_internet use and depressive symptoms pgs.tiff"), plot = p_pool, width = 20, height = 12, unit = "in", dpi = 300, device = "tiff")

```

### Extended Data Figure 4: Interaction and joint effect of baseline Internet use and polygenic score for subjective well-being on mental health

```{r}

#### Theme setting ####
theme <- forestploter::forest_theme(
  core = list(bg_params = list(fill = c("white"))),
  base_size = 10, 
  # base_family = "Arial",
  ci_pch = 15,
  ci_col = "#3B4992FF", 
  ci_alpha = 1,
  ci_lty = 1,
  ci_lwd = 1,
  ci_Theight = unit(0, "cm"),
  
  xaxis_lwd = 1,
  xaxis_cex = 1,
  
  summary_col = "#008B45FF", 
  refline_col = "gray", 
  refline_lwd = 2, 
  
  title_just = "center",
  title_cex = 1.2,
  title_fontface = "bold",
  title_col = "black",
  
  arrow_type = "closed",
  arrow_label_just = "end",
  arrow_length = 0.05,
  arrow_lwd = 1,
  arrow_fill = "black",
  arrow_col = "black"
  )

#### CES-D ####
dat <- cesd_iyes_adj_wellbpgs_re %>%
  bind_rows(
    tibble(
      country = "England", wellbpgs = "low", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "England", wellbpgs = "intermediate", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "England", wellbpgs = "high", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
    bind_rows(
    tibble(
      country = "USA", wellbpgs = "low", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "USA", wellbpgs = "intermediate", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "USA", wellbpgs = "high", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = ifelse(term == "no", "Reference", beta_ci),
    blank = paste(rep(" ", 10), collapse = " "),
    plot_ci = paste(rep(" ", 20), collapse = " "),
    term = str_c(wellbpgs, term, sep = "."),
    term = factor(term, levels = c("low.no", "low.internet_yesyes", "intermediate.no", "intermediate.internet_yesyes", "high.no", "high.internet_yesyes"), labels = c("  No internet use", "  Internet use", "  No internet use", "  Internet use", "  No internet use", "  Internet use")),
    wellbpgs = factor(wellbpgs, levels = c("low", "intermediate", "high"), labels = c("Low genetic risk", "Intermediate genetic risk", "High genetic risk"))
  ) %>%
  arrange(country, wellbpgs, term)


dat_fig <- dat %>%
  select(country, wellbpgs, term, estimate, lower, upper, beta_ci, blank, plot_ci) %>%
  pivot_wider(
    names_from = country,
    values_from = c(estimate, lower, upper, beta_ci, blank, plot_ci)
  ) %>%
  add_row(
    term = "Low genetic risk",
    beta_ci_England = "", beta_ci_USA = "",
    plot_ci_England = paste(rep(" ", 20), collapse = " "), 
    blank_England = paste(rep(" ", 10), collapse = " "),
    plot_ci_USA = paste(rep(" ", 20), collapse = " ")
    ) %>%
  add_row(
    term = "Intermediate genetic risk",
    beta_ci_England = "", beta_ci_USA = "",
    plot_ci_England = paste(rep(" ", 20), collapse = " "), 
    blank_England = paste(rep(" ", 10), collapse = " "),
    plot_ci_USA = paste(rep(" ", 20), collapse = " ")
    ) %>%
  add_row(
    term = "High genetic risk",
    beta_ci_England = "", beta_ci_USA = "",
    plot_ci_England = paste(rep(" ", 20), collapse = " "), 
    blank_England = paste(rep(" ", 10), collapse = " "),
    plot_ci_USA = paste(rep(" ", 20), collapse = " ")
    ) %>%
  add_row(
    term = "",
    beta_ci_England = "", beta_ci_USA = "",
    plot_ci_England = paste(rep(" ", 20), collapse = " "),
    blank_England = paste(rep(" ", 10), collapse = " "),
    plot_ci_USA = paste(rep(" ", 20), collapse = " ")
    ) %>%
  add_row(
    term = "",
    beta_ci_England = "", beta_ci_USA = "",
    plot_ci_England = paste(rep(" ", 20), collapse = " "),
    blank_England = paste(rep(" ", 10), collapse = " "),
    plot_ci_USA = paste(rep(" ", 20), collapse = " ")
    ) %>%
  select(
    term, estimate_England, estimate_USA, 
    lower_England, lower_USA,
    upper_England, upper_USA, 
    plot_ci_England, beta_ci_England, blank_England,
    plot_ci_USA, beta_ci_USA
    )
dat_fig <- dat_fig[c(7,1:2,10, 8,3:4,11, 9,5:6),]
colnames(dat_fig)[colnames(dat_fig) == "term"] <- "Groups"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_England"] <- "England"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_USA"] <- "USA"
colnames(dat_fig)[colnames(dat_fig) %in% c("beta_ci_England", "beta_ci_USA")] <- "β (95% CI)"
colnames(dat_fig)[colnames(dat_fig) %in% c("blank_England", "blank_USA")] <- " "

p_cesd_pgs <- forestploter::forest(
  dat_fig[,c(1, 8:12)],
  est = list(
    dat_fig$estimate_England,
    dat_fig$estimate_USA
  ),
  lower = list(
    dat_fig$lower_England,
    dat_fig$lower_USA
  ),
  upper = list(
    dat_fig$upper_England,
    dat_fig$upper_USA
  ),
  ci_column = c(2, 5),
  ref_line = c(0, 0),
  sizes = 0.7,
  xlim = list(
    c(-0.4, 0.2),
    c(-0.4, 0.2)
    ),            
  ticks_at = list(
    c(-0.4, -0.2, 0, 0.2), 
    c(-0.4, -0.2, 0, 0.2)
    ),
  arrow_lab = c("Fewer depressive symptoms","More depressive symptoms"),
  theme = theme
  )

# Add border
p_cesd_pgs <- add_border(p_cesd_pgs, part = "header", row = 1, col = c(1:6), gp = gpar(lwd = 1))

# Italic group name
p_cesd_pgs <- edit_plot(p_cesd_pgs, row = c(1, 5, 9), gp = gpar(fontface = "italic"))

#### Life satisfaction ####
dat <- satlife_iyes_adj_wellbpgs_re %>%
  bind_rows(
    tibble(
      country = "England", wellbpgs = "low", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "England", wellbpgs = "intermediate", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "England", wellbpgs = "high", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
    bind_rows(
    tibble(
      country = "USA", wellbpgs = "low", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "USA", wellbpgs = "intermediate", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "USA", wellbpgs = "high", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = ifelse(term == "no", "Reference", beta_ci),
    blank = paste(rep(" ", 10), collapse = " "),
    plot_ci = paste(rep(" ", 20), collapse = " "),
    term = str_c(wellbpgs, term, sep = "."),
    term = factor(term, levels = c("low.no", "low.internet_yesyes", "intermediate.no", "intermediate.internet_yesyes", "high.no", "high.internet_yesyes"), labels = c("  No internet use", "  Internet use", "  No internet use", "  Internet use", "  No internet use", "  Internet use")),
    wellbpgs = factor(wellbpgs, levels = c("low", "intermediate", "high"), labels = c("Low genetic risk", "Intermediate genetic risk", "High genetic risk"))
  ) %>%
  arrange(country, wellbpgs, term)


dat_fig <- dat %>%
  select(country, wellbpgs, term, estimate, lower, upper, beta_ci, blank, plot_ci) %>%
  pivot_wider(
    names_from = country,
    values_from = c(estimate, lower, upper, beta_ci, blank, plot_ci)
  ) %>%
  add_row(
    term = "Low genetic risk",
    beta_ci_England = "", beta_ci_USA = "",
    plot_ci_England = paste(rep(" ", 20), collapse = " "), 
    blank_England = paste(rep(" ", 10), collapse = " "),
    plot_ci_USA = paste(rep(" ", 20), collapse = " ")
    ) %>%
  add_row(
    term = "Intermediate genetic risk",
    beta_ci_England = "", beta_ci_USA = "",
    plot_ci_England = paste(rep(" ", 20), collapse = " "), 
    blank_England = paste(rep(" ", 10), collapse = " "),
    plot_ci_USA = paste(rep(" ", 20), collapse = " ")
    ) %>%
  add_row(
    term = "High genetic risk",
    beta_ci_England = "", beta_ci_USA = "",
    plot_ci_England = paste(rep(" ", 20), collapse = " "), 
    blank_England = paste(rep(" ", 10), collapse = " "),
    plot_ci_USA = paste(rep(" ", 20), collapse = " ")
    ) %>%
  add_row(
    term = "",
    beta_ci_England = "", beta_ci_USA = "",
    plot_ci_England = paste(rep(" ", 20), collapse = " "),
    blank_England = paste(rep(" ", 10), collapse = " "),
    plot_ci_USA = paste(rep(" ", 20), collapse = " ")
    ) %>%
  add_row(
    term = "",
    beta_ci_England = "", beta_ci_USA = "",
    plot_ci_England = paste(rep(" ", 20), collapse = " "),
    blank_England = paste(rep(" ", 10), collapse = " "),
    plot_ci_USA = paste(rep(" ", 20), collapse = " ")
    ) %>%
  select(
    term, estimate_England, estimate_USA, 
    lower_England, lower_USA,
    upper_England, upper_USA, 
    plot_ci_England, beta_ci_England, blank_England,
    plot_ci_USA, beta_ci_USA
    )
dat_fig <- dat_fig[c(7,1:2,10, 8,3:4,11, 9,5:6),] 
colnames(dat_fig)[colnames(dat_fig) == "term"] <- "Groups"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_England"] <- "England"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_USA"] <- "USA"
colnames(dat_fig)[colnames(dat_fig) %in% c("beta_ci_England", "beta_ci_USA")] <- "β (95% CI)"
colnames(dat_fig)[colnames(dat_fig) %in% c("blank_England", "blank_USA")] <- " "

p_satlife_pgs <- forestploter::forest(
  dat_fig[,c(1, 8:12)],
  est = list(
    dat_fig$estimate_England,
    dat_fig$estimate_USA
  ),
  lower = list(
    dat_fig$lower_England,
    dat_fig$lower_USA
  ),
  upper = list(
    dat_fig$upper_England,
    dat_fig$upper_USA
  ),
  ci_column = c(2, 5),
  ref_line = c(0, 0),
  sizes = 0.7,
  xlim = list(
    c(-0.3, 0.3),
    c(-0.3, 0.3)
    ),            
  ticks_at = list(
    c(-0.3, -0.15, 0, 0.15, 0.3), 
    c(-0.3, -0.15, 0, 0.15, 0.3)
    ),  
  arrow_lab = c("Lower life satisfaction","Higher life satisfaction"),
  theme = theme
  )

# Add border
p_satlife_pgs <- add_border(p_satlife_pgs, part = "header", row = 1, col = c(1:6), gp = gpar(lwd = 1))

# Italic group name
p_satlife_pgs <- edit_plot(p_satlife_pgs, row = c(1, 5, 9), gp = gpar(fontface = "italic"))

#### Self-rated health ####
dat <- shlt_iyes_adj_wellbpgs_re %>%
  bind_rows(
    tibble(
      country = "England", wellbpgs = "low", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "England", wellbpgs = "intermediate", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "England", wellbpgs = "high", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
    bind_rows(
    tibble(
      country = "USA", wellbpgs = "low", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "USA", wellbpgs = "intermediate", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "USA", wellbpgs = "high", term = "no",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = ifelse(term == "no", "Reference", beta_ci),
    blank = paste(rep(" ", 10), collapse = " "),
    plot_ci = paste(rep(" ", 20), collapse = " "),
    term = str_c(wellbpgs, term, sep = "."),
    term = factor(term, levels = c("low.no", "low.internet_yesyes", "intermediate.no", "intermediate.internet_yesyes", "high.no", "high.internet_yesyes"), labels = c("  No internet use", "  Internet use", "  No internet use", "  Internet use", "  No internet use", "  Internet use")),
    wellbpgs = factor(wellbpgs, levels = c("low", "intermediate", "high"), labels = c("Low genetic risk", "Intermediate genetic risk", "High genetic risk"))
  ) %>%
  arrange(country, wellbpgs, term)


dat_fig <- dat %>%
  select(country, wellbpgs, term, estimate, lower, upper, beta_ci, blank, plot_ci) %>%
  pivot_wider(
    names_from = country,
    values_from = c(estimate, lower, upper, beta_ci, blank, plot_ci)
  ) %>%
  add_row(
    term = "Low genetic risk",
    beta_ci_England = "", beta_ci_USA = "",
    plot_ci_England = paste(rep(" ", 20), collapse = " "), 
    blank_England = paste(rep(" ", 10), collapse = " "),
    plot_ci_USA = paste(rep(" ", 20), collapse = " ")
    ) %>%
  add_row(
    term = "Intermediate genetic risk",
    beta_ci_England = "", beta_ci_USA = "",
    plot_ci_England = paste(rep(" ", 20), collapse = " "), 
    blank_England = paste(rep(" ", 10), collapse = " "),
    plot_ci_USA = paste(rep(" ", 20), collapse = " ")
    ) %>%
  add_row(
    term = "High genetic risk",
    beta_ci_England = "", beta_ci_USA = "",
    plot_ci_England = paste(rep(" ", 20), collapse = " "), 
    blank_England = paste(rep(" ", 10), collapse = " "),
    plot_ci_USA = paste(rep(" ", 20), collapse = " ")
    ) %>%
  add_row(
    term = "",
    beta_ci_England = "", beta_ci_USA = "",
    plot_ci_England = paste(rep(" ", 20), collapse = " "),
    blank_England = paste(rep(" ", 10), collapse = " "),
    plot_ci_USA = paste(rep(" ", 20), collapse = " ")
    ) %>%
  add_row(
    term = "",
    beta_ci_England = "", beta_ci_USA = "",
    plot_ci_England = paste(rep(" ", 20), collapse = " "),
    blank_England = paste(rep(" ", 10), collapse = " "),
    plot_ci_USA = paste(rep(" ", 20), collapse = " ")
    ) %>%
  select(
    term, estimate_England, estimate_USA, 
    lower_England, lower_USA,
    upper_England, upper_USA, 
    plot_ci_England, beta_ci_England, blank_England,
    plot_ci_USA, beta_ci_USA
    )
dat_fig <- dat_fig[c(7,1:2,10, 8,3:4,11, 9,5:6),]
colnames(dat_fig)[colnames(dat_fig) == "term"] <- "Groups"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_England"] <- "England"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_USA"] <- "USA"
colnames(dat_fig)[colnames(dat_fig) %in% c("beta_ci_England", "beta_ci_USA")] <- "β (95% CI)"
colnames(dat_fig)[colnames(dat_fig) %in% c("blank_England", "blank_USA")] <- " "

p_shlt_pgs <- forestploter::forest(
  dat_fig[,c(1, 8:12)],
  est = list(
    dat_fig$estimate_England,
    dat_fig$estimate_USA
  ),
  lower = list(
    dat_fig$lower_England,
    dat_fig$lower_USA
  ),
  upper = list(
    dat_fig$upper_England,
    dat_fig$upper_USA
  ),
  ci_column = c(2, 5),
  ref_line = c(0, 0),
  sizes = 0.7,
  xlim = list(
    c(-0.15, 0.3),
    c(-0.15, 0.3)
    ),            
  ticks_at = list(
    c(-0.15, 0, 0.15, 0.3), 
    c(-0.15, 0, 0.15, 0.3)
    ),  
  arrow_lab = c("Worse self-reported health","Better self-reported health"),
  theme = theme
  )

# Add border
p_shlt_pgs <- add_border(p_shlt_pgs, part = "header", row = 1, col = c(1:6), gp = gpar(lwd = 1))

# Italic group name
p_shlt_pgs <- edit_plot(p_shlt_pgs, row = c(1, 5, 9), gp = gpar(fontface = "italic"))


#### CES-D joint ####
dat <- cesd_iyes_adj_wellbpgs_joint_re %>%
  add_row(
    country = "England", term = "jointwellbno.high", estimate = 0, std.error = 0
  ) %>%
  add_row(
    country = "USA", term = "jointwellbno.high", estimate = 0, std.error = 0
  ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = ifelse(term == "jointwellbno.high", "Reference", beta_ci),
    blank = paste(rep(" ", 10), collapse = " "),
    plot_ci = paste(rep(" ", 20), collapse = " "),
    term = factor(term, levels = c("jointwellbno.high", "jointwellbyes.high", "jointwellbno.intermediate", "jointwellbyes.intermediate", "jointwellbno.low", "jointwellbyes.low"))
  ) %>%
  arrange(country, term) %>%
  separate(term, c("internet_yes", "pgs")) %>%
  mutate(
    pgs = factor(pgs, levels = c("high", "intermediate", "low"), labels = c("High genetic risk", "Intermediate genetic risk", "Low genetic risk")),
    internet_yes = factor(internet_yes, levels = c("jointwellbno", "jointwellbyes"), labels = c("No", "Yes"))
  )


dat_fig <- dat %>%
  select(country, pgs, internet_yes, estimate, lower, upper, beta_ci, blank, plot_ci) %>%
  pivot_wider(
    names_from = country,
    values_from = c(estimate, lower, upper, beta_ci, blank, plot_ci)
  ) %>%
  select(
    pgs, internet_yes, estimate_England, estimate_USA, 
    lower_England, lower_USA,
    upper_England, upper_USA, 
    plot_ci_England, beta_ci_England, blank_England,
    plot_ci_USA, beta_ci_USA
    )
colnames(dat_fig)[colnames(dat_fig) == "pgs"] <- "Polygenic risk score"
colnames(dat_fig)[colnames(dat_fig) == "internet_yes"] <- "Internet use"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_England"] <- "England"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_USA"] <- "USA"
colnames(dat_fig)[colnames(dat_fig) %in% c("beta_ci_England", "beta_ci_USA")] <- "β (95% CI)"
colnames(dat_fig)[colnames(dat_fig) %in% c("blank_England", "blank_USA")] <- " "

p_cesd_joint <- forestploter::forest(
  dat_fig[,c(1,2, 9:13)],
  est = list(
    dat_fig$estimate_England,
    dat_fig$estimate_USA
  ),
  lower = list(
    dat_fig$lower_England,
    dat_fig$lower_USA
  ),
  upper = list(
    dat_fig$upper_England,
    dat_fig$upper_USA
  ),
  ci_column = c(3, 6),
  ref_line = c(0, 0),
  sizes = 0.7,
  xlim = list(
    c(-0.4, 0.1),
    c(-0.4, 0.1)
    ),            
  ticks_at = list(
    c(-0.4, -0.3, -0.2, -0.1, 0, 0.1), 
    c(-0.4, -0.3, -0.2, -0.1, 0, 0.1)
    ),  
  arrow_lab = c("Fewer depressive symptoms","More depressive symptoms"),
  theme = theme
  )

# Add border
p_cesd_joint <- add_border(p_cesd_joint, part = "header", row = 1, col = c(1:7), gp = gpar(lwd = 1))

#### Life satisfaction joint ####
dat <- satlife_iyes_adj_wellbpgs_joint_re %>%
  add_row(
    country = "England", term = "jointwellbno.high", estimate = 0, std.error = 0
  ) %>%
  add_row(
    country = "USA", term = "jointwellbno.high", estimate = 0, std.error = 0
  ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = ifelse(term == "jointwellbno.high", "Reference", beta_ci),
    blank = paste(rep(" ", 10), collapse = " "),
    plot_ci = paste(rep(" ", 20), collapse = " "),
    term = factor(term, levels = c("jointwellbno.high", "jointwellbyes.high", "jointwellbno.intermediate", "jointwellbyes.intermediate", "jointwellbno.low", "jointwellbyes.low"))
  ) %>%
  arrange(country, term) %>%
  separate(term, c("internet_yes", "pgs")) %>%
  mutate(
    pgs = factor(pgs, levels = c("high", "intermediate", "low"), labels = c("High genetic risk", "Intermediate genetic risk", "Low genetic risk")),
    internet_yes = factor(internet_yes, levels = c("jointwellbno", "jointwellbyes"), labels = c("No", "Yes"))
  )

dat_fig <- dat %>%
  select(country, pgs, internet_yes, estimate, lower, upper, beta_ci, blank, plot_ci) %>%
  pivot_wider(
    names_from = country,
    values_from = c(estimate, lower, upper, beta_ci, blank, plot_ci)
  ) %>%
  select(
    pgs, internet_yes, estimate_England, estimate_USA, 
    lower_England, lower_USA,
    upper_England, upper_USA, 
    plot_ci_England, beta_ci_England, blank_England,
    plot_ci_USA, beta_ci_USA
    )
colnames(dat_fig)[colnames(dat_fig) == "pgs"] <- "Polygenic risk score"
colnames(dat_fig)[colnames(dat_fig) == "internet_yes"] <- "Internet use"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_England"] <- "England"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_USA"] <- "USA"
colnames(dat_fig)[colnames(dat_fig) %in% c("beta_ci_England", "beta_ci_USA")] <- "β (95% CI)"
colnames(dat_fig)[colnames(dat_fig) %in% c("blank_England", "blank_USA")] <- " "

p_satlife_joint <- forestploter::forest(
  dat_fig[,c(1,2, 9:13)],
  est = list(
    dat_fig$estimate_England,
    dat_fig$estimate_USA
  ),
  lower = list(
    dat_fig$lower_England,
    dat_fig$lower_USA
  ),
  upper = list(
    dat_fig$upper_England,
    dat_fig$upper_USA
  ),
  ci_column = c(3, 6),
  ref_line = c(0, 0),
  sizes = 0.7,
  xlim = list(
    c(-0.15, 0.3),
    c(-0.15, 0.3)
    ),            
  ticks_at = list(
    c(-0.15, 0, 0.15, 0.3), 
    c(-0.15, 0, 0.15, 0.3)
    ),  
  arrow_lab = c("Lower life satisfaction","Higher life satisfaction"),
  theme = theme
  )

# Add border
p_satlife_joint <- add_border(p_satlife_joint, part = "header", row = 1, col = c(1:7), gp = gpar(lwd = 1))

#### Self-rated health joint ####
dat <- shlt_iyes_adj_wellbpgs_joint_re %>%
  add_row(
    country = "England", term = "jointwellbno.high", estimate = 0, std.error = 0
  ) %>%
  add_row(
    country = "USA", term = "jointwellbno.high", estimate = 0, std.error = 0
  ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = ifelse(term == "jointwellbno.high", "Reference", beta_ci),
    blank = paste(rep(" ", 10), collapse = " "),
    plot_ci = paste(rep(" ", 20), collapse = " "),
    term = factor(term, levels = c("jointwellbno.high", "jointwellbyes.high", "jointwellbno.intermediate", "jointwellbyes.intermediate", "jointwellbno.low", "jointwellbyes.low"))
  ) %>%
  arrange(country, term) %>%
  separate(term, c("internet_yes", "pgs")) %>%
  mutate(
    pgs = factor(pgs, levels = c("high", "intermediate", "low"), labels = c("High genetic risk", "Intermediate genetic risk", "Low genetic risk")),
    internet_yes = factor(internet_yes, levels = c("jointwellbno", "jointwellbyes"), labels = c("No", "Yes"))
  )


dat_fig <- dat %>%
  select(country, pgs, internet_yes, estimate, lower, upper, beta_ci, blank, plot_ci) %>%
  pivot_wider(
    names_from = country,
    values_from = c(estimate, lower, upper, beta_ci, blank, plot_ci)
  ) %>%
  select(
    pgs, internet_yes, estimate_England, estimate_USA, 
    lower_England, lower_USA,
    upper_England, upper_USA, 
    plot_ci_England, beta_ci_England, blank_England,
    plot_ci_USA, beta_ci_USA
    )
colnames(dat_fig)[colnames(dat_fig) == "pgs"] <- "Polygenic risk score"
colnames(dat_fig)[colnames(dat_fig) == "internet_yes"] <- "Internet use"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_England"] <- "England"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_USA"] <- "USA"
colnames(dat_fig)[colnames(dat_fig) %in% c("beta_ci_England", "beta_ci_USA")] <- "β (95% CI)"
colnames(dat_fig)[colnames(dat_fig) %in% c("blank_England", "blank_USA")] <- " "

p_shlt_joint <- forestploter::forest(
  dat_fig[,c(1,2, 9:13)],
  est = list(
    dat_fig$estimate_England,
    dat_fig$estimate_USA
  ),
  lower = list(
    dat_fig$lower_England,
    dat_fig$lower_USA
  ),
  upper = list(
    dat_fig$upper_England,
    dat_fig$upper_USA
  ),
  ci_column = c(3, 6),
  ref_line = c(0, 0),
  sizes = 0.7,
  xlim = list(
    c(-0.2, 0.4),
    c(-0.2, 0.4)
    ),            
  ticks_at = list(
    c(-0.2, 0, 0.2, 0.4), 
    c(-0.2, 0, 0.2, 0.4)
    ),  
  arrow_lab = c("Worse self-reported health","Better self-reported health"),
  theme = theme
  )

# Add border
p_shlt_joint <- add_border(p_shlt_joint, part = "header", row = 1, col = c(1:7), gp = gpar(lwd = 1))

#### Pool ####
p_pool_pgs <- wrap_elements(
  (wrap_elements(p_cesd_pgs) + labs(tag = "a")) + (wrap_elements(p_satlife_pgs) + labs(tag = "b")) + (wrap_elements(p_shlt_pgs) + labs(tag = "c")) +
    plot_layout(nrow = 3)
  )

p_pool_joint <- wrap_elements(
  (wrap_elements(p_cesd_joint) + labs(tag = "d")) + (wrap_elements(p_satlife_joint) + labs(tag = "e")) + (wrap_elements(p_shlt_joint) + labs(tag = "f")) +
    plot_layout(nrow = 3)
  )

p_pool <- wrap_elements(
  p_pool_pgs + p_pool_joint +
    plot_layout(ncol = 2)
  )

ggsave(str_c(getwd(), "/results/Figure/Extended Data Figure 4_Forest plot_internet use and well-being pgs.tiff"), plot = p_pool, width = 20, height = 12, unit = "in", dpi = 300, device = "tiff")

```

## Supplementary Table 4: baseline characteristics 

```{r}

baseline_cov <- final_iyes_pgs_merge %>% 
  group_by(id) %>%
  slice(1) %>%
  ungroup() %>%
  dplyr::select(
    country_names, 
    internet_yes, highdeprepgs, highwellbpgs, 
    cesd, shlt, satlife,
    age, male, nonmarried, hhres, lowedu, lowwealth, lbrf,
    smoken, weekdrink, phyinact,
    dis, adl_any, iadl
  ) 

var_need <- c("internet_yes", "highdeprepgs", "highwellbpgs", "cesd", "shlt", "satlife", "age", "male", "nonmarried", "hhres", "lowedu", "lowwealth", "lbrf", "smoken", "weekdrink", "phyinact", "dis", "adl_any", "iadl")

var_name <- c(
  "Internet use",
  
  "Polygenic score for depressive symptoms",
  "Polygenic score for subjective well-being",
  "Depressive symptoms",
  "Self-reported health",
  "Life satisfaction",
  
  "Age (years)",
  "Male",
  "Unmarried",  
  "Household size",
  
  "Education",
  "Wealth",
  "Labor force status",

  "Current smoker",
  "Weekly alcohol use",
  "Physical inactivity",
  
  "Number of chronic conditions",
  "ADL disability", 
  "IADL"
)

label_list <- list()
for (i in 1:length(var_name)) {
  formula_str <- paste0(var_need[i], " ~ ", "\"", gsub("'", "'", var_name[i]), "\"")
  label_list[[i]] <- as.formula(formula_str)
}

tbl <- baseline_cov %>%
  mutate(
    male = relevel(factor(male, labels = c("no", "yes")), ref = "no"),
    lowedu = factor(lowedu, levels = c("primary", "secondary", "tertiary"), labels = c("Primary", "Secondary", "Tertiary")),
    lowwealth = factor(lowwealth, levels = c("3", "2", "1"), labels = c("Low", "Middle", "High")),
    lbrf = factor(lbrf, levels = c("employed", "retired", "others"), labels = c("Working", "Retired", "Others"))
  ) %>%
  tbl_summary(
    by = country_names,
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    label = label_list,
    type = list(cesd ~ "continuous", shlt ~ "continuous", satlife ~ "continuous", dis ~ "continuous",  iadl ~ "continuous"),
    digits = list(all_continuous() ~ 1, all_categorical() ~ c(0, 1)),
    missing = "no"
    )

tbl %>%
  as_flex_table() %>%
  flextable::save_as_docx(path = str_c(getwd(), "/results/Table/Supplementary Table 4_Baseline characteristics by countries_pgs.docx"))

```

# Cumulative internet use

### Merge data

```{r}

iso <- c(40, 56, 156, 203, 208, 826, 233, 250, 276, 376, 380, 442, 484, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "China", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Israel", "Italy", "Luxembourg", "Mexico", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

final_icum_merge <- final_icum_hrs %>% mutate(id = as.character(id)) %>%
  bind_rows(., final_icum_elsa %>% mutate(id = as.character(id))) %>%
  bind_rows(., final_icum_charls %>% mutate(id = as.character(id))) %>%
  bind_rows(., final_icum_share) %>%
  bind_rows(., final_icum_mhas) %>%
  mutate(
    country_names = case_when(
      country == iso[1] ~ names[1],
      country == iso[2] ~ names[2],
      country == iso[3] ~ names[3],
      country == iso[4] ~ names[4],
      country == iso[5] ~ names[5],
      country == iso[6] ~ names[6],
      country == iso[7] ~ names[7],
      country == iso[8] ~ names[8],
      country == iso[9] ~ names[9],
      country == iso[10] ~ names[10],
      country == iso[11] ~ names[11],
      country == iso[12] ~ names[12],
      country == iso[13] ~ names[13],
      country == iso[14] ~ names[14],
      country == iso[15] ~ names[15],
      country == iso[16] ~ names[16],
      country == iso[17] ~ names[17],
      country == iso[18] ~ names[18]
    )
  )

```

### CES-D

```{r}

#### lme4 ####
cesd_icum_unadj_results <- tibble()
for(i in 1:18){
  cesd_icum_unadj <- lmer(
    cesd_stand ~ internet_cum + cwave + (1 | id),
    data = final_icum_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_icum_unadj_result <- broom.mixed::tidy(cesd_icum_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_icum_unadj_results <- cesd_icum_unadj_results %>% 
    bind_rows(., cesd_icum_unadj_result)
  rm(cesd_icum_unadj, cesd_icum_unadj_result)
}

cesd_icum_adj_results <- tibble()
for(i in c(1:18)){
  cesd_icum_adj <- lmer(
    cesd_stand ~ internet_cum + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_icum_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_icum_adj_result <- broom.mixed::tidy(cesd_icum_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_icum_adj_results <- cesd_icum_adj_results %>% 
    bind_rows(., cesd_icum_adj_result)
  rm(cesd_icum_adj, cesd_icum_adj_result)
}

#### metafor ####
cesd_icum_unadj_meta <- rma(yi = estimate, sei = std.error, data = cesd_icum_unadj_results, slab = country)

cesd_icum_adj_meta <- rma(yi = estimate, sei = std.error, data = cesd_icum_adj_results, slab = country)

```


### Life satisfaction

```{r}

#### lme4 ####
satlife_icum_unadj_results <- tibble()
for(i in 1:18){
  satlife_icum_unadj <- lmer(
    satlife_stand ~ internet_cum + cwave + (1 | id),
    data = final_icum_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_icum_unadj_result <- broom.mixed::tidy(satlife_icum_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_icum_unadj_results <- satlife_icum_unadj_results %>% 
    bind_rows(., satlife_icum_unadj_result)
  rm(satlife_icum_unadj, satlife_icum_unadj_result)
}

satlife_icum_adj_results <- tibble()
for(i in c(1:18)){
  satlife_icum_adj <- lmer(
    satlife_stand ~ internet_cum + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_icum_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_icum_adj_result <- broom.mixed::tidy(satlife_icum_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_icum_adj_results <- satlife_icum_adj_results %>% 
    bind_rows(., satlife_icum_adj_result)
  rm(satlife_icum_adj, satlife_icum_adj_result)
}

#### metafor ####
satlife_icum_unadj_meta <- rma(yi = estimate, sei = std.error, data = satlife_icum_unadj_results, slab = country)

satlife_icum_adj_meta <- rma(yi = estimate, sei = std.error, data = satlife_icum_adj_results, slab = country)

```


### Self-rated health

```{r}

#### lme4 ####
shlt_icum_unadj_results <- tibble()
for(i in 1:18){
  shlt_icum_unadj <- lmer(
    shlt_stand ~ internet_cum + cwave + (1 | id),
    data = final_icum_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_icum_unadj_result <- broom.mixed::tidy(shlt_icum_unadj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_icum_unadj_results <- shlt_icum_unadj_results %>% 
    bind_rows(., shlt_icum_unadj_result)
  rm(shlt_icum_unadj, shlt_icum_unadj_result)
}

shlt_icum_adj_results <- tibble()
for(i in c(1:18)){
  shlt_icum_adj <- lmer(
    shlt_stand ~ internet_cum + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_icum_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_icum_adj_result <- broom.mixed::tidy(shlt_icum_adj) %>% 
    slice(2) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_icum_adj_results <- shlt_icum_adj_results %>% 
    bind_rows(., shlt_icum_adj_result)
  rm(shlt_icum_adj, shlt_icum_adj_result)
}

#### metafor ####
shlt_icum_unadj_meta <- rma(yi = estimate, sei = std.error, data = shlt_icum_unadj_results, slab = country)

shlt_icum_adj_meta <- rma(yi = estimate, sei = std.error, data = shlt_icum_adj_results, slab = country)

```

### Figure 5: Associations of cumulative Internet use with mental health

```{r}

#### Theme setting ####
theme <- forestploter::forest_theme(
  core = list(bg_params = list(fill = c("white"))),
  base_size = 10, 
  # base_family = "Arial",
  ci_pch = 15,
  ci_col = "#3B4992FF", 
  ci_alpha = 1,
  ci_lty = 1,
  ci_lwd = 1,
  ci_Theight = unit(0, "cm"),
  
  xaxis_lwd = 1,
  xaxis_cex = 1,
  
  summary_col = "#008B45FF", 
  refline_col = "gray", 
  refline_lwd = 2, 
  
  title_just = "center",
  title_cex = 1.2,
  title_fontface = "bold",
  title_col = "black",
  
  arrow_type = "closed",
  arrow_label_just = "end",
  arrow_length = 0.05,
  arrow_lwd = 1,
  arrow_fill = "black",
  arrow_col = "black"
  )

#### CES-D ####
# Data
dat <- cesd_icum_adj_results %>%
  mutate(weights = weights(cesd_icum_adj_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(cesd_icum_adj_meta$beta),
      std.error = as.numeric(cesd_icum_adj_meta$se), 
      statistic = NA, df = NA, p.value = NA, p.sig = NA, 
      weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "β (95% CI)", "Weight (%)")

p_cesd <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Fewer depressive symptoms","More depressive symptoms"),
  xlim = c(-0.3, 0.1),
  ticks_at = c(-0.3, -0.2, -0.1, 0, 0.1),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(cesd_icum_adj_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(cesd_icum_adj_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(cesd_icum_adj_meta$H2, digits = 2)))
    )

p_cesd <- add_text(
  p_cesd, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- bquote(
    paste(
      "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
      "Q (", .(cesd_icum_adj_meta$k - cesd_icum_adj_meta$p), ") = ", 
      .(fmtx(cesd_icum_adj_meta$QE, digits = 2)), ", ",
      italic(P), " < 0.001"
      )
)

test_hetero <- 
  if(cesd_icum_adj_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(cesd_icum_adj_meta$k - cesd_icum_adj_meta$p), ") = ", 
        .(fmtx(cesd_icum_adj_meta$QE, digits = 2)), ", ",
        
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(cesd_icum_adj_meta$k - cesd_icum_adj_meta$p), ") = ", 
        .(fmtx(cesd_icum_adj_meta$QE, digits = 2)), ", ",
        .(fmtp(cesd_icum_adj_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )
  }

p_cesd <- add_text(
  p_cesd, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(cesd_icum_adj_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(cesd_icum_adj_meta$zval, digits = 2)), ", ",
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(cesd_icum_adj_meta$zval, digits = 2)), ", ",
        .(fmtp(cesd_icum_adj_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )    
  }

p_cesd <- add_text(
  p_cesd, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_cesd <- add_border(p_cesd, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))


#### Self-rated health ####
# Data
dat <- shlt_icum_adj_results %>%
  mutate(weights = weights(shlt_icum_adj_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(shlt_icum_adj_meta$beta),
      std.error = as.numeric(shlt_icum_adj_meta$se), 
      statistic = NA, df = NA, p.value = NA, p.sig = NA, 
      weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "β (95% CI)", "Weight (%)")


p_shlt <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Worse self-reported health","Better self-reported health"),
  xlim = c(-0.1, 0.3),
  ticks_at = c(-0.1, 0, 0.1, 0.2, 0.3),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(shlt_icum_adj_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(shlt_icum_adj_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(shlt_icum_adj_meta$H2, digits = 2)))
    )

p_shlt <- add_text(
  p_shlt, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(shlt_icum_adj_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(shlt_icum_adj_meta$k - shlt_icum_adj_meta$p), ") = ", 
        .(fmtx(shlt_icum_adj_meta$QE, digits = 2)), ", ",
        
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(shlt_icum_adj_meta$k - shlt_icum_adj_meta$p), ") = ", 
        .(fmtx(shlt_icum_adj_meta$QE, digits = 2)), ", ",
        .(fmtp(shlt_icum_adj_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )
  }

p_shlt <- add_text(
  p_shlt, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(shlt_icum_adj_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(shlt_icum_adj_meta$zval, digits = 2)), ", ",
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(shlt_icum_adj_meta$zval, digits = 2)), ", ",
        .(fmtp(shlt_icum_adj_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )    
  }

p_shlt <- add_text(
  p_shlt, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_shlt <- add_border(p_shlt, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))


#### Life satisfaction ####
# Data
dat <- satlife_icum_adj_results %>%
  mutate(weights = weights(satlife_icum_adj_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(satlife_icum_adj_meta$beta),
      std.error = as.numeric(satlife_icum_adj_meta$se), 
      statistic = NA, df = NA, p.value = NA, p.sig = NA, 
      weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "β (95% CI)", "Weight (%)")


p_satlife <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Lower life satisfaction","Higher life satisfaction"),
  xlim = c(-0.2, 0.3),
  ticks_at = c(-0.2, -0.1, 0, 0.1, 0.2, 0.3),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(satlife_icum_adj_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(satlife_icum_adj_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(satlife_icum_adj_meta$H2, digits = 2)))
    )

p_satlife <- add_text(
  p_satlife, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(satlife_icum_adj_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(satlife_icum_adj_meta$k - satlife_icum_adj_meta$p), ") = ", 
        .(fmtx(satlife_icum_adj_meta$QE, digits = 2)), ", ",
        
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(satlife_icum_adj_meta$k - satlife_icum_adj_meta$p), ") = ", 
        .(fmtx(satlife_icum_adj_meta$QE, digits = 2)), ", ",
        .(fmtp(satlife_icum_adj_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )
  }

p_satlife <- add_text(
  p_satlife, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(satlife_icum_adj_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(satlife_icum_adj_meta$zval, digits = 2)), ", ",
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(satlife_icum_adj_meta$zval, digits = 2)), ", ",
        .(fmtp(satlife_icum_adj_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )    
  }

p_satlife <- add_text(
  p_satlife, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_satlife <- add_border(p_satlife, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))

#### Pool ####
p_pool <- wrap_elements(
  wrap_elements(p_cesd) + wrap_elements(p_satlife) + wrap_elements(p_shlt) + 
    plot_layout(nrow = 2) + 
    plot_annotation(tag_levels = "a")
  ) 

ggsave(str_c(getwd(), "/results/Figure/Figure 5_Forest plot_cumulative internet use.tiff"), plot = p_pool, width = 16, height = 12, unit = "in", dpi = 500, device = "tiff")

```

### Supplementary Table 2: baseline characteristics 

```{r}

baseline_cov <- final_icum_merge %>% 
  group_by(id) %>%
  slice(1) %>%
  ungroup() %>%
  dplyr::select(
    country_names, 
    internet_cum, 
    cesd, shlt, satlife,
    age, male, lowedu, lowwealth, lbrf,
    nonmarried, hhres, smoken, weekdrink, phyinact,
    dis, adl_any, iadl
  )

var_need <- c("internet_cum", "cesd", "shlt", "satlife", "age", "male", "lowedu", "lowwealth", "lbrf", "nonmarried", "hhres", "smoken", "weekdrink", "phyinact", "dis", "adl_any", "iadl")

var_name <- c(
  "Cumulative internet use",
  
  "Depressive symptoms",
  "Self-reported health",
  "Life satisfaction",
  
  "Age (years)",
  "Male",
  "Education",
  "Wealth",
  "Labor force status",

  "Unmarried",  
  "Household size",
  "Current smoker",
  "Weekly alcohol use",
  "Physical inactivity",
  
  "Number of chronic conditions",
  "ADL disability", 
  "IADL"
)

label_list <- list()
for (i in 1:length(var_name)) {
  formula_str <- paste0(var_need[i], " ~ ", "\"", gsub("'", "'", var_name[i]), "\"")
  label_list[[i]] <- as.formula(formula_str)
}

tbl <- baseline_cov %>%
  mutate(
    male = relevel(factor(male, labels = c("no", "yes")), ref = "no"),
    lowedu = factor(lowedu, levels = c("primary", "secondary", "tertiary"), labels = c("Primary", "Secondary", "Tertiary")),
    lowwealth = factor(lowwealth, levels = c("3", "2", "1"), labels = c("Low", "Middle", "High")),
    lbrf = factor(lbrf, levels = c("employed", "retired", "others"), labels = c("Working", "Retired", "Others"))
  ) %>%
  tbl_summary(
    by = country_names,
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    label = label_list,
    type = list(internet_cum ~ "continuous", cesd ~ "continuous", shlt ~ "continuous", satlife ~ "continuous", dis ~ "continuous",  iadl ~ "continuous"),
    digits = list(all_continuous() ~ 1, all_categorical() ~ c(0, 1)),
    missing = "no"
    )

tbl %>%
  as_flex_table() %>%
  flextable::save_as_docx(path = str_c(getwd(), "/results/Table/Supplementary Table 2_Baseline characteristics by countries_cumulative internet use.docx"))

```


# Internet use frequency

## Merge data

```{r}

iso <- c(156, 826, 840)

names <- c("China", "England", "USA")

final_ifreq_merge <- final_ifreq_hrs %>% mutate(id = as.character(id)) %>%
  bind_rows(., final_ifreq_elsa %>% mutate(id = as.character(id))) %>%
  bind_rows(., final_ifreq_charls %>% mutate(id = as.character(id))) %>%
  mutate(
    country_names = case_when(
      country == iso[1] ~ names[1],
      country == iso[2] ~ names[2],
      country == iso[3] ~ names[3]
    )
  )

```

## CES-D

```{r}

cesd_ifreq_unadj_results <- tibble()
for(i in 1:3){
  cesd_ifreq_unadj <- lmer(
    cesd_stand ~ internet_freq + cwave + (1 | id),
    data = final_ifreq_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_ifreq_unadj_result <- broom.mixed::tidy(cesd_ifreq_unadj) %>% 
    slice(2:4) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_ifreq_unadj_results <- cesd_ifreq_unadj_results %>% 
    bind_rows(., cesd_ifreq_unadj_result)
  rm(cesd_ifreq_unadj, cesd_ifreq_unadj_result)
}

cesd_ifreq_adj_results <- tibble()
for(i in 1:3){
  cesd_ifreq_adj <- lmer(
    cesd_stand ~ internet_freq + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_ifreq_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  cesd_ifreq_adj_result <- broom.mixed::tidy(cesd_ifreq_adj) %>% 
    slice(2:4) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  cesd_ifreq_adj_results <- cesd_ifreq_adj_results %>% 
    bind_rows(., cesd_ifreq_adj_result)
  rm(cesd_ifreq_adj, cesd_ifreq_adj_result)
}

cesd_ifreq_adj_results

```

## Life satisfaction

```{r}

satlife_ifreq_unadj_results <- tibble()
for(i in 1:3){
  satlife_ifreq_unadj <- lmer(
    satlife_stand ~ internet_freq + cwave + (1 | id),
    data = final_ifreq_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_ifreq_unadj_result <- broom.mixed::tidy(satlife_ifreq_unadj) %>% 
    slice(2:4) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_ifreq_unadj_results <- satlife_ifreq_unadj_results %>% 
    bind_rows(., satlife_ifreq_unadj_result)
  rm(satlife_ifreq_unadj, satlife_ifreq_unadj_result)
}

satlife_ifreq_adj_results <- tibble()
for(i in 1:3){
  satlife_ifreq_adj <- lmer(
    satlife_stand ~ internet_freq + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_ifreq_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  satlife_ifreq_adj_result <- broom.mixed::tidy(satlife_ifreq_adj) %>% 
    slice(2:4) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  satlife_ifreq_adj_results <- satlife_ifreq_adj_results %>% 
    bind_rows(., satlife_ifreq_adj_result)
  rm(satlife_ifreq_adj, satlife_ifreq_adj_result)
}

satlife_ifreq_adj_results

```

## Self-rated health

```{r}

shlt_ifreq_unadj_results <- tibble()
for(i in 1:3){
  shlt_ifreq_unadj <- lmer(
    shlt_stand ~ internet_freq + cwave + (1 | id),
    data = final_ifreq_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_ifreq_unadj_result <- broom.mixed::tidy(shlt_ifreq_unadj) %>% 
    slice(2:4) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_ifreq_unadj_results <- shlt_ifreq_unadj_results %>% 
    bind_rows(., shlt_ifreq_unadj_result)
  rm(shlt_ifreq_unadj, shlt_ifreq_unadj_result)
}

shlt_ifreq_adj_results <- tibble()
for(i in 1:3){
  shlt_ifreq_adj <- lmer(
    shlt_stand ~ internet_freq + cwave + 
      age + male + lowedu + lowwealth + lbrf + 
      nonmarried + hhres + smoken + weekdrink + phyinact + 
      dis + adl_any + iadl + 
      (1 | id),
    data = final_ifreq_merge %>% filter(country_names == names[i]), 
    control = lmerControl(optimizer = "bobyqa")
    )
  shlt_ifreq_adj_result <- broom.mixed::tidy(shlt_ifreq_adj) %>% 
    slice(2:4) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  
  shlt_ifreq_adj_results <- shlt_ifreq_adj_results %>% 
    bind_rows(., shlt_ifreq_adj_result)
  rm(shlt_ifreq_adj, shlt_ifreq_adj_result)
}

shlt_ifreq_adj_results

```

## Forest plot

### Figure 6: Associations of Internet use frequency with mental health (adjusted)

```{r}

#### Theme setting ####
theme <- forestploter::forest_theme(
  core = list(bg_params = list(fill = c("white"))),
  base_size = 10, 
  # base_family = "Arial",
  ci_pch = 15,
  ci_col = "#3B4992FF", 
  ci_alpha = 1,
  ci_lty = 1,
  ci_lwd = 1,
  ci_Theight = unit(0, "cm"),
  
  xaxis_lwd = 1,
  xaxis_cex = 1,
  
  summary_col = "#008B45FF", 
  refline_col = "gray", 
  refline_lwd = 2, 
  
  title_just = "center",
  title_cex = 1.2,
  title_fontface = "bold",
  title_col = "black",
  
  arrow_type = "closed",
  arrow_label_just = "end",
  arrow_length = 0.05,
  arrow_lwd = 1,
  arrow_fill = "black",
  arrow_col = "black"
  )

#### CES-D ####
dat <- cesd_ifreq_adj_results %>%
  bind_rows(
    tibble(
      country = "China", term = "never",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "England", term = "never",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "USA", term = "never",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = ifelse(term == "never", "Reference", beta_ci),
    blank = paste(rep(" ", 10), collapse = " "),
    plot_ci = paste(rep(" ", 20), collapse = " "),
    term = factor(term, levels = c("never", "internet_freqnotregularly", "internet_freqweekly", "internet_freqdaily"), labels = c("  Never", "  Less than weekly", "  Weekly", "  Daily"))
  ) %>%
  arrange(country, term)

dat_fig <- dat %>%
  select(country, term, estimate, lower, upper, beta_ci, blank, plot_ci) %>%
  pivot_wider(
    names_from = country,
    values_from = c(estimate, lower, upper, beta_ci, blank, plot_ci)
  ) %>%
  select(
    term, estimate_China, estimate_England, estimate_USA, 
    lower_China, lower_England, lower_USA,
    upper_China, upper_England, upper_USA, 
    plot_ci_China, beta_ci_China, blank_China,
    plot_ci_England, beta_ci_England, blank_England,
    plot_ci_USA, beta_ci_USA
    )
colnames(dat_fig)[colnames(dat_fig) == "term"] <- "Internet use frequency"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_China"] <- "China"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_England"] <- "England"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_USA"] <- "USA"
colnames(dat_fig)[colnames(dat_fig) %in% c("beta_ci_China", "beta_ci_England", "beta_ci_USA")] <- "β (95% CI)"
colnames(dat_fig)[colnames(dat_fig) %in% c("blank_China", "blank_England", "blank_USA")] <- " "

p_cesd <- forestploter::forest(
  dat_fig[,c(1, 11:18)],
  est = list(
    dat_fig$estimate_China,
    dat_fig$estimate_England,
    dat_fig$estimate_USA
  ),
  lower = list(
    dat_fig$lower_China,
    dat_fig$lower_England,
    dat_fig$lower_USA
  ),
  upper = list(
    dat_fig$upper_China,
    dat_fig$upper_England,
    dat_fig$upper_USA
  ),
  ci_column = c(2, 5, 8),
  ref_line = c(0, 0, 0),
  sizes = 0.7,
  xlim = list(
    c(-1.2, 1.2), 
    c(-1.2, 1.2),
    c(-1.2, 1.2)
    ),            
  ticks_at = list(
    c(-1.2, -0.6, 0, 0.6, 1.2), 
    c(-1.2, -0.6, 0, 0.6, 1.2), 
    c(-1.2, -0.6, 0, 0.6, 1.2)
    ),  
  arrow_lab = c("Fewer depressive symptoms","More depressive symptoms"),
  theme = theme
  )

# Add border
p_cesd <- add_border(p_cesd, part = "header", row = 1, col = c(1:9), gp = gpar(lwd = 1))


#### Life satisfaction ####
dat <- satlife_ifreq_adj_results %>%
  bind_rows(
    tibble(
      country = "China", term = "never",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "England", term = "never",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "USA", term = "never",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = ifelse(term == "never", "Reference", beta_ci),
    blank = paste(rep(" ", 10), collapse = " "),
    plot_ci = paste(rep(" ", 20), collapse = " "),
    term = factor(term, levels = c("never", "internet_freqnotregularly", "internet_freqweekly", "internet_freqdaily"), labels = c("  Never", "  Less than weekly", "  Weekly", "  Daily"))
  ) %>%
  arrange(country, term)

dat_fig <- dat %>%
  select(country, term, estimate, lower, upper, beta_ci, blank, plot_ci) %>%
  pivot_wider(
    names_from = country,
    values_from = c(estimate, lower, upper, beta_ci, blank, plot_ci)
  ) %>%
  select(
    term, estimate_China, estimate_England, estimate_USA, 
    lower_China, lower_England, lower_USA,
    upper_China, upper_England, upper_USA, 
    plot_ci_China, beta_ci_China, blank_China,
    plot_ci_England, beta_ci_England, blank_England,
    plot_ci_USA, beta_ci_USA
    )
colnames(dat_fig)[colnames(dat_fig) == "term"] <- "Internet use frequency"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_China"] <- "China"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_England"] <- "England"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_USA"] <- "USA"
colnames(dat_fig)[colnames(dat_fig) %in% c("beta_ci_China", "beta_ci_England", "beta_ci_USA")] <- "β (95% CI)"
colnames(dat_fig)[colnames(dat_fig) %in% c("blank_China", "blank_England", "blank_USA")] <- " "


p_satlife <- forestploter::forest(
  dat_fig[,c(1, 11:18)],
  est = list(
    dat_fig$estimate_China,
    dat_fig$estimate_England,
    dat_fig$estimate_USA
  ),
  lower = list(
    dat_fig$lower_China,
    dat_fig$lower_England,
    dat_fig$lower_USA
  ),
  upper = list(
    dat_fig$upper_China,
    dat_fig$upper_England,
    dat_fig$upper_USA
  ),
  ci_column = c(2, 5, 8),
  ref_line = c(0, 0, 0),
  sizes = 0.7,
  xlim = list(
    c(-1.4, 0.7), 
    c(-1.4, 0.7),
    c(-1.4, 0.7)
    ),            
  ticks_at = list(
    c(-1.4, -0.7, 0, 0.7), 
    c(-1.4, -0.7, 0, 0.7), 
    c(-1.4, -0.7, 0, 0.7)
    ),  
  arrow_lab = c("Lower life satisfaction","Higher life satisfaction"),
  theme = theme
  )

# Add border
p_satlife <- add_border(p_satlife, part = "header", row = 1, col = c(1:9), gp = gpar(lwd = 1))


#### Self-rated health ####
dat <- shlt_ifreq_adj_results %>%
  bind_rows(
    tibble(
      country = "China", term = "never",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "England", term = "never",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "USA", term = "never",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = ifelse(term == "never", "Reference", beta_ci),
    blank = paste(rep(" ", 10), collapse = " "),
    plot_ci = paste(rep(" ", 20), collapse = " "),
    term = factor(term, levels = c("never", "internet_freqnotregularly", "internet_freqweekly", "internet_freqdaily"), labels = c("  Never", "  Less than weekly", "  Weekly", "  Daily"))
  ) %>%
  arrange(country, term)

dat_fig <- dat %>%
  select(country, term, estimate, lower, upper, beta_ci, blank, plot_ci) %>%
  pivot_wider(
    names_from = country,
    values_from = c(estimate, lower, upper, beta_ci, blank, plot_ci)
  ) %>%
  select(
    term, estimate_China, estimate_England, estimate_USA, 
    lower_China, lower_England, lower_USA,
    upper_China, upper_England, upper_USA, 
    plot_ci_China, beta_ci_China, blank_China,
    plot_ci_England, beta_ci_England, blank_England,
    plot_ci_USA, beta_ci_USA
    )
colnames(dat_fig)[colnames(dat_fig) == "term"] <- "Internet use frequency"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_China"] <- "China"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_England"] <- "England"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_USA"] <- "USA"
colnames(dat_fig)[colnames(dat_fig) %in% c("beta_ci_China", "beta_ci_England", "beta_ci_USA")] <- "β (95% CI)"
colnames(dat_fig)[colnames(dat_fig) %in% c("blank_China", "blank_England", "blank_USA")] <- " "

p_shlt <- forestploter::forest(
  dat_fig[,c(1, 11:18)],
  est = list(
    dat_fig$estimate_China,
    dat_fig$estimate_England,
    dat_fig$estimate_USA
  ),
  lower = list(
    dat_fig$lower_China,
    dat_fig$lower_England,
    dat_fig$lower_USA
  ),
  upper = list(
    dat_fig$upper_China,
    dat_fig$upper_England,
    dat_fig$upper_USA
  ),
  ci_column = c(2, 5, 8),
  ref_line = c(0, 0, 0),
  sizes = 0.7,
  xlim = list(
    c(-0.7, 1.4), 
    c(-0.7, 1.4),
    c(-0.7, 1.4)
    ),            
  ticks_at = list(
    c(-0.7, 0, 0.7, 1.4), 
    c(-0.7, 0, 0.7, 1.4), 
    c(-0.7, 0, 0.7, 1.4)
    ),  
  arrow_lab = c("Worse self-reported health","Better self-reported health"),
  theme = theme
  )

# Add border
p_shlt <- add_border(p_shlt, part = "header", row = 1, col = c(1:9), gp = gpar(lwd = 1))

#### Pool ####
p_pool <- wrap_elements(
  wrap_elements(p_cesd) + wrap_elements(p_satlife) + wrap_elements(p_shlt) + 
    plot_layout(nrow = 3) + 
    plot_annotation(tag_levels = "a")
  ) 

ggsave(str_c(getwd(), "/results/Figure/Figure 6_Forest plot_internet use frequency.tiff"), plot = p_pool, width = 13, height = 8, unit = "in", dpi = 500, device = "tiff")

```

### Supplementary Figure 1: Associations of Internet use frequency with mental health (unadjusted)

```{r}

#### Theme setting ####
theme <- forestploter::forest_theme(
  core = list(bg_params = list(fill = c("white"))), 
  base_size = 10, 
  # base_family = "Arial",
  ci_pch = 15,
  ci_col = "#3B4992FF", 
  ci_alpha = 1,
  ci_lty = 1,
  ci_lwd = 1,
  ci_Theight = unit(0, "cm"),
  
  xaxis_lwd = 1,
  xaxis_cex = 1,
  
  summary_col = "#008B45FF", 
  refline_col = "gray", 
  refline_lwd = 2, 
  
  title_just = "center",
  title_cex = 1.2,
  title_fontface = "bold",
  title_col = "black",
  
  arrow_type = "closed",
  arrow_label_just = "end",
  arrow_length = 0.05,
  arrow_lwd = 1,
  arrow_fill = "black",
  arrow_col = "black"
  )

#### CES-D ####
dat <- cesd_ifreq_unadj_results %>%
  bind_rows(
    tibble(
      country = "China", term = "never",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "England", term = "never",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "USA", term = "never",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = ifelse(term == "never", "Reference", beta_ci),
    blank = paste(rep(" ", 10), collapse = " "),
    plot_ci = paste(rep(" ", 20), collapse = " "),
    term = factor(term, levels = c("never", "internet_freqnotregularly", "internet_freqweekly", "internet_freqdaily"), labels = c("  Never", "  Less than weekly", "  Weekly", "  Daily"))
  ) %>%
  arrange(country, term)

dat_fig <- dat %>%
  select(country, term, estimate, lower, upper, beta_ci, blank, plot_ci) %>%
  pivot_wider(
    names_from = country,
    values_from = c(estimate, lower, upper, beta_ci, blank, plot_ci)
  ) %>%
  select(
    term, estimate_China, estimate_England, estimate_USA, 
    lower_China, lower_England, lower_USA,
    upper_China, upper_England, upper_USA, 
    plot_ci_China, beta_ci_China, blank_China,
    plot_ci_England, beta_ci_England, blank_England,
    plot_ci_USA, beta_ci_USA
    )
colnames(dat_fig)[colnames(dat_fig) == "term"] <- "Internet use frequency"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_China"] <- "China"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_England"] <- "England"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_USA"] <- "USA"
colnames(dat_fig)[colnames(dat_fig) %in% c("beta_ci_China", "beta_ci_England", "beta_ci_USA")] <- "β (95% CI)"
colnames(dat_fig)[colnames(dat_fig) %in% c("blank_China", "blank_England", "blank_USA")] <- " "

p_cesd <- forestploter::forest(
  dat_fig[,c(1, 11:18)],
  est = list(
    dat_fig$estimate_China,
    dat_fig$estimate_England,
    dat_fig$estimate_USA
  ),
  lower = list(
    dat_fig$lower_China,
    dat_fig$lower_England,
    dat_fig$lower_USA
  ),
  upper = list(
    dat_fig$upper_China,
    dat_fig$upper_England,
    dat_fig$upper_USA
  ),
  ci_column = c(2, 5, 8),
  ref_line = c(0, 0, 0),
  sizes = 0.7,
  xlim = list(
    c(-1.8, 0.6), 
    c(-1.8, 0.6), 
    c(-1.8, 0.6)
    ),            
  ticks_at = list(
    c(-1.8, -1.2, -0.6, 0, 0.6), 
    c(-1.8, -1.2, -0.6, 0, 0.6), 
    c(-1.8, -1.2, -0.6, 0, 0.6)
    ),  
  arrow_lab = c("Fewer depressive symptoms","More depressive symptoms"),
  theme = theme
  )

# Add border
p_cesd <- add_border(p_cesd, part = "header", row = 1, col = c(1:9), gp = gpar(lwd = 1))


#### Self-rated health ####
dat <- shlt_ifreq_unadj_results %>%
  bind_rows(
    tibble(
      country = "China", term = "never",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "England", term = "never",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "USA", term = "never",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = ifelse(term == "never", "Reference", beta_ci),
    blank = paste(rep(" ", 10), collapse = " "),
    plot_ci = paste(rep(" ", 20), collapse = " "),
    term = factor(term, levels = c("never", "internet_freqnotregularly", "internet_freqweekly", "internet_freqdaily"), labels = c("  Never", "  Less than weekly", "  Weekly", "  Daily"))
  ) %>%
  arrange(country, term)

dat_fig <- dat %>%
  select(country, term, estimate, lower, upper, beta_ci, blank, plot_ci) %>%
  pivot_wider(
    names_from = country,
    values_from = c(estimate, lower, upper, beta_ci, blank, plot_ci)
  ) %>%
  select(
    term, estimate_China, estimate_England, estimate_USA, 
    lower_China, lower_England, lower_USA,
    upper_China, upper_England, upper_USA, 
    plot_ci_China, beta_ci_China, blank_China,
    plot_ci_England, beta_ci_England, blank_England,
    plot_ci_USA, beta_ci_USA
    )
colnames(dat_fig)[colnames(dat_fig) == "term"] <- "Internet use frequency"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_China"] <- "China"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_England"] <- "England"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_USA"] <- "USA"
colnames(dat_fig)[colnames(dat_fig) %in% c("beta_ci_China", "beta_ci_England", "beta_ci_USA")] <- "β (95% CI)"
colnames(dat_fig)[colnames(dat_fig) %in% c("blank_China", "blank_England", "blank_USA")] <- " "

p_shlt <- forestploter::forest(
  dat_fig[,c(1, 11:18)],
  est = list(
    dat_fig$estimate_China,
    dat_fig$estimate_England,
    dat_fig$estimate_USA
  ),
  lower = list(
    dat_fig$lower_China,
    dat_fig$lower_England,
    dat_fig$lower_USA
  ),
  upper = list(
    dat_fig$upper_China,
    dat_fig$upper_England,
    dat_fig$upper_USA
  ),
  ci_column = c(2, 5, 8),
  ref_line = c(0, 0, 0),
  sizes = 0.7,
  xlim = list(
    c(-0.6, 1.8), 
    c(-0.6, 1.8), 
    c(-0.6, 1.8)
    ),            
  ticks_at = list(
    c(-0.6, 0, 0.6, 1.2, 1.8), 
    c(-0.6, 0, 0.6, 1.2, 1.8), 
    c(-0.6, 0, 0.6, 1.2, 1.8)
    ),  
  arrow_lab = c("Worse self-reported health","Better self-reported health"),
  theme = theme
  )

# Add border
p_shlt <- add_border(p_shlt, part = "header", row = 1, col = c(1:9), gp = gpar(lwd = 1))


#### Life satisfaction ####
dat <- satlife_ifreq_unadj_results %>%
  bind_rows(
    tibble(
      country = "China", term = "never",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "England", term = "never",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "USA", term = "never",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = ifelse(term == "never", "Reference", beta_ci),
    blank = paste(rep(" ", 10), collapse = " "),
    plot_ci = paste(rep(" ", 20), collapse = " "),
    term = factor(term, levels = c("never", "internet_freqnotregularly", "internet_freqweekly", "internet_freqdaily"), labels = c("  Never", "  Less than weekly", "  Weekly", "  Daily"))
  ) %>%
  arrange(country, term)

dat_fig <- dat %>%
  select(country, term, estimate, lower, upper, beta_ci, blank, plot_ci) %>%
  pivot_wider(
    names_from = country,
    values_from = c(estimate, lower, upper, beta_ci, blank, plot_ci)
  ) %>%
  select(
    term, estimate_China, estimate_England, estimate_USA, 
    lower_China, lower_England, lower_USA,
    upper_China, upper_England, upper_USA, 
    plot_ci_China, beta_ci_China, blank_China,
    plot_ci_England, beta_ci_England, blank_England,
    plot_ci_USA, beta_ci_USA
    )
colnames(dat_fig)[colnames(dat_fig) == "term"] <- "Internet use frequency"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_China"] <- "China"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_England"] <- "England"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_USA"] <- "USA"
colnames(dat_fig)[colnames(dat_fig) %in% c("beta_ci_China", "beta_ci_England", "beta_ci_USA")] <- "β (95% CI)"
colnames(dat_fig)[colnames(dat_fig) %in% c("blank_China", "blank_England", "blank_USA")] <- " "


p_satlife <- forestploter::forest(
  dat_fig[,c(1, 11:18)],
  est = list(
    dat_fig$estimate_China,
    dat_fig$estimate_England,
    dat_fig$estimate_USA
  ),
  lower = list(
    dat_fig$lower_China,
    dat_fig$lower_England,
    dat_fig$lower_USA
  ),
  upper = list(
    dat_fig$upper_China,
    dat_fig$upper_England,
    dat_fig$upper_USA
  ),
  ci_column = c(2, 5, 8),
  ref_line = c(0, 0, 0),
  sizes = 0.7,
  xlim = list(
    c(-1.4, 0.7), 
    c(-1.4, 0.7),
    c(-1.4, 0.7)
    ),            
  ticks_at = list(
    c(-1.4, -0.7, 0, 0.7), 
    c(-1.4, -0.7, 0, 0.7), 
    c(-1.4, -0.7, 0, 0.7)
    ),  
  arrow_lab = c("Lower life satisfaction","Higher life satisfaction"),
  theme = theme
  )

# Add border
p_satlife <- add_border(p_satlife, part = "header", row = 1, col = c(1:9), gp = gpar(lwd = 1))

#### Pool ####
p_pool <- wrap_elements(
  wrap_elements(p_cesd) + wrap_elements(p_satlife) + wrap_elements(p_shlt) + 
    plot_layout(nrow = 3) + 
    plot_annotation(tag_levels = "a")
  ) 

ggsave(str_c(getwd(), "/results/Figure/Supplementary Figure 1_Forest plot_internet use frequency_unadjusted.tiff"), plot = p_pool, width = 13, height = 8, unit = "in", dpi = 500, device = "tiff")

```


## Supplementary Table 3: baseline characteristics 

```{r}

baseline_cov <- final_ifreq_merge %>% 
  group_by(id) %>%
  slice(1) %>%
  ungroup() %>%
  dplyr::select(
    country_names, 
    internet_freq, 
    cesd, shlt, satlife,
    age, male, lowedu, lowwealth, lbrf,
    nonmarried, hhres, smoken, weekdrink, phyinact,
    dis, adl_any, iadl
  ) 

var_need <- c("internet_freq", "cesd", "shlt", "satlife", "age", "male", "lowedu", "lowwealth", "lbrf", "nonmarried", "hhres", "smoken", "weekdrink", "phyinact", "dis", "adl_any", "iadl")

var_name <- c(
  "Internet use frequency",
  
  "Depressive symptoms",
  "Self-reported health",
  "Life satisfaction",
  
  "Age (years)",
  "Male",
  "Education",
  "Wealth",
  "Labor force status",

  "Unmarried",  
  "Household size",
  "Current smoker",
  "Weekly alcohol use",
  "Physical inactivity",
  
  "Number of chronic conditions",
  "ADL disability", 
  "IADL"
)

label_list <- list()
for (i in 1:length(var_name)) {
  formula_str <- paste0(var_need[i], " ~ ", "\"", gsub("'", "'", var_name[i]), "\"")
  label_list[[i]] <- as.formula(formula_str)
}

tbl <- baseline_cov %>%
  mutate(
    internet_freq = factor(internet_freq, levels = c("none", "notregularly", "weekly", "daily"), labels = c("Never", "Less than weekly", "Weekly", "Daily")),
    male = relevel(factor(male, labels = c("no", "yes")), ref = "no"),
    lowedu = factor(lowedu, levels = c("primary", "secondary", "tertiary"), labels = c("Primary", "Secondary", "Tertiary")),
    lowwealth = factor(lowwealth, levels = c("3", "2", "1"), labels = c("Low", "Middle", "High")),
    lbrf = factor(lbrf, levels = c("employed", "retired", "others"), labels = c("Working", "Retired", "Others"))
  ) %>%
  tbl_summary(
    by = country_names,
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    label = label_list,
    type = list(cesd ~ "continuous", shlt ~ "continuous", satlife ~ "continuous", dis ~ "continuous",  iadl ~ "continuous"),
    digits = list(all_continuous() ~ 1, all_categorical() ~ c(0, 1)),
    missing = "no"
    )

tbl %>%
  as_flex_table() %>%
  flextable::save_as_docx(path = str_c(getwd(), "/results/Table/Supplementary Table 3_Baseline characteristics by countries_internet use frequency.docx"))

```

# Supplementary Table 5: Subgroup analyses by Internet use measures in the meta-analysis

```{r}

#### CES-D ####
cesd_binary <- rma(yi = estimate, sei = std.error, data = metareg_cesd_iyes_adj, subset = measure == "binary")
cesd_freq <- rma(yi = estimate, sei = std.error, data = metareg_cesd_iyes_adj, subset = measure == "frequency")
cesd_home <- rma(yi = estimate, sei = std.error, data = metareg_cesd_iyes_adj, subset = measure == "home_level")

dat_comp_cesd <- tibble(
  estimate = c(coef(cesd_binary), coef(cesd_freq), coef(cesd_home)), 
  std.error = c(cesd_binary$se, cesd_freq$se, cesd_home$se),
  meta = c("binary", "frequency", "home_level"), 
  I2 = round(c(cesd_binary$I2, cesd_freq$I2, cesd_home$I2),3),
  tau2 = round(c(cesd_binary$tau2, cesd_freq$tau2, cesd_home$tau2),3),
  H2 = round(c(cesd_binary$H2, cesd_freq$H2, cesd_home$tau2),3)
  ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    outcome = "cesd"
  )

measure_cesd_iyes_adj_fe <- rma(estimate, sei = std.error, mods = ~ meta, method = "FE", data = dat_comp_cesd, digits = 3)

#### Life satisfaction ####
satlife_binary <- rma(yi = estimate, sei = std.error, data = metareg_satlife_iyes_adj, subset = measure == "binary")
satlife_freq <- rma(yi = estimate, sei = std.error, data = metareg_satlife_iyes_adj, subset = measure == "frequency")
satlife_home <- rma(yi = estimate, sei = std.error, data = metareg_satlife_iyes_adj, subset = measure == "home_level")

dat_comp_satlife <- tibble(
  estimate = c(coef(satlife_binary), coef(satlife_freq), coef(satlife_home)), 
  std.error = c(satlife_binary$se, satlife_freq$se, satlife_home$se),
  meta = c("binary", "frequency", "home_level"), 
  I2 = round(c(satlife_binary$I2, satlife_freq$I2, satlife_home$I2),3),
  tau2 = round(c(satlife_binary$tau2, satlife_freq$tau2, satlife_home$tau2),3),
  H2 = round(c(satlife_binary$H2, satlife_freq$H2, satlife_home$tau2),3)
  ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    outcome = "satlife"
  )

measure_satlife_iyes_adj_fe <- rma(estimate, sei = std.error, mods = ~ meta, method = "FE", data = dat_comp_satlife, digits = 3)

#### Self-rated health ####
shlt_binary <- rma(yi = estimate, sei = std.error, data = metareg_shlt_iyes_adj, subset = measure == "binary")
shlt_freq <- rma(yi = estimate, sei = std.error, data = metareg_shlt_iyes_adj, subset = measure == "frequency")
shlt_home <- rma(yi = estimate, sei = std.error, data = metareg_shlt_iyes_adj, subset = measure == "home_level")

dat_comp_shlt <- tibble(
  estimate = c(coef(shlt_binary), coef(shlt_freq), coef(shlt_home)), 
  std.error = c(shlt_binary$se, shlt_freq$se, shlt_home$se),
  meta = c("binary", "frequency", "home_level"), 
  I2 = round(c(shlt_binary$I2, shlt_freq$I2, shlt_home$I2),3),
  tau2 = round(c(shlt_binary$tau2, shlt_freq$tau2, shlt_home$tau2),3),
  H2 = round(c(shlt_binary$H2, shlt_freq$H2, shlt_home$tau2),3)
  ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    outcome = "shlt"
  )

measure_shlt_iyes_adj_fe <- rma(estimate, sei = std.error, mods = ~ meta, method = "FE", data = dat_comp_shlt, digits = 3)

dat_comp_all <- dat_comp_cesd %>%
  bind_rows(., dat_comp_satlife) %>%
  bind_rows(., dat_comp_shlt)

write.csv(dat_comp_all, file = str_c(getwd(), "/results/Table/Supplementary Table 5_Subgroup analyses by internet use measures.csv"))

```

# Extended Data Figure 2: Prevalence of Internet use

```{r}

data_internet_pre <- final_iyes_merge %>% 
  group_by(id) %>% 
  slice(1) %>% 
  ungroup() %>% 
  mutate(internet_yes = as.numeric(internet_yes) - 1) %>%
  group_by(country_names) %>% 
  summarise(prevalence = mean(internet_yes)*100) %>%
  ungroup() %>%
  arrange(prevalence) %>%
  mutate(
    prevalence_label = format(round(prevalence, 1), big.mark = ","),
    country_names = factor(country_names, levels = country_names)
    )
  
p_internet_pre <- ggplot(data = data_internet_pre, aes(x = country_names, y = prevalence, fill = prevalence)) +
  geom_bar(stat = "identity")+
  geom_text(aes(label = prevalence_label), hjust = -0.2, size = 4, fontface = "bold")+
  theme_void() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 16, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 16, vjust = 1, angle = 90, face = "bold"),
    axis.line.x = element_line(colour = "grey", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 1, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 16, hjust = .5)
    ) +
  scale_y_continuous(
    limits = c(0, 100)
  ) +
  scale_fill_gradientn(
    colours = c("#58539f", "#bbbbd6", "#eebabb", "#d86967"),
    breaks = seq(0, 90, by = 10),
    limit = c(0, 90)
    ) +
  coord_flip() +
  labs(
    x = NULL,
    y = "Prevalence (%)",
    title = NULL
  )

ggsave(str_c(getwd(), "/results/Figure/Extended Data Figure 2_Bar plot_internet use prevalence by country.tiff"), plot = p_internet_pre, width = 6, height = 12, unit = "in", dpi = 500, device = "tiff")

```

# Extended Data Figure 3: Correlation between Internet use prevalence and country-level factors

```{r}

dat <- data_internet_pre %>%
  left_join(country_factor, by = join_by(country_names == country))

# GDP per capita
cor <- cor.test(dat$GDP_per_capita, dat$prevalence)

dot_internet_gdp <- ggplot(data = dat) +
  geom_point(
    aes(x = GDP_per_capita, y = prevalence), color = "#3B4992FF", alpha = 1, size = 1.5
    ) + 
  geom_text(
    aes(x = GDP_per_capita, y = prevalence, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = -Inf, parse = F, hjust = 1.05, vjust = 0, size = 4,
    label = bquote(
      paste(
        italic(r), " = ", .(fmtx(cor$estimate, digits = 2)), ", ",
        .(fmtp(cor$p.value, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(8500, 130000)
  ) +
  scale_y_continuous(
    limits = c(0, 90)
  ) +
  labs(
    x = "GDP per capita ($US)",
    y = "Prevalence (%)",
    title = NULL
  )

# Gini index
cor <- cor.test(dat$gini, dat$prevalence)

dot_internet_gini <- ggplot(data = dat) +
  geom_point(
    aes(x = gini, y = prevalence), color = "#3B4992FF", alpha = 1, size = 1.5
    ) + 
  geom_text(
    aes(x = gini, y = prevalence, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = -Inf, parse = F, hjust = 1.05, vjust = 0, size = 4,
    label = bquote(
      paste(
        italic(r), " = ", .(fmtx(cor$estimate, digits = 2)), ", ",
        .(fmtp(cor$p.value, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(24, 54)
  ) +
  scale_y_continuous(
    limits = c(0, 90)
  ) +
  labs(
    x = "Gini index",
    y = "Prevalence (%)",
    title = NULL
  )

# World happiness index
cor <- cor.test(dat$world_happiness_index, dat$prevalence)

dot_internet_whi <- ggplot(data = dat) +
  geom_point(
    aes(x = world_happiness_index, y = prevalence), color = "#3B4992FF", alpha = 1, size = 1.5
    ) + 
  geom_text(
    aes(x = world_happiness_index, y = prevalence, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = -Inf, parse = F, hjust = 1.05, vjust = 0, size = 4,
    label = bquote(
      paste(
        italic(r), " = ", .(fmtx(cor$estimate, digits = 2)), ", ",
        .(fmtp(cor$p.value, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(5.8, 7.68)
  ) +
  scale_y_continuous(
    limits = c(0, 90)
  ) +
  labs(
    x = "World happiness index",
    y = "Prevalence (%)",
    title = NULL
  )

# Hofstede’s index
cor <- cor.test(dat$individualism_score, dat$prevalence)

dot_internet_indiv <- ggplot(data = dat) +
  geom_point(
    aes(x = individualism_score, y = prevalence), color = "#3B4992FF", alpha = 1, size = 1.5
    ) + 
  geom_text(
    aes(x = individualism_score, y = prevalence, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = -Inf, parse = F, hjust = 1.05, vjust = 0, size = 4,
    label = bquote(
      paste(
        italic(r), " = ", .(fmtx(cor$estimate, digits = 2)), ", ",
        .(fmtp(cor$p.value, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(34, 101.5)
  ) +
  scale_y_continuous(
    limits = c(0, 90)
  ) +
  labs(
    x = "Hofstede’s index",
    y = "Prevalence (%)",
    title = NULL
  )

# Internet use rate
cor <- cor.test(dat$internet_use_rate, dat$prevalence)

dot_internet_iuse <- ggplot(data = dat) +
  geom_point(
    aes(x = internet_use_rate, y = prevalence), color = "#3B4992FF", alpha = 1, size = 1.5
    ) + 
  geom_text(
    aes(x = internet_use_rate, y = prevalence, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = -Inf, parse = F, hjust = 1.05, vjust = 0, size = 4,
    label = bquote(
      paste(
        italic(r), " = ", .(fmtx(cor$estimate, digits = 2)), ", ",
        .(fmtp(cor$p.value, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5),
    ) +
  scale_x_continuous(
    limits = c(75, 99)
  ) +
  scale_y_continuous(
    limits = c(0, 90)
  ) +
  labs(
    x = "Internet use rate (%)",
    y = "Prevalence (%)",
    title = NULL
  )

# Digital skills among active population
cor <- cor.test(dat$digital_skills_score, dat$prevalence)

dot_internet_dskill <- ggplot(data = dat) +
  geom_point(
    aes(x = digital_skills_score, y = prevalence), color = "#3B4992FF", alpha = 1, size = 1.5
    ) + 
  geom_text(
    aes(x = digital_skills_score, y = prevalence, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = -Inf, parse = F, hjust = 1.05, vjust = 0, size = 4,
    label = bquote(
      paste(
        italic(r), " = ", .(fmtx(cor$estimate, digits = 2)), ", ",
        .(fmtp(cor$p.value, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5),
    ) +
  scale_x_continuous(
    limits = c(34, 79)
  ) +
  scale_y_continuous(
    limits = c(0, 90)
  ) +
  labs(
    x = "Digital skills among active population",
    y = "Prevalence (%)",
    title = NULL
  )

# Healthy life expectancy at birth
cor <- cor.test(dat$healthy_life_expectancy, dat$prevalence)

dot_internet_hale <- ggplot(data = dat) +
  geom_point(
    aes(x = healthy_life_expectancy, y = prevalence), color = "#3B4992FF", alpha = 1, size = 1.5
    ) + 
  geom_text(
    aes(x = healthy_life_expectancy, y = prevalence, label = iso_alpha2_code), 
    size = 4, color = "black",
    check_overlap = F, vjust = -0.5, hjust = 0.005
    ) +
  annotate(
    "text", x = Inf, y = -Inf, parse = F, hjust = 1.05, vjust = 0, size = 4,
    label = bquote(
      paste(
        italic(r), " = ", .(fmtx(cor$estimate, digits = 2)), ", ",
        .(fmtp(cor$p.value, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
    ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", vjust = 0, angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = -0.5, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "bold"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks = element_line(colour = "black", linewidth = .5),
    axis.ticks.length = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0, r = .25, b = 1, l = .25), "cm"),
    plot.title = element_text(size = 12, hjust = .5)
    ) +
  scale_x_continuous(
    limits = c(65.2, 72.8)
  ) +
  scale_y_continuous(
    limits = c(0, 90)
  ) +
  labs(
    x = "Healthy life expectancy at birth (years)",
    y = "Prevalence (%)",
    title = NULL
  )

#### Pool ####
p_pool_dot <- wrap_elements(
  dot_internet_gdp + dot_internet_gini + dot_internet_whi + dot_internet_indiv + 
    dot_internet_iuse + dot_internet_dskill + dot_internet_hale +
    plot_annotation(tag_levels = "a") +
    plot_layout(nrow = 3)
  )

ggsave(str_c(getwd(), "/results/Figure/Extended Data Figure 3_Dot plot_correlation.tiff"), plot = p_pool_dot, width = 12, height = 12, unit = "in", dpi = 500, device = "tiff")

```

# Supplementary Table 1: baseline characteristics 

```{r}

baseline_cov <- final_iyes_merge %>% 
  group_by(id) %>%
  slice(1) %>%
  ungroup() %>%
  dplyr::select(
    country_names, wave,
    internet_yes, 
    cesd, shlt, satlife,
    age, male, lowedu, lowwealth, lbrf,
    nonmarried, hhres, smoken, weekdrink, phyinact,
    dis, adl_any, iadl
  )

var_need <- c("internet_yes", "cesd", "shlt", "satlife", "age", "male", "lowedu", "lowwealth", "lbrf", "nonmarried", "hhres", "smoken", "weekdrink", "phyinact", "dis", "adl_any", "iadl")

var_name <- c(
  "Internet use",
  
  "Depressive symptoms",
  "Self-reported health",
  "Life satisfaction",
  
  "Age (years)",
  "Male",
  "Education",
  "Wealth",
  "Labor force status",

  "Unmarried",  
  "Household size",
  "Current smoker",
  "Weekly alcohol use",
  "Physical inactivity",
  
  "Number of chronic conditions",
  "ADL disability", 
  "IADL"
)

label_list <- list()
for (i in 1:length(var_name)) {
  formula_str <- paste0(var_need[i], " ~ ", "\"", gsub("'", "'", var_name[i]), "\"")
  label_list[[i]] <- as.formula(formula_str)
}

tbl <- baseline_cov %>%
  mutate(
    male = relevel(factor(male, labels = c("no", "yes")), ref = "no"),
    lowedu = factor(lowedu, levels = c("primary", "secondary", "tertiary"), labels = c("Primary", "Secondary", "Tertiary")),
    lowwealth = factor(lowwealth, levels = c("3", "2", "1"), labels = c("Low", "Middle", "High")),
    lbrf = factor(lbrf, levels = c("employed", "retired", "others"), labels = c("Working", "Retired", "Others"))
  ) %>%
  tbl_summary(
    by = country_names,
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    label = label_list,
    type = list(wave ~ "continuous", cesd ~ "continuous", shlt ~ "continuous", satlife ~ "continuous", dis ~ "continuous",  iadl ~ "continuous"),
    digits = list(all_continuous() ~ 1, all_categorical() ~ c(0, 1)),
    missing = "no"
    )

tbl %>%
  as_flex_table() %>%
  flextable::save_as_docx(path = str_c(getwd(), "/results/Table/Supplementary Table 1_Baseline characteristics by countries_internet use.docx"))

# For baseline survey wave
tbl_wave <- baseline_cov %>%
  dplyr::select(country_names, wave) %>%
  tbl_summary(
    by = country_names,
    statistic = list(
      all_continuous() ~ "{median} ({p75}-{p25})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    label = wave ~ "Survey wave",
    type = list(wave ~ "continuous"),
    digits = list(all_continuous() ~ 1, all_categorical() ~ c(0, 1)),
    missing = "no"
    )

tbl_wave %>%
  as_flex_table() %>%
  flextable::save_as_docx(path = str_c(getwd(), "/results/Table/Supplementary Table 1_Baseline survey year by countries_internet use.docx"))

```

# Median follow-up time or observations

```{r}

# Number of observations
nrow(final_iyes_merge) # 299172

# Median of follow-up
end <- final_iyes_merge %>% 
  group_by(id) %>%
  slice(n()) %>%
  ungroup() %>%
  dplyr::select(
    country_names, cwave
  ) 
skim(end)

```


# Sentivity analyses

## Multiple imputation

### Internet use (yes/no)

```{r}

iso <- c(40, 56, 76, 156, 191, 203, 208, 826, 233, 250, 276, 300, 376, 380, 442, 484, 528, 616, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "Brazil", "China", "Croatia", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Greece", "Israel", "Italy", "Luxembourg", "Mexico", "Netherlands", "Poland", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

mi_iyes_merge <- list()
for(i in 1:20){
  mi_iyes <- mi_iyes_hrs[[i]] %>% mutate(id = as.character(id)) %>% 
    bind_rows(., mi_iyes_elsa[[i]] %>% mutate(id = as.character(id))) %>%
    bind_rows(., mi_iyes_charls[[i]] %>% mutate(id = as.character(id))) %>%
    bind_rows(., mi_iyes_share[[i]]) %>%
    bind_rows(., mi_iyes_mhas[[i]]) %>%
    mutate(
      country_names = case_when(
        country == iso[1] ~ names[1],
        country == iso[2] ~ names[2],
        country == iso[3] ~ names[3],
        country == iso[4] ~ names[4],
        country == iso[5] ~ names[5],
        country == iso[6] ~ names[6],
        country == iso[7] ~ names[7],
        country == iso[8] ~ names[8],
        country == iso[9] ~ names[9],
        country == iso[10] ~ names[10],
        country == iso[11] ~ names[11],
        country == iso[12] ~ names[12],
        country == iso[13] ~ names[13],
        country == iso[14] ~ names[14],
        country == iso[15] ~ names[15],
        country == iso[16] ~ names[16],
        country == iso[17] ~ names[17],
        country == iso[18] ~ names[18],
        country == iso[19] ~ names[19],
        country == iso[20] ~ names[20],
        country == iso[21] ~ names[21],
        country == iso[22] ~ names[22],
        country == iso[23] ~ names[23]
      )
    )
  mi_iyes_merge[[i]] <- mi_iyes
  rm(mi_iyes)
}

```


#### CES-D

```{r}

#### lme4 ####
cesd_iyes_unadj_mi_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    cesd_iyes_unadj_mi <- lmer(
      cesd_stand ~ internet_yes + cwave + (1 | id),
      data = final_iyes_elsi, 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil doesn't have missing values
    cesd_iyes_unadj_mi_result <- broom.mixed::tidy(cesd_iyes_unadj_mi) %>% 
      slice(2) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  }else{
    cesd_iyes_unadj_mi <- lapply(mi_iyes_merge, function(x){
    lmer(
      cesd_stand ~ internet_yes + cwave + (1 | id),
      data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'))
      })
    cesd_iyes_unadj_mi_result <- broom.mixed::tidy(pool(cesd_iyes_unadj_mi)) %>% 
      slice(2) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  }
  
  cesd_iyes_unadj_mi_results <- cesd_iyes_unadj_mi_results %>% 
    bind_rows(., cesd_iyes_unadj_mi_result)
  
  rm(cesd_iyes_unadj_mi, cesd_iyes_unadj_mi_result)
}

cesd_iyes_adj_mi_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    cesd_iyes_adj_mi <- lmer(
      cesd_stand ~ internet_yes + cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi, 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    cesd_iyes_adj_mi_result <- broom.mixed::tidy(cesd_iyes_adj_mi) %>% 
      slice(2) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  }else{
    cesd_iyes_adj_mi <- lapply(mi_iyes_merge, function(x){
      lmer(
        cesd_stand ~ internet_yes + cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl +  
          (1 | id),
        data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'))
      })
    cesd_iyes_adj_mi_result <- broom.mixed::tidy(pool(cesd_iyes_adj_mi)) %>% 
      slice(2) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  }
  
  cesd_iyes_adj_mi_results <- cesd_iyes_adj_mi_results %>% 
    bind_rows(., cesd_iyes_adj_mi_result)
  
  rm(cesd_iyes_adj_mi, cesd_iyes_adj_mi_result)
}

#### metafor ####
cesd_iyes_unadj_mi_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_unadj_mi_results, slab = country)

cesd_iyes_adj_mi_meta <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_mi_results, slab = country)

```


#### Self-rated health

```{r}

#### lme4 ####
shlt_iyes_unadj_mi_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    shlt_iyes_unadj_mi <- lmer(
      shlt_stand ~ internet_yes + cwave + (1 | id),
      data = final_iyes_elsi, 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil doesn't have missing values
    shlt_iyes_unadj_mi_result <- broom.mixed::tidy(shlt_iyes_unadj_mi) %>% 
      slice(2) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  }else{
    shlt_iyes_unadj_mi <- lapply(mi_iyes_merge, function(x){
    lmer(
      shlt_stand ~ internet_yes + cwave + (1 | id),
      data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'))
      })
    shlt_iyes_unadj_mi_result <- broom.mixed::tidy(pool(shlt_iyes_unadj_mi)) %>% 
      slice(2) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  }
  
  shlt_iyes_unadj_mi_results <- shlt_iyes_unadj_mi_results %>% 
    bind_rows(., shlt_iyes_unadj_mi_result)
  
  rm(shlt_iyes_unadj_mi, shlt_iyes_unadj_mi_result)
}

shlt_iyes_adj_mi_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    shlt_iyes_adj_mi <- lmer(
      shlt_stand ~ internet_yes + cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi, 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil dont have missing values
    shlt_iyes_adj_mi_result <- broom.mixed::tidy(shlt_iyes_adj_mi) %>% 
      slice(2) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  }else{
    shlt_iyes_adj_mi <- lapply(mi_iyes_merge, function(x){
      lmer(
        shlt_stand ~ internet_yes + cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl + 
          (1 | id),
        data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'))
      })
    shlt_iyes_adj_mi_result <- broom.mixed::tidy(pool(shlt_iyes_adj_mi)) %>% 
      slice(2) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  }
  
  shlt_iyes_adj_mi_results <- shlt_iyes_adj_mi_results %>% 
    bind_rows(., shlt_iyes_adj_mi_result)
  
  rm(shlt_iyes_adj_mi, shlt_iyes_adj_mi_result)
}

#### metafor ####
shlt_iyes_unadj_mi_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_unadj_mi_results, slab = country)

shlt_iyes_adj_mi_meta <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_mi_results, slab = country)

```


#### Life satisfaction

```{r}

#### lme4 ####
satlife_iyes_unadj_mi_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    satlife_iyes_unadj_mi <- lmer(
      satlife_stand ~ internet_yes + cwave + (1 | id),
      data = final_iyes_elsi, 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil doesn't have missing values
    satlife_iyes_unadj_mi_result <- broom.mixed::tidy(satlife_iyes_unadj_mi) %>% 
      slice(2) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  }else{
    satlife_iyes_unadj_mi <- lapply(mi_iyes_merge, function(x){
    lmer(
      satlife_stand ~ internet_yes + cwave + (1 | id),
      data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'))
      })
    satlife_iyes_unadj_mi_result <- broom.mixed::tidy(pool(satlife_iyes_unadj_mi)) %>% 
      slice(2) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  }
  
  satlife_iyes_unadj_mi_results <- satlife_iyes_unadj_mi_results %>% 
    bind_rows(., satlife_iyes_unadj_mi_result)
  
  rm(satlife_iyes_unadj_mi, satlife_iyes_unadj_mi_result)
}

satlife_iyes_adj_mi_results <- tibble()
for(i in 1:23){
  
  if(i==3){
    satlife_iyes_adj_mi <- lmer(
      satlife_stand ~ internet_yes + cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = final_iyes_elsi, 
      control = lmerControl(optimizer = "bobyqa")
      ) # Brazil doesn't have missing values
    satlife_iyes_adj_mi_result <- broom.mixed::tidy(satlife_iyes_adj_mi) %>% 
      slice(2) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  }else{
    satlife_iyes_adj_mi <- lapply(mi_iyes_merge, function(x){
      lmer(
        satlife_stand ~ internet_yes + cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl + 
          (1 | id),
        data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'))
      })
    satlife_iyes_adj_mi_result <- broom.mixed::tidy(pool(satlife_iyes_adj_mi)) %>% 
      slice(2) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  }
  
  satlife_iyes_adj_mi_results <- satlife_iyes_adj_mi_results %>% 
    bind_rows(., satlife_iyes_adj_mi_result)
  
  rm(satlife_iyes_adj_mi, satlife_iyes_adj_mi_result)
}

#### metafor ####
satlife_iyes_unadj_mi_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_unadj_mi_results, slab = country)

satlife_iyes_adj_mi_meta <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_mi_results, slab = country)

```

#### Extended Data Figure 5: Associations of Internet use with mental health (imputed data)

```{r}

#### Theme setting ####
theme <- forestploter::forest_theme(
  core = list(bg_params = list(fill = c("white"))), 
  base_size = 10, 
  # base_family = "Arial",
  ci_pch = 15,
  ci_col = "#3B4992FF", 
  ci_alpha = 1,
  ci_lty = 1,
  ci_lwd = 1,
  ci_Theight = unit(0, "cm"),
  
  xaxis_lwd = 1,
  xaxis_cex = 1,
  
  summary_col = "#008B45FF", 
  refline_col = "gray", 
  refline_lwd = 2, 
  
  title_just = "center",
  title_cex = 1.2,
  title_fontface = "bold",
  title_col = "black",
  
  arrow_type = "closed",
  arrow_label_just = "end",
  arrow_length = 0.05,
  arrow_lwd = 1,
  arrow_fill = "black",
  arrow_col = "black"
  )

#### CES-D ####
# Data
dat <- cesd_iyes_adj_mi_results %>%
  mutate(weights = weights(cesd_iyes_adj_mi_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(cesd_iyes_adj_mi_meta$beta),
      std.error = as.numeric(cesd_iyes_adj_mi_meta$se), 
      statistic = NA, df = NA, p.value = NA, p.sig = NA, 
      weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "β (95% CI)", "Weight (%)")


p_cesd <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Fewer depressive symptoms","More depressive symptoms"),
  xlim = c(-0.5, 0.5),
  ticks_at = c(-0.5, -0.25, 0, 0.25, 0.5),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(cesd_iyes_adj_mi_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(cesd_iyes_adj_mi_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(cesd_iyes_adj_mi_meta$H2, digits = 2)))
    )

p_cesd <- add_text(
  p_cesd, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(cesd_iyes_adj_mi_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(cesd_iyes_adj_mi_meta$k - cesd_iyes_adj_mi_meta$p), ") = ", 
        .(fmtx(cesd_iyes_adj_mi_meta$QE, digits = 2)), ", ",
        
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(cesd_iyes_adj_mi_meta$k - cesd_iyes_adj_mi_meta$p), ") = ", 
        .(fmtx(cesd_iyes_adj_mi_meta$QE, digits = 2)), ", ",
        .(fmtp(cesd_iyes_adj_mi_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )
  }

p_cesd <- add_text(
  p_cesd, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(cesd_iyes_adj_mi_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(cesd_iyes_adj_mi_meta$zval, digits = 2)), ", ",
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(cesd_iyes_adj_mi_meta$zval, digits = 2)), ", ",
        .(fmtp(cesd_iyes_adj_mi_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )    
  }

p_cesd <- add_text(
  p_cesd, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_cesd <- add_border(p_cesd, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))


#### Self-rated health ####
# Data
dat <- shlt_iyes_adj_mi_results %>%
  mutate(weights = weights(shlt_iyes_adj_mi_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(shlt_iyes_adj_mi_meta$beta),
      std.error = as.numeric(shlt_iyes_adj_mi_meta$se), 
      statistic = NA, df = NA, p.value = NA, p.sig = NA, 
      weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "β (95% CI)", "Weight (%)")

p_shlt <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Worse self-reported health","Better self-reported health"),
  xlim = c(-0.4, 0.4),
  ticks_at = c(-0.4, -0.2, 0, 0.2, 0.4),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(shlt_iyes_adj_mi_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(shlt_iyes_adj_mi_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(shlt_iyes_adj_mi_meta$H2, digits = 2)))
    )

p_shlt <- add_text(
  p_shlt, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(shlt_iyes_adj_mi_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(shlt_iyes_adj_mi_meta$k - shlt_iyes_adj_mi_meta$p), ") = ", 
        .(fmtx(shlt_iyes_adj_mi_meta$QE, digits = 2)), ", ",
        
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(shlt_iyes_adj_mi_meta$k - shlt_iyes_adj_mi_meta$p), ") = ", 
        .(fmtx(shlt_iyes_adj_mi_meta$QE, digits = 2)), ", ",
        .(fmtp(shlt_iyes_adj_mi_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )
  }

p_shlt <- add_text(
  p_shlt, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(shlt_iyes_adj_mi_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(shlt_iyes_adj_mi_meta$zval, digits = 2)), ", ",
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(shlt_iyes_adj_mi_meta$zval, digits = 2)), ", ",
        .(fmtp(shlt_iyes_adj_mi_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )    
  }

p_shlt <- add_text(
  p_shlt, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_shlt <- add_border(p_shlt, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))


#### Life satisfaction ####
# Data
dat <- satlife_iyes_adj_mi_results %>%
  mutate(weights = weights(satlife_iyes_adj_mi_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(satlife_iyes_adj_mi_meta$beta),
      std.error = as.numeric(satlife_iyes_adj_mi_meta$se), 
      statistic = NA, df = NA, p.value = NA, p.sig = NA, 
      weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "β (95% CI)", "Weight (%)")


p_satlife <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Lower life satisfaction","Higher life satisfaction"),
  xlim = c(-0.2, 0.8),
  ticks_at = c(-0.2, 0, 0.2, 0.4, 0.6, 0.8),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(satlife_iyes_adj_mi_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(satlife_iyes_adj_mi_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(satlife_iyes_adj_mi_meta$H2, digits = 2)))
    )

p_satlife <- add_text(
  p_satlife, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(satlife_iyes_adj_mi_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(satlife_iyes_adj_mi_meta$k - satlife_iyes_adj_mi_meta$p), ") = ", 
        .(fmtx(satlife_iyes_adj_mi_meta$QE, digits = 2)), ", ",
        
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(satlife_iyes_adj_mi_meta$k - satlife_iyes_adj_mi_meta$p), ") = ", 
        .(fmtx(satlife_iyes_adj_mi_meta$QE, digits = 2)), ", ",
        .(fmtp(satlife_iyes_adj_mi_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )
  }

p_satlife <- add_text(
  p_satlife, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(satlife_iyes_adj_mi_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(satlife_iyes_adj_mi_meta$zval, digits = 2)), ", ",
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(satlife_iyes_adj_mi_meta$zval, digits = 2)), ", ",
        .(fmtp(satlife_iyes_adj_mi_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )    
  }

p_satlife <- add_text(
  p_satlife, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_satlife <- add_border(p_satlife, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))

#### Pool ####
p_re <- wrap_elements(
  wrap_elements(p_cesd) + wrap_elements(p_satlife) + wrap_elements(p_shlt) + 
    plot_layout(nrow = 2) + 
    plot_annotation(tag_levels = "a")
  ) 

ggsave(str_c(getwd(), "/results/Figure/Extended Data Figure 5_Forest plot_internet use_mice.tiff"), plot = p_re, width = 16, height = 14, unit = "in", dpi = 500, device = "tiff")


```

### Cumulative internet use

```{r}

iso <- c(40, 56, 156, 203, 208, 826, 233, 250, 276, 376, 380, 442, 484, 705, 724, 752, 756, 840)

names <- c("Austria", "Belgium", "China", "Czech Republic", "Denmark", "England", "Estonia", "France", "Germany", "Israel", "Italy", "Luxembourg", "Mexico", "Slovenia", "Spain", "Sweden", "Switzerland", "USA")

mi_icum_merge <- list()
for(i in 1:20){
  mi_icum <- mi_icum_hrs[[i]] %>% 
    mutate(id = as.character(id)) %>% 
    bind_rows(., mi_icum_elsa[[i]] %>% mutate(id = as.character(id))) %>%
    bind_rows(., mi_icum_charls[[i]] %>% mutate(id = as.character(id))) %>%
    bind_rows(., mi_icum_share[[i]]) %>%
    mutate(
      country_names = case_when(
        country == iso[1] ~ names[1],
        country == iso[2] ~ names[2],
        country == iso[3] ~ names[3],
        country == iso[4] ~ names[4],
        country == iso[5] ~ names[5],
        country == iso[6] ~ names[6],
        country == iso[7] ~ names[7],
        country == iso[8] ~ names[8],
        country == iso[9] ~ names[9],
        country == iso[10] ~ names[10],
        country == iso[11] ~ names[11],
        country == iso[12] ~ names[12],
        country == iso[13] ~ names[13],
        country == iso[14] ~ names[14],
        country == iso[15] ~ names[15],
        country == iso[16] ~ names[16],
        country == iso[17] ~ names[17],
        country == iso[18] ~ names[18]
      )
    )
  mi_icum_merge[[i]] <- mi_icum
  rm(mi_icum)
}

```

#### CES-D

```{r}

#### lme4 ####
cesd_icum_unadj_mi_results <- tibble()
for(i in 1:18){
  
  if(i==13){
    cesd_icum_unadj_mi <- lmer(
      cesd_stand ~ internet_cum + cwave + (1 | id),
      data = final_icum_mhas, 
      control = lmerControl(optimizer = "bobyqa")
      ) # Mexico doesn't have missing values
    cesd_icum_unadj_mi_result <- broom.mixed::tidy(cesd_icum_unadj_mi) %>% 
      slice(2) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  }else{
    cesd_icum_unadj_mi <- lapply(mi_icum_merge, function(x){
      lmer(
        cesd_stand ~ internet_cum + cwave + (1 | id),
        data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'))
        })
    cesd_icum_unadj_mi_result <- broom.mixed::tidy(pool(cesd_icum_unadj_mi)) %>% 
      slice(2) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  }
  
  cesd_icum_unadj_mi_results <- cesd_icum_unadj_mi_results %>% 
    bind_rows(., cesd_icum_unadj_mi_result)
  
  rm(cesd_icum_unadj_mi, cesd_icum_unadj_mi_result)
}

cesd_icum_adj_mi_results <- tibble()
for(i in 1:18){
  
  if(i==13){
    cesd_icum_adj_mi <- lmer(
      cesd_stand ~ internet_cum + cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),      
      data = final_icum_mhas, 
      control = lmerControl(optimizer = "bobyqa")
      ) # Mexico don't have missing values
    cesd_icum_adj_mi_result <- broom.mixed::tidy(cesd_icum_adj_mi) %>% 
      slice(2) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  }else{
    cesd_icum_adj_mi <- lapply(mi_icum_merge, function(x){
      lmer(
        cesd_stand ~ internet_cum + cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl + 
          (1 | id),
        data = x %>% filter(country_names == names[i]), 
        control = lmerControl(optimizer = 'bobyqa')
        )
      })
    
    cesd_icum_adj_mi_result <- broom.mixed::tidy(pool(cesd_icum_adj_mi)) %>% 
      slice(2) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  }
  
  cesd_icum_adj_mi_results <- cesd_icum_adj_mi_results %>% 
    bind_rows(., cesd_icum_adj_mi_result)
  
  rm(cesd_icum_adj_mi, cesd_icum_adj_mi_result)
}

#### metafor ####
cesd_icum_unadj_mi_meta <- rma(yi = estimate, sei = std.error, data = cesd_icum_unadj_mi_results, slab = country)

cesd_icum_adj_mi_meta <- rma(yi = estimate, sei = std.error, data = cesd_icum_adj_mi_results, slab = country)

```

#### Self-rated health

```{r}

#### lme4 ####
shlt_icum_unadj_mi_results <- tibble()
for(i in 1:18){
  
  if(i==13){
    shlt_icum_unadj_mi <- lmer(
      shlt_stand ~ internet_cum + cwave + (1 | id),
      data = final_icum_mhas, 
      control = lmerControl(optimizer = "bobyqa")
      ) # Mexico doesn't have missing values
    shlt_icum_unadj_mi_result <- broom.mixed::tidy(shlt_icum_unadj_mi) %>% 
      slice(2) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  }else{
    shlt_icum_unadj_mi <- lapply(mi_icum_merge, function(x){
      lmer(
        shlt_stand ~ internet_cum + cwave + (1 | id),
        data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'))
        })
    shlt_icum_unadj_mi_result <- broom.mixed::tidy(pool(shlt_icum_unadj_mi)) %>% 
      slice(2) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  }
  
  shlt_icum_unadj_mi_results <- shlt_icum_unadj_mi_results %>% 
    bind_rows(., shlt_icum_unadj_mi_result)
  
  rm(shlt_icum_unadj_mi, shlt_icum_unadj_mi_result)
}

shlt_icum_adj_mi_results <- tibble()
for(i in 1:18){
  
  if(i==13){
    shlt_icum_adj_mi <- lmer(
      shlt_stand ~ internet_cum + cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),      
      data = final_icum_mhas, 
      control = lmerControl(optimizer = "bobyqa")
      ) # Mexico doesn't have missing values
    shlt_icum_adj_mi_result <- broom.mixed::tidy(shlt_icum_adj_mi) %>% 
      slice(2) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  }else{
    shlt_icum_adj_mi <- lapply(mi_icum_merge, function(x){
      lmer(
        shlt_stand ~ internet_cum + cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl + 
          (1 | id),
        data = x %>% filter(country_names == names[i]), 
        control = lmerControl(optimizer = 'bobyqa')
        )
      })
    
    shlt_icum_adj_mi_result <- broom.mixed::tidy(pool(shlt_icum_adj_mi)) %>% 
      slice(2) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  }
  
  shlt_icum_adj_mi_results <- shlt_icum_adj_mi_results %>% 
    bind_rows(., shlt_icum_adj_mi_result)
  
  rm(shlt_icum_adj_mi, shlt_icum_adj_mi_result)
}

#### metafor ####
shlt_icum_unadj_mi_meta <- rma(yi = estimate, sei = std.error, data = shlt_icum_unadj_mi_results, slab = country)

shlt_icum_adj_mi_meta <- rma(yi = estimate, sei = std.error, data = shlt_icum_adj_mi_results, slab = country)

```

#### Life satisfaction

```{r}

#### lme4 ####
satlife_icum_unadj_mi_results <- tibble()
for(i in 1:18){
  
  if(i==13){
    satlife_icum_unadj_mi <- lmer(
      satlife_stand ~ internet_cum + cwave + (1 | id),
      data = final_icum_mhas, 
      control = lmerControl(optimizer = "bobyqa")
      ) # Mexico doesn't have missing values
    satlife_icum_unadj_mi_result <- broom.mixed::tidy(satlife_icum_unadj_mi) %>% 
      slice(2) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  }else{
    satlife_icum_unadj_mi <- lapply(mi_icum_merge, function(x){
      lmer(
        satlife_stand ~ internet_cum + cwave + (1 | id),
        data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'))
        })
    satlife_icum_unadj_mi_result <- broom.mixed::tidy(pool(satlife_icum_unadj_mi)) %>% 
      slice(2) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  }
  
  satlife_icum_unadj_mi_results <- satlife_icum_unadj_mi_results %>% 
    bind_rows(., satlife_icum_unadj_mi_result)
  
  rm(satlife_icum_unadj_mi, satlife_icum_unadj_mi_result)
}

satlife_icum_adj_mi_results <- tibble()
for(i in 1:18){
  
  if(i==13){
    satlife_icum_adj_mi <- lmer(
      satlife_stand ~ internet_cum + cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),      
      data = final_icum_mhas, 
      control = lmerControl(optimizer = "bobyqa")
      ) # Mexico doesn't have missing values
    satlife_icum_adj_mi_result <- broom.mixed::tidy(satlife_icum_adj_mi) %>% 
      slice(2) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  }else{
    satlife_icum_adj_mi <- lapply(mi_icum_merge, function(x){
      lmer(
        satlife_stand ~ internet_cum + cwave + 
          age + male + lowedu + lowwealth + lbrf + 
          nonmarried + hhres + smoken + weekdrink + phyinact + 
          dis + adl_any + iadl + 
          (1 | id),
        data = x %>% filter(country_names == names[i]), 
        control = lmerControl(optimizer = 'bobyqa')
        )
      })
    
    satlife_icum_adj_mi_result <- broom.mixed::tidy(pool(satlife_icum_adj_mi)) %>% 
      slice(2) %>% 
      mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
      dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig)
  }
  
  satlife_icum_adj_mi_results <- satlife_icum_adj_mi_results %>% 
    bind_rows(., satlife_icum_adj_mi_result)
  
  rm(satlife_icum_adj_mi, satlife_icum_adj_mi_result)
}

#### metafor ####
satlife_icum_unadj_mi_meta <- rma(yi = estimate, sei = std.error, data = satlife_icum_unadj_mi_results, slab = country)

satlife_icum_adj_mi_meta <- rma(yi = estimate, sei = std.error, data = satlife_icum_adj_mi_results, slab = country)

```

#### Extended Data Figure 6: Associations of cumulative Internet use with mental health (imputed data)

```{r}

#### Theme setting ####
theme <- forestploter::forest_theme(
  core = list(bg_params = list(fill = c("white"))), 
  base_size = 10, 
  # base_family = "Arial",
  ci_pch = 15,
  ci_col = "#3B4992FF", 
  ci_alpha = 1,
  ci_lty = 1,
  ci_lwd = 1,
  ci_Theight = unit(0, "cm"),
  
  xaxis_lwd = 1,
  xaxis_cex = 1,
  
  summary_col = "#008B45FF", 
  refline_col = "gray", 
  refline_lwd = 2, 
  
  title_just = "center",
  title_cex = 1.2,
  title_fontface = "bold",
  title_col = "black",
  
  arrow_type = "closed",
  arrow_label_just = "end",
  arrow_length = 0.05,
  arrow_lwd = 1,
  arrow_fill = "black",
  arrow_col = "black"
  )

#### CES-D ####
# Data
dat <- cesd_icum_adj_mi_results %>%
  mutate(weights = weights(cesd_icum_adj_mi_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(cesd_icum_adj_mi_meta$beta),
      std.error = as.numeric(cesd_icum_adj_mi_meta$se), 
      statistic = NA, df = NA, p.value = NA, p.sig = NA, 
      weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "β (95% CI)", "Weight (%)")
# colnames(dat_fig) <- c("Country", "", "", "", "Weight (%)")

p_cesd <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Fewer depressive symptoms","More depressive symptoms"),
  xlim = c(-0.4, 0.1),
  ticks_at = c(-0.4, -0.3, -0.2, -0.1, 0, 0.1),
  # footnote = "This is the demo data. Please feel free to change\nanything you want.",
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(cesd_icum_adj_mi_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(cesd_icum_adj_mi_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(cesd_icum_adj_mi_meta$H2, digits = 2)))
    )

p_cesd <- add_text(
  p_cesd, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- bquote(
    paste(
      "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
      "Q (", .(cesd_icum_adj_mi_meta$k - cesd_icum_adj_mi_meta$p), ") = ", 
      .(fmtx(cesd_icum_adj_mi_meta$QE, digits = 2)), ", ",
      # .(fmtp(cesd_icum_adj_mi_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      italic(P), " < 0.001"
      )
)

test_hetero <- 
  if(cesd_icum_adj_mi_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(cesd_icum_adj_mi_meta$k - cesd_icum_adj_mi_meta$p), ") = ", 
        .(fmtx(cesd_icum_adj_mi_meta$QE, digits = 2)), ", ",
        
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(cesd_icum_adj_mi_meta$k - cesd_icum_adj_mi_meta$p), ") = ", 
        .(fmtx(cesd_icum_adj_mi_meta$QE, digits = 2)), ", ",
        .(fmtp(cesd_icum_adj_mi_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )
  }

p_cesd <- add_text(
  p_cesd, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(cesd_icum_adj_mi_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(cesd_icum_adj_mi_meta$zval, digits = 2)), ", ",
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(cesd_icum_adj_mi_meta$zval, digits = 2)), ", ",
        .(fmtp(cesd_icum_adj_mi_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )    
  }

p_cesd <- add_text(
  p_cesd, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_cesd <- add_border(p_cesd, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))


#### Self-rated health ####
# Data
dat <- shlt_icum_adj_mi_results %>%
  mutate(weights = weights(shlt_icum_adj_mi_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(shlt_icum_adj_mi_meta$beta),
      std.error = as.numeric(shlt_icum_adj_mi_meta$se), 
      statistic = NA, df = NA, p.value = NA, p.sig = NA, 
      weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "β (95% CI)", "Weight (%)")
# colnames(dat_fig) <- c("Country", "", "", "", "Weight (%)")


p_shlt <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Worse self-reported health","Better self-reported health"),
  xlim = c(-0.1, 0.3),
  ticks_at = c(-0.1, 0, 0.1, 0.2, 0.3),
  # footnote = "This is the demo data. Please feel free to change\nanything you want.",
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(shlt_icum_adj_mi_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(shlt_icum_adj_mi_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(shlt_icum_adj_mi_meta$H2, digits = 2)))
    )

p_shlt <- add_text(
  p_shlt, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(shlt_icum_adj_mi_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(shlt_icum_adj_mi_meta$k - shlt_icum_adj_mi_meta$p), ") = ", 
        .(fmtx(shlt_icum_adj_mi_meta$QE, digits = 2)), ", ",
        
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(shlt_icum_adj_mi_meta$k - shlt_icum_adj_mi_meta$p), ") = ", 
        .(fmtx(shlt_icum_adj_mi_meta$QE, digits = 2)), ", ",
        .(fmtp(shlt_icum_adj_mi_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )
  }

p_shlt <- add_text(
  p_shlt, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(shlt_icum_adj_mi_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(shlt_icum_adj_mi_meta$zval, digits = 2)), ", ",
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(shlt_icum_adj_mi_meta$zval, digits = 2)), ", ",
        .(fmtp(shlt_icum_adj_mi_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )    
  }

p_shlt <- add_text(
  p_shlt, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_shlt <- add_border(p_shlt, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))


#### Life satisfaction ####
# Data
dat <- satlife_icum_adj_mi_results %>%
  mutate(weights = weights(satlife_icum_adj_mi_meta)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(satlife_icum_adj_mi_meta$beta),
      std.error = as.numeric(satlife_icum_adj_mi_meta$se), 
      statistic = NA, df = NA, p.value = NA, p.sig = NA, 
      weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "β (95% CI)", "Weight (%)")
# colnames(dat_fig) <- c("Country", "", "", "", "Weight (%)")


p_satlife <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Lower life satisfaction","Higher life satisfaction"),
  xlim = c(-0.2, 0.3),
  ticks_at = c(-0.2, -0.1, 0, 0.1, 0.2, 0.3),
  # footnote = "This is the demo data. Please feel free to change\nanything you want.",
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(satlife_icum_adj_mi_meta$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(satlife_icum_adj_mi_meta$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(satlife_icum_adj_mi_meta$H2, digits = 2)))
    )

p_satlife <- add_text(
  p_satlife, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(satlife_icum_adj_mi_meta$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(satlife_icum_adj_mi_meta$k - satlife_icum_adj_mi_meta$p), ") = ", 
        .(fmtx(satlife_icum_adj_mi_meta$QE, digits = 2)), ", ",
        
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(satlife_icum_adj_mi_meta$k - satlife_icum_adj_mi_meta$p), ") = ", 
        .(fmtx(satlife_icum_adj_mi_meta$QE, digits = 2)), ", ",
        .(fmtp(satlife_icum_adj_mi_meta$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )
  }

p_satlife <- add_text(
  p_satlife, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(satlife_icum_adj_mi_meta$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(satlife_icum_adj_mi_meta$zval, digits = 2)), ", ",
        "P < 0.001"
      )
    )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(satlife_icum_adj_mi_meta$zval, digits = 2)), ", ",
        .(fmtp(satlife_icum_adj_mi_meta$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
      )
    )    
  }

p_satlife <- add_text(
  p_satlife, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_satlife <- add_border(p_satlife, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))

#### Pool ####
p_pool <- wrap_elements(
  wrap_elements(p_cesd) + wrap_elements(p_satlife) + wrap_elements(p_shlt) + 
    plot_layout(nrow = 2) + 
    plot_annotation(tag_levels = "a")
  ) 

ggsave(str_c(getwd(), "/results/Figure/Extended Data Figure 6_Forest plot_cumulative internet use_mice.tiff"), plot = p_pool, width = 16, height = 12, unit = "in", dpi = 500, device = "tiff")

```


### Internet use frequency

```{r}

iso <- c(156, 826, 840)

names <- c("China", "England", "USA")

mi_ifreq_merge <- list()
for(i in 1:20){
  mi_ifreq <- mi_ifreq_hrs[[i]] %>% mutate(id = as.character(id)) %>% 
    bind_rows(., mi_ifreq_elsa[[i]] %>% mutate(id = as.character(id))) %>%
    bind_rows(., mi_ifreq_charls[[i]] %>% mutate(id = as.character(id))) %>%
    mutate(
      country_names = case_when(
        country == iso[1] ~ names[1],
        country == iso[2] ~ names[2],
        country == iso[3] ~ names[3]
      )
    )
  mi_ifreq_merge[[i]] <- mi_ifreq
  rm(mi_ifreq)
}

```

#### CES-D

```{r}

cesd_ifreq_unadj_mi_results <- tibble()
for(i in 1:3){
  cesd_ifreq_unadj_mi <- lapply(mi_ifreq_merge, function(x){
    lmer(
      cesd_stand ~ internet_freq + cwave + (1 | id),
      data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'))
  })
  
  cesd_ifreq_unadj_mi_result <- broom.mixed::tidy(pool(cesd_ifreq_unadj_mi)) %>% 
    slice(2:4) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig, b, df, dfcom, fmi, lambda, m, riv, ubar)
  
  cesd_ifreq_unadj_mi_results <- cesd_ifreq_unadj_mi_results %>% 
    bind_rows(., cesd_ifreq_unadj_mi_result)
  
  rm(cesd_ifreq_unadj_mi, cesd_ifreq_unadj_mi_result)
}

cesd_ifreq_adj_mi_results <- tibble()
for(i in 1:3){
  cesd_ifreq_adj_mi <- lapply(mi_ifreq_merge, function(x){
    lmer(
      cesd_stand ~ internet_freq + cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'))
  })
  
  cesd_ifreq_adj_mi_result <- broom.mixed::tidy(pool(cesd_ifreq_adj_mi)) %>% 
    slice(2:4) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig, b, df, dfcom, fmi, lambda, m, riv, ubar)
  
  cesd_ifreq_adj_mi_results <- cesd_ifreq_adj_mi_results %>% 
    bind_rows(., cesd_ifreq_adj_mi_result)
  
  rm(cesd_ifreq_adj_mi, cesd_ifreq_adj_mi_result)
}

cesd_ifreq_adj_mi_results

```


#### Self-rated health

```{r}

shlt_ifreq_unadj_mi_results <- tibble()
for(i in 1:3){
  shlt_ifreq_unadj_mi <- lapply(mi_ifreq_merge, function(x){
    lmer(
      shlt_stand ~ internet_freq + cwave + (1 | id),
      data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'))
  })
  
  shlt_ifreq_unadj_mi_result <- broom.mixed::tidy(pool(shlt_ifreq_unadj_mi)) %>% 
    slice(2:4) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig, b, df, dfcom, fmi, lambda, m, riv, ubar)
  
  shlt_ifreq_unadj_mi_results <- shlt_ifreq_unadj_mi_results %>% 
    bind_rows(., shlt_ifreq_unadj_mi_result)
  
  rm(shlt_ifreq_unadj_mi, shlt_ifreq_unadj_mi_result)
}

shlt_ifreq_adj_mi_results <- tibble()
for(i in 1:3){
  shlt_ifreq_adj_mi <- lapply(mi_ifreq_merge, function(x){
    lmer(
      shlt_stand ~ internet_freq + cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl + 
        (1 | id),
      data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'))
  })
  
  shlt_ifreq_adj_mi_result <- broom.mixed::tidy(pool(shlt_ifreq_adj_mi)) %>% 
    slice(2:4) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig, b, df, dfcom, fmi, lambda, m, riv, ubar)
  
  shlt_ifreq_adj_mi_results <- shlt_ifreq_adj_mi_results %>% 
    bind_rows(., shlt_ifreq_adj_mi_result)
  
  rm(shlt_ifreq_adj_mi, shlt_ifreq_adj_mi_result)
}

shlt_ifreq_adj_mi_results

```


#### Life satisfaction

```{r}

satlife_ifreq_unadj_mi_results <- tibble()
for(i in 1:3){
  satlife_ifreq_unadj_mi <- lapply(mi_ifreq_merge, function(x){
    lmer(
      satlife_stand ~ internet_freq + cwave + (1 | id),
      data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'))
  })
  
  satlife_ifreq_unadj_mi_result <- broom.mixed::tidy(pool(satlife_ifreq_unadj_mi)) %>% 
    slice(2:4) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig, b, df, dfcom, fmi, lambda, m, riv, ubar)
  
  satlife_ifreq_unadj_mi_results <- satlife_ifreq_unadj_mi_results %>% 
    bind_rows(., satlife_ifreq_unadj_mi_result)
  
  rm(satlife_ifreq_unadj_mi, satlife_ifreq_unadj_mi_result)
}

satlife_ifreq_adj_mi_results <- tibble()
for(i in 1:3){
  satlife_ifreq_adj_mi <- lapply(mi_ifreq_merge, function(x){
    lmer(
      satlife_stand ~ internet_freq + cwave + 
        age + male + lowedu + lowwealth + lbrf + 
        nonmarried + hhres + smoken + weekdrink + phyinact + 
        dis + adl_any + iadl +  
        (1 | id),
      data = x %>% filter(country_names == names[i]), control = lmerControl(optimizer = 'bobyqa'))
  })
  
  satlife_ifreq_adj_mi_result <- broom.mixed::tidy(pool(satlife_ifreq_adj_mi)) %>% 
    slice(2:4) %>% 
    mutate(country = names[i], p.sig = ifelse(p.value < 0.05, 1, NA)) %>%
    dplyr::select(country, term, estimate, std.error, statistic, df, p.value, p.sig, b, df, dfcom, fmi, lambda, m, riv, ubar)
  
  satlife_ifreq_adj_mi_results <- satlife_ifreq_adj_mi_results %>% 
    bind_rows(., satlife_ifreq_adj_mi_result)
  
  rm(satlife_ifreq_adj_mi, satlife_ifreq_adj_mi_result)
}

satlife_ifreq_adj_mi_results

```

#### Extended Data Figure 7: Associations of Internet use frequency with mental health (imputed data)

```{r}

#### Theme setting ####
theme <- forestploter::forest_theme(
  core = list(bg_params = list(fill = c("white"))),
  base_size = 10, 
  # base_family = "Arial",
  ci_pch = 15,
  ci_col = "#3B4992FF", 
  ci_alpha = 1,
  ci_lty = 1,
  ci_lwd = 1,
  ci_Theight = unit(0, "cm"),
  
  xaxis_lwd = 1,
  xaxis_cex = 1,
  
  summary_col = "#008B45FF", 
  refline_col = "gray", 
  refline_lwd = 2, 
  
  title_just = "center",
  title_cex = 1.2,
  title_fontface = "bold",
  title_col = "black",
  
  arrow_type = "closed",
  arrow_label_just = "end",
  arrow_length = 0.05,
  arrow_lwd = 1,
  arrow_fill = "black",
  arrow_col = "black"
  )

#### CES-D ####
dat <- cesd_ifreq_adj_mi_results %>%
  bind_rows(
    tibble(
      country = "China", term = "never",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "England", term = "never",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "USA", term = "never",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = ifelse(term == "never", "Reference", beta_ci),
    blank = paste(rep(" ", 10), collapse = " "),
    plot_ci = paste(rep(" ", 20), collapse = " "),
    term = factor(term, levels = c("never", "internet_freqnotregularly", "internet_freqweekly", "internet_freqdaily"), labels = c("  Never", "  Less than weekly", "  Weekly", "  Daily"))
  ) %>%
  arrange(country, term)

dat_fig <- dat %>%
  select(country, term, estimate, lower, upper, beta_ci, blank, plot_ci) %>%
  pivot_wider(
    names_from = country,
    values_from = c(estimate, lower, upper, beta_ci, blank, plot_ci)
  ) %>%
  select(
    term, estimate_China, estimate_England, estimate_USA, 
    lower_China, lower_England, lower_USA,
    upper_China, upper_England, upper_USA, 
    plot_ci_China, beta_ci_China, blank_China,
    plot_ci_England, beta_ci_England, blank_England,
    plot_ci_USA, beta_ci_USA
    )
colnames(dat_fig)[colnames(dat_fig) == "term"] <- "Internet use frequency"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_China"] <- "China"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_England"] <- "England"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_USA"] <- "USA"
colnames(dat_fig)[colnames(dat_fig) %in% c("beta_ci_China", "beta_ci_England", "beta_ci_USA")] <- "β (95% CI)"
colnames(dat_fig)[colnames(dat_fig) %in% c("blank_China", "blank_England", "blank_USA")] <- " "


p_cesd <- forestploter::forest(
  dat_fig[,c(1, 11:18)],
  est = list(
    dat_fig$estimate_China,
    dat_fig$estimate_England,
    dat_fig$estimate_USA
  ),
  lower = list(
    dat_fig$lower_China,
    dat_fig$lower_England,
    dat_fig$lower_USA
  ),
  upper = list(
    dat_fig$upper_China,
    dat_fig$upper_England,
    dat_fig$upper_USA
  ),
  ci_column = c(2, 5, 8),
  ref_line = c(0, 0, 0),
  sizes = 0.7,
  xlim = list(
    c(-1.2, 1.2), 
    c(-1.2, 1.2),
    c(-1.2, 1.2)
    ),            
  ticks_at = list(
    c(-1.2, -0.6, 0, 0.6, 1.2), 
    c(-1.2, -0.6, 0, 0.6, 1.2), 
    c(-1.2, -0.6, 0, 0.6, 1.2)
    ),  
  
  arrow_lab = c("Fewer depressive symptoms","More depressive symptoms"),
  theme = theme
  )

# Add border
p_cesd <- add_border(p_cesd, part = "header", row = 1, col = c(1:9), gp = gpar(lwd = 1))


#### Self-rated health ####
dat <- shlt_ifreq_adj_mi_results %>%
  bind_rows(
    tibble(
      country = "China", term = "never",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "England", term = "never",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "USA", term = "never",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = ifelse(term == "never", "Reference", beta_ci),
    blank = paste(rep(" ", 10), collapse = " "),
    plot_ci = paste(rep(" ", 20), collapse = " "),
    term = factor(term, levels = c("never", "internet_freqnotregularly", "internet_freqweekly", "internet_freqdaily"), labels = c("  Never", "  Less than weekly", "  Weekly", "  Daily"))
  ) %>%
  arrange(country, term)

dat_fig <- dat %>%
  select(country, term, estimate, lower, upper, beta_ci, blank, plot_ci) %>%
  pivot_wider(
    names_from = country,
    values_from = c(estimate, lower, upper, beta_ci, blank, plot_ci)
  ) %>%
  select(
    term, estimate_China, estimate_England, estimate_USA, 
    lower_China, lower_England, lower_USA,
    upper_China, upper_England, upper_USA, 
    plot_ci_China, beta_ci_China, blank_China,
    plot_ci_England, beta_ci_England, blank_England,
    plot_ci_USA, beta_ci_USA
    )
colnames(dat_fig)[colnames(dat_fig) == "term"] <- "Internet use frequency"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_China"] <- "China"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_England"] <- "England"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_USA"] <- "USA"
colnames(dat_fig)[colnames(dat_fig) %in% c("beta_ci_China", "beta_ci_England", "beta_ci_USA")] <- "β (95% CI)"
colnames(dat_fig)[colnames(dat_fig) %in% c("blank_China", "blank_England", "blank_USA")] <- " "


p_shlt <- forestploter::forest(
  dat_fig[,c(1, 11:18)],
  est = list(
    dat_fig$estimate_China,
    dat_fig$estimate_England,
    dat_fig$estimate_USA
  ),
  lower = list(
    dat_fig$lower_China,
    dat_fig$lower_England,
    dat_fig$lower_USA
  ),
  upper = list(
    dat_fig$upper_China,
    dat_fig$upper_England,
    dat_fig$upper_USA
  ),
  ci_column = c(2, 5, 8),
  ref_line = c(0, 0, 0),
  sizes = 0.7,
  xlim = list(
    c(-1.4, 0.7), 
    c(-1.4, 0.7),
    c(-1.4, 0.7)
    ),            
  ticks_at = list(
    c(-1.4, -0.7, 0, 0.7), 
    c(-1.4, -0.7, 0, 0.7), 
    c(-1.4, -0.7, 0, 0.7)
    ),  
  arrow_lab = c("Worse self-reported health","Better self-reported health"),
  theme = theme
  )

# Add border
p_shlt <- add_border(p_shlt, part = "header", row = 1, col = c(1:9), gp = gpar(lwd = 1))


#### Life satisfaction ####
dat <- satlife_ifreq_adj_mi_results %>%
  bind_rows(
    tibble(
      country = "China", term = "never",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "England", term = "never",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = "USA", term = "never",
      estimate = 0, std.error = 0, statistic = NA, df = NA, p.value = NA, p.sig = NA
      )
    ) %>%
  mutate(
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    beta_ci = ifelse(term == "never", "Reference", beta_ci),
    blank = paste(rep(" ", 10), collapse = " "),
    plot_ci = paste(rep(" ", 20), collapse = " "),
    term = factor(term, levels = c("never", "internet_freqnotregularly", "internet_freqweekly", "internet_freqdaily"), labels = c("  Never", "  Less than weekly", "  Weekly", "  Daily"))
  ) %>%
  arrange(country, term)

dat_fig <- dat %>%
  select(country, term, estimate, lower, upper, beta_ci, blank, plot_ci) %>%
  pivot_wider(
    names_from = country,
    values_from = c(estimate, lower, upper, beta_ci, blank, plot_ci)
  ) %>%
  select(
    term, estimate_China, estimate_England, estimate_USA, 
    lower_China, lower_England, lower_USA,
    upper_China, upper_England, upper_USA, 
    plot_ci_China, beta_ci_China, blank_China,
    plot_ci_England, beta_ci_England, blank_England,
    plot_ci_USA, beta_ci_USA
    )
colnames(dat_fig)[colnames(dat_fig) == "term"] <- "Internet use frequency"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_China"] <- "China"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_England"] <- "England"
colnames(dat_fig)[colnames(dat_fig) == "plot_ci_USA"] <- "USA"
colnames(dat_fig)[colnames(dat_fig) %in% c("beta_ci_China", "beta_ci_England", "beta_ci_USA")] <- "β (95% CI)"
colnames(dat_fig)[colnames(dat_fig) %in% c("blank_China", "blank_England", "blank_USA")] <- " "


p_satlife <- forestploter::forest(
  dat_fig[,c(1, 11:18)],
  est = list(
    dat_fig$estimate_China,
    dat_fig$estimate_England,
    dat_fig$estimate_USA
  ),
  lower = list(
    dat_fig$lower_China,
    dat_fig$lower_England,
    dat_fig$lower_USA
  ),
  upper = list(
    dat_fig$upper_China,
    dat_fig$upper_England,
    dat_fig$upper_USA
  ),
  ci_column = c(2, 5, 8),
  ref_line = c(0, 0, 0),
  sizes = 0.7,
  xlim = list(
    c(-0.7, 1.4), 
    c(-0.7, 1.4),
    c(-0.7, 1.4)
    ),            
  ticks_at = list(
    c(-0.7, 0, 0.7, 1.4), 
    c(-0.7, 0, 0.7, 1.4), 
    c(-0.7, 0, 0.7, 1.4)
    ),  
  arrow_lab = c("Lower life satisfaction","Higher life satisfaction"),
  theme = theme
  )

# Add border
p_satlife <- add_border(p_satlife, part = "header", row = 1, col = c(1:9), gp = gpar(lwd = 1))

#### Pool ####
p_pool <- wrap_elements(
  wrap_elements(p_cesd) + wrap_elements(p_satlife) + wrap_elements(p_shlt) + 
    plot_layout(nrow = 3) + 
    plot_annotation(tag_levels = "a")
  ) 

ggsave(str_c(getwd(), "/results/Figure/Extended Data Figure 7_Forest plot_internet use frequency_mice.tiff"), plot = p_pool, width = 13, height = 8, unit = "in", dpi = 500, device = "tiff")


```


## Exclude the MHAS and ELSA

```{r}

#### CES-D ####
cesd_iyes_unadj_meta_exclude <- rma(yi = estimate, sei = std.error, data = cesd_iyes_unadj_results %>% filter(!country %in% c("Mexico", "England")), slab = country)

cesd_iyes_adj_meta_exclude <- rma(yi = estimate, sei = std.error, data = cesd_iyes_adj_results %>% filter(!country %in% c("Mexico", "England")), slab = country)

#### Self-rated health ####
shlt_iyes_unadj_meta_exclude <- rma(yi = estimate, sei = std.error, data = shlt_iyes_unadj_results  %>% filter(!country %in% c("Mexico", "England")), slab = country)

shlt_iyes_adj_meta_exclude <- rma(yi = estimate, sei = std.error, data = shlt_iyes_adj_results %>% filter(!country %in% c("Mexico", "England")), slab = country)

#### Life satisfaction ####
satlife_iyes_unadj_meta_exclude <- rma(yi = estimate, sei = std.error, data = satlife_iyes_unadj_results %>% filter(!country %in% c("Mexico", "England")), slab = country)

satlife_iyes_adj_meta_exclude <- rma(yi = estimate, sei = std.error, data = satlife_iyes_adj_results %>% filter(!country %in% c("Mexico", "England")), slab = country)

```

### Extended Data Figure 8: Associations of Internet use with mental health excluding participants from the England and Mexico

```{r}

#### Theme setting ####
theme <- forestploter::forest_theme(
  core = list(bg_params = list(fill = c("white"))), 
  base_size = 10, 
  # base_family = "Arial",
  ci_pch = 15,
  ci_col = "#3B4992FF", 
  ci_alpha = 1,
  ci_lty = 1,
  ci_lwd = 1,
  ci_Theight = unit(0, "cm"),
  
  xaxis_lwd = 1,
  xaxis_cex = 1,
  
  summary_col = "#008B45FF", 
  refline_col = "gray", 
  refline_lwd = 2, 
  
  title_just = "center",
  title_cex = 1.2,
  title_fontface = "bold",
  title_col = "black",
  
  arrow_type = "closed",
  arrow_label_just = "end",
  arrow_length = 0.05,
  arrow_lwd = 1,
  arrow_fill = "black",
  arrow_col = "black"
  )

#### CES-D ####
# Data
dat <- cesd_iyes_adj_results %>% filter(!country %in% c("Mexico", "England")) %>%
  mutate(weights = weights(cesd_iyes_unadj_meta_exclude)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(cesd_iyes_unadj_meta_exclude$beta),
      std.error = as.numeric(cesd_iyes_unadj_meta_exclude$se), 
      statistic = NA, df = NA, p.value = NA, p.sig = NA, 
      weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "β (95% CI)", "Weight (%)")

p_cesd <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Fewer depressive symptoms","More depressive symptoms"),
  xlim = c(-0.5, 0.5),
  ticks_at = c(-0.5, -0.25, 0, 0.25, 0.5),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(cesd_iyes_unadj_meta_exclude$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(cesd_iyes_unadj_meta_exclude$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(cesd_iyes_unadj_meta_exclude$H2, digits = 2)))
    )

p_cesd <- add_text(
  p_cesd, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(cesd_iyes_unadj_meta_exclude$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(cesd_iyes_unadj_meta_exclude$k - cesd_iyes_unadj_meta_exclude$p), ") = ", 
        .(fmtx(cesd_iyes_unadj_meta_exclude$QE, digits = 2)), ", ",

        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(cesd_iyes_unadj_meta_exclude$k - cesd_iyes_unadj_meta_exclude$p), ") = ", 
        .(fmtx(cesd_iyes_unadj_meta_exclude$QE, digits = 2)), ", ",
        .(fmtp(cesd_iyes_unadj_meta_exclude$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
  }
  

p_cesd <- add_text(
  p_cesd, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(cesd_iyes_unadj_meta_exclude$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(cesd_iyes_unadj_meta_exclude$zval, digits = 2)), ", ",
        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(cesd_iyes_unadj_meta_exclude$zval, digits = 2)), ", ",
      .(fmtp(cesd_iyes_unadj_meta_exclude$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )    
  }

p_cesd <- add_text(
  p_cesd, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_cesd <- add_border(p_cesd, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))


#### Self-rated health ####
# Data
dat <- shlt_iyes_adj_results %>% filter(!country %in% c("Mexico", "England")) %>%
  mutate(weights = weights(shlt_iyes_unadj_meta_exclude)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(shlt_iyes_unadj_meta_exclude$beta),
      std.error = as.numeric(shlt_iyes_unadj_meta_exclude$se), 
      statistic = NA, df = NA, p.value = NA, p.sig = NA, 
      weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "β (95% CI)", "Weight (%)")

p_shlt <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Worse self-reported health","Better self-reported health"),
  xlim = c(-0.4, 0.4),
  ticks_at = c(-0.4, -0.2, 0, 0.2, 0.4),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(shlt_iyes_unadj_meta_exclude$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(shlt_iyes_unadj_meta_exclude$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(shlt_iyes_unadj_meta_exclude$H2, digits = 2)))
    )

p_shlt <- add_text(
  p_shlt, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(shlt_iyes_unadj_meta_exclude$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(shlt_iyes_unadj_meta_exclude$k - shlt_iyes_unadj_meta_exclude$p), ") = ", 
        .(fmtx(shlt_iyes_unadj_meta_exclude$QE, digits = 2)), ", ",

        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(shlt_iyes_unadj_meta_exclude$k - shlt_iyes_unadj_meta_exclude$p), ") = ", 
        .(fmtx(shlt_iyes_unadj_meta_exclude$QE, digits = 2)), ", ",
        .(fmtp(shlt_iyes_unadj_meta_exclude$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
  }

p_shlt <- add_text(
  p_shlt, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(shlt_iyes_unadj_meta_exclude$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(shlt_iyes_unadj_meta_exclude$zval, digits = 2)), ", ",
        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(shlt_iyes_unadj_meta_exclude$zval, digits = 2)), ", ",
      .(fmtp(shlt_iyes_unadj_meta_exclude$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )    
  }

p_shlt <- add_text(
  p_shlt, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_shlt <- add_border(p_shlt, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))


#### Life satisfaction ####
# Data
dat <- satlife_iyes_adj_results %>% filter(!country %in% c("Mexico", "England")) %>%
  mutate(weights = weights(satlife_iyes_unadj_meta_exclude)) %>%
  bind_rows(
    tibble(
      country = "Overall", term = NA,
      estimate = as.numeric(satlife_iyes_unadj_meta_exclude$beta),
      std.error = as.numeric(satlife_iyes_unadj_meta_exclude$se), 
      statistic = NA, df = NA, p.value = NA, p.sig = NA, 
      weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  bind_rows(
    tibble(
      country = NA, term = NA, estimate = NA, std.error = NA,
      statistic = NA, df = NA, p.value = NA, p.sig = NA, weights = NA
      )
    ) %>%
  mutate(
    weights_text = sprintf("%0.2f", weights),
    lower = estimate - 1.96*std.error,
    upper = estimate + 1.96*std.error,
    beta_ci = sprintf("%0.2f [%0.2f, %0.2f]", estimate, lower, upper),
    blank = paste(rep(" ", 20), collapse = " "),
    plot_ci = paste(rep(" ", 30), collapse = " "),
    
    weights_text = ifelse(weights_text == "NA", " ", weights_text),
    beta_ci = ifelse(beta_ci == "NA [NA, NA]", " ", beta_ci)
  )

dat_fig <- dat %>% select(country, blank, plot_ci, beta_ci, weights_text)
dat_fig[is.na(dat_fig)] <- " "
colnames(dat_fig) <- c("Country", "", "", "β (95% CI)", "Weight (%)")

p_satlife <- forestploter::forest(
  dat_fig,
  est = dat$estimate,
  lower = dat$lower, 
  upper = dat$upper,
  sizes = c(sqrt((dat %>% slice(1:(nrow(dat)-4)) %>% pull(weights))/8), rep(1, 4)),
  is_summary = c(rep(F, nrow(dat)-4), T, rep(F, 3)),
  ci_column = 3,
  ref_line = 0,
  arrow_lab = c("Lower life satisfaction","Higher life satisfaction"),
  xlim = c(-0.2, 0.8),
  ticks_at = c(-0.2, 0, 0.2, 0.4, 0.6, 0.8),
  theme = theme
  )

# Add text
heterogeneity <- bquote(
    paste(
      "Heterogeneity: ",
      italic(tau)^2, " = ", .(fmtx(satlife_iyes_unadj_meta_exclude$tau2, digits = 2)), ", ",
      italic(I)^2, " = ", .(fmtx(satlife_iyes_unadj_meta_exclude$I2, digits = 2)), "%", ", ",
      italic(H)^2, " = ", .(fmtx(satlife_iyes_unadj_meta_exclude$H2, digits = 2)))
    )

p_satlife <- add_text(
  p_satlife, text = heterogeneity, row = nrow(dat)-2, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_hetero <- 
  if(satlife_iyes_unadj_meta_exclude$QEp < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(satlife_iyes_unadj_meta_exclude$k - satlife_iyes_unadj_meta_exclude$p), ") = ", 
        .(fmtx(satlife_iyes_unadj_meta_exclude$QE, digits = 2)), ", ",

        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta[i]), " = ", italic(theta[j]), ": ", 
        "Q (", .(satlife_iyes_unadj_meta_exclude$k - satlife_iyes_unadj_meta_exclude$p), ") = ", 
        .(fmtx(satlife_iyes_unadj_meta_exclude$QE, digits = 2)), ", ",
        .(fmtp(satlife_iyes_unadj_meta_exclude$QEp, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )
  }

p_satlife <- add_text(
  p_satlife, text = test_hetero, row = nrow(dat)-1, col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

test_overall <- 
  if(satlife_iyes_unadj_meta_exclude$pval < 0.001){
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(satlife_iyes_unadj_meta_exclude$zval, digits = 2)), ", ",
        "P < 0.001"
        )
      )
  }else{
    bquote(
      paste(
        "Test of ", italic(theta), " = 0: ", 
        italic(z), " = ", .(fmtx(satlife_iyes_unadj_meta_exclude$zval, digits = 2)), ", ",
      .(fmtp(satlife_iyes_unadj_meta_exclude$pval, digits = 3, pname = "P", add0 = T, equal = T, sep = T))
        )
      )    
  }

p_satlife <- add_text(
  p_satlife, text = test_overall, row = nrow(dat), col = 1, part = "body", just = "left", 
  gp = gpar(fontsize = 10), parse = T
)

# Add border
p_satlife <- add_border(p_satlife, part = "header", row = 1, col = c(1:5), gp = gpar(lwd = 1))

#### Pool ####
p_pool <- wrap_elements(
  wrap_elements(p_cesd) + wrap_elements(p_satlife) + wrap_elements(p_shlt) + 
    plot_layout(nrow = 2) + 
    plot_annotation(tag_levels = "a")
  ) 

ggsave(str_c(getwd(), "/results/Figure/Extended Data Figure 8_Forest plot_internet use_excluding ELSA and MHAS.tiff"), plot = p_pool, width = 16, height = 14, unit = "in", dpi = 500, device = "tiff")

```


